# M17-風險管理模組 資料庫設計

> **文件編號**: DB-M17
> **模組名稱**: 風險管理模組 (Risk Management Module)
> **版本**: v1.0
> **最後更新**: 2026-01-15
> **狀態**: Draft

---

## 1. 資料表清單

| 序號 | 資料表名稱 | 中文名稱 | 說明 |
|-----|-----------|---------|------|
| 1 | risk_snapshots | 風險快照表 | 每日風險指標快照 |
| 2 | risk_var_results | VaR 結果表 | VaR 計算結果 |
| 3 | risk_limits | 風險限額表 | 風險限額設定 |
| 4 | risk_limit_checks | 限額檢查記錄表 | 每日限額檢查結果 |
| 5 | risk_alerts | 風險預警表 | 已觸發的預警記錄 |
| 6 | risk_alert_rules | 預警規則表 | 自訂預警規則 |
| 7 | risk_stress_tests | 壓力測試表 | 壓力測試任務 |
| 8 | risk_stress_results | 壓力測試結果表 | 各情境測試結果 |
| 9 | risk_scenarios | 自訂情境表 | 用戶自訂情境 |
| 10 | risk_correlation_cache | 相關性快取表 | 相關係數矩陣快取 |

---

## 2. 資料表詳細設計

### 2.1 risk_snapshots (風險快照表)

儲存投資組合每日風險指標快照。

```sql
CREATE TABLE risk_snapshots (
    id                    BIGSERIAL PRIMARY KEY,
    portfolio_id          VARCHAR(50) NOT NULL,
    snapshot_date         DATE NOT NULL,

    -- 整體風險
    risk_level            VARCHAR(20),       -- LOW | MEDIUM | MEDIUM_HIGH | HIGH
    risk_score            INTEGER,           -- 0-100

    -- VaR 指標
    var_95_daily          DECIMAL(15,2),
    var_99_daily          DECIMAL(15,2),
    cvar_95               DECIMAL(15,2),
    var_method            VARCHAR(20),       -- HISTORICAL | PARAMETRIC | MONTE_CARLO

    -- 波動度
    volatility_daily      DECIMAL(10,6),
    volatility_annualized DECIMAL(10,6),
    downside_volatility   DECIMAL(10,6),

    -- 市場風險
    beta                  DECIMAL(8,4),
    correlation_market    DECIMAL(8,4),
    benchmark_code        VARCHAR(20),

    -- 回撤
    max_drawdown          DECIMAL(8,4),
    current_drawdown      DECIMAL(8,4),

    -- 集中度
    hhi                   DECIMAL(8,4),      -- 赫芬達爾指數
    top5_weight           DECIMAL(6,4),
    largest_position_pct  DECIMAL(6,4),

    -- 其他風險指標
    sharpe_ratio          DECIMAL(8,4),
    sortino_ratio         DECIMAL(8,4),

    -- 詳細分解 (JSONB)
    risk_attribution      JSONB,             -- 風險歸因
    sector_exposure       JSONB,             -- 產業曝險
    top_risk_contributors JSONB,             -- 主要風險貢獻者

    -- 計算資訊
    total_value           DECIMAL(15,2),
    position_count        INTEGER,
    calculated_at         TIMESTAMP WITH TIME ZONE,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(portfolio_id, snapshot_date)
);

-- 索引
CREATE INDEX idx_risk_snapshots_portfolio ON risk_snapshots(portfolio_id, snapshot_date DESC);
CREATE INDEX idx_risk_snapshots_date ON risk_snapshots(snapshot_date);
CREATE INDEX idx_risk_snapshots_level ON risk_snapshots(portfolio_id, risk_level);

-- 風險等級約束
ALTER TABLE risk_snapshots
ADD CONSTRAINT chk_risk_level
CHECK (risk_level IS NULL OR risk_level IN ('LOW', 'MEDIUM', 'MEDIUM_HIGH', 'HIGH'));
```

**JSONB 結構範例**

`risk_attribution`:
```json
{
  "factorRisk": {
    "market": 0.72,
    "sector": 0.15,
    "specific": 0.13
  },
  "sectorRisk": {
    "electronic": 0.55,
    "financial": 0.20,
    "traditional": 0.15,
    "others": 0.10
  }
}
```

`top_risk_contributors`:
```json
[
  {
    "stockId": "2330",
    "stockName": "台積電",
    "weight": 0.18,
    "riskContribution": 0.32,
    "marginalVar": 45000
  },
  {
    "stockId": "2317",
    "stockName": "鴻海",
    "weight": 0.12,
    "riskContribution": 0.15,
    "marginalVar": 22000
  }
]
```

---

### 2.2 risk_var_results (VaR 結果表)

儲存 VaR 計算的詳細結果。

```sql
CREATE TABLE risk_var_results (
    id                    BIGSERIAL PRIMARY KEY,
    portfolio_id          VARCHAR(50) NOT NULL,
    calculation_date      DATE NOT NULL,

    -- 計算參數
    method                VARCHAR(20) NOT NULL,   -- HISTORICAL | PARAMETRIC | MONTE_CARLO
    confidence_level      DECIMAL(4,2) NOT NULL,  -- 0.95 | 0.99
    horizon_days          INTEGER NOT NULL,       -- 1 | 5 | 10 | 21
    lookback_days         INTEGER,
    simulations           INTEGER,                -- Monte Carlo 專用

    -- VaR 結果
    var_value             DECIMAL(15,2) NOT NULL,
    var_percentage        DECIMAL(8,4) NOT NULL,
    cvar_value            DECIMAL(15,2),
    cvar_percentage       DECIMAL(8,4),
    standard_error        DECIMAL(15,2),          -- Monte Carlo 專用

    -- 組成分解 (JSONB)
    component_var         JSONB,

    -- 歷史驗證
    backtest_exceedances  INTEGER,                -- 實際超出次數
    expected_exceedances  DECIMAL(8,2),           -- 預期超出次數
    backtest_pvalue       DECIMAL(6,4),

    -- 敏感度分析 (JSONB)
    sensitivity_analysis  JSONB,

    -- Monte Carlo 分布 (JSONB)
    distribution_stats    JSONB,

    -- 計算資訊
    total_value           DECIMAL(15,2),
    calculated_at         TIMESTAMP WITH TIME ZONE,
    calculation_time_ms   INTEGER,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(portfolio_id, calculation_date, method, confidence_level, horizon_days)
);

-- 索引
CREATE INDEX idx_var_results_portfolio ON risk_var_results(portfolio_id, calculation_date DESC);
CREATE INDEX idx_var_results_method ON risk_var_results(portfolio_id, method);

-- 方法約束
ALTER TABLE risk_var_results
ADD CONSTRAINT chk_var_method
CHECK (method IN ('HISTORICAL', 'PARAMETRIC', 'MONTE_CARLO'));
```

**JSONB 結構範例**

`component_var`:
```json
[
  {
    "stockId": "2330",
    "stockName": "台積電",
    "positionValue": 900000,
    "componentVar": 40000,
    "marginalVar": 0.044,
    "contribution": 0.32
  }
]
```

`sensitivity_analysis`:
```json
{
  "varAt90": 95000,
  "varAt95": 125000,
  "varAt99": 185000,
  "varAt99_5": 220000
}
```

`distribution_stats` (Monte Carlo):
```json
{
  "mean": 5005000,
  "median": 5012000,
  "stdDev": 78000,
  "skewness": -0.35,
  "kurtosis": 3.8,
  "percentiles": {
    "p1": 4750000,
    "p5": 4875000,
    "p10": 4920000,
    "p50": 5012000,
    "p95": 5125000,
    "p99": 5185000
  }
}
```

---

### 2.3 risk_limits (風險限額表)

儲存風險限額設定。

```sql
CREATE TABLE risk_limits (
    id                    BIGSERIAL PRIMARY KEY,
    limit_id              VARCHAR(50) NOT NULL UNIQUE,
    portfolio_id          VARCHAR(50) NOT NULL,
    user_id               VARCHAR(50) NOT NULL,

    -- 限額設定
    limit_type            VARCHAR(30) NOT NULL,
    limit_value           DECIMAL(15,4) NOT NULL,
    limit_unit            VARCHAR(20),           -- AMOUNT | PERCENTAGE

    -- 閾值設定
    warning_threshold     DECIMAL(4,2) DEFAULT 0.80,
    critical_threshold    DECIMAL(4,2) DEFAULT 0.95,

    -- 觸發動作
    action_type           VARCHAR(20) DEFAULT 'ALERT',  -- ALERT | BLOCK_TRADE

    -- 描述
    description           TEXT,

    -- 狀態
    enabled               BOOLEAN DEFAULT TRUE,
    current_value         DECIMAL(15,4),
    current_utilization   DECIMAL(6,4),
    current_status        VARCHAR(20),           -- NORMAL | WARNING | CRITICAL | BREACHED

    -- 最後檢查
    last_checked_at       TIMESTAMP WITH TIME ZONE,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_risk_limits_portfolio ON risk_limits(portfolio_id, enabled);
CREATE INDEX idx_risk_limits_type ON risk_limits(limit_type);
CREATE INDEX idx_risk_limits_status ON risk_limits(current_status) WHERE current_status != 'NORMAL';

-- 唯一約束：同一組合同一類型只能有一個限額
CREATE UNIQUE INDEX idx_risk_limits_unique
ON risk_limits(portfolio_id, limit_type) WHERE enabled = TRUE;

-- 限額類型約束
ALTER TABLE risk_limits
ADD CONSTRAINT chk_limit_type
CHECK (limit_type IN (
    'VAR_95', 'VAR_99', 'VAR_PCT',
    'VOLATILITY', 'MAX_SINGLE_STOCK', 'MAX_SECTOR',
    'MAX_DRAWDOWN', 'BETA', 'CONCENTRATION_HHI'
));

-- 動作類型約束
ALTER TABLE risk_limits
ADD CONSTRAINT chk_action_type
CHECK (action_type IN ('ALERT', 'BLOCK_TRADE'));
```

---

### 2.4 risk_limit_checks (限額檢查記錄表)

儲存每日限額檢查結果。

```sql
CREATE TABLE risk_limit_checks (
    id                    BIGSERIAL PRIMARY KEY,
    limit_id              VARCHAR(50) NOT NULL,
    portfolio_id          VARCHAR(50) NOT NULL,
    check_date            DATE NOT NULL,

    -- 限額資訊
    limit_type            VARCHAR(30) NOT NULL,
    limit_value           DECIMAL(15,4) NOT NULL,

    -- 檢查結果
    current_value         DECIMAL(15,4) NOT NULL,
    utilization           DECIMAL(6,4) NOT NULL,
    status                VARCHAR(20) NOT NULL,   -- NORMAL | WARNING | CRITICAL | BREACHED

    -- 閾值
    warning_threshold     DECIMAL(4,2),
    critical_threshold    DECIMAL(4,2),

    -- 較前日變化
    previous_value        DECIMAL(15,4),
    value_change          DECIMAL(15,4),
    value_change_pct      DECIMAL(8,4),

    -- 是否觸發預警
    alert_triggered       BOOLEAN DEFAULT FALSE,
    alert_id              VARCHAR(50),

    checked_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(limit_id, check_date)
);

-- 索引
CREATE INDEX idx_limit_checks_portfolio ON risk_limit_checks(portfolio_id, check_date DESC);
CREATE INDEX idx_limit_checks_status ON risk_limit_checks(status, check_date);
CREATE INDEX idx_limit_checks_alert ON risk_limit_checks(alert_triggered, check_date) WHERE alert_triggered = TRUE;

-- 外鍵
ALTER TABLE risk_limit_checks
ADD CONSTRAINT fk_limit_checks_limit
FOREIGN KEY (limit_id) REFERENCES risk_limits(limit_id) ON DELETE CASCADE;
```

---

### 2.5 risk_alerts (風險預警表)

儲存已觸發的風險預警。

```sql
CREATE TABLE risk_alerts (
    id                    BIGSERIAL PRIMARY KEY,
    alert_id              VARCHAR(50) NOT NULL UNIQUE,
    alert_rule_id         VARCHAR(50),           -- 關聯的預警規則
    portfolio_id          VARCHAR(50) NOT NULL,

    -- 預警類型
    alert_type            VARCHAR(30) NOT NULL,
    severity              VARCHAR(20) NOT NULL,   -- LOW | MEDIUM | HIGH | CRITICAL

    -- 預警內容
    title                 VARCHAR(200) NOT NULL,
    message               TEXT NOT NULL,

    -- 觸發資訊
    trigger_value         DECIMAL(15,4),
    threshold_value       DECIMAL(15,4),
    trigger_metric        VARCHAR(50),

    -- 相關標的
    stock_id              VARCHAR(20),
    stock_name            VARCHAR(100),

    -- 狀態
    status                VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',  -- ACTIVE | ACKNOWLEDGED | RESOLVED
    triggered_at          TIMESTAMP WITH TIME ZONE NOT NULL,

    -- 確認資訊
    acknowledged_at       TIMESTAMP WITH TIME ZONE,
    acknowledged_by       VARCHAR(100),
    acknowledge_note      TEXT,

    -- 解決資訊
    resolved_at           TIMESTAMP WITH TIME ZONE,
    resolved_by           VARCHAR(100),
    resolution_note       TEXT,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_alerts_portfolio ON risk_alerts(portfolio_id, triggered_at DESC);
CREATE INDEX idx_alerts_status ON risk_alerts(status, severity);
CREATE INDEX idx_alerts_active ON risk_alerts(portfolio_id, status) WHERE status = 'ACTIVE';
CREATE INDEX idx_alerts_type ON risk_alerts(alert_type, triggered_at DESC);

-- 預警類型約束
ALTER TABLE risk_alerts
ADD CONSTRAINT chk_alert_type
CHECK (alert_type IN (
    'VAR_THRESHOLD', 'VOLATILITY_SPIKE', 'CONCENTRATION',
    'DRAWDOWN', 'BETA_DEVIATION', 'LIMIT_BREACH',
    'CORRELATION_CHANGE', 'STRESS_TEST_FAIL'
));

-- 嚴重等級約束
ALTER TABLE risk_alerts
ADD CONSTRAINT chk_severity
CHECK (severity IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL'));

-- 狀態約束
ALTER TABLE risk_alerts
ADD CONSTRAINT chk_alert_status
CHECK (status IN ('ACTIVE', 'ACKNOWLEDGED', 'RESOLVED'));
```

---

### 2.6 risk_alert_rules (預警規則表)

儲存用戶自訂的預警規則。

```sql
CREATE TABLE risk_alert_rules (
    id                    BIGSERIAL PRIMARY KEY,
    rule_id               VARCHAR(50) NOT NULL UNIQUE,
    portfolio_id          VARCHAR(50) NOT NULL,
    user_id               VARCHAR(50) NOT NULL,

    -- 規則設定
    alert_type            VARCHAR(30) NOT NULL,
    rule_name             VARCHAR(200) NOT NULL,
    description           TEXT,

    -- 條件設定 (JSONB)
    condition             JSONB NOT NULL,

    -- 預警設定
    severity              VARCHAR(20) DEFAULT 'MEDIUM',
    notification_channels JSONB,                  -- ["EMAIL", "PUSH"]
    cooldown_minutes      INTEGER DEFAULT 60,

    -- 狀態
    enabled               BOOLEAN DEFAULT TRUE,
    triggered_count       INTEGER DEFAULT 0,
    last_triggered_at     TIMESTAMP WITH TIME ZONE,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_alert_rules_portfolio ON risk_alert_rules(portfolio_id, enabled);
CREATE INDEX idx_alert_rules_type ON risk_alert_rules(alert_type);

-- 唯一約束
CREATE UNIQUE INDEX idx_alert_rules_unique
ON risk_alert_rules(portfolio_id, alert_type, rule_name) WHERE enabled = TRUE;
```

**JSONB 結構範例**

`condition`:
```json
{
  "metric": "VOLATILITY_ANNUALIZED",
  "operator": "GREATER_THAN",
  "threshold": 0.35,
  "comparison": {
    "type": "ABSOLUTE",
    "reference": null
  }
}
```

`notification_channels`:
```json
["EMAIL", "PUSH", "SMS"]
```

---

### 2.7 risk_stress_tests (壓力測試表)

儲存壓力測試任務。

```sql
CREATE TABLE risk_stress_tests (
    id                    BIGSERIAL PRIMARY KEY,
    test_id               VARCHAR(50) NOT NULL UNIQUE,
    portfolio_id          VARCHAR(50) NOT NULL,
    user_id               VARCHAR(50) NOT NULL,

    -- 測試設定
    test_name             VARCHAR(200),
    scenario_ids          TEXT[],                 -- 預設情境 ID
    custom_scenarios      JSONB,                  -- 自訂情境
    include_historical    BOOLEAN DEFAULT TRUE,

    -- 執行狀態
    status                VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    total_scenarios       INTEGER NOT NULL,
    completed_scenarios   INTEGER DEFAULT 0,

    -- 結果摘要
    scenarios_passed      INTEGER,
    scenarios_failed      INTEGER,
    worst_case_scenario   VARCHAR(100),
    worst_case_loss       DECIMAL(15,2),
    worst_case_pct        DECIMAL(8,4),
    avg_loss              DECIMAL(15,2),

    -- 投組資訊
    total_value           DECIMAL(15,2),

    -- 執行時間
    started_at            TIMESTAMP WITH TIME ZONE,
    completed_at          TIMESTAMP WITH TIME ZONE,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_stress_tests_portfolio ON risk_stress_tests(portfolio_id, created_at DESC);
CREATE INDEX idx_stress_tests_status ON risk_stress_tests(status);

-- 狀態約束
ALTER TABLE risk_stress_tests
ADD CONSTRAINT chk_stress_test_status
CHECK (status IN ('PENDING', 'RUNNING', 'COMPLETED', 'FAILED'));
```

---

### 2.8 risk_stress_results (壓力測試結果表)

儲存各情境的測試結果。

```sql
CREATE TABLE risk_stress_results (
    id                    BIGSERIAL PRIMARY KEY,
    test_id               VARCHAR(50) NOT NULL,
    scenario_id           VARCHAR(50) NOT NULL,

    -- 情境資訊
    scenario_name         VARCHAR(200) NOT NULL,
    scenario_type         VARCHAR(20) NOT NULL,   -- SYSTEM | CUSTOM | HISTORICAL
    scenario_description  TEXT,

    -- 情境衝擊設定 (JSONB)
    shocks                JSONB NOT NULL,

    -- 結果
    market_change         DECIMAL(8,4),
    portfolio_change      DECIMAL(8,4) NOT NULL,
    estimated_loss        DECIMAL(15,2) NOT NULL,
    final_value           DECIMAL(15,2) NOT NULL,

    -- 各持股影響 (JSONB)
    position_impacts      JSONB,

    -- 是否通過
    passed                BOOLEAN NOT NULL,
    breached_limits       TEXT[],                 -- 違反的限額

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(test_id, scenario_id)
);

-- 索引
CREATE INDEX idx_stress_results_test ON risk_stress_results(test_id);
CREATE INDEX idx_stress_results_scenario ON risk_stress_results(scenario_id);

-- 外鍵
ALTER TABLE risk_stress_results
ADD CONSTRAINT fk_stress_results_test
FOREIGN KEY (test_id) REFERENCES risk_stress_tests(test_id) ON DELETE CASCADE;
```

**JSONB 結構範例**

`shocks`:
```json
[
  {"factor": "MARKET", "change": -0.25},
  {"factor": "SECTOR_ELECTRONIC", "change": -0.35},
  {"factor": "CURRENCY_TWD", "change": -0.10}
]
```

`position_impacts`:
```json
[
  {"stockId": "2330", "stockName": "台積電", "change": -0.42, "loss": 378000},
  {"stockId": "2882", "stockName": "國泰金", "change": -0.52, "loss": 234000}
]
```

---

### 2.9 risk_scenarios (自訂情境表)

儲存用戶自訂的壓力測試情境。

```sql
CREATE TABLE risk_scenarios (
    id                    BIGSERIAL PRIMARY KEY,
    scenario_id           VARCHAR(50) NOT NULL UNIQUE,
    user_id               VARCHAR(50) NOT NULL,

    -- 情境設定
    scenario_name         VARCHAR(200) NOT NULL,
    description           TEXT,
    scenario_type         VARCHAR(20) NOT NULL DEFAULT 'CUSTOM',

    -- 衝擊設定 (JSONB)
    shocks                JSONB NOT NULL,

    -- 可見性
    is_public             BOOLEAN DEFAULT FALSE,

    -- 使用統計
    usage_count           INTEGER DEFAULT 0,
    last_used_at          TIMESTAMP WITH TIME ZONE,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_scenarios_user ON risk_scenarios(user_id);
CREATE INDEX idx_scenarios_public ON risk_scenarios(is_public) WHERE is_public = TRUE;
CREATE INDEX idx_scenarios_type ON risk_scenarios(scenario_type);

-- 唯一約束
CREATE UNIQUE INDEX idx_scenarios_name
ON risk_scenarios(user_id, scenario_name);
```

---

### 2.10 risk_correlation_cache (相關性快取表)

快取投資組合的相關係數矩陣。

```sql
CREATE TABLE risk_correlation_cache (
    id                    BIGSERIAL PRIMARY KEY,
    portfolio_id          VARCHAR(50) NOT NULL,
    cache_date            DATE NOT NULL,
    period                VARCHAR(10) NOT NULL,   -- 1M | 3M | 6M | 1Y | 2Y
    method                VARCHAR(20) NOT NULL,   -- PEARSON | SPEARMAN

    -- 股票清單
    stock_ids             TEXT[] NOT NULL,
    stock_names           JSONB,

    -- 相關係數矩陣 (二維陣列)
    correlation_matrix    JSONB NOT NULL,

    -- 統計資訊
    avg_correlation       DECIMAL(8,4),
    max_correlation       DECIMAL(8,4),
    max_correlation_pair  TEXT[],                 -- [stock1, stock2]
    min_correlation       DECIMAL(8,4),
    min_correlation_pair  TEXT[],
    diversification_ratio DECIMAL(8,4),

    -- 聚類分析 (JSONB)
    clusters              JSONB,

    -- 快取資訊
    expires_at            TIMESTAMP WITH TIME ZONE,
    calculated_at         TIMESTAMP WITH TIME ZONE,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(portfolio_id, cache_date, period, method)
);

-- 索引
CREATE INDEX idx_correlation_cache_portfolio ON risk_correlation_cache(portfolio_id, cache_date DESC);
CREATE INDEX idx_correlation_cache_expires ON risk_correlation_cache(expires_at);

-- 清理過期快取
CREATE INDEX idx_correlation_cache_cleanup
ON risk_correlation_cache(expires_at) WHERE expires_at < CURRENT_TIMESTAMP;
```

**JSONB 結構範例**

`correlation_matrix`:
```json
[
  [1.00, 0.65, 0.72, 0.68, 0.35],
  [0.65, 1.00, 0.58, 0.55, 0.42],
  [0.72, 0.58, 1.00, 0.75, 0.28],
  [0.68, 0.55, 0.75, 1.00, 0.25],
  [0.35, 0.42, 0.28, 0.25, 1.00]
]
```

`clusters`:
```json
[
  {
    "clusterId": 1,
    "name": "半導體群",
    "stocks": ["2330", "2454", "2303"],
    "avgIntraCorrelation": 0.72
  },
  {
    "clusterId": 2,
    "name": "金融群",
    "stocks": ["2882"],
    "avgIntraCorrelation": 1.00
  }
]
```

---

## 3. MyBatis Mapper 設計

### 3.1 RiskSnapshotMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.chris.fin_shark.m17.mapper.RiskSnapshotMapper">

    <!-- 取得最新風險快照 -->
    <select id="findLatestByPortfolio" resultType="RiskSnapshot">
        SELECT *
        FROM risk_snapshots
        WHERE portfolio_id = #{portfolioId}
        ORDER BY snapshot_date DESC
        LIMIT 1
    </select>

    <!-- 取得歷史風險數據 -->
    <select id="findHistoryByPortfolio" resultType="RiskSnapshot">
        SELECT *
        FROM risk_snapshots
        WHERE portfolio_id = #{portfolioId}
          AND snapshot_date BETWEEN #{startDate} AND #{endDate}
        <if test="interval == 'WEEKLY'">
            AND EXTRACT(DOW FROM snapshot_date) = 5
        </if>
        <if test="interval == 'MONTHLY'">
            AND snapshot_date = (
                SELECT MAX(snapshot_date)
                FROM risk_snapshots s2
                WHERE s2.portfolio_id = risk_snapshots.portfolio_id
                  AND DATE_TRUNC('month', s2.snapshot_date) = DATE_TRUNC('month', risk_snapshots.snapshot_date)
            )
        </if>
        ORDER BY snapshot_date
    </select>

    <!-- 插入或更新風險快照 -->
    <insert id="upsert">
        INSERT INTO risk_snapshots (
            portfolio_id, snapshot_date,
            risk_level, risk_score,
            var_95_daily, var_99_daily, cvar_95, var_method,
            volatility_daily, volatility_annualized, downside_volatility,
            beta, correlation_market, benchmark_code,
            max_drawdown, current_drawdown,
            hhi, top5_weight, largest_position_pct,
            sharpe_ratio, sortino_ratio,
            risk_attribution, sector_exposure, top_risk_contributors,
            total_value, position_count, calculated_at
        ) VALUES (
            #{portfolioId}, #{snapshotDate},
            #{riskLevel}, #{riskScore},
            #{var95Daily}, #{var99Daily}, #{cvar95}, #{varMethod},
            #{volatilityDaily}, #{volatilityAnnualized}, #{downsideVolatility},
            #{beta}, #{correlationMarket}, #{benchmarkCode},
            #{maxDrawdown}, #{currentDrawdown},
            #{hhi}, #{top5Weight}, #{largestPositionPct},
            #{sharpeRatio}, #{sortinoRatio},
            #{riskAttribution}::jsonb, #{sectorExposure}::jsonb, #{topRiskContributors}::jsonb,
            #{totalValue}, #{positionCount}, #{calculatedAt}
        )
        ON CONFLICT (portfolio_id, snapshot_date)
        DO UPDATE SET
            risk_level = EXCLUDED.risk_level,
            risk_score = EXCLUDED.risk_score,
            var_95_daily = EXCLUDED.var_95_daily,
            var_99_daily = EXCLUDED.var_99_daily,
            cvar_95 = EXCLUDED.cvar_95,
            volatility_annualized = EXCLUDED.volatility_annualized,
            beta = EXCLUDED.beta,
            max_drawdown = EXCLUDED.max_drawdown,
            current_drawdown = EXCLUDED.current_drawdown,
            hhi = EXCLUDED.hhi,
            top_risk_contributors = EXCLUDED.top_risk_contributors,
            total_value = EXCLUDED.total_value,
            calculated_at = EXCLUDED.calculated_at
    </insert>

    <!-- 統計風險指標變化 -->
    <select id="getRiskTrend" resultType="RiskTrend">
        SELECT
            portfolio_id,
            AVG(var_95_daily) FILTER (WHERE snapshot_date >= CURRENT_DATE - INTERVAL '7 days') as var_avg_7d,
            AVG(var_95_daily) FILTER (WHERE snapshot_date >= CURRENT_DATE - INTERVAL '30 days') as var_avg_30d,
            AVG(volatility_annualized) FILTER (WHERE snapshot_date >= CURRENT_DATE - INTERVAL '7 days') as vol_avg_7d,
            AVG(volatility_annualized) FILTER (WHERE snapshot_date >= CURRENT_DATE - INTERVAL '30 days') as vol_avg_30d,
            (SELECT var_95_daily FROM risk_snapshots s2
             WHERE s2.portfolio_id = #{portfolioId} ORDER BY snapshot_date DESC LIMIT 1) as var_current,
            (SELECT volatility_annualized FROM risk_snapshots s2
             WHERE s2.portfolio_id = #{portfolioId} ORDER BY snapshot_date DESC LIMIT 1) as vol_current
        FROM risk_snapshots
        WHERE portfolio_id = #{portfolioId}
          AND snapshot_date >= CURRENT_DATE - INTERVAL '30 days'
        GROUP BY portfolio_id
    </select>

    <!-- 清理過期快照 -->
    <delete id="deleteOldSnapshots">
        DELETE FROM risk_snapshots
        WHERE snapshot_date &lt; #{expireDate}
    </delete>

</mapper>
```

### 3.2 RiskLimitMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.chris.fin_shark.m17.mapper.RiskLimitMapper">

    <!-- 取得投組所有啟用限額 -->
    <select id="findActiveByPortfolio" resultType="RiskLimit">
        SELECT *
        FROM risk_limits
        WHERE portfolio_id = #{portfolioId}
          AND enabled = TRUE
        ORDER BY limit_type
    </select>

    <!-- 取得需檢查的限額 (所有啟用中) -->
    <select id="findAllActiveLimits" resultType="RiskLimit">
        SELECT l.*, p.portfolio_name
        FROM risk_limits l
        LEFT JOIN portfolios p ON l.portfolio_id = p.portfolio_id
        WHERE l.enabled = TRUE
        ORDER BY l.portfolio_id, l.limit_type
    </select>

    <!-- 更新限額檢查結果 -->
    <update id="updateCheckResult">
        UPDATE risk_limits
        SET current_value = #{currentValue},
            current_utilization = #{utilization},
            current_status = #{status},
            last_checked_at = CURRENT_TIMESTAMP,
            updated_at = CURRENT_TIMESTAMP
        WHERE limit_id = #{limitId}
    </update>

    <!-- 批次更新限額狀態 -->
    <update id="batchUpdateStatus">
        <foreach collection="results" item="r" separator=";">
            UPDATE risk_limits
            SET current_value = #{r.currentValue},
                current_utilization = #{r.utilization},
                current_status = #{r.status},
                last_checked_at = CURRENT_TIMESTAMP
            WHERE limit_id = #{r.limitId}
        </foreach>
    </update>

    <!-- 統計限額狀態 -->
    <select id="getLimitStatusSummary" resultType="LimitStatusSummary">
        SELECT
            COUNT(*) as total_limits,
            COUNT(*) FILTER (WHERE current_status = 'NORMAL') as normal_count,
            COUNT(*) FILTER (WHERE current_status = 'WARNING') as warning_count,
            COUNT(*) FILTER (WHERE current_status = 'CRITICAL') as critical_count,
            COUNT(*) FILTER (WHERE current_status = 'BREACHED') as breached_count
        FROM risk_limits
        WHERE portfolio_id = #{portfolioId}
          AND enabled = TRUE
    </select>

</mapper>
```

### 3.3 RiskAlertMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.chris.fin_shark.m17.mapper.RiskAlertMapper">

    <!-- 取得有效預警 -->
    <select id="findActiveAlerts" resultType="RiskAlert">
        SELECT a.*, p.portfolio_name
        FROM risk_alerts a
        LEFT JOIN portfolios p ON a.portfolio_id = p.portfolio_id
        WHERE a.status IN ('ACTIVE', 'ACKNOWLEDGED')
        <if test="portfolioId != null">
            AND a.portfolio_id = #{portfolioId}
        </if>
        <if test="severity != null">
            AND a.severity = #{severity}
        </if>
        <if test="alertType != null">
            AND a.alert_type = #{alertType}
        </if>
        ORDER BY
            CASE a.severity
                WHEN 'CRITICAL' THEN 1
                WHEN 'HIGH' THEN 2
                WHEN 'MEDIUM' THEN 3
                WHEN 'LOW' THEN 4
            END,
            a.triggered_at DESC
    </select>

    <!-- 統計預警數量 -->
    <select id="getAlertSummary" resultType="AlertSummary">
        SELECT
            COUNT(*) as total_active,
            COUNT(*) FILTER (WHERE severity = 'CRITICAL') as critical_count,
            COUNT(*) FILTER (WHERE severity = 'HIGH') as high_count,
            COUNT(*) FILTER (WHERE severity = 'MEDIUM') as medium_count,
            COUNT(*) FILTER (WHERE severity = 'LOW') as low_count
        FROM risk_alerts
        WHERE status = 'ACTIVE'
        <if test="portfolioId != null">
            AND portfolio_id = #{portfolioId}
        </if>
    </select>

    <!-- 確認預警 -->
    <update id="acknowledgeAlert">
        UPDATE risk_alerts
        SET status = 'ACKNOWLEDGED',
            acknowledged_at = CURRENT_TIMESTAMP,
            acknowledged_by = #{acknowledgedBy},
            acknowledge_note = #{note},
            updated_at = CURRENT_TIMESTAMP
        WHERE alert_id = #{alertId}
          AND status = 'ACTIVE'
    </update>

    <!-- 解決預警 -->
    <update id="resolveAlert">
        UPDATE risk_alerts
        SET status = 'RESOLVED',
            resolved_at = CURRENT_TIMESTAMP,
            resolved_by = #{resolvedBy},
            resolution_note = #{note},
            updated_at = CURRENT_TIMESTAMP
        WHERE alert_id = #{alertId}
    </update>

    <!-- 批次解決符合條件的預警 -->
    <update id="autoResolveAlerts">
        UPDATE risk_alerts
        SET status = 'RESOLVED',
            resolved_at = CURRENT_TIMESTAMP,
            resolved_by = 'SYSTEM',
            resolution_note = '風險指標已回復正常',
            updated_at = CURRENT_TIMESTAMP
        WHERE portfolio_id = #{portfolioId}
          AND alert_type = #{alertType}
          AND status IN ('ACTIVE', 'ACKNOWLEDGED')
          AND trigger_value > #{currentValue}
    </update>

    <!-- 取得預警歷史 -->
    <select id="findAlertHistory" resultType="RiskAlert">
        SELECT *
        FROM risk_alerts
        WHERE portfolio_id = #{portfolioId}
        <if test="startDate != null">
            AND triggered_at >= #{startDate}
        </if>
        <if test="endDate != null">
            AND triggered_at &lt;= #{endDate}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY triggered_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

</mapper>
```

### 3.4 RiskStressTestMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.chris.fin_shark.m17.mapper.RiskStressTestMapper">

    <!-- 批次插入測試結果 -->
    <insert id="batchInsertResults">
        INSERT INTO risk_stress_results (
            test_id, scenario_id, scenario_name, scenario_type, scenario_description,
            shocks, market_change, portfolio_change, estimated_loss, final_value,
            position_impacts, passed, breached_limits
        ) VALUES
        <foreach collection="results" item="r" separator=",">
            (
                #{r.testId}, #{r.scenarioId}, #{r.scenarioName}, #{r.scenarioType},
                #{r.scenarioDescription}, #{r.shocks}::jsonb, #{r.marketChange},
                #{r.portfolioChange}, #{r.estimatedLoss}, #{r.finalValue},
                #{r.positionImpacts}::jsonb, #{r.passed}, #{r.breachedLimits}
            )
        </foreach>
    </insert>

    <!-- 更新測試狀態 -->
    <update id="updateTestStatus">
        UPDATE risk_stress_tests
        SET status = #{status},
            completed_scenarios = #{completedScenarios},
            <if test="status == 'COMPLETED'">
                scenarios_passed = #{scenariosPassed},
                scenarios_failed = #{scenariosFailed},
                worst_case_scenario = #{worstCaseScenario},
                worst_case_loss = #{worstCaseLoss},
                worst_case_pct = #{worstCasePct},
                avg_loss = #{avgLoss},
                completed_at = CURRENT_TIMESTAMP,
            </if>
            updated_at = CURRENT_TIMESTAMP
        WHERE test_id = #{testId}
    </update>

    <!-- 取得測試結果 -->
    <select id="findResultsByTestId" resultType="StressTestResult">
        SELECT *
        FROM risk_stress_results
        WHERE test_id = #{testId}
        ORDER BY estimated_loss DESC
    </select>

    <!-- 取得歷史測試清單 -->
    <select id="findTestHistory" resultType="RiskStressTest">
        SELECT *
        FROM risk_stress_tests
        WHERE portfolio_id = #{portfolioId}
          AND status = 'COMPLETED'
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

</mapper>
```

---

## 4. 資料關聯圖

```
┌─────────────────────────────────────────────────────────────────┐
│                      M17 資料關聯圖                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  核心表：                                                        │
│  ┌─────────────────────┐                                        │
│  │   risk_snapshots    │ <-- 每日風險快照，所有指標              │
│  │   (每日快照)         │                                        │
│  └─────────────────────┘                                        │
│                                                                  │
│  ┌─────────────────────┐                                        │
│  │   risk_var_results  │ <-- VaR 詳細計算結果                    │
│  │   (VaR 結果)         │                                        │
│  └─────────────────────┘                                        │
│                                                                  │
│  限額與預警：                                                     │
│  ┌─────────────────────┐      ┌─────────────────────┐          │
│  │    risk_limits      │──────│  risk_limit_checks  │          │
│  │    (風險限額)        │  1:N │  (限額檢查記錄)      │          │
│  └─────────────────────┘      └─────────────────────┘          │
│                                          │                      │
│  ┌─────────────────────┐                 │                      │
│  │  risk_alert_rules   │─────────────────┼───────┐              │
│  │  (預警規則)          │                 │       │              │
│  └─────────────────────┘                 ▼       ▼              │
│                               ┌─────────────────────┐          │
│                               │    risk_alerts      │          │
│                               │    (風險預警)        │          │
│                               └─────────────────────┘          │
│                                                                  │
│  壓力測試：                                                       │
│  ┌─────────────────────┐      ┌─────────────────────┐          │
│  │  risk_stress_tests  │──────│ risk_stress_results │          │
│  │  (壓力測試)          │  1:N │ (測試結果)           │          │
│  └─────────────────────┘      └─────────────────────┘          │
│             │                                                    │
│             ▼                                                    │
│  ┌─────────────────────┐                                        │
│  │   risk_scenarios    │ <-- 自訂/系統情境                       │
│  │   (測試情境)         │                                        │
│  └─────────────────────┘                                        │
│                                                                  │
│  快取：                                                          │
│  ┌──────────────────────────┐                                   │
│  │ risk_correlation_cache   │ <-- 相關性矩陣快取                 │
│  └──────────────────────────┘                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 相關文檔

- [M17 功能需求](../specs/functional/M17-風險管理功能需求.md)
- [M17 API 規格](../specs/api/M17-API規格.md)
- [M17 ERD](./erd/M17-ERD.md)

---

**文件維護者**: 後端工程師
**最後更新**: 2026-01-15
**下次審核**: 2026-04-15
