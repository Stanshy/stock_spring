# M12-ç¸½ç¶“èˆ‡ç”¢æ¥­åˆ†ææ¨¡çµ„è³‡æ–™åº«è¨­è¨ˆ

> **æ–‡ä»¶ç·¨è™Ÿ**: DB-M12
> **æ¨¡çµ„åç¨±**: ç¸½ç¶“èˆ‡ç”¢æ¥­åˆ†ææ¨¡çµ„
> **ç‰ˆæœ¬**: v1.0
> **æœ€å¾Œæ›´æ–°**: 2026-01-14
> **ç‹€æ…‹**: Draft

---

## 1. è³‡æ–™åº«è¨­è¨ˆç¸½è¦½

### 1.1 è¨­è¨ˆåŸå‰‡

| åŸå‰‡ | èªªæ˜ |
|-----|------|
| æŒä¹…å±¤é¸æ“‡ | JPA ç‚ºä¸»ï¼ˆå¯¦é«”æ“ä½œå°å‘ï¼‰ |
| æ­£è¦åŒ–ç¨‹åº¦ | ç¬¬ä¸‰æ­£è¦åŒ– (3NF) |
| å‘½åè¦ç¯„ | snake_case |
| ä¸»éµç­–ç•¥ | æ¥­å‹™ä¸»éµ + è‡ªç„¶ä¸»éµ |
| æ™‚å€è™•ç† | UTC å„²å­˜ï¼Œæ‡‰ç”¨å±¤è½‰æ› |

### 1.2 è³‡æ–™è¡¨æ¸…å–®

| è¡¨å | èªªæ˜ | é ä¼°è³‡æ–™é‡ |
|-----|------|-----------|
| macro_indicators | ç¸½ç¶“æŒ‡æ¨™å®šç¾© | ~30 ç­† |
| macro_indicator_values | ç¸½ç¶“æŒ‡æ¨™æ­·å²å€¼ | ~10,000 ç­†/å¹´ |
| economic_cycles | ç¶“æ¿Ÿé€±æœŸè¨˜éŒ„ | ~50 ç­† |
| sectors | ç”¢æ¥­åˆ†é¡å®šç¾© | ~50 ç­† |
| stock_classifications | è‚¡ç¥¨ç”¢æ¥­åˆ†é¡ | ~2,000 ç­† |
| themes | è‡ªè¨‚ä¸»é¡Œå®šç¾© | ~20 ç­† |
| theme_stocks | ä¸»é¡Œæˆåˆ†è‚¡ | ~500 ç­† |
| sector_performance | ç”¢æ¥­ç¸¾æ•ˆæ­·å² | ~15,000 ç­†/å¹´ |
| sector_valuation | ç”¢æ¥­ä¼°å€¼æ­·å² | ~15,000 ç­†/å¹´ |
| industry_signals | ç”¢æ¥­ä¿¡è™Ÿè¨˜éŒ„ | ~2,000 ç­†/å¹´ |

---

## 2. è³‡æ–™è¡¨è©³ç´°è¨­è¨ˆ

### 2.1 macro_indicatorsï¼ˆç¸½ç¶“æŒ‡æ¨™å®šç¾©è¡¨ï¼‰

**èªªæ˜**: å„²å­˜ç¸½ç¶“æŒ‡æ¨™çš„åŸºæœ¬å®šç¾©

```sql
CREATE TABLE macro_indicators (
    indicator_code VARCHAR(50) PRIMARY KEY,
    indicator_name VARCHAR(100) NOT NULL,
    indicator_name_en VARCHAR(100),
    region VARCHAR(10) NOT NULL DEFAULT 'TW',
    category VARCHAR(30) NOT NULL,
    description TEXT,
    unit VARCHAR(20),
    frequency VARCHAR(20) NOT NULL,
    source VARCHAR(100),
    source_url VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    display_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_region CHECK (region IN ('TW', 'US', 'CN', 'JP', 'EU', 'GLOBAL')),
    CONSTRAINT chk_category CHECK (category IN ('GDP', 'INFLATION', 'INTEREST', 'TRADE', 'MONEY', 'EMPLOYMENT', 'SENTIMENT', 'MARKET')),
    CONSTRAINT chk_frequency CHECK (frequency IN ('DAILY', 'WEEKLY', 'MONTHLY', 'QUARTERLY', 'YEARLY', 'IRREGULAR'))
);

COMMENT ON TABLE macro_indicators IS 'ç¸½ç¶“æŒ‡æ¨™å®šç¾©è¡¨';
COMMENT ON COLUMN macro_indicators.indicator_code IS 'æŒ‡æ¨™ä»£ç¢¼ï¼ˆä¸»éµï¼‰';
COMMENT ON COLUMN macro_indicators.region IS 'åœ°å€ï¼šTW/US/CN/JP/EU/GLOBAL';
COMMENT ON COLUMN macro_indicators.category IS 'é¡åˆ¥ï¼šGDP/INFLATION/INTEREST/TRADE/MONEY/EMPLOYMENT/SENTIMENT/MARKET';
COMMENT ON COLUMN macro_indicators.frequency IS 'æ›´æ–°é »ç‡ï¼šDAILY/WEEKLY/MONTHLY/QUARTERLY/YEARLY/IRREGULAR';

-- ç´¢å¼•
CREATE INDEX idx_macro_indicators_region ON macro_indicators(region);
CREATE INDEX idx_macro_indicators_category ON macro_indicators(category);
CREATE INDEX idx_macro_indicators_active ON macro_indicators(is_active);
```

---

### 2.2 macro_indicator_valuesï¼ˆç¸½ç¶“æŒ‡æ¨™æ­·å²å€¼è¡¨ï¼‰

**èªªæ˜**: å„²å­˜ç¸½ç¶“æŒ‡æ¨™çš„æ­·å²æ•¸å€¼

```sql
CREATE TABLE macro_indicator_values (
    id BIGSERIAL PRIMARY KEY,
    indicator_code VARCHAR(50) NOT NULL REFERENCES macro_indicators(indicator_code),
    value_date DATE NOT NULL,
    value DECIMAL(20,6) NOT NULL,
    previous_value DECIMAL(20,6),
    change_value DECIMAL(20,6),
    change_percent DECIMAL(10,4),
    revision_number INTEGER DEFAULT 0,
    is_preliminary BOOLEAN DEFAULT FALSE,
    source_date DATE,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uk_macro_value UNIQUE (indicator_code, value_date)
);

COMMENT ON TABLE macro_indicator_values IS 'ç¸½ç¶“æŒ‡æ¨™æ­·å²å€¼è¡¨';
COMMENT ON COLUMN macro_indicator_values.revision_number IS 'ä¿®æ­£æ¬¡æ•¸ï¼ˆ0=åˆç‰ˆï¼‰';
COMMENT ON COLUMN macro_indicator_values.is_preliminary IS 'æ˜¯å¦ç‚ºåˆå€¼ï¼ˆå¯èƒ½ä¿®æ­£ï¼‰';

-- ç´¢å¼•
CREATE INDEX idx_macro_values_indicator ON macro_indicator_values(indicator_code);
CREATE INDEX idx_macro_values_date ON macro_indicator_values(value_date DESC);
CREATE INDEX idx_macro_values_composite ON macro_indicator_values(indicator_code, value_date DESC);

-- åˆ†å€ï¼ˆæŒ‰å¹´ï¼‰
-- CREATE TABLE macro_indicator_values_2024 PARTITION OF macro_indicator_values
--     FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
```

---

### 2.3 economic_cyclesï¼ˆç¶“æ¿Ÿé€±æœŸè¨˜éŒ„è¡¨ï¼‰

**èªªæ˜**: è¨˜éŒ„ç¶“æ¿Ÿé€±æœŸåˆ¤æ–·æ­·å²

```sql
CREATE TABLE economic_cycles (
    cycle_id BIGSERIAL PRIMARY KEY,
    cycle_stage VARCHAR(20) NOT NULL,
    stage_name VARCHAR(50) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE,
    duration_months INTEGER,
    confidence DECIMAL(5,4),
    determination_date DATE NOT NULL,
    key_indicators JSONB,
    analysis_notes TEXT,
    is_current BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_cycle_stage CHECK (cycle_stage IN ('DEPRESSION', 'RECOVERY', 'EXPANSION', 'OVERHEATING', 'RECESSION', 'UNCERTAIN'))
);

COMMENT ON TABLE economic_cycles IS 'ç¶“æ¿Ÿé€±æœŸè¨˜éŒ„è¡¨';
COMMENT ON COLUMN economic_cycles.cycle_stage IS 'é€±æœŸéšæ®µï¼šDEPRESSION/RECOVERY/EXPANSION/OVERHEATING/RECESSION/UNCERTAIN';
COMMENT ON COLUMN economic_cycles.key_indicators IS 'åˆ¤æ–·ä¾æ“šçš„é—œéµæŒ‡æ¨™ JSON';

-- ç´¢å¼•
CREATE INDEX idx_cycles_stage ON economic_cycles(cycle_stage);
CREATE INDEX idx_cycles_current ON economic_cycles(is_current) WHERE is_current = TRUE;
CREATE INDEX idx_cycles_date ON economic_cycles(start_date DESC);
```

**key_indicators JSONB çµæ§‹**:
```json
{
  "leading_index": {
    "value": 102.5,
    "trend": "UP",
    "months_in_trend": 6
  },
  "coincident_index": {
    "value": 98.3,
    "level": "MID_HIGH",
    "percentile": 68
  },
  "monitor_score": {
    "value": 28,
    "signal": "GREEN_YELLOW"
  }
}
```

---

### 2.4 sectorsï¼ˆç”¢æ¥­åˆ†é¡å®šç¾©è¡¨ï¼‰

**èªªæ˜**: å„²å­˜ç”¢æ¥­åˆ†é¡å®šç¾©

```sql
CREATE TABLE sectors (
    sector_code VARCHAR(20) PRIMARY KEY,
    sector_name VARCHAR(100) NOT NULL,
    sector_name_en VARCHAR(100),
    level INTEGER NOT NULL DEFAULT 1,
    parent_code VARCHAR(20) REFERENCES sectors(sector_code),
    classification_type VARCHAR(20) NOT NULL DEFAULT 'TWSE',
    description TEXT,
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_level CHECK (level IN (1, 2, 3)),
    CONSTRAINT chk_classification_type CHECK (classification_type IN ('TWSE', 'CUSTOM'))
);

COMMENT ON TABLE sectors IS 'ç”¢æ¥­åˆ†é¡å®šç¾©è¡¨';
COMMENT ON COLUMN sectors.level IS 'åˆ†é¡å±¤ç´šï¼š1=å¤§é¡, 2=ä¸­é¡, 3=å°é¡';
COMMENT ON COLUMN sectors.classification_type IS 'åˆ†é¡é«”ç³»ï¼šTWSE=è­‰äº¤æ‰€æ¨™æº–, CUSTOM=è‡ªè¨‚';

-- ç´¢å¼•
CREATE INDEX idx_sectors_parent ON sectors(parent_code);
CREATE INDEX idx_sectors_type ON sectors(classification_type);
CREATE INDEX idx_sectors_level ON sectors(level);
CREATE INDEX idx_sectors_active ON sectors(is_active);
```

---

### 2.5 stock_classificationsï¼ˆè‚¡ç¥¨ç”¢æ¥­åˆ†é¡è¡¨ï¼‰

**èªªæ˜**: å„²å­˜è‚¡ç¥¨èˆ‡ç”¢æ¥­çš„å°æ‡‰é—œä¿‚

```sql
CREATE TABLE stock_classifications (
    id BIGSERIAL PRIMARY KEY,
    stock_id VARCHAR(10) NOT NULL,
    sector_code VARCHAR(20) NOT NULL REFERENCES sectors(sector_code),
    classification_type VARCHAR(20) NOT NULL DEFAULT 'TWSE',
    is_primary BOOLEAN DEFAULT TRUE,
    effective_date DATE NOT NULL,
    end_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uk_stock_sector UNIQUE (stock_id, sector_code, effective_date)
);

COMMENT ON TABLE stock_classifications IS 'è‚¡ç¥¨ç”¢æ¥­åˆ†é¡å°æ‡‰è¡¨';
COMMENT ON COLUMN stock_classifications.is_primary IS 'æ˜¯å¦ç‚ºä¸»è¦åˆ†é¡';
COMMENT ON COLUMN stock_classifications.effective_date IS 'ç”Ÿæ•ˆæ—¥æœŸ';
COMMENT ON COLUMN stock_classifications.end_date IS 'çµæŸæ—¥æœŸï¼ˆNULL è¡¨ç¤ºä»æœ‰æ•ˆï¼‰';

-- ç´¢å¼•
CREATE INDEX idx_stock_class_stock ON stock_classifications(stock_id);
CREATE INDEX idx_stock_class_sector ON stock_classifications(sector_code);
CREATE INDEX idx_stock_class_effective ON stock_classifications(effective_date);
CREATE INDEX idx_stock_class_active ON stock_classifications(stock_id, sector_code) WHERE end_date IS NULL;
```

---

### 2.6 themesï¼ˆè‡ªè¨‚ä¸»é¡Œå®šç¾©è¡¨ï¼‰

**èªªæ˜**: å„²å­˜è‡ªè¨‚æŠ•è³‡ä¸»é¡Œå®šç¾©

```sql
CREATE TABLE themes (
    theme_code VARCHAR(30) PRIMARY KEY,
    theme_name VARCHAR(100) NOT NULL,
    theme_name_en VARCHAR(100),
    description TEXT,
    inclusion_criteria TEXT,
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_by VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE themes IS 'è‡ªè¨‚ä¸»é¡Œå®šç¾©è¡¨';
COMMENT ON COLUMN themes.inclusion_criteria IS 'ç´å…¥æ¨™æº–èªªæ˜';

-- ç´¢å¼•
CREATE INDEX idx_themes_active ON themes(is_active);
```

---

### 2.7 theme_stocksï¼ˆä¸»é¡Œæˆåˆ†è‚¡è¡¨ï¼‰

**èªªæ˜**: å„²å­˜ä¸»é¡Œèˆ‡è‚¡ç¥¨çš„å°æ‡‰é—œä¿‚

```sql
CREATE TABLE theme_stocks (
    id BIGSERIAL PRIMARY KEY,
    theme_code VARCHAR(30) NOT NULL REFERENCES themes(theme_code),
    stock_id VARCHAR(10) NOT NULL,
    inclusion_reason TEXT,
    weight DECIMAL(5,2),
    effective_date DATE NOT NULL,
    end_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uk_theme_stock UNIQUE (theme_code, stock_id, effective_date)
);

COMMENT ON TABLE theme_stocks IS 'ä¸»é¡Œæˆåˆ†è‚¡å°æ‡‰è¡¨';
COMMENT ON COLUMN theme_stocks.inclusion_reason IS 'ç´å…¥åŸå› ';
COMMENT ON COLUMN theme_stocks.weight IS 'ä¸»é¡Œå…§æ¬Šé‡ï¼ˆ%ï¼‰';

-- ç´¢å¼•
CREATE INDEX idx_theme_stocks_theme ON theme_stocks(theme_code);
CREATE INDEX idx_theme_stocks_stock ON theme_stocks(stock_id);
CREATE INDEX idx_theme_stocks_active ON theme_stocks(theme_code, stock_id) WHERE end_date IS NULL;
```

---

### 2.8 sector_performanceï¼ˆç”¢æ¥­ç¸¾æ•ˆæ­·å²è¡¨ï¼‰

**èªªæ˜**: å„²å­˜ç”¢æ¥­ç¸¾æ•ˆè¨ˆç®—çµæœ

```sql
CREATE TABLE sector_performance (
    id BIGSERIAL PRIMARY KEY,
    sector_code VARCHAR(20) NOT NULL REFERENCES sectors(sector_code),
    trade_date DATE NOT NULL,

    -- å ±é…¬ç‡æŒ‡æ¨™
    return_1d DECIMAL(10,4),
    return_5d DECIMAL(10,4),
    return_20d DECIMAL(10,4),
    return_60d DECIMAL(10,4),
    return_ytd DECIMAL(10,4),

    -- å‹•èƒ½æŒ‡æ¨™
    momentum_20d DECIMAL(10,4),
    relative_strength DECIMAL(10,4),

    -- å¸‚å ´å»£åº¦
    advance_count INTEGER,
    decline_count INTEGER,
    unchanged_count INTEGER,
    breadth DECIMAL(5,2),

    -- æˆäº¤è³‡è¨Š
    total_volume BIGINT,
    total_value BIGINT,
    volume_change DECIMAL(10,4),

    -- æ’å
    return_rank INTEGER,
    momentum_rank INTEGER,

    -- å¸‚å€¼
    total_market_cap BIGINT,
    weight_in_market DECIMAL(5,2),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uk_sector_perf UNIQUE (sector_code, trade_date)
);

COMMENT ON TABLE sector_performance IS 'ç”¢æ¥­ç¸¾æ•ˆæ­·å²è¡¨';
COMMENT ON COLUMN sector_performance.momentum_20d IS '20 æ—¥å‹•èƒ½ï¼ˆå ±é…¬/æ³¢å‹•ï¼‰';
COMMENT ON COLUMN sector_performance.relative_strength IS 'ç›¸å°å¤§ç›¤è¶…é¡å ±é…¬';
COMMENT ON COLUMN sector_performance.breadth IS 'æ¼²è·Œå®¶æ•¸æ¯”ï¼ˆ%ï¼‰';

-- ç´¢å¼•
CREATE INDEX idx_sector_perf_sector ON sector_performance(sector_code);
CREATE INDEX idx_sector_perf_date ON sector_performance(trade_date DESC);
CREATE INDEX idx_sector_perf_composite ON sector_performance(sector_code, trade_date DESC);
CREATE INDEX idx_sector_perf_return_rank ON sector_performance(trade_date, return_rank);
CREATE INDEX idx_sector_perf_momentum_rank ON sector_performance(trade_date, momentum_rank);

-- åˆ†å€ï¼ˆæŒ‰å¹´ï¼‰
-- CREATE TABLE sector_performance_2024 PARTITION OF sector_performance
--     FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
```

---

### 2.9 sector_valuationï¼ˆç”¢æ¥­ä¼°å€¼æ­·å²è¡¨ï¼‰

**èªªæ˜**: å„²å­˜ç”¢æ¥­ä¼°å€¼è¨ˆç®—çµæœ

```sql
CREATE TABLE sector_valuation (
    id BIGSERIAL PRIMARY KEY,
    sector_code VARCHAR(20) NOT NULL REFERENCES sectors(sector_code),
    trade_date DATE NOT NULL,

    -- æœ¬ç›Šæ¯”
    pe_ratio DECIMAL(10,2),
    pe_percentile DECIMAL(5,2),
    pe_5y_avg DECIMAL(10,2),

    -- è‚¡åƒ¹æ·¨å€¼æ¯”
    pb_ratio DECIMAL(10,2),
    pb_percentile DECIMAL(5,2),
    pb_5y_avg DECIMAL(10,2),

    -- è‚¡åˆ©ç‡
    dividend_yield DECIMAL(5,2),
    dy_percentile DECIMAL(5,2),
    dy_5y_avg DECIMAL(5,2),

    -- EV/EBITDA
    ev_ebitda DECIMAL(10,2),

    -- èˆ‡å¤§ç›¤æ¯”è¼ƒ
    pe_vs_market DECIMAL(10,2),
    pb_vs_market DECIMAL(10,2),

    -- ä¼°å€¼ä¿¡è™Ÿ
    valuation_signal VARCHAR(20),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uk_sector_val UNIQUE (sector_code, trade_date),
    CONSTRAINT chk_val_signal CHECK (valuation_signal IN ('UNDERVALUED', 'FAIR', 'OVERVALUED'))
);

COMMENT ON TABLE sector_valuation IS 'ç”¢æ¥­ä¼°å€¼æ­·å²è¡¨';
COMMENT ON COLUMN sector_valuation.pe_percentile IS 'PE æ­·å²ç™¾åˆ†ä½ï¼ˆ0-100ï¼‰';
COMMENT ON COLUMN sector_valuation.valuation_signal IS 'ä¼°å€¼ä¿¡è™Ÿï¼šUNDERVALUED/FAIR/OVERVALUED';

-- ç´¢å¼•
CREATE INDEX idx_sector_val_sector ON sector_valuation(sector_code);
CREATE INDEX idx_sector_val_date ON sector_valuation(trade_date DESC);
CREATE INDEX idx_sector_val_signal ON sector_valuation(trade_date, valuation_signal);
```

---

### 2.10 industry_signalsï¼ˆç”¢æ¥­ä¿¡è™Ÿè¨˜éŒ„è¡¨ï¼‰

**èªªæ˜**: å„²å­˜ç”¢ç”Ÿçš„ç”¢æ¥­ç›¸é—œä¿¡è™Ÿ

```sql
CREATE TABLE industry_signals (
    signal_id VARCHAR(50) PRIMARY KEY,
    signal_type VARCHAR(30) NOT NULL,
    signal_code VARCHAR(30) NOT NULL,
    signal_name VARCHAR(100) NOT NULL,
    target_type VARCHAR(20) NOT NULL,
    target_id VARCHAR(30) NOT NULL,
    target_name VARCHAR(100),
    signal_date DATE NOT NULL,
    signal_value JSONB,
    confidence_score DECIMAL(5,4),
    description TEXT,
    is_consumed BOOLEAN DEFAULT FALSE,
    consumed_at TIMESTAMP,
    consumed_by VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_signal_type CHECK (signal_type IN ('INDUSTRY_ROTATION', 'INDUSTRY_MOMENTUM', 'INDUSTRY_VALUATION', 'MACRO_CYCLE', 'MACRO_RATE', 'MACRO_MONITOR')),
    CONSTRAINT chk_target_type CHECK (target_type IN ('SECTOR', 'THEME', 'MACRO'))
);

COMMENT ON TABLE industry_signals IS 'ç”¢æ¥­ä¿¡è™Ÿè¨˜éŒ„è¡¨';
COMMENT ON COLUMN industry_signals.signal_type IS 'ä¿¡è™Ÿé¡å‹';
COMMENT ON COLUMN industry_signals.target_type IS 'ç›®æ¨™é¡å‹ï¼šSECTOR=ç”¢æ¥­, THEME=ä¸»é¡Œ, MACRO=ç¸½ç¶“';
COMMENT ON COLUMN industry_signals.is_consumed IS 'æ˜¯å¦å·²è¢« M13 æ¶ˆè²»';
COMMENT ON COLUMN industry_signals.consumed_by IS 'æ¶ˆè²»è€…ï¼ˆé€šå¸¸ç‚º M13ï¼‰';

-- ç´¢å¼•
CREATE INDEX idx_ind_signals_type ON industry_signals(signal_type);
CREATE INDEX idx_ind_signals_date ON industry_signals(signal_date DESC);
CREATE INDEX idx_ind_signals_target ON industry_signals(target_type, target_id);
CREATE INDEX idx_ind_signals_unconsumed ON industry_signals(signal_date, is_consumed) WHERE is_consumed = FALSE;
CREATE INDEX idx_ind_signals_consumed ON industry_signals(consumed_at DESC) WHERE is_consumed = TRUE;
```

**signal_value JSONB çµæ§‹ç¯„ä¾‹**:
```json
{
  "current_rank": 5,
  "previous_rank": 13,
  "rank_change": 8,
  "momentum_score": 75.5,
  "weeks_improving": 3
}
```

---

## 3. JPA Entity è¨­è¨ˆ

### 3.1 MacroIndicator Entity

```java
@Entity
@Table(name = "macro_indicators")
public class MacroIndicator {

    @Id
    @Column(name = "indicator_code", length = 50)
    private String indicatorCode;

    @Column(name = "indicator_name", nullable = false, length = 100)
    private String indicatorName;

    @Column(name = "indicator_name_en", length = 100)
    private String indicatorNameEn;

    @Column(name = "region", nullable = false, length = 10)
    @Enumerated(EnumType.STRING)
    private Region region = Region.TW;

    @Column(name = "category", nullable = false, length = 30)
    @Enumerated(EnumType.STRING)
    private MacroCategory category;

    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @Column(name = "unit", length = 20)
    private String unit;

    @Column(name = "frequency", nullable = false, length = 20)
    @Enumerated(EnumType.STRING)
    private Frequency frequency;

    @Column(name = "source", length = 100)
    private String source;

    @Column(name = "source_url", length = 500)
    private String sourceUrl;

    @Column(name = "is_active")
    private Boolean isActive = true;

    @Column(name = "display_order")
    private Integer displayOrder = 0;

    @OneToMany(mappedBy = "indicator", cascade = CascadeType.ALL)
    private List<MacroIndicatorValue> values;

    // Getters and Setters
}

public enum Region {
    TW, US, CN, JP, EU, GLOBAL
}

public enum MacroCategory {
    GDP, INFLATION, INTEREST, TRADE, MONEY, EMPLOYMENT, SENTIMENT, MARKET
}

public enum Frequency {
    DAILY, WEEKLY, MONTHLY, QUARTERLY, YEARLY, IRREGULAR
}
```

---

### 3.2 Sector Entity

```java
@Entity
@Table(name = "sectors")
public class Sector {

    @Id
    @Column(name = "sector_code", length = 20)
    private String sectorCode;

    @Column(name = "sector_name", nullable = false, length = 100)
    private String sectorName;

    @Column(name = "sector_name_en", length = 100)
    private String sectorNameEn;

    @Column(name = "level", nullable = false)
    private Integer level = 1;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "parent_code")
    private Sector parent;

    @OneToMany(mappedBy = "parent")
    private List<Sector> children;

    @Column(name = "classification_type", nullable = false, length = 20)
    @Enumerated(EnumType.STRING)
    private ClassificationType classificationType = ClassificationType.TWSE;

    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @Column(name = "is_active")
    private Boolean isActive = true;

    @OneToMany(mappedBy = "sector")
    private List<StockClassification> stockClassifications;

    // Getters and Setters
}

public enum ClassificationType {
    TWSE, CUSTOM
}
```

---

### 3.3 SectorPerformance Entity

```java
@Entity
@Table(name = "sector_performance")
public class SectorPerformance {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "sector_code", nullable = false)
    private Sector sector;

    @Column(name = "trade_date", nullable = false)
    private LocalDate tradeDate;

    // å ±é…¬ç‡
    @Column(name = "return_1d", precision = 10, scale = 4)
    private BigDecimal return1d;

    @Column(name = "return_5d", precision = 10, scale = 4)
    private BigDecimal return5d;

    @Column(name = "return_20d", precision = 10, scale = 4)
    private BigDecimal return20d;

    @Column(name = "return_60d", precision = 10, scale = 4)
    private BigDecimal return60d;

    @Column(name = "return_ytd", precision = 10, scale = 4)
    private BigDecimal returnYtd;

    // å‹•èƒ½
    @Column(name = "momentum_20d", precision = 10, scale = 4)
    private BigDecimal momentum20d;

    @Column(name = "relative_strength", precision = 10, scale = 4)
    private BigDecimal relativeStrength;

    // å¸‚å ´å»£åº¦
    @Column(name = "advance_count")
    private Integer advanceCount;

    @Column(name = "decline_count")
    private Integer declineCount;

    @Column(name = "breadth", precision = 5, scale = 2)
    private BigDecimal breadth;

    // æ’å
    @Column(name = "return_rank")
    private Integer returnRank;

    @Column(name = "momentum_rank")
    private Integer momentumRank;

    // å¸‚å€¼
    @Column(name = "total_market_cap")
    private Long totalMarketCap;

    @Column(name = "weight_in_market", precision = 5, scale = 2)
    private BigDecimal weightInMarket;

    // Getters and Setters
}
```

---

### 3.4 IndustrySignal Entity

```java
@Entity
@Table(name = "industry_signals")
public class IndustrySignal {

    @Id
    @Column(name = "signal_id", length = 50)
    private String signalId;

    @Column(name = "signal_type", nullable = false, length = 30)
    @Enumerated(EnumType.STRING)
    private IndustrySignalType signalType;

    @Column(name = "signal_code", nullable = false, length = 30)
    private String signalCode;

    @Column(name = "signal_name", nullable = false, length = 100)
    private String signalName;

    @Column(name = "target_type", nullable = false, length = 20)
    @Enumerated(EnumType.STRING)
    private TargetType targetType;

    @Column(name = "target_id", nullable = false, length = 30)
    private String targetId;

    @Column(name = "target_name", length = 100)
    private String targetName;

    @Column(name = "signal_date", nullable = false)
    private LocalDate signalDate;

    @Type(JsonType.class)
    @Column(name = "signal_value", columnDefinition = "jsonb")
    private Map<String, Object> signalValue;

    @Column(name = "confidence_score", precision = 5, scale = 4)
    private BigDecimal confidenceScore;

    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @Column(name = "is_consumed")
    private Boolean isConsumed = false;

    @Column(name = "consumed_at")
    private LocalDateTime consumedAt;

    @Column(name = "consumed_by", length = 20)
    private String consumedBy;

    @Column(name = "created_at")
    private LocalDateTime createdAt = LocalDateTime.now();

    // Getters and Setters
}

public enum IndustrySignalType {
    INDUSTRY_ROTATION,
    INDUSTRY_MOMENTUM,
    INDUSTRY_VALUATION,
    MACRO_CYCLE,
    MACRO_RATE,
    MACRO_MONITOR
}

public enum TargetType {
    SECTOR, THEME, MACRO
}
```

---

## 4. Repository è¨­è¨ˆ

### 4.1 MacroIndicatorRepository

```java
@Repository
public interface MacroIndicatorRepository extends JpaRepository<MacroIndicator, String> {

    List<MacroIndicator> findByRegionAndIsActiveTrue(Region region);

    List<MacroIndicator> findByCategoryAndIsActiveTrue(MacroCategory category);

    @Query("SELECT m FROM MacroIndicator m WHERE m.isActive = true ORDER BY m.displayOrder")
    List<MacroIndicator> findAllActiveOrdered();
}
```

### 4.2 SectorPerformanceRepository

```java
@Repository
public interface SectorPerformanceRepository extends JpaRepository<SectorPerformance, Long> {

    Optional<SectorPerformance> findBySectorSectorCodeAndTradeDate(String sectorCode, LocalDate tradeDate);

    @Query("SELECT sp FROM SectorPerformance sp WHERE sp.tradeDate = :date ORDER BY sp.returnRank")
    List<SectorPerformance> findByTradeDateOrderByReturnRank(@Param("date") LocalDate date);

    @Query("SELECT sp FROM SectorPerformance sp WHERE sp.tradeDate = :date ORDER BY sp.momentum20d DESC")
    List<SectorPerformance> findByTradeDateOrderByMomentum(@Param("date") LocalDate date);

    @Query("SELECT sp FROM SectorPerformance sp WHERE sp.sector.sectorCode = :sectorCode " +
           "AND sp.tradeDate BETWEEN :startDate AND :endDate ORDER BY sp.tradeDate DESC")
    List<SectorPerformance> findBySectorCodeAndDateRange(
            @Param("sectorCode") String sectorCode,
            @Param("startDate") LocalDate startDate,
            @Param("endDate") LocalDate endDate);
}
```

### 4.3 IndustrySignalRepository

```java
@Repository
public interface IndustrySignalRepository extends JpaRepository<IndustrySignal, String> {

    List<IndustrySignal> findBySignalDateAndIsConsumedFalse(LocalDate signalDate);

    @Query("SELECT s FROM IndustrySignal s WHERE s.isConsumed = false ORDER BY s.signalDate DESC, s.createdAt DESC")
    List<IndustrySignal> findAllUnconsumed();

    List<IndustrySignal> findBySignalTypeAndSignalDateBetween(
            IndustrySignalType signalType, LocalDate startDate, LocalDate endDate);

    @Modifying
    @Query("UPDATE IndustrySignal s SET s.isConsumed = true, s.consumedAt = :now, s.consumedBy = :consumer " +
           "WHERE s.signalId IN :signalIds")
    int markAsConsumed(@Param("signalIds") List<String> signalIds,
                       @Param("now") LocalDateTime now,
                       @Param("consumer") String consumer);
}
```

---

## 5. åˆå§‹åŒ–è³‡æ–™

### 5.1 ç¸½ç¶“æŒ‡æ¨™åˆå§‹è³‡æ–™

```sql
-- å°ç£ç¸½ç¶“æŒ‡æ¨™
INSERT INTO macro_indicators (indicator_code, indicator_name, region, category, unit, frequency, source) VALUES
('TW_GDP_YOY', 'GDP å¹´å¢ç‡', 'TW', 'GDP', '%', 'QUARTERLY', 'ä¸»è¨ˆç¸½è™•'),
('TW_CPI_YOY', 'CPI å¹´å¢ç‡', 'TW', 'INFLATION', '%', 'MONTHLY', 'ä¸»è¨ˆç¸½è™•'),
('TW_PMI', 'è£½é€ æ¥­ PMI', 'TW', 'SENTIMENT', 'æŒ‡æ•¸', 'MONTHLY', 'ä¸­ç¶“é™¢'),
('TW_EXPORT_YOY', 'å‡ºå£å¹´å¢ç‡', 'TW', 'TRADE', '%', 'MONTHLY', 'è²¡æ”¿éƒ¨'),
('TW_M1B_YOY', 'M1B å¹´å¢ç‡', 'TW', 'MONEY', '%', 'MONTHLY', 'å¤®è¡Œ'),
('TW_POLICY_RATE', 'å¤®è¡Œé‡è²¼ç¾ç‡', 'TW', 'INTEREST', '%', 'IRREGULAR', 'å¤®è¡Œ'),
('TW_LEADING_INDEX', 'æ™¯æ°£é ˜å…ˆæŒ‡æ¨™', 'TW', 'SENTIMENT', 'æŒ‡æ•¸', 'MONTHLY', 'åœ‹ç™¼æœƒ'),
('TW_MONITOR_SCORE', 'æ™¯æ°£ç‡ˆè™Ÿåˆ†æ•¸', 'TW', 'SENTIMENT', 'åˆ†', 'MONTHLY', 'åœ‹ç™¼æœƒ');

-- ç¾åœ‹ç¸½ç¶“æŒ‡æ¨™
INSERT INTO macro_indicators (indicator_code, indicator_name, region, category, unit, frequency, source) VALUES
('US_FED_RATE', 'è¯é‚¦åŸºé‡‘åˆ©ç‡', 'US', 'INTEREST', '%', 'IRREGULAR', 'Fed'),
('US_CPI_YOY', 'ç¾åœ‹ CPI å¹´å¢ç‡', 'US', 'INFLATION', '%', 'MONTHLY', 'BLS'),
('US_10Y_YIELD', 'ç¾åœ‹ 10 å¹´æœŸå…¬å‚µæ®–åˆ©ç‡', 'US', 'INTEREST', '%', 'DAILY', 'Treasury'),
('VIX', 'VIX ææ…ŒæŒ‡æ•¸', 'GLOBAL', 'MARKET', 'æŒ‡æ•¸', 'DAILY', 'CBOE');
```

### 5.2 ç”¢æ¥­åˆ†é¡åˆå§‹è³‡æ–™

```sql
-- å¤§é¡
INSERT INTO sectors (sector_code, sector_name, level, classification_type) VALUES
('E', 'é›»å­å·¥æ¥­', 1, 'TWSE'),
('F', 'é‡‘èä¿éšª', 1, 'TWSE'),
('T', 'å‚³çµ±ç”¢æ¥­', 1, 'TWSE');

-- ä¸­é¡ï¼ˆé›»å­ï¼‰
INSERT INTO sectors (sector_code, sector_name, level, parent_code, classification_type) VALUES
('24', 'åŠå°é«”æ¥­', 2, 'E', 'TWSE'),
('25', 'é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­', 2, 'E', 'TWSE'),
('26', 'å…‰é›»æ¥­', 2, 'E', 'TWSE'),
('27', 'é€šä¿¡ç¶²è·¯æ¥­', 2, 'E', 'TWSE'),
('28', 'é›»å­é›¶çµ„ä»¶æ¥­', 2, 'E', 'TWSE');

-- ä¸­é¡ï¼ˆé‡‘èï¼‰
INSERT INTO sectors (sector_code, sector_name, level, parent_code, classification_type) VALUES
('17', 'é‡‘èä¿éšªæ¥­', 2, 'F', 'TWSE');

-- ä¸­é¡ï¼ˆå‚³ç”¢ï¼‰
INSERT INTO sectors (sector_code, sector_name, level, parent_code, classification_type) VALUES
('01', 'æ°´æ³¥å·¥æ¥­', 2, 'T', 'TWSE'),
('02', 'é£Ÿå“å·¥æ¥­', 2, 'T', 'TWSE'),
('03', 'å¡‘è† å·¥æ¥­', 2, 'T', 'TWSE'),
('11', 'é‹¼éµå·¥æ¥­', 2, 'T', 'TWSE'),
('31', 'èˆªé‹æ¥­', 2, 'T', 'TWSE');
```

### 5.3 ä¸»é¡Œåˆå§‹è³‡æ–™

```sql
INSERT INTO themes (theme_code, theme_name, description) VALUES
('AI_CONCEPT', 'AI æ¦‚å¿µè‚¡', 'äººå·¥æ™ºæ…§ç›¸é—œæ¦‚å¿µè‚¡ï¼ŒåŒ…å« AI æ™¶ç‰‡ã€é›²ç«¯é‹ç®—ã€AI æ‡‰ç”¨ç­‰'),
('EV_CONCEPT', 'é›»å‹•è»Šæ¦‚å¿µ', 'é›»å‹•è»Šä¾›æ‡‰éˆç›¸é—œï¼ŒåŒ…å«é›»æ± ã€é¦¬é”ã€å……é›»è¨­å‚™ç­‰'),
('5G_CONCEPT', '5G æ¦‚å¿µè‚¡', '5G åŸºç¤å»ºè¨­èˆ‡æ‡‰ç”¨ç›¸é—œ'),
('ESG_LEADER', 'ESG é ˜è¢–è‚¡', 'ESG è©•åˆ†å„ªè‰¯çš„ä¼æ¥­'),
('DIVIDEND_KING', 'é«˜è‚¡æ¯ç²¾é¸', 'é€£çºŒé…æ¯ä¸”æ®–åˆ©ç‡ç©©å®šçš„è‚¡ç¥¨'),
('GROWTH_STOCK', 'æˆé•·å‹•èƒ½è‚¡', 'ç‡Ÿæ”¶èˆ‡ç²åˆ©é«˜æˆé•·çš„ä¼æ¥­');
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [M12 åŠŸèƒ½éœ€æ±‚](../specs/functional/M12-ç¸½ç¶“ç”¢æ¥­åˆ†æåŠŸèƒ½éœ€æ±‚.md)
- [M12 API è¦æ ¼](../specs/api/M12-APIè¦æ ¼.md)
- [M12 ERD](./erd/M12-ERD.md)
- [å…¨ç³»çµ±è³‡æ–™åº«è¦ç¯„](../specs/technical/00-å…¨ç³»çµ±å¥‘ç´„.md#4-è³‡æ–™åº«è¦ç¯„)

---

**æ–‡ä»¶ç¶­è­·è€…**: è³‡æ–™åº«ç®¡ç†å“¡
**æœ€å¾Œæ›´æ–°**: 2026-01-14
**ä¸‹æ¬¡å¯©æ ¸**: 2026-04-14
