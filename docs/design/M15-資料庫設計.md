# M15-è­¦å ±é€šçŸ¥ç³»çµ± è³‡æ–™åº«è¨­è¨ˆ

> **æ–‡ä»¶ç·¨è™Ÿ**: DB-M15
> **æ¨¡çµ„åç¨±**: è­¦å ±é€šçŸ¥ç³»çµ± (Alert Notification System)
> **ç‰ˆæœ¬**: v1.0
> **æœ€å¾Œæ›´æ–°**: 2026-01-15
> **ç‹€æ…‹**: Draft

---

## 1. è¨­è¨ˆæ¦‚è¿°

### 1.1 è¨­è¨ˆç›®æ¨™

- å„²å­˜ç”¨æˆ¶è­¦å ±è¦å‰‡èˆ‡é€šçŸ¥è¨­å®š
- è¨˜éŒ„è­¦å ±æ­·å²èˆ‡é€šçŸ¥ç‹€æ…‹
- æ”¯æ´å¤šé€šçŸ¥ç®¡é“æ•´åˆ
- æä¾›é«˜æ•ˆçš„è¦å‰‡æ¯”å°æŸ¥è©¢

### 1.2 æŒä¹…å±¤ç­–ç•¥

| æ“ä½œé¡å‹ | æŠ€è¡“é¸æ“‡ | èªªæ˜ |
|---------|---------|------|
| è¦å‰‡ CRUD | JPA | æ¨™æº–å¢åˆªæ”¹æŸ¥ |
| è­¦å ±è¨˜éŒ„ | JPA | å¯¦é«”é—œè¯æ“ä½œ |
| è¦å‰‡æ¯”å° | JPA | ç°¡å–®æŸ¥è©¢ |
| æ­·å²æŸ¥è©¢ | JPA | åˆ†é æŸ¥è©¢ |
| çµ±è¨ˆåˆ†æ | JPA + JPQL | èšåˆæŸ¥è©¢ |

### 1.3 è¡¨æ ¼ç¸½è¦½

| # | è¡¨æ ¼åç¨± | èªªæ˜ | é ä¼°è³‡æ–™é‡ |
|---|---------|------|-----------|
| 1 | alert_rules | è­¦å ±è¦å‰‡å®šç¾© | 20 è¬ç­† |
| 2 | alert_history | è­¦å ±æ­·å²è¨˜éŒ„ | 1000 è¬ç­†/å¹´ |
| 3 | notification_logs | é€šçŸ¥ç™¼é€æ—¥èªŒ | 2000 è¬ç­†/å¹´ |
| 4 | user_notification_settings | ç”¨æˆ¶é€šçŸ¥è¨­å®š | 1 è¬ç­† |
| 5 | user_devices | ç”¨æˆ¶è£ç½® (FCM) | 3 è¬ç­† |
| 6 | notification_templates | é€šçŸ¥ç¯„æœ¬ | 20 ç­† |

---

## 2. è¡¨æ ¼è©³ç´°è¨­è¨ˆ

### 2.1 alert_rulesï¼ˆè­¦å ±è¦å‰‡è¡¨ï¼‰

å„²å­˜ç”¨æˆ¶å®šç¾©çš„è­¦å ±è¦å‰‡ã€‚

```sql
CREATE TABLE alert_rules (
    id                  BIGSERIAL PRIMARY KEY,
    rule_id             VARCHAR(50) NOT NULL UNIQUE,
    user_id             VARCHAR(50) NOT NULL,
    rule_name           VARCHAR(100) NOT NULL,
    rule_type           VARCHAR(20) NOT NULL,
    enabled             BOOLEAN DEFAULT TRUE,
    conditions          JSONB NOT NULL,
    condition_summary   VARCHAR(200),
    notification_channels JSONB NOT NULL,
    notification_priority VARCHAR(10) DEFAULT 'NORMAL',
    throttle_max_per_day INTEGER DEFAULT 20,
    throttle_cooldown_minutes INTEGER DEFAULT 60,
    triggered_count     INTEGER DEFAULT 0,
    last_triggered_at   TIMESTAMP WITH TIME ZONE,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_rule_type CHECK (rule_type IN ('SIGNAL', 'PRICE', 'CHANGE', 'VOLUME', 'WATCHLIST')),
    CONSTRAINT chk_priority CHECK (notification_priority IN ('HIGH', 'NORMAL', 'LOW'))
);

-- ç´¢å¼•
CREATE INDEX idx_rules_user ON alert_rules(user_id, enabled);
CREATE INDEX idx_rules_type ON alert_rules(rule_type, enabled);
CREATE INDEX idx_rules_user_enabled ON alert_rules(user_id) WHERE enabled = TRUE;

COMMENT ON TABLE alert_rules IS 'è­¦å ±è¦å‰‡å®šç¾©è¡¨';
COMMENT ON COLUMN alert_rules.conditions IS 'è§¸ç™¼æ¢ä»¶ (JSONB)';
COMMENT ON COLUMN alert_rules.notification_channels IS 'é€šçŸ¥ç®¡é“åˆ—è¡¨ (JSONB)';
```

**Conditions JSONB çµæ§‹**:
```json
{
  "stockIds": ["2330", "2317"],
  "directions": ["BUY"],
  "minGrade": "B+",
  "minScore": 70,
  "priceAbove": null,
  "priceBelow": null,
  "changePercentAbove": null,
  "changePercentBelow": null,
  "volumeMultiple": null
}
```

**JPA Entity**:
```java
@Entity
@Table(name = "alert_rules")
public class AlertRule {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "rule_id", nullable = false, unique = true)
    private String ruleId;

    @Column(name = "user_id", nullable = false)
    private String userId;

    @Column(name = "rule_name", nullable = false)
    private String ruleName;

    @Enumerated(EnumType.STRING)
    @Column(name = "rule_type", nullable = false)
    private RuleType ruleType;

    @Column(name = "enabled")
    private Boolean enabled = true;

    @Type(JsonType.class)
    @Column(name = "conditions", columnDefinition = "jsonb")
    private RuleConditions conditions;

    @Column(name = "condition_summary")
    private String conditionSummary;

    @Type(JsonType.class)
    @Column(name = "notification_channels", columnDefinition = "jsonb")
    private List<String> notificationChannels;

    @Enumerated(EnumType.STRING)
    @Column(name = "notification_priority")
    private NotificationPriority notificationPriority = NotificationPriority.NORMAL;

    @Column(name = "throttle_max_per_day")
    private Integer throttleMaxPerDay = 20;

    @Column(name = "throttle_cooldown_minutes")
    private Integer throttleCooldownMinutes = 60;

    @Column(name = "triggered_count")
    private Integer triggeredCount = 0;

    @Column(name = "last_triggered_at")
    private OffsetDateTime lastTriggeredAt;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;

    @Column(name = "updated_at")
    private OffsetDateTime updatedAt;
}
```

**JPA Repository**:
```java
public interface AlertRuleRepository extends JpaRepository<AlertRule, Long> {

    Optional<AlertRule> findByRuleId(String ruleId);

    List<AlertRule> findByUserIdAndEnabledTrue(String userId);

    @Query("SELECT r FROM AlertRule r WHERE r.enabled = true AND r.ruleType = :ruleType")
    List<AlertRule> findEnabledRulesByType(@Param("ruleType") RuleType ruleType);

    @Query("SELECT COUNT(r) FROM AlertRule r WHERE r.userId = :userId")
    long countByUserId(@Param("userId") String userId);

    @Modifying
    @Query("UPDATE AlertRule r SET r.triggeredCount = r.triggeredCount + 1, r.lastTriggeredAt = :now WHERE r.ruleId = :ruleId")
    int incrementTriggeredCount(@Param("ruleId") String ruleId, @Param("now") OffsetDateTime now);
}
```

---

### 2.2 alert_historyï¼ˆè­¦å ±æ­·å²è¡¨ï¼‰

è¨˜éŒ„æ‰€æœ‰è§¸ç™¼çš„è­¦å ±ã€‚

```sql
CREATE TABLE alert_history (
    id                  BIGSERIAL PRIMARY KEY,
    alert_id            VARCHAR(50) NOT NULL UNIQUE,
    rule_id             VARCHAR(50) NOT NULL,
    user_id             VARCHAR(50) NOT NULL,
    alert_type          VARCHAR(20) NOT NULL,
    stock_id            VARCHAR(10) NOT NULL,
    stock_name          VARCHAR(50),
    signal_id           VARCHAR(50),
    signal_direction    VARCHAR(10),
    signal_grade        VARCHAR(5),
    signal_score        DECIMAL(5,2),
    signal_summary      VARCHAR(500),
    price               DECIMAL(10,2),
    price_change        DECIMAL(10,2),
    price_change_pct    DECIMAL(8,4),
    triggered_at        TIMESTAMP WITH TIME ZONE NOT NULL,
    is_read             BOOLEAN DEFAULT FALSE,
    read_at             TIMESTAMP WITH TIME ZONE,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_history_rule FOREIGN KEY (rule_id)
        REFERENCES alert_rules(rule_id) ON DELETE SET NULL
);

-- ç´¢å¼•
CREATE INDEX idx_history_user_date ON alert_history(user_id, triggered_at DESC);
CREATE INDEX idx_history_user_unread ON alert_history(user_id, is_read) WHERE is_read = FALSE;
CREATE INDEX idx_history_stock ON alert_history(stock_id, triggered_at DESC);
CREATE INDEX idx_history_rule ON alert_history(rule_id, triggered_at DESC);
CREATE INDEX idx_history_date ON alert_history(triggered_at DESC);

COMMENT ON TABLE alert_history IS 'è­¦å ±æ­·å²è¨˜éŒ„è¡¨';
COMMENT ON COLUMN alert_history.signal_summary IS 'M13 ä¿¡è™Ÿæ‘˜è¦';
```

**JPA Entity**:
```java
@Entity
@Table(name = "alert_history")
public class AlertHistory {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "alert_id", nullable = false, unique = true)
    private String alertId;

    @Column(name = "rule_id", nullable = false)
    private String ruleId;

    @Column(name = "user_id", nullable = false)
    private String userId;

    @Enumerated(EnumType.STRING)
    @Column(name = "alert_type", nullable = false)
    private AlertType alertType;

    @Column(name = "stock_id", nullable = false)
    private String stockId;

    @Column(name = "stock_name")
    private String stockName;

    @Column(name = "signal_id")
    private String signalId;

    @Enumerated(EnumType.STRING)
    @Column(name = "signal_direction")
    private SignalDirection signalDirection;

    @Column(name = "signal_grade")
    private String signalGrade;

    @Column(name = "signal_score")
    private BigDecimal signalScore;

    @Column(name = "signal_summary")
    private String signalSummary;

    @Column(name = "price")
    private BigDecimal price;

    @Column(name = "price_change")
    private BigDecimal priceChange;

    @Column(name = "price_change_pct")
    private BigDecimal priceChangePct;

    @Column(name = "triggered_at", nullable = false)
    private OffsetDateTime triggeredAt;

    @Column(name = "is_read")
    private Boolean isRead = false;

    @Column(name = "read_at")
    private OffsetDateTime readAt;

    @OneToMany(mappedBy = "alertHistory", cascade = CascadeType.ALL)
    private List<NotificationLog> notificationLogs;
}
```

**JPA Repository**:
```java
public interface AlertHistoryRepository extends JpaRepository<AlertHistory, Long> {

    Optional<AlertHistory> findByAlertId(String alertId);

    Page<AlertHistory> findByUserIdOrderByTriggeredAtDesc(String userId, Pageable pageable);

    @Query("SELECT h FROM AlertHistory h WHERE h.userId = :userId AND h.isRead = false ORDER BY h.triggeredAt DESC")
    List<AlertHistory> findUnreadByUserId(@Param("userId") String userId);

    @Query("SELECT COUNT(h) FROM AlertHistory h WHERE h.userId = :userId AND h.isRead = false")
    long countUnreadByUserId(@Param("userId") String userId);

    @Modifying
    @Query("UPDATE AlertHistory h SET h.isRead = true, h.readAt = :now WHERE h.userId = :userId AND h.isRead = false")
    int markAllAsRead(@Param("userId") String userId, @Param("now") OffsetDateTime now);

    @Query("SELECT h.stockId, COUNT(h) as cnt FROM AlertHistory h WHERE h.userId = :userId AND h.triggeredAt >= :since GROUP BY h.stockId ORDER BY cnt DESC")
    List<Object[]> findTopStocksByUserId(@Param("userId") String userId, @Param("since") OffsetDateTime since);
}
```

---

### 2.3 notification_logsï¼ˆé€šçŸ¥ç™¼é€æ—¥èªŒè¡¨ï¼‰

è¨˜éŒ„æ¯å‰‡é€šçŸ¥çš„ç™¼é€ç‹€æ…‹ã€‚

```sql
CREATE TABLE notification_logs (
    id                  BIGSERIAL PRIMARY KEY,
    log_id              VARCHAR(50) NOT NULL UNIQUE,
    alert_id            VARCHAR(50) NOT NULL,
    user_id             VARCHAR(50) NOT NULL,
    channel             VARCHAR(20) NOT NULL,
    status              VARCHAR(20) NOT NULL,
    recipient           VARCHAR(200),
    message_preview     VARCHAR(500),
    error_message       VARCHAR(500),
    retry_count         INTEGER DEFAULT 0,
    sent_at             TIMESTAMP WITH TIME ZONE,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_channel CHECK (channel IN ('EMAIL', 'LINE', 'PUSH', 'WEBHOOK')),
    CONSTRAINT chk_status CHECK (status IN ('PENDING', 'SENT', 'FAILED', 'SKIPPED')),
    CONSTRAINT fk_log_alert FOREIGN KEY (alert_id)
        REFERENCES alert_history(alert_id) ON DELETE CASCADE
);

-- ç´¢å¼•
CREATE INDEX idx_logs_alert ON notification_logs(alert_id);
CREATE INDEX idx_logs_status ON notification_logs(status, created_at) WHERE status = 'PENDING';
CREATE INDEX idx_logs_user_date ON notification_logs(user_id, sent_at DESC);

COMMENT ON TABLE notification_logs IS 'é€šçŸ¥ç™¼é€æ—¥èªŒè¡¨';
COMMENT ON COLUMN notification_logs.recipient IS 'æ¥æ”¶è€…åœ°å€ï¼ˆemail/device token ç­‰ï¼‰';
```

**JPA Entity**:
```java
@Entity
@Table(name = "notification_logs")
public class NotificationLog {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "log_id", nullable = false, unique = true)
    private String logId;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "alert_id", referencedColumnName = "alert_id")
    private AlertHistory alertHistory;

    @Column(name = "alert_id", insertable = false, updatable = false)
    private String alertId;

    @Column(name = "user_id", nullable = false)
    private String userId;

    @Enumerated(EnumType.STRING)
    @Column(name = "channel", nullable = false)
    private NotificationChannel channel;

    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false)
    private NotificationStatus status;

    @Column(name = "recipient")
    private String recipient;

    @Column(name = "message_preview")
    private String messagePreview;

    @Column(name = "error_message")
    private String errorMessage;

    @Column(name = "retry_count")
    private Integer retryCount = 0;

    @Column(name = "sent_at")
    private OffsetDateTime sentAt;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;

    @Column(name = "updated_at")
    private OffsetDateTime updatedAt;
}
```

---

### 2.4 user_notification_settingsï¼ˆç”¨æˆ¶é€šçŸ¥è¨­å®šè¡¨ï¼‰

å„²å­˜ç”¨æˆ¶çš„é€šçŸ¥åå¥½è¨­å®šã€‚

```sql
CREATE TABLE user_notification_settings (
    id                  BIGSERIAL PRIMARY KEY,
    user_id             VARCHAR(50) NOT NULL UNIQUE,
    email_enabled       BOOLEAN DEFAULT TRUE,
    email_address       VARCHAR(200),
    email_verified      BOOLEAN DEFAULT FALSE,
    line_enabled        BOOLEAN DEFAULT FALSE,
    line_token          VARCHAR(200),
    line_display_name   VARCHAR(100),
    line_connected_at   TIMESTAMP WITH TIME ZONE,
    push_enabled        BOOLEAN DEFAULT TRUE,
    mute_enabled        BOOLEAN DEFAULT FALSE,
    quiet_hours_start   TIME,
    quiet_hours_end     TIME,
    quiet_timezone      VARCHAR(50) DEFAULT 'Asia/Taipei',
    weekend_mute        BOOLEAN DEFAULT FALSE,
    daily_limit_email   INTEGER DEFAULT 20,
    daily_limit_line    INTEGER DEFAULT 10,
    daily_limit_push    INTEGER DEFAULT 30,
    batch_enabled       BOOLEAN DEFAULT FALSE,
    batch_window_minutes INTEGER DEFAULT 5,
    batch_threshold     INTEGER DEFAULT 3,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_settings_user ON user_notification_settings(user_id);

COMMENT ON TABLE user_notification_settings IS 'ç”¨æˆ¶é€šçŸ¥è¨­å®šè¡¨';
COMMENT ON COLUMN user_notification_settings.line_token IS 'Line Notify Access Tokenï¼ˆåŠ å¯†å„²å­˜ï¼‰';
```

**JPA Entity**:
```java
@Entity
@Table(name = "user_notification_settings")
public class UserNotificationSettings {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "user_id", nullable = false, unique = true)
    private String userId;

    // Email è¨­å®š
    @Column(name = "email_enabled")
    private Boolean emailEnabled = true;

    @Column(name = "email_address")
    private String emailAddress;

    @Column(name = "email_verified")
    private Boolean emailVerified = false;

    // Line è¨­å®š
    @Column(name = "line_enabled")
    private Boolean lineEnabled = false;

    @Column(name = "line_token")
    private String lineToken;

    @Column(name = "line_display_name")
    private String lineDisplayName;

    @Column(name = "line_connected_at")
    private OffsetDateTime lineConnectedAt;

    // Push è¨­å®š
    @Column(name = "push_enabled")
    private Boolean pushEnabled = true;

    // éœéŸ³è¨­å®š
    @Column(name = "mute_enabled")
    private Boolean muteEnabled = false;

    @Column(name = "quiet_hours_start")
    private LocalTime quietHoursStart;

    @Column(name = "quiet_hours_end")
    private LocalTime quietHoursEnd;

    @Column(name = "quiet_timezone")
    private String quietTimezone = "Asia/Taipei";

    @Column(name = "weekend_mute")
    private Boolean weekendMute = false;

    // æ¯æ—¥é™é¡
    @Column(name = "daily_limit_email")
    private Integer dailyLimitEmail = 20;

    @Column(name = "daily_limit_line")
    private Integer dailyLimitLine = 10;

    @Column(name = "daily_limit_push")
    private Integer dailyLimitPush = 30;

    // æ‰¹æ¬¡è¨­å®š
    @Column(name = "batch_enabled")
    private Boolean batchEnabled = false;

    @Column(name = "batch_window_minutes")
    private Integer batchWindowMinutes = 5;

    @Column(name = "batch_threshold")
    private Integer batchThreshold = 3;

    @OneToMany(mappedBy = "userId")
    private List<UserDevice> devices;
}
```

---

### 2.5 user_devicesï¼ˆç”¨æˆ¶è£ç½®è¡¨ï¼‰

å„²å­˜ç”¨æˆ¶çš„ APP è£ç½®è³‡è¨Šï¼ˆFCM Tokenï¼‰ã€‚

```sql
CREATE TABLE user_devices (
    id                  BIGSERIAL PRIMARY KEY,
    user_id             VARCHAR(50) NOT NULL,
    device_id           VARCHAR(100) NOT NULL,
    fcm_token           VARCHAR(500) NOT NULL,
    platform            VARCHAR(20) NOT NULL,
    device_name         VARCHAR(100),
    app_version         VARCHAR(20),
    is_active           BOOLEAN DEFAULT TRUE,
    last_active_at      TIMESTAMP WITH TIME ZONE,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_platform CHECK (platform IN ('iOS', 'Android')),
    CONSTRAINT uk_user_device UNIQUE (user_id, device_id)
);

-- ç´¢å¼•
CREATE INDEX idx_devices_user ON user_devices(user_id, is_active);
CREATE INDEX idx_devices_token ON user_devices(fcm_token);

COMMENT ON TABLE user_devices IS 'ç”¨æˆ¶è£ç½®è¡¨ï¼ˆFCM æ¨æ’­ï¼‰';
```

**JPA Entity**:
```java
@Entity
@Table(name = "user_devices")
public class UserDevice {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "user_id", nullable = false)
    private String userId;

    @Column(name = "device_id", nullable = false)
    private String deviceId;

    @Column(name = "fcm_token", nullable = false)
    private String fcmToken;

    @Enumerated(EnumType.STRING)
    @Column(name = "platform", nullable = false)
    private Platform platform;

    @Column(name = "device_name")
    private String deviceName;

    @Column(name = "app_version")
    private String appVersion;

    @Column(name = "is_active")
    private Boolean isActive = true;

    @Column(name = "last_active_at")
    private OffsetDateTime lastActiveAt;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;

    @Column(name = "updated_at")
    private OffsetDateTime updatedAt;
}
```

---

### 2.6 notification_templatesï¼ˆé€šçŸ¥ç¯„æœ¬è¡¨ï¼‰

å„²å­˜ç³»çµ±é€šçŸ¥ç¯„æœ¬ã€‚

```sql
CREATE TABLE notification_templates (
    id                  BIGSERIAL PRIMARY KEY,
    template_id         VARCHAR(50) NOT NULL UNIQUE,
    template_name       VARCHAR(100) NOT NULL,
    template_type       VARCHAR(20) NOT NULL,
    channel             VARCHAR(20) NOT NULL,
    subject_template    VARCHAR(200),
    body_template       TEXT NOT NULL,
    is_default          BOOLEAN DEFAULT FALSE,
    is_active           BOOLEAN DEFAULT TRUE,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_tpl_type CHECK (template_type IN ('SIGNAL', 'PRICE', 'CHANGE', 'VOLUME', 'BATCH')),
    CONSTRAINT chk_tpl_channel CHECK (channel IN ('EMAIL', 'LINE', 'PUSH'))
);

-- åˆå§‹è³‡æ–™
INSERT INTO notification_templates (template_id, template_name, template_type, channel, subject_template, body_template, is_default) VALUES
-- Email ç¯„æœ¬
('TPL_EMAIL_SIGNAL', 'ä¿¡è™Ÿé€šçŸ¥ Email', 'SIGNAL', 'EMAIL',
 'ğŸ“ˆ äº¤æ˜“ä¿¡è™Ÿ: {{stockId}} {{stockName}} - {{direction}}',
 '<h2>ğŸ“ˆ äº¤æ˜“ä¿¡è™Ÿè­¦å ±</h2>
<table>
<tr><td>è‚¡ç¥¨</td><td>{{stockId}} {{stockName}}</td></tr>
<tr><td>ä¿¡è™Ÿæ–¹å‘</td><td>{{direction}}</td></tr>
<tr><td>è©•ç´š</td><td>{{grade}} ({{score}}åˆ†)</td></tr>
<tr><td>ç¾åƒ¹</td><td>{{price}} ({{changePercent}}%)</td></tr>
</table>
<p><strong>ä¿¡è™Ÿæ‘˜è¦</strong></p>
<p>{{signalSummary}}</p>',
 true),

-- Line ç¯„æœ¬
('TPL_LINE_SIGNAL', 'ä¿¡è™Ÿé€šçŸ¥ Line', 'SIGNAL', 'LINE',
 null,
 'ğŸ“ˆ äº¤æ˜“ä¿¡è™Ÿè­¦å ±

è‚¡ç¥¨: {{stockId}} {{stockName}}
æ–¹å‘: {{direction}} {{directionEmoji}}
è©•ç´š: {{grade}} ({{score}}åˆ†)
ç¾åƒ¹: {{price}} ({{changePercent}}%)

ã€ä¿¡è™Ÿæ‘˜è¦ã€‘
{{signalSummary}}

â° {{triggeredAt}}',
 true),

-- Push ç¯„æœ¬
('TPL_PUSH_SIGNAL', 'ä¿¡è™Ÿé€šçŸ¥ Push', 'SIGNAL', 'PUSH',
 null,
 '{{stockId}} {{stockName}} - {{direction}} ({{grade}})',
 true),

-- æ‰¹æ¬¡é€šçŸ¥ç¯„æœ¬
('TPL_EMAIL_BATCH', 'æ‰¹æ¬¡é€šçŸ¥ Email', 'BATCH', 'EMAIL',
 'ğŸ“Š æ‚¨æœ‰ {{count}} å‰‡æ–°è­¦å ±',
 '<h2>ğŸ“Š è­¦å ±æ‘˜è¦</h2>
<p>æ‚¨æœ‰ {{count}} å‰‡æ–°è­¦å ±ï¼š</p>
<ul>
{{#alerts}}
<li>{{stockId}} {{stockName}} - {{direction}} ({{grade}})</li>
{{/alerts}}
</ul>
<p><a href="{{detailUrl}}">é»æ“ŠæŸ¥çœ‹è©³æƒ…</a></p>',
 true);

COMMENT ON TABLE notification_templates IS 'é€šçŸ¥ç¯„æœ¬è¡¨';
COMMENT ON COLUMN notification_templates.body_template IS 'è¨Šæ¯å…§å®¹ç¯„æœ¬ï¼ˆæ”¯æ´ Mustache èªæ³•ï¼‰';
```

---

## 3. ç¯€æµè¨ˆæ•¸è¡¨

### 3.1 daily_notification_countsï¼ˆæ¯æ—¥é€šçŸ¥è¨ˆæ•¸è¡¨ï¼‰

è¿½è¹¤æ¯æ—¥é€šçŸ¥ç™¼é€æ•¸é‡ã€‚

```sql
CREATE TABLE daily_notification_counts (
    id                  BIGSERIAL PRIMARY KEY,
    user_id             VARCHAR(50) NOT NULL,
    count_date          DATE NOT NULL,
    channel             VARCHAR(20) NOT NULL,
    notification_count  INTEGER DEFAULT 0,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uk_daily_count UNIQUE (user_id, count_date, channel)
);

-- ç´¢å¼•
CREATE INDEX idx_daily_count_user_date ON daily_notification_counts(user_id, count_date);

COMMENT ON TABLE daily_notification_counts IS 'æ¯æ—¥é€šçŸ¥è¨ˆæ•¸è¡¨';
```

**JPA Entity**:
```java
@Entity
@Table(name = "daily_notification_counts")
public class DailyNotificationCount {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "user_id", nullable = false)
    private String userId;

    @Column(name = "count_date", nullable = false)
    private LocalDate countDate;

    @Enumerated(EnumType.STRING)
    @Column(name = "channel", nullable = false)
    private NotificationChannel channel;

    @Column(name = "notification_count")
    private Integer notificationCount = 0;
}
```

**JPA Repository**:
```java
public interface DailyNotificationCountRepository extends JpaRepository<DailyNotificationCount, Long> {

    @Query("SELECT c FROM DailyNotificationCount c WHERE c.userId = :userId AND c.countDate = :date AND c.channel = :channel")
    Optional<DailyNotificationCount> findByUserAndDateAndChannel(
        @Param("userId") String userId,
        @Param("date") LocalDate date,
        @Param("channel") NotificationChannel channel
    );

    @Modifying
    @Query("UPDATE DailyNotificationCount c SET c.notificationCount = c.notificationCount + 1 WHERE c.userId = :userId AND c.countDate = :date AND c.channel = :channel")
    int incrementCount(
        @Param("userId") String userId,
        @Param("date") LocalDate date,
        @Param("channel") NotificationChannel channel
    );
}
```

---

## 4. ç´¢å¼•ç­–ç•¥

### 4.1 æŸ¥è©¢æ¨¡å¼åˆ†æ

| æŸ¥è©¢å ´æ™¯ | ä½¿ç”¨é »ç‡ | é—œéµæ¬„ä½ |
|---------|---------|---------|
| å–å¾—ç”¨æˆ¶å•Ÿç”¨è¦å‰‡ | é«˜ | user_id, enabled |
| æŸ¥è©¢è­¦å ±æ­·å² | é«˜ | user_id, triggered_at |
| æŸ¥è©¢æœªè®€è­¦å ± | é«˜ | user_id, is_read |
| é€šçŸ¥ç™¼é€ç‹€æ…‹ | ä¸­ | alert_id, status |
| æ¯æ—¥è¨ˆæ•¸æŸ¥è©¢ | é«˜ | user_id, count_date |

### 4.2 æ ¸å¿ƒç´¢å¼•

```sql
-- è¦å‰‡æŸ¥è©¢ï¼ˆæœ€å¸¸ç”¨ï¼‰
CREATE INDEX idx_rules_user_enabled ON alert_rules(user_id, enabled);

-- æ­·å²æŸ¥è©¢ï¼ˆåˆ†é ï¼‰
CREATE INDEX idx_history_user_triggered ON alert_history(user_id, triggered_at DESC);

-- æœªè®€è¨ˆæ•¸ï¼ˆDashboardï¼‰
CREATE INDEX idx_history_user_unread ON alert_history(user_id) WHERE is_read = FALSE;

-- é€šçŸ¥æ—¥èªŒç‹€æ…‹
CREATE INDEX idx_logs_pending ON notification_logs(status, created_at) WHERE status = 'PENDING';
```

---

## 5. è³‡æ–™ä¿ç•™ç­–ç•¥

| è¡¨æ ¼ | ä¿ç•™æœŸé™ | æ¸…ç†ç­–ç•¥ |
|-----|---------|---------|
| alert_rules | æ°¸ä¹… | ç”¨æˆ¶åˆªé™¤æ™‚æ¸…ç† |
| alert_history | 180 å¤© | å®šæœŸæ­¸æª”å¾Œåˆªé™¤ |
| notification_logs | 90 å¤© | å®šæœŸæ¸…ç† |
| daily_notification_counts | 30 å¤© | å®šæœŸæ¸…ç† |
| user_notification_settings | æ°¸ä¹… | ç”¨æˆ¶åˆªé™¤æ™‚æ¸…ç† |
| user_devices | æ°¸ä¹… | éæ´»èº 90 å¤©å¾Œæ¸…ç† |

---

## 6. ç›¸é—œæ–‡æª”

- [M15 åŠŸèƒ½éœ€æ±‚](../specs/functional/M15-è­¦å ±é€šçŸ¥ç³»çµ±åŠŸèƒ½éœ€æ±‚.md)
- [M15 API è¦æ ¼](../specs/api/M15-APIè¦æ ¼.md)
- [M15 ERD](./erd/M15-ERD.md)

---

**æ–‡ä»¶ç¶­è­·è€…**: å¾Œç«¯å·¥ç¨‹å¸«
**æœ€å¾Œæ›´æ–°**: 2026-01-15
**ä¸‹æ¬¡å¯©æ ¸**: 2026-04-15
