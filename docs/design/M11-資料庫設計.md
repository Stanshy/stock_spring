# M11-é‡åŒ–ç­–ç•¥æ¨¡çµ„è³‡æ–™åº«è¨­è¨ˆ

> **æ–‡ä»¶ç·¨è™Ÿ**: DB-M11
> **æ¨¡çµ„åç¨±**: é‡åŒ–ç­–ç•¥æ¨¡çµ„
> **ç‰ˆæœ¬**: v1.0
> **æœ€å¾Œæ›´æ–°**: 2026-01-14
> **ç‹€æ…‹**: Draft

---

## ğŸ“‹ è³‡æ–™åº«è¨­è¨ˆç¸½è¦½

æœ¬æ–‡ä»¶å®šç¾©é‡åŒ–ç­–ç•¥æ¨¡çµ„çš„è³‡æ–™è¡¨çµæ§‹ã€‚M11 ä¸»è¦ä¾è³´ M07/M08/M09 çš„åˆ†æçµæœè¡¨é€²è¡Œå› å­æ•¸æ“šè®€å–ï¼Œä¸¦æ–°å¢ç­–ç•¥å®šç¾©èˆ‡åŸ·è¡Œçµæœå„²å­˜è¡¨ã€‚

---

## 1. è³‡æ–™è¡¨æ¸…å–®

| è¡¨å | èªªæ˜ | æŒä¹…å±¤ | ç‰¹æ®ŠåŠŸèƒ½ |
|-----|------|-------|---------|
| strategies | ç­–ç•¥å®šç¾©è¡¨ | MyBatis | JSONBã€ç‰ˆæœ¬æ§åˆ¶ |
| strategy_versions | ç­–ç•¥ç‰ˆæœ¬æ­·å²è¡¨ | MyBatis | ç‰ˆæœ¬è¿½æº¯ |
| strategy_executions | ç­–ç•¥åŸ·è¡Œè¨˜éŒ„è¡¨ | MyBatis | åŸ·è¡Œè¿½è¹¤ |
| strategy_signals | ç­–ç•¥ä¿¡è™Ÿè¡¨ | MyBatis | JSONBã€åˆ†å€ |
| strategy_optimizations | åƒæ•¸å„ªåŒ–è¨˜éŒ„è¡¨ | MyBatis | å„ªåŒ–çµæœ |
| factor_metadata | å› å­å…ƒæ•¸æ“šè¡¨ | MyBatis | å› å­å®šç¾© |

**ä¾è³´çš„ä¸Šæ¸¸è³‡æ–™è¡¨ï¼ˆåªè®€ï¼‰**:

| è¡¨å | ä¾†æºæ¨¡çµ„ | ç”¨é€” |
|-----|---------|------|
| stocks | M06 | è‚¡ç¥¨åŸºæœ¬è³‡æ–™ |
| stock_prices | M06 | è‚¡åƒ¹è³‡æ–™ |
| technical_indicators | M07 | æŠ€è¡“æŒ‡æ¨™è¨ˆç®—çµæœ |
| fundamental_indicators | M08 | è²¡å‹™æŒ‡æ¨™è¨ˆç®—çµæœ |
| chip_analysis_results | M09 | ç±Œç¢¼åˆ†æè¨ˆç®—çµæœ |

---

## 2. è³‡æ–™è¡¨è©³ç´°è¨­è¨ˆ

### 2.1 strategies (ç­–ç•¥å®šç¾©è¡¨)

å„²å­˜ç­–ç•¥çš„å®šç¾©èˆ‡é…ç½®ï¼Œä½¿ç”¨ JSONB å„²å­˜å½ˆæ€§çš„æ¢ä»¶èˆ‡åƒæ•¸ã€‚

```sql
-- PostgreSQL å»ºè¡¨èªæ³•
CREATE TABLE strategies (
    strategy_id         VARCHAR(20) PRIMARY KEY,
    strategy_name       VARCHAR(100) NOT NULL,
    strategy_type       VARCHAR(20) NOT NULL,
    description         TEXT,

    -- ç•¶å‰ç‰ˆæœ¬
    current_version     INTEGER DEFAULT 1,

    -- ç­–ç•¥ç‹€æ…‹
    status              VARCHAR(20) DEFAULT 'DRAFT',
    is_preset           BOOLEAN DEFAULT FALSE,

    -- ç­–ç•¥å®šç¾©ï¼ˆJSONBï¼‰
    conditions          JSONB NOT NULL,
    parameters          JSONB DEFAULT '{}',
    output_config       JSONB DEFAULT '{}',

    -- åŸ·è¡Œçµ±è¨ˆï¼ˆå¿«å–ï¼‰
    total_executions    INTEGER DEFAULT 0,
    total_signals       INTEGER DEFAULT 0,
    last_execution_at   TIMESTAMP,

    -- å¯©è¨ˆæ¬„ä½
    created_by          VARCHAR(50),
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ç´„æŸ
    CHECK (strategy_type IN ('MOMENTUM', 'VALUE', 'HYBRID', 'CUSTOM')),
    CHECK (status IN ('DRAFT', 'ACTIVE', 'INACTIVE', 'ARCHIVED'))
);

-- ç´¢å¼•
CREATE INDEX idx_strategies_type ON strategies(strategy_type);
CREATE INDEX idx_strategies_status ON strategies(status);
CREATE INDEX idx_strategies_is_preset ON strategies(is_preset);
CREATE INDEX idx_strategies_conditions ON strategies USING GIN(conditions);

-- è‡ªå‹•æ›´æ–° updated_at
CREATE TRIGGER update_strategies_updated_at
    BEFORE UPDATE ON strategies
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE strategies IS 'ç­–ç•¥å®šç¾©è¡¨';
COMMENT ON COLUMN strategies.conditions IS 'ç­–ç•¥æ¢ä»¶å®šç¾© JSONB';
COMMENT ON COLUMN strategies.parameters IS 'ç­–ç•¥åƒæ•¸ï¼ˆå¯èª¿æ•´ï¼‰';
COMMENT ON COLUMN strategies.output_config IS 'è¼¸å‡ºé…ç½®ï¼ˆä¿¡è™Ÿé¡å‹ã€ä¿¡å¿ƒåº¦å…¬å¼ï¼‰';
```

**JSONB çµæ§‹ç¯„ä¾‹**:

```json
{
  "conditions": {
    "logic": "AND",
    "conditions": [
      {
        "factor_id": "M07_RSI_14",
        "operator": "LESS_THAN",
        "value": 30,
        "description": "RSI(14) < 30"
      },
      {
        "logic": "OR",
        "conditions": [
          {
            "factor_id": "M09_FOREIGN_NET",
            "operator": "GREATER_THAN",
            "value": 0
          },
          {
            "factor_id": "M09_TRUST_NET",
            "operator": "GREATER_THAN",
            "value": 0
          }
        ]
      }
    ]
  },
  "parameters": {
    "rsi_threshold": 30,
    "volume_ratio_min": 1.0,
    "lookback_days": 60
  },
  "output_config": {
    "signal_type": "BUY",
    "confidence_formula": "(30 - RSI) / 30 * 0.4 + chip_score * 0.6"
  }
}
```

---

### 2.2 strategy_versions (ç­–ç•¥ç‰ˆæœ¬æ­·å²è¡¨)

å„²å­˜ç­–ç•¥çš„ç‰ˆæœ¬æ­·å²ï¼Œæ”¯æ´ç‰ˆæœ¬è¿½æº¯èˆ‡æ¯”è¼ƒã€‚

```sql
CREATE TABLE strategy_versions (
    version_id          BIGSERIAL PRIMARY KEY,
    strategy_id         VARCHAR(20) NOT NULL REFERENCES strategies(strategy_id),
    version             INTEGER NOT NULL,

    -- ç‰ˆæœ¬å…§å®¹å¿«ç…§
    strategy_name       VARCHAR(100) NOT NULL,
    description         TEXT,
    conditions          JSONB NOT NULL,
    parameters          JSONB DEFAULT '{}',
    output_config       JSONB DEFAULT '{}',

    -- ç‰ˆæœ¬è³‡è¨Š
    change_summary      TEXT,
    created_by          VARCHAR(50),
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- å”¯ä¸€ç´„æŸ
    UNIQUE (strategy_id, version)
);

-- ç´¢å¼•
CREATE INDEX idx_strategy_versions_strategy_id ON strategy_versions(strategy_id);
CREATE INDEX idx_strategy_versions_version ON strategy_versions(version);

-- è¡¨è¨»é‡‹
COMMENT ON TABLE strategy_versions IS 'ç­–ç•¥ç‰ˆæœ¬æ­·å²è¡¨';
COMMENT ON COLUMN strategy_versions.change_summary IS 'ç‰ˆæœ¬è®Šæ›´æ‘˜è¦';
```

---

### 2.3 strategy_executions (ç­–ç•¥åŸ·è¡Œè¨˜éŒ„è¡¨)

å„²å­˜æ¯æ¬¡ç­–ç•¥åŸ·è¡Œçš„è¨˜éŒ„èˆ‡çµ±è¨ˆã€‚

```sql
CREATE TABLE strategy_executions (
    execution_id        VARCHAR(30) PRIMARY KEY,
    strategy_id         VARCHAR(20) NOT NULL REFERENCES strategies(strategy_id),
    strategy_version    INTEGER NOT NULL,

    -- åŸ·è¡Œè³‡è¨Š
    execution_date      DATE NOT NULL,
    execution_type      VARCHAR(20) DEFAULT 'SCHEDULED',

    -- åŸ·è¡Œç¯„åœ
    stock_universe      JSONB,
    stocks_evaluated    INTEGER,

    -- åŸ·è¡Œçµæœ
    signals_generated   INTEGER DEFAULT 0,
    buy_signals         INTEGER DEFAULT 0,
    sell_signals        INTEGER DEFAULT 0,
    hold_signals        INTEGER DEFAULT 0,
    avg_confidence      NUMERIC(5,2),

    -- åŸ·è¡Œæ•ˆèƒ½
    execution_time_ms   INTEGER,
    status              VARCHAR(20) DEFAULT 'RUNNING',
    error_message       TEXT,

    -- è¨ºæ–·è³‡è¨Š
    diagnostics         JSONB DEFAULT '{}',

    -- å¯©è¨ˆæ¬„ä½
    started_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at        TIMESTAMP,

    -- ç´„æŸ
    CHECK (execution_type IN ('SCHEDULED', 'MANUAL', 'BACKTEST', 'OPTIMIZATION')),
    CHECK (status IN ('RUNNING', 'SUCCESS', 'FAILED', 'CANCELLED'))
);

-- ç´¢å¼•
CREATE INDEX idx_strategy_executions_strategy_id ON strategy_executions(strategy_id);
CREATE INDEX idx_strategy_executions_date ON strategy_executions(execution_date);
CREATE INDEX idx_strategy_executions_status ON strategy_executions(status);
CREATE INDEX idx_strategy_executions_type ON strategy_executions(execution_type);

-- è¤‡åˆç´¢å¼•
CREATE INDEX idx_strategy_executions_strategy_date
    ON strategy_executions(strategy_id, execution_date);

-- è¡¨è¨»é‡‹
COMMENT ON TABLE strategy_executions IS 'ç­–ç•¥åŸ·è¡Œè¨˜éŒ„è¡¨';
COMMENT ON COLUMN strategy_executions.execution_type IS 'åŸ·è¡Œé¡å‹ï¼ˆæ’ç¨‹/æ‰‹å‹•/å›æ¸¬/å„ªåŒ–ï¼‰';
COMMENT ON COLUMN strategy_executions.diagnostics IS 'åŸ·è¡Œè¨ºæ–·è³‡è¨Š JSONB';
```

**è¨ºæ–·è³‡è¨Š JSONB ç¯„ä¾‹**:

```json
{
  "diagnostics": {
    "factors_loaded": 4,
    "factors_missing": 0,
    "stocks_skipped": 25,
    "skip_reasons": {
      "missing_data": 15,
      "suspended": 10
    },
    "calculation_errors": 0,
    "warnings": []
  }
}
```

---

### 2.4 strategy_signals (ç­–ç•¥ä¿¡è™Ÿè¡¨)

å„²å­˜ç­–ç•¥åŸ·è¡Œç”¢ç”Ÿçš„ä¿¡è™Ÿï¼Œä½¿ç”¨åˆ†å€æå‡æŸ¥è©¢æ•ˆèƒ½ã€‚

```sql
-- PostgreSQL å»ºè¡¨èªæ³•ï¼ˆä½¿ç”¨åˆ†å€ï¼‰
CREATE TABLE strategy_signals (
    signal_id           VARCHAR(30),
    execution_id        VARCHAR(30) NOT NULL,
    strategy_id         VARCHAR(20) NOT NULL,
    strategy_version    INTEGER NOT NULL,

    -- è‚¡ç¥¨è³‡è¨Š
    stock_id            VARCHAR(10) NOT NULL,
    trade_date          DATE NOT NULL,

    -- ä¿¡è™Ÿè³‡è¨Š
    signal_type         VARCHAR(10) NOT NULL,
    confidence_score    NUMERIC(5,2),

    -- æ¢ä»¶åŒ¹é…è©³æƒ…
    matched_conditions  JSONB NOT NULL,
    factor_values       JSONB,

    -- ç‹€æ…‹ï¼ˆä¾› M13 æ¶ˆè²»è¿½è¹¤ï¼‰
    is_consumed         BOOLEAN DEFAULT FALSE,
    consumed_by         VARCHAR(30),
    consumed_at         TIMESTAMP,

    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (signal_id, trade_date),

    -- ç´„æŸ
    CHECK (signal_type IN ('BUY', 'SELL', 'HOLD'))
) PARTITION BY RANGE (trade_date);

-- å»ºç«‹åˆ†å€ï¼ˆæŒ‰æœˆï¼‰
CREATE TABLE strategy_signals_2024_01 PARTITION OF strategy_signals
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE strategy_signals_2024_02 PARTITION OF strategy_signals
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
-- ... å…¶ä»–æœˆä»½åˆ†å€

CREATE TABLE strategy_signals_2025_01 PARTITION OF strategy_signals
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
CREATE TABLE strategy_signals_2025_02 PARTITION OF strategy_signals
    FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
-- ... å…¶ä»–æœˆä»½åˆ†å€

CREATE TABLE strategy_signals_2026_01 PARTITION OF strategy_signals
    FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
CREATE TABLE strategy_signals_2026_02 PARTITION OF strategy_signals
    FOR VALUES FROM ('2026-02-01') TO ('2026-03-01');
-- ... å…¶ä»–æœˆä»½åˆ†å€

CREATE TABLE strategy_signals_future PARTITION OF strategy_signals
    FOR VALUES FROM ('2027-01-01') TO (MAXVALUE);

-- ç´¢å¼•
CREATE INDEX idx_strategy_signals_strategy_id ON strategy_signals(strategy_id);
CREATE INDEX idx_strategy_signals_stock_id ON strategy_signals(stock_id);
CREATE INDEX idx_strategy_signals_trade_date ON strategy_signals(trade_date);
CREATE INDEX idx_strategy_signals_execution_id ON strategy_signals(execution_id);
CREATE INDEX idx_strategy_signals_signal_type ON strategy_signals(signal_type);
CREATE INDEX idx_strategy_signals_confidence ON strategy_signals(confidence_score);
CREATE INDEX idx_strategy_signals_is_consumed ON strategy_signals(is_consumed);

-- è¤‡åˆç´¢å¼•ï¼ˆå¸¸ç”¨æŸ¥è©¢ï¼‰
CREATE INDEX idx_strategy_signals_strategy_date
    ON strategy_signals(strategy_id, trade_date);
CREATE INDEX idx_strategy_signals_stock_date
    ON strategy_signals(stock_id, trade_date);

-- JSONB GIN ç´¢å¼•
CREATE INDEX idx_strategy_signals_matched ON strategy_signals USING GIN(matched_conditions);
CREATE INDEX idx_strategy_signals_factors ON strategy_signals USING GIN(factor_values);

-- è¡¨è¨»é‡‹
COMMENT ON TABLE strategy_signals IS 'ç­–ç•¥ä¿¡è™Ÿè¡¨ï¼ˆæŒ‰æœˆåˆ†å€ï¼‰';
COMMENT ON COLUMN strategy_signals.matched_conditions IS 'åŒ¹é…çš„æ¢ä»¶è©³æƒ… JSONB';
COMMENT ON COLUMN strategy_signals.factor_values IS 'å› å­æ•¸å€¼å¿«ç…§ JSONB';
COMMENT ON COLUMN strategy_signals.is_consumed IS 'æ˜¯å¦å·²è¢« M13 æ¶ˆè²»';
```

**JSONB çµæ§‹ç¯„ä¾‹**:

```json
{
  "matched_conditions": [
    {
      "factor_id": "M07_RSI_14",
      "factor_value": 25.3,
      "operator": "LESS_THAN",
      "threshold": 30,
      "matched": true
    },
    {
      "factor_id": "M09_FOREIGN_NET",
      "factor_value": 5000000,
      "operator": "GREATER_THAN",
      "threshold": 0,
      "matched": true
    }
  ],
  "factor_values": {
    "M07_RSI_14": 25.3,
    "M07_KD_K": 18.5,
    "M09_FOREIGN_NET": 5000000,
    "M09_TRUST_NET": 800000,
    "M06_VOLUME_RATIO": 1.35,
    "M08_PE_RATIO": 12.5
  }
}
```

---

### 2.5 strategy_optimizations (åƒæ•¸å„ªåŒ–è¨˜éŒ„è¡¨)

å„²å­˜ç­–ç•¥åƒæ•¸å„ªåŒ–çš„åŸ·è¡Œè¨˜éŒ„èˆ‡çµæœã€‚

```sql
CREATE TABLE strategy_optimizations (
    optimization_id     VARCHAR(30) PRIMARY KEY,
    strategy_id         VARCHAR(20) NOT NULL REFERENCES strategies(strategy_id),
    strategy_version    INTEGER NOT NULL,

    -- å„ªåŒ–é…ç½®
    optimization_method VARCHAR(20) NOT NULL,
    objective_function  VARCHAR(30) NOT NULL,
    parameter_config    JSONB NOT NULL,
    backtest_config     JSONB NOT NULL,

    -- å„ªåŒ–ç‹€æ…‹
    status              VARCHAR(20) DEFAULT 'QUEUED',
    total_combinations  INTEGER,
    completed_combinations INTEGER DEFAULT 0,
    progress_percent    NUMERIC(5,2) DEFAULT 0,

    -- å„ªåŒ–çµæœ
    best_parameters     JSONB,
    best_objective_value NUMERIC(10,4),
    all_results         JSONB,

    -- åŸ·è¡Œè³‡è¨Š
    execution_time_ms   INTEGER,
    error_message       TEXT,

    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    started_at          TIMESTAMP,
    completed_at        TIMESTAMP,

    -- ç´„æŸ
    CHECK (optimization_method IN ('GRID_SEARCH', 'RANDOM_SEARCH', 'BAYESIAN')),
    CHECK (objective_function IN ('SHARPE_RATIO', 'TOTAL_RETURN', 'WIN_RATE', 'MAX_DRAWDOWN')),
    CHECK (status IN ('QUEUED', 'RUNNING', 'SUCCESS', 'FAILED', 'CANCELLED'))
);

-- ç´¢å¼•
CREATE INDEX idx_strategy_optimizations_strategy_id ON strategy_optimizations(strategy_id);
CREATE INDEX idx_strategy_optimizations_status ON strategy_optimizations(status);

-- è¡¨è¨»é‡‹
COMMENT ON TABLE strategy_optimizations IS 'ç­–ç•¥åƒæ•¸å„ªåŒ–è¨˜éŒ„è¡¨';
COMMENT ON COLUMN strategy_optimizations.parameter_config IS 'åƒæ•¸æœç´¢ç©ºé–“é…ç½®';
COMMENT ON COLUMN strategy_optimizations.best_parameters IS 'æœ€ä½³åƒæ•¸çµ„åˆ';
```

**å„ªåŒ–çµæœ JSONB ç¯„ä¾‹**:

```json
{
  "best_parameters": {
    "rsi_threshold": 25,
    "volume_ratio_min": 1.25
  },
  "all_results": [
    {
      "parameters": {"rsi_threshold": 20, "volume_ratio_min": 0.5},
      "sharpe_ratio": 1.15,
      "total_return": 12.5,
      "win_rate": 55.2,
      "max_drawdown": -15.3
    },
    {
      "parameters": {"rsi_threshold": 25, "volume_ratio_min": 1.25},
      "sharpe_ratio": 1.42,
      "total_return": 18.5,
      "win_rate": 62.1,
      "max_drawdown": -12.8
    }
  ]
}
```

---

### 2.6 factor_metadata (å› å­å…ƒæ•¸æ“šè¡¨)

å„²å­˜å¯ç”¨æ–¼ç­–ç•¥çµ„åˆçš„å› å­å®šç¾©ã€‚

```sql
CREATE TABLE factor_metadata (
    factor_id           VARCHAR(30) PRIMARY KEY,
    factor_name         VARCHAR(50) NOT NULL,
    display_name        VARCHAR(100) NOT NULL,

    -- åˆ†é¡è³‡è¨Š
    category            VARCHAR(20) NOT NULL,
    source_module       VARCHAR(10) NOT NULL,

    -- æ•¸æ“šé¡å‹èˆ‡ç¯„åœ
    data_type           VARCHAR(20) NOT NULL,
    value_range         JSONB,
    typical_thresholds  JSONB,

    -- æ”¯æ´çš„é‹ç®—
    supported_operators JSONB NOT NULL,
    default_operator    VARCHAR(20),

    -- èªªæ˜
    description         TEXT,
    calculation_formula TEXT,

    -- æ›´æ–°é »ç‡
    update_frequency    VARCHAR(20) DEFAULT 'DAILY',

    -- ç‹€æ…‹
    is_active           BOOLEAN DEFAULT TRUE,

    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ç´„æŸ
    CHECK (category IN ('TECHNICAL', 'FUNDAMENTAL', 'CHIP', 'PRICE_VOLUME', 'DERIVED')),
    CHECK (source_module IN ('M06', 'M07', 'M08', 'M09', 'M11')),
    CHECK (data_type IN ('NUMERIC', 'INTEGER', 'BOOLEAN', 'STRING', 'ENUM'))
);

-- ç´¢å¼•
CREATE INDEX idx_factor_metadata_category ON factor_metadata(category);
CREATE INDEX idx_factor_metadata_source ON factor_metadata(source_module);
CREATE INDEX idx_factor_metadata_is_active ON factor_metadata(is_active);

-- è¡¨è¨»é‡‹
COMMENT ON TABLE factor_metadata IS 'å› å­å…ƒæ•¸æ“šè¡¨';
COMMENT ON COLUMN factor_metadata.supported_operators IS 'æ”¯æ´çš„é‹ç®—å­åˆ—è¡¨';
COMMENT ON COLUMN factor_metadata.typical_thresholds IS 'å…¸å‹é–¾å€¼ï¼ˆä¾› UI åƒè€ƒï¼‰';
```

**JSONB çµæ§‹ç¯„ä¾‹**:

```json
{
  "value_range": {
    "min": 0,
    "max": 100
  },
  "typical_thresholds": [30, 70],
  "supported_operators": [
    "EQUAL", "NOT_EQUAL",
    "GREATER_THAN", "GREATER_THAN_EQUAL",
    "LESS_THAN", "LESS_THAN_EQUAL",
    "BETWEEN", "CROSS_ABOVE", "CROSS_BELOW"
  ]
}
```

---

## 3. MyBatis Mapper è¨­è¨ˆ

### 3.1 StrategyMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chris.fin_shark.m11.mapper.StrategyMapper">

    <!-- æŸ¥è©¢ç­–ç•¥æ¸…å–®ï¼ˆæ”¯æ´ç¯©é¸èˆ‡åˆ†é ï¼‰ -->
    <select id="selectStrategies" resultType="com.chris.fin_shark.m11.dto.StrategyDTO">
        SELECT
            strategy_id,
            strategy_name,
            strategy_type,
            description,
            current_version as version,
            status,
            is_preset,
            jsonb_array_length(conditions->'conditions') as condition_count,
            last_execution_at as last_execution,
            total_signals,
            created_at,
            updated_at
        FROM strategies
        WHERE 1=1
        <if test="status != null and status != 'all'">
            AND status = #{status}
        </if>
        <if test="type != null and type != 'all'">
            AND strategy_type = #{type}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (strategy_name ILIKE '%' || #{keyword} || '%'
                 OR description ILIKE '%' || #{keyword} || '%')
        </if>
        ORDER BY
        <choose>
            <when test="sortField == 'name'">strategy_name</when>
            <when test="sortField == 'type'">strategy_type</when>
            <when test="sortField == 'signals'">total_signals</when>
            <otherwise>created_at</otherwise>
        </choose>
        <if test="sortDirection == 'asc'">ASC</if>
        <if test="sortDirection == 'desc'">DESC</if>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- å„²å­˜ç­–ç•¥ï¼ˆUPSERTï¼‰ -->
    <insert id="upsertStrategy" parameterType="com.chris.fin_shark.m11.entity.Strategy">
        INSERT INTO strategies (
            strategy_id, strategy_name, strategy_type, description,
            current_version, status, is_preset,
            conditions, parameters, output_config,
            created_by, created_at, updated_at
        ) VALUES (
            #{strategyId}, #{strategyName}, #{strategyType}, #{description},
            #{currentVersion}, #{status}, #{isPreset},
            #{conditions, typeHandler=com.chris.fin_shark.common.handler.JsonbTypeHandler},
            #{parameters, typeHandler=com.chris.fin_shark.common.handler.JsonbTypeHandler},
            #{outputConfig, typeHandler=com.chris.fin_shark.common.handler.JsonbTypeHandler},
            #{createdBy}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
        )
        ON CONFLICT (strategy_id) DO UPDATE SET
            strategy_name = EXCLUDED.strategy_name,
            description = EXCLUDED.description,
            current_version = EXCLUDED.current_version,
            status = EXCLUDED.status,
            conditions = EXCLUDED.conditions,
            parameters = EXCLUDED.parameters,
            output_config = EXCLUDED.output_config,
            updated_at = CURRENT_TIMESTAMP
    </insert>

    <!-- æ‰¹æ¬¡å„²å­˜ç­–ç•¥ä¿¡è™Ÿ -->
    <insert id="batchInsertSignals" parameterType="list">
        INSERT INTO strategy_signals (
            signal_id, execution_id, strategy_id, strategy_version,
            stock_id, trade_date, signal_type, confidence_score,
            matched_conditions, factor_values, created_at
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.signalId}, #{item.executionId}, #{item.strategyId},
                #{item.strategyVersion}, #{item.stockId}, #{item.tradeDate},
                #{item.signalType}, #{item.confidenceScore},
                #{item.matchedConditions, typeHandler=com.chris.fin_shark.common.handler.JsonbTypeHandler},
                #{item.factorValues, typeHandler=com.chris.fin_shark.common.handler.JsonbTypeHandler},
                CURRENT_TIMESTAMP
            )
        </foreach>
    </insert>

    <!-- æŸ¥è©¢ç­–ç•¥ä¿¡è™Ÿï¼ˆä¾› M13 æ¶ˆè²»ï¼‰ -->
    <select id="selectUnconsumedSignals" resultType="com.chris.fin_shark.m11.dto.StrategySignalDTO">
        SELECT
            signal_id,
            execution_id,
            strategy_id,
            strategy_version,
            stock_id,
            trade_date,
            signal_type,
            confidence_score,
            matched_conditions,
            factor_values
        FROM strategy_signals
        WHERE trade_date = #{tradeDate}
          AND is_consumed = false
        <if test="strategyId != null">
            AND strategy_id = #{strategyId}
        </if>
        <if test="signalType != null">
            AND signal_type = #{signalType}
        </if>
        <if test="minConfidence != null">
            AND confidence_score >= #{minConfidence}
        </if>
        ORDER BY confidence_score DESC
        LIMIT #{limit}
    </select>

    <!-- æ¨™è¨˜ä¿¡è™Ÿå·²æ¶ˆè²»ï¼ˆä¾› M13 å‘¼å«ï¼‰ -->
    <update id="markSignalsConsumed">
        UPDATE strategy_signals
        SET is_consumed = true,
            consumed_by = #{consumedBy},
            consumed_at = CURRENT_TIMESTAMP
        WHERE signal_id = ANY(#{signalIds}::varchar[])
          AND trade_date = #{tradeDate}
    </update>

</mapper>
```

### 3.2 StrategyExecutionMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chris.fin_shark.m11.mapper.StrategyExecutionMapper">

    <!-- è¼‰å…¥ç­–ç•¥åŸ·è¡Œæ‰€éœ€çš„å› å­æ•¸æ“šï¼ˆè·¨ M07/M08/M09ï¼‰ -->
    <select id="loadFactorDataForExecution" resultType="com.chris.fin_shark.m11.dto.FactorDataDTO">
        SELECT
            s.stock_id,
            s.stock_name,
            s.market_type,
            s.industry,
            -- M06 åƒ¹é‡å› å­
            sp.close_price,
            sp.volume,
            sp.volume / NULLIF(sp.volume_ma20, 0) as volume_ratio,
            (sp.close_price - sp.prev_close) / NULLIF(sp.prev_close, 0) * 100 as price_change_pct,
            -- M07 æŠ€è¡“æŒ‡æ¨™
            ti.rsi_14,
            ti.macd_histogram,
            ti.kd_k,
            ti.kd_d,
            ti.ma5,
            ti.ma20,
            ti.ma60,
            ti.bollinger_upper,
            ti.bollinger_lower,
            ti.bollinger_middle,
            -- M08 è²¡å‹™æŒ‡æ¨™
            fi.pe_ratio,
            fi.pb_ratio,
            fi.roe,
            fi.eps,
            fi.dividend_yield,
            fi.revenue_growth_yoy,
            fi.profit_margin,
            -- M09 ç±Œç¢¼æŒ‡æ¨™
            ca.foreign_net,
            ca.foreign_continuous_days,
            ca.foreign_accumulated_20d,
            ca.trust_net,
            ca.trust_continuous_days,
            ca.dealer_net,
            ca.total_net,
            ca.margin_balance,
            ca.margin_change,
            ca.margin_short_ratio,
            ca.chip_score
        FROM stocks s
        LEFT JOIN stock_prices sp
            ON s.stock_id = sp.stock_id AND sp.trade_date = #{tradeDate}
        LEFT JOIN technical_indicators ti
            ON s.stock_id = ti.stock_id AND ti.trade_date = #{tradeDate}
        LEFT JOIN fundamental_indicators fi
            ON s.stock_id = fi.stock_id AND fi.report_date = #{latestReportDate}
        LEFT JOIN chip_analysis_results ca
            ON s.stock_id = ca.stock_id AND ca.trade_date = #{tradeDate}
        WHERE s.is_active = true
        <if test="marketType != null">
            AND s.market_type = #{marketType}
        </if>
        <if test="minVolume != null and minVolume > 0">
            AND sp.volume >= #{minVolume}
        </if>
        <if test="excludeEtf">
            AND s.security_type != 'ETF'
        </if>
        <if test="stockIds != null and stockIds.size() > 0">
            AND s.stock_id = ANY(#{stockIds}::varchar[])
        </if>
        <if test="industries != null and industries.size() > 0">
            AND s.industry = ANY(#{industries}::varchar[])
        </if>
    </select>

    <!-- æŸ¥è©¢ç­–ç•¥åŸ·è¡Œæ­·å² -->
    <select id="selectExecutionHistory" resultType="com.chris.fin_shark.m11.dto.ExecutionHistoryDTO">
        SELECT
            execution_id,
            strategy_id,
            strategy_version,
            execution_date,
            execution_type,
            stocks_evaluated,
            signals_generated,
            buy_signals,
            sell_signals,
            avg_confidence,
            execution_time_ms,
            status,
            started_at as executed_at
        FROM strategy_executions
        WHERE strategy_id = #{strategyId}
        <if test="startDate != null">
            AND execution_date >= #{startDate}
        </if>
        <if test="endDate != null">
            AND execution_date &lt;= #{endDate}
        </if>
        ORDER BY execution_date DESC, started_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- æ›´æ–°ç­–ç•¥åŸ·è¡Œçµ±è¨ˆï¼ˆå®Œæˆå¾Œæ›´æ–° strategies è¡¨ï¼‰ -->
    <update id="updateStrategyStatistics">
        UPDATE strategies
        SET total_executions = total_executions + 1,
            total_signals = total_signals + #{signalsGenerated},
            last_execution_at = #{executedAt},
            updated_at = CURRENT_TIMESTAMP
        WHERE strategy_id = #{strategyId}
    </update>

</mapper>
```

---

## 4. è³‡æ–™é—œè¯åœ–

```
ä¸Šæ¸¸è³‡æ–™è¡¨ï¼ˆåªè®€ï¼‰                         M11 è³‡æ–™è¡¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ stocks (M06)         â”‚                â”‚    strategies        â”‚
â”‚ (è‚¡ç¥¨åŸºæœ¬è³‡æ–™)        â”‚                â”‚  (ç­–ç•¥å®šç¾©è¡¨)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                       â”‚
           â”‚                                       â”‚
           â–¼                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ stock_prices (M06)   â”‚                â”‚  strategy_versions   â”‚
â”‚ (è‚¡åƒ¹è³‡æ–™)           â”‚                â”‚  (ç‰ˆæœ¬æ­·å²è¡¨)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                       â”‚
           â”‚                                       â”‚
           â–¼                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚technical_indicators  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ strategy_executions  â”‚
â”‚ (M07 æŠ€è¡“æŒ‡æ¨™)       â”‚  å› å­æ•¸æ“šè®€å–   â”‚  (åŸ·è¡Œè¨˜éŒ„è¡¨)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                       â”‚
           â”‚                                       â”‚
           â–¼                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚fundamental_indicatorsâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚   strategy_signals   â”‚
â”‚ (M08 è²¡å‹™æŒ‡æ¨™)       â”‚  å› å­æ•¸æ“šè®€å–   â”‚   (ç­–ç•¥ä¿¡è™Ÿè¡¨)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                       â”‚
           â”‚                                       â”‚ ä¾› M13 æ¶ˆè²»
           â–¼                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚chip_analysis_results â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚     M13 ä¿¡è™Ÿå¼•æ“      â”‚
â”‚ (M09 ç±Œç¢¼åˆ†æ)       â”‚  å› å­æ•¸æ“šè®€å–   â”‚   (ä¸‹æ¸¸æ¶ˆè²»è€…)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   factor_metadata    â”‚
           â”‚   (å› å­å…ƒæ•¸æ“šè¡¨)      â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ å®šç¾©å¯ç”¨å› å­
                      â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚strategy_optimizationsâ”‚
           â”‚  (åƒæ•¸å„ªåŒ–è¨˜éŒ„è¡¨)     â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ç´¢å¼•ç­–ç•¥

### 5.1 ä¸»è¦æŸ¥è©¢å ´æ™¯èˆ‡ç´¢å¼•

| æŸ¥è©¢å ´æ™¯ | ä½¿ç”¨ç´¢å¼• | èªªæ˜ |
|---------|---------|------|
| ç­–ç•¥æ¸…å–®æŸ¥è©¢ | idx_strategies_status | æŒ‰ç‹€æ…‹ç¯©é¸ |
| ç­–ç•¥æ¢ä»¶æœç´¢ | idx_strategies_conditions | JSONB GIN ç´¢å¼• |
| ä¿¡è™Ÿæ—¥æœŸæŸ¥è©¢ | idx_strategy_signals_trade_date | åˆ†å€è£å‰ª + ç´¢å¼• |
| ç­–ç•¥ä¿¡è™ŸæŸ¥è©¢ | idx_strategy_signals_strategy_date | è¤‡åˆç´¢å¼• |
| æœªæ¶ˆè²»ä¿¡è™ŸæŸ¥è©¢ | idx_strategy_signals_is_consumed | M13 æ¶ˆè²»æŸ¥è©¢ |
| åŸ·è¡Œæ­·å²æŸ¥è©¢ | idx_strategy_executions_strategy_date | è¤‡åˆç´¢å¼• |

### 5.2 åˆ†å€ç­–ç•¥

- `strategy_signals` æŒ‰æœˆä»½åˆ†å€
- æŸ¥è©¢æ™‚è‡ªå‹•è£å‰ªä¸ç›¸é—œæœˆä»½
- æ­·å²è³‡æ–™å¯ DETACH èˆŠåˆ†å€æ­¸æª”

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [M11 åŠŸèƒ½éœ€æ±‚](../specs/functional/M11-é‡åŒ–ç­–ç•¥åŠŸèƒ½éœ€æ±‚.md)
- [M11 APIè¦æ ¼](../specs/api/M11-APIè¦æ ¼.md)
- [M11 ERD](./erd/M11-ERD.md)
- [M07 è³‡æ–™åº«è¨­è¨ˆ](./M07-è³‡æ–™åº«è¨­è¨ˆ.md)
- [M08 è³‡æ–™åº«è¨­è¨ˆ](./M08-è³‡æ–™åº«è¨­è¨ˆ.md)
- [M09 è³‡æ–™åº«è¨­è¨ˆ](./M09-è³‡æ–™åº«è¨­è¨ˆ.md)

---

**æ–‡ä»¶ç¶­è­·è€…**: è³‡æ–™åº«æ¶æ§‹å¸«
**æœ€å¾Œæ›´æ–°**: 2026-01-14
**ä¸‹æ¬¡å¯©æ ¸**: 2026-04-14
