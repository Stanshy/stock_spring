# M11-é‡åŒ–ç­–ç•¥æ¨¡çµ„æ¸¬è©¦æº–å‰‡

> **æ–‡ä»¶ç·¨è™Ÿ**: TEST-M11
> **æ¨¡çµ„åç¨±**: é‡åŒ–ç­–ç•¥æ¨¡çµ„
> **ç‰ˆæœ¬**: v1.0
> **æœ€å¾Œæ›´æ–°**: 2026-01-14
> **ç‹€æ…‹**: Draft

---

## 1. æ¸¬è©¦ç¸½è¦½

æœ¬æ–‡ä»¶å®šç¾©é‡åŒ–ç­–ç•¥æ¨¡çµ„çš„æ¸¬è©¦ç­–ç•¥ã€æ¸¬è©¦å ´æ™¯èˆ‡æ¸¬è©¦æº–å‰‡ã€‚

**æ¸¬è©¦é‡é»**:
- æ¢ä»¶æ¨¹è©•ä¼°é‚è¼¯æ­£ç¢ºæ€§
- å› å­è¼‰å…¥èˆ‡è·¨æ¨¡çµ„æ•´åˆ
- ä¿¡å¿ƒåˆ†æ•¸è¨ˆç®—æº–ç¢ºæ€§
- ç­–ç•¥åŸ·è¡Œå¼•æ“å¯é æ€§
- M13 ä¿¡è™Ÿæ¶ˆè²»æ•´åˆ

---

## 2. å–®å…ƒæ¸¬è©¦

### 2.1 æ¢ä»¶æ¨¹è©•ä¼°å™¨æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™**: é©—è­‰æ¢ä»¶æ¨¹è§£æèˆ‡è©•ä¼°é‚è¼¯æ­£ç¢ºæ€§

**æ¸¬è©¦å ´æ™¯**:

#### åŸºæœ¬æ¢ä»¶æ¸¬è©¦

```
æ¸¬è©¦: ConditionEvaluator.evaluate() - å–®ä¸€æ¢ä»¶
Given: æ¢ä»¶ {"factor": "RSI_14", "operator": ">=", "value": 70}
       å› å­å€¼ {"RSI_14": 75.5}
When: åŸ·è¡Œ evaluate()
Then:
  - è¿”å› true
  - è©•ä¼°æ™‚é–“ < 1ms

æ¸¬è©¦: ConditionEvaluator.evaluate() - æ¢ä»¶ä¸æ»¿è¶³
Given: æ¢ä»¶ {"factor": "RSI_14", "operator": ">=", "value": 70}
       å› å­å€¼ {"RSI_14": 45.2}
When: åŸ·è¡Œ evaluate()
Then:
  - è¿”å› false

æ¸¬è©¦: ConditionEvaluator.evaluate() - å› å­ä¸å­˜åœ¨
Given: æ¢ä»¶ {"factor": "UNKNOWN_FACTOR", "operator": ">=", "value": 50}
       å› å­å€¼ {"RSI_14": 75.5}
When: åŸ·è¡Œ evaluate()
Then:
  - è¿”å› false
  - diagnostics è¨˜éŒ„ "FACTOR_NOT_FOUND" è­¦å‘Š
```

#### è¤‡åˆæ¢ä»¶æ¸¬è©¦ï¼ˆAND/ORï¼‰

```
æ¸¬è©¦: ConditionEvaluator.evaluate() - AND æ¢ä»¶å…¨æ»¿è¶³
Given: æ¢ä»¶
  {
    "operator": "AND",
    "conditions": [
      {"factor": "RSI_14", "operator": ">=", "value": 70},
      {"factor": "MACD_HISTOGRAM", "operator": ">", "value": 0}
    ]
  }
  å› å­å€¼ {"RSI_14": 75, "MACD_HISTOGRAM": 0.5}
When: åŸ·è¡Œ evaluate()
Then:
  - è¿”å› true

æ¸¬è©¦: ConditionEvaluator.evaluate() - AND æ¢ä»¶éƒ¨åˆ†æ»¿è¶³
Given: æ¢ä»¶
  {
    "operator": "AND",
    "conditions": [
      {"factor": "RSI_14", "operator": ">=", "value": 70},
      {"factor": "MACD_HISTOGRAM", "operator": ">", "value": 0}
    ]
  }
  å› å­å€¼ {"RSI_14": 75, "MACD_HISTOGRAM": -0.5}
When: åŸ·è¡Œ evaluate()
Then:
  - è¿”å› false
  - çŸ­è·¯è©•ä¼°ç”Ÿæ•ˆï¼ˆMACD æ¢ä»¶å¤±æ•—å¾Œç«‹å³è¿”å›ï¼‰

æ¸¬è©¦: ConditionEvaluator.evaluate() - OR æ¢ä»¶ä»»ä¸€æ»¿è¶³
Given: æ¢ä»¶
  {
    "operator": "OR",
    "conditions": [
      {"factor": "RSI_14", "operator": ">=", "value": 70},
      {"factor": "RSI_14", "operator": "<=", "value": 30}
    ]
  }
  å› å­å€¼ {"RSI_14": 25}
When: åŸ·è¡Œ evaluate()
Then:
  - è¿”å› trueï¼ˆç¬¬äºŒæ¢ä»¶æ»¿è¶³ï¼‰

æ¸¬è©¦: ConditionEvaluator.evaluate() - å·¢ç‹€æ¢ä»¶
Given: æ¢ä»¶
  {
    "operator": "AND",
    "conditions": [
      {
        "operator": "OR",
        "conditions": [
          {"factor": "RSI_14", "operator": ">=", "value": 70},
          {"factor": "RSI_7", "operator": ">=", "value": 75}
        ]
      },
      {"factor": "VOLUME_RATIO", "operator": ">", "value": 1.5}
    ]
  }
  å› å­å€¼ {"RSI_14": 65, "RSI_7": 80, "VOLUME_RATIO": 2.0}
When: åŸ·è¡Œ evaluate()
Then:
  - è¿”å› trueï¼ˆRSI_7 æ»¿è¶³ ORï¼ŒVOLUME_RATIO æ»¿è¶³ ANDï¼‰
```

#### é‹ç®—ç¬¦æ¸¬è©¦

```
æ¸¬è©¦: æ‰€æœ‰æ¯”è¼ƒé‹ç®—ç¬¦
Given: å› å­å€¼ {"TEST_FACTOR": 50}

æ¸¬è©¦æ¡ˆä¾‹:
| operator | value | é æœŸçµæœ |
|----------|-------|---------|
| >        | 49    | true    |
| >        | 50    | false   |
| >=       | 50    | true    |
| <        | 51    | true    |
| <=       | 50    | true    |
| ==       | 50    | true    |
| !=       | 50    | false   |
| BETWEEN  | [40,60] | true  |
| IN       | [48,50,52] | true |

æ¸¬è©¦: BETWEEN é‹ç®—ç¬¦é‚Šç•Œ
Given: å› å­å€¼ {"PRICE": 100}
       æ¢ä»¶ {"factor": "PRICE", "operator": "BETWEEN", "value": [100, 200]}
When: åŸ·è¡Œ evaluate()
Then:
  - è¿”å› trueï¼ˆåŒ…å«é‚Šç•Œå€¼ï¼‰
```

---

### 2.2 ä¿¡å¿ƒåˆ†æ•¸è¨ˆç®—å™¨æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™**: é©—è­‰ä¿¡å¿ƒåˆ†æ•¸è¨ˆç®—é‚è¼¯æ­£ç¢ºæ€§

```
æ¸¬è©¦: ConfidenceCalculator.calculate() - åŸºæœ¬è¨ˆç®—
Given:
  ç­–ç•¥å®šç¾©:
    - factor_weights: {"RSI_14": 0.3, "MACD_HISTOGRAM": 0.3, "PE_RATIO": 0.4}
    - factor_scores è¨ˆç®—è¦å‰‡å·²å®šç¾©
  å› å­å€¼: {"RSI_14": 75, "MACD_HISTOGRAM": 0.5, "PE_RATIO": 12}
When: åŸ·è¡Œ calculate()
Then:
  - confidenceScore = åŠ æ¬Šåˆ†æ•¸åˆè¨ˆ
  - åˆ†æ•¸ç¯„åœåœ¨ [0, 1] ä¹‹é–“
  - ç²¾ç¢ºåˆ°å°æ•¸é»å¾Œ 4 ä½

æ¸¬è©¦: ConfidenceCalculator.calculate() - éƒ¨åˆ†å› å­ç¼ºå¤±
Given:
  - factor_weights: {"RSI_14": 0.5, "UNKNOWN": 0.5}
  - å› å­å€¼: {"RSI_14": 75}
When: åŸ·è¡Œ calculate()
Then:
  - ä½¿ç”¨å¯ç”¨å› å­è¨ˆç®—ï¼ˆé‡æ–°åˆ†é…æ¬Šé‡ï¼‰
  - confidenceScore ä»åœ¨æœ‰æ•ˆç¯„åœ
  - diagnostics è¨˜éŒ„ç¼ºå¤±å› å­

æ¸¬è©¦: ConfidenceCalculator.calculate() - æ‰€æœ‰å› å­ç¼ºå¤±
Given:
  - factor_weights: {"FACTOR_A": 0.5, "FACTOR_B": 0.5}
  - å› å­å€¼: {} (ç©º)
When: åŸ·è¡Œ calculate()
Then:
  - è¿”å›é è¨­ä¿¡å¿ƒåˆ†æ•¸ 0.5
  - diagnostics è¨˜éŒ„åš´é‡è­¦å‘Š

æ¸¬è©¦: ConfidenceCalculator.normalizeScore() - åˆ†æ•¸æ­£è¦åŒ–
Given:
  - RSI_14 = 85
  - æ­£è¦åŒ–è¦å‰‡: RSI > 80 â†’ å¾—åˆ† 1.0, RSI 50-80 â†’ ç·šæ€§æ˜ å°„
When: åŸ·è¡Œ normalizeScore("RSI_14", 85)
Then:
  - è¿”å› 1.0
```

---

### 2.3 ç­–ç•¥åŸ·è¡Œå¼•æ“æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™**: é©—è­‰ç­–ç•¥åŸ·è¡Œå¼•æ“çš„å”èª¿é‚è¼¯

```
æ¸¬è©¦: DefaultStrategyEngine.execute() - å®Œæ•´åŸ·è¡Œï¼ˆç”¢ç”Ÿè²·å…¥ä¿¡è™Ÿï¼‰
Given:
  - ç­–ç•¥: å‹•èƒ½çªç ´ç­–ç•¥ï¼ˆRSI >= 70 AND Volume > MAï¼‰
  - è‚¡ç¥¨ 2330 ç¬¦åˆæ¢ä»¶
When: åŸ·è¡Œ execute(strategy, ["2330"], tradeDate)
Then:
  - è¿”å› ExecutionResult
  - signals åŒ…å« 2330 çš„ BUY ä¿¡è™Ÿ
  - diagnostics.successfulStocks = 1
  - diagnostics.signalsGenerated = 1

æ¸¬è©¦: DefaultStrategyEngine.execute() - ä¸ç¬¦åˆæ¢ä»¶
Given:
  - ç­–ç•¥: å‹•èƒ½çªç ´ç­–ç•¥
  - è‚¡ç¥¨ 2330 ä¸ç¬¦åˆæ¢ä»¶ï¼ˆRSI = 45ï¼‰
When: åŸ·è¡Œ execute()
Then:
  - signals ç‚ºç©ºï¼ˆæˆ–åŒ…å« HOLD ä¿¡è™Ÿï¼Œè¦–ç­–ç•¥é…ç½®ï¼‰
  - diagnostics.stocksEvaluated = 1
  - diagnostics.signalsGenerated = 0

æ¸¬è©¦: DefaultStrategyEngine.execute() - æ‰¹æ¬¡åŸ·è¡Œ
Given:
  - ç­–ç•¥: å‹•èƒ½çªç ´ç­–ç•¥
  - è‚¡ç¥¨æ¸…å–®: 100 æª”è‚¡ç¥¨
  - å…¶ä¸­ 15 æª”ç¬¦åˆæ¢ä»¶
When: åŸ·è¡Œ execute(strategy, stockList, tradeDate)
Then:
  - signals.size() = 15
  - diagnostics.stocksEvaluated = 100
  - åŸ·è¡Œæ™‚é–“ < 5 ç§’

æ¸¬è©¦: DefaultStrategyEngine.execute() - å› å­è¼‰å…¥å¤±æ•—è™•ç†
Given:
  - ç­–ç•¥éœ€è¦ RSI_14 å› å­
  - è‚¡ç¥¨ 9999 ç„¡æŠ€è¡“æŒ‡æ¨™è³‡æ–™
When: åŸ·è¡Œ execute(strategy, ["9999"], tradeDate)
Then:
  - ä¸æ‹‹å‡ºç•°å¸¸
  - signals ç‚ºç©º
  - diagnostics.failedStocks = 1
  - diagnostics åŒ…å«éŒ¯èª¤è¨Šæ¯ "FACTOR_LOADING_FAILED"

æ¸¬è©¦: DefaultStrategyEngine.batchExecuteAllStrategies()
Given: 10 å€‹æ´»èºç­–ç•¥ï¼Œ1800 æª”è‚¡ç¥¨
When: åŸ·è¡Œæ¯æ—¥æ‰¹æ¬¡
Then:
  - æ‰€æœ‰ç­–ç•¥ä¾åºåŸ·è¡Œ
  - æ¯ç­–ç•¥çš„çµæœç¨ç«‹è¨˜éŒ„
  - å–®ç­–ç•¥å¤±æ•—ä¸å½±éŸ¿å…¶ä»–ç­–ç•¥
  - ç¸½åŸ·è¡Œæ™‚é–“ < 10 åˆ†é˜
```

---

### 2.4 å› å­è³‡æ–™è¼‰å…¥å™¨æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™**: é©—è­‰è·¨æ¨¡çµ„å› å­è¼‰å…¥é‚è¼¯

```
æ¸¬è©¦: FactorDataLoader.loadFactors() - è¼‰å…¥æŠ€è¡“å› å­
Given:
  - è‚¡ç¥¨ 2330 åœ¨ M07 æœ‰æŠ€è¡“æŒ‡æ¨™è³‡æ–™
  - éœ€è¦å› å­: ["RSI_14", "MACD_VALUE", "SMA_20"]
When: å‘¼å« loadFactors("2330", tradeDate, factors)
Then:
  - è¿”å› Map åŒ…å« 3 å€‹å› å­
  - æ•¸å€¼æ­£ç¢ºå°æ‡‰ M07 è³‡æ–™

æ¸¬è©¦: FactorDataLoader.loadFactors() - è¼‰å…¥è²¡å‹™å› å­
Given:
  - è‚¡ç¥¨ 2330 åœ¨ M08 æœ‰è²¡å‹™æŒ‡æ¨™è³‡æ–™
  - éœ€è¦å› å­: ["PE_RATIO", "ROE", "DEBT_RATIO"]
When: å‘¼å« loadFactors("2330", tradeDate, factors)
Then:
  - è¿”å› Map åŒ…å« 3 å€‹å› å­
  - æ•¸å€¼æ­£ç¢ºå°æ‡‰ M08 è³‡æ–™

æ¸¬è©¦: FactorDataLoader.loadFactors() - è¼‰å…¥ç±Œç¢¼å› å­
Given:
  - è‚¡ç¥¨ 2330 åœ¨ M09 æœ‰ç±Œç¢¼åˆ†æè³‡æ–™
  - éœ€è¦å› å­: ["FOREIGN_NET", "CHIP_SCORE"]
When: å‘¼å« loadFactors("2330", tradeDate, factors)
Then:
  - è¿”å› Map åŒ…å« 2 å€‹å› å­
  - æ•¸å€¼æ­£ç¢ºå°æ‡‰ M09 è³‡æ–™

æ¸¬è©¦: FactorDataLoader.batchLoadFactors() - æ‰¹æ¬¡è¼‰å…¥
Given:
  - 100 æª”è‚¡ç¥¨
  - éœ€è¦å› å­: ["RSI_14", "PE_RATIO", "FOREIGN_NET"]ï¼ˆè·¨ 3 æ¨¡çµ„ï¼‰
When: å‘¼å« batchLoadFactors(stockIds, tradeDate, factors)
Then:
  - ä¸¦è¡ŒæŸ¥è©¢ M07/M08/M09
  - è¿”å› 100 Ã— 3 çš„å› å­çŸ©é™£
  - åŸ·è¡Œæ™‚é–“ < 500ms

æ¸¬è©¦: FactorDataLoader.loadFactors() - å› å­ä¸å­˜åœ¨
Given:
  - è‚¡ç¥¨ 2330 ç„¡ç•¶æ—¥è³‡æ–™
When: å‘¼å« loadFactors("2330", tradeDate, factors)
Then:
  - è¿”å›ç©º Map æˆ–éƒ¨åˆ†è³‡æ–™
  - ä¸æ‹‹å‡ºç•°å¸¸
```

---

### 2.5 Service å±¤æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™**: é©—è­‰æ¥­å‹™é‚è¼¯æ­£ç¢ºæ€§

```
æ¸¬è©¦: StrategyService.createStrategy()
Given: æœ‰æ•ˆçš„ç­–ç•¥å®šç¾© DTO
When: å‘¼å« createStrategy(dto)
Then:
  - ç­–ç•¥æˆåŠŸå„²å­˜
  - è‡ªå‹•ç”¢ç”Ÿ strategy_id
  - ç‰ˆæœ¬è™Ÿåˆå§‹ç‚º "1.0.0"
  - ç‹€æ…‹ç‚º "DRAFT"

æ¸¬è©¦: StrategyService.updateStrategy()
Given:
  - ç¾æœ‰ç­–ç•¥ STG_001 (version = "1.0.0")
  - æ›´æ–°æ¢ä»¶å®šç¾©
When: å‘¼å« updateStrategy(strategyId, dto)
Then:
  - ç­–ç•¥æ›´æ–°æˆåŠŸ
  - ç‰ˆæœ¬è™Ÿéå¢ç‚º "1.1.0"
  - èˆŠç‰ˆæœ¬å„²å­˜åˆ° strategy_versions

æ¸¬è©¦: StrategyService.activateStrategy()
Given: ç­–ç•¥ç‹€æ…‹ç‚º "DRAFT"
When: å‘¼å« activateStrategy(strategyId)
Then:
  - ç­–ç•¥ç‹€æ…‹è®Šæ›´ç‚º "ACTIVE"
  - æ¢ä»¶æ¨¹é ç·¨è­¯ä¸¦å¿«å–

æ¸¬è©¦: StrategySignalService.getSignals() - å¿«å–å‘½ä¸­
Given: Redis å¿«å–ä¸­æœ‰ 2330 çš„ç•¶æ—¥ä¿¡è™Ÿ
When: å‘¼å« getSignals("2330", tradeDate)
Then:
  - ç›´æ¥è¿”å›å¿«å–çµæœ
  - ä¸æŸ¥è©¢è³‡æ–™åº«

æ¸¬è©¦: StrategySignalService.markAsConsumed()
Given: M13 æ¶ˆè²»ä¿¡è™Ÿ
When: å‘¼å« markAsConsumed(signalIds)
Then:
  - is_consumed æ›´æ–°ç‚º true
  - consumed_at æ›´æ–°ç‚ºç•¶å‰æ™‚é–“
  - è¿”å›æ›´æ–°ç­†æ•¸
```

**Mock ç­–ç•¥**:
- Mock FactorDataLoaderï¼ˆå–®å…ƒæ¸¬è©¦ï¼‰
- Mock StrategySignalMapperï¼ˆå–®å…ƒæ¸¬è©¦ï¼‰
- ä½¿ç”¨çœŸå¯¦ PostgreSQLï¼ˆæ•´åˆæ¸¬è©¦ï¼ŒTestcontainersï¼‰

---

## 3. æ•´åˆæ¸¬è©¦

### 3.1 è³‡æ–™åº«æ•´åˆæ¸¬è©¦

**æ¸¬è©¦ç’°å¢ƒ**: ä½¿ç”¨ Testcontainers å•Ÿå‹• PostgreSQL å®¹å™¨

```
æ¸¬è©¦: StrategySignalMapper.batchInsertSignals()
Given: æº–å‚™ 500 ç­†ç­–ç•¥ä¿¡è™Ÿ
When: åŸ·è¡Œæ‰¹æ¬¡ INSERT
Then:
  - åŸ·è¡Œæ™‚é–“ < 1s
  - æ‰€æœ‰è³‡æ–™æ­£ç¢ºå„²å­˜
  - signal_id å”¯ä¸€ç´„æŸç”Ÿæ•ˆ

æ¸¬è©¦: StrategySignalMapper.selectUnconsumedSignals()
Given: strategy_signals è¡¨æœ‰ 1000 ç­†è³‡æ–™ï¼Œ500 ç­† is_consumed = false
When: æŸ¥è©¢æœªæ¶ˆè²»ä¿¡è™Ÿ
Then:
  - è¿”å› 500 ç­†
  - æŸ¥è©¢æ™‚é–“ < 100ms
  - ç´¢å¼•ç”Ÿæ•ˆ

æ¸¬è©¦: StrategyMapper.selectActiveStrategies()
Given: strategies è¡¨æœ‰ 50 ç­†ï¼Œ20 ç­† status = 'ACTIVE'
When: æŸ¥è©¢æ´»èºç­–ç•¥
Then:
  - è¿”å› 20 ç­†
  - åŒ…å«å®Œæ•´ç­–ç•¥å®šç¾©
  - JSONB æ¬„ä½æ­£ç¢ºååºåˆ—åŒ–

æ¸¬è©¦: åˆ†å€è£å‰ª
Given: strategy_signals æœ‰ 2024-10 è‡³ 2025-01 æœˆåº¦åˆ†å€
When: æŸ¥è©¢ 2024-12 ä¿¡è™Ÿ
Then:
  - åªæƒæ strategy_signals_2024_12 åˆ†å€
  - EXPLAIN é¡¯ç¤ºåˆ†å€è£å‰ªç”Ÿæ•ˆ
```

---

### 3.2 å¿«å–æ•´åˆæ¸¬è©¦

**æ¸¬è©¦ç’°å¢ƒ**: ä½¿ç”¨ Testcontainers å•Ÿå‹• Redis å®¹å™¨

```
æ¸¬è©¦: ç­–ç•¥å®šç¾©å¿«å–
Given: ç­–ç•¥ STG_001 å·²å„²å­˜
When: é€£çºŒæŸ¥è©¢ 10 æ¬¡
Then:
  - ç¬¬ä¸€æ¬¡æŸ¥è©¢è³‡æ–™åº«
  - å¾ŒçºŒ 9 æ¬¡å‘½ä¸­å¿«å–
  - å¿«å– TTL æ­£ç¢º

æ¸¬è©¦: ä¿¡è™Ÿå¿«å–å¯«å…¥èˆ‡è®€å–
Given: åŸ·è¡Œå®Œæˆï¼Œç”¢ç”Ÿ 50 ç­†ä¿¡è™Ÿ
When: å¯«å…¥å¿«å–å¾Œè®€å–
Then:
  - è³‡æ–™æ­£ç¢ºåºåˆ—åŒ–/ååºåˆ—åŒ–
  - å–®è‚¡ä¿¡è™Ÿå¿«å–åŒæ­¥æ›´æ–°

æ¸¬è©¦: å¿«å–å¤±æ•ˆï¼ˆç­–ç•¥æ›´æ–°ï¼‰
Given: ç­–ç•¥ STG_001 å¿«å–ä¸­
When: æ›´æ–°ç­–ç•¥å®šç¾©
Then:
  - å¿«å–è‡ªå‹•å¤±æ•ˆ
  - ä¸‹æ¬¡æŸ¥è©¢é‡æ–°è¼‰å…¥
  - ç·¨è­¯æ¢ä»¶æ¨¹å¿«å–åŒæ­¥æ¸…é™¤
```

---

### 3.3 M07/M08/M09 ä¾è³´æ•´åˆæ¸¬è©¦

```
æ¸¬è©¦: å¾ M07 è¼‰å…¥æŠ€è¡“å› å­
Given: technical_indicators è¡¨æœ‰ 2330 çš„è³‡æ–™
When: å‘¼å« FactorDataLoader.loadTechnicalFactors("2330", tradeDate)
Then:
  - æ­£ç¢ºè¼‰å…¥ RSI, MACD, SMA ç­‰æŒ‡æ¨™
  - æ•¸å€¼ç²¾ç¢ºåº¦æ­£ç¢º

æ¸¬è©¦: å¾ M08 è¼‰å…¥è²¡å‹™å› å­
Given: fundamental_indicators è¡¨æœ‰ 2330 çš„è³‡æ–™
When: å‘¼å« FactorDataLoader.loadFundamentalFactors("2330", tradeDate)
Then:
  - æ­£ç¢ºè¼‰å…¥ PE, ROE, EPS ç­‰æŒ‡æ¨™
  - æ•¸å€¼ç²¾ç¢ºåº¦æ­£ç¢º

æ¸¬è©¦: å¾ M09 è¼‰å…¥ç±Œç¢¼å› å­
Given: chip_analysis_results è¡¨æœ‰ 2330 çš„è³‡æ–™
When: å‘¼å« FactorDataLoader.loadChipFactors("2330", tradeDate)
Then:
  - æ­£ç¢ºè¼‰å…¥ FOREIGN_NET, CHIP_SCORE ç­‰æŒ‡æ¨™
  - æ•¸å€¼ç²¾ç¢ºåº¦æ­£ç¢º

æ¸¬è©¦: è·¨æ¨¡çµ„å› å­è¯åˆè¼‰å…¥
Given: ç­–ç•¥éœ€è¦ RSI_14 (M07) + PE_RATIO (M08) + FOREIGN_NET (M09)
When: åŸ·è¡Œç­–ç•¥
Then:
  - ä¸‰å€‹æ¨¡çµ„çš„å› å­æ­£ç¢ºè¼‰å…¥
  - ä¸¦è¡ŒæŸ¥è©¢ç”Ÿæ•ˆï¼ˆåŸ·è¡Œæ™‚é–“ < ä¸²è¡Œï¼‰
  - æ¢ä»¶è©•ä¼°ä½¿ç”¨æ­£ç¢ºå› å­å€¼

æ¸¬è©¦: ä¸Šæ¸¸æ¨¡çµ„è³‡æ–™ä¸å®Œæ•´
Given: è‚¡ç¥¨ 8888 åƒ…æœ‰ M07 è³‡æ–™ï¼Œç„¡ M08/M09 è³‡æ–™
When: åŸ·è¡Œéœ€è¦è·¨æ¨¡çµ„å› å­çš„ç­–ç•¥
Then:
  - ä¸æ‹‹å‡ºç•°å¸¸
  - ä½¿ç”¨å¯ç”¨å› å­è©•ä¼°
  - diagnostics è¨˜éŒ„ç¼ºå¤±æ¨¡çµ„
```

---

### 3.4 M13 æ•´åˆæ¸¬è©¦

```
æ¸¬è©¦: M13 æ¶ˆè²»æœªè™•ç†ä¿¡è™Ÿ
Given: ç•¶æ—¥ strategy_signals æœ‰ 100 ç­† is_consumed = false
When: M13 å‘¼å« GET /api/v1/strategy/signals/unconsumed
Then:
  - è¿”å› 100 ç­†ä¿¡è™Ÿ
  - åŒ…å«æ‰€æœ‰å¿…è¦æ¬„ä½ä¾› M13 è™•ç†

æ¸¬è©¦: M13 æ¨™è¨˜ä¿¡è™Ÿå·²æ¶ˆè²»
Given: M13 è™•ç†å®Œ 50 ç­†ä¿¡è™Ÿ
When: M13 å‘¼å« POST /api/v1/strategy/signals/consumed
Then:
  - 50 ç­†ä¿¡è™Ÿ is_consumed = true
  - consumed_at å·²æ›´æ–°
  - è¿”å›æˆåŠŸç­†æ•¸

æ¸¬è©¦: äº‹ä»¶é€šçŸ¥ M13
Given: JOB-M11-001 åŸ·è¡Œå®Œæˆ
When: JOB-M11-002 ç™¼é€äº‹ä»¶
Then:
  - äº‹ä»¶æ ¼å¼æ­£ç¢º
  - åŒ…å« summaryï¼ˆç¸½ä¿¡è™Ÿæ•¸ã€è²·è³£ä¿¡è™Ÿæ•¸ï¼‰
  - M13 å¯æ­£ç¢ºæ¥æ”¶
```

---

## 4. API æ¸¬è©¦

**æ¸¬è©¦å·¥å…·**: MockMvc æˆ– RestAssured

### 4.1 ç­–ç•¥ç®¡ç† API

```
æ¸¬è©¦: POST /api/v1/strategy - å»ºç«‹ç­–ç•¥
Given: æœ‰æ•ˆçš„ç­–ç•¥å®šç¾©
When: POST /api/v1/strategy
Then:
  - HTTP 201
  - Response åŒ…å« strategy_id
  - è³‡æ–™åº«æœ‰æ–°è¨˜éŒ„

æ¸¬è©¦: GET /api/v1/strategy/{id} - å–å¾—ç­–ç•¥
Given: ç­–ç•¥ STG_001 å­˜åœ¨
When: GET /api/v1/strategy/STG_001
Then:
  - HTTP 200
  - Response åŒ…å«å®Œæ•´ç­–ç•¥å®šç¾©
  - åŒ…å« conditions JSONB

æ¸¬è©¦: PUT /api/v1/strategy/{id} - æ›´æ–°ç­–ç•¥
Given: ç­–ç•¥ STG_001 ç‹€æ…‹ç‚º DRAFT
When: PUT /api/v1/strategy/STG_001
Then:
  - HTTP 200
  - ç‰ˆæœ¬è™Ÿéå¢
  - æ¢ä»¶å·²æ›´æ–°

æ¸¬è©¦: POST /api/v1/strategy/{id}/activate - å•Ÿç”¨ç­–ç•¥
Given: ç­–ç•¥ç‹€æ…‹ç‚º DRAFT
When: POST /api/v1/strategy/STG_001/activate
Then:
  - HTTP 200
  - ç‹€æ…‹è®Šæ›´ç‚º ACTIVE
```

### 4.2 ç­–ç•¥åŸ·è¡Œ API

```
æ¸¬è©¦: POST /api/v1/strategy/{id}/execute - å³æ™‚åŸ·è¡Œ
Given: æ´»èºç­–ç•¥ STG_001
When: POST /api/v1/strategy/STG_001/execute
       Body: {"stock_universe": {"type": "MARKET", "market_type": "TWSE"}}
Then:
  - HTTP 200
  - Response åŒ…å« execution_id
  - åŒ…å«åŸ·è¡Œæ‘˜è¦ï¼ˆevaluated, signals_generatedï¼‰

æ¸¬è©¦: GET /api/v1/strategy/{id}/executions - åŸ·è¡Œæ­·å²
Given: ç­–ç•¥æœ‰ 10 æ¬¡åŸ·è¡Œè¨˜éŒ„
When: GET /api/v1/strategy/STG_001/executions?page=1&size=5
Then:
  - HTTP 200
  - è¿”å› 5 ç­†ï¼ŒæŒ‰åŸ·è¡Œæ™‚é–“é™åº
  - åŒ…å«åˆ†é è³‡è¨Š
```

### 4.3 ä¿¡è™ŸæŸ¥è©¢ API

```
æ¸¬è©¦: GET /api/v1/strategy/signals/stock/{stockId} - å–®è‚¡ä¿¡è™Ÿ
Given: è‚¡ç¥¨ 2330 æœ‰ç•¶æ—¥ä¿¡è™Ÿ
When: GET /api/v1/strategy/signals/stock/2330
Then:
  - HTTP 200
  - è¿”å›æ‰€æœ‰ç­–ç•¥å° 2330 çš„ä¿¡è™Ÿ
  - åŒ…å« signal_type, confidence_score

æ¸¬è©¦: GET /api/v1/strategy/signals/unconsumed - æœªæ¶ˆè²»ä¿¡è™Ÿ
Given: æœ‰ 50 ç­†æœªæ¶ˆè²»ä¿¡è™Ÿ
When: GET /api/v1/strategy/signals/unconsumed
Then:
  - HTTP 200
  - è¿”å› 50 ç­†
  - ä¾› M13 æ¶ˆè²»
```

### 4.4 éŒ¯èª¤å ´æ™¯

```
æ¸¬è©¦: ç­–ç•¥ä¸å­˜åœ¨
When: GET /api/v1/strategy/INVALID_ID
Then:
  - HTTP 404
  - error_code = "M11_STRATEGY_001"

æ¸¬è©¦: ç­–ç•¥æœªå•Ÿç”¨ç„¡æ³•åŸ·è¡Œ
Given: ç­–ç•¥ç‹€æ…‹ç‚º DRAFT
When: POST /api/v1/strategy/STG_001/execute
Then:
  - HTTP 400
  - error_code = "M11_STRATEGY_003"

æ¸¬è©¦: æ¢ä»¶æ ¼å¼éŒ¯èª¤
When: POST /api/v1/strategy
       Body: {"conditions": "invalid json"}
Then:
  - HTTP 400
  - error_code = "M11_PARAM_001"
  - åŒ…å«é©—è­‰éŒ¯èª¤è©³æƒ…

æ¸¬è©¦: è‚¡ç¥¨ä»£ç¢¼ä¸å­˜åœ¨
When: POST /api/v1/strategy/STG_001/execute
       Body: {"stock_universe": {"type": "LIST", "stock_ids": ["9999"]}}
Then:
  - HTTP 200ï¼ˆéƒ¨åˆ†æˆåŠŸï¼‰
  - diagnostics.failedStocks = 1
```

---

## 5. æ•ˆèƒ½æ¸¬è©¦

**æ¸¬è©¦å·¥å…·**: JMeter æˆ– Gatling

```
æ¸¬è©¦: ç­–ç•¥æŸ¥è©¢æ•ˆèƒ½
Given: 100 å€‹ä½µç™¼ä½¿ç”¨è€…
When: æ¯ç§’æŸ¥è©¢ /api/v1/strategy/STG_001
Then:
  - P95 å›æ‡‰æ™‚é–“ < 50ms
  - å¿«å–å‘½ä¸­ç‡ > 90%

æ¸¬è©¦: ä¿¡è™ŸæŸ¥è©¢æ•ˆèƒ½ï¼ˆå¿«å–å‘½ä¸­ï¼‰
Given: 100 å€‹ä½µç™¼ä½¿ç”¨è€…
When: æ¯ç§’æŸ¥è©¢ /api/v1/strategy/signals/stock/2330
Then:
  - P95 å›æ‡‰æ™‚é–“ < 100ms

æ¸¬è©¦: å–®ç­–ç•¥å³æ™‚åŸ·è¡Œæ•ˆèƒ½
Given: ç­–ç•¥æ¶‰åŠ 5 å€‹å› å­ï¼Œ3 å±¤æ¢ä»¶
When: åŸ·è¡Œ 100 æª”è‚¡ç¥¨
Then:
  - åŸ·è¡Œæ™‚é–“ < 5 ç§’
  - å› å­è¼‰å…¥ä¸¦è¡Œç”Ÿæ•ˆ

æ¸¬è©¦: æ¯æ—¥æ‰¹æ¬¡åŸ·è¡Œæ•ˆèƒ½
Given: 10 å€‹æ´»èºç­–ç•¥ï¼Œ1800 æª”è‚¡ç¥¨
When: åŸ·è¡Œ EXEC_ALL_STRATEGIES Job
Then:
  - åŸ·è¡Œæ™‚é–“ < 10 åˆ†é˜
  - æˆåŠŸç‡ > 95%
  - ç„¡è¨˜æ†¶é«”æº¢å‡º

æ¸¬è©¦: æ¢ä»¶æ¨¹è©•ä¼°æ•ˆèƒ½
Given: 10 å±¤å·¢ç‹€æ¢ä»¶æ¨¹
When: è©•ä¼° 1000 æª”è‚¡ç¥¨
Then:
  - å¹³å‡å–®è‚¡è©•ä¼°æ™‚é–“ < 5ms
  - çŸ­è·¯è©•ä¼°ç”Ÿæ•ˆ
```

---

## 6. è¨ˆç®—æ­£ç¢ºæ€§æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™**: é©—è­‰ç­–ç•¥è©•ä¼°çµæœçš„æ­£ç¢ºæ€§

```
æ¸¬è©¦: RSI å‹•èƒ½ç­–ç•¥
Given:
  - ç­–ç•¥æ¢ä»¶: RSI_14 >= 70 AND RSI_14 <= 80
  - è‚¡ç¥¨ A: RSI_14 = 75 (ç¬¦åˆ)
  - è‚¡ç¥¨ B: RSI_14 = 85 (ä¸ç¬¦åˆ)
  - è‚¡ç¥¨ C: RSI_14 = 65 (ä¸ç¬¦åˆ)
When: åŸ·è¡Œç­–ç•¥
Then:
  - åªæœ‰è‚¡ç¥¨ A ç”¢ç”Ÿ BUY ä¿¡è™Ÿ

æ¸¬è©¦: å¤šå› å­çµ„åˆç­–ç•¥
Given:
  - ç­–ç•¥æ¢ä»¶:
    (RSI_14 > 50 OR MACD_HISTOGRAM > 0)
    AND
    PE_RATIO < 15
    AND
    FOREIGN_NET > 0
  - è‚¡ç¥¨è³‡æ–™æº–å‚™
When: åŸ·è¡Œç­–ç•¥
Then:
  - ä¿¡è™Ÿèˆ‡æ‰‹å‹•è¨ˆç®—çµæœä¸€è‡´
  - æ¢ä»¶è©•ä¼°é †åºæ­£ç¢º

æ¸¬è©¦: ä¿¡å¿ƒåˆ†æ•¸è¨ˆç®—
Given:
  - factor_weights = {"RSI_14": 0.4, "VOLUME_RATIO": 0.3, "FOREIGN_NET": 0.3}
  - factor_values = {"RSI_14": 75, "VOLUME_RATIO": 2.0, "FOREIGN_NET": 5000000}
  - åˆ†æ•¸æ­£è¦åŒ–è¦å‰‡å·²å®šç¾©
When: è¨ˆç®— confidenceScore
Then:
  - åˆ†æ•¸ = 0.4 Ã— normalize(RSI) + 0.3 Ã— normalize(VOL) + 0.3 Ã— normalize(FN)
  - çµæœèˆ‡é æœŸä¸€è‡´ï¼ˆå…è¨± 0.01 èª¤å·®ï¼‰

æ¸¬è©¦: é‚Šç•Œæ¢ä»¶
Given:
  - æ¢ä»¶: RSI_14 >= 70
  - è‚¡ç¥¨ RSI_14 = 70.00
When: è©•ä¼°æ¢ä»¶
Then:
  - è¿”å› trueï¼ˆé‚Šç•Œå€¼åŒ…å«ï¼‰

æ¸¬è©¦: NULL å€¼è™•ç†
Given:
  - æ¢ä»¶: PE_RATIO < 15
  - è‚¡ç¥¨ PE_RATIO = NULLï¼ˆè™§æå…¬å¸ï¼‰
When: è©•ä¼°æ¢ä»¶
Then:
  - è¿”å› falseï¼ˆNULL ä¸æ»¿è¶³ä»»ä½•æ•¸å€¼æ¢ä»¶ï¼‰
  - diagnostics è¨˜éŒ„ "NULL_FACTOR_VALUE"
```

---

## 7. æ¸¬è©¦è¦†è“‹ç‡ç›®æ¨™

| å±¤ç´š | è¦†è“‹ç‡ç›®æ¨™ | èªªæ˜ |
|-----|----------|------|
| ConditionEvaluator | > 95% | æ¢ä»¶è©•ä¼°é‚è¼¯å¿…é ˆå®Œæ•´æ¸¬è©¦ |
| ConfidenceCalculator | > 95% | ä¿¡å¿ƒåˆ†æ•¸è¨ˆç®—å¿…é ˆç²¾ç¢º |
| StrategyEngine | > 90% | åŸ·è¡Œå¼•æ“å”èª¿é‚è¼¯å¿…é ˆæ¸¬è©¦ |
| FactorDataLoader | > 85% | å› å­è¼‰å…¥èˆ‡æ•´åˆå¿…é ˆæ¸¬è©¦ |
| Service å±¤ | > 80% | æ ¸å¿ƒæ¥­å‹™é‚è¼¯å¿…é ˆæ¸¬è©¦ |
| Controller å±¤ | > 70% | ä¸»è¦ API ç«¯é»å¿…é ˆæ¸¬è©¦ |
| æ•´é«” | > 80% | æ•´é«”ç¨‹å¼ç¢¼è¦†è“‹ç‡ |

**æ¸¬è©¦å„ªå…ˆç´š**:
1. P0 åŠŸèƒ½ï¼š100% æ¸¬è©¦è¦†è“‹ï¼ˆæ¢ä»¶è©•ä¼°ã€ç­–ç•¥åŸ·è¡Œã€ä¿¡è™Ÿç”¢ç”Ÿï¼‰
2. P1 åŠŸèƒ½ï¼š> 80% æ¸¬è©¦è¦†è“‹ï¼ˆå› å­è¼‰å…¥ã€å¿«å–ç®¡ç†ï¼‰
3. P2 åŠŸèƒ½ï¼š> 60% æ¸¬è©¦è¦†è“‹ï¼ˆçµ±è¨ˆæ›´æ–°ã€è³‡æ–™æ¸…ç†ï¼‰

---

## 8. æ¸¬è©¦è³‡æ–™æº–å‚™

### 8.1 æ¸¬è©¦è³‡æ–™é›†

```java
@TestConfiguration
public class StrategyTestDataConfig {

    // æ¨™æº–æ¸¬è©¦ç­–ç•¥
    public static Strategy createTestStrategy() {
        return Strategy.builder()
            .strategyId("STG_TEST_001")
            .strategyName("æ¸¬è©¦å‹•èƒ½ç­–ç•¥")
            .strategyType(StrategyType.MOMENTUM)
            .status(StrategyStatus.ACTIVE)
            .conditions(createTestConditions())
            .factorWeights(Map.of(
                "RSI_14", new BigDecimal("0.4"),
                "MACD_HISTOGRAM", new BigDecimal("0.3"),
                "VOLUME_RATIO", new BigDecimal("0.3")
            ))
            .build();
    }

    // æ¸¬è©¦æ¢ä»¶æ¨¹
    private static JsonNode createTestConditions() {
        return JsonNodeFactory.instance.objectNode()
            .put("operator", "AND")
            .set("conditions", JsonNodeFactory.instance.arrayNode()
                .add(createCondition("RSI_14", ">=", 70))
                .add(createCondition("MACD_HISTOGRAM", ">", 0))
            );
    }

    // æ¨¡æ“¬å› å­è³‡æ–™
    public static Map<String, BigDecimal> createTestFactorValues(boolean shouldMatch) {
        if (shouldMatch) {
            return Map.of(
                "RSI_14", new BigDecimal("75.5"),
                "MACD_HISTOGRAM", new BigDecimal("0.25"),
                "VOLUME_RATIO", new BigDecimal("1.8")
            );
        } else {
            return Map.of(
                "RSI_14", new BigDecimal("45.0"),
                "MACD_HISTOGRAM", new BigDecimal("-0.15"),
                "VOLUME_RATIO", new BigDecimal("0.7")
            );
        }
    }

    // é‚Šç•Œæ¢ä»¶æ¸¬è©¦è³‡æ–™
    public static List<Map<String, BigDecimal>> createEdgeCaseFactors() {
        return List.of(
            Map.of("RSI_14", new BigDecimal("70.00")),  // å‰›å¥½é‚Šç•Œ
            Map.of("RSI_14", new BigDecimal("69.99")),  // å‰›å¥½ä¸ç¬¦åˆ
            Map.of(),                                    // ç©ºå› å­
            null                                         // null å› å­
        );
    }
}
```

### 8.2 æ¸¬è©¦ç­–ç•¥åº«

| ç­–ç•¥åç¨± | æ¸¬è©¦ç›®çš„ | æ¢ä»¶è¤‡é›œåº¦ |
|---------|---------|-----------|
| SimpleRSIStrategy | åŸºæœ¬æ¢ä»¶æ¸¬è©¦ | å–®ä¸€æ¢ä»¶ |
| DualIndicatorStrategy | AND æ¢ä»¶æ¸¬è©¦ | 2 æ¢ä»¶ AND |
| MultiOrStrategy | OR æ¢ä»¶æ¸¬è©¦ | 3 æ¢ä»¶ OR |
| NestedConditionStrategy | å·¢ç‹€æ¢ä»¶æ¸¬è©¦ | 3 å±¤å·¢ç‹€ |
| CrossModuleStrategy | è·¨æ¨¡çµ„æ•´åˆæ¸¬è©¦ | M07+M08+M09 |
| HighComplexityStrategy | æ•ˆèƒ½å£“åŠ›æ¸¬è©¦ | 10 å±¤å·¢ç‹€ |

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [M11 åŠŸèƒ½éœ€æ±‚](../specs/functional/M11-é‡åŒ–ç­–ç•¥åŠŸèƒ½éœ€æ±‚.md)
- [M11 APIè¦æ ¼](../specs/api/M11-APIè¦æ ¼.md)
- [M11 è³‡æ–™åº«è¨­è¨ˆ](./M11-è³‡æ–™åº«è¨­è¨ˆ.md)
- [é–‹ç™¼æº–å‰‡](../specs/technical/00-é–‹ç™¼æº–å‰‡.md)

---

**æ–‡ä»¶ç¶­è­·è€…**: æ¸¬è©¦å·¥ç¨‹å¸«
**æœ€å¾Œæ›´æ–°**: 2026-01-14
**ä¸‹æ¬¡å¯©æ ¸**: 2026-04-14
