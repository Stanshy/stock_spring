# M14-選股引擎 業務流程

> **文件編號**: FLOW-M14
> **模組名稱**: 選股引擎 (Stock Screening Engine)
> **版本**: v1.0
> **最後更新**: 2026-01-15
> **狀態**: Draft

---

## 1. 流程總覽

### 1.1 核心業務流程

| # | 流程名稱 | 觸發方式 | 說明 |
|---|---------|---------|------|
| 1 | 快速選股 | API 呼叫 | 使用預設模板快速篩選 |
| 2 | 自訂選股 | API 呼叫 | 用戶自訂條件即時篩選 |
| 3 | 策略選股 | API 呼叫 | 執行已儲存的策略 |
| 4 | 信號選股 | API 呼叫 | 依據 M13 信號篩選 |
| 5 | 績效追蹤 | 排程 | 自動追蹤選股績效 |
| 6 | 歷史清理 | 排程 | 清理過期執行記錄 |

### 1.2 流程優先級

```
┌────────────────────────────────────────────────────────────────┐
│                      M14 業務流程優先級                         │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│   高優先級（即時回應）                                           │
│   ┌─────────────────────────────────────────────────────┐      │
│   │  • 快速選股（< 500ms）                               │      │
│   │  • 自訂選股（< 2s）                                  │      │
│   │  • 策略執行（< 2s）                                  │      │
│   │  • 信號選股（< 1s）                                  │      │
│   └─────────────────────────────────────────────────────┘      │
│                                                                 │
│   中優先級（非同步處理）                                         │
│   ┌─────────────────────────────────────────────────────┐      │
│   │  • 策略儲存                                          │      │
│   │  • 執行記錄保存                                      │      │
│   │  • 結果匯出                                          │      │
│   └─────────────────────────────────────────────────────┘      │
│                                                                 │
│   背景處理（排程任務）                                           │
│   ┌─────────────────────────────────────────────────────┐      │
│   │  • 績效追蹤更新                                      │      │
│   │  • 歷史資料清理                                      │      │
│   │  • 熱門策略統計                                      │      │
│   └─────────────────────────────────────────────────────┘      │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

## 2. 快速選股流程

### 2.1 流程圖

```
┌─────────────────────────────────────────────────────────────────────┐
│                          快速選股流程                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────┐    ┌──────────────┐    ┌──────────────┐              │
│  │  Client  │───►│ API Gateway  │───►│ Controller   │              │
│  │  Request │    │              │    │              │              │
│  └──────────┘    └──────────────┘    └──────┬───────┘              │
│                                             │                        │
│                          ┌──────────────────┴──────────────────┐    │
│                          ▼                                      │    │
│                   ┌─────────────┐                               │    │
│                   │   Service   │                               │    │
│                   │ QuickScreen │                               │    │
│                   └──────┬──────┘                               │    │
│                          │                                      │    │
│         ┌────────────────┼────────────────┐                     │    │
│         ▼                ▼                ▼                     │    │
│  ┌────────────┐   ┌────────────┐   ┌────────────┐              │    │
│  │  Validate  │   │   Load     │   │   Build    │              │    │
│  │  Request   │   │  Template  │   │   Query    │              │    │
│  └────────────┘   └────────────┘   └────────────┘              │    │
│         │                │                │                     │    │
│         └────────────────┼────────────────┘                     │    │
│                          ▼                                      │    │
│                   ┌─────────────┐                               │    │
│                   │  Execute    │                               │    │
│                   │  Screening  │                               │    │
│                   └──────┬──────┘                               │    │
│                          │                                      │    │
│         ┌────────────────┼────────────────┐                     │    │
│         ▼                ▼                ▼                     │    │
│  ┌────────────┐   ┌────────────┐   ┌────────────┐              │    │
│  │   M06      │   │   M07/M08  │   │   M09/M13  │              │    │
│  │  Stocks    │   │ Indicators │   │ Chip/Signal│              │    │
│  └────────────┘   └────────────┘   └────────────┘              │    │
│         │                │                │                     │    │
│         └────────────────┼────────────────┘                     │    │
│                          ▼                                      │    │
│                   ┌─────────────┐                               │    │
│                   │   Apply     │                               │    │
│                   │  Sorting    │                               │    │
│                   └──────┬──────┘                               │    │
│                          │                                      │    │
│                          ▼                                      │    │
│                   ┌─────────────┐                               │    │
│                   │   Save      │ ◄── 非同步                    │    │
│                   │  Execution  │                               │    │
│                   └──────┬──────┘                               │    │
│                          │                                      │    │
│                          ▼                                      │    │
│                   ┌─────────────┐                               │    │
│                   │  Return     │                               │    │
│                   │  Results    │                               │    │
│                   └─────────────┘                               │    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 步驟說明

| 步驟 | 動作 | 說明 | 耗時目標 |
|------|------|------|---------|
| 1 | 驗證請求 | 檢查模板代碼是否有效 | < 5ms |
| 2 | 載入模板 | 從快取/DB 取得模板條件 | < 10ms |
| 3 | 建構查詢 | 根據條件建構動態 SQL | < 20ms |
| 4 | 執行篩選 | 多維度 JOIN 查詢 | < 400ms |
| 5 | 排序結果 | 依指定欄位排序 | < 30ms |
| 6 | 儲存記錄 | 非同步保存執行記錄 | 背景 |
| 7 | 回傳結果 | 返回篩選結果 | < 10ms |

---

## 3. 自訂選股流程

### 3.1 流程圖

```
┌─────────────────────────────────────────────────────────────────────┐
│                          自訂選股流程                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                      請求處理階段                              │   │
│  │  ┌──────────┐    ┌──────────────┐    ┌──────────────┐        │   │
│  │  │  Client  │───►│   Validate   │───►│    Parse     │        │   │
│  │  │ Conditions│    │  Conditions  │    │  Condition   │        │   │
│  │  └──────────┘    └──────────────┘    └──────────────┘        │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                │                                     │
│                                ▼                                     │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                      條件解析階段                              │   │
│  │                                                               │   │
│  │  ┌────────────────────────────────────────────────────┐      │   │
│  │  │              Condition Combiner                     │      │   │
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐            │      │   │
│  │  │  │ AND/OR  │  │  Nested │  │ Flatten │            │      │   │
│  │  │  │  Logic  │  │  Groups │  │ Validate│            │      │   │
│  │  │  └─────────┘  └─────────┘  └─────────┘            │      │   │
│  │  └────────────────────────────────────────────────────┘      │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                │                                     │
│                                ▼                                     │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                      查詢建構階段                              │   │
│  │                                                               │   │
│  │  ┌────────────────────────────────────────────────────┐      │   │
│  │  │              Query Builder                          │      │   │
│  │  │                                                     │      │   │
│  │  │  ┌───────────────────────────────────────────┐     │      │   │
│  │  │  │ 分析條件 → 決定需要 JOIN 的表              │     │      │   │
│  │  │  └───────────────────────────────────────────┘     │      │   │
│  │  │            │                                        │      │   │
│  │  │            ▼                                        │      │   │
│  │  │  ┌─────────────────────────────────────────────┐   │      │   │
│  │  │  │ 基本面條件 → JOIN fundamental_indicators    │   │      │   │
│  │  │  │ 技術面條件 → JOIN technical_indicators     │   │      │   │
│  │  │  │ 籌碼條件   → JOIN chip_indicators          │   │      │   │
│  │  │  │ 信號條件   → JOIN unified_signals          │   │      │   │
│  │  │  └─────────────────────────────────────────────┘   │      │   │
│  │  │            │                                        │      │   │
│  │  │            ▼                                        │      │   │
│  │  │  ┌───────────────────────────────────────────┐     │      │   │
│  │  │  │ 建構 WHERE 子句（AND/OR 組合）            │     │      │   │
│  │  │  └───────────────────────────────────────────┘     │      │   │
│  │  └────────────────────────────────────────────────────┘      │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                │                                     │
│                                ▼                                     │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                      執行與結果階段                            │   │
│  │                                                               │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │   │
│  │  │  Execute    │───►│  Enrich     │───►│  Return     │       │   │
│  │  │   Query     │    │  Results    │    │  Response   │       │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘       │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 條件組合邏輯

```
┌─────────────────────────────────────────────────────────────────────┐
│                        條件組合邏輯範例                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  使用者輸入:                                                         │
│  "PE < 15 且 (外資連買 >= 3日 或 投信連買 >= 3日)"                   │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │                      ROOT (AND)                             │     │
│  │  ┌────────────────┐    ┌────────────────────────────────┐  │     │
│  │  │ PE < 15        │ +  │          GROUP (OR)            │  │     │
│  │  │ (基本面條件)    │    │  ┌──────────┐  ┌──────────┐   │  │     │
│  │  └────────────────┘    │  │外資連買≥3│ OR│投信連買≥3│   │  │     │
│  │                        │  │(籌碼條件) │  │(籌碼條件) │   │  │     │
│  │                        │  └──────────┘  └──────────┘   │  │     │
│  │                        └────────────────────────────────┘  │     │
│  └────────────────────────────────────────────────────────────┘     │
│                                                                      │
│  轉換為 SQL:                                                         │
│  WHERE fi.pe_ratio < 15                                              │
│    AND (ci.foreign_cont_days >= 3 OR ci.trust_cont_days >= 3)       │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. 策略管理流程

### 4.1 策略建立流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                          策略建立流程                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────┐                                                   │
│  │   User       │                                                   │
│  │ Create/Edit  │                                                   │
│  │   Strategy   │                                                   │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │   Validate   │ ◄── 條件數量 ≤ 20                                 │
│  │  Conditions  │ ◄── 巢狀層數 ≤ 3                                  │
│  │              │ ◄── 條件代碼有效                                   │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │   Generate   │                                                   │
│  │   Summary    │ ◄── "PE < 15, ROE > 15%, 外資連買"                │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │    Save      │                                                   │
│  │   Strategy   │ ◄── 儲存至 screening_strategies                   │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │   Return     │                                                   │
│  │ Strategy ID  │                                                   │
│  └──────────────┘                                                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 策略執行流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                          策略執行流程                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────┐                                                   │
│  │  Execute     │                                                   │
│  │  Strategy    │                                                   │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │    Load      │                                                   │
│  │   Strategy   │ ◄── 驗證擁有權 / 公開性                           │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │   Execute    │                                                   │
│  │  Screening   │ ◄── 同自訂選股流程                                │
│  └──────┬───────┘                                                   │
│         │                                                            │
│     ┌───┴───────────────────────────────────────┐                   │
│     │                                           │                   │
│     ▼                                           ▼                   │
│  ┌──────────────┐                        ┌──────────────┐          │
│  │ Save Exec    │                        │   Update     │          │
│  │   Record     │ ◄── 執行記錄           │  Strategy    │          │
│  │ + Results    │     + 結果明細         │   Stats      │          │
│  └──────────────┘                        └──────────────┘          │
│                                          ◄── execution_count++     │
│                                          ◄── last_executed_at      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 5. 績效追蹤流程

### 5.1 排程追蹤流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        績效追蹤排程流程                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────┐    每日 18:00 觸發                                │
│  │   Quartz     │───────────────────┐                               │
│  │  Scheduler   │                   │                               │
│  └──────────────┘                   │                               │
│                                     ▼                               │
│                              ┌──────────────┐                       │
│                              │   Query      │                       │
│                              │  Pending     │ ◄── tracking_days < 20│
│                              │ Performance  │                       │
│                              └──────┬───────┘                       │
│                                     │                               │
│                                     ▼                               │
│                              ┌──────────────┐                       │
│                              │  Batch       │                       │
│                              │  Process     │ ◄── 每批 1000 筆      │
│                              └──────┬───────┘                       │
│                                     │                               │
│         ┌───────────────────────────┼───────────────────────────┐   │
│         │                           │                           │   │
│         ▼                           ▼                           ▼   │
│  ┌────────────┐            ┌────────────┐            ┌────────────┐│
│  │ Get Today  │            │  Calculate │            │   Update   ││
│  │   Price    │───────────►│   Return   │───────────►│Performance ││
│  │  (M06)     │            │ 1d/5d/10d  │            │   Record   ││
│  └────────────┘            │    /20d    │            └────────────┘│
│                            └────────────┘                          │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                       追蹤天數邏輯                             │   │
│  │                                                               │   │
│  │  執行日 (D+0)  ───► 建立績效記錄 (price_at_execution)         │   │
│  │  D+1          ───► 更新 price_1d, return_1d                   │   │
│  │  D+5          ───► 更新 price_5d, return_5d                   │   │
│  │  D+10         ───► 更新 price_10d, return_10d                 │   │
│  │  D+20         ───► 更新 price_20d, return_20d, 完成追蹤       │   │
│  │                                                               │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 績效計算邏輯

```
┌─────────────────────────────────────────────────────────────────────┐
│                          績效計算邏輯                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  報酬率計算:                                                         │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                                                               │   │
│  │  return_Nd = (price_Nd - price_at_execution)                  │   │
│  │              ────────────────────────────────  × 100%         │   │
│  │                    price_at_execution                         │   │
│  │                                                               │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  策略績效統計:                                                       │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                                                               │   │
│  │  avg_return_5d  = AVG(return_5d)  ◄── 平均 5 日報酬           │   │
│  │  win_rate_5d    = COUNT(return_5d > 0) / COUNT(*)             │   │
│  │                   ◄── 5 日勝率                                │   │
│  │  max_return_5d  = MAX(return_5d)  ◄── 最大報酬                │   │
│  │  min_return_5d  = MIN(return_5d)  ◄── 最大虧損                │   │
│  │                                                               │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 6. 信號選股流程

### 6.1 流程圖

```
┌─────────────────────────────────────────────────────────────────────┐
│                          信號選股流程                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────┐                                                   │
│  │   Client     │                                                   │
│  │   Request    │                                                   │
│  │  (direction, │                                                   │
│  │   minGrade)  │                                                   │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │    Query     │                                                   │
│  │   M13        │ ◄── unified_signals 表                            │
│  │   Signals    │                                                   │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │    Filter    │                                                   │
│  │   by Grade   │ ◄── S_GRADE >= minGrade                          │
│  │   Direction  │ ◄── S_DIRECTION = direction                      │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │    Enrich    │                                                   │
│  │   Stock      │ ◄── JOIN stocks, stock_daily                     │
│  │   Info       │                                                   │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │    Sort by   │                                                   │
│  │   Score      │ ◄── ORDER BY unified_score DESC                  │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │   Return     │                                                   │
│  │   Results    │                                                   │
│  └──────────────┘                                                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 7. 資料清理流程

### 7.1 歷史清理排程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        歷史資料清理流程                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────┐    每日 02:00 觸發                                │
│  │   Quartz     │───────────────────┐                               │
│  │  Scheduler   │                   │                               │
│  └──────────────┘                   │                               │
│                                     ▼                               │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                     清理策略                                   │   │
│  │                                                               │   │
│  │  1. screening_results (保留 90 天)                            │   │
│  │     DELETE WHERE created_at < NOW() - INTERVAL '90 days'     │   │
│  │                                                               │   │
│  │  2. screening_performance (保留 90 天)                        │   │
│  │     DELETE WHERE created_at < NOW() - INTERVAL '90 days'     │   │
│  │                                                               │   │
│  │  3. screening_executions (保留 1 年)                          │   │
│  │     - 先歸檔至 screening_executions_archive                  │   │
│  │     - 再刪除原表記錄                                          │   │
│  │                                                               │   │
│  │  4. screening_strategies (永久保留)                           │   │
│  │     - 只做邏輯刪除 (status = 'DELETED')                      │   │
│  │     - 實體刪除需管理員手動執行                                │   │
│  │                                                               │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 8. 異常處理流程

### 8.1 篩選執行異常

```
┌─────────────────────────────────────────────────────────────────────┐
│                        篩選異常處理流程                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────┐                                                   │
│  │   Execute    │                                                   │
│  │  Screening   │                                                   │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │  Exception   │                                                   │
│  │  Handler     │                                                   │
│  └──────┬───────┘                                                   │
│         │                                                            │
│    ┌────┴────────────────────────────┐                              │
│    │                                 │                              │
│    ▼                                 ▼                              │
│  ┌──────────────┐            ┌──────────────┐                       │
│  │  Timeout     │            │  Data Error  │                       │
│  │  Exception   │            │  Exception   │                       │
│  └──────┬───────┘            └──────┬───────┘                       │
│         │                           │                               │
│         ▼                           ▼                               │
│  ┌──────────────┐            ┌──────────────┐                       │
│  │  Reduce      │            │   Log Error  │                       │
│  │  Complexity  │            │   & Retry    │                       │
│  │  & Retry     │            └──────────────┘                       │
│  └──────────────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │  Return      │                                                   │
│  │  Partial     │ ◄── 部分結果 + 警告訊息                           │
│  │  Results     │                                                   │
│  └──────────────┘                                                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 8.2 異常類型與處理

| 異常類型 | 原因 | 處理方式 |
|---------|------|---------|
| InvalidConditionException | 條件代碼不存在 | 返回 400，提示正確條件 |
| TooManyConditionsException | 條件數 > 20 | 返回 400，提示簡化條件 |
| NestingTooDeepException | 巢狀層數 > 3 | 返回 400，提示減少巢狀 |
| QueryTimeoutException | 查詢超時 | 簡化查詢後重試 |
| DataNotReadyException | 資料尚未同步 | 返回 503，提示稍後重試 |
| StrategyNotFoundException | 策略不存在 | 返回 404 |
| UnauthorizedException | 無存取權限 | 返回 403 |

---

## 9. 流程監控指標

| 指標名稱 | 說明 | 告警閾值 |
|---------|------|---------|
| screening_execution_count | 每小時執行次數 | > 10000 |
| screening_avg_latency_ms | 平均執行耗時 | > 2000ms |
| screening_error_rate | 執行錯誤率 | > 5% |
| performance_tracking_lag | 績效追蹤延遲天數 | > 1 天 |
| strategy_count_per_user | 單用戶策略數 | > 100 |

---

## 10. 相關文檔

- [M14 功能需求](../specs/functional/M14-選股引擎功能需求.md)
- [M14 API 規格](../specs/api/M14-API規格.md)
- [M14 資料庫設計](./M14-資料庫設計.md)
- [M14 Job 排程配置](../deployment/M14-Job排程配置.md)

---

**文件維護者**: 後端工程師
**最後更新**: 2026-01-15
**下次審核**: 2026-04-15
