# M07-æŠ€è¡“åˆ†ææ¨¡çµ„è³‡æ–™åº«è¨­è¨ˆ

> **æ–‡ä»¶ç·¨è™Ÿ**: DB-M07  
> **æ¨¡çµ„åç¨±**: æŠ€è¡“åˆ†ææ¨¡çµ„  
> **ç‰ˆæœ¬**: v2.0  
> **æœ€å¾Œæ›´æ–°**: 2025-12-31  
> **ç‹€æ…‹**: Draft

---

## ğŸ“‹ è³‡æ–™åº«è¨­è¨ˆç¸½è¦½

æœ¬æ–‡ä»¶å®šç¾© æŠ€è¡“åˆ†ææ¨¡çµ„çš„æ‰€æœ‰è³‡æ–™è¡¨çµæ§‹ã€‚

---

## 3. è³‡æ–™è¨­è¨ˆ

### 3.1 è³‡æ–™è¡¨æ¸…å–®

| è¡¨å | èªªæ˜ | æŒä¹…å±¤ | ç‰¹æ®ŠåŠŸèƒ½ |
|-----|------|-------|---------|
| technical_indicators | æŠ€è¡“æŒ‡æ¨™ä¸»è¡¨ | JPA + MyBatis | JSONBã€åˆ†å€ã€GIN ç´¢å¼• |
| indicator_definitions | æŒ‡æ¨™å®šç¾©èˆ‡åƒæ•¸è¡¨ | JPA | JSONB |
| indicator_calculation_jobs | æŒ‡æ¨™è¨ˆç®— Job è¨˜éŒ„è¡¨ | JPA | - |

### 3.2 è³‡æ–™è¡¨è¨­è¨ˆ

#### 3.2.1 technical_indicators (æŠ€è¡“æŒ‡æ¨™ä¸»è¡¨)

```sql
-- PostgreSQL å»ºè¡¨èªæ³•ï¼ˆä½¿ç”¨åˆ†å€ï¼‰
CREATE TABLE technical_indicators (
    indicator_id        BIGSERIAL,
    stock_id            VARCHAR(10) NOT NULL,
    calculation_date    DATE NOT NULL,
    
    -- è¶¨å‹¢æŒ‡æ¨™ï¼ˆä½¿ç”¨ JSONB å„²å­˜ï¼‰
    trend_indicators    JSONB DEFAULT '{}',
    
    -- å‹•èƒ½æŒ‡æ¨™
    momentum_indicators JSONB DEFAULT '{}',
    
    -- æ³¢å‹•æ€§æŒ‡æ¨™
    volatility_indicators JSONB DEFAULT '{}',
    
    -- æˆäº¤é‡æŒ‡æ¨™
    volume_indicators   JSONB DEFAULT '{}',
    
    -- æ”¯æ’å£“åŠ›æŒ‡æ¨™
    support_resistance  JSONB DEFAULT '{}',
    
    -- é€±æœŸæŒ‡æ¨™
    cycle_indicators    JSONB DEFAULT '{}',
    
    -- çµ±è¨ˆæŒ‡æ¨™
    statistical_indicators JSONB DEFAULT '{}',
    
    -- ç¶œåˆæŒ‡æ¨™
    composite_indicators JSONB DEFAULT '{}',
    
    -- å¿«é€ŸæŸ¥è©¢æ¬„ä½ï¼ˆå†—é¤˜ï¼Œç”¨æ–¼å¸¸ç”¨æŒ‡æ¨™ï¼‰
    ma5                 NUMERIC(10,2),
    ma20                NUMERIC(10,2),
    ma60                NUMERIC(10,2),
    ema12               NUMERIC(10,2),
    ema26               NUMERIC(10,2),
    macd_value          NUMERIC(10,4),
    macd_signal         NUMERIC(10,4),
    macd_histogram      NUMERIC(10,4),
    rsi_14              NUMERIC(5,2),
    stoch_k             NUMERIC(5,2),
    stoch_d             NUMERIC(5,2),
    bbands_upper        NUMERIC(10,2),
    bbands_middle       NUMERIC(10,2),
    bbands_lower        NUMERIC(10,2),
    atr_14              NUMERIC(10,4),
    obv                 BIGINT,
    adx_14              NUMERIC(5,2),
    
    -- è¨ˆç®—è³‡è¨Š
    calculation_version VARCHAR(10),
    calculation_engine  VARCHAR(50) DEFAULT 'pandas-ta',
    
    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (indicator_id, calculation_date),
    UNIQUE (stock_id, calculation_date),
    
    FOREIGN KEY (stock_id) REFERENCES stocks(stock_id) ON DELETE CASCADE
) PARTITION BY RANGE (calculation_date);

-- å»ºç«‹åˆ†å€ï¼ˆæŒ‰å¹´ä»½ï¼‰
CREATE TABLE technical_indicators_2023 PARTITION OF technical_indicators
    FOR VALUES FROM ('2023-01-01') TO ('2024-01-01');
    
CREATE TABLE technical_indicators_2024 PARTITION OF technical_indicators
    FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
    
CREATE TABLE technical_indicators_2025 PARTITION OF technical_indicators
    FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');

CREATE TABLE technical_indicators_2026 PARTITION OF technical_indicators
    FOR VALUES FROM ('2026-01-01') TO ('2027-01-01');    
    
CREATE TABLE technical_indicators_future PARTITION OF technical_indicators
    FOR VALUES FROM ('2027-01-01') TO (MAXVALUE);

-- ç´¢å¼•
CREATE INDEX idx_technical_indicators_stock_id ON technical_indicators(stock_id);
CREATE INDEX idx_technical_indicators_date ON technical_indicators(calculation_date);

-- GIN ç´¢å¼•ï¼ˆåŠ é€Ÿ JSONB æŸ¥è©¢ï¼‰
CREATE INDEX idx_technical_indicators_trend ON technical_indicators USING GIN(trend_indicators);
CREATE INDEX idx_technical_indicators_momentum ON technical_indicators USING GIN(momentum_indicators);
CREATE INDEX idx_technical_indicators_volatility ON technical_indicators USING GIN(volatility_indicators);
CREATE INDEX idx_technical_indicators_volume ON technical_indicators USING GIN(volume_indicators);

-- è‡ªå‹•æ›´æ–° updated_at è§¸ç™¼å™¨
CREATE TRIGGER update_technical_indicators_updated_at
    BEFORE UPDATE ON technical_indicators
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE technical_indicators IS 'æŠ€è¡“æŒ‡æ¨™ä¸»è¡¨ï¼ˆä½¿ç”¨åˆ†å€å’Œ JSONB å„ªåŒ–ï¼‰';
COMMENT ON COLUMN technical_indicators.trend_indicators IS 'è¶¨å‹¢æŒ‡æ¨™ JSONBï¼ˆMAã€EMAã€MACDã€ADXç­‰ï¼‰';
COMMENT ON COLUMN technical_indicators.ma5 IS '5æ—¥å‡ç·šï¼ˆå†—é¤˜æ¬„ä½ï¼Œç”¨æ–¼å¿«é€ŸæŸ¥è©¢ï¼‰';
```

**è¨­è¨ˆèªªæ˜**:
- ä½¿ç”¨ PostgreSQL **åˆ†å€ï¼ˆPartitioningï¼‰** å„ªåŒ–å¤§é‡æ­·å²è³‡æ–™æŸ¥è©¢
- ä½¿ç”¨ **JSONB** å„²å­˜å„é¡åˆ¥æŒ‡æ¨™ï¼Œå½ˆæ€§æ“´å……
- æä¾›å†—é¤˜æ¬„ä½ï¼ˆma5, rsi_14 ç­‰ï¼‰ç”¨æ–¼é«˜é »æŸ¥è©¢ï¼Œé¿å…è§£æ JSON
- GIN ç´¢å¼•åŠ é€Ÿ JSONB æŸ¥è©¢
- åˆ†å€ç­–ç•¥ï¼šæŒ‰å¹´ä»½ RANGE åˆ†å€

**JSONB çµæ§‹ç¯„ä¾‹**:

**trend_indicators**:
```json
{
  "ma": {
    "ma5": 580.50,
    "ma10": 575.20,
    "ma20": 570.80,
    "ma60": 565.00,
    "ma120": 560.00,
    "ma240": 555.00
  },
  "ema": {
    "ema12": 578.30,
    "ema26": 572.40,
    "ema50": 568.00,
    "ema200": 550.00
  },
  "macd": {
    "macd_line": 5.90,
    "signal_line": 4.20,
    "histogram": 1.70
  },
  "adx": {
    "adx": 25.50,
    "plus_di": 28.30,
    "minus_di": 15.20
  },
  "aroon": {
    "aroon_up": 80,
    "aroon_down": 20,
    "aroon_oscillator": 60
  },
  "psar": {
    "psar": 570.00,
    "trend": "up"
  },
  "supertrend": {
    "supertrend": 575.00,
    "direction": 1
  }
}
```

**momentum_indicators**:
```json
{
  "rsi": {
    "rsi_14": 65.50
  },
  "stochastic": {
    "k": 75.20,
    "d": 72.80
  },
  "stochrsi": {
    "stochrsi_k": 80.00,
    "stochrsi_d": 75.00
  },
  "williams_r": {
    "willr_14": -25.50
  },
  "cci": {
    "cci_20": 120.30
  },
  "mfi": {
    "mfi_14": 68.50
  },
  "roc": {
    "roc_12": 5.20
  },
  "momentum": {
    "momentum_10": 15.30
  }
}
```

**volatility_indicators**:
```json
{
  "bbands": {
    "upper": 590.00,
    "middle": 580.00,
    "lower": 570.00,
    "bandwidth": 20.00,
    "percent_b": 0.75
  },
  "keltner": {
    "upper": 588.00,
    "middle": 580.00,
    "lower": 572.00
  },
  "atr": {
    "atr_14": 12.50
  },
  "donchian": {
    "upper": 595.00,
    "middle": 580.00,
    "lower": 565.00
  }
}
```

**volume_indicators**:
```json
{
  "obv": 125000000000,
  "ad_line": 85000000000,
  "cmf": {
    "cmf_20": 0.35
  },
  "mfi": {
    "mfi_14": 68.50
  },
  "vwap": 578.50,
  "volume_ma": {
    "vol_ma5": 35000000,
    "vol_ma20": 32000000
  }
}
```

**JSONB æŸ¥è©¢ç¯„ä¾‹**:
```sql
-- æŸ¥è©¢ RSI > 70 çš„è‚¡ç¥¨ï¼ˆè¶…è²·ï¼‰
SELECT stock_id, calculation_date, 
       (momentum_indicators->'rsi'->>'rsi_14')::numeric as rsi
FROM technical_indicators
WHERE calculation_date = '2024-12-24'
  AND (momentum_indicators->'rsi'->>'rsi_14')::numeric > 70;

-- æŸ¥è©¢ MA5 ä¸Šç©¿ MA20 çš„è‚¡ç¥¨ï¼ˆé»ƒé‡‘äº¤å‰ï¼‰
SELECT t1.stock_id, t1.calculation_date
FROM technical_indicators t1
JOIN technical_indicators t2 ON t1.stock_id = t2.stock_id
WHERE t1.calculation_date = '2024-12-24'
  AND t2.calculation_date = '2024-12-23'
  AND (t1.trend_indicators->'ma'->>'ma5')::numeric > (t1.trend_indicators->'ma'->>'ma20')::numeric
  AND (t2.trend_indicators->'ma'->>'ma5')::numeric < (t2.trend_indicators->'ma'->>'ma20')::numeric;

-- æŸ¥è©¢åŒ…å«ç‰¹å®šæŒ‡æ¨™çš„è¨˜éŒ„
SELECT * FROM technical_indicators 
WHERE trend_indicators ? 'macd'  -- æª¢æŸ¥ JSON éµæ˜¯å¦å­˜åœ¨
  AND calculation_date = '2024-12-24';
```

**UPSERT èªæ³•ï¼ˆMyBatisï¼‰**:
```sql
INSERT INTO technical_indicators (
    stock_id, calculation_date, 
    trend_indicators, momentum_indicators, volatility_indicators, volume_indicators,
    ma5, ma20, ma60, rsi_14, stoch_k, stoch_d, atr_14, obv,
    calculation_version, calculation_engine
) VALUES (
    '2330', '2024-12-24',
    '{"ma": {"ma5": 580.5, "ma20": 570.8}, ...}'::jsonb,
    '{"rsi": {"rsi_14": 65.5}, ...}'::jsonb,
    '{"bbands": {...}}'::jsonb,
    '{"obv": 125000000000, ...}'::jsonb,
    580.5, 570.8, 565.0, 65.5, 75.2, 72.8, 12.5, 125000000000,
    'v2.0', 'pandas-ta'
)
ON CONFLICT (stock_id, calculation_date)
DO UPDATE SET
    trend_indicators = EXCLUDED.trend_indicators,
    momentum_indicators = EXCLUDED.momentum_indicators,
    volatility_indicators = EXCLUDED.volatility_indicators,
    volume_indicators = EXCLUDED.volume_indicators,
    ma5 = EXCLUDED.ma5,
    ma20 = EXCLUDED.ma20,
    rsi_14 = EXCLUDED.rsi_14,
    stoch_k = EXCLUDED.stoch_k,
    stoch_d = EXCLUDED.stoch_d,
    atr_14 = EXCLUDED.atr_14,
    obv = EXCLUDED.obv,
    calculation_version = EXCLUDED.calculation_version,
    updated_at = CURRENT_TIMESTAMP;
```

---

#### 3.2.2 indicator_definitions (æŒ‡æ¨™å®šç¾©èˆ‡åƒæ•¸è¡¨)

```sql
-- PostgreSQL å»ºè¡¨èªæ³•
CREATE TABLE indicator_definitions (
    definition_id       BIGSERIAL PRIMARY KEY,
    indicator_name      VARCHAR(50) NOT NULL UNIQUE,
    indicator_category  VARCHAR(50) NOT NULL CHECK (indicator_category IN (
        'TREND', 'MOMENTUM', 'VOLATILITY', 'VOLUME', 
        'SUPPORT_RESISTANCE', 'CYCLE', 'STATISTICAL', 'COMPOSITE'
    )),
    indicator_name_zh   VARCHAR(100),
    description         TEXT,
    
    -- åƒæ•¸å®šç¾©ï¼ˆJSONBï¼‰
    default_params      JSONB NOT NULL,
    param_ranges        JSONB,
    
    -- è¨ˆç®—è³‡è¨Š
    calculation_formula TEXT,
    pandas_ta_function  VARCHAR(50),
    min_data_points     INTEGER,
    
    -- è¼¸å‡ºè³‡è¨Š
    output_fields       JSONB,
    value_range         JSONB,
    
    -- å„ªå…ˆç´šèˆ‡å•Ÿç”¨ç‹€æ…‹
    priority            VARCHAR(10) CHECK (priority IN ('P0', 'P1', 'P2')),
    is_active           BOOLEAN DEFAULT TRUE,
    is_cached           BOOLEAN DEFAULT FALSE,
    
    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_indicator_definitions_category ON indicator_definitions(indicator_category);
CREATE INDEX idx_indicator_definitions_priority ON indicator_definitions(priority);
CREATE INDEX idx_indicator_definitions_active ON indicator_definitions(is_active);

-- GIN ç´¢å¼•
CREATE INDEX idx_indicator_definitions_params ON indicator_definitions USING GIN(default_params);

-- è‡ªå‹•æ›´æ–° updated_at è§¸ç™¼å™¨
CREATE TRIGGER update_indicator_definitions_updated_at
    BEFORE UPDATE ON indicator_definitions
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE indicator_definitions IS 'æŠ€è¡“æŒ‡æ¨™å®šç¾©èˆ‡åƒæ•¸é…ç½®è¡¨';
COMMENT ON COLUMN indicator_definitions.default_params IS 'é è¨­åƒæ•¸ JSONBï¼ˆå¦‚: {"period": 14}ï¼‰';
COMMENT ON COLUMN indicator_definitions.output_fields IS 'è¼¸å‡ºæ¬„ä½å®šç¾© JSONB';

-- æ’å…¥ç¯„ä¾‹è³‡æ–™
INSERT INTO indicator_definitions (
    indicator_name, indicator_category, indicator_name_zh, description,
    default_params, param_ranges, pandas_ta_function, min_data_points,
    output_fields, value_range, priority, is_active, is_cached
) VALUES
-- è¶¨å‹¢æŒ‡æ¨™
('MA', 'TREND', 'ç°¡å–®ç§»å‹•å¹³å‡', 'è¨ˆç®—Nå¤©æ”¶ç›¤åƒ¹çš„å¹³å‡å€¼',
 '{"periods": [5, 10, 20, 60, 120, 240]}'::jsonb,
 '{"min_period": 2, "max_period": 500}'::jsonb,
 'sma', 2,
 '["ma5", "ma10", "ma20", "ma60", "ma120", "ma240"]'::jsonb,
 '{"min": 0, "max": null}'::jsonb,
 'P0', true, true),

('EMA', 'TREND', 'æŒ‡æ•¸ç§»å‹•å¹³å‡', 'çµ¦äºˆè¿‘æœŸåƒ¹æ ¼æ›´é«˜æ¬Šé‡çš„ç§»å‹•å¹³å‡',
 '{"periods": [12, 26, 50, 200]}'::jsonb,
 '{"min_period": 2, "max_period": 500}'::jsonb,
 'ema', 2,
 '["ema12", "ema26", "ema50", "ema200"]'::jsonb,
 '{"min": 0, "max": null}'::jsonb,
 'P0', true, true),

('MACD', 'TREND', 'MACDæŒ‡æ¨™', 'æŒ‡æ•¸å¹³æ»‘ç•°åŒç§»å‹•å¹³å‡ç·š',
 '{"fast": 12, "slow": 26, "signal": 9}'::jsonb,
 '{"fast": [5, 20], "slow": [20, 50], "signal": [5, 15]}'::jsonb,
 'macd', 26,
 '["macd_line", "signal_line", "histogram"]'::jsonb,
 '{"min": null, "max": null}'::jsonb,
 'P0', true, true),

('RSI', 'MOMENTUM', 'ç›¸å°å¼·å¼±æŒ‡æ¨™', 'æ¸¬é‡åƒ¹æ ¼è®Šå‹•é€Ÿåº¦å’Œå¹…åº¦',
 '{"period": 14}'::jsonb,
 '{"min_period": 5, "max_period": 30}'::jsonb,
 'rsi', 14,
 '["rsi_14"]'::jsonb,
 '{"min": 0, "max": 100}'::jsonb,
 'P0', true, true),

('STOCH', 'MOMENTUM', 'KDéš¨æ©ŸæŒ‡æ¨™', 'æ¸¬é‡æ”¶ç›¤åƒ¹åœ¨é«˜ä½å€é–“çš„ä½ç½®',
 '{"k": 9, "d": 3, "smooth_k": 3}'::jsonb,
 '{"k": [5, 20], "d": [2, 5], "smooth_k": [2, 5]}'::jsonb,
 'stoch', 9,
 '["stoch_k", "stoch_d"]'::jsonb,
 '{"min": 0, "max": 100}'::jsonb,
 'P0', true, true),

('BBANDS', 'VOLATILITY', 'å¸ƒæ—é€šé“', 'åƒ¹æ ¼çš„çµ±è¨ˆæ³¢å‹•ç¯„åœ',
 '{"period": 20, "std": 2}'::jsonb,
 '{"period": [10, 50], "std": [1, 3]}'::jsonb,
 'bbands', 20,
 '["upper", "middle", "lower"]'::jsonb,
 '{"min": 0, "max": null}'::jsonb,
 'P0', true, true),

('ATR', 'VOLATILITY', 'å¹³å‡çœŸå¯¦ç¯„åœ', 'æ¸¬é‡åƒ¹æ ¼æ³¢å‹•å¹…åº¦',
 '{"period": 14}'::jsonb,
 '{"period": [7, 30]}'::jsonb,
 'atr', 14,
 '["atr_14"]'::jsonb,
 '{"min": 0, "max": null}'::jsonb,
 'P0', true, true),

('OBV', 'VOLUME', 'èƒ½é‡æ½®', 'ç´¯ç©æˆäº¤é‡æŒ‡æ¨™',
 '{}'::jsonb,
 '{}'::jsonb,
 'obv', 1,
 '["obv"]'::jsonb,
 '{"min": null, "max": null}'::jsonb,
 'P0', true, true),

('ADX', 'TREND', 'å¹³å‡è¶¨å‘æŒ‡æ¨™', 'æ¸¬é‡è¶¨å‹¢å¼·åº¦',
 '{"period": 14}'::jsonb,
 '{"period": [7, 30]}'::jsonb,
 'adx', 14,
 '["adx", "plus_di", "minus_di"]'::jsonb,
 '{"min": 0, "max": 100}'::jsonb,
 'P0', true, true);
```

**è¨­è¨ˆèªªæ˜**:
- é›†ä¸­ç®¡ç†æ‰€æœ‰æŠ€è¡“æŒ‡æ¨™çš„å®šç¾©èˆ‡åƒæ•¸
- ä½¿ç”¨ JSONB å„²å­˜åƒæ•¸é…ç½®ï¼Œå½ˆæ€§æ“´å……
- æ”¯æ´å„ªå…ˆç´šåˆ†é¡ï¼ˆP0/P1/P2ï¼‰ï¼Œæ§åˆ¶è¨ˆç®—é »ç‡
- æä¾› pandas-ta å‡½æ•¸æ˜ å°„ï¼Œç°¡åŒ–è¨ˆç®—å¼•æ“å¯¦ä½œ

---

#### 3.2.3 indicator_calculation_jobs (æŒ‡æ¨™è¨ˆç®— Job è¨˜éŒ„è¡¨)

```sql
-- PostgreSQL å»ºè¡¨èªæ³•
CREATE TABLE indicator_calculation_jobs (
    job_id              BIGSERIAL PRIMARY KEY,
    job_type            VARCHAR(50) DEFAULT 'CALCULATE_INDICATORS',
    calculation_date    DATE NOT NULL,
    
    -- Job åƒæ•¸
    stock_list          TEXT[],
    indicator_priority  VARCHAR(10),
    
    -- åŸ·è¡Œè³‡è¨Š
    status              VARCHAR(20) DEFAULT 'PENDING' CHECK (status IN (
        'PENDING', 'RUNNING', 'SUCCESS', 'FAILED', 'CANCELLED'
    )),
    start_time          TIMESTAMP,
    end_time            TIMESTAMP,
    duration_seconds    INTEGER,
    
    -- çµ±è¨ˆè³‡è¨Šï¼ˆJSONBï¼‰
    statistics          JSONB DEFAULT '{}',
    
    -- éŒ¯èª¤è³‡è¨Š
    error_message       TEXT,
    error_stack_trace   TEXT,
    
    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by          VARCHAR(50) DEFAULT 'SYSTEM'
);

-- ç´¢å¼•
CREATE INDEX idx_indicator_jobs_date ON indicator_calculation_jobs(calculation_date);
CREATE INDEX idx_indicator_jobs_status ON indicator_calculation_jobs(status);
CREATE INDEX idx_indicator_jobs_type ON indicator_calculation_jobs(job_type);

-- è¡¨è¨»é‡‹
COMMENT ON TABLE indicator_calculation_jobs IS 'æŠ€è¡“æŒ‡æ¨™è¨ˆç®— Job åŸ·è¡Œè¨˜éŒ„è¡¨';
COMMENT ON COLUMN indicator_calculation_jobs.statistics IS 'åŸ·è¡Œçµ±è¨ˆè³‡è¨Šï¼ˆç¸½ç­†æ•¸ã€æˆåŠŸç­†æ•¸ã€å¤±æ•—ç­†æ•¸ç­‰ï¼‰';
```

**statistics JSONB çµæ§‹ç¯„ä¾‹**:
```json
{
  "total_stocks": 1800,
  "success_count": 1785,
  "failed_count": 15,
  "skipped_count": 0,
  "indicators_calculated": ["MA", "EMA", "RSI", "MACD"],
  "failed_stocks": ["1234", "5678"],
  "average_time_per_stock_ms": 250
}
```

---

### 3.3 è³‡æ–™åº«è¦–åœ–ï¼ˆViewï¼‰

#### 3.3.1 v_latest_indicators (æœ€æ–°æŒ‡æ¨™è¦–åœ–)

```sql
-- å»ºç«‹è¦–åœ–ï¼šå–å¾—æ¯æª”è‚¡ç¥¨çš„æœ€æ–°æŒ‡æ¨™
CREATE OR REPLACE VIEW v_latest_indicators AS
SELECT 
    ti.stock_id,
    s.stock_name,
    ti.calculation_date,
    ti.ma5, ti.ma20, ti.ma60,
    ti.ema12, ti.ema26,
    ti.macd_value, ti.macd_signal, ti.macd_histogram,
    ti.rsi_14,
    ti.stoch_k, ti.stoch_d,
    ti.bbands_upper, ti.bbands_middle, ti.bbands_lower,
    ti.atr_14,
    ti.obv,
    ti.adx_14,
    ti.trend_indicators,
    ti.momentum_indicators,
    ti.volatility_indicators,
    ti.volume_indicators
FROM technical_indicators ti
JOIN stocks s ON ti.stock_id = s.stock_id
WHERE ti.calculation_date = (
    SELECT MAX(calculation_date) 
    FROM technical_indicators 
    WHERE stock_id = ti.stock_id
)
AND s.is_active = true;

COMMENT ON VIEW v_latest_indicators IS 'æ¯æª”è‚¡ç¥¨çš„æœ€æ–°æŠ€è¡“æŒ‡æ¨™ï¼ˆæ´»èºè‚¡ç¥¨ï¼‰';
```

---

#### 3.3.2 v_golden_cross_candidates (é»ƒé‡‘äº¤å‰å€™é¸è¦–åœ–)

```sql
-- å»ºç«‹è¦–åœ–ï¼šåµæ¸¬ MA5 ä¸Šç©¿ MA20 çš„è‚¡ç¥¨
  CREATE OR REPLACE VIEW v_golden_cross_candidates AS
  WITH today_data AS (
      SELECT stock_id, ma5, ma20, calculation_date
      FROM technical_indicators
      WHERE calculation_date = CURRENT_DATE - INTERVAL '1 day'
  ),
  yesterday_data AS (
      SELECT stock_id, ma5, ma20
      FROM technical_indicators ti1
      WHERE calculation_date = (
          SELECT MAX(calculation_date)
          FROM technical_indicators ti2
          WHERE ti2.stock_id = ti1.stock_id
            AND ti2.calculation_date < (CURRENT_DATE - INTERVAL '1 day')
      )
  )
  SELECT 
      t.stock_id,
      s.stock_name,
      t.calculation_date as cross_date,
      t.ma5 as today_ma5,
      t.ma20 as today_ma20,
      y.ma5 as yesterday_ma5,
      y.ma20 as yesterday_ma20,
      'GOLDEN_CROSS' as signal_type
  FROM today_data t
  JOIN yesterday_data y ON t.stock_id = y.stock_id
  JOIN stocks s ON t.stock_id = s.stock_id
  WHERE y.ma5 < y.ma20
    AND t.ma5 > t.ma20
    AND s.is_active = true;

  COMMENT ON VIEW v_golden_cross_candidates IS 'MA5ä¸Šç©¿MA20é»ƒé‡‘äº¤å‰å€™é¸è‚¡ç¥¨';
```


### 3.4 JPA vs MyBatis ä½¿ç”¨å ´æ™¯

| è³‡æ–™è¡¨ | ç°¡å–® CRUD | è¤‡é›œæŸ¥è©¢ | æ‰¹æ¬¡æ“ä½œ | çµ±è¨ˆæŸ¥è©¢ |
|-------|----------|---------|---------|---------|
| technical_indicators | JPA | **MyBatis** | **MyBatis** | **MyBatis** |
| indicator_definitions | JPA | JPA | JPA | JPA |
| indicator_calculation_jobs | JPA | JPA | JPA | JPA |

**ä½¿ç”¨åŸå‰‡**:
- **JPA**: å–®ç­†æŸ¥è©¢ã€ç°¡å–®æ¢ä»¶ã€Entity ç®¡ç†
- **MyBatis**: æ‰¹æ¬¡ UPSERTã€JSONB æŸ¥è©¢ã€äº¤å‰ä¿¡è™Ÿåµæ¸¬ã€è¶…è²·è¶…è³£æŸ¥è©¢

---

---


---

## ğŸ“š ç›¸é—œæ–‡æª”

- [å…¨ç³»çµ±è³‡æ–™åº«æ¶æ§‹](./database-schema.md)
- [M07 ERD](./erd/M07-ERD.md)
- [M07 åŠŸèƒ½éœ€æ±‚](../specs/functional/M07-æŠ€è¡“åˆ†æåŠŸèƒ½éœ€æ±‚.md)

---

**æ–‡ä»¶ç¶­è­·è€…**: è³‡æ–™åº«è¨­è¨ˆå¸«  
**æœ€å¾Œæ›´æ–°**: 2025-12-31
