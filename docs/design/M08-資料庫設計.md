# M08-基本面分析模組資料庫設計

> **文件編號**: DB-M08  
> **模組名稱**: 基本面分析模組  
> **版本**: v2.0  
> **最後更新**: 2025-12-31  
> **狀態**: Draft

---

## 📋 資料庫設計總覽

本文件定義 基本面分析模組的所有資料表結構。

---

## 3. 資料設計

### 3.1 資料表清單

| 表名 | 說明 | 持久層 | 特殊功能 |
|-----|------|-------|---------|
| fundamental_indicators | 基本面指標主表 | JPA + MyBatis | JSONB、GIN 索引 |
| financial_scores | 綜合評分表 | JPA | - |
| financial_alerts | 財務異常警示表 | JPA | - |

### 3.2 資料表設計

#### 3.2.1 fundamental_indicators (基本面指標主表)

```sql
-- PostgreSQL 建表語法
CREATE TABLE fundamental_indicators (
    indicator_id        BIGSERIAL PRIMARY KEY,
    stock_id            VARCHAR(10) NOT NULL,
    year                INTEGER NOT NULL,
    quarter             INTEGER NOT NULL CHECK (quarter BETWEEN 1 AND 4),
    report_type         VARCHAR(10) NOT NULL CHECK (report_type IN ('Q', 'H', 'Y')),
    
    -- 估值指標（使用 JSONB 儲存）
    valuation_indicators JSONB DEFAULT '{}',
    
    -- 獲利能力指標
    profitability_indicators JSONB DEFAULT '{}',
    
    -- 財務結構指標
    financial_structure_indicators JSONB DEFAULT '{}',
    
    -- 償債能力指標
    solvency_indicators JSONB DEFAULT '{}',
    
    -- 經營效率指標
    efficiency_indicators JSONB DEFAULT '{}',
    
    -- 現金流量指標
    cash_flow_indicators JSONB DEFAULT '{}',
    
    -- 成長性指標
    growth_indicators JSONB DEFAULT '{}',
    
    -- 股利政策指標
    dividend_indicators JSONB DEFAULT '{}',
    
    -- 快速查詢欄位（冗餘，用於常用指標）
    pe_ratio            NUMERIC(10,2),
    pb_ratio            NUMERIC(10,2),
    ps_ratio            NUMERIC(10,2),
    roe                 NUMERIC(10,2),
    roa                 NUMERIC(10,2),
    gross_margin        NUMERIC(10,2),
    operating_margin    NUMERIC(10,2),
    net_margin          NUMERIC(10,2),
    eps                 NUMERIC(10,2),
    debt_ratio          NUMERIC(10,2),
    current_ratio       NUMERIC(10,2),
    quick_ratio         NUMERIC(10,2),
    fcf                 BIGINT,
    fcf_yield           NUMERIC(10,2),
    dividend_yield      NUMERIC(10,2),
    revenue_growth      NUMERIC(10,2),
    eps_growth          NUMERIC(10,2),
    
    -- 計算資訊
    calculation_date    DATE NOT NULL,
    stock_price         NUMERIC(10,2),
    calculation_version VARCHAR(10),
    
    -- 審計欄位
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE (stock_id, year, quarter, report_type),
    
    FOREIGN KEY (stock_id) REFERENCES stocks(stock_id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_fundamental_indicators_stock_id ON fundamental_indicators(stock_id);
CREATE INDEX idx_fundamental_indicators_year_quarter ON fundamental_indicators(year, quarter);
CREATE INDEX idx_fundamental_indicators_calculation_date ON fundamental_indicators(calculation_date);

-- GIN 索引（加速 JSONB 查詢）
CREATE INDEX idx_fundamental_indicators_valuation ON fundamental_indicators USING GIN(valuation_indicators);
CREATE INDEX idx_fundamental_indicators_profitability ON fundamental_indicators USING GIN(profitability_indicators);
CREATE INDEX idx_fundamental_indicators_structure ON fundamental_indicators USING GIN(financial_structure_indicators);
CREATE INDEX idx_fundamental_indicators_cashflow ON fundamental_indicators USING GIN(cash_flow_indicators);

-- 自動更新 updated_at 觸發器
CREATE TRIGGER update_fundamental_indicators_updated_at
    BEFORE UPDATE ON fundamental_indicators
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 表註釋
COMMENT ON TABLE fundamental_indicators IS '基本面指標主表（使用 JSONB 優化）';
COMMENT ON COLUMN fundamental_indicators.valuation_indicators IS '估值指標 JSONB（P/E、P/B、P/S等）';
COMMENT ON COLUMN fundamental_indicators.pe_ratio IS '本益比（冗餘欄位，用於快速查詢）';
```

**設計說明**:
- 使用 **JSONB** 儲存各類別指標，彈性擴充
- 提供冗餘欄位（pe_ratio, roe 等）用於高頻查詢，避免解析 JSON
- GIN 索引加速 JSONB 查詢
- UNIQUE 約束：(stock_id, year, quarter, report_type)

**JSONB 結構範例**:

**valuation_indicators**:
```json
{
  "pe_ratio": 18.50,
  "forward_pe": 16.20,
  "trailing_pe": 19.30,
  "pb_ratio": 3.20,
  "ps_ratio": 4.50,
  "pcf_ratio": 12.30,
  "pfcf_ratio": 15.80,
  "peg_ratio": 1.25,
  "ev_ebitda": 10.50,
  "tobins_q": 1.80,
  "graham_number": 650.00,
  "ev": 18500000000000,
  "market_cap": 15000000000000
}
```

**profitability_indicators**:
```json
{
  "gross_margin": 53.50,
  "operating_margin": 42.30,
  "net_margin": 41.20,
  "ebitda_margin": 48.50,
  "roe": 26.70,
  "roa": 18.70,
  "roic": 22.50,
  "rota": 20.30,
  "eps": 36.05,
  "diluted_eps": 35.80,
  "operating_eps": 38.20,
  "ebitda": 1100000000000
}
```

**financial_structure_indicators**:
```json
{
  "debt_to_equity": 0.35,
  "debt_ratio": 26.00,
  "equity_ratio": 74.00,
  "long_term_debt_to_equity": 0.20
}
```

**solvency_indicators**:
```json
{
  "current_ratio": 2.10,
  "quick_ratio": 1.85,
  "cash_ratio": 1.20,
  "interest_coverage": 45.30,
  "debt_service_coverage": 3.80,
  "ocf_to_current_liabilities": 2.50
}
```

**efficiency_indicators**:
```json
{
  "asset_turnover": 0.75,
  "inventory_turnover": 8.50,
  "receivables_turnover": 12.30,
  "payables_turnover": 9.80,
  "dio": 42.94,
  "dso": 29.67,
  "dpo": 37.24,
  "cash_conversion_cycle": 35.37,
  "operating_cycle": 72.61,
  "total_asset_turnover": 0.75
}
```

**cash_flow_indicators**:
```json
{
  "operating_cash_flow": 1000000000000,
  "free_cash_flow": 700000000000,
  "fcf_yield": 4.67,
  "ocf_ratio": 1.25,
  "cf_to_sales": 44.18,
  "accrual_ratio": -0.05
}
```

**growth_indicators**:
```json
{
  "revenue_growth_yoy": 18.50,
  "revenue_growth_qoq": 5.20,
  "eps_growth_yoy": 25.30,
  "eps_growth_qoq": 8.10,
  "net_income_growth_yoy": 22.80,
  "roe_growth_yoy": 3.50,
  "revenue_cagr_3y": 20.10,
  "revenue_cagr_5y": 22.50,
  "eps_cagr_3y": 28.30,
  "eps_cagr_5y": 30.20
}
```

**dividend_indicators**:
```json
{
  "dividend_yield": 1.90,
  "dividend_payout_ratio": 42.50,
  "dividend_per_share": 11.00,
  "dividend_growth_yoy": 15.80,
  "dividend_coverage": 2.35
}
```

**JSONB 查詢範例**:
```sql
-- 查詢 ROE > 20% 的股票
SELECT stock_id, year, quarter, 
       profitability_indicators->>'roe' as roe
FROM fundamental_indicators 
WHERE (profitability_indicators->>'roe')::numeric > 20.0
  AND year = 2024 AND quarter = 3;

-- 查詢本益比 < 15 且負債比 < 50% 的股票
SELECT stock_id, year, quarter,
       valuation_indicators->>'pe_ratio' as pe,
       financial_structure_indicators->>'debt_ratio' as debt_ratio
FROM fundamental_indicators 
WHERE (valuation_indicators->>'pe_ratio')::numeric < 15.0
  AND (financial_structure_indicators->>'debt_ratio')::numeric < 50.0
  AND year = 2024 AND quarter = 3;

-- 查詢包含特定指標的記錄
SELECT * FROM fundamental_indicators 
WHERE valuation_indicators ? 'peg_ratio'  -- 檢查 JSON 鍵是否存在
  AND year = 2024;
```

**UPSERT 語法（MyBatis）**:
```sql
INSERT INTO fundamental_indicators (
    stock_id, year, quarter, report_type,
    valuation_indicators, profitability_indicators,
    financial_structure_indicators, solvency_indicators,
    efficiency_indicators, cash_flow_indicators,
    growth_indicators, dividend_indicators,
    pe_ratio, pb_ratio, roe, eps,
    calculation_date, stock_price
) VALUES (
    '2330', 2024, 3, 'Q',
    '{"pe_ratio": 18.5, "pb_ratio": 3.2}'::jsonb,
    '{"roe": 26.7, "roa": 18.7, "net_margin": 41.2}'::jsonb,
    '{"debt_ratio": 26.0, "equity_ratio": 74.0}'::jsonb,
    '{"current_ratio": 2.1, "quick_ratio": 1.85}'::jsonb,
    '{"asset_turnover": 0.75, "dio": 42.94}'::jsonb,
    '{"fcf": 700000000000, "fcf_yield": 4.67}'::jsonb,
    '{"revenue_growth_yoy": 18.5, "eps_growth_yoy": 25.3}'::jsonb,
    '{"dividend_yield": 1.9, "dividend_payout_ratio": 42.5}'::jsonb,
    18.5, 3.2, 26.7, 36.05,
    '2024-11-14', 580.00
)
ON CONFLICT (stock_id, year, quarter, report_type)
DO UPDATE SET
    valuation_indicators = EXCLUDED.valuation_indicators,
    profitability_indicators = EXCLUDED.profitability_indicators,
    financial_structure_indicators = EXCLUDED.financial_structure_indicators,
    solvency_indicators = EXCLUDED.solvency_indicators,
    efficiency_indicators = EXCLUDED.efficiency_indicators,
    cash_flow_indicators = EXCLUDED.cash_flow_indicators,
    growth_indicators = EXCLUDED.growth_indicators,
    dividend_indicators = EXCLUDED.dividend_indicators,
    pe_ratio = EXCLUDED.pe_ratio,
    pb_ratio = EXCLUDED.pb_ratio,
    roe = EXCLUDED.roe,
    eps = EXCLUDED.eps,
    calculation_date = EXCLUDED.calculation_date,
    stock_price = EXCLUDED.stock_price,
    updated_at = CURRENT_TIMESTAMP;
```

---

#### 3.2.2 financial_scores (綜合評分表)

```sql
-- PostgreSQL 建表語法
CREATE TABLE financial_scores (
    score_id            BIGSERIAL PRIMARY KEY,
    stock_id            VARCHAR(10) NOT NULL,
    year                INTEGER NOT NULL,
    quarter             INTEGER NOT NULL CHECK (quarter BETWEEN 1 AND 4),
    
    -- Piotroski F-Score (0-9)
    piotroski_f_score   INTEGER CHECK (piotroski_f_score BETWEEN 0 AND 9),
    piotroski_details   JSONB,
    
    -- Altman Z-Score
    altman_z_score      NUMERIC(10,2),
    altman_status       VARCHAR(20) CHECK (altman_status IN ('SAFE', 'GREY', 'DISTRESS')),
    altman_details      JSONB,
    
    -- Beneish M-Score
    beneish_m_score     NUMERIC(10,2),
    beneish_status      VARCHAR(20) CHECK (beneish_status IN ('CLEAN', 'WARNING', 'MANIPULATOR')),
    beneish_details     JSONB,
    
    -- Graham Score (0-10)
    graham_score        INTEGER CHECK (graham_score BETWEEN 0 AND 10),
    graham_details      JSONB,
    
    -- 自訂綜合評分 (0-100)
    composite_score     NUMERIC(5,2) CHECK (composite_score BETWEEN 0 AND 100),
    composite_grade     VARCHAR(5) CHECK (composite_grade IN ('A+', 'A', 'B+', 'B', 'C+', 'C', 'D', 'F')),
    
    -- 計算資訊
    calculation_date    DATE NOT NULL,
    
    -- 審計欄位
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE (stock_id, year, quarter),
    
    FOREIGN KEY (stock_id) REFERENCES stocks(stock_id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_financial_scores_stock_id ON financial_scores(stock_id);
CREATE INDEX idx_financial_scores_year_quarter ON financial_scores(year, quarter);
CREATE INDEX idx_financial_scores_piotroski ON financial_scores(piotroski_f_score DESC);
CREATE INDEX idx_financial_scores_composite ON financial_scores(composite_score DESC);

-- 自動更新 updated_at 觸發器
CREATE TRIGGER update_financial_scores_updated_at
    BEFORE UPDATE ON financial_scores
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 表註釋
COMMENT ON TABLE financial_scores IS '綜合財務評分表';
COMMENT ON COLUMN financial_scores.piotroski_f_score IS 'Piotroski F-Score (0-9，越高越好)';
COMMENT ON COLUMN financial_scores.altman_z_score IS 'Altman Z-Score (>2.99安全，<1.81危險)';
COMMENT ON COLUMN financial_scores.composite_score IS '自訂綜合評分 (0-100)';
```

**JSONB 結構範例**:

**piotroski_details**:
```json
{
  "profitability": {
    "roa_positive": 1,
    "ocf_positive": 1,
    "roa_increasing": 1,
    "ocf_gt_ni": 1,
    "total": 4
  },
  "leverage": {
    "debt_decreasing": 1,
    "current_ratio_increasing": 1,
    "shares_not_increasing": 1,
    "total": 3
  },
  "operating_efficiency": {
    "gross_margin_increasing": 1,
    "asset_turnover_increasing": 1,
    "total": 2
  }
}
```

**altman_details**:
```json
{
  "working_capital_to_assets": 0.35,
  "retained_earnings_to_assets": 0.45,
  "ebit_to_assets": 0.18,
  "market_value_to_liabilities": 5.20,
  "sales_to_assets": 0.75,
  "z_score": 3.85,
  "interpretation": "安全區：破產風險低"
}
```

**beneish_details**:
```json
{
  "dsri": 1.05,
  "gmi": 0.95,
  "aqi": 1.02,
  "sgi": 1.18,
  "depi": 0.98,
  "sgai": 0.92,
  "lvgi": 1.03,
  "tata": -0.05,
  "m_score": -2.50,
  "interpretation": "盈餘品質良好"
}
```

---

#### 3.2.3 financial_alerts (財務異常警示表)

```sql
-- PostgreSQL 建表語法
CREATE TABLE financial_alerts (
    alert_id            BIGSERIAL PRIMARY KEY,
    stock_id            VARCHAR(10) NOT NULL,
    year                INTEGER NOT NULL,
    quarter             INTEGER NOT NULL,
    
    -- 警示資訊
    alert_type          VARCHAR(50) NOT NULL,
    alert_category      VARCHAR(50) NOT NULL CHECK (alert_category IN 
        ('EARNINGS_QUALITY', 'DEBT_RISK', 'LIQUIDITY_RISK', 'PROFITABILITY_DECLINE', 'OTHER')),
    severity            VARCHAR(20) NOT NULL CHECK (severity IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')),
    
    alert_message       TEXT NOT NULL,
    alert_detail        JSONB,
    
    -- 觸發條件
    trigger_indicator   VARCHAR(50),
    trigger_value       NUMERIC(15,2),
    threshold_value     NUMERIC(15,2),
    
    -- 狀態管理
    alert_status        VARCHAR(20) DEFAULT 'ACTIVE' CHECK (alert_status IN ('ACTIVE', 'RESOLVED', 'IGNORED')),
    is_notified         BOOLEAN DEFAULT FALSE,
    resolved_at         TIMESTAMP,
    
    -- 審計欄位
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (stock_id) REFERENCES stocks(stock_id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_financial_alerts_stock_id ON financial_alerts(stock_id);
CREATE INDEX idx_financial_alerts_year_quarter ON financial_alerts(year, quarter);
CREATE INDEX idx_financial_alerts_severity ON financial_alerts(severity);
CREATE INDEX idx_financial_alerts_status ON financial_alerts(alert_status);
CREATE INDEX idx_financial_alerts_category ON financial_alerts(alert_category);

-- 自動更新 updated_at 觸發器
CREATE TRIGGER update_financial_alerts_updated_at
    BEFORE UPDATE ON financial_alerts
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 表註釋
COMMENT ON TABLE financial_alerts IS '財務異常警示表';
COMMENT ON COLUMN financial_alerts.alert_category IS '警示類別（盈餘品質、負債風險、流動性風險等）';
COMMENT ON COLUMN financial_alerts.severity IS '嚴重程度（LOW、MEDIUM、HIGH、CRITICAL）';
```


---

### 3.3 資料關聯圖
```
┌──────────────────────┐
│      stocks          │ ← 股票主表（來自 M06）
└──────────────────────┘
            │
            │ (讀取，不修改)
            ↓
┌──────────────────────┐
│ financial_statements │ ← 財務報表（來自 M06）
│  - JSONB 儲存        │   - 讀取營收、淨利、總資產等
│  - GIN 索引          │   - 計算指標的資料來源
└──────────────────────┘
            │
            ↓
┌──────────────────────────────┐
│   fundamental_indicators     │ ← 基本面指標主表（M08 核心）
│    - JSONB 儲存各類指標      │   - 8 大類 JSONB 欄位
│    - GIN 索引               │   - 冗餘欄位（高頻查詢）
│    - 唯一鍵: (stock_id,     │
│       year, quarter)         │
└──────────────────────────────┘
            │
            ├──────────────→ financial_scores (1:1)
            │                 - 綜合評分
            │                 - Piotroski、Altman、Beneish
            │
            └──────────────→ financial_alerts (1:N)
                              - 財務異常警示
                              - 觸發信號

┌──────────────────────┐
│   stock_prices       │ ← 股價資料（來自 M06）
└──────────────────────┘   - 讀取收盤價（計算估值指標）
                           - 計算市值
```

**說明**:
- M08 **不修改** M06 的資料表
- M08 **讀取** financial_statements 和 stock_prices
- M08 **寫入** fundamental_indicators, financial_scores, financial_alerts
- fundamental_indicators 是核心表，使用 JSONB 儲存 75 個指標
- financial_scores 與 fundamental_indicators 是 1:1 關聯
- financial_alerts 與 fundamental_indicators 是 1:N 關聯（一季可能有多個警示）

---

### 3.4 JPA vs MyBatis 使用場景

| 資料表 | 簡單 CRUD | 複雜查詢 | 批次操作 | 統計查詢 |
|-------|----------|---------|---------|---------|
| fundamental_indicators | JPA | **MyBatis** | **MyBatis** | **MyBatis** |
| financial_scores | JPA | JPA | **MyBatis** | MyBatis |
| financial_alerts | JPA | MyBatis | JPA | MyBatis |

**使用原則**:
- **JPA**: 單筆查詢、簡單條件查詢
- **MyBatis**: 批次 UPSERT、JSONB 查詢、複雜統計

**具體場景**:

**fundamental_indicators**:
- 簡單查詢（單一股票單季）→ JPA
```java
  repository.findByStockIdAndYearAndQuarter("2330", 2024, 3)
```
- JSONB 查詢（ROE > 20%）→ MyBatis
```sql
  SELECT * FROM fundamental_indicators 
  WHERE (profitability_indicators->>'roe')::numeric > 20.0
```
- 批次 UPSERT（計算完成後儲存）→ MyBatis
```sql
  INSERT INTO fundamental_indicators (...) VALUES (...), (...), (...)
  ON CONFLICT (stock_id, year, quarter, report_type) DO UPDATE SET ...
```
- 統計查詢（產業平均 ROE）→ MyBatis
```sql
  SELECT industry, AVG((profitability_indicators->>'roe')::numeric)
  FROM fundamental_indicators
  GROUP BY industry
```

**financial_scores**:
- 單筆查詢 → JPA
- 批次插入（評分計算完成）→ MyBatis

**financial_alerts**:
- 單筆插入（單一警示）→ JPA
- 條件查詢（某股票的高嚴重度警示）→ MyBatis

**判斷標準**:
- ✅ 使用 MyBatis 的情況：
  - JSONB 欄位條件查詢
  - 批次 UPSERT（>10 筆）
  - 複雜聚合統計
  - 多表 JOIN + 動態條件
  
- ✅ 使用 JPA 的情況：
  - 單筆 findById
  - 簡單條件查詢（不涉及 JSONB）
  - Spring Data JPA 分頁查詢



---


---

## 📚 相關文檔

- [全系統資料庫架構](./database-schema.md)
- [M08 ERD](./erd/M08-ERD.md)
- [M08 功能需求](../specs/functional/M08-基本面分析功能需求.md)

---

**文件維護者**: 資料庫設計師  
**最後更新**: 2025-12-31
