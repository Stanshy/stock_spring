# M11-é‡åŒ–ç­–ç•¥æ¨¡çµ„æ•ˆèƒ½è€ƒé‡

> **æ–‡ä»¶ç·¨è™Ÿ**: PERF-M11
> **æ¨¡çµ„åç¨±**: é‡åŒ–ç­–ç•¥æ¨¡çµ„
> **ç‰ˆæœ¬**: v1.0
> **æœ€å¾Œæ›´æ–°**: 2026-01-14
> **ç‹€æ…‹**: Draft

---

## 1. æ•ˆèƒ½ç›®æ¨™

| æŒ‡æ¨™ | ç›®æ¨™å€¼ | æ¸¬é‡æ–¹å¼ | èªªæ˜ |
|-----|-------|---------|------|
| å–®ç­–ç•¥æŸ¥è©¢ | P95 < 30ms | APM ç›£æ§ | ç­–ç•¥å®šç¾©æŸ¥è©¢ |
| ç­–ç•¥æ¸…å–®æŸ¥è©¢ | P95 < 100ms | APM ç›£æ§ | åˆ†é æŸ¥è©¢ |
| å–®è‚¡ä¿¡è™ŸæŸ¥è©¢ | P95 < 50ms | APM ç›£æ§ | å¿«å–å‘½ä¸­ |
| å–®è‚¡ä¿¡è™ŸæŸ¥è©¢ï¼ˆç„¡å¿«å–ï¼‰ | P95 < 150ms | APM ç›£æ§ | è³‡æ–™åº«æŸ¥è©¢ |
| å–®ç­–ç•¥å³æ™‚åŸ·è¡Œ | P95 < 500ms | APM ç›£æ§ | æŒ‡å®šè‚¡ç¥¨æ¸…å–® |
| å› å­è³‡æ–™è¼‰å…¥ | P95 < 200ms | APM ç›£æ§ | å–®è‚¡å…¨å› å­ |
| æ¯æ—¥ç­–ç•¥æ‰¹æ¬¡åŸ·è¡Œ | < 10 åˆ†é˜ | Job åŸ·è¡Œè¨˜éŒ„ | 10 ç­–ç•¥ Ã— 1800 è‚¡ |
| æ¢ä»¶æ¨¹è©•ä¼° | < 5ms | å…§éƒ¨è¨ˆæ™‚ | å–®è‚¡å–®ç­–ç•¥ |
| å¿«å–å‘½ä¸­ç‡ | > 75% | Redis çµ±è¨ˆ | ç†±é–€ç­–ç•¥ä¿¡è™Ÿ |
| è³‡æ–™åº«æŸ¥è©¢æ™‚é–“ | < 50ms | æ…¢æŸ¥è©¢æ—¥èªŒ | å–®è¡¨æŸ¥è©¢ |

---

## 2. æ•ˆèƒ½å„ªåŒ–ç­–ç•¥

### 2.1 ç­–ç•¥åŸ·è¡Œå¼•æ“å„ªåŒ–

**æ‰¹æ¬¡åŸ·è¡Œæ¶æ§‹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç­–ç•¥æ‰¹æ¬¡åŸ·è¡Œæ¶æ§‹                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   æ´»èºç­–ç•¥æ¸…å–®   â”‚
                    â”‚ (10 å€‹ç­–ç•¥)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼ ä¾åºåŸ·è¡Œï¼ˆç­–ç•¥é–“æœ‰ä¾è³´ï¼Œä¸ä¸¦è¡Œï¼‰
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å–®ç­–ç•¥åŸ·è¡Œ     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   è‚¡ç¥¨æ¸…å–®       â”‚
                    â”‚ (1800 æª”)       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   åˆ†æ‰¹è™•ç†       â”‚ â† batch_size = 100
                    â”‚ (18 æ‰¹)         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Thread 1   â”‚ â”‚  Thread 2   â”‚ â”‚  Thread N   â”‚
    â”‚  Batch 1-6  â”‚ â”‚  Batch 7-12 â”‚ â”‚  Batch 13-18â”‚
    â”‚             â”‚ â”‚             â”‚ â”‚             â”‚
    â”‚ 1. è¼‰å…¥å› å­ â”‚ â”‚ 1. è¼‰å…¥å› å­ â”‚ â”‚ 1. è¼‰å…¥å› å­ â”‚
    â”‚ 2. è©•ä¼°æ¢ä»¶ â”‚ â”‚ 2. è©•ä¼°æ¢ä»¶ â”‚ â”‚ 2. è©•ä¼°æ¢ä»¶ â”‚
    â”‚ 3. è¨ˆç®—ä¿¡å¿ƒ â”‚ â”‚ 3. è¨ˆç®—ä¿¡å¿ƒ â”‚ â”‚ 3. è¨ˆç®—ä¿¡å¿ƒ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚               â”‚               â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  MyBatis æ‰¹æ¬¡   â”‚
                    â”‚  UPSERT Signals â”‚
                    â”‚ (100 ç­†/æ‰¹)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŸ·è¡Œç·’æ± é…ç½®**:
```java
@Configuration
public class StrategyEngineConfig {

    @Bean("strategyExecutionExecutor")
    public ThreadPoolTaskExecutor strategyExecutionExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(4);           // CPU æ ¸å¿ƒæ•¸
        executor.setMaxPoolSize(8);            // æœ€å¤§åŸ·è¡Œç·’æ•¸
        executor.setQueueCapacity(200);        // ä»»å‹™ä½‡åˆ—
        executor.setKeepAliveSeconds(60);
        executor.setThreadNamePrefix("strategy-exec-");
        executor.setRejectedExecutionHandler(new CallerRunsPolicy());
        return executor;
    }
}
```

**å› å­è¼‰å…¥å„ªåŒ–**:
```java
// æ‰¹æ¬¡è¼‰å…¥å› å­ï¼Œé¿å… N+1 æŸ¥è©¢
public Map<String, Map<String, BigDecimal>> batchLoadFactors(
        List<String> stockIds,
        LocalDate tradeDate,
        Set<String> requiredFactors) {

    // 1. ä¾å› å­é¡å‹åˆ†çµ„
    Map<FactorCategory, Set<String>> factorsByCategory =
        categorizeFactors(requiredFactors);

    // 2. æ‰¹æ¬¡æŸ¥è©¢å„é¡å› å­
    Map<String, Map<String, BigDecimal>> result = new HashMap<>();

    // ä¸¦è¡Œè¼‰å…¥ä¸åŒä¾†æºçš„å› å­
    CompletableFuture<?>[] futures = new CompletableFuture[3];
    futures[0] = loadTechnicalFactorsAsync(stockIds, tradeDate, factorsByCategory.get(TECHNICAL));
    futures[1] = loadFundamentalFactorsAsync(stockIds, tradeDate, factorsByCategory.get(FUNDAMENTAL));
    futures[2] = loadChipFactorsAsync(stockIds, tradeDate, factorsByCategory.get(CHIP));

    CompletableFuture.allOf(futures).join();

    return mergeFactorResults(futures);
}
```

---

### 2.2 æ¢ä»¶æ¨¹è©•ä¼°å„ªåŒ–

**æ¢ä»¶è©•ä¼°å¿«å–**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¢ä»¶è©•ä¼°å„ªåŒ–ç­–ç•¥                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‚³çµ±æ–¹å¼ï¼ˆæ¯è‚¡é‡æ–°è§£æï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stock A    â”‚    â”‚  Stock B    â”‚    â”‚  Stock C    â”‚
â”‚  Parse JSON â”‚    â”‚  Parse JSON â”‚    â”‚  Parse JSON â”‚
â”‚  Build Tree â”‚    â”‚  Build Tree â”‚    â”‚  Build Tree â”‚
â”‚  Evaluate   â”‚    â”‚  Evaluate   â”‚    â”‚  Evaluate   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    æ™‚é–“: 5ms          æ™‚é–“: 5ms          æ™‚é–“: 5ms

å„ªåŒ–æ–¹å¼ï¼ˆé ç·¨è­¯æ¢ä»¶æ¨¹ï¼‰:
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Strategy      â”‚
                â”‚   Parse JSON    â”‚ â† åªåšä¸€æ¬¡
                â”‚   Build Tree    â”‚
                â”‚   Compile       â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stock A    â”‚ â”‚  Stock B    â”‚ â”‚  Stock C    â”‚
â”‚  Evaluate   â”‚ â”‚  Evaluate   â”‚ â”‚  Evaluate   â”‚
â”‚  (Reuse)    â”‚ â”‚  (Reuse)    â”‚ â”‚  (Reuse)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    æ™‚é–“: 1ms          æ™‚é–“: 1ms          æ™‚é–“: 1ms
```

**é ç·¨è­¯æ¢ä»¶æ¨¹å¯¦ä½œ**:
```java
@Service
public class ConditionTreeCompiler {

    // å¿«å–å·²ç·¨è­¯çš„æ¢ä»¶æ¨¹
    private final Map<String, CompiledConditionTree> cache =
        new ConcurrentHashMap<>();

    public CompiledConditionTree compile(Strategy strategy) {
        return cache.computeIfAbsent(
            strategy.getStrategyId() + "_" + strategy.getVersion(),
            key -> doCompile(strategy.getConditions())
        );
    }

    private CompiledConditionTree doCompile(JsonNode conditions) {
        // è§£æ JSON ä¸¦å»ºç«‹å¯é‡ç”¨çš„æ¢ä»¶æ¨¹çµæ§‹
        // é å…ˆé©—è­‰å› å­åç¨±
        // é å…ˆè§£ææ¯”è¼ƒé‹ç®—ç¬¦
        return new CompiledConditionTree(conditions);
    }
}
```

**çŸ­è·¯è©•ä¼°**:
```java
// AND æ¢ä»¶ï¼šé‡åˆ° false ç«‹å³è¿”å›
// OR æ¢ä»¶ï¼šé‡åˆ° true ç«‹å³è¿”å›
public boolean evaluateNode(ConditionNode node, Map<String, BigDecimal> factors) {
    if (node.isLeaf()) {
        return evaluateCondition(node.getCondition(), factors);
    }

    if (node.getOperator() == Operator.AND) {
        for (ConditionNode child : node.getChildren()) {
            if (!evaluateNode(child, factors)) {
                return false;  // çŸ­è·¯
            }
        }
        return true;
    } else { // OR
        for (ConditionNode child : node.getChildren()) {
            if (evaluateNode(child, factors)) {
                return true;  // çŸ­è·¯
            }
        }
        return false;
    }
}
```

---

### 2.3 è³‡æ–™åº«å„ªåŒ–

**ç´¢å¼•ç­–ç•¥**:

| è¡¨å | ç´¢å¼• | æŸ¥è©¢å ´æ™¯ |
|-----|------|---------|
| strategies | (status, strategy_type) | æ´»èºç­–ç•¥æ¸…å–®æŸ¥è©¢ |
| strategies | (creator_id, status) | ä½¿ç”¨è€…ç­–ç•¥æŸ¥è©¢ |
| strategy_signals | (execution_id) | åŸ·è¡Œçµæœé—œè¯ |
| strategy_signals | (strategy_id, trade_date) | ç­–ç•¥ä¿¡è™Ÿæ­·å² |
| strategy_signals | (stock_id, trade_date) | å–®è‚¡ä¿¡è™ŸæŸ¥è©¢ |
| strategy_signals | (trade_date, is_consumed) | M13 æ¶ˆè²»æŸ¥è©¢ |
| strategy_signals | (signal_type, confidence_score) | é«˜ä¿¡å¿ƒä¿¡è™Ÿç¯©é¸ |
| strategy_executions | (strategy_id, execution_date) | åŸ·è¡Œæ­·å²æŸ¥è©¢ |
| factor_metadata | (source_module, category) | å› å­æ¸…å–®æŸ¥è©¢ |

**åˆ†å€ç­–ç•¥**:
```sql
-- strategy_signals æŒ‰æœˆåˆ†å€ï¼ˆè³‡æ–™é‡å¤§ï¼‰
CREATE TABLE strategy_signals (
    signal_id VARCHAR(50) PRIMARY KEY,
    execution_id VARCHAR(50) NOT NULL,
    strategy_id VARCHAR(50) NOT NULL,
    stock_id VARCHAR(10) NOT NULL,
    trade_date DATE NOT NULL,
    signal_type VARCHAR(10) NOT NULL,
    confidence_score DECIMAL(5,4),
    is_consumed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) PARTITION BY RANGE (trade_date);

-- å»ºç«‹æœˆåº¦åˆ†å€
CREATE TABLE strategy_signals_2024_12
    PARTITION OF strategy_signals
    FOR VALUES FROM ('2024-12-01') TO ('2025-01-01');

CREATE TABLE strategy_signals_2025_01
    PARTITION OF strategy_signals
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

**MyBatis æ‰¹æ¬¡å› å­è¼‰å…¥**:
```xml
<!-- å–®æ¬¡æŸ¥è©¢è¼‰å…¥å¤šè‚¡ç¥¨çš„æŠ€è¡“å› å­ -->
<select id="batchLoadTechnicalFactors" resultType="map">
    SELECT
        stock_id,
        rsi_14, rsi_7,
        macd_value, macd_signal, macd_histogram,
        sma_5, sma_20, sma_60,
        bollinger_upper, bollinger_middle, bollinger_lower
    FROM technical_indicators
    WHERE stock_id IN
    <foreach collection="stockIds" item="id" open="(" separator="," close=")">
        #{id}
    </foreach>
    AND trade_date = #{tradeDate}
</select>
```

**æ‰¹æ¬¡å¯«å…¥å„ªåŒ–**:
```sql
-- MyBatis æ‰¹æ¬¡ INSERTï¼ˆæ¯æ‰¹ 100 ç­†ï¼‰
INSERT INTO strategy_signals (
    signal_id, execution_id, strategy_id, stock_id, trade_date,
    signal_type, confidence_score, factor_values, created_at
) VALUES
    <foreach collection="signals" item="s" separator=",">
    (#{s.signalId}, #{s.executionId}, #{s.strategyId}, #{s.stockId}, #{s.tradeDate},
     #{s.signalType}, #{s.confidenceScore}, #{s.factorValues}::jsonb, CURRENT_TIMESTAMP)
    </foreach>
ON CONFLICT (signal_id) DO NOTHING
</sql>
```

**é€£ç·šæ± é…ç½®**:
```yaml
spring:
  datasource:
    hikari:
      minimum-idle: 10
      maximum-pool-size: 50
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

---

### 2.4 å¿«å–å„ªåŒ–

**å¤šå±¤å¿«å–æ¶æ§‹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¿«å–å±¤ç´š                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è«‹æ±‚
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1: æœ¬åœ°å¿«å–        â”‚ â† Caffeine Cache
â”‚  TTL: 10 åˆ†é˜       â”‚     ç­–ç•¥å®šç¾©ã€ç·¨è­¯æ¢ä»¶æ¨¹
â”‚  Size: 500 entries  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚ æœªå‘½ä¸­
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L2: Redis å¿«å–     â”‚ â† åˆ†æ•£å¼å¿«å–
â”‚  TTL: 1-6 å°æ™‚      â”‚     ç­–ç•¥ä¿¡è™Ÿã€å› å­å…ƒæ•¸æ“š
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚ æœªå‘½ä¸­
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L3: PostgreSQL     â”‚ â† æŒä¹…åŒ–å„²å­˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Redis å¿«å– Key è¨­è¨ˆ**:

| å¿«å–é¡å‹ | Key Pattern | TTL | èªªæ˜ |
|---------|-------------|-----|------|
| ç­–ç•¥å®šç¾© | `strategy:def:{strategyId}` | 30 åˆ†é˜ | ç­–ç•¥ JSON |
| ç­–ç•¥ä¿¡è™Ÿ | `strategy:signals:{strategyId}:{date}` | 6 å°æ™‚ | ç•¶æ—¥ä¿¡è™Ÿ |
| è‚¡ç¥¨ä¿¡è™Ÿ | `strategy:stock:{stockId}:{date}` | 6 å°æ™‚ | å–®è‚¡æ‰€æœ‰ä¿¡è™Ÿ |
| å› å­å…ƒæ•¸æ“š | `strategy:factors:metadata` | 24 å°æ™‚ | å› å­æ¸…å–® |
| åŸ·è¡Œçµæœ | `strategy:exec:{executionId}` | 1 å°æ™‚ | åŸ·è¡Œæ‘˜è¦ |

**å¿«å–æ›´æ–°ç­–ç•¥**:
```java
@Service
public class StrategyCacheService {

    private final RedisTemplate<String, Object> redisTemplate;
    private final Cache<String, Strategy> localCache;

    // å¯«å…¥æ™‚åŒæ­¥æ›´æ–°å¿«å–
    @CacheEvict(value = "strategies", key = "#strategy.strategyId")
    public void updateStrategy(Strategy strategy) {
        strategyRepository.save(strategy);
        // åŒæ™‚æ¸…é™¤æœ¬åœ°å¿«å–
        localCache.invalidate(strategy.getStrategyId());
    }

    // åŸ·è¡Œå®Œæˆæ™‚æ›´æ–°ä¿¡è™Ÿå¿«å–
    public void cacheExecutionSignals(StrategyExecution execution, List<StrategySignal> signals) {
        String key = String.format("strategy:signals:%s:%s",
            execution.getStrategyId(), execution.getExecutionDate());

        redisTemplate.opsForValue().set(key, signals, Duration.ofHours(6));

        // åŒæ™‚æ›´æ–°å„è‚¡ç¥¨çš„ä¿¡è™Ÿå¿«å–
        signals.stream()
            .collect(Collectors.groupingBy(StrategySignal::getStockId))
            .forEach((stockId, stockSignals) -> {
                String stockKey = String.format("strategy:stock:%s:%s", stockId, execution.getExecutionDate());
                redisTemplate.opsForList().rightPushAll(stockKey, stockSignals);
                redisTemplate.expire(stockKey, Duration.ofHours(6));
            });
    }
}
```

**å¿«å–é˜²è­·ç­–ç•¥**:

| å•é¡Œ | è§£æ±ºæ–¹æ¡ˆ |
|-----|---------|
| å¿«å–ç©¿é€ | ç©ºå€¼å¿«å–ï¼ˆTTL 5åˆ†é˜ï¼‰+ å¸ƒéš†éæ¿¾å™¨ï¼ˆç­–ç•¥IDï¼‰ |
| å¿«å–é›ªå´© | TTL éš¨æ©ŸåŒ–ï¼ˆÂ±15%ï¼‰ |
| å¿«å–æ“Šç©¿ | åˆ†æ•£å¼é–ï¼ˆç­–ç•¥åŸ·è¡Œæ™‚ï¼‰ |
| è³‡æ–™ä¸€è‡´ | å¯«å…¥æ™‚ä¸»å‹•å¤±æ•ˆå¿«å– |

---

### 2.5 å› å­è¼‰å…¥å„ªåŒ–

**è·¨æ¨¡çµ„æŸ¥è©¢æ•ˆèƒ½**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å› å­è¼‰å…¥å„ªåŒ–                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‚³çµ±æ–¹å¼ï¼ˆä¸²è¡ŒæŸ¥è©¢ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ M07 æŸ¥è©¢  â”‚   â”‚ M08 æŸ¥è©¢  â”‚   â”‚ M09 æŸ¥è©¢  â”‚   â”‚ åˆä½µçµæœ  â”‚
â”‚ 50ms     â”‚   â”‚ 50ms     â”‚   â”‚ 50ms     â”‚   â”‚ 5ms      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              ç¸½æ™‚é–“: 155ms

å„ªåŒ–æ–¹å¼ï¼ˆä¸¦è¡ŒæŸ¥è©¢ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ M07 æŸ¥è©¢  â”‚ â”€â”€â”€â”€â”€â”
â”‚ 50ms     â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”œâ”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ M08 æŸ¥è©¢  â”‚ â”€â”€â”€â”€â”€â”¤    â”‚ åˆä½µçµæœ  â”‚
â”‚ 50ms     â”‚      â”‚    â”‚ 5ms      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ M09 æŸ¥è©¢  â”‚ â”€â”€â”€â”€â”€â”˜    ç¸½æ™‚é–“: 55ms
â”‚ 50ms     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸¦è¡Œå› å­è¼‰å…¥å¯¦ä½œ**:
```java
@Service
public class FactorDataLoader {

    @Async("factorLoadingExecutor")
    public CompletableFuture<Map<String, BigDecimal>> loadTechnicalFactors(
            String stockId, LocalDate tradeDate, Set<String> factors) {
        // æŸ¥è©¢ M07 æŠ€è¡“æŒ‡æ¨™
        return CompletableFuture.completedFuture(
            technicalMapper.selectFactors(stockId, tradeDate, factors)
        );
    }

    @Async("factorLoadingExecutor")
    public CompletableFuture<Map<String, BigDecimal>> loadFundamentalFactors(
            String stockId, LocalDate tradeDate, Set<String> factors) {
        // æŸ¥è©¢ M08 è²¡å‹™æŒ‡æ¨™
        return CompletableFuture.completedFuture(
            fundamentalMapper.selectFactors(stockId, tradeDate, factors)
        );
    }

    @Async("factorLoadingExecutor")
    public CompletableFuture<Map<String, BigDecimal>> loadChipFactors(
            String stockId, LocalDate tradeDate, Set<String> factors) {
        // æŸ¥è©¢ M09 ç±Œç¢¼æŒ‡æ¨™
        return CompletableFuture.completedFuture(
            chipMapper.selectFactors(stockId, tradeDate, factors)
        );
    }
}
```

**å› å­é è¼‰å…¥**:
```java
// åœ¨ç­–ç•¥åŸ·è¡Œå‰ï¼Œé è¼‰å…¥æ‰€æœ‰éœ€è¦çš„å› å­
public void preloadFactors(Strategy strategy, List<String> stockIds, LocalDate tradeDate) {
    Set<String> requiredFactors = extractRequiredFactors(strategy.getConditions());

    // æ‰¹æ¬¡é è¼‰å…¥åˆ° Redis
    Map<String, Map<String, BigDecimal>> factorData =
        factorDataLoader.batchLoad(stockIds, tradeDate, requiredFactors);

    // å¿«å–åˆ° Redisï¼ˆç”¨æ–¼ç­–ç•¥åŸ·è¡ŒæœŸé–“ï¼‰
    String cacheKey = String.format("strategy:factors:%s:%s",
        strategy.getStrategyId(), tradeDate);
    redisTemplate.opsForValue().set(cacheKey, factorData, Duration.ofHours(1));
}
```

---

## 3. å®¹é‡è¦åŠƒ

### 3.1 è³‡æ–™é‡ä¼°ç®—

**strategies è¡¨**:
```
é æœŸç­–ç•¥æ•¸: 50-100 å€‹ï¼ˆå«ç³»çµ±é è¨­ + ä½¿ç”¨è€…è‡ªè¨‚ï¼‰
å–®ç­†å¤§å°: ~2 KBï¼ˆå« JSONB æ¬„ä½ï¼‰
ç¸½å®¹é‡: < 1 MB
```

**strategy_versions è¡¨**:
```
å‡è¨­æ¯ç­–ç•¥å¹³å‡ 5 å€‹ç‰ˆæœ¬
ç‰ˆæœ¬æ•¸: 100 Ã— 5 = 500 ç­†
å–®ç­†å¤§å°: ~3 KB
ç¸½å®¹é‡: < 2 MB
```

**strategy_executions è¡¨**:
```
æ¯æ—¥åŸ·è¡Œ: 10 ç­–ç•¥ Ã— 1 æ¬¡ = 10 ç­†/æ—¥
æ¯å¹´: 10 Ã— 250 = 2,500 ç­†/å¹´
ä¿ç•™ 1 å¹´: 2,500 ç­†

å–®ç­†å¤§å°ï¼ˆå« diagnostics JSONBï¼‰: ~5 KB
ç¸½å®¹é‡: ç´„ 12 MB
```

**strategy_signals è¡¨ï¼ˆæœ€å¤§ï¼‰**:
```
å‡è¨­æ¯ç­–ç•¥æ¯æ—¥ç”¢ç”Ÿä¿¡è™Ÿ: å¹³å‡ 50 ç­†
æ¯æ—¥æ–°å¢: 10 ç­–ç•¥ Ã— 50 ç­† = 500 ç­†/æ—¥
æ¯å¹´æ–°å¢: 500 Ã— 250 = 125,000 ç­†/å¹´
ä¿ç•™ 90 å¤©: ç´„ 45,000 ç­†

å–®ç­†å¤§å°ï¼ˆå« factor_values JSONBï¼‰: ~1 KB
ç¸½å®¹é‡: ç´„ 45 MB
å«ç´¢å¼•: ç´„ 100-150 MB
```

**factor_metadata è¡¨**:
```
å› å­ç¸½æ•¸: M07(71) + M08(75) + M09(20) â‰ˆ 166 å€‹
å–®ç­†å¤§å°: ~500 bytes
ç¸½å®¹é‡: < 100 KB
```

### 3.2 Redis è¨˜æ†¶é«”ä¼°ç®—

```
å¿«å–é …ç›®:
- ç­–ç•¥å®šç¾©: 100 Ã— 2 KB = 0.2 MB
- ç•¶æ—¥ä¿¡è™Ÿ: 500 Ã— 1 KB = 0.5 MB
- å› å­å…ƒæ•¸æ“š: 1 Ã— 100 KB = 0.1 MB
- åŸ·è¡Œçµæœ: 10 Ã— 10 KB = 0.1 MB
- é è¼‰å› å­: 1800 Ã— 20 KB = 36 MBï¼ˆåŸ·è¡ŒæœŸé–“ï¼‰

ç¸½è¨ˆ:
- å¸¸é§: ç´„ 5-10 MB
- åŸ·è¡ŒæœŸé–“å³°å€¼: ç´„ 50 MB
å»ºè­°åˆ†é…: 100-200 MB
```

### 3.3 ç¡¬é«”éœ€æ±‚

**é–‹ç™¼/æ¸¬è©¦ç’°å¢ƒ**:
- CPU: 2 æ ¸
- RAM: 4 GB
- Disk: 20 GB SSD
- Redis: 256 MB

**ç”Ÿç”¢ç’°å¢ƒï¼ˆå–®æ©Ÿï¼‰**:
- CPU: 4 æ ¸
- RAM: 16 GB
- Disk: 100 GB SSD
- Redis: 1 GB
- PostgreSQL shared_buffers: 4 GB

---

## 4. ç›£æ§æŒ‡æ¨™

| æŒ‡æ¨™é¡å‹ | æŒ‡æ¨™åç¨± | é–¾å€¼ | å‘Šè­¦ç­‰ç´š |
|---------|---------|------|---------|
| API æ•ˆèƒ½ | P95 å›æ‡‰æ™‚é–“ | > 300ms | WARNING |
| API æ•ˆèƒ½ | P99 å›æ‡‰æ™‚é–“ | > 500ms | ERROR |
| ç­–ç•¥åŸ·è¡Œ | å–®ç­–ç•¥åŸ·è¡Œæ™‚é–“ | > 2 åˆ†é˜ | WARNING |
| ç­–ç•¥åŸ·è¡Œ | å–®è‚¡è©•ä¼°æ™‚é–“ | > 50ms | WARNING |
| æ‰¹æ¬¡æ•ˆèƒ½ | æ¯æ—¥ Job åŸ·è¡Œæ™‚é•· | > 15 åˆ†é˜ | WARNING |
| æ‰¹æ¬¡æ•ˆèƒ½ | ç­–ç•¥å¤±æ•—ç‡ | > 30% | ERROR |
| å› å­è¼‰å…¥ | å› å­ç¼ºå¤±ç‡ | > 5% | WARNING |
| å› å­è¼‰å…¥ | è·¨æ¨¡çµ„æŸ¥è©¢æ™‚é–“ | > 300ms | WARNING |
| å¿«å– | Redis å‘½ä¸­ç‡ | < 70% | WARNING |
| å¿«å– | Redis è¨˜æ†¶é«”ä½¿ç”¨ç‡ | > 80% | WARNING |
| è³‡æ–™åº« | æ…¢æŸ¥è©¢æ•¸é‡ | > 10/åˆ†é˜ | WARNING |
| è³‡æ–™åº« | é€£ç·šæ± ä½¿ç”¨ç‡ | > 80% | WARNING |

---

## 5. æ•ˆèƒ½æ¸¬è©¦å ´æ™¯

| æ¸¬è©¦å ´æ™¯ | é æœŸçµæœ | èªªæ˜ |
|---------|---------|------|
| 100 ä½µç™¼ç­–ç•¥æŸ¥è©¢ | P95 < 50ms | ç­–ç•¥å®šç¾©æŸ¥è©¢ |
| 100 ä½µç™¼ä¿¡è™ŸæŸ¥è©¢ï¼ˆå¿«å–å‘½ä¸­ï¼‰ | P95 < 50ms | å–®è‚¡ç•¶æ—¥ä¿¡è™Ÿ |
| 100 ä½µç™¼ä¿¡è™ŸæŸ¥è©¢ï¼ˆå¿«å–æœªå‘½ä¸­ï¼‰ | P95 < 200ms | å†·é–€è‚¡ç¥¨ |
| å–®ç­–ç•¥å³æ™‚åŸ·è¡Œï¼ˆ100 è‚¡ï¼‰ | < 3 ç§’ | åŒ…å«å› å­è¼‰å…¥ |
| å–®ç­–ç•¥å³æ™‚åŸ·è¡Œï¼ˆå…¨å¸‚å ´ï¼‰ | < 30 ç§’ | 1800 è‚¡ |
| æ¯æ—¥æ‰¹æ¬¡åŸ·è¡Œï¼ˆ10 ç­–ç•¥ï¼‰ | < 10 åˆ†é˜ | 10 Ã— 1800 è‚¡ |
| æ¢ä»¶æ¨¹è©•ä¼°ï¼ˆè¤‡é›œæ¢ä»¶ï¼‰ | < 10ms | 10 å±¤å·¢ç‹€ |
| ä¸¦è¡Œå› å­è¼‰å…¥ | < 100ms | 3 æ¨¡çµ„ä¸¦è¡Œ |

---

## 6. æ•ˆèƒ½èª¿å„ªå»ºè­°

### 6.1 ç­–ç•¥è¨­è¨ˆå»ºè­°

| å»ºè­° | èªªæ˜ |
|-----|------|
| é™åˆ¶æ¢ä»¶æ·±åº¦ | å»ºè­°æ¢ä»¶æ¨¹æ·±åº¦ â‰¤ 5 å±¤ |
| æ§åˆ¶å› å­æ•¸é‡ | å–®ç­–ç•¥ä½¿ç”¨å› å­æ•¸ â‰¤ 20 å€‹ |
| é¿å…å†—é¤˜æ¢ä»¶ | ç§»é™¤æ°¸çœŸ/æ°¸å‡çš„æ¢ä»¶ç¯€é» |
| å„ªå…ˆé«˜æ•ˆå› å­ | æŠ€è¡“å› å­æŸ¥è©¢è¼ƒå¿«ï¼Œå¯å„ªå…ˆä½¿ç”¨ |

### 6.2 JVM èª¿å„ª

```bash
# ç”Ÿç”¢ç’°å¢ƒ JVM åƒæ•¸
JAVA_OPTS="-Xms2g -Xmx4g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=100 \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/var/log/heapdump.hprof"
```

### 6.3 è³‡æ–™åº«èª¿å„ª

```sql
-- é‡å°ç­–ç•¥åŸ·è¡Œçš„æŸ¥è©¢å„ªåŒ–
SET work_mem = '256MB';           -- æé«˜æ’åº/é›œæ¹Šè¨˜æ†¶é«”
SET effective_cache_size = '8GB'; -- å‘ŠçŸ¥å„ªåŒ–å™¨å¯ç”¨å¿«å–
SET random_page_cost = 1.1;       -- SSD ç’°å¢ƒé™ä½éš¨æ©Ÿè®€å–æˆæœ¬
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [M11 åŠŸèƒ½éœ€æ±‚](../specs/functional/M11-é‡åŒ–ç­–ç•¥åŠŸèƒ½éœ€æ±‚.md)
- [M11 è³‡æ–™åº«è¨­è¨ˆ](./M11-è³‡æ–™åº«è¨­è¨ˆ.md)
- [M11 Jobæ’ç¨‹é…ç½®](../deployment/M11-Jobæ’ç¨‹é…ç½®.md)
- [NFRéåŠŸèƒ½æ€§éœ€æ±‚](../specs/technical/00-NFRéåŠŸèƒ½æ€§éœ€æ±‚.md)

---

**æ–‡ä»¶ç¶­è­·è€…**: æ•ˆèƒ½å·¥ç¨‹å¸«
**æœ€å¾Œæ›´æ–°**: 2026-01-14
**ä¸‹æ¬¡å¯©æ ¸**: 2026-04-14
