# M09-籌碼分析模組業務流程

> **文件編號**: BIZ-M09
> **模組名稱**: 籌碼分析模組
> **版本**: v1.0
> **最後更新**: 2026-01-11
> **狀態**: Draft

---

## 📋 業務流程總覽

本文件定義籌碼分析模組的核心業務流程與引擎運作機制。

---

## 1. 籌碼計算引擎架構

### 1.1 引擎設計（參考 M07/M08 模式）

```
┌─────────────────────────────────────────────────────────────────┐
│                      ChipEngine（引擎介面）                       │
│  ┌────────────────────────────────────────────────────────┐    │
│  │               DefaultChipEngine                         │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │         ChipCalculatorRegistry                    │  │    │
│  │  │  ┌────────────────────────────────────────────┐  │  │    │
│  │  │  │         ChipCalculator 介面                 │  │  │    │
│  │  │  │  ┌────────┐ ┌────────┐ ┌──────────────┐   │  │  │    │
│  │  │  │  │Institu-│ │ Margin │ │Concentration │   │  │  │    │
│  │  │  │  │ tional │ │Calcul- │ │  Calculator  │   │  │  │    │
│  │  │  │  │Calcul- │ │  ator  │ │              │   │  │  │    │
│  │  │  │  │  ator  │ │        │ │              │   │  │  │    │
│  │  │  │  └────────┘ └────────┘ └──────────────┘   │  │  │    │
│  │  │  │  ┌────────┐ ┌────────────────────────┐    │  │  │    │
│  │  │  │  │  Cost  │ │    SignalDetector      │    │  │  │    │
│  │  │  │  │Calcul- │ │  ┌─────┐ ┌─────────┐   │    │  │  │    │
│  │  │  │  │  ator  │ │  │Inst.│ │ Margin  │   │    │  │  │    │
│  │  │  │  │        │ │  │Sig. │ │  Sig.   │   │    │  │  │    │
│  │  │  │  └────────┘ │  └─────┘ └─────────┘   │    │  │  │    │
│  │  │  │             └────────────────────────┘    │  │  │    │
│  │  │  └────────────────────────────────────────────┘  │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 計算器分類

| 類別 | Category | 包含計算器 | 說明 |
|-----|----------|-----------|------|
| 三大法人 | INSTITUTIONAL | ForeignNetCalculator, TrustNetCalculator, DealerNetCalculator, ContinuousDaysCalculator, AccumulatedCalculator | 法人買賣超相關指標 |
| 融資融券 | MARGIN | MarginBalanceCalculator, MarginUsageCalculator, ShortBalanceCalculator, MarginShortRatioCalculator | 融資融券相關指標 |
| 籌碼集中度 | CONCENTRATION | ConcentrationCalculator, ConcentrationTrendCalculator | 籌碼分布分析 |
| 成本估算 | COST | CostEstimationCalculator | 主力成本估算 |
| 訊號偵測 | SIGNAL | InstitutionalSignalDetector, MarginSignalDetector, CompositeSignalDetector | 異常訊號偵測 |

### 1.3 計算計劃（ChipCalculationPlan）

```java
public class ChipCalculationPlan {
    private boolean includeInstitutional = true;   // 三大法人指標
    private boolean includeMargin = true;          // 融資融券指標
    private boolean includeConcentration = true;   // 籌碼集中度
    private boolean includeCost = false;           // 成本估算（選用）
    private boolean includeSignals = true;         // 異常訊號偵測
    private int lookbackPeriod = 60;               // 回溯天數

    // 預設計劃：完整計算
    public static ChipCalculationPlan full() {
        return ChipCalculationPlan.builder()
            .includeInstitutional(true)
            .includeMargin(true)
            .includeConcentration(true)
            .includeCost(true)
            .includeSignals(true)
            .lookbackPeriod(120)
            .build();
    }

    // 快速計劃：只計算核心指標
    public static ChipCalculationPlan quick() {
        return ChipCalculationPlan.builder()
            .includeInstitutional(true)
            .includeMargin(true)
            .includeConcentration(false)
            .includeCost(false)
            .includeSignals(false)
            .lookbackPeriod(20)
            .build();
    }
}
```

---

## 2. 核心業務流程

### 2.1 籌碼分析計算流程

```
┌─────────────────────────────────────────────────────────────────┐
│                  籌碼分析計算流程                                 │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────┐
│   1. 接收計算請求    │ ← ChipAnalysisRequest (stockId, plan)
└─────────────────────┘
        │
        ▼
┌─────────────────────┐     ┌─────────────────────────────────┐
│   2. 資料準備        │────→│ 從 M06 取得原始資料              │
│                     │     │ - institutional_trading         │
│                     │     │ - margin_trading                │
│                     │     │ - stock_prices                  │
└─────────────────────┘     └─────────────────────────────────┘
        │
        ▼
┌─────────────────────┐
│   3. 建立資料序列    │ ← ChipDataSeries (封裝原始資料)
└─────────────────────┘
        │
        ▼
┌─────────────────────┐     ┌─────────────────────────────────┐
│   4. 執行計算引擎    │────→│ DefaultChipEngine.compute()     │
│                     │     │ - 遍歷註冊的計算器               │
│                     │     │ - 依計劃篩選要執行的計算器        │
│                     │     │ - 收集計算結果與診斷資訊          │
└─────────────────────┘     └─────────────────────────────────┘
        │
        ▼
┌─────────────────────┐
│  4.1 三大法人計算    │ ← InstitutionalCalculator
│   - 買賣超計算       │
│   - 移動平均計算     │
│   - 連續天數計算     │
│   - 累計計算         │
└─────────────────────┘
        │
        ▼
┌─────────────────────┐
│  4.2 融資融券計算    │ ← MarginCalculator
│   - 餘額變化計算     │
│   - 使用率計算       │
│   - 券資比計算       │
└─────────────────────┘
        │
        ▼
┌─────────────────────┐
│  4.3 籌碼集中度計算  │ ← ConcentrationCalculator
│   - 法人持股比估算   │
│   - 集中趨勢分析     │
└─────────────────────┘
        │
        ▼
┌─────────────────────┐
│  4.4 異常訊號偵測    │ ← SignalDetector
│   - 統計異常檢測     │
│   - 規則式檢測       │
│   - 產生訊號記錄     │
└─────────────────────┘
        │
        ▼
┌─────────────────────┐
│   5. 彙整計算結果    │ ← ChipAnalysisResult
└─────────────────────┘
        │
        ▼
┌─────────────────────┐     ┌─────────────────────────────────┐
│   6. 儲存結果        │────→│ chip_analysis_results (UPSERT)  │
│                     │     │ chip_signals (INSERT)           │
└─────────────────────┘     └─────────────────────────────────┘
        │
        ▼
┌─────────────────────┐
│   7. 更新快取        │ ← Redis Cache
└─────────────────────┘
        │
        ▼
┌─────────────────────┐
│   8. 回傳結果        │
└─────────────────────┘
```

---

### 2.2 連續買超天數計算演算法

```
演算法：計算連續買超/賣超天數

輸入：
  - stock_id: 股票代碼
  - trade_dates[]: 交易日期陣列（降序排列，最新在前）
  - net_values[]: 買賣超數值陣列

輸出：
  - continuous_days: 連續天數（正數表示連續買超，負數表示連續賣超）

演算法：
┌────────────────────────────────────────────────────────────┐
│ 1. 取得最新一日的買賣超方向                                   │
│    direction = net_values[0] > 0 ? 1 : -1                  │
│                                                            │
│ 2. 從最新日期往前遍歷                                        │
│    count = 0                                               │
│    for i = 0 to len(net_values) - 1:                       │
│        if direction == 1 and net_values[i] > 0:            │
│            count++                                         │
│        else if direction == -1 and net_values[i] < 0:      │
│            count++                                         │
│        else:                                               │
│            break  // 方向改變，停止計算                       │
│                                                            │
│ 3. 回傳結果                                                 │
│    return direction * count                                │
└────────────────────────────────────────────────────────────┘

範例：
  net_values = [5000, 3000, -2000, 4000, 1000]
  direction = 1 (最新是買超)
  遍歷: 5000(+1), 3000(+1), -2000(停止)
  結果: continuous_days = 2
```

---

### 2.3 異常訊號偵測演算法

```
演算法：統計異常偵測（Z-Score 方法）

輸入：
  - current_value: 當前數值
  - historical_values[]: 歷史數值（N日）
  - threshold: Z-Score 門檻（預設 2.0）

輸出：
  - is_anomaly: 是否異常
  - deviation: 偏離程度（標準差倍數）
  - severity: 嚴重度

演算法：
┌────────────────────────────────────────────────────────────┐
│ 1. 計算統計量                                               │
│    mean = avg(historical_values)                           │
│    std = stddev(historical_values)                         │
│                                                            │
│ 2. 計算 Z-Score                                            │
│    if std == 0:                                            │
│        z_score = 0                                         │
│    else:                                                   │
│        z_score = (current_value - mean) / std              │
│                                                            │
│ 3. 判斷異常                                                 │
│    deviation = abs(z_score)                                │
│    is_anomaly = deviation >= threshold                     │
│                                                            │
│ 4. 決定嚴重度                                               │
│    if deviation >= 3.0:                                    │
│        severity = CRITICAL                                 │
│    else if deviation >= 2.5:                               │
│        severity = HIGH                                     │
│    else if deviation >= 2.0:                               │
│        severity = MEDIUM                                   │
│    else:                                                   │
│        severity = LOW                                      │
└────────────────────────────────────────────────────────────┘

訊號產生規則：
┌─────────────────────────────────────────────────────────────┐
│ CHIP_SIG_001 (外資大買):                                     │
│   條件: foreign_net > mean_20 + 2 * std_20                   │
│   嚴重度: HIGH                                               │
│                                                             │
│ CHIP_SIG_003 (外資連續買超):                                  │
│   條件: foreign_continuous_days >= 5                         │
│   嚴重度: MEDIUM                                             │
│                                                             │
│ CHIP_SIG_010 (融資斷頭):                                     │
│   條件: margin_change < -0.1 * margin_balance                │
│   嚴重度: CRITICAL                                           │
└─────────────────────────────────────────────────────────────┘
```

---

### 2.4 主力成本估算演算法

```
演算法：加權平均成本法

輸入：
  - trade_data[]: 交易資料陣列
    - trade_date: 交易日期
    - net_shares: 買賣超股數
    - avg_price: 當日均價（(H+L+C)/3）

輸出：
  - avg_cost: 平均成本
  - holding_shares: 估計持股數

演算法：
┌────────────────────────────────────────────────────────────┐
│ 1. 初始化                                                   │
│    total_cost = 0                                          │
│    total_shares = 0                                        │
│                                                            │
│ 2. 遍歷交易資料（從最舊到最新）                               │
│    for each trade in trade_data:                           │
│        if trade.net_shares > 0:  // 買進                    │
│            total_cost += trade.net_shares * trade.avg_price│
│            total_shares += trade.net_shares                │
│        else:  // 賣出                                       │
│            // 按比例減少成本                                 │
│            if total_shares > 0:                            │
│                sell_ratio = abs(trade.net_shares) / total_ │
│                total_cost *= (1 - sell_ratio)              │
│                total_shares += trade.net_shares            │
│                                                            │
│ 3. 計算平均成本                                             │
│    if total_shares > 0:                                    │
│        avg_cost = total_cost / total_shares                │
│    else:                                                   │
│        avg_cost = NULL                                     │
│                                                            │
│ 4. 回傳結果                                                 │
│    return (avg_cost, total_shares)                         │
└────────────────────────────────────────────────────────────┘
```

---

## 3. 批次計算流程

### 3.1 每日批次籌碼計算 Job

```
┌─────────────────────────────────────────────────────────────────┐
│              JOB-M09-001: 每日籌碼分析批次計算                    │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────┐
│  1. Job 啟動檢查    │
│  - 確認是交易日      │
│  - 確認 M06 同步完成 │
└─────────────────────┘
        │
        ▼
┌─────────────────────┐     ┌─────────────────────────────────┐
│  2. 取得股票清單     │────→│ SELECT stock_id FROM stocks      │
│                     │     │ WHERE is_active = true           │
└─────────────────────┘     └─────────────────────────────────┘
        │
        ▼
┌─────────────────────┐
│  3. 分批處理         │ ← batch_size = 50
│                     │
│  for each batch:    │
│    ┌───────────────┐│
│    │ 3.1 載入資料   ││ ← 載入 N 日歷史資料
│    └───────────────┘│
│           │         │
│           ▼         │
│    ┌───────────────┐│
│    │ 3.2 計算引擎   ││ ← ChipEngine.batchCompute()
│    └───────────────┘│
│           │         │
│           ▼         │
│    ┌───────────────┐│
│    │ 3.3 儲存結果   ││ ← MyBatis 批次 UPSERT
│    └───────────────┘│
└─────────────────────┘
        │
        ▼
┌─────────────────────┐
│  4. 更新排行榜快取   │ ← 計算並快取各類排行榜
└─────────────────────┘
        │
        ▼
┌─────────────────────┐
│  5. 記錄 Job 結果    │
│  - 成功/失敗統計     │
│  - 執行時間          │
└─────────────────────┘
```

---

## 4. 排行榜更新流程

### 4.1 排行榜計算與快取流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    排行榜更新流程                                 │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────┐
│  1. 計算各類排行榜   │
│                     │
│  ┌───────────────┐  │     ┌─────────────────────────────────┐
│  │ 外資買超排行   │──┼────→│ ORDER BY foreign_net DESC       │
│  └───────────────┘  │     │ LIMIT 50                        │
│  ┌───────────────┐  │     └─────────────────────────────────┘
│  │ 投信買超排行   │──┼────→│ ORDER BY trust_net DESC         │
│  └───────────────┘  │     └─────────────────────────────────┘
│  ┌───────────────┐  │     ┌─────────────────────────────────┐
│  │ 融資增減排行   │──┼────→│ ORDER BY margin_change DESC/ASC │
│  └───────────────┘  │     └─────────────────────────────────┘
│  ┌───────────────┐  │     ┌─────────────────────────────────┐
│  │ 連續買超排行   │──┼────→│ ORDER BY continuous_days DESC   │
│  └───────────────┘  │     └─────────────────────────────────┘
│                     │
└─────────────────────┘
        │
        ▼
┌─────────────────────┐
│  2. 儲存至快取表     │ ← chip_rankings_cache (UPSERT)
│     設定過期時間     │ ← expires_at = NOW() + 30 minutes
└─────────────────────┘
        │
        ▼
┌─────────────────────┐
│  3. 更新 Redis 快取  │ ← TTL = 30 minutes
└─────────────────────┘
```

---

## 5. API 查詢流程

### 5.1 籌碼分析查詢流程

```
┌─────────────────────────────────────────────────────────────────┐
│              GET /api/v1/chip/{stockId}/analysis                 │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────┐
│  1. 參數驗證         │
│  - stockId 格式      │
│  - date 範圍         │
└─────────────────────┘
        │
        ▼
┌─────────────────────┐     ┌─────────────────────────────────┐
│  2. 查詢 Redis 快取  │────→│ GET chip:analysis:{stockId}     │
└─────────────────────┘     └─────────────────────────────────┘
        │
        ├── 快取命中 ─────────────────────────────────────┐
        │                                                │
        ▼                                                ▼
┌─────────────────────┐                     ┌─────────────────────┐
│  3. 查詢資料庫       │                     │  直接回傳快取結果     │
│  chip_analysis_     │                     └─────────────────────┘
│  results            │
└─────────────────────┘
        │
        ├── 資料庫有結果 ────────────────────┐
        │                                   │
        ▼                                   ▼
┌─────────────────────┐          ┌─────────────────────┐
│  4. 即時計算         │          │  組裝回應 DTO        │
│  （資料庫無結果時）   │          │  更新 Redis 快取     │
└─────────────────────┘          └─────────────────────┘
        │                                   │
        ▼                                   ▼
┌─────────────────────┐          ┌─────────────────────┐
│  5. 儲存計算結果     │          │  回傳 API 回應       │
└─────────────────────┘          └─────────────────────┘
```

---

## 6. 快取策略

### 6.1 快取層級

```
┌─────────────────────────────────────────────────────────────────┐
│                        快取架構                                  │
└─────────────────────────────────────────────────────────────────┘

         請求
          │
          ▼
┌─────────────────────┐
│   L1: Redis 快取    │ ← TTL: 1-6 小時
│   - 即時查詢結果     │
│   - 排行榜快取       │
└─────────────────────┘
          │
          │ 未命中
          ▼
┌─────────────────────┐
│   L2: DB 快取表     │ ← chip_rankings_cache
│   - 排行榜預計算     │
│   - 降低即時查詢壓力 │
└─────────────────────┘
          │
          │ 未命中
          ▼
┌─────────────────────┐
│   L3: 原始資料表    │ ← chip_analysis_results
│   - 完整計算結果     │
│   - JSONB 詳細指標   │
└─────────────────────┘
          │
          │ 未命中
          ▼
┌─────────────────────┐
│   即時計算          │ ← ChipEngine.compute()
└─────────────────────┘
```

### 6.2 快取 Key 設計

| 快取類型 | Key Pattern | TTL | 說明 |
|---------|-------------|-----|------|
| 單股分析結果 | `chip:analysis:{stockId}:{date}` | 6 小時 | 當日分析結果 |
| 三大法人指標 | `chip:inst:{stockId}:{date}` | 6 小時 | 法人指標 |
| 融資融券指標 | `chip:margin:{stockId}:{date}` | 6 小時 | 融資融券指標 |
| 排行榜 | `chip:rank:{rankType}:{date}:{market}` | 30 分鐘 | 排行榜結果 |
| 異常訊號 | `chip:signals:{date}` | 1 小時 | 當日異常訊號 |

---

## 📚 相關文檔

- [M09 功能需求](../specs/functional/M09-籌碼分析功能需求.md)
- [M09 API規格](../specs/api/M09-API規格.md)
- [M09 資料庫設計](./M09-資料庫設計.md)
- [M09 Job排程配置](../deployment/M09-Job排程配置.md)

---

**文件維護者**: 系統分析師
**最後更新**: 2026-01-11
**下次審核**: 2026-03-31
