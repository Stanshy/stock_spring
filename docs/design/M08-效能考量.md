# M08-åŸºæœ¬é¢åˆ†ææ¨¡çµ„æ•ˆèƒ½è€ƒé‡

> **æ–‡ä»¶ç·¨è™Ÿ**: PERF-M08  
> **æ¨¡çµ„åç¨±**: åŸºæœ¬é¢åˆ†ææ¨¡çµ„  
> **ç‰ˆæœ¬**: v2.0  
> **æœ€å¾Œæ›´æ–°**: 2025-12-31  
> **ç‹€æ…‹**: Draft

---

## 9. æ•ˆèƒ½è€ƒé‡

### 9.1 æ•ˆèƒ½ç›®æ¨™

åƒç…§ç¸½ç¶± NFRï¼š

| æŒ‡æ¨™ | ç›®æ¨™å€¼ | èªªæ˜ |
|-----|-------|------|
| API å›æ‡‰æ™‚é–“ (P95) | < 300ms | å–®ä¸€è‚¡ç¥¨æŸ¥è©¢ |
| API å›æ‡‰æ™‚é–“ (P95) | < 1000ms | æ‰¹æ¬¡æŸ¥è©¢ï¼ˆ10 æª”è‚¡ç¥¨ï¼‰ |
| Job åŸ·è¡Œæ™‚é–“ | < 20 åˆ†é˜ | 2000 æª”è‚¡ç¥¨æŒ‡æ¨™è¨ˆç®— |
| è³‡æ–™åº«æŸ¥è©¢æ™‚é–“ (P95) | < 100ms | å–®ä¸€æŸ¥è©¢ |
| Redis å¿«å–å‘½ä¸­ç‡ | > 80% | ç†±é–€è‚¡ç¥¨ |

### 9.2 è³‡æ–™åº«å„ªåŒ–ç­–ç•¥

#### 9.2.1 ç´¢å¼•ç­–ç•¥

**fundamental_indicators è¡¨**:
```sql
-- ä¸»è¦æŸ¥è©¢ç´¢å¼•
CREATE INDEX idx_fundamental_indicators_stock_id ON fundamental_indicators(stock_id);
CREATE INDEX idx_fundamental_indicators_year_quarter ON fundamental_indicators(year, quarter);
CREATE INDEX idx_fundamental_indicators_calculation_date ON fundamental_indicators(calculation_date);

-- è¤‡åˆç´¢å¼•ï¼ˆç”¨æ–¼å¸¸è¦‹æŸ¥è©¢æ¨¡å¼ï¼‰
CREATE INDEX idx_fundamental_indicators_stock_year_quarter 
  ON fundamental_indicators(stock_id, year DESC, quarter DESC);

-- GIN ç´¢å¼•ï¼ˆåŠ é€Ÿ JSONB æŸ¥è©¢ï¼‰
CREATE INDEX idx_fundamental_indicators_valuation 
  ON fundamental_indicators USING GIN(valuation_indicators);
CREATE INDEX idx_fundamental_indicators_profitability 
  ON fundamental_indicators USING GIN(profitability_indicators);
```

**financial_scores è¡¨**:
```sql
CREATE INDEX idx_financial_scores_stock_id ON financial_scores(stock_id);
CREATE INDEX idx_financial_scores_year_quarter ON financial_scores(year, quarter);
CREATE INDEX idx_financial_scores_piotroski ON financial_scores(piotroski_f_score DESC);
CREATE INDEX idx_financial_scores_composite ON financial_scores(composite_score DESC);
```

**financial_alerts è¡¨**:
```sql
CREATE INDEX idx_financial_alerts_stock_id ON financial_alerts(stock_id);
CREATE INDEX idx_financial_alerts_severity ON financial_alerts(severity);
CREATE INDEX idx_financial_alerts_status ON financial_alerts(alert_status);
CREATE INDEX idx_financial_alerts_category ON financial_alerts(alert_category);
```

---

#### 9.2.2 æŸ¥è©¢å„ªåŒ–

**å„ªåŒ–ç­–ç•¥ 1: é¿å… N+1 æŸ¥è©¢**
```
éŒ¯èª¤åšæ³•:
FOR EACH stock IN stock_list
  SELECT * FROM fundamental_indicators WHERE stock_id = stock.id
END FOR

æ­£ç¢ºåšæ³•:
SELECT * FROM fundamental_indicators 
WHERE stock_id IN ('2330', '2317', '2454', ...)
```

**å„ªåŒ–ç­–ç•¥ 2: ä½¿ç”¨ JSONB ç´¢å¼•åŠ é€ŸæŸ¥è©¢**
```sql
-- ä½¿ç”¨ GIN ç´¢å¼•æŸ¥è©¢
SELECT stock_id, year, quarter,
       profitability_indicators->>'roe' as roe
FROM fundamental_indicators 
WHERE (profitability_indicators->>'roe')::numeric > 20.0
  AND year = 2024 AND quarter = 3;

-- æ•ˆèƒ½: ä½¿ç”¨ GIN ç´¢å¼•ï¼Œå¿«é€Ÿéæ¿¾
```

**å„ªåŒ–ç­–ç•¥ 3: æ‰¹æ¬¡æŸ¥è©¢æ­·å²è³‡æ–™**
```sql
-- ä¸€æ¬¡æŸ¥è©¢å¤šå­£è³‡æ–™
SELECT stock_id, year, quarter, roe, eps_growth
FROM fundamental_indicators 
WHERE stock_id = '2330'
  AND (year, quarter) >= (2020, 1)
  AND (year, quarter) <= (2024, 3)
ORDER BY year DESC, quarter DESC;
```

---

#### 9.2.3 æ‰¹æ¬¡å¯«å…¥å„ªåŒ–

**MyBatis æ‰¹æ¬¡ UPSERT**:
```xml
<insert id="batchUpsert" parameterType="java.util.List">
  INSERT INTO fundamental_indicators (
    stock_id, year, quarter, report_type,
    valuation_indicators, profitability_indicators,
    pe_ratio, pb_ratio, roe, eps
  ) VALUES
  <foreach collection="list" item="item" separator=",">
    (
      #{item.stockId}, #{item.year}, #{item.quarter}, #{item.reportType},
      #{item.valuationIndicators}::jsonb, #{item.profitabilityIndicators}::jsonb,
      #{item.peRatio}, #{item.pbRatio}, #{item.roe}, #{item.eps}
    )
  </foreach>
  ON CONFLICT (stock_id, year, quarter, report_type)
  DO UPDATE SET
    valuation_indicators = EXCLUDED.valuation_indicators,
    profitability_indicators = EXCLUDED.profitability_indicators,
    pe_ratio = EXCLUDED.pe_ratio,
    pb_ratio = EXCLUDED.pb_ratio,
    roe = EXCLUDED.roe,
    eps = EXCLUDED.eps,
    updated_at = CURRENT_TIMESTAMP;
</insert>
```

**æ‰¹æ¬¡å¤§å°**:
- æ¯æ‰¹ 20-50 ç­†ï¼ˆå¹³è¡¡è¨˜æ†¶é«”èˆ‡æ•ˆèƒ½ï¼‰
- ä½¿ç”¨ Transaction ä¿è­·æ¯æ‰¹æ¬¡
- æ‰¹æ¬¡å¤±æ•—å¾Œé‡è©¦å–®ç­†ï¼ˆéš”é›¢éŒ¯èª¤ï¼‰

---

### 9.3 å¿«å–å„ªåŒ–ç­–ç•¥

#### 9.3.1 å¿«å–å±¤æ¬¡è¨­è¨ˆ

**L1 å¿«å–ï¼ˆæ‡‰ç”¨å±¤ï¼‰**:
- ä½¿ç”¨ Caffeine æœ¬æ©Ÿå¿«å–
- å¿«å–æŒ‡æ¨™å®šç¾©ã€åƒæ•¸é…ç½®
- TTL: æ°¸ä¹…ï¼ˆé…ç½®è®Šæ›´æ™‚ä¸»å‹•å¤±æ•ˆï¼‰

**L2 å¿«å–ï¼ˆRedisï¼‰**:
- å¿«å–ç†±é–€è‚¡ç¥¨è²¡å‹™æŒ‡æ¨™
- å¿«å–ç¶œåˆè©•åˆ†
- å¿«å–æŒ‡æ¨™æ­·å²è¶¨å‹¢

**å¿«å– Key è¨­è¨ˆ**:
```
fund:indicators:{stock_id}:{year}:{quarter}        â†’ å–®å­£æ‰€æœ‰æŒ‡æ¨™
fund:score:{stock_id}:{year}:{quarter}             â†’ ç¶œåˆè©•åˆ†
fund:trend:{stock_id}:{indicator}:20q              â†’ 20å­£è¶¨å‹¢
fund:hot:stocks                                    â†’ ç†±é–€è‚¡ç¥¨æ¸…å–®
```

---

#### 9.3.2 å¿«å–æ›´æ–°ç­–ç•¥

**ç­–ç•¥ 1: ä¸»å‹•æ›´æ–°ï¼ˆWrite-Throughï¼‰**
```
ç•¶è²¡å‹™æŒ‡æ¨™è¨ˆç®—å®Œæˆæ™‚:
1. å¯«å…¥è³‡æ–™åº«
2. åŒæ­¥å¯«å…¥ Redis å¿«å–
3. è¨­å®š TTL = 24 å°æ™‚
```

**ç­–ç•¥ 2: å¤±æ•ˆæ›´æ–°ï¼ˆCache-Asideï¼‰**
```
ç•¶æŸ¥è©¢æ™‚:
1. æª¢æŸ¥ Redis å¿«å–
2. è‹¥å‘½ä¸­ï¼Œè¿”å›å¿«å–çµæœ
3. è‹¥æœªå‘½ä¸­ï¼ŒæŸ¥è©¢è³‡æ–™åº«
4. å°‡çµæœå¯«å…¥ Redisï¼ˆTTL = 24 å°æ™‚ï¼‰
5. è¿”å›çµæœ
```

**ç­–ç•¥ 3: å®šæœŸé ç†±**
```
æ¯é€±ä¸€ 11:30ï¼ˆJOB-M08-005ï¼‰:
1. æŸ¥è©¢å¸‚å€¼å‰ 50 æª”è‚¡ç¥¨
2. æ‰¹æ¬¡è¼‰å…¥æœ€æ–° 4 å­£è²¡å‹™æŒ‡æ¨™
3. æ‰¹æ¬¡å¯«å…¥ Redis
4. è¨­å®š TTL = 24 å°æ™‚
```

---

#### 9.3.3 å¿«å–å¤±æ•ˆç­–ç•¥

**è‡ªå‹•å¤±æ•ˆ**:
- TTL åˆ°æœŸè‡ªå‹•å¤±æ•ˆ
- LRU æ¼”ç®—æ³•æ·˜æ±°å†·è³‡æ–™

**ä¸»å‹•å¤±æ•ˆ**:
- è²¡å‹™æŒ‡æ¨™é‡æ–°è¨ˆç®—å®Œæˆ â†’ åˆªé™¤èˆŠå¿«å–
- è²¡å ±è³‡æ–™ä¿®æ­£ â†’ åˆªé™¤ç›¸é—œå¿«å–

**æ‰¹æ¬¡å¤±æ•ˆ**:
```java
// åˆªé™¤æŸè‚¡ç¥¨æ‰€æœ‰å¿«å–
public void invalidateStockCache(String stockId) {
    Set<String> keys = redisTemplate.keys("fund:*:" + stockId + ":*");
    if (keys != null && !keys.isEmpty()) {
        redisTemplate.delete(keys);
    }
}
```

---

### 9.4 Job æ•ˆèƒ½å„ªåŒ–

#### 9.4.1 ä¸¦è¡Œè™•ç†

**ç­–ç•¥**:
- ä½¿ç”¨ Java ExecutorService ä¸¦è¡Œè™•ç†
- å·¥ä½œåŸ·è¡Œç·’æ± å¤§å°: 5-10 å€‹åŸ·è¡Œç·’
- æ¯å€‹åŸ·è¡Œç·’è™•ç†ä¸€æ‰¹è‚¡ç¥¨ï¼ˆ20 æª”ï¼‰

**ç¯„ä¾‹æ¶æ§‹**:
```
Job ä¸»åŸ·è¡Œç·’:
  â”œâ”€ æŸ¥è©¢å¾…è™•ç†è‚¡ç¥¨æ¸…å–® (2000 æª”)
  â”œâ”€ åˆ†æ‰¹ (æ¯æ‰¹ 20 æª”ï¼Œå…± 100 æ‰¹)
  â”œâ”€ æäº¤è‡³åŸ·è¡Œç·’æ±  (5 å€‹å·¥ä½œåŸ·è¡Œç·’)
  â”‚    â”œâ”€ Worker 1: è™•ç†æ‰¹æ¬¡ 1-20
  â”‚    â”œâ”€ Worker 2: è™•ç†æ‰¹æ¬¡ 21-40
  â”‚    â”œâ”€ Worker 3: è™•ç†æ‰¹æ¬¡ 41-60
  â”‚    â”œâ”€ Worker 4: è™•ç†æ‰¹æ¬¡ 61-80
  â”‚    â””â”€ Worker 5: è™•ç†æ‰¹æ¬¡ 81-100
  â””â”€ ç­‰å¾…æ‰€æœ‰æ‰¹æ¬¡å®Œæˆ
```

---

#### 9.4.2 å¢é‡è¨ˆç®—

**ç­–ç•¥**:
- åªè¨ˆç®—æ–°å¢æˆ–æ›´æ–°çš„è²¡å ±
- ä½¿ç”¨ updated_at æ¬„ä½åˆ¤æ–·

**SQL é‚è¼¯**:
```sql
-- æŸ¥è©¢æœ€è¿‘ä¸€é€±æ–°å¢æˆ–æ›´æ–°çš„è²¡å ±
SELECT stock_id, year, quarter
FROM financial_statements
WHERE updated_at > (SELECT MAX(end_time) FROM job_executions WHERE job_name = 'CALCULATE_FUNDAMENTALS')
  OR updated_at > CURRENT_TIMESTAMP - INTERVAL '7 days';
```

**æ•ˆç›Š**:
- å¹³æ™‚æ¯é€±åªéœ€è¨ˆç®— 50-100 æª”è‚¡ç¥¨
- ç¯€çœ 95% è¨ˆç®—æ™‚é–“

---

### 9.5 å®¹é‡è¦åŠƒ

**è³‡æ–™è¡¨å®¹é‡ä¼°ç®—**:

| è³‡æ–™è¡¨ | æ¯ç­†å¤§å° | æ¯å­£æ–°å¢ | æ¯å¹´æ–°å¢ | 5å¹´ç¸½é‡ |
|-------|---------|---------|---------|---------|
| fundamental_indicators | 5 KB | 2000 ç­† | 8000 ç­† | 40000 ç­† (200 MB) |
| financial_scores | 2 KB | 2000 ç­† | 8000 ç­† | 40000 ç­† (80 MB) |
| financial_alerts | 1 KB | 500 ç­† | 2000 ç­† | 10000 ç­† (10 MB) |

**Redis å®¹é‡ä¼°ç®—**:
- ç†±é–€è‚¡ç¥¨ 50 æª” Ã— 4 å­£ Ã— 5 KB = 1 MB
- æŒ‡æ¨™è¶¨å‹¢ 50 æª” Ã— 10 æŒ‡æ¨™ Ã— 2 KB = 1 MB
- ç¸½è¨ˆ: ç´„ 5 MBï¼ˆå«å…¶ä»–å¿«å–ï¼‰

**è³‡æ–™åº«é€£æ¥æ± é…ç½®**:
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

---



---

## ğŸ“š ç›¸é—œæ–‡æª”

- [M08 åŠŸèƒ½éœ€æ±‚](../specs/functional/M08-åŸºæœ¬é¢åˆ†æåŠŸèƒ½éœ€æ±‚.md)
- [M08 è³‡æ–™åº«è¨­è¨ˆ](./M08-è³‡æ–™åº«è¨­è¨ˆ.md)
- [M08 Jobæ’ç¨‹é…ç½®](../deployment/M08-Jobæ’ç¨‹é…ç½®.md)
- [NFRéåŠŸèƒ½æ€§éœ€æ±‚](../specs/technical/00-NFRéåŠŸèƒ½æ€§éœ€æ±‚.md)

---

**æ–‡ä»¶ç¶­è­·è€…**: æ•ˆèƒ½å·¥ç¨‹å¸«  
**æœ€å¾Œæ›´æ–°**: 2025-12-31  
**ä¸‹æ¬¡å¯©æ ¸**: 2026-02-28
