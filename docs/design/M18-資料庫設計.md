# M18 投資組合管理 資料庫設計

## 文件資訊
| 項目 | 內容 |
|------|------|
| 模組代號 | M18 |
| 模組名稱 | 投資組合管理 Portfolio Management |
| 資料庫 | PostgreSQL 15+ |
| 文件版本 | 1.0 |
| 建立日期 | 2026-01-15 |

---

## 資料表總覽

| # | 資料表名稱 | 說明 | 預估資料量 |
|---|-----------|------|-----------|
| 1 | portfolios | 投資組合主表 | 1K |
| 2 | portfolio_target_allocations | 目標配置 | 10K |
| 3 | portfolio_positions | 持倉表 | 10K |
| 4 | portfolio_position_lots | 成本批次 | 50K |
| 5 | portfolio_trades | 交易記錄 | 100K |
| 6 | portfolio_snapshots | 投組快照 | 500K |
| 7 | portfolio_snapshot_positions | 快照持倉明細 | 2M |
| 8 | portfolio_performance | 績效記錄 | 500K |
| 9 | portfolio_signal_subscriptions | 信號訂閱 | 5K |
| 10 | portfolio_cash_transactions | 現金異動 | 50K |
| 11 | portfolio_dividends | 股利記錄 | 20K |
| 12 | portfolio_reports | 報告記錄 | 10K |
| 13 | portfolio_benchmarks | 基準定義 | 100 |
| 14 | portfolio_attributions | 績效歸因 | 50K |

---

## 資料表詳細設計

### 1. portfolios（投資組合主表）

儲存投資組合基本資訊與設定。

```sql
CREATE TABLE portfolios (
    id                    VARCHAR(32) PRIMARY KEY,
    name                  VARCHAR(100) NOT NULL,
    description           VARCHAR(500),
    currency              VARCHAR(3) DEFAULT 'TWD',
    benchmark_id          VARCHAR(20),
    initial_cash          DECIMAL(15,2) NOT NULL DEFAULT 0,
    cash_balance          DECIMAL(15,2) NOT NULL DEFAULT 0,
    total_value           DECIMAL(15,2) DEFAULT 0,
    market_value          DECIMAL(15,2) DEFAULT 0,
    unrealized_pnl        DECIMAL(15,2) DEFAULT 0,
    realized_pnl          DECIMAL(15,2) DEFAULT 0,
    status                VARCHAR(20) DEFAULT 'ACTIVE',
    -- 設定
    rebalance_threshold   DECIMAL(5,4) DEFAULT 0.05,
    auto_rebalance        BOOLEAN DEFAULT FALSE,
    track_dividends       BOOLEAN DEFAULT TRUE,
    dividend_reinvest     BOOLEAN DEFAULT FALSE,
    -- 統計
    position_count        INTEGER DEFAULT 0,
    total_deposits        DECIMAL(15,2) DEFAULT 0,
    total_withdrawals     DECIMAL(15,2) DEFAULT 0,
    -- 時間戳
    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    closed_at             TIMESTAMP WITH TIME ZONE,

    CONSTRAINT chk_portfolio_status CHECK (status IN ('ACTIVE', 'CLOSED', 'SUSPENDED'))
);

-- 索引
CREATE INDEX idx_portfolios_status ON portfolios(status);
CREATE INDEX idx_portfolios_benchmark ON portfolios(benchmark_id);
CREATE INDEX idx_portfolios_created ON portfolios(created_at DESC);

-- 註解
COMMENT ON TABLE portfolios IS '投資組合主表';
COMMENT ON COLUMN portfolios.rebalance_threshold IS '再平衡閾值（權重偏離百分比）';
```

---

### 2. portfolio_target_allocations（目標配置）

儲存投資組合的目標資產配置。

```sql
CREATE TABLE portfolio_target_allocations (
    id                VARCHAR(32) PRIMARY KEY,
    portfolio_id      VARCHAR(32) NOT NULL REFERENCES portfolios(id),
    stock_id          VARCHAR(20) NOT NULL,
    target_weight     DECIMAL(5,4) NOT NULL,
    min_weight        DECIMAL(5,4),
    max_weight        DECIMAL(5,4),
    priority          INTEGER DEFAULT 0,
    notes             VARCHAR(200),
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uk_portfolio_target_stock UNIQUE (portfolio_id, stock_id),
    CONSTRAINT chk_target_weight CHECK (target_weight >= 0 AND target_weight <= 1),
    CONSTRAINT chk_weight_range CHECK (min_weight <= target_weight AND target_weight <= max_weight)
);

-- 索引
CREATE INDEX idx_target_alloc_portfolio ON portfolio_target_allocations(portfolio_id);

-- 註解
COMMENT ON TABLE portfolio_target_allocations IS '投資組合目標配置';
COMMENT ON COLUMN portfolio_target_allocations.target_weight IS '目標權重 (0-1)';
```

---

### 3. portfolio_positions（持倉表）

儲存當前持倉狀態，使用移動加權平均成本計算。

```sql
CREATE TABLE portfolio_positions (
    id                VARCHAR(32) PRIMARY KEY,
    portfolio_id      VARCHAR(32) NOT NULL REFERENCES portfolios(id),
    stock_id          VARCHAR(20) NOT NULL,
    shares            DECIMAL(15,4) NOT NULL DEFAULT 0,
    avg_cost          DECIMAL(12,4) NOT NULL DEFAULT 0,
    total_cost        DECIMAL(15,2) NOT NULL DEFAULT 0,
    current_price     DECIMAL(12,4),
    market_value      DECIMAL(15,2),
    weight            DECIMAL(5,4),
    unrealized_pnl    DECIMAL(15,2),
    unrealized_pnl_pct DECIMAL(8,4),
    realized_pnl      DECIMAL(15,2) DEFAULT 0,
    -- 統計
    first_buy_date    DATE,
    last_trade_date   DATE,
    total_bought      DECIMAL(15,4) DEFAULT 0,
    total_sold        DECIMAL(15,4) DEFAULT 0,
    total_dividends   DECIMAL(15,2) DEFAULT 0,
    -- 時間戳
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uk_position_portfolio_stock UNIQUE (portfolio_id, stock_id),
    CONSTRAINT chk_position_shares CHECK (shares >= 0)
);

-- 索引
CREATE INDEX idx_positions_portfolio ON portfolio_positions(portfolio_id);
CREATE INDEX idx_positions_stock ON portfolio_positions(stock_id);
CREATE INDEX idx_positions_weight ON portfolio_positions(portfolio_id, weight DESC);

-- 註解
COMMENT ON TABLE portfolio_positions IS '投資組合持倉表';
COMMENT ON COLUMN portfolio_positions.avg_cost IS '移動加權平均成本';
```

---

### 4. portfolio_position_lots（成本批次）

儲存每筆買入的成本批次，用於 FIFO/LIFO 賣出計算。

```sql
CREATE TABLE portfolio_position_lots (
    id                VARCHAR(32) PRIMARY KEY,
    portfolio_id      VARCHAR(32) NOT NULL REFERENCES portfolios(id),
    position_id       VARCHAR(32) NOT NULL REFERENCES portfolio_positions(id),
    stock_id          VARCHAR(20) NOT NULL,
    trade_id          VARCHAR(32) REFERENCES portfolio_trades(id),
    purchase_date     DATE NOT NULL,
    original_shares   DECIMAL(15,4) NOT NULL,
    remaining_shares  DECIMAL(15,4) NOT NULL,
    cost_per_share    DECIMAL(12,4) NOT NULL,
    total_cost        DECIMAL(15,2) NOT NULL,
    status            VARCHAR(20) DEFAULT 'OPEN',
    closed_date       DATE,
    realized_pnl      DECIMAL(15,2),
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_lot_shares CHECK (remaining_shares >= 0 AND remaining_shares <= original_shares),
    CONSTRAINT chk_lot_status CHECK (status IN ('OPEN', 'PARTIAL', 'CLOSED'))
);

-- 索引
CREATE INDEX idx_lots_position ON portfolio_position_lots(position_id);
CREATE INDEX idx_lots_portfolio_stock ON portfolio_position_lots(portfolio_id, stock_id);
CREATE INDEX idx_lots_status ON portfolio_position_lots(status) WHERE status != 'CLOSED';
CREATE INDEX idx_lots_purchase_date ON portfolio_position_lots(purchase_date);

-- 註解
COMMENT ON TABLE portfolio_position_lots IS '持倉成本批次（用於 FIFO/LIFO 計算）';
```

---

### 5. portfolio_trades（交易記錄）

儲存所有交易明細。

```sql
CREATE TABLE portfolio_trades (
    id                VARCHAR(32) PRIMARY KEY,
    portfolio_id      VARCHAR(32) NOT NULL REFERENCES portfolios(id),
    stock_id          VARCHAR(20) NOT NULL,
    trade_date        DATE NOT NULL,
    trade_time        TIME,
    trade_type        VARCHAR(20) NOT NULL,
    shares            DECIMAL(15,4) NOT NULL,
    price             DECIMAL(12,4) NOT NULL,
    gross_amount      DECIMAL(15,2) NOT NULL,
    fees              DECIMAL(10,2) DEFAULT 0,
    tax               DECIMAL(10,2) DEFAULT 0,
    net_amount        DECIMAL(15,2) NOT NULL,
    -- 成交後狀態
    position_shares   DECIMAL(15,4),
    position_avg_cost DECIMAL(12,4),
    cash_before       DECIMAL(15,2),
    cash_after        DECIMAL(15,2),
    realized_pnl      DECIMAL(15,2),
    -- 其他
    notes             VARCHAR(500),
    reference_id      VARCHAR(50),
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_trade_type CHECK (trade_type IN (
        'BUY', 'SELL', 'DIVIDEND_REINVEST', 'STOCK_DIVIDEND',
        'SPLIT', 'TRANSFER_IN', 'TRANSFER_OUT'
    )),
    CONSTRAINT chk_trade_shares CHECK (shares > 0)
);

-- 索引
CREATE INDEX idx_trades_portfolio ON portfolio_trades(portfolio_id);
CREATE INDEX idx_trades_portfolio_date ON portfolio_trades(portfolio_id, trade_date DESC);
CREATE INDEX idx_trades_stock ON portfolio_trades(stock_id);
CREATE INDEX idx_trades_type ON portfolio_trades(trade_type);
CREATE INDEX idx_trades_date ON portfolio_trades(trade_date DESC);

-- 註解
COMMENT ON TABLE portfolio_trades IS '投資組合交易記錄';
COMMENT ON COLUMN portfolio_trades.net_amount IS '淨金額（含費用稅金）';
```

---

### 6. portfolio_snapshots（投組快照）

每日收盤後儲存投組快照。

```sql
CREATE TABLE portfolio_snapshots (
    id                VARCHAR(32) PRIMARY KEY,
    portfolio_id      VARCHAR(32) NOT NULL REFERENCES portfolios(id),
    snapshot_date     DATE NOT NULL,
    snapshot_time     TIME DEFAULT '13:30:00',
    -- 價值
    total_value       DECIMAL(15,2) NOT NULL,
    market_value      DECIMAL(15,2) NOT NULL,
    cash_balance      DECIMAL(15,2) NOT NULL,
    -- 損益
    unrealized_pnl    DECIMAL(15,2),
    realized_pnl      DECIMAL(15,2),
    daily_pnl         DECIMAL(15,2),
    daily_return      DECIMAL(8,6),
    -- 統計
    position_count    INTEGER,
    cumulative_return DECIMAL(10,6),
    -- 現金流
    cash_inflow       DECIMAL(15,2) DEFAULT 0,
    cash_outflow      DECIMAL(15,2) DEFAULT 0,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uk_snapshot_portfolio_date UNIQUE (portfolio_id, snapshot_date)
);

-- 索引
CREATE INDEX idx_snapshots_portfolio ON portfolio_snapshots(portfolio_id);
CREATE INDEX idx_snapshots_date ON portfolio_snapshots(snapshot_date DESC);
CREATE INDEX idx_snapshots_portfolio_date ON portfolio_snapshots(portfolio_id, snapshot_date DESC);

-- 分區（按月）
-- CREATE TABLE portfolio_snapshots_2026_01 PARTITION OF portfolio_snapshots
--     FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');

-- 註解
COMMENT ON TABLE portfolio_snapshots IS '投資組合每日快照';
```

---

### 7. portfolio_snapshot_positions（快照持倉明細）

每日快照的持倉詳細資訊。

```sql
CREATE TABLE portfolio_snapshot_positions (
    id                VARCHAR(32) PRIMARY KEY,
    snapshot_id       VARCHAR(32) NOT NULL REFERENCES portfolio_snapshots(id),
    portfolio_id      VARCHAR(32) NOT NULL,
    snapshot_date     DATE NOT NULL,
    stock_id          VARCHAR(20) NOT NULL,
    shares            DECIMAL(15,4) NOT NULL,
    avg_cost          DECIMAL(12,4) NOT NULL,
    close_price       DECIMAL(12,4) NOT NULL,
    market_value      DECIMAL(15,2) NOT NULL,
    weight            DECIMAL(5,4),
    unrealized_pnl    DECIMAL(15,2),
    daily_change      DECIMAL(12,4),
    daily_change_pct  DECIMAL(8,6),

    CONSTRAINT uk_snapshot_pos UNIQUE (snapshot_id, stock_id)
);

-- 索引
CREATE INDEX idx_snap_pos_snapshot ON portfolio_snapshot_positions(snapshot_id);
CREATE INDEX idx_snap_pos_portfolio_date ON portfolio_snapshot_positions(portfolio_id, snapshot_date);
CREATE INDEX idx_snap_pos_stock ON portfolio_snapshot_positions(stock_id);

-- 註解
COMMENT ON TABLE portfolio_snapshot_positions IS '快照持倉明細';
```

---

### 8. portfolio_performance（績效記錄）

儲存計算好的績效指標。

```sql
CREATE TABLE portfolio_performance (
    id                VARCHAR(32) PRIMARY KEY,
    portfolio_id      VARCHAR(32) NOT NULL REFERENCES portfolios(id),
    calc_date         DATE NOT NULL,
    period_type       VARCHAR(10) NOT NULL,
    period_start      DATE NOT NULL,
    period_end        DATE NOT NULL,
    -- 報酬率
    twr               DECIMAL(10,6),
    twr_annualized    DECIMAL(10,6),
    mwr               DECIMAL(10,6),
    mwr_annualized    DECIMAL(10,6),
    simple_return     DECIMAL(10,6),
    cumulative_return DECIMAL(10,6),
    -- 風險指標
    volatility        DECIMAL(10,6),
    volatility_ann    DECIMAL(10,6),
    sharpe_ratio      DECIMAL(10,6),
    sortino_ratio     DECIMAL(10,6),
    max_drawdown      DECIMAL(10,6),
    max_drawdown_date DATE,
    calmar_ratio      DECIMAL(10,6),
    -- 相對指標
    beta              DECIMAL(10,6),
    alpha             DECIMAL(10,6),
    treynor_ratio     DECIMAL(10,6),
    information_ratio DECIMAL(10,6),
    tracking_error    DECIMAL(10,6),
    -- 基準比較
    benchmark_id      VARCHAR(20),
    benchmark_return  DECIMAL(10,6),
    excess_return     DECIMAL(10,6),
    up_capture        DECIMAL(10,6),
    down_capture      DECIMAL(10,6),
    win_rate          DECIMAL(5,4),
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uk_perf_portfolio_period UNIQUE (portfolio_id, period_type, period_end),
    CONSTRAINT chk_period_type CHECK (period_type IN ('DAILY', 'WEEKLY', 'MONTHLY', 'QUARTERLY', 'YEARLY', 'YTD', 'INCEPTION'))
);

-- 索引
CREATE INDEX idx_perf_portfolio ON portfolio_performance(portfolio_id);
CREATE INDEX idx_perf_date ON portfolio_performance(calc_date DESC);
CREATE INDEX idx_perf_period ON portfolio_performance(period_type, period_end DESC);

-- 註解
COMMENT ON TABLE portfolio_performance IS '投資組合績效指標';
COMMENT ON COLUMN portfolio_performance.twr IS '時間加權報酬率';
COMMENT ON COLUMN portfolio_performance.mwr IS '金額加權報酬率';
```

---

### 9. portfolio_signal_subscriptions（信號訂閱）

儲存投資組合訂閱的信號設定。

```sql
CREATE TABLE portfolio_signal_subscriptions (
    id                VARCHAR(32) PRIMARY KEY,
    portfolio_id      VARCHAR(32) NOT NULL REFERENCES portfolios(id),
    stock_id          VARCHAR(20) NOT NULL,
    signal_types      VARCHAR(500) NOT NULL,
    min_strength      DECIMAL(3,2) DEFAULT 0.5,
    notify_email      BOOLEAN DEFAULT FALSE,
    notify_push       BOOLEAN DEFAULT TRUE,
    status            VARCHAR(20) DEFAULT 'ACTIVE',
    last_triggered_at TIMESTAMP WITH TIME ZONE,
    trigger_count     INTEGER DEFAULT 0,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uk_signal_sub UNIQUE (portfolio_id, stock_id),
    CONSTRAINT chk_sub_status CHECK (status IN ('ACTIVE', 'PAUSED', 'EXPIRED'))
);

-- 索引
CREATE INDEX idx_signal_sub_portfolio ON portfolio_signal_subscriptions(portfolio_id);
CREATE INDEX idx_signal_sub_stock ON portfolio_signal_subscriptions(stock_id);
CREATE INDEX idx_signal_sub_status ON portfolio_signal_subscriptions(status);

-- 註解
COMMENT ON TABLE portfolio_signal_subscriptions IS '投資組合信號訂閱';
COMMENT ON COLUMN portfolio_signal_subscriptions.signal_types IS 'JSON array of signal types';
```

---

### 10. portfolio_cash_transactions（現金異動）

儲存現金帳戶異動記錄。

```sql
CREATE TABLE portfolio_cash_transactions (
    id                VARCHAR(32) PRIMARY KEY,
    portfolio_id      VARCHAR(32) NOT NULL REFERENCES portfolios(id),
    transaction_date  DATE NOT NULL,
    transaction_type  VARCHAR(20) NOT NULL,
    amount            DECIMAL(15,2) NOT NULL,
    balance_before    DECIMAL(15,2) NOT NULL,
    balance_after     DECIMAL(15,2) NOT NULL,
    reference_type    VARCHAR(20),
    reference_id      VARCHAR(50),
    description       VARCHAR(200),
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_cash_type CHECK (transaction_type IN (
        'DEPOSIT', 'WITHDRAWAL', 'TRADE_BUY', 'TRADE_SELL',
        'DIVIDEND', 'INTEREST', 'FEE', 'TAX', 'ADJUSTMENT'
    ))
);

-- 索引
CREATE INDEX idx_cash_tx_portfolio ON portfolio_cash_transactions(portfolio_id);
CREATE INDEX idx_cash_tx_date ON portfolio_cash_transactions(transaction_date DESC);
CREATE INDEX idx_cash_tx_type ON portfolio_cash_transactions(transaction_type);
CREATE INDEX idx_cash_tx_reference ON portfolio_cash_transactions(reference_type, reference_id);

-- 註解
COMMENT ON TABLE portfolio_cash_transactions IS '現金帳戶異動記錄';
```

---

### 11. portfolio_dividends（股利記錄）

儲存股利發放與處理記錄。

```sql
CREATE TABLE portfolio_dividends (
    id                VARCHAR(32) PRIMARY KEY,
    portfolio_id      VARCHAR(32) NOT NULL REFERENCES portfolios(id),
    position_id       VARCHAR(32) REFERENCES portfolio_positions(id),
    stock_id          VARCHAR(20) NOT NULL,
    -- 股利資訊
    ex_date           DATE NOT NULL,
    record_date       DATE,
    pay_date          DATE,
    dividend_type     VARCHAR(10) NOT NULL,
    -- 金額
    shares_held       DECIMAL(15,4) NOT NULL,
    dividend_per_share DECIMAL(10,4) NOT NULL,
    gross_amount      DECIMAL(15,2),
    tax_withheld      DECIMAL(10,2) DEFAULT 0,
    net_amount        DECIMAL(15,2),
    shares_received   DECIMAL(15,4),
    -- 狀態
    status            VARCHAR(20) DEFAULT 'PENDING',
    reinvested        BOOLEAN DEFAULT FALSE,
    reinvest_trade_id VARCHAR(32) REFERENCES portfolio_trades(id),
    processed_at      TIMESTAMP WITH TIME ZONE,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_dividend_type CHECK (dividend_type IN ('CASH', 'STOCK')),
    CONSTRAINT chk_dividend_status CHECK (status IN ('PENDING', 'PAID', 'RECEIVED', 'REINVESTED', 'CANCELLED'))
);

-- 索引
CREATE INDEX idx_dividends_portfolio ON portfolio_dividends(portfolio_id);
CREATE INDEX idx_dividends_stock ON portfolio_dividends(stock_id);
CREATE INDEX idx_dividends_ex_date ON portfolio_dividends(ex_date);
CREATE INDEX idx_dividends_status ON portfolio_dividends(status);
CREATE INDEX idx_dividends_pay_date ON portfolio_dividends(pay_date);

-- 註解
COMMENT ON TABLE portfolio_dividends IS '股利記錄';
```

---

### 12. portfolio_reports（報告記錄）

儲存產生的報告資訊。

```sql
CREATE TABLE portfolio_reports (
    id                VARCHAR(32) PRIMARY KEY,
    portfolio_id      VARCHAR(32) NOT NULL REFERENCES portfolios(id),
    report_type       VARCHAR(20) NOT NULL,
    period_start      DATE,
    period_end        DATE,
    format            VARCHAR(10) DEFAULT 'PDF',
    language          VARCHAR(10) DEFAULT 'zh-TW',
    sections          VARCHAR(500),
    status            VARCHAR(20) DEFAULT 'PENDING',
    file_path         VARCHAR(500),
    file_size         BIGINT,
    error_message     VARCHAR(1000),
    generated_at      TIMESTAMP WITH TIME ZONE,
    expires_at        TIMESTAMP WITH TIME ZONE,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_report_type CHECK (report_type IN (
        'MONTHLY', 'QUARTERLY', 'ANNUAL', 'CUSTOM', 'PERFORMANCE', 'TAX'
    )),
    CONSTRAINT chk_report_status CHECK (status IN ('PENDING', 'GENERATING', 'COMPLETED', 'FAILED', 'EXPIRED'))
);

-- 索引
CREATE INDEX idx_reports_portfolio ON portfolio_reports(portfolio_id);
CREATE INDEX idx_reports_status ON portfolio_reports(status);
CREATE INDEX idx_reports_created ON portfolio_reports(created_at DESC);

-- 註解
COMMENT ON TABLE portfolio_reports IS '投資組合報告';
```

---

### 13. portfolio_benchmarks（基準定義）

儲存可用的績效基準。

```sql
CREATE TABLE portfolio_benchmarks (
    id                VARCHAR(20) PRIMARY KEY,
    name              VARCHAR(100) NOT NULL,
    benchmark_type    VARCHAR(20) NOT NULL,
    description       VARCHAR(500),
    ticker            VARCHAR(20),
    data_source       VARCHAR(50),
    inception_date    DATE,
    is_active         BOOLEAN DEFAULT TRUE,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_benchmark_type CHECK (benchmark_type IN ('ETF', 'INDEX', 'CUSTOM'))
);

-- 初始資料
INSERT INTO portfolio_benchmarks (id, name, benchmark_type, description, ticker) VALUES
('0050', '元大台灣50', 'ETF', '追蹤臺灣50指數', '0050.TW'),
('0051', '元大中型100', 'ETF', '追蹤臺灣中型100指數', '0051.TW'),
('0056', '元大高股息', 'ETF', '追蹤臺灣高股息指數', '0056.TW'),
('TAIEX', '加權股價指數', 'INDEX', '臺灣證券交易所發行量加權股價指數', '^TWII');

-- 註解
COMMENT ON TABLE portfolio_benchmarks IS '績效基準定義';
```

---

### 14. portfolio_attributions（績效歸因）

儲存績效歸因分析結果。

```sql
CREATE TABLE portfolio_attributions (
    id                VARCHAR(32) PRIMARY KEY,
    portfolio_id      VARCHAR(32) NOT NULL REFERENCES portfolios(id),
    calc_date         DATE NOT NULL,
    period_start      DATE NOT NULL,
    period_end        DATE NOT NULL,
    method            VARCHAR(20) DEFAULT 'BRINSON',
    -- 總體歸因
    total_return      DECIMAL(10,6),
    benchmark_return  DECIMAL(10,6),
    active_return     DECIMAL(10,6),
    allocation_effect DECIMAL(10,6),
    selection_effect  DECIMAL(10,6),
    interaction_effect DECIMAL(10,6),
    -- 明細 JSON
    sector_attribution JSONB,
    stock_attribution  JSONB,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uk_attribution UNIQUE (portfolio_id, method, period_end),
    CONSTRAINT chk_attr_method CHECK (method IN ('BRINSON', 'FACTOR', 'RISK'))
);

-- 索引
CREATE INDEX idx_attr_portfolio ON portfolio_attributions(portfolio_id);
CREATE INDEX idx_attr_date ON portfolio_attributions(period_end DESC);

-- 註解
COMMENT ON TABLE portfolio_attributions IS '績效歸因分析';
COMMENT ON COLUMN portfolio_attributions.allocation_effect IS 'Brinson 配置效果';
COMMENT ON COLUMN portfolio_attributions.selection_effect IS 'Brinson 選股效果';
```

---

## JPA Entity 範例

### Portfolio Entity

```java
@Entity
@Table(name = "portfolios")
@EntityListeners(AuditingEntityListener.class)
public class Portfolio {

    @Id
    @Column(length = 32)
    private String id;

    @Column(nullable = false, length = 100)
    private String name;

    @Column(length = 500)
    private String description;

    @Column(length = 3)
    private String currency = "TWD";

    @Column(name = "benchmark_id", length = 20)
    private String benchmarkId;

    @Column(name = "initial_cash", precision = 15, scale = 2)
    private BigDecimal initialCash = BigDecimal.ZERO;

    @Column(name = "cash_balance", precision = 15, scale = 2)
    private BigDecimal cashBalance = BigDecimal.ZERO;

    @Column(name = "total_value", precision = 15, scale = 2)
    private BigDecimal totalValue = BigDecimal.ZERO;

    @Column(name = "market_value", precision = 15, scale = 2)
    private BigDecimal marketValue = BigDecimal.ZERO;

    @Column(name = "unrealized_pnl", precision = 15, scale = 2)
    private BigDecimal unrealizedPnL = BigDecimal.ZERO;

    @Column(name = "realized_pnl", precision = 15, scale = 2)
    private BigDecimal realizedPnL = BigDecimal.ZERO;

    @Enumerated(EnumType.STRING)
    @Column(length = 20)
    private PortfolioStatus status = PortfolioStatus.ACTIVE;

    @Column(name = "rebalance_threshold", precision = 5, scale = 4)
    private BigDecimal rebalanceThreshold = new BigDecimal("0.05");

    @Column(name = "auto_rebalance")
    private Boolean autoRebalance = false;

    @Column(name = "track_dividends")
    private Boolean trackDividends = true;

    @Column(name = "dividend_reinvest")
    private Boolean dividendReinvest = false;

    @OneToMany(mappedBy = "portfolio", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<PortfolioPosition> positions = new ArrayList<>();

    @OneToMany(mappedBy = "portfolio", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<PortfolioTargetAllocation> targetAllocations = new ArrayList<>();

    @CreatedDate
    @Column(name = "created_at")
    private OffsetDateTime createdAt;

    @LastModifiedDate
    @Column(name = "updated_at")
    private OffsetDateTime updatedAt;

    @Column(name = "closed_at")
    private OffsetDateTime closedAt;
}
```

### PortfolioPosition Entity

```java
@Entity
@Table(name = "portfolio_positions")
public class PortfolioPosition {

    @Id
    @Column(length = 32)
    private String id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "portfolio_id", nullable = false)
    private Portfolio portfolio;

    @Column(name = "stock_id", nullable = false, length = 20)
    private String stockId;

    @Column(precision = 15, scale = 4)
    private BigDecimal shares = BigDecimal.ZERO;

    @Column(name = "avg_cost", precision = 12, scale = 4)
    private BigDecimal avgCost = BigDecimal.ZERO;

    @Column(name = "total_cost", precision = 15, scale = 2)
    private BigDecimal totalCost = BigDecimal.ZERO;

    @Column(name = "current_price", precision = 12, scale = 4)
    private BigDecimal currentPrice;

    @Column(name = "market_value", precision = 15, scale = 2)
    private BigDecimal marketValue;

    @Column(precision = 5, scale = 4)
    private BigDecimal weight;

    @Column(name = "unrealized_pnl", precision = 15, scale = 2)
    private BigDecimal unrealizedPnL;

    @Column(name = "unrealized_pnl_pct", precision = 8, scale = 4)
    private BigDecimal unrealizedPnLPct;

    @OneToMany(mappedBy = "position", cascade = CascadeType.ALL)
    private List<PortfolioPositionLot> lots = new ArrayList<>();

    // 計算移動加權平均成本
    public void addShares(BigDecimal newShares, BigDecimal price) {
        BigDecimal newTotalCost = this.shares.multiply(this.avgCost)
            .add(newShares.multiply(price));
        this.shares = this.shares.add(newShares);
        this.avgCost = newTotalCost.divide(this.shares, 4, RoundingMode.HALF_UP);
        this.totalCost = this.shares.multiply(this.avgCost);
    }
}
```

---

## MyBatis Mapper 範例

### PortfolioMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chris.fin_shark.m18.mapper.PortfolioMapper">

    <!-- 查詢投組績效歷史 -->
    <select id="findPerformanceHistory" resultType="PortfolioPerformanceDto">
        SELECT
            snapshot_date as date,
            total_value,
            market_value,
            cash_balance,
            daily_return,
            cumulative_return
        FROM portfolio_snapshots
        WHERE portfolio_id = #{portfolioId}
          AND snapshot_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY snapshot_date
    </select>

    <!-- 計算 TWR (時間加權報酬率) -->
    <select id="calculateTWR" resultType="java.math.BigDecimal">
        WITH daily_returns AS (
            SELECT
                snapshot_date,
                daily_return,
                cash_inflow,
                cash_outflow
            FROM portfolio_snapshots
            WHERE portfolio_id = #{portfolioId}
              AND snapshot_date BETWEEN #{startDate} AND #{endDate}
        )
        SELECT
            EXP(SUM(LN(1 + COALESCE(daily_return, 0)))) - 1 as twr
        FROM daily_returns
    </select>

    <!-- 查詢持倉權重分布 -->
    <select id="findPositionWeights" resultType="PositionWeightDto">
        SELECT
            p.stock_id,
            s.name as stock_name,
            s.industry,
            p.shares,
            p.market_value,
            p.weight,
            p.unrealized_pnl,
            p.unrealized_pnl_pct
        FROM portfolio_positions p
        LEFT JOIN stocks s ON p.stock_id = s.stock_id
        WHERE p.portfolio_id = #{portfolioId}
          AND p.shares > 0
        ORDER BY p.weight DESC
    </select>

    <!-- 查詢產業集中度 -->
    <select id="findIndustryConcentration" resultType="map">
        SELECT
            COALESCE(s.industry, '其他') as industry,
            SUM(p.weight) as total_weight,
            COUNT(*) as position_count
        FROM portfolio_positions p
        LEFT JOIN stocks s ON p.stock_id = s.stock_id
        WHERE p.portfolio_id = #{portfolioId}
          AND p.shares > 0
        GROUP BY COALESCE(s.industry, '其他')
        ORDER BY total_weight DESC
    </select>

    <!-- 查詢再平衡建議 -->
    <select id="findRebalanceRecommendations" resultType="RebalanceRecommendationDto">
        SELECT
            t.stock_id,
            s.name as stock_name,
            COALESCE(p.shares, 0) as current_shares,
            COALESCE(p.weight, 0) as current_weight,
            t.target_weight,
            t.target_weight - COALESCE(p.weight, 0) as deviation,
            CASE
                WHEN t.target_weight > COALESCE(p.weight, 0) THEN 'BUY'
                WHEN t.target_weight < COALESCE(p.weight, 0) THEN 'SELL'
                ELSE 'HOLD'
            END as action
        FROM portfolio_target_allocations t
        LEFT JOIN portfolio_positions p
            ON t.portfolio_id = p.portfolio_id
            AND t.stock_id = p.stock_id
        LEFT JOIN stocks s ON t.stock_id = s.stock_id
        WHERE t.portfolio_id = #{portfolioId}
          AND ABS(t.target_weight - COALESCE(p.weight, 0)) > #{threshold}
        ORDER BY ABS(t.target_weight - COALESCE(p.weight, 0)) DESC
    </select>

    <!-- Brinson 績效歸因：產業配置 -->
    <select id="calculateSectorAttribution" resultType="SectorAttributionDto">
        WITH portfolio_sectors AS (
            SELECT
                COALESCE(s.industry, '其他') as sector,
                SUM(sp.weight) as portfolio_weight,
                SUM(sp.weight * sp.daily_change_pct) / NULLIF(SUM(sp.weight), 0) as portfolio_return
            FROM portfolio_snapshot_positions sp
            JOIN portfolio_snapshots ps ON sp.snapshot_id = ps.id
            LEFT JOIN stocks s ON sp.stock_id = s.stock_id
            WHERE ps.portfolio_id = #{portfolioId}
              AND ps.snapshot_date BETWEEN #{startDate} AND #{endDate}
            GROUP BY COALESCE(s.industry, '其他')
        ),
        benchmark_sectors AS (
            -- 從基準 ETF 成分股計算
            SELECT sector, benchmark_weight, benchmark_return
            FROM benchmark_sector_returns
            WHERE benchmark_id = #{benchmarkId}
              AND date BETWEEN #{startDate} AND #{endDate}
        )
        SELECT
            ps.sector,
            ps.portfolio_weight,
            bs.benchmark_weight,
            ps.portfolio_return,
            bs.benchmark_return,
            (ps.portfolio_weight - bs.benchmark_weight) *
                (bs.benchmark_return - #{totalBenchmarkReturn}) as allocation_effect,
            bs.benchmark_weight *
                (ps.portfolio_return - bs.benchmark_return) as selection_effect
        FROM portfolio_sectors ps
        LEFT JOIN benchmark_sectors bs ON ps.sector = bs.sector
    </select>

    <!-- 股利彙總 -->
    <select id="summarizeDividends" resultType="DividendSummaryDto">
        SELECT
            EXTRACT(YEAR FROM ex_date) as year,
            dividend_type,
            SUM(CASE WHEN dividend_type = 'CASH' THEN net_amount ELSE 0 END) as cash_dividends,
            SUM(CASE WHEN dividend_type = 'STOCK' THEN shares_received ELSE 0 END) as stock_dividends,
            COUNT(*) as dividend_count
        FROM portfolio_dividends
        WHERE portfolio_id = #{portfolioId}
          AND status IN ('PAID', 'RECEIVED', 'REINVESTED')
        GROUP BY EXTRACT(YEAR FROM ex_date), dividend_type
        ORDER BY year DESC
    </select>

</mapper>
```

---

## 索引策略

### 高頻查詢索引

```sql
-- 投組快照查詢（每日績效圖表）
CREATE INDEX idx_snapshots_perf_chart
    ON portfolio_snapshots(portfolio_id, snapshot_date DESC)
    INCLUDE (total_value, daily_return, cumulative_return);

-- 持倉權重查詢（投組總覽）
CREATE INDEX idx_positions_overview
    ON portfolio_positions(portfolio_id, shares)
    INCLUDE (stock_id, market_value, weight, unrealized_pnl)
    WHERE shares > 0;

-- 交易記錄查詢
CREATE INDEX idx_trades_history
    ON portfolio_trades(portfolio_id, trade_date DESC)
    INCLUDE (stock_id, trade_type, shares, price, net_amount);
```

### 分析查詢索引

```sql
-- 績效歸因查詢
CREATE INDEX idx_attr_analysis
    ON portfolio_attributions(portfolio_id, period_end DESC)
    INCLUDE (allocation_effect, selection_effect, active_return);

-- 績效比較查詢
CREATE INDEX idx_perf_comparison
    ON portfolio_performance(portfolio_id, period_type, period_end DESC)
    INCLUDE (twr, sharpe_ratio, max_drawdown, benchmark_return);
```

---

## 資料保留策略

| 資料類型 | 保留期限 | 說明 |
|---------|---------|------|
| portfolio_snapshots | 永久 | 歷史績效數據，可壓縮歸檔 |
| portfolio_snapshot_positions | 3 年 | 超過 3 年移至歸檔表 |
| portfolio_trades | 永久 | 交易記錄須永久保存 |
| portfolio_cash_transactions | 永久 | 現金流記錄須永久保存 |
| portfolio_performance | 5 年 | 定期績效可重新計算 |
| portfolio_reports | 1 年 | 報告檔案過期自動清除 |
| portfolio_attributions | 3 年 | 歸因分析可重新計算 |
