# M08-基本面分析模組測試準則

> **文件編號**: TEST-M08  
> **模組名稱**: 基本面分析模組  
> **版本**: v2.0  
> **最後更新**: 2026-01-15  
> **狀態**: Draft

---

## 10. 測試準則

### 10.1 單元測試

#### 10.1.0 P0 計算器測試（待建立）

> **新增於**: 2026-01-15
> **狀態**: ⚠️ 尚未建立測試檔案

目前 M08 已實作 14 個 P0 計算器，但尚無對應的單元測試。以下為預計建立的測試類別：

**估值類測試**:

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| PECalculatorTest | 計算正確性、虧損處理、異常高值 | P/E > 0 當 EPS > 0；虧損時返回 NULL |
| PBCalculatorTest | 計算正確性、淨值為負處理 | P/B > 0 當權益 > 0 |
| PSCalculatorTest | 計算正確性 | P/S 範圍合理性 |
| PEGCalculatorTest | 成長率計算、除零處理 | 成長率 <= 0 時處理 |

```
測試: PECalculator - 正常計算
Given: stockPrice=580, eps=36.05
When: calculate()
Then:
  - pe_ratio ≈ 16.08
  - 無錯誤訊息
```

```
測試: PECalculator - 虧損公司
Given: stockPrice=50, eps=-5.00
When: calculate()
Then:
  - pe_ratio = NULL (不計算)
  - 記錄 debug log
```

**獲利能力類測試**:

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| ROECalculatorTest | 計算正確性、異常值處理 | ROE 範圍 -100%~100% |
| ROACalculatorTest | 計算正確性 | ROA 範圍合理性 |
| GrossMarginCalculatorTest | 計算正確性、負毛利處理 | 毛利率 < 0 時記錄警告 |
| NetMarginCalculatorTest | 計算正確性 | 淨利率範圍 |

```
測試: ROECalculator - 正常計算
Given: netIncome=934億, totalEquity=3.5兆
When: calculate()
Then:
  - roe ≈ 26.69%
  - 無警告
```

```
測試: ROECalculator - 異常高
Given: netIncome=500億, totalEquity=100億
When: calculate()
Then:
  - roe = 500%
  - 記錄警告「ROE 異常高」
```

**財務結構類測試**:

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| DebtRatioCalculatorTest | 計算正確性 | 負債比 0%~100%+ |
| EquityRatioCalculatorTest | 一致性驗證 | 負債比 + 權益比 ≈ 100% |

**償債能力類測試**:

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| CurrentRatioCalculatorTest | 計算正確性、流動負債為零 | 流動比 > 0 |
| QuickRatioCalculatorTest | 計算正確性 | 速動比 <= 流動比 |

**現金流量類測試**:

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| FCFCalculatorTest | 正負值處理 | FCF 可為負（擴張期） |
| FCFYieldCalculatorTest | 市值為零處理 | 除零保護 |

---

#### 10.1.1 測試場景

**場景 1: 估值指標計算測試**
```
Given: 
- 財報資料: 營收=2263億, 淨利=934億, 總資產=5兆, 股東權益=3.5兆
- 股價=580, 流通股數=259億股

When: 
- 計算估值指標

Then:
- P/E ≈ 16.08
- P/B ≈ 4.29
- P/S ≈ 6.63
- 所有指標非 NULL, 非 NaN
```

**場景 2: 獲利能力指標計算測試**
```
Given:
- 營收=2263億, 營業成本=1052億, 營業利益=957億, 淨利=934億
- 總資產=5兆, 股東權益=3.5兆

When:
- 計算獲利能力指標

Then:
- 毛利率 ≈ 53.50%
- 營業利益率 ≈ 42.30%
- 淨利率 ≈ 41.27%
- ROE ≈ 26.69%
- ROA ≈ 18.68%
```

**場景 3: 成長性指標計算測試**
```
Given:
- 本季營收=2263億, 去年同季營收=1910億
- 本季EPS=36.05, 去年同季EPS=28.80

When:
- 計算成長性指標

Then:
- 營收成長率 YoY ≈ 18.48%
- EPS 成長率 YoY ≈ 25.17%
```

**場景 4: Piotroski F-Score 計算測試**
```
Given:
- 當季 ROA=18.7%, 去年同季 ROA=17.2%
- 當季 營運現金流=1兆, 淨利=934億
- 當季 流動比=2.1, 去年同季 流動比=2.0
- 當季 毛利率=53.5%, 去年同季 毛利率=52.8%

When:
- 計算 Piotroski F-Score

Then:
- 獲利能力: 4 分 (ROA>0, OCF>0, ROA增加, OCF>淨利)
- 總分 >= 6 分（良好）
```

**場景 5: 財務異常偵測測試**
```
Given:
- 負債比=75%

When:
- 執行異常偵測

Then:
- 產生 HIGH_DEBT_RATIO 警示
- severity = 'HIGH'
- alert_category = 'DEBT_RISK'
```

---

#### 10.1.2 邊界條件測試

**測試 1: 處理虧損公司**
```
Given:
- EPS = -5.00 (虧損)

When:
- 計算 P/E

Then:
- P/E = NULL (虧損時 P/E 無意義)
```

**測試 2: 處理淨值為負公司**
```
Given:
- 股東權益 = -100億 (淨值為負)

When:
- 計算 P/B

Then:
- P/B = NULL (淨值為負時 P/B 無意義)
```

**測試 3: 處理除數為零**
```
Given:
- 去年同季 EPS = 0

When:
- 計算 EPS 成長率

Then:
- EPS 成長率 = NULL (除數為零)
```

**測試 4: 處理盈轉虧**
```
Given:
- 去年同季 EPS = 10.00
- 本季 EPS = -5.00

When:
- 計算 EPS 成長率

Then:
- EPS 成長率 = -999% (標記特殊情況)
```

---

### 10.2 整合測試

#### 10.2.1 API 整合測試

**測試 1: 查詢財務指標 API**
```
Given:
- 資料庫已有台積電 2024Q3 財務指標

When:
- GET /api/stocks/2330/fundamentals?year=2024&quarter=3

Then:
- HTTP Status = 200
- Response.success = true
- Response.data.stock_id = "2330"
- Response.data.pe_ratio > 0
- Response.data.roe > 0
```

**測試 2: 批次查詢 API**
```
Given:
- 資料庫已有台積電、鴻海、聯發科的 2024Q3 財務指標

When:
- POST /api/fundamentals/batch
- Body: {"stock_ids": ["2330", "2317", "2454"], "year": 2024, "quarter": 3}

Then:
- HTTP Status = 200
- Response.data.results.length = 3
- 每個結果包含指定的指標
```

**測試 3: 查詢綜合評分 API**
```
Given:
- 資料庫已有台積電 2024Q3 綜合評分

When:
- GET /api/stocks/2330/scores?year=2024&quarter=3

Then:
- HTTP Status = 200
- Response.data.piotroski_f_score >= 0 AND <= 9
- Response.data.altman_z_score > 0
```

---

#### 10.2.2 Job 整合測試

**測試 1: 財務指標計算 Job**
```
Given:
- M06 已同步台積電 2024Q3 財報
- M06 已同步台積電股價

When:
- 執行 JOB-M08-001 (手動觸發)

Then:
- Job status = 'SUCCESS'
- fundamental_indicators 表新增 1 筆記錄
- stock_id = '2330', year = 2024, quarter = 3
- pe_ratio, roe 等欄位非 NULL
```

**測試 2: 綜合評分計算 Job**
```
Given:
- fundamental_indicators 表已有台積電 2024Q3 與 2023Q3 資料

When:
- 執行 JOB-M08-002

Then:
- Job status = 'SUCCESS'
- financial_scores 表新增 1 筆記錄
- piotroski_f_score >= 0 AND <= 9
- altman_z_score > 0
```

**測試 3: 財務異常偵測 Job**
```
Given:
- fundamental_indicators 表已有高負債股票資料（負債比=75%）

When:
- 執行 JOB-M08-003

Then:
- Job status = 'SUCCESS'
- financial_alerts 表新增警示記錄
- alert_type = 'HIGH_DEBT_RATIO'
- severity = 'HIGH'
```

---

### 10.3 效能測試

#### 10.3.1 API 效能測試

**測試 1: 單一查詢效能**
```
場景: 查詢單一股票財務指標
Target: P95 < 300ms

測試步驟:
1. 準備 100 檔股票的財務指標資料
2. 並發 100 個請求查詢不同股票
3. 測量回應時間

驗證:
- P95 回應時間 < 300ms
- P99 回應時間 < 500ms
```

**測試 2: 批次查詢效能**
```
場景: 批次查詢 10 檔股票
Target: P95 < 1000ms

測試步驟:
1. 準備 1000 檔股票的財務指標資料
2. 並發 100 個請求，每個請求查詢 10 檔股票
3. 測量回應時間

驗證:
- P95 回應時間 < 1000ms
- P99 回應時間 < 1500ms
```

---

#### 10.3.2 Job 效能測試

**測試 1: 指標計算 Job 效能**
```
場景: 計算 2000 檔股票財務指標
Target: < 20 分鐘

測試步驟:
1. 準備 2000 檔股票的財報資料
2. 執行 JOB-M08-001
3. 測量執行時間

驗證:
- 執行時間 < 20 分鐘
- 成功率 > 95%
```

**測試 2: 綜合評分 Job 效能**
```
場景: 計算 2000 檔股票綜合評分
Target: < 5 分鐘

測試步驟:
1. 準備 2000 檔股票的財務指標資料
2. 執行 JOB-M08-002
3. 測量執行時間

驗證:
- 執行時間 < 5 分鐘
- 成功率 > 95%
```

---

### 10.4 測試覆蓋率目標

| 層級 | 覆蓋率目標 | 說明 |
|-----|----------|------|
| Repository | > 90% | JPA Repository 方法測試 |
| Mapper | > 85% | MyBatis Mapper 測試 |
| Service | > 80% | 業務邏輯測試 |
| Controller | > 70% | API 測試 |
| Job | > 75% | 排程任務測試 |

---

### 10.5 測試資料準備

**測試資料集**:
1. **台積電 (2330)**: 標準案例（高ROE、低負債、穩定成長）
2. **中鋼 (2002)**: 景氣循環股（毛利率波動大）
3. **友達 (2409)**: 虧損股（負EPS、淨值低）
4. **長榮 (2603)**: 爆發成長股（EPS大幅成長）
5. **聯電 (2303)**: 財務槓桿高股（負債比>60%）

**財報資料範圍**:
- 時間: 2020Q1 ~ 2024Q3（共 19 季）
- 涵蓋: 營收、淨利、總資產、股東權益、現金流等完整欄位

---



---

## 📚 相關文檔

- [M08 功能需求](../specs/functional/M08-基本面分析功能需求.md)
- [M08 API規格](../specs/technical/api/M08-API規格.md)
- [M08 業務流程](./M08-業務流程.md)
- [開發準則](../specs/technical/00-開發準則.md)

---

**文件維護者**: 測試工程師  
**最後更新**: 2025-12-31  
**下次審核**: 2026-02-28
