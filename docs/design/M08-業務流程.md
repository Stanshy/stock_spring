# M08-基本面分析模組業務流程

> **文件編號**: FLOW-M08  
> **模組名稱**: 基本面分析模組  
> **版本**: v2.0  
> **最後更新**: 2025-12-31  
> **狀態**: Draft

---

## 📋 業務流程總覽

本文件定義 基本面分析模組的資料流與業務邏輯。

---

## 5. 資料流設計

### 5.1 資料流總覽

```
┌─────────────────────────────────────────────────────────────┐
│                M06 資料管理模組                              │
│           financial_statements 表                            │
│           (營收、淨利、總資產、現金流等)                      │
└─────────────────────────────────────────────────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  財報資料讀取層  │
                    │  - 查詢最新財報  │
                    │  - 查詢歷史財報  │
                    │  - 資料驗證      │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  指標計算層      │
                    │  - 估值指標      │
                    │  - 獲利指標      │
                    │  - 財務結構      │
                    │  - 償債能力      │
                    │  - 經營效率      │
                    │  - 現金流量      │
                    │  - 成長性        │
                    │  - 股利政策      │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  綜合評分層      │
                    │  - Piotroski    │
                    │  - Altman       │
                    │  - Beneish      │
                    │  - Graham       │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  異常偵測層      │
                    │  - 盈餘品質檢查  │
                    │  - 負債風險檢查  │
                    │  - 流動性檢查    │
                    │  - 獲利惡化檢查  │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  資料儲存層      │
                    │  - UPSERT 指標   │
                    │  - UPSERT 評分   │
                    │  - INSERT 警示   │
                    │  - Transaction   │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  快取更新層      │
                    │  - Redis 寫入    │
                    │  - 設定 TTL      │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  結果記錄層      │
                    │  - Job 記錄      │
                    │  - 統計資訊      │
                    │  - 告警觸發      │
                    └─────────────────┘
```

### 5.2 財務指標計算流程

```
START: 財務指標計算 Job 觸發（每週一 09:00 或事件觸發）
  ↓
1. 建立 Job 執行記錄（job_executions 表）
   - job_name = 'CALCULATE_FUNDAMENTALS'
   - job_status = 'RUNNING'
   - start_time = CURRENT_TIMESTAMP
  ↓
2. 查詢最近一季新增或更新的財報資料
   - 從 financial_statements 表
   - WHERE updated_at > last_job_time
   - 或手動指定 stock_ids, year, quarter
  ↓
3. 對每檔股票每季財報執行計算
  ↓
4. 讀取財報資料
   - 查詢 financial_statements 表
   - 驗證資料完整性（營收、淨利、總資產、股東權益必填）
   ├─ 資料不完整 → 記錄 data_quality_issues，跳過該股票
   └─ 資料完整 → 繼續
  ↓
5. 查詢股價（用於估值指標）
   - 從 stock_prices 表查詢財報公告日收盤價
   - 若當日無交易，取最近交易日收盤價
  ↓
6. 計算估值指標
   - P/E = 股價 / EPS
   - P/B = 股價 / (股東權益 / 流通股數)
   - P/S = 股價 / (營收 / 流通股數)
   - P/CF = 股價 / (營運現金流 / 流通股數)
   - P/FCF = 股價 / (自由現金流 / 流通股數)
   - PEG = P/E / EPS成長率
   - EV/EBITDA = (市值 + 負債 - 現金) / EBITDA
  ↓
7. 計算獲利能力指標
   - 毛利率 = (營收 - 營業成本) / 營收 × 100%
   - 營業利益率 = 營業利益 / 營收 × 100%
   - 淨利率 = 稅後淨利 / 營收 × 100%
   - ROE = 稅後淨利 / 股東權益 × 100%
   - ROA = 稅後淨利 / 總資產 × 100%
   - EPS = 稅後淨利 / 流通股數
  ↓
8. 計算財務結構指標
   - 負債權益比 = 總負債 / 股東權益
   - 負債比率 = 總負債 / 總資產 × 100%
   - 權益比率 = 股東權益 / 總資產 × 100%
  ↓
9. 計算償債能力指標
   - 流動比率 = 流動資產 / 流動負債
   - 速動比率 = (流動資產 - 存貨) / 流動負債
   - 現金比率 = (現金 + 約當現金) / 流動負債
   - 利息保障倍數 = EBIT / 利息費用
  ↓
10. 計算經營效率指標
    - 總資產週轉率 = 營收 / 平均總資產
    - 存貨週轉率 = 營業成本 / 平均存貨
    - 應收帳款週轉率 = 營收 / 平均應收帳款
    - DIO = 365 / 存貨週轉率
    - DSO = 365 / 應收帳款週轉率
    - DPO = 365 / 應付帳款週轉率
    - 現金週轉週期 = DIO + DSO - DPO
  ↓
11. 計算現金流量指標
    - 自由現金流 = 營運現金流 - 資本支出
    - FCF Yield = FCF / 市值 × 100%
    - 營運現金流比率 = 營運現金流 / 流動負債
    - 應計項目比率 = (淨利 - 營運現金流) / 總資產
  ↓
12. 計算成長性指標（需查詢歷史財報）
    - 營收成長率 YoY = (本季營收 - 去年同季營收) / 去年同季營收 × 100%
    - EPS成長率 YoY = (本季EPS - 去年同季EPS) / 去年同季EPS × 100%
    - 營收 CAGR 3年/5年
    - EPS CAGR 3年/5年
  ↓
13. 計算股利政策指標
    - 現金殖利率 = 每股股利 / 股價 × 100%
    - 股利發放率 = 每股股利 / EPS × 100%
  ↓
14. 驗證計算結果
    - 檢查 NULL、NaN、Inf
    - 檢查範圍合理性（如 ROE > 100%）
    - 檢查一致性（權益比 + 負債比 ≈ 100%）
    ├─ 驗證失敗 → 記錄 data_quality_issues，標記異常值
    └─ 驗證通過 → 繼續
  ↓
15. 計算綜合評分
    - Piotroski F-Score (0-9)
    - Altman Z-Score
    - Beneish M-Score
    - Graham Score
    - 自訂綜合評分 (0-100)
  ↓
16. 偵測財務異常
    - 應計項目比率 > 10% → 盈餘品質警示
    - 負債比 > 70% → 高負債警示
    - 流動比 < 1.0 → 流動性風險警示
    - FCF 連續 2 季為負 → 現金流警示
    - ROE 連續 2 季下降且 < 10% → 獲利惡化警示
  ↓
17. 使用 MyBatis 批次 UPSERT 儲存
    - INSERT INTO fundamental_indicators ... ON CONFLICT DO UPDATE
    - INSERT INTO financial_scores ... ON CONFLICT DO UPDATE
    - INSERT INTO financial_alerts ... (若偵測到異常)
    - Transaction 保護
  ↓
18. 更新 Redis 快取（僅熱門股票）
    - Key: fund:indicators:{stock_id}:{year}:{quarter}
    - TTL: 24 小時
  ↓
19. 產生信號並發布（若偵測到異常）
    - 遵守總綱 4.2 Signal Contract
    - signal_type = 'SELL' 或 'HOLD'
    - signal_source = 'M08_FUNDAMENTAL'
    - evidence_data 包含異常細節
  ↓
20. 更新 Job 執行記錄
    - job_status = 'SUCCESS'
    - end_time = CURRENT_TIMESTAMP
    - processed_count, success_count, failed_count
  ↓
END
```

### 5.3 綜合評分計算流程

```
START: 綜合評分計算（在指標計算完成後）
  ↓
1. Piotroski F-Score 計算 (0-9)
  ↓
  1a. 獲利能力 (4分)
      - ROA > 0 → +1
      - 營運現金流 > 0 → +1
      - ROA 增加 → +1
      - 營運現金流 > 淨利 → +1
  ↓
  1b. 財務結構/槓桿 (3分)
      - 長期負債減少 → +1
      - 流動比率增加 → +1
      - 未發行新股稀釋 → +1
  ↓
  1c. 經營效率 (2分)
      - 毛利率增加 → +1
      - 總資產週轉率增加 → +1
  ↓
2. Altman Z-Score 計算
  ↓
  Z = 1.2 × (營運資金/總資產)
    + 1.4 × (保留盈餘/總資產)
    + 3.3 × (稅前息前盈餘/總資產)
    + 0.6 × (股東權益市值/總負債)
    + 1.0 × (營收/總資產)
  ↓
  判斷:
  - Z > 2.99 → SAFE (安全)
  - 1.81 < Z < 2.99 → GREY (灰色地帶)
  - Z < 1.81 → DISTRESS (財務困境)
  ↓
3. Beneish M-Score 計算（會計操縱偵測）
  ↓
  M = -4.84 + 0.92×DSRI + 0.528×GMI + 0.404×AQI
    + 0.892×SGI + 0.115×DEPI - 0.172×SGAI
    + 4.679×TATA - 0.327×LVGI
  ↓
  判斷:
  - M < -2.22 → CLEAN (盈餘品質良好)
  - -2.22 < M < -1.78 → WARNING (需注意)
  - M > -1.78 → MANIPULATOR (可能會計操縱)
  ↓
4. Graham Score 計算 (0-10)
  ↓
  評分項目:
  - EPS 連續 5 年成長 → +1
  - 股利連續 20 年發放 → +1
  - 負債比 < 50% → +1
  - 流動比 > 2.0 → +1
  - P/E < 15 → +1
  - P/B < 1.5 → +1
  - ROE > 15% → +1
  - 毛利率 > 40% → +1
  - 自由現金流 > 0 → +1
  - 殖利率 > 3% → +1
  ↓
5. 自訂綜合評分 (0-100)
  ↓
  - 估值 (20分): P/E, P/B, PEG
  - 獲利 (30分): ROE, 淨利率, EPS成長
  - 財務健全 (20分): 負債比, 流動比, FCF
  - 成長性 (15分): 營收成長, EPS成長
  - 股利 (15分): 殖利率, 股利發放率
  ↓
  評級:
  - 90-100 → A+
  - 80-89 → A
  - 70-79 → B+
  - 60-69 → B
  - 50-59 → C+
  - 40-49 → C
  - 30-39 → D
  - 0-29 → F
  ↓
6. 儲存評分結果
   - INSERT INTO financial_scores
  ↓
END
```

### 5.4 財務異常偵測流程

```
START: 財務異常偵測（在指標計算完成後）
  ↓
1. 盈餘品質檢查
  ↓
  1a. 應計項目比率檢查
      - 應計比率 = (淨利 - 營運現金流) / 總資產
      - 若 應計比率 > 10% → 觸發 EARNINGS_QUALITY 警示
  ↓
  1b. 現金流與淨利比較
      - 若 營運現金流 < 淨利 × 0.7 → 觸發 EARNINGS_QUALITY 警示
  ↓
  1c. 自由現金流趨勢
      - 查詢最近 2 季 FCF
      - 若連續 2 季 FCF < 0 → 觸發 EARNINGS_QUALITY 警示（燒錢）
  ↓
2. 負債風險檢查
  ↓
  2a. 負債比率檢查
      - 若 負債比 > 70% → 觸發 DEBT_RISK 警示（HIGH）
      - 若 負債比 > 60% → 觸發 DEBT_RISK 警示（MEDIUM）
  ↓
  2b. 負債權益比檢查
      - 若 負債權益比 > 2.0 → 觸發 DEBT_RISK 警示
  ↓
  2c. 利息保障倍數檢查
      - 若 利息保障倍數 < 1.5 → 觸發 DEBT_RISK 警示（CRITICAL）
  ↓
3. 流動性風險檢查
  ↓
  3a. 流動比率檢查
      - 若 流動比 < 1.0 → 觸發 LIQUIDITY_RISK 警示（HIGH）
      - 若 流動比 < 1.5 → 觸發 LIQUIDITY_RISK 警示（MEDIUM）
  ↓
  3b. 速動比率檢查
      - 若 速動比 < 0.8 → 觸發 LIQUIDITY_RISK 警示
  ↓
  3c. 現金比率檢查
      - 若 現金比 < 0.3 → 觸發 LIQUIDITY_RISK 警示
  ↓
4. 獲利能力惡化檢查
  ↓
  4a. ROE 趨勢檢查
      - 查詢最近 2 季 ROE
      - 若連續 2 季下降且最新 ROE < 10% → 觸發 PROFITABILITY_DECLINE 警示
  ↓
  4b. 毛利率趨勢檢查
      - 查詢最近 2 季毛利率
      - 若連續 2 季下降且最新毛利率 < 15% → 觸發 PROFITABILITY_DECLINE 警示
  ↓
  4c. 淨利率檢查
      - 若 淨利率 < 3% → 觸發 PROFITABILITY_DECLINE 警示
  ↓
5. 記錄警示
   - 若偵測到任何異常
   - INSERT INTO financial_alerts
   - 設定 severity (LOW, MEDIUM, HIGH, CRITICAL)
  ↓
6. 產生信號（若 severity >= MEDIUM）
   - 遵守總綱 4.2 Signal Contract
   - signal_type = 'SELL' 或 'HOLD'
   - signal_source = 'M08_FUNDAMENTAL_ALERT'
   - signal_name = alert_type
   - confidence_score = 根據 severity 設定（HIGH=75, MEDIUM=60）
   - evidence_data = alert_detail
  ↓
7. 發布事件
   - 發布 FinancialAlertDetected 事件至 M13
  ↓
END
```

---

## 7. 業務邏輯設計

> **說明**: 本節以文字描述業務邏輯與演算法，不包含程式碼實作

### 7.1 Service 層架構

```
FundamentalAnalysisService (基本面分析服務 - 門面)
    │
    ├─→ IndicatorCalculationService (指標計算服務)
    │       ├─ 職責: 財務指標計算、驗證與儲存
    │       ├─ 依賴: FundamentalIndicatorRepository (JPA), IndicatorMapper (MyBatis)
    │       └─ 核心方法: 
    │           - calculateIndicators(stockId, year, quarter)
    │           - calculateValuationIndicators(financialData, stockPrice)
    │           - calculateProfitabilityIndicators(financialData)
    │           - calculateGrowthIndicators(currentData, historicalData)
    │
    ├─→ ScoreCalculationService (評分計算服務)
    │       ├─ 職責: 綜合評分計算（Piotroski、Altman、Beneish、Graham）
    │       ├─ 依賴: FinancialScoreRepository (JPA), IndicatorMapper (MyBatis)
    │       └─ 核心方法:
    │           - calculatePiotroskiScore(currentData, previousData)
    │           - calculateAltmanZScore(financialData, marketData)
    │           - calculateBeneishMScore(currentData, previousData)
    │           - calculateGrahamScore(indicators)
    │           - calculateCompositeScore(indicators)
    │
    ├─→ AnomalyDetectionService (異常偵測服務)
    │       ├─ 職責: 財務異常偵測、警示產生
    │       ├─ 依賴: FinancialAlertRepository (JPA), IndicatorMapper (MyBatis)
    │       └─ 核心方法:
    │           - detectEarningsQualityIssues(indicators)
    │           - detectDebtRisks(indicators)
    │           - detectLiquidityRisks(indicators)
    │           - detectProfitabilityDecline(indicators, historical)
    │           - generateAlert(alertType, severity, detail)
    │
    ├─→ TrendAnalysisService (趨勢分析服務)
    │       ├─ 職責: 指標歷史趨勢計算、統計分析
    │       ├─ 依賴: IndicatorMapper (MyBatis)
    │       └─ 核心方法:
    │           - calculateTrend(stockId, indicator, periods)
    │           - calculateStatistics(historicalData)
    │           - detectTrendDirection(historicalData)
    │
    ├─→ FinancialDataService (財務資料服務)
    │       ├─ 職責: 財報資料讀取、驗證
    │       ├─ 依賴: FinancialStatementMapper (MyBatis, 來自 M06)
    │       └─ 核心方法:
    │           - getFinancialStatement(stockId, year, quarter)
    │           - getHistoricalStatements(stockId, periods)
    │           - validateFinancialData(financialData)
    │
    └─→ CacheManagementService (快取管理服務)
            ├─ 職責: Redis 快取管理、預熱、失效
            ├─ 依賴: RedisTemplate
            └─ 核心方法:
                - cacheIndicators(stockId, year, quarter, indicators)
                - getIndicatorsFromCache(stockId, year, quarter)
                - warmUpCache(stockIds)
                - invalidateCache(stockId)
```

---

### 7.2 指標計算邏輯

#### 7.2.1 估值指標計算

**輸入**:
- 財報資料: 營收、淨利、總資產、股東權益、負債、現金、EBITDA
- 股價資料: 財報公告日收盤價
- 股本資料: 流通股數

**計算步驟**:

**步驟 1: 計算每股數值**
```
EPS = 稅後淨利 / 流通股數
BVPS (每股淨值) = 股東權益 / 流通股數
SPS (每股營收) = 營收 / 流通股數
CFPS (每股營運現金流) = 營運現金流 / 流通股數
FCFPS (每股自由現金流) = 自由現金流 / 流通股數
```

**步驟 2: 計算估值比率**
```
P/E = 股價 / EPS
P/B = 股價 / BVPS
P/S = 股價 / SPS
P/CF = 股價 / CFPS
P/FCF = 股價 / FCFPS
```

**步驟 3: 計算進階估值指標**
```
市值 = 股價 × 流通股數
企業價值 (EV) = 市值 + 總負債 - 現金及約當現金
EV/EBITDA = EV / EBITDA

PEG = P/E / EPS成長率
  - 需要查詢去年同季 EPS 計算成長率
  - 若成長率為負，PEG 設為 NULL

Tobin's Q = 市值 / 資產重置成本
  - 資產重置成本 ≈ 總資產（簡化計算）
  
Graham Number = √(22.5 × EPS × BVPS)
```

**驗證規則**:
- P/E、P/B、P/S 應 > 0（若為負表示虧損或淨值為負）
- 若 EPS < 0，P/E 設為 NULL
- 若 BVPS < 0，P/B 設為 NULL
- PEG 範圍通常 0-5（超過 5 可能異常）

---

#### 7.2.2 獲利能力指標計算

**輸入**:
- 財報資料: 營收、營業成本、營業利益、稅後淨利、總資產、股東權益

**計算步驟**:

**步驟 1: 計算利潤率**
```
毛利 = 營收 - 營業成本
毛利率 = 毛利 / 營收 × 100%

營業利益率 = 營業利益 / 營收 × 100%

淨利率 = 稅後淨利 / 營收 × 100%

EBITDA = 稅前息前盈餘 + 折舊 + 攤銷
EBITDA Margin = EBITDA / 營收 × 100%
```

**步驟 2: 計算報酬率**
```
ROE = 稅後淨利 / 股東權益 × 100%

ROA = 稅後淨利 / 總資產 × 100%

ROIC = NOPAT / 投入資本 × 100%
  - NOPAT (稅後營業利益) = 營業利益 × (1 - 稅率)
  - 投入資本 = 股東權益 + 有息負債
  - 稅率 = (稅前淨利 - 稅後淨利) / 稅前淨利
```

**步驟 3: 計算每股盈餘**
```
基本 EPS = 稅後淨利 / 流通股數

營業 EPS = 營業利益 / 流通股數

稀釋 EPS = 稅後淨利 / (流通股數 + 潛在稀釋股數)
  - 潛在稀釋股數包含可轉債、認股權等
```

**驗證規則**:
- 各利潤率範圍：-100% 到 100%（虧損公司可為負）
- ROE、ROA 範圍：-100% 到 100%
- ROE > 100% 視為異常，標記需人工檢查
- 毛利率 > 營業利益率 > 淨利率（正常情況）

---

#### 7.2.3 成長性指標計算

**輸入**:
- 當季財報資料
- 去年同季財報資料（YoY）
- 上季財報資料（QoQ）
- 過去 3 年、5 年財報資料（CAGR）

**計算步驟**:

**步驟 1: 計算年增率（YoY）**
```
營收成長率 YoY = (本季營收 - 去年同季營收) / 去年同季營收 × 100%

EPS 成長率 YoY = (本季EPS - 去年同季EPS) / 去年同季EPS × 100%

淨利成長率 YoY = (本季淨利 - 去年同季淨利) / 去年同季淨利 × 100%

ROE 成長率 YoY = (本季ROE - 去年同季ROE) / 去年同季ROE × 100%
```

**步驟 2: 計算季增率（QoQ）**
```
營收成長率 QoQ = (本季營收 - 上季營收) / 上季營收 × 100%

EPS 成長率 QoQ = (本季EPS - 上季EPS) / 上季EPS × 100%
```

**步驟 3: 計算複合年成長率（CAGR）**
```
營收 CAGR 3年 = [(本季營收 / 3年前同季營收)^(1/3) - 1] × 100%

營收 CAGR 5年 = [(本季營收 / 5年前同季營收)^(1/5) - 1] × 100%

EPS CAGR 3年 = [(本季EPS / 3年前同季EPS)^(1/3) - 1] × 100%

EPS CAGR 5年 = [(本季EPS / 5年前同季EPS)^(1/5) - 1] × 100%
```

**特殊處理**:
- 若去年同季值為 0，成長率設為 NULL
- 若去年同季為負、本季為正（虧轉盈），成長率設為 999%（標記特殊情況）
- 若去年同季為正、本季為負（盈轉虧），成長率設為 -999%（標記特殊情況）
- 若歷史資料不足 3 年或 5 年，CAGR 設為 NULL

---

#### 7.2.4 現金流量指標計算

**輸入**:
- 財報資料: 營運現金流、資本支出、淨利、總資產、流動負債、營收

**計算步驟**:

**步驟 1: 計算自由現金流**
```
自由現金流 (FCF) = 營運現金流 - 資本支出
```

**步驟 2: 計算現金流比率**
```
FCF Yield = FCF / 市值 × 100%

營運現金流比率 = 營運現金流 / 流動負債

現金流營收比 = 營運現金流 / 營收 × 100%
```

**步驟 3: 計算應計項目比率（盈餘品質）**
```
應計項目 = 稅後淨利 - 營運現金流

應計項目比率 = 應計項目 / 總資產 × 100%
```

**解讀**:
- FCF > 0: 公司有剩餘現金可分配
- FCF < 0: 公司資本支出大於營運現金流，可能在擴張期
- 應計項目比率 < 5%: 盈餘品質良好
- 應計項目比率 > 10%: 盈餘品質堪慮，可能有會計操縱

---

### 7.3 綜合評分計算邏輯

#### 7.3.1 Piotroski F-Score 計算

**資料需求**:
- 當季指標
- 去年同季指標（用於比較）
- 流通股數（當季與去年同季）

**計算步驟**:

**獲利能力 (4分)**:
```
1. ROA > 0 → +1 分
2. 營運現金流 > 0 → +1 分
3. ROA 增加（當季 ROA > 去年同季 ROA）→ +1 分
4. 營運現金流 > 淨利（現金獲利能力強）→ +1 分
```

**財務結構/槓桿 (3分)**:
```
5. 長期負債減少（當季長期負債 < 去年同季長期負債）→ +1 分
6. 流動比率增加（當季流動比 > 去年同季流動比）→ +1 分
7. 未發行新股稀釋（當季流通股數 <= 去年同季流通股數）→ +1 分
```

**經營效率 (2分)**:
```
8. 毛利率增加（當季毛利率 > 去年同季毛利率）→ +1 分
9. 總資產週轉率增加（當季週轉率 > 去年同季週轉率）→ +1 分
```

**總分範圍**: 0-9 分
- 8-9 分: 優秀（財務體質非常健全）
- 6-7 分: 良好
- 4-5 分: 普通
- 0-3 分: 較差（財務體質不佳）

**JSONB 儲存格式**:
```json
{
  "profitability": {
    "roa_positive": 1,
    "ocf_positive": 1,
    "roa_increasing": 1,
    "ocf_gt_ni": 1,
    "total": 4
  },
  "leverage": {
    "debt_decreasing": 1,
    "current_ratio_increasing": 1,
    "shares_not_increasing": 0,
    "total": 2
  },
  "operating_efficiency": {
    "gross_margin_increasing": 1,
    "asset_turnover_increasing": 1,
    "total": 2
  },
  "total_score": 8
}
```

---

#### 7.3.2 Altman Z-Score 計算

**資料需求**:
- 財報資料: 營運資金、保留盈餘、EBIT、總資產、總負債、營收
- 市場資料: 股價、流通股數（計算市值）

**計算步驟**:

**步驟 1: 計算各項係數**
```
X1 = 營運資金 / 總資產
  - 營運資金 = 流動資產 - 流動負債

X2 = 保留盈餘 / 總資產
  - 保留盈餘 = 股東權益 - 股本

X3 = 稅前息前盈餘(EBIT) / 總資產

X4 = 股東權益市值 / 總負債
  - 股東權益市值 = 股價 × 流通股數

X5 = 營收 / 總資產
  - 即總資產週轉率
```

**步驟 2: 計算 Z-Score**
```
Z = 1.2 × X1 + 1.4 × X2 + 3.3 × X3 + 0.6 × X4 + 1.0 × X5
```

**步驟 3: 判斷財務狀況**
```
IF Z > 2.99 THEN
  status = 'SAFE'
  interpretation = '安全區：破產風險低'
ELSIF Z > 1.81 THEN
  status = 'GREY'
  interpretation = '灰色地帶：需持續關注'
ELSE
  status = 'DISTRESS'
  interpretation = '財務困境區：破產風險高'
END IF
```

**JSONB 儲存格式**:
```json
{
  "working_capital_to_assets": 0.35,
  "retained_earnings_to_assets": 0.45,
  "ebit_to_assets": 0.18,
  "market_value_to_liabilities": 5.20,
  "sales_to_assets": 0.75,
  "z_score": 3.85,
  "status": "SAFE",
  "interpretation": "安全區：破產風險低"
}
```

---

#### 7.3.3 Beneish M-Score 計算（會計操縱偵測）

**資料需求**:
- 當季財報
- 去年同季財報（用於計算各項指數）

**計算步驟**:

**步驟 1: 計算 8 個指數**
```
DSRI (應收帳款比率指數) = (應收帳款t / 營收t) / (應收帳款t-1 / 營收t-1)

GMI (毛利率指數) = 毛利率t-1 / 毛利率t
  - 毛利率下降時 GMI > 1

AQI (資產品質指數) = (1 - 流動資產t - 固定資產t) / (1 - 流動資產t-1 - 固定資產t-1)

SGI (營收成長指數) = 營收t / 營收t-1

DEPI (折舊指數) = 折舊率t-1 / 折舊率t

SGAI (銷管費用指數) = (銷管費用t / 營收t) / (銷管費用t-1 / 營收t-1)

LVGI (槓桿指數) = 槓桿t / 槓桿t-1
  - 槓桿 = (流動負債 + 長期負債) / 總資產

TATA (總應計項目) = (營運資金變動 - 折舊) / 總資產
```

**步驟 2: 計算 M-Score**
```
M = -4.84 + 0.92×DSRI + 0.528×GMI + 0.404×AQI + 0.892×SGI 
    + 0.115×DEPI - 0.172×SGAI + 4.679×TATA - 0.327×LVGI
```

**步驟 3: 判斷盈餘品質**
```
IF M < -2.22 THEN
  status = 'CLEAN'
  interpretation = '盈餘品質良好，會計操縱風險低'
ELSIF M < -1.78 THEN
  status = 'WARNING'
  interpretation = '需注意，存在部分會計操縱跡象'
ELSE
  status = 'MANIPULATOR'
  interpretation = '高度懷疑會計操縱，盈餘品質堪慮'
END IF
```

---

### 7.4 資料驗證邏輯

#### 7.4.1 財報資料完整性驗證

**驗證步驟**:

**步驟 1: 檢查必填欄位**
```
必填欄位清單:
- 營收 (revenue)
- 稅後淨利 (net_income)
- 總資產 (total_assets)
- 股東權益 (equity)
- 流通股數 (shares_outstanding)

IF 任一必填欄位為 NULL THEN
  記錄 data_quality_issues
  跳過該股票
END IF
```

**步驟 2: 檢查數值合理性**
```
IF 總資產 <= 0 THEN
  記錄錯誤: 總資產必須為正
END IF

IF 流通股數 <= 0 THEN
  記錄錯誤: 流通股數必須為正
END IF

IF 營收 < 0 THEN
  記錄警告: 營收為負（特殊情況）
END IF
```

**步驟 3: 檢查會計等式**
```
IF |總資產 - (總負債 + 股東權益)| > 1000 THEN
  記錄錯誤: 資產負債表不平衡
  差異 = |總資產 - (總負債 + 股東權益)|
END IF
```

---

#### 7.4.2 指標計算結果驗證

**驗證步驟**:

**步驟 1: 檢查 NULL 與 NaN**
```
FOR EACH 指標 IN 計算結果
  IF 指標值 IS NULL OR 指標值 IS NaN OR 指標值 IS Inf THEN
    記錄警告: 指標計算結果異常
    將該指標設為 NULL
  END IF
END FOR
```

**步驟 2: 檢查範圍合理性**
```
IF ROE > 100% OR ROE < -100% THEN
  記錄警告: ROE 超出合理範圍
  標記需人工檢查
END IF

IF 負債比 > 200% THEN
  記錄警告: 負債比異常高（淨值可能為負）
END IF

IF 毛利率 > 95% THEN
  記錄警告: 毛利率異常高
END IF

IF 毛利率 < -50% THEN
  記錄警告: 毛利率異常低
END IF
```

**步驟 3: 檢查邏輯一致性**
```
IF 權益比 + 負債比 不約等於 100% THEN
  IF |權益比 + 負債比 - 100| > 5 THEN
    記錄錯誤: 權益比與負債比不一致
  END IF
END IF

IF 毛利率 < 營業利益率 THEN
  記錄警告: 毛利率應大於營業利益率（異常情況）
END IF

IF 營業利益率 < 淨利率 THEN
  記錄警告: 營業利益率應大於淨利率（可能有業外大額收入）
END IF
```

---


---

## 8. 整合點

### 8.1 對外部系統的依賴

| 外部系統 | 用途 | 協議 | 資料格式 | 限制 |
|---------|------|------|---------|------|
| 無 | - | - | - | - |

M08 模組不依賴外部系統，所有資料來自 M06。

### 8.2 對內部模組的依賴

| 上游模組 | 使用的資料/API | 呼叫頻率 | 說明 |
|---------|--------------|---------|------|
| M06 資料管理模組 | financial_statements 表 | 每週一次（Job） | 讀取財報資料 |
| M06 資料管理模組 | stock_prices 表 | 每週一次（Job） | 讀取股價資料（用於估值指標） |
| M06 資料管理模組 | stocks 表 | 每週一次（Job） | 讀取股本資料 |

### 8.3 對內部模組的提供

| 下游模組 | 使用的 API | 呼叫頻率 | 說明 |
|---------|-----------|---------|------|
| M13 信號判斷引擎 | GET /api/stocks/{id}/fundamentals | 高頻 | 查詢財務指標用於信號判斷 |
| M13 信號判斷引擎 | GET /api/stocks/{id}/scores | 高頻 | 查詢綜合評分 |
| M13 信號判斷引擎 | GET /api/stocks/{id}/alerts | 高頻 | 查詢財務警示 |
| M14 選股引擎 | POST /api/fundamentals/batch | 高頻 | 批次查詢財務指標用於選股篩選 |
| M14 選股引擎 | POST /api/fundamentals/trends | 中頻 | 查詢指標歷史趨勢 |
| M16 回測系統 | POST /api/fundamentals/batch | 中頻 | 批次查詢歷史財務指標用於回測 |
| M17 風險管理模組 | GET /api/stocks/{id}/fundamentals | 中頻 | 查詢財務指標評估風險 |

### 8.4 事件發布

| 事件名稱 | 觸發條件 | 訂閱者 | 事件內容 |
|---------|---------|-------|---------|
| FundamentalIndicatorsCalculated | 財務指標計算完成 | M13, M14 | stock_id, year, quarter, calculation_date |
| FinancialScoreUpdated | 綜合評分更新 | M13, M14 | stock_id, year, quarter, piotroski_score, altman_z_score |
| FinancialAlertDetected | 偵測到財務異常 | M13, M15 | stock_id, year, quarter, alert_type, severity, detail |

**事件發布機制**:
- 使用 Spring ApplicationEventPublisher
- 非同步處理（避免阻塞主流程）
- 失敗重試機制（最多 3 次）

---


---

## 📚 相關文檔

- [M08 功能需求](../specs/functional/M08-基本面分析功能需求.md)
- [M08 API規格](../specs/technical/api/M08-API規格.md)
- [M08 資料庫設計](./M08-資料庫設計.md)

---

**文件維護者**: 系統架構師  
**最後更新**: 2025-12-31
