# M10-æŠ€è¡“å‹æ…‹è¾¨è­˜æ¨¡çµ„è³‡æ–™åº«è¨­è¨ˆ

> **æ–‡ä»¶ç·¨è™Ÿ**: DB-M10
> **æ¨¡çµ„åç¨±**: æŠ€è¡“å‹æ…‹è¾¨è­˜æ¨¡çµ„
> **ç‰ˆæœ¬**: v1.0
> **æœ€å¾Œæ›´æ–°**: 2026-01-12
> **ç‹€æ…‹**: Draft

---

## ğŸ“‹ è³‡æ–™åº«è¨­è¨ˆç¸½è¦½

æœ¬æ–‡ä»¶å®šç¾©æŠ€è¡“å‹æ…‹è¾¨è­˜æ¨¡çµ„çš„è³‡æ–™è¡¨çµæ§‹ã€‚M10 ä¸»è¦ä¾è³´ M06 çš„è‚¡åƒ¹è³‡æ–™ï¼ˆstock_pricesï¼‰å’Œ M07 çš„æŠ€è¡“æŒ‡æ¨™è³‡æ–™ï¼Œä¸¦æ–°å¢å‹æ…‹è¾¨è­˜çµæœå„²å­˜è¡¨ã€‚

---

## 1. è³‡æ–™è¡¨æ¸…å–®

| è¡¨å | èªªæ˜ | æŒä¹…å±¤ | ç‰¹æ®ŠåŠŸèƒ½ |
|-----|------|-------|---------|
| kline_pattern_results | K ç·šå‹æ…‹è¾¨è­˜çµæœè¡¨ | MyBatis | åˆ†å€ã€ç´¢å¼•å„ªåŒ– |
| chart_pattern_results | åœ–è¡¨å‹æ…‹è¾¨è­˜çµæœè¡¨ | MyBatis | JSONBã€è¤‡é›œçµæ§‹ |
| trend_analysis_results | è¶¨å‹¢åˆ†æçµæœè¡¨ | JPA + MyBatis | JSONB |
| support_resistance_levels | æ”¯æ’å£“åŠ›ä½è¡¨ | JPA + MyBatis | å‹•æ…‹æ›´æ–° |
| pattern_signals | å‹æ…‹è¨Šè™Ÿè¡¨ | JPA + MyBatis | ç´¢å¼•å„ªåŒ– |
| pattern_statistics | å‹æ…‹çµ±è¨ˆè¡¨ | MyBatis | å¿«å–ã€å®šæœŸæ›´æ–° |

**ä¾è³´çš„è³‡æ–™è¡¨**:

| è¡¨å | æ¨¡çµ„ | ç”¨é€” |
|-----|------|------|
| stock_prices | M06 | è‚¡åƒ¹ OHLCV è³‡æ–™ä¾†æº |
| stocks | M06 | è‚¡ç¥¨åŸºæœ¬è³‡æ–™ |
| technical_indicator_results | M07 | æŠ€è¡“æŒ‡æ¨™ï¼ˆå‡ç·šã€ADX ç­‰ï¼‰ |

---

## 2. è³‡æ–™è¡¨è©³ç´°è¨­è¨ˆ

### 2.1 kline_pattern_results (K ç·šå‹æ…‹è¾¨è­˜çµæœè¡¨)

å„²å­˜æ¯æ—¥ K ç·šå‹æ…‹è¾¨è­˜çµæœã€‚

```sql
-- PostgreSQL å»ºè¡¨èªæ³•ï¼ˆä½¿ç”¨åˆ†å€ï¼‰
CREATE TABLE kline_pattern_results (
    result_id           BIGSERIAL,
    stock_id            VARCHAR(10) NOT NULL,
    trade_date          DATE NOT NULL,

    -- å‹æ…‹è³‡è¨Š
    pattern_id          VARCHAR(20) NOT NULL,
    pattern_name        VARCHAR(50) NOT NULL,
    english_name        VARCHAR(50),
    pattern_category    VARCHAR(20) NOT NULL,

    -- å‹æ…‹è©³æƒ…
    signal_type         VARCHAR(30) NOT NULL,
    strength            INTEGER NOT NULL,
    confidence          INTEGER,

    -- ç›¸é—œæ—¥æœŸï¼ˆK ç·šçµ„åˆæ¶‰åŠçš„æ—¥æœŸï¼‰
    involved_dates      DATE[] NOT NULL,

    -- åƒ¹æ ¼è³‡è¨Š
    pattern_low         NUMERIC(10,2),
    pattern_high        NUMERIC(10,2),
    candle_data         JSONB,

    -- æˆäº¤é‡ç¢ºèª
    volume_confirmation BOOLEAN DEFAULT FALSE,
    volume_ratio        NUMERIC(5,2),

    -- è¶¨å‹¢èƒŒæ™¯
    trend_context       VARCHAR(20),

    -- æè¿°
    description         TEXT,

    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (result_id, trade_date),

    -- ç´„æŸ
    CHECK (pattern_category IN ('SINGLE_KLINE', 'DOUBLE_KLINE', 'TRIPLE_KLINE', 'MULTI_KLINE')),
    CHECK (signal_type IN ('BULLISH_REVERSAL', 'BEARISH_REVERSAL', 'BULLISH_CONTINUATION',
                           'BEARISH_CONTINUATION', 'NEUTRAL_REVERSAL', 'NEUTRAL')),
    CHECK (strength BETWEEN 0 AND 100)
) PARTITION BY RANGE (trade_date);

-- å»ºç«‹åˆ†å€ï¼ˆæŒ‰å¹´ä»½ï¼‰
CREATE TABLE kline_pattern_results_2024 PARTITION OF kline_pattern_results
    FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

CREATE TABLE kline_pattern_results_2025 PARTITION OF kline_pattern_results
    FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');

CREATE TABLE kline_pattern_results_2026 PARTITION OF kline_pattern_results
    FOR VALUES FROM ('2026-01-01') TO ('2027-01-01');

CREATE TABLE kline_pattern_results_future PARTITION OF kline_pattern_results
    FOR VALUES FROM ('2027-01-01') TO (MAXVALUE);

-- ç´¢å¼•
CREATE INDEX idx_kline_ptn_stock_id ON kline_pattern_results(stock_id);
CREATE INDEX idx_kline_ptn_trade_date ON kline_pattern_results(trade_date);
CREATE INDEX idx_kline_ptn_pattern_id ON kline_pattern_results(pattern_id);
CREATE INDEX idx_kline_ptn_signal_type ON kline_pattern_results(signal_type);
CREATE INDEX idx_kline_ptn_strength ON kline_pattern_results(strength);

-- è¤‡åˆç´¢å¼•
CREATE INDEX idx_kline_ptn_stock_date ON kline_pattern_results(stock_id, trade_date);
CREATE INDEX idx_kline_ptn_date_signal ON kline_pattern_results(trade_date, signal_type);

-- è¡¨è¨»é‡‹
COMMENT ON TABLE kline_pattern_results IS 'K ç·šå‹æ…‹è¾¨è­˜çµæœè¡¨ï¼ˆæŒ‰å¹´ä»½åˆ†å€ï¼‰';
COMMENT ON COLUMN kline_pattern_results.involved_dates IS 'å‹æ…‹æ¶‰åŠçš„äº¤æ˜“æ—¥æœŸé™£åˆ—';
COMMENT ON COLUMN kline_pattern_results.candle_data IS 'K ç·šè©³ç´°è³‡æ–™ JSONB';
```

**JSONB candle_data çµæ§‹ç¯„ä¾‹**:

```json
{
  "candles": [
    {
      "date": "2024-12-22",
      "open": 578,
      "high": 580,
      "low": 565,
      "close": 568,
      "volume": 25000000,
      "body": -10,
      "upper_shadow": 2,
      "lower_shadow": 13
    },
    {
      "date": "2024-12-23",
      "open": 566,
      "high": 582,
      "low": 565,
      "close": 580,
      "volume": 32000000,
      "body": 14,
      "upper_shadow": 2,
      "lower_shadow": 1
    }
  ],
  "pattern_metrics": {
    "body_ratio": 1.4,
    "engulfing_ratio": 1.0,
    "volume_change_percent": 28
  }
}
```

---

### 2.2 chart_pattern_results (åœ–è¡¨å‹æ…‹è¾¨è­˜çµæœè¡¨)

å„²å­˜åœ–è¡¨å‹æ…‹è¾¨è­˜çµæœã€‚

```sql
CREATE TABLE chart_pattern_results (
    result_id           BIGSERIAL PRIMARY KEY,
    stock_id            VARCHAR(10) NOT NULL,
    detection_date      DATE NOT NULL,

    -- å‹æ…‹è³‡è¨Š
    pattern_id          VARCHAR(20) NOT NULL,
    pattern_name        VARCHAR(50) NOT NULL,
    english_name        VARCHAR(50),
    pattern_category    VARCHAR(20) NOT NULL,

    -- å‹æ…‹ç‹€æ…‹
    status              VARCHAR(20) NOT NULL DEFAULT 'FORMING',
    signal_type         VARCHAR(30) NOT NULL,
    strength            INTEGER NOT NULL,

    -- å½¢æˆæ™‚é–“
    formation_start     DATE NOT NULL,
    formation_end       DATE,
    duration_days       INTEGER,

    -- é—œéµåƒ¹ä½ï¼ˆJSONB å„²å­˜å½ˆæ€§çµæ§‹ï¼‰
    key_levels          JSONB NOT NULL,

    -- ç›®æ¨™èˆ‡æ­¢æ
    target_price        NUMERIC(10,2),
    stop_loss_price     NUMERIC(10,2),
    potential_move_pct  NUMERIC(5,2),
    risk_reward_ratio   NUMERIC(5,2),

    -- å®Œæˆæ¨™æº–
    completion_criteria TEXT,
    breakout_level      NUMERIC(10,2),
    breakout_direction  VARCHAR(10),

    -- æˆäº¤é‡åˆ†æ
    volume_pattern      VARCHAR(50),
    volume_confirmation BOOLEAN,

    -- å¯é åº¦å› ç´ 
    reliability_factors JSONB,

    -- æè¿°
    description         TEXT,

    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ç´„æŸ
    CHECK (pattern_category IN ('REVERSAL', 'CONTINUATION', 'GAP', 'BILATERAL')),
    CHECK (status IN ('FORMING', 'CONFIRMED', 'COMPLETED', 'FAILED', 'INVALIDATED')),
    CHECK (breakout_direction IN ('UP', 'DOWN', NULL))
);

-- ç´¢å¼•
CREATE INDEX idx_chart_ptn_stock_id ON chart_pattern_results(stock_id);
CREATE INDEX idx_chart_ptn_detection_date ON chart_pattern_results(detection_date);
CREATE INDEX idx_chart_ptn_pattern_id ON chart_pattern_results(pattern_id);
CREATE INDEX idx_chart_ptn_status ON chart_pattern_results(status);
CREATE INDEX idx_chart_ptn_signal_type ON chart_pattern_results(signal_type);

-- è¤‡åˆç´¢å¼•
CREATE INDEX idx_chart_ptn_stock_status ON chart_pattern_results(stock_id, status);
CREATE INDEX idx_chart_ptn_date_category ON chart_pattern_results(detection_date, pattern_category);

-- JSONB GIN ç´¢å¼•
CREATE INDEX idx_chart_ptn_key_levels ON chart_pattern_results USING GIN(key_levels);

-- è‡ªå‹•æ›´æ–° updated_at
CREATE TRIGGER update_chart_ptn_updated_at
    BEFORE UPDATE ON chart_pattern_results
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE chart_pattern_results IS 'åœ–è¡¨å‹æ…‹è¾¨è­˜çµæœè¡¨';
COMMENT ON COLUMN chart_pattern_results.key_levels IS 'é—œéµåƒ¹ä½ JSONBï¼ˆåŒ…å«å³°å€¼ã€è°·å€¼ã€é ¸ç·šç­‰ï¼‰';
COMMENT ON COLUMN chart_pattern_results.reliability_factors IS 'å¯é åº¦è©•ä¼°å› ç´  JSONB';
```

**JSONB key_levels çµæ§‹ç¯„ä¾‹**:

```json
{
  "pattern_type": "DOUBLE_TOP",
  "first_peak": {
    "date": "2024-11-25",
    "price": 598
  },
  "second_peak": {
    "date": "2024-12-15",
    "price": 595
  },
  "neckline": 565,
  "pattern_height": 33,
  "trough": {
    "date": "2024-12-05",
    "price": 565
  }
}
```

**JSONB reliability_factors çµæ§‹ç¯„ä¾‹**:

```json
{
  "time_symmetry": 85,
  "price_symmetry": 90,
  "volume_confirmation": 75,
  "trend_alignment": 80,
  "overall_score": 82.5
}
```

---

### 2.3 trend_analysis_results (è¶¨å‹¢åˆ†æçµæœè¡¨)

å„²å­˜è¶¨å‹¢åˆ†æçµæœã€‚

```sql
CREATE TABLE trend_analysis_results (
    result_id           BIGSERIAL PRIMARY KEY,
    stock_id            VARCHAR(10) NOT NULL,
    analysis_date       DATE NOT NULL,

    -- ä¸»è¦è¶¨å‹¢
    primary_trend_id    VARCHAR(20) NOT NULL,
    primary_trend_name  VARCHAR(30) NOT NULL,
    primary_strength    INTEGER NOT NULL,
    trend_duration_days INTEGER,
    trend_start_date    DATE,
    trend_start_price   NUMERIC(10,2),
    trend_gain_pct      NUMERIC(8,2),

    -- æ¬¡è¦è¶¨å‹¢
    secondary_trend_id  VARCHAR(20),
    secondary_trend_name VARCHAR(30),
    secondary_strength  INTEGER,

    -- å‡ç·šåˆ†æ
    ma5                 NUMERIC(10,2),
    ma10                NUMERIC(10,2),
    ma20                NUMERIC(10,2),
    ma60                NUMERIC(10,2),
    ma120               NUMERIC(10,2),
    ma_alignment        VARCHAR(20),
    ma_alignment_strength INTEGER,

    -- è¶¨å‹¢æŒ‡æ¨™
    adx_value           NUMERIC(5,2),
    di_plus             NUMERIC(5,2),
    di_minus            NUMERIC(5,2),
    trend_strength_level VARCHAR(20),

    -- çµæ§‹åˆ†æ
    higher_highs_count  INTEGER DEFAULT 0,
    higher_lows_count   INTEGER DEFAULT 0,
    lower_highs_count   INTEGER DEFAULT 0,
    lower_lows_count    INTEGER DEFAULT 0,
    structure_type      VARCHAR(20),

    -- è¶¨å‹¢å“è³ª
    consistency         NUMERIC(5,2),
    volatility          NUMERIC(5,2),
    momentum            VARCHAR(20),

    -- è©³ç´°åˆ†æï¼ˆJSONBï¼‰
    detailed_analysis   JSONB DEFAULT '{}',
    warnings            TEXT[],

    -- é æ¸¬
    short_term_forecast VARCHAR(20),
    medium_term_forecast VARCHAR(20),
    forecast_confidence INTEGER,

    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE (stock_id, analysis_date),

    -- ç´„æŸ
    CHECK (ma_alignment IN ('BULLISH', 'BEARISH', 'MIXED', 'NEUTRAL')),
    CHECK (structure_type IN ('BULLISH', 'BEARISH', 'NEUTRAL', 'TRANSITIONING')),
    CHECK (momentum IN ('POSITIVE', 'NEGATIVE', 'NEUTRAL', 'ACCELERATING', 'DECELERATING'))
);

-- ç´¢å¼•
CREATE INDEX idx_trend_stock_id ON trend_analysis_results(stock_id);
CREATE INDEX idx_trend_analysis_date ON trend_analysis_results(analysis_date);
CREATE INDEX idx_trend_primary_id ON trend_analysis_results(primary_trend_id);
CREATE INDEX idx_trend_ma_alignment ON trend_analysis_results(ma_alignment);

-- è¤‡åˆç´¢å¼•
CREATE INDEX idx_trend_stock_date ON trend_analysis_results(stock_id, analysis_date);

-- è‡ªå‹•æ›´æ–° updated_at
CREATE TRIGGER update_trend_updated_at
    BEFORE UPDATE ON trend_analysis_results
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE trend_analysis_results IS 'è¶¨å‹¢åˆ†æçµæœè¡¨';
COMMENT ON COLUMN trend_analysis_results.ma_alignment IS 'å‡ç·šæ’åˆ—ç‹€æ…‹';
COMMENT ON COLUMN trend_analysis_results.structure_type IS 'åƒ¹æ ¼çµæ§‹é¡å‹ï¼ˆé«˜ä½é»åˆ†æï¼‰';
```

**JSONB detailed_analysis çµæ§‹ç¯„ä¾‹**:

```json
{
  "key_levels": {
    "support_levels": [565, 550, 530],
    "resistance_levels": [590, 600, 620],
    "nearest_support": 565,
    "nearest_resistance": 590
  },
  "trend_quality": {
    "consistency": 78,
    "volatility": 15.2,
    "momentum": "POSITIVE"
  },
  "golden_death_cross": {
    "last_golden_cross": "2024-11-15",
    "last_death_cross": null
  },
  "forecast": {
    "short_term": "BULLISH",
    "medium_term": "BULLISH",
    "key_watch_levels": {
      "bullish_confirmation": 590,
      "bearish_warning": 565
    }
  }
}
```

---

### 2.4 support_resistance_levels (æ”¯æ’å£“åŠ›ä½è¡¨)

å„²å­˜è­˜åˆ¥å‡ºçš„æ”¯æ’èˆ‡å£“åŠ›ä½ã€‚

```sql
CREATE TABLE support_resistance_levels (
    level_id            BIGSERIAL PRIMARY KEY,
    stock_id            VARCHAR(10) NOT NULL,
    analysis_date       DATE NOT NULL,

    -- åƒ¹ä½è³‡è¨Š
    price_level         NUMERIC(10,2) NOT NULL,
    level_type          VARCHAR(15) NOT NULL,
    strength            INTEGER NOT NULL,

    -- è­˜åˆ¥ä¾†æº
    source_type         VARCHAR(30) NOT NULL,
    source_description  VARCHAR(100),

    -- æ¸¬è©¦ç´€éŒ„
    test_count          INTEGER DEFAULT 0,
    last_test_date      DATE,
    break_count         INTEGER DEFAULT 0,

    -- è·é›¢ç•¶å‰åƒ¹æ ¼
    current_price       NUMERIC(10,2),
    distance_percent    NUMERIC(8,2),

    -- ç‹€æ…‹
    is_active           BOOLEAN DEFAULT TRUE,
    invalidated_at      TIMESTAMP,
    invalidation_reason VARCHAR(100),

    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ç´„æŸ
    CHECK (level_type IN ('SUPPORT', 'RESISTANCE')),
    CHECK (source_type IN ('WAVE_PEAK', 'WAVE_TROUGH', 'MOVING_AVERAGE', 'VOLUME_PROFILE',
                           'PSYCHOLOGICAL', 'GAP', 'FIBONACCI', 'HISTORICAL', 'PIVOT'))
);

-- ç´¢å¼•
CREATE INDEX idx_sr_stock_id ON support_resistance_levels(stock_id);
CREATE INDEX idx_sr_analysis_date ON support_resistance_levels(analysis_date);
CREATE INDEX idx_sr_level_type ON support_resistance_levels(level_type);
CREATE INDEX idx_sr_is_active ON support_resistance_levels(is_active);

-- è¤‡åˆç´¢å¼•
CREATE INDEX idx_sr_stock_active ON support_resistance_levels(stock_id, is_active);
CREATE INDEX idx_sr_stock_date_type ON support_resistance_levels(stock_id, analysis_date, level_type);

-- è‡ªå‹•æ›´æ–° updated_at
CREATE TRIGGER update_sr_updated_at
    BEFORE UPDATE ON support_resistance_levels
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE support_resistance_levels IS 'æ”¯æ’å£“åŠ›ä½è¡¨';
COMMENT ON COLUMN support_resistance_levels.source_type IS 'è­˜åˆ¥ä¾†æºé¡å‹';
COMMENT ON COLUMN support_resistance_levels.test_count IS 'è©²åƒ¹ä½è¢«æ¸¬è©¦æ¬¡æ•¸';
```

---

### 2.5 pattern_signals (å‹æ…‹è¨Šè™Ÿè¡¨)

å„²å­˜å‹æ…‹ç›¸é—œçš„äº¤æ˜“è¨Šè™Ÿã€‚

```sql
CREATE TABLE pattern_signals (
    signal_id           BIGSERIAL PRIMARY KEY,
    stock_id            VARCHAR(10) NOT NULL,
    trade_date          DATE NOT NULL,

    -- è¨Šè™Ÿè³‡è¨Š
    signal_code         VARCHAR(20) NOT NULL,
    signal_name         VARCHAR(50) NOT NULL,
    signal_type         VARCHAR(10) NOT NULL,
    source_category     VARCHAR(15) NOT NULL,

    -- ä¾†æºå‹æ…‹
    source_pattern_id   VARCHAR(20),
    source_pattern_name VARCHAR(50),

    -- è§¸ç™¼è³‡è¨Š
    trigger_price       NUMERIC(10,2),
    current_price       NUMERIC(10,2),
    confidence          INTEGER NOT NULL,
    strength            VARCHAR(15) NOT NULL,

    -- ç›®æ¨™èˆ‡é¢¨éšª
    target_price        NUMERIC(10,2),
    stop_loss           NUMERIC(10,2),
    target_gain_pct     NUMERIC(5,2),
    stop_loss_pct       NUMERIC(5,2),
    risk_reward_ratio   NUMERIC(5,2),

    -- æ”¯æŒå› ç´ 
    supporting_factors  TEXT[],

    -- æè¿°
    description         TEXT,

    -- ç‹€æ…‹è¿½è¹¤
    status              VARCHAR(20) DEFAULT 'ACTIVE',
    outcome             VARCHAR(20),
    outcome_date        DATE,
    actual_gain_pct     NUMERIC(8,2),

    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ç´„æŸ
    CHECK (signal_type IN ('BUY', 'SELL', 'WATCH')),
    CHECK (source_category IN ('KLINE', 'CHART', 'TREND', 'SUPPORT_RESISTANCE')),
    CHECK (strength IN ('CRITICAL', 'HIGH', 'MEDIUM', 'LOW')),
    CHECK (status IN ('ACTIVE', 'TRIGGERED', 'EXPIRED', 'CANCELLED')),
    CHECK (outcome IN ('SUCCESS', 'FAILURE', 'PARTIAL', NULL))
);

-- ç´¢å¼•
CREATE INDEX idx_ptn_sig_stock_id ON pattern_signals(stock_id);
CREATE INDEX idx_ptn_sig_trade_date ON pattern_signals(trade_date);
CREATE INDEX idx_ptn_sig_signal_code ON pattern_signals(signal_code);
CREATE INDEX idx_ptn_sig_signal_type ON pattern_signals(signal_type);
CREATE INDEX idx_ptn_sig_source ON pattern_signals(source_category);
CREATE INDEX idx_ptn_sig_status ON pattern_signals(status);

-- è¤‡åˆç´¢å¼•
CREATE INDEX idx_ptn_sig_date_type ON pattern_signals(trade_date, signal_type);
CREATE INDEX idx_ptn_sig_stock_date ON pattern_signals(stock_id, trade_date);

-- è¡¨è¨»é‡‹
COMMENT ON TABLE pattern_signals IS 'å‹æ…‹è¨Šè™Ÿè¡¨';
COMMENT ON COLUMN pattern_signals.signal_code IS 'è¨Šè™Ÿä»£ç¢¼ï¼ˆå¦‚ PTN_SIG_001ï¼‰';
COMMENT ON COLUMN pattern_signals.supporting_factors IS 'æ”¯æŒå› ç´ é™£åˆ—';
```

**è¨Šè™Ÿä»£ç¢¼å°ç…§è¡¨**:

| signal_code | signal_name | signal_type | source_category | é è¨­ strength |
|-------------|-------------|-------------|-----------------|---------------|
| PTN_SIG_001 | çœ‹æ¼²Kç·šå‹æ…‹ | BUY | KLINE | MEDIUM |
| PTN_SIG_002 | çœ‹è·ŒKç·šå‹æ…‹ | SELL | KLINE | MEDIUM |
| PTN_SIG_003 | é ­è‚©é ‚å®Œæˆ | SELL | CHART | HIGH |
| PTN_SIG_004 | é ­è‚©åº•å®Œæˆ | BUY | CHART | HIGH |
| PTN_SIG_005 | é›™é‡é ‚ç¢ºèª | SELL | CHART | HIGH |
| PTN_SIG_006 | é›™é‡åº•ç¢ºèª | BUY | CHART | HIGH |
| PTN_SIG_007 | ä¸‰è§’å½¢çªç ´ | BUY/SELL | CHART | MEDIUM |
| PTN_SIG_008 | æ——å½¢çªç ´ | BUY/SELL | CHART | MEDIUM |
| PTN_SIG_009 | è¶¨å‹¢è½‰å¤š | BUY | TREND | HIGH |
| PTN_SIG_010 | è¶¨å‹¢è½‰ç©º | SELL | TREND | HIGH |
| PTN_SIG_011 | æ”¯æ’ç¢ºèª | BUY | SUPPORT_RESISTANCE | MEDIUM |
| PTN_SIG_012 | å£“åŠ›çªç ´ | BUY | SUPPORT_RESISTANCE | MEDIUM |
| PTN_SIG_013 | çªç ´ç¼ºå£ | BUY | CHART | HIGH |
| PTN_SIG_014 | å³¶ç‹€åè½‰ | BUY/SELL | CHART | CRITICAL |

---

### 2.6 pattern_statistics (å‹æ…‹çµ±è¨ˆè¡¨)

å„²å­˜å‹æ…‹æ­·å²çµ±è¨ˆè³‡æ–™ï¼Œå®šæœŸæ›´æ–°ã€‚

```sql
CREATE TABLE pattern_statistics (
    stat_id             BIGSERIAL PRIMARY KEY,
    stock_id            VARCHAR(10) NOT NULL,
    pattern_id          VARCHAR(20) NOT NULL,

    -- çµ±è¨ˆæœŸé–“
    stat_period_start   DATE NOT NULL,
    stat_period_end     DATE NOT NULL,
    trading_days        INTEGER,

    -- åŸºæœ¬çµ±è¨ˆ
    occurrence_count    INTEGER NOT NULL DEFAULT 0,
    success_count       INTEGER NOT NULL DEFAULT 0,
    failure_count       INTEGER NOT NULL DEFAULT 0,
    pending_count       INTEGER NOT NULL DEFAULT 0,
    success_rate        NUMERIC(5,2),

    -- æ”¶ç›Šçµ±è¨ˆ
    avg_gain_1d         NUMERIC(8,4),
    avg_gain_3d         NUMERIC(8,4),
    avg_gain_5d         NUMERIC(8,4),
    avg_gain_10d        NUMERIC(8,4),
    avg_gain_20d        NUMERIC(8,4),
    max_gain            NUMERIC(8,4),
    max_loss            NUMERIC(8,4),
    avg_loss_when_failed NUMERIC(8,4),

    -- æœ€ä½³æ¢ä»¶
    optimal_conditions  JSONB DEFAULT '{}',

    -- ä¿¡å¿ƒåº¦
    confidence          INTEGER,

    -- å¯©è¨ˆæ¬„ä½
    generated_at        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at          TIMESTAMP,

    UNIQUE (stock_id, pattern_id, stat_period_start, stat_period_end)
);

-- ç´¢å¼•
CREATE INDEX idx_ptn_stat_stock_id ON pattern_statistics(stock_id);
CREATE INDEX idx_ptn_stat_pattern_id ON pattern_statistics(pattern_id);
CREATE INDEX idx_ptn_stat_expires ON pattern_statistics(expires_at);

-- è¡¨è¨»é‡‹
COMMENT ON TABLE pattern_statistics IS 'å‹æ…‹çµ±è¨ˆè¡¨ï¼ˆå®šæœŸæ›´æ–°å¿«å–ï¼‰';
COMMENT ON COLUMN pattern_statistics.optimal_conditions IS 'æœ€ä½³è§¸ç™¼æ¢ä»¶ JSONB';
```

**JSONB optimal_conditions çµæ§‹ç¯„ä¾‹**:

```json
{
  "best_volume_ratio": ">1.5",
  "best_trend_context": "DOWNTREND",
  "best_strength_threshold": 70,
  "best_ma_alignment": "BEARISH",
  "notes": "å‡ºç¾åœ¨ä¸‹è·Œè¶¨å‹¢æœ«ç«¯ã€æˆäº¤é‡æ”¾å¤§æ™‚å‹ç‡æœ€é«˜"
}
```

---

## 3. MyBatis Mapper è¨­è¨ˆ

### 3.1 PatternAnalysisMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chris.fin_shark.m10.mapper.PatternAnalysisMapper">

    <!-- æ‰¹æ¬¡æ’å…¥ K ç·šå‹æ…‹çµæœ -->
    <insert id="batchInsertKLinePatterns" parameterType="list">
        INSERT INTO kline_pattern_results (
            stock_id, trade_date, pattern_id, pattern_name, english_name,
            pattern_category, signal_type, strength, confidence, involved_dates,
            pattern_low, pattern_high, candle_data, volume_confirmation,
            volume_ratio, trend_context, description
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.stockId}, #{item.tradeDate}, #{item.patternId},
                #{item.patternName}, #{item.englishName}, #{item.patternCategory},
                #{item.signalType}, #{item.strength}, #{item.confidence},
                #{item.involvedDates, typeHandler=com.chris.fin_shark.common.handler.DateArrayTypeHandler},
                #{item.patternLow}, #{item.patternHigh},
                #{item.candleData, typeHandler=com.chris.fin_shark.common.handler.JsonbTypeHandler},
                #{item.volumeConfirmation}, #{item.volumeRatio},
                #{item.trendContext}, #{item.description}
            )
        </foreach>
        ON CONFLICT (stock_id, trade_date, pattern_id) DO UPDATE SET
            strength = EXCLUDED.strength,
            confidence = EXCLUDED.confidence,
            volume_confirmation = EXCLUDED.volume_confirmation,
            description = EXCLUDED.description
    </insert>

    <!-- æŸ¥è©¢ K ç·šå‹æ…‹æƒæçµæœ -->
    <select id="scanKLinePatterns" resultType="com.chris.fin_shark.m10.dto.KLinePatternScanDTO">
        SELECT
            k.stock_id,
            s.stock_name,
            s.market_type,
            s.industry,
            p.close_price,
            p.change_percent,
            k.pattern_id,
            k.pattern_name,
            k.signal_type,
            k.strength,
            (p.volume::decimal / NULLIF(p.volume_ma20, 0)) as volume_ratio
        FROM kline_pattern_results k
        JOIN stocks s ON k.stock_id = s.stock_id
        LEFT JOIN stock_prices p ON k.stock_id = p.stock_id AND k.trade_date = p.trade_date
        WHERE k.trade_date = #{tradeDate}
          AND s.is_active = true
          <if test="patternTypes != null and patternTypes.size() > 0">
              AND k.pattern_id IN
              <foreach collection="patternTypes" item="type" open="(" separator="," close=")">
                  #{type}
              </foreach>
          </if>
          <if test="signalFilter != null and signalFilter != 'all'">
              AND k.signal_type LIKE CONCAT(#{signalFilter}, '%')
          </if>
          <if test="minStrength != null">
              AND k.strength >= #{minStrength}
          </if>
          <if test="marketType != null and marketType != 'all'">
              AND s.market_type = #{marketType}
          </if>
        ORDER BY k.strength DESC
        LIMIT #{limit}
    </select>

    <!-- æŸ¥è©¢åœ–è¡¨å‹æ…‹ï¼ˆå«é—œéµåƒ¹ä½ï¼‰ -->
    <select id="selectChartPatterns" resultType="com.chris.fin_shark.m10.dto.ChartPatternDTO">
        SELECT
            c.result_id,
            c.stock_id,
            c.pattern_id,
            c.pattern_name,
            c.english_name,
            c.pattern_category,
            c.status,
            c.signal_type,
            c.strength,
            c.formation_start,
            c.formation_end,
            c.duration_days,
            c.key_levels,
            c.target_price,
            c.stop_loss_price,
            c.potential_move_pct,
            c.risk_reward_ratio,
            c.completion_criteria,
            c.breakout_level,
            c.volume_pattern,
            c.reliability_factors,
            c.description
        FROM chart_pattern_results c
        WHERE c.stock_id = #{stockId}
          AND c.detection_date >= #{startDate}
          AND c.detection_date <= #{endDate}
          <if test="status != null and status != 'all'">
              AND c.status = #{status}
          </if>
          <if test="minStrength != null">
              AND c.strength >= #{minStrength}
          </if>
        ORDER BY c.detection_date DESC, c.strength DESC
    </select>

    <!-- æŸ¥è©¢æ”¯æ’å£“åŠ›ä½ -->
    <select id="selectSupportResistanceLevels" resultType="com.chris.fin_shark.m10.dto.SupportResistanceDTO">
        SELECT
            level_id,
            stock_id,
            price_level,
            level_type,
            strength,
            source_type,
            source_description,
            test_count,
            last_test_date,
            current_price,
            distance_percent
        FROM support_resistance_levels
        WHERE stock_id = #{stockId}
          AND analysis_date = #{analysisDate}
          AND is_active = true
        ORDER BY
            CASE level_type
                WHEN 'SUPPORT' THEN price_level
                WHEN 'RESISTANCE' THEN -price_level
            END DESC,
            strength DESC
        LIMIT #{maxLevels}
    </select>

    <!-- æŸ¥è©¢å‹æ…‹æ­·å²çµ±è¨ˆ -->
    <select id="selectPatternStatistics" resultType="com.chris.fin_shark.m10.dto.PatternStatisticsDTO">
        SELECT
            pattern_id,
            occurrence_count,
            success_rate,
            avg_gain_1d,
            avg_gain_5d,
            avg_gain_10d,
            avg_gain_20d,
            max_gain,
            max_loss,
            optimal_conditions,
            confidence
        FROM pattern_statistics
        WHERE stock_id = #{stockId}
          AND stat_period_end >= #{minDate}
          <if test="patternId != null">
              AND pattern_id = #{patternId}
          </if>
        ORDER BY occurrence_count DESC
    </select>

    <!-- æ³¢å³°æ³¢è°·è­˜åˆ¥æŸ¥è©¢ -->
    <select id="selectPeaksAndTroughs" resultType="com.chris.fin_shark.m10.dto.PeakTroughDTO">
        WITH price_data AS (
            SELECT
                trade_date,
                high,
                low,
                close,
                LAG(high, 1) OVER (ORDER BY trade_date) as prev_high,
                LAG(low, 1) OVER (ORDER BY trade_date) as prev_low,
                LEAD(high, 1) OVER (ORDER BY trade_date) as next_high,
                LEAD(low, 1) OVER (ORDER BY trade_date) as next_low
            FROM stock_prices
            WHERE stock_id = #{stockId}
              AND trade_date BETWEEN #{startDate} AND #{endDate}
        )
        SELECT
            trade_date,
            CASE
                WHEN high > prev_high AND high > next_high THEN 'PEAK'
                WHEN low < prev_low AND low < next_low THEN 'TROUGH'
                ELSE NULL
            END as point_type,
            CASE
                WHEN high > prev_high AND high > next_high THEN high
                WHEN low < prev_low AND low < next_low THEN low
                ELSE NULL
            END as price
        FROM price_data
        WHERE (high > prev_high AND high > next_high)
           OR (low < prev_low AND low < next_low)
        ORDER BY trade_date
    </select>

</mapper>
```

---

## 4. è³‡æ–™é—œè¯åœ–

```
M06 è³‡æ–™è¡¨ï¼ˆè³‡æ–™ä¾†æºï¼‰                    M10 è³‡æ–™è¡¨ï¼ˆåˆ†æçµæœï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    stock_prices      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚ kline_pattern_results â”‚
â”‚ (è‚¡åƒ¹ OHLCV)         â”‚                â”‚ (K ç·šå‹æ…‹çµæœ)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                       â”‚
           â”‚                                       â†“
           â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                            â”‚ chart_pattern_results â”‚
           â”‚                            â”‚ (åœ–è¡¨å‹æ…‹çµæœ)        â”‚
           â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                       â”‚
           â†“                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       stocks         â”‚                â”‚ trend_analysis_resultsâ”‚
â”‚ (è‚¡ç¥¨åŸºæœ¬è³‡æ–™)        â”‚                â”‚ (è¶¨å‹¢åˆ†æçµæœ)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
M07 è³‡æ–™è¡¨ï¼ˆä¾è³´ï¼‰                                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚technical_indicator_  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚support_resistance_   â”‚
â”‚      results         â”‚                â”‚      levels          â”‚
â”‚ (æŠ€è¡“æŒ‡æ¨™çµæœ)        â”‚                â”‚ (æ”¯æ’å£“åŠ›ä½)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â†“
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚   pattern_signals    â”‚
                                        â”‚ (å‹æ…‹è¨Šè™Ÿ)           â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â†“
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚  pattern_statistics  â”‚
                                        â”‚ (å‹æ…‹çµ±è¨ˆ)           â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ç´¢å¼•ç­–ç•¥

### 5.1 ä¸»è¦æŸ¥è©¢å ´æ™¯èˆ‡ç´¢å¼•

| æŸ¥è©¢å ´æ™¯ | ä½¿ç”¨ç´¢å¼• | èªªæ˜ |
|---------|---------|------|
| å–®ä¸€è‚¡ç¥¨ K ç·šå‹æ…‹æŸ¥è©¢ | idx_kline_ptn_stock_date | æœ€å¸¸ç”¨æŸ¥è©¢ |
| å…¨å¸‚å ´å‹æ…‹æƒæ | idx_kline_ptn_date_signal | æ—¥æœŸ + è¨Šè™Ÿé¡å‹ |
| åœ–è¡¨å‹æ…‹ç‹€æ…‹æŸ¥è©¢ | idx_chart_ptn_stock_status | ç¯©é¸ç‰¹å®šç‹€æ…‹ |
| æ”¯æ’å£“åŠ›ä½æŸ¥è©¢ | idx_sr_stock_active | åªæŸ¥è©¢æœ‰æ•ˆåƒ¹ä½ |
| å‹æ…‹è¨Šè™ŸæŸ¥è©¢ | idx_ptn_sig_date_type | æ—¥æœŸ + è¨Šè™Ÿé¡å‹ |
| JSONB é—œéµåƒ¹ä½æŸ¥è©¢ | idx_chart_ptn_key_levels | GIN ç´¢å¼• |

### 5.2 åˆ†å€ç­–ç•¥

- `kline_pattern_results` æŒ‰å¹´ä»½åˆ†å€
- æŸ¥è©¢æ™‚è‡ªå‹•è£å‰ªä¸ç›¸é—œåˆ†å€
- æ­·å²è³‡æ–™å¯ç›´æ¥ DETACH èˆŠå¹´ä»½åˆ†å€é€²è¡Œæ­¸æª”

### 5.3 è³‡æ–™ä¿ç•™ç­–ç•¥

| è³‡æ–™è¡¨ | ä¿ç•™æœŸé™ | æ­¸æª”ç­–ç•¥ |
|-------|---------|---------|
| kline_pattern_results | 3 å¹´ | å¹´åº¦åˆ†å€æ­¸æª” |
| chart_pattern_results | 3 å¹´ | æŒ‰å¹´ä»½åˆªé™¤èˆŠè³‡æ–™ |
| trend_analysis_results | 1 å¹´ | ä¿ç•™æœ€æ–°è³‡æ–™ |
| support_resistance_levels | 6 å€‹æœˆ | å®šæœŸæ¸…ç†å¤±æ•ˆè³‡æ–™ |
| pattern_signals | 2 å¹´ | æŒ‰ç‹€æ…‹æ­¸æª” |
| pattern_statistics | æ°¸ä¹… | å®šæœŸæ›´æ–° |

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [M10 åŠŸèƒ½éœ€æ±‚](../specs/functional/M10-æŠ€è¡“å‹æ…‹è¾¨è­˜åŠŸèƒ½éœ€æ±‚.md)
- [M10 APIè¦æ ¼](../specs/api/M10-APIè¦æ ¼.md)
- [M10 ERD](./erd/M10-ERD.md)
- [M06 è³‡æ–™åº«è¨­è¨ˆ](./M06-è³‡æ–™åº«è¨­è¨ˆ.md)
- [M07 è³‡æ–™åº«è¨­è¨ˆ](./M07-è³‡æ–™åº«è¨­è¨ˆ.md)

---

**æ–‡ä»¶ç¶­è­·è€…**: è³‡æ–™åº«æ¶æ§‹å¸«
**æœ€å¾Œæ›´æ–°**: 2026-01-12
**ä¸‹æ¬¡å¯©æ ¸**: 2026-03-31
