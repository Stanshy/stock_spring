# M06-資料管理模組效能考量

> **文件編號**: PERF-M06  
> **模組名稱**: 資料管理模組  
> **版本**: v2.0  
> **最後更新**: 2025-12-31  
> **狀態**: Draft

---

## 9. 效能考量

### 9.1 效能目標

| 指標 | 目標值 | 測量方式 | 說明 |
|-----|-------|---------|------|
| API 回應時間（單一股票） | P95 < 100ms | APM 監控 | 含快取命中 |
| API 回應時間（範圍查詢） | P95 < 300ms | APM 監控 | 查詢 1 年資料 |
| 股價同步 Job 執行時間 | < 5 分鐘 | Job 執行記錄 | 1800 檔股票 |
| 快取命中率 | > 80% | Redis 統計 | 熱門股票 |
| 資料庫查詢時間 | < 50ms | 慢查詢日誌 | 單表查詢，有索引 |

---

### 9.2 效能優化策略

#### 9.2.1 資料庫優化

**索引優化**:
- 所有常用查詢欄位都建立索引
- 複合索引順序：選擇性高的欄位在前
- 範例：(stock_id, trade_date) 而非 (trade_date, stock_id)
- 定期執行 `ANALYZE` 更新統計資訊

**查詢優化**:
- 避免 SELECT *，只查詢需要的欄位
- 使用 LIMIT 限制查詢筆數
- 批次查詢替代逐筆查詢
  - 不良範例：循環執行 1800 次單筆查詢
  - 良好範例：使用 WHERE stock_id IN (...) 一次查詢

**分區優化**:
- stock_prices 表按年份分區
- 查詢時自動裁剪不相關分區
- 範例：查詢 2024 年資料，只掃描 stock_prices_2024 分區

**連線池優化**:
- PostgreSQL 連線池大小：50-100
- 連線超時時間：30 秒
- 最大閒置連線數：10

---

#### 9.2.2 快取優化

**多層快取架構**:
```
請求 
  ↓
Redis（L1 快取，熱資料）
  ↓ 未命中
PostgreSQL（資料庫）
  ↓
返回資料並寫入 Redis
```

**快取預熱**:
- 系統啟動時預載熱門股票（市值前 50）資料
- 每日 Job 完成後批次更新快取
- 預熱時間：< 30 秒

**快取穿透防護**:
- 布隆過濾器（Bloom Filter）檢查股票是否存在
- 空值快取（TTL 較短，5 分鐘），避免惡意查詢

**快取雪崩防護**:
- TTL 加入隨機值（±10%），避免大量快取同時失效
- 範例：TTL = 6 小時 ± 36 分鐘

**快取擊穿防護**:
- 熱門資料使用分散式鎖（Redis SET NX）
- 只允許一個請求查詢資料庫，其他請求等待

---

#### 9.2.3 批次處理優化

**批次大小調整**:
- 股價同步：每批 50 檔股票（API 限制）
- 資料庫 UPSERT：每批 100 筆（效能最佳）

**並行處理**:
- 使用執行緒池（ThreadPoolExecutor）
- 執行緒池大小：CPU 核心數 × 2
- 注意：避免過度並行導致資料庫連線耗盡

**連線池優化**:
- MySQL 連線池大小：50-100
- Redis 連線池大小：20-50
- 連線超時時間：30 秒

**批次寫入優化（MyBatis）**:
```sql
-- 使用 PostgreSQL COPY 命令（更快）
COPY stock_prices (stock_id, trade_date, open_price, ...)
FROM STDIN WITH (FORMAT csv);

-- 或使用批次 INSERT
INSERT INTO stock_prices VALUES
  (row1), (row2), ..., (row100)
ON CONFLICT (stock_id, trade_date) DO UPDATE ...;
```

---

### 9.3 容量規劃

#### 9.3.1 資料量估算

**stock_prices 表**:
```
每日新增: 1800 檔股票 × 1 筆 = 1,800 筆/日
每年新增: 1,800 × 250 交易日 = 450,000 筆/年
20 年累積: 450,000 × 20 = 9,000,000 筆

單筆大小約 150 bytes（含索引）
總容量: 9,000,000 × 150 bytes ≈ 1.35 GB

加上分區索引、JSONB 額外空間:
實際容量: 約 3-4 GB（20 年資料）
```

**financial_statements 表**:
```
每年新增: 1800 檔股票 × 4 季 = 7,200 筆/年
10 年累積: 72,000 筆

單筆大小約 1 KB（含 JSONB）
總容量: 72,000 × 1 KB ≈ 72 MB

加上 GIN 索引:
實際容量: 約 200 MB（10 年資料）
```

**institutional_trading 表**:
```
類似 stock_prices
5 年累積: 1,800 × 250 × 5 = 2,250,000 筆
總容量: 約 500 MB
```

**總計（20 年資料）**:
- 資料表大小: 約 4-5 GB
- 含索引與備份: 約 15-20 GB
- PostgreSQL WAL 日誌: 約 5 GB

#### 9.3.2 硬體需求建議

**開發/測試環境**:
- CPU: 2 核
- RAM: 4 GB
- Disk: 50 GB SSD
- PostgreSQL shared_buffers: 1 GB
- Redis: 512 MB

**生產環境（單機）**:
- CPU: 8 核
- RAM: 32 GB
- Disk: 500 GB SSD（含備份空間）
- PostgreSQL shared_buffers: 8 GB
- PostgreSQL effective_cache_size: 24 GB
- Redis: 4 GB

**生產環境（高可用）**:
- 主從架構：1 主 + 2 從
- 負載均衡：讀寫分離
- 備份策略：每日全量備份 + WAL 歸檔

---

### 9.4 監控指標

| 指標類型 | 指標名稱 | 閾值 | 告警等級 |
|---------|---------|------|---------|
| API 效能 | P95 回應時間 | > 500ms | WARNING |
| API 效能 | P99 回應時間 | > 1000ms | ERROR |
| 資料庫 | 慢查詢數量 | > 10/分鐘 | WARNING |
| 資料庫 | 連線池使用率 | > 80% | WARNING |
| 資料庫 | Disk I/O 使用率 | > 80% | ERROR |
| 快取 | Redis 記憶體使用率 | > 80% | WARNING |
| 快取 | 快取命中率 | < 70% | WARNING |
| Job 效能 | Job 執行時長 | > 預估時長 × 2 | WARNING |

---



---

## 📚 相關文檔

- [M06 功能需求](../specs/functional/M06-資料管理功能需求.md)
- [M06 資料庫設計](./M06-資料庫設計.md)
- [M06 Job排程配置](../deployment/M06-Job排程配置.md)
- [NFR非功能性需求](../specs/technical/00-NFR非功能性需求.md)

---

**文件維護者**: 效能工程師  
**最後更新**: 2025-12-31  
**下次審核**: 2026-02-28
