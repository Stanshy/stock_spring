# M06-è³‡æ–™ç®¡ç†æ¨¡çµ„è³‡æ–™åº«è¨­è¨ˆ

> **æ–‡ä»¶ç·¨è™Ÿ**: DB-M06  
> **æ¨¡çµ„åç¨±**: è³‡æ–™ç®¡ç†æ¨¡çµ„  
> **ç‰ˆæœ¬**: v2.0  
> **æœ€å¾Œæ›´æ–°**: 2025-12-31  
> **ç‹€æ…‹**: Draft

---

## ğŸ“‹ è³‡æ–™åº«è¨­è¨ˆç¸½è¦½

æœ¬æ–‡ä»¶å®šç¾© è³‡æ–™ç®¡ç†æ¨¡çµ„çš„æ‰€æœ‰è³‡æ–™è¡¨çµæ§‹ã€‚

---

## 3. è³‡æ–™è¨­è¨ˆ

### 3.1 è³‡æ–™è¡¨æ¸…å–®

| è¡¨å | èªªæ˜ | æŒä¹…å±¤ | ç‰¹æ®ŠåŠŸèƒ½ |
|-----|------|-------|---------|
| stocks | è‚¡ç¥¨åŸºæœ¬è³‡æ–™è¡¨ | JPA | é™£åˆ—æ¬„ä½ã€JSONB |
| stock_prices | è‚¡åƒ¹æ­·å²è³‡æ–™è¡¨ | JPA + MyBatis | åˆ†å€ã€è¨ˆç®—æ¬„ä½ |
| financial_statements | è²¡å‹™å ±è¡¨è³‡æ–™è¡¨ | MyBatis | JSONBã€GIN ç´¢å¼• |
| institutional_trading | ä¸‰å¤§æ³•äººè²·è³£è¶…è³‡æ–™è¡¨ | JPA + MyBatis | è¨ˆç®—æ¬„ä½ |
| margin_trading | èè³‡èåˆ¸è³‡æ–™è¡¨ | JPA + MyBatis | è¨ˆç®—æ¬„ä½ |
| trading_calendar | äº¤æ˜“æ—¥æ›†è¡¨ | JPA | è¨ˆç®—æ¬„ä½ |

### 3.2 è³‡æ–™è¡¨è¨­è¨ˆ

#### 3.2.1 stocks (è‚¡ç¥¨åŸºæœ¬è³‡æ–™è¡¨)

```sql
-- PostgreSQL å»ºè¡¨èªæ³•
CREATE TABLE stocks (
    stock_id        VARCHAR(10) PRIMARY KEY,
    stock_name      VARCHAR(50) NOT NULL,
    stock_name_en   VARCHAR(100),
    market_type     VARCHAR(20) NOT NULL CHECK (market_type IN ('TWSE', 'OTC', 'EMERGING')),
    industry        VARCHAR(50),
    sector          VARCHAR(50),
    listing_date    DATE,
    delisting_date  DATE,
    is_active       BOOLEAN DEFAULT TRUE,
    
    -- åŸºæœ¬è³‡è¨Š
    par_value       NUMERIC(10,2),
    issued_shares   BIGINT,
    market_cap      NUMERIC(20,2),
    
    -- åˆ†é¡æ¨™ç±¤ï¼ˆä½¿ç”¨ PostgreSQL é™£åˆ—å‹æ…‹ï¼‰
    tags            TEXT[] DEFAULT '{}',
    
    -- é¡å¤–è³‡è¨Šï¼ˆä½¿ç”¨ JSONBï¼‰
    extra_info      JSONB DEFAULT '{}',
    
    -- å¯©è¨ˆæ¬„ä½
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç´„æŸ
    CHECK (issued_shares >= 0),
    CHECK (market_cap >= 0)
);

-- ç´¢å¼•
CREATE INDEX idx_stocks_market_type ON stocks(market_type);
CREATE INDEX idx_stocks_industry ON stocks(industry);
CREATE INDEX idx_stocks_is_active ON stocks(is_active);
CREATE INDEX idx_stocks_tags ON stocks USING GIN(tags);  -- GIN ç´¢å¼•æ”¯æ´é™£åˆ—æŸ¥è©¢
CREATE INDEX idx_stocks_extra_info ON stocks USING GIN(extra_info);  -- GIN ç´¢å¼•æ”¯æ´ JSONB

-- è‡ªå‹•æ›´æ–° updated_at è§¸ç™¼å™¨
CREATE TRIGGER update_stocks_updated_at
    BEFORE UPDATE ON stocks
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE stocks IS 'è‚¡ç¥¨åŸºæœ¬è³‡æ–™è¡¨';
COMMENT ON COLUMN stocks.stock_id IS 'è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¦‚ 2330ï¼‰';
COMMENT ON COLUMN stocks.tags IS 'è‚¡ç¥¨æ¨™ç±¤é™£åˆ—ï¼ˆå¦‚: {åŠå°é«”, AI, ESG}ï¼‰';
COMMENT ON COLUMN stocks.extra_info IS 'é¡å¤–è³‡è¨Š JSONBï¼ˆå¦‚: ç¶²ç«™ã€è‘£äº‹é•·ç­‰ï¼‰';
```

**è¨­è¨ˆèªªæ˜**:
- ä½¿ç”¨ PostgreSQL **é™£åˆ—å‹æ…‹** (TEXT[]) å„²å­˜è‚¡ç¥¨æ¨™ç±¤
- ä½¿ç”¨ **JSONB** å„²å­˜é¡å¤–è³‡è¨Šï¼Œå½ˆæ€§æ“´å……
- GIN ç´¢å¼•åŠ é€Ÿé™£åˆ—èˆ‡ JSONB æŸ¥è©¢
- ä¸»éµç‚º stock_id

**JSONB çµæ§‹ç¯„ä¾‹**:
```json
{
  "website": "https://www.tsmc.com",
  "chairman": "åŠ‰å¾·éŸ³",
  "ceo": "é­å“²å®¶",
  "employee_count": 75000,
  "founded_year": 1987
}
```

**é™£åˆ—æŸ¥è©¢ç¯„ä¾‹**:
```sql
-- æŸ¥è©¢åŒ…å«ç‰¹å®šæ¨™ç±¤çš„è‚¡ç¥¨
SELECT * FROM stocks WHERE 'AI' = ANY(tags);

-- æŸ¥è©¢åŒ…å«ä»»ä¸€æ¨™ç±¤çš„è‚¡ç¥¨
SELECT * FROM stocks WHERE tags && ARRAY['AI', 'åŠå°é«”'];

-- æŸ¥è©¢åŒ…å«æ‰€æœ‰æ¨™ç±¤çš„è‚¡ç¥¨
SELECT * FROM stocks WHERE tags @> ARRAY['AI', 'åŠå°é«”'];
```

---

#### 3.2.2 stock_prices (è‚¡åƒ¹æ­·å²è³‡æ–™è¡¨)

```sql
-- PostgreSQL å»ºè¡¨èªæ³•ï¼ˆä½¿ç”¨åˆ†å€ï¼‰
CREATE TABLE stock_prices (
    price_id        BIGSERIAL,
    stock_id        VARCHAR(10) NOT NULL,
    trade_date      DATE NOT NULL,
    
    -- OHLCV
    open_price      NUMERIC(10,2) NOT NULL,
    high_price      NUMERIC(10,2) NOT NULL,
    low_price       NUMERIC(10,2) NOT NULL,
    close_price     NUMERIC(10,2) NOT NULL,
    volume          BIGINT NOT NULL,
    
    -- é¡å¤–è³‡è¨Š
    turnover        NUMERIC(20,2),
    transactions    INTEGER,
    change_price    NUMERIC(10,2),
    change_percent  NUMERIC(5,2),
    
    -- æŠ€è¡“æŒ‡æ¨™å¿«é€ŸæŸ¥è©¢æ¬„ä½ï¼ˆå†—é¤˜ï¼Œç”± M07 è¨ˆç®—å¾Œå›å¯«ï¼‰
    ma5             NUMERIC(10,2),
    ma20            NUMERIC(10,2),
    volume_ma5      BIGINT,
    
    -- å¯©è¨ˆæ¬„ä½
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (price_id, trade_date),  -- åˆ†å€è¡¨çš„ä¸»éµå¿…é ˆåŒ…å«åˆ†å€éµ
    UNIQUE (stock_id, trade_date),
    
    -- ç´„æŸ
    CHECK (open_price >= 0),
    CHECK (high_price >= low_price),
    CHECK (low_price <= open_price),
    CHECK (low_price <= close_price),
    CHECK (high_price >= open_price),
    CHECK (high_price >= close_price),
    CHECK (volume >= 0),
    
    FOREIGN KEY (stock_id) REFERENCES stocks(stock_id) ON DELETE CASCADE
) PARTITION BY RANGE (trade_date);

-- å»ºç«‹åˆ†å€ï¼ˆæŒ‰å¹´ä»½ï¼‰
CREATE TABLE stock_prices_2023 PARTITION OF stock_prices
    FOR VALUES FROM ('2023-01-01') TO ('2024-01-01');
    
CREATE TABLE stock_prices_2024 PARTITION OF stock_prices
    FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
    
CREATE TABLE stock_prices_2025 PARTITION OF stock_prices
    FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');
    
-- é ç•™æœªä¾†åˆ†å€
CREATE TABLE stock_prices_future PARTITION OF stock_prices
    FOR VALUES FROM ('2026-01-01') TO (MAXVALUE);

-- ç´¢å¼•ï¼ˆæœƒè‡ªå‹•åœ¨æ¯å€‹åˆ†å€å»ºç«‹ï¼‰
CREATE INDEX idx_stock_prices_stock_id ON stock_prices(stock_id);
CREATE INDEX idx_stock_prices_trade_date ON stock_prices(trade_date);

-- è‡ªå‹•æ›´æ–° updated_at è§¸ç™¼å™¨
CREATE TRIGGER update_stock_prices_updated_at
    BEFORE UPDATE ON stock_prices
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE stock_prices IS 'è‚¡åƒ¹æ­·å²è³‡æ–™è¡¨ï¼ˆä½¿ç”¨åˆ†å€å„ªåŒ–æŸ¥è©¢ï¼‰';
COMMENT ON COLUMN stock_prices.ma5 IS '5æ—¥å‡ç·šï¼ˆå†—é¤˜æ¬„ä½ï¼Œç”±M07è¨ˆç®—ï¼‰';
```

**è¨­è¨ˆèªªæ˜**:
- ä½¿ç”¨ PostgreSQL **åˆ†å€ï¼ˆPartitioningï¼‰** å„ªåŒ–å¤§é‡æ­·å²è³‡æ–™æŸ¥è©¢
- åˆ†å€ç­–ç•¥ï¼šæŒ‰å¹´ä»½ RANGE åˆ†å€ï¼ŒæŸ¥è©¢æ™‚è‡ªå‹•è£å‰ªä¸ç›¸é—œåˆ†å€
- ä½¿ç”¨ UNIQUE (stock_id, trade_date) ç¢ºä¿å”¯ä¸€æ€§
- é ç•™æŠ€è¡“æŒ‡æ¨™å†—é¤˜æ¬„ä½ï¼ˆma5, ma20ï¼‰ï¼Œç”± M07 è¨ˆç®—å¾Œå›å¯«
- CHECK ç´„æŸä¿è­‰å››åƒ¹é—œä¿‚

**åˆ†å€å„ªå‹¢**:
- æŸ¥è©¢ç‰¹å®šå¹´ä»½æ™‚ï¼Œåªæƒæè©²å¹´ä»½åˆ†å€ï¼Œæ•ˆèƒ½å¤§å¹…æå‡
- æ­¸æª”èˆŠè³‡æ–™æ™‚ï¼Œç›´æ¥ DETACH åˆ†å€å³å¯
- ç¶­è­·ç´¢å¼•æ›´å®¹æ˜“ï¼ˆåˆ†å€ç´¢å¼•è¼ƒå°ï¼‰

**UPSERT èªæ³•ï¼ˆMyBatisï¼‰**:
```sql
INSERT INTO stock_prices (
    stock_id, trade_date, open_price, high_price, low_price, 
    close_price, volume, turnover, transactions, 
    change_price, change_percent
) VALUES (
    '2330', '2024-12-24', 575.00, 582.00, 573.00, 
    580.00, 35000000, 20300000000, 125000, 
    5.00, 0.87
)
ON CONFLICT (stock_id, trade_date)
DO UPDATE SET
    open_price = EXCLUDED.open_price,
    high_price = EXCLUDED.high_price,
    low_price = EXCLUDED.low_price,
    close_price = EXCLUDED.close_price,
    volume = EXCLUDED.volume,
    turnover = EXCLUDED.turnover,
    transactions = EXCLUDED.transactions,
    change_price = EXCLUDED.change_price,
    change_percent = EXCLUDED.change_percent,
    updated_at = CURRENT_TIMESTAMP;
```

---

#### 3.2.3 financial_statements (è²¡å‹™å ±è¡¨è³‡æ–™è¡¨)

```sql
-- PostgreSQL å»ºè¡¨èªæ³•
CREATE TABLE financial_statements (
    statement_id    BIGSERIAL PRIMARY KEY,
    stock_id        VARCHAR(10) NOT NULL,
    year            INTEGER NOT NULL,
    quarter         SMALLINT NOT NULL CHECK (quarter BETWEEN 1 AND 4),
    report_type     VARCHAR(2) NOT NULL CHECK (report_type IN ('Q', 'A')),
    
    -- æç›Šè¡¨ï¼ˆæ ¸å¿ƒæ¬„ä½ï¼‰
    revenue         NUMERIC(20,2),
    operating_income NUMERIC(20,2),
    net_income      NUMERIC(20,2),
    gross_profit    NUMERIC(20,2),
    operating_expense NUMERIC(20,2),
    
    -- è³‡ç”¢è² å‚µè¡¨ï¼ˆæ ¸å¿ƒæ¬„ä½ï¼‰
    total_assets    NUMERIC(20,2),
    total_liabilities NUMERIC(20,2),
    equity          NUMERIC(20,2),
    current_assets  NUMERIC(20,2),
    current_liabilities NUMERIC(20,2),
    
    -- ç¾é‡‘æµé‡è¡¨ï¼ˆæ ¸å¿ƒæ¬„ä½ï¼‰
    operating_cash_flow NUMERIC(20,2),
    investing_cash_flow NUMERIC(20,2),
    financing_cash_flow NUMERIC(20,2),
    free_cash_flow  NUMERIC(20,2),
    
    -- æ¯è‚¡æŒ‡æ¨™
    eps             NUMERIC(10,2),
    bps             NUMERIC(10,2),
    
    -- è©³ç´°è³‡æ–™ï¼ˆä½¿ç”¨ JSONB å„²å­˜å®Œæ•´è²¡å ±ï¼‰
    income_statement    JSONB DEFAULT '{}',
    balance_sheet       JSONB DEFAULT '{}',
    cash_flow_statement JSONB DEFAULT '{}',
    financial_ratios    JSONB DEFAULT '{}',
    
    -- å¯©è¨ˆæ¬„ä½
    publish_date    DATE,
    source          VARCHAR(50),
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE (stock_id, year, quarter, report_type),
    FOREIGN KEY (stock_id) REFERENCES stocks(stock_id) ON DELETE CASCADE,
    
    -- ç´„æŸ
    CHECK (total_assets >= 0),
    CHECK (equity >= 0)
);

-- ç´¢å¼•
CREATE INDEX idx_financial_statements_stock_id ON financial_statements(stock_id);
CREATE INDEX idx_financial_statements_year_quarter ON financial_statements(year, quarter);
CREATE INDEX idx_financial_statements_publish_date ON financial_statements(publish_date);

-- JSONB GIN ç´¢å¼•ï¼ˆåŠ é€Ÿ JSON æŸ¥è©¢ï¼‰
CREATE INDEX idx_financial_income_statement ON financial_statements USING GIN(income_statement);
CREATE INDEX idx_financial_balance_sheet ON financial_statements USING GIN(balance_sheet);
CREATE INDEX idx_financial_ratios ON financial_statements USING GIN(financial_ratios);

-- è‡ªå‹•æ›´æ–° updated_at
CREATE TRIGGER update_financial_statements_updated_at
    BEFORE UPDATE ON financial_statements
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE financial_statements IS 'è²¡å‹™å ±è¡¨è³‡æ–™è¡¨ï¼ˆæ ¸å¿ƒæ¬„ä½+JSONBè©³ç´°è³‡æ–™ï¼‰';
COMMENT ON COLUMN financial_statements.income_statement IS 'å®Œæ•´æç›Šè¡¨ JSONB';
COMMENT ON COLUMN financial_statements.balance_sheet IS 'å®Œæ•´è³‡ç”¢è² å‚µè¡¨ JSONB';
COMMENT ON COLUMN financial_statements.financial_ratios IS 'è²¡å‹™æ¯”ç‡ JSONBï¼ˆç”±M08è¨ˆç®—ï¼‰';
```

**è¨­è¨ˆèªªæ˜**:
- **æ ¸å¿ƒæ¬„ä½**ç¨ç«‹å„²å­˜ï¼ˆrevenue, net_income ç­‰ï¼‰ï¼ŒæŸ¥è©¢æ•ˆèƒ½é«˜
- **è©³ç´°è³‡æ–™**ä½¿ç”¨ JSONB å„²å­˜ï¼Œå½ˆæ€§æ“´å……
- GIN ç´¢å¼•åŠ é€Ÿ JSONB æŸ¥è©¢
- æ”¯æ´ PostgreSQL åŸç”Ÿ JSON æ“ä½œç¬¦

**JSONB çµæ§‹ç¯„ä¾‹**:
```json
{
  "income_statement": {
    "revenue": 1000000,
    "cost_of_goods_sold": 600000,
    "gross_profit": 400000,
    "operating_expenses": {
      "selling_expenses": 100000,
      "general_expenses": 50000,
      "rd_expenses": 80000
    },
    "non_operating_income": 20000,
    "income_before_tax": 190000,
    "income_tax": 30000,
    "net_income": 160000
  },
  
  "financial_ratios": {
    "roe": 15.5,
    "roa": 8.2,
    "gross_margin": 40.0,
    "operating_margin": 19.0,
    "net_margin": 16.0,
    "current_ratio": 1.8,
    "quick_ratio": 1.2,
    "debt_to_equity": 0.5
  }
}
```

**JSONB æŸ¥è©¢ç¯„ä¾‹**ï¼ˆMyBatisï¼‰:
```sql
-- æŸ¥è©¢ ROE > 15% çš„è‚¡ç¥¨
SELECT 
    stock_id,
    stock_name,
    year,
    quarter,
    (financial_ratios->>'roe')::numeric AS roe
FROM financial_statements f
JOIN stocks s USING (stock_id)
WHERE year = 2024
  AND quarter = 3
  AND (financial_ratios->>'roe')::numeric > 15.0
ORDER BY (financial_ratios->>'roe')::numeric DESC;

-- æŸ¥è©¢åŒ…å«ç‰¹å®šè³‡è¨Šçš„è²¡å ±
SELECT * FROM financial_statements
WHERE income_statement @> '{"rd_expenses": 80000}'::jsonb;

-- æŸ¥è©¢æ˜¯å¦å­˜åœ¨ç‰¹å®šæ¬„ä½
SELECT * FROM financial_statements
WHERE financial_ratios ? 'roe';
```

---

#### 3.2.4 institutional_trading (ä¸‰å¤§æ³•äººè²·è³£è¶…è³‡æ–™è¡¨)

```sql
-- PostgreSQL å»ºè¡¨èªæ³•
CREATE TABLE institutional_trading (
    trading_id      BIGSERIAL PRIMARY KEY,
    stock_id        VARCHAR(10) NOT NULL,
    trade_date      DATE NOT NULL,
    
    -- å¤–è³‡ï¼ˆForeign Investorsï¼‰
    foreign_buy     BIGINT DEFAULT 0,
    foreign_sell    BIGINT DEFAULT 0,
    foreign_net     BIGINT GENERATED ALWAYS AS (foreign_buy - foreign_sell) STORED,
    
    -- æŠ•ä¿¡ï¼ˆInvestment Trustï¼‰
    trust_buy       BIGINT DEFAULT 0,
    trust_sell      BIGINT DEFAULT 0,
    trust_net       BIGINT GENERATED ALWAYS AS (trust_buy - trust_sell) STORED,
    
    -- è‡ªç‡Ÿå•†ï¼ˆDealersï¼‰
    dealer_buy      BIGINT DEFAULT 0,
    dealer_sell     BIGINT DEFAULT 0,
    dealer_net      BIGINT GENERATED ALWAYS AS (dealer_buy - dealer_sell) STORED,
    
    -- åˆè¨ˆ
    total_net       BIGINT GENERATED ALWAYS AS (foreign_net + trust_net + dealer_net) STORED,
    
    -- å¯©è¨ˆæ¬„ä½
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE (stock_id, trade_date),
    FOREIGN KEY (stock_id) REFERENCES stocks(stock_id) ON DELETE CASCADE
);

-- ç´¢å¼•
CREATE INDEX idx_institutional_stock_id ON institutional_trading(stock_id);
CREATE INDEX idx_institutional_trade_date ON institutional_trading(trade_date);
CREATE INDEX idx_institutional_foreign_net ON institutional_trading(foreign_net);
CREATE INDEX idx_institutional_total_net ON institutional_trading(total_net);

-- è‡ªå‹•æ›´æ–° updated_at
CREATE TRIGGER update_institutional_trading_updated_at
    BEFORE UPDATE ON institutional_trading
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE institutional_trading IS 'ä¸‰å¤§æ³•äººè²·è³£è¶…è³‡æ–™è¡¨';
COMMENT ON COLUMN institutional_trading.foreign_net IS 'å¤–è³‡è²·è³£è¶…ï¼ˆä½¿ç”¨ GENERATED COLUMN è‡ªå‹•è¨ˆç®—ï¼‰';
```

**è¨­è¨ˆèªªæ˜**:
- ä½¿ç”¨ PostgreSQL **GENERATED COLUMNï¼ˆè¨ˆç®—æ¬„ä½ï¼‰** è‡ªå‹•è¨ˆç®—è²·è³£è¶…
- `STORED` è¡¨ç¤ºè¨ˆç®—çµæœå¯¦éš›å„²å­˜ï¼ŒæŸ¥è©¢æ•ˆèƒ½æ›´å¥½
- ç´¢å¼• foreign_net, total_net åŠ é€Ÿç±Œç¢¼åˆ†ææŸ¥è©¢
- è²·è³£è¶… = è²·é€² - è³£å‡ºï¼Œè‡ªå‹•ç¶­è­·ç„¡éœ€æ‡‰ç”¨ç¨‹å¼è¨ˆç®—

---

#### 3.2.5 margin_trading (èè³‡èåˆ¸è³‡æ–™è¡¨)

```sql
-- PostgreSQL å»ºè¡¨èªæ³•
CREATE TABLE margin_trading (
    margin_id       BIGSERIAL PRIMARY KEY,
    stock_id        VARCHAR(10) NOT NULL,
    trade_date      DATE NOT NULL,
    
    -- èè³‡ï¼ˆMargin Purchaseï¼‰
    margin_purchase BIGINT DEFAULT 0,
    margin_sell     BIGINT DEFAULT 0,
    margin_balance  BIGINT DEFAULT 0,
    margin_quota    BIGINT,
    margin_usage_rate NUMERIC(5,2) GENERATED ALWAYS AS 
        (CASE WHEN margin_quota > 0 THEN (margin_balance::numeric / margin_quota * 100) ELSE 0 END) STORED,
    
    -- èåˆ¸ï¼ˆShort Sellingï¼‰
    short_purchase  BIGINT DEFAULT 0,
    short_sell      BIGINT DEFAULT 0,
    short_balance   BIGINT DEFAULT 0,
    short_quota     BIGINT,
    short_usage_rate NUMERIC(5,2) GENERATED ALWAYS AS 
        (CASE WHEN short_quota > 0 THEN (short_balance::numeric / short_quota * 100) ELSE 0 END) STORED,
    
    -- å¯©è¨ˆæ¬„ä½
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE (stock_id, trade_date),
    FOREIGN KEY (stock_id) REFERENCES stocks(stock_id) ON DELETE CASCADE,
    
    -- ç´„æŸ
    CHECK (margin_balance >= 0),
    CHECK (short_balance >= 0)
);

-- ç´¢å¼•
CREATE INDEX idx_margin_stock_id ON margin_trading(stock_id);
CREATE INDEX idx_margin_trade_date ON margin_trading(trade_date);
CREATE INDEX idx_margin_usage_rate ON margin_trading(margin_usage_rate);

-- è‡ªå‹•æ›´æ–° updated_at
CREATE TRIGGER update_margin_trading_updated_at
    BEFORE UPDATE ON margin_trading
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE margin_trading IS 'èè³‡èåˆ¸è³‡æ–™è¡¨';
COMMENT ON COLUMN margin_trading.margin_usage_rate IS 'èè³‡ä½¿ç”¨ç‡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰';
```

**è¨­è¨ˆèªªæ˜**:
- èè³‡/èåˆ¸ä½¿ç”¨ç‡ä½¿ç”¨ GENERATED COLUMN è‡ªå‹•è¨ˆç®—
- ä½¿ç”¨ç‡ = é¤˜é¡ / é¡åº¦ Ã— 100

---

#### 3.2.6 trading_calendar (äº¤æ˜“æ—¥æ›†è¡¨)

```sql
-- PostgreSQL å»ºè¡¨èªæ³•
CREATE TABLE trading_calendar (
    calendar_id     SERIAL PRIMARY KEY,
    calendar_date   DATE NOT NULL UNIQUE,
    is_trading_day  BOOLEAN NOT NULL,
    day_type        VARCHAR(20) CHECK (day_type IN ('TRADING', 'WEEKEND', 'HOLIDAY', 'SPECIAL')),
    holiday_name    VARCHAR(100),
    year            INTEGER GENERATED ALWAYS AS (EXTRACT(YEAR FROM calendar_date)) STORED,
    month           INTEGER GENERATED ALWAYS AS (EXTRACT(MONTH FROM calendar_date)) STORED,
    day_of_week     INTEGER GENERATED ALWAYS AS (EXTRACT(DOW FROM calendar_date)) STORED,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_trading_calendar_date ON trading_calendar(calendar_date);
CREATE INDEX idx_trading_calendar_is_trading ON trading_calendar(is_trading_day);
CREATE INDEX idx_trading_calendar_year_month ON trading_calendar(year, month);

-- è¡¨è¨»é‡‹
COMMENT ON TABLE trading_calendar IS 'äº¤æ˜“æ—¥æ›†è¡¨';
COMMENT ON COLUMN trading_calendar.day_of_week IS 'æ˜ŸæœŸå¹¾ï¼ˆ0=é€±æ—¥, 1=é€±ä¸€, ..., 6=é€±å…­ï¼‰';
```

**è¨­è¨ˆèªªæ˜**:
- ä½¿ç”¨ GENERATED COLUMN è‡ªå‹•æå–å¹´ã€æœˆã€æ˜ŸæœŸ
- æ”¯æ´å¿«é€ŸæŸ¥è©¢æŸå¹´æŸæœˆçš„äº¤æ˜“æ—¥

---

### 3.3 è³‡æ–™é—œè¯åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   stocks     â”‚ â† è‚¡ç¥¨ä¸»è¡¨ï¼ˆ1ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ stock_prices (1:N)
       â”‚                - åˆ†å€è¡¨
       â”‚                - è¨ˆç®—æ¬„ä½ï¼ˆè²·è³£è¶…ï¼‰
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ financial_statements (1:N)
       â”‚                - JSONB è©³ç´°è³‡æ–™
       â”‚                - GIN ç´¢å¼•
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ institutional_trading (1:N)
       â”‚                - è¨ˆç®—æ¬„ä½ï¼ˆè²·è³£è¶…ï¼‰
       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ margin_trading (1:N)
                        - è¨ˆç®—æ¬„ä½ï¼ˆä½¿ç”¨ç‡ï¼‰

trading_calendar (ç¨ç«‹è¡¨ï¼Œç„¡å¤–éµ)
```

---

### 3.4 JPA vs MyBatis ä½¿ç”¨å ´æ™¯

| è³‡æ–™è¡¨ | ç°¡å–® CRUD | è¤‡é›œæŸ¥è©¢ | æ‰¹æ¬¡æ“ä½œ | çµ±è¨ˆæŸ¥è©¢ |
|-------|----------|---------|---------|---------|
| stocks | JPA | JPA | JPA | JPA |
| stock_prices | JPA | MyBatis | **MyBatis** | **MyBatis** |
| financial_statements | JPA | **MyBatis** | **MyBatis** | **MyBatis** |
| institutional_trading | JPA | MyBatis | **MyBatis** | MyBatis |
| margin_trading | JPA | MyBatis | **MyBatis** | MyBatis |
| trading_calendar | JPA | JPA | JPA | JPA |

**ä½¿ç”¨åŸå‰‡**:
- **JPA**: å–®ç­†æŸ¥è©¢ã€ç°¡å–®æ¢ä»¶ã€é—œè¯æŸ¥è©¢
- **MyBatis**: æ‰¹æ¬¡ UPSERTã€è¤‡é›œå‹•æ…‹ SQLã€JSONB æŸ¥è©¢ã€çµ±è¨ˆåˆ†æ

---


---

## ğŸ“š ç›¸é—œæ–‡æª”

- [å…¨ç³»çµ±è³‡æ–™åº«æ¶æ§‹](./database-schema.md)
- [M06 ERD](./erd/M06-ERD.md)
- [M06 åŠŸèƒ½éœ€æ±‚](../specs/functional/M06-è³‡æ–™ç®¡ç†åŠŸèƒ½éœ€æ±‚.md)

---

**æ–‡ä»¶ç¶­è­·è€…**: è³‡æ–™åº«è¨­è¨ˆå¸«  
**æœ€å¾Œæ›´æ–°**: 2025-12-31
