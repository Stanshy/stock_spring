# M09-ç±Œç¢¼åˆ†ææ¨¡çµ„è³‡æ–™åº«è¨­è¨ˆ

> **æ–‡ä»¶ç·¨è™Ÿ**: DB-M09
> **æ¨¡çµ„åç¨±**: ç±Œç¢¼åˆ†ææ¨¡çµ„
> **ç‰ˆæœ¬**: v1.0
> **æœ€å¾Œæ›´æ–°**: 2026-01-11
> **ç‹€æ…‹**: Draft

---

## ğŸ“‹ è³‡æ–™åº«è¨­è¨ˆç¸½è¦½

æœ¬æ–‡ä»¶å®šç¾©ç±Œç¢¼åˆ†ææ¨¡çµ„çš„è³‡æ–™è¡¨çµæ§‹ã€‚M09 ä¸»è¦ä¾è³´ M06 çš„åŸå§‹è³‡æ–™è¡¨ï¼ˆinstitutional_tradingã€margin_tradingï¼‰ï¼Œä¸¦æ–°å¢è¨ˆç®—çµæœå„²å­˜è¡¨ã€‚

---

## 1. è³‡æ–™è¡¨æ¸…å–®

| è¡¨å | èªªæ˜ | æŒä¹…å±¤ | ç‰¹æ®ŠåŠŸèƒ½ |
|-----|------|-------|---------|
| chip_analysis_results | ç±Œç¢¼åˆ†æçµæœè¡¨ | MyBatis | JSONBã€åˆ†å€ |
| chip_signals | ç±Œç¢¼ç•°å¸¸è¨Šè™Ÿè¡¨ | JPA + MyBatis | ç´¢å¼•å„ªåŒ– |
| chip_rankings_cache | ç±Œç¢¼æ’è¡Œæ¦œå¿«å–è¡¨ | MyBatis | å¿«å–ã€å®šæœŸæ›´æ–° |
| chip_cost_estimation | ä¸»åŠ›æˆæœ¬ä¼°ç®—è¡¨ | MyBatis | è¨ˆç®—æ¬„ä½ |

**ä¾è³´çš„ M06 è³‡æ–™è¡¨**:

| è¡¨å | èªªæ˜ | ç”¨é€” |
|-----|------|------|
| institutional_trading | ä¸‰å¤§æ³•äººè²·è³£è¶… | æ³•äººæŒ‡æ¨™è¨ˆç®—ä¾†æº |
| margin_trading | èè³‡èåˆ¸è³‡æ–™ | èè³‡èåˆ¸æŒ‡æ¨™è¨ˆç®—ä¾†æº |
| stock_prices | è‚¡åƒ¹è³‡æ–™ | æˆæœ¬ä¼°ç®—ã€é‡èƒ½åˆ†æ |
| stocks | è‚¡ç¥¨åŸºæœ¬è³‡æ–™ | é—œè¯æŸ¥è©¢ |

---

## 2. è³‡æ–™è¡¨è©³ç´°è¨­è¨ˆ

### 2.1 chip_analysis_results (ç±Œç¢¼åˆ†æçµæœè¡¨)

å„²å­˜æ¯æ—¥ç±Œç¢¼åˆ†æè¨ˆç®—çµæœï¼Œä½¿ç”¨ JSONB å„²å­˜å½ˆæ€§æŒ‡æ¨™ã€‚

```sql
-- PostgreSQL å»ºè¡¨èªæ³•ï¼ˆä½¿ç”¨åˆ†å€ï¼‰
CREATE TABLE chip_analysis_results (
    result_id           BIGSERIAL,
    stock_id            VARCHAR(10) NOT NULL,
    trade_date          DATE NOT NULL,

    -- ä¸‰å¤§æ³•äººæ ¸å¿ƒæŒ‡æ¨™ï¼ˆå¸¸ç”¨æ¬„ä½ç¨ç«‹å„²å­˜ï¼‰
    foreign_net         BIGINT,
    foreign_net_ma5     NUMERIC(15,2),
    foreign_net_ma20    NUMERIC(15,2),
    foreign_continuous_days INTEGER,
    foreign_accumulated_20d BIGINT,

    trust_net           BIGINT,
    trust_net_ma5       NUMERIC(15,2),
    trust_continuous_days INTEGER,

    dealer_net          BIGINT,
    total_net           BIGINT,

    -- èè³‡èåˆ¸æ ¸å¿ƒæŒ‡æ¨™
    margin_balance      BIGINT,
    margin_change       BIGINT,
    margin_usage_rate   NUMERIC(5,2),
    margin_continuous_days INTEGER,

    short_balance       BIGINT,
    short_change        BIGINT,
    margin_short_ratio  NUMERIC(5,2),

    -- ç±Œç¢¼é›†ä¸­åº¦
    institutional_ratio NUMERIC(5,2),
    concentration_trend VARCHAR(20),

    -- è©³ç´°æŒ‡æ¨™ï¼ˆä½¿ç”¨ JSONB å½ˆæ€§æ“´å……ï¼‰
    institutional_indicators JSONB DEFAULT '{}',
    margin_indicators       JSONB DEFAULT '{}',
    concentration_indicators JSONB DEFAULT '{}',

    -- ç±Œç¢¼è©•åˆ†
    chip_score          INTEGER,
    chip_grade          VARCHAR(2),

    -- å¯©è¨ˆæ¬„ä½
    calculation_time_ms INTEGER,
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (result_id, trade_date),
    UNIQUE (stock_id, trade_date)
) PARTITION BY RANGE (trade_date);

-- å»ºç«‹åˆ†å€ï¼ˆæŒ‰å¹´ä»½ï¼‰
CREATE TABLE chip_analysis_results_2024 PARTITION OF chip_analysis_results
    FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

CREATE TABLE chip_analysis_results_2025 PARTITION OF chip_analysis_results
    FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');

CREATE TABLE chip_analysis_results_2026 PARTITION OF chip_analysis_results
    FOR VALUES FROM ('2026-01-01') TO ('2027-01-01');

CREATE TABLE chip_analysis_results_future PARTITION OF chip_analysis_results
    FOR VALUES FROM ('2027-01-01') TO (MAXVALUE);

-- ç´¢å¼•
CREATE INDEX idx_chip_results_stock_id ON chip_analysis_results(stock_id);
CREATE INDEX idx_chip_results_trade_date ON chip_analysis_results(trade_date);
CREATE INDEX idx_chip_results_foreign_net ON chip_analysis_results(foreign_net);
CREATE INDEX idx_chip_results_total_net ON chip_analysis_results(total_net);
CREATE INDEX idx_chip_results_chip_score ON chip_analysis_results(chip_score);

-- JSONB GIN ç´¢å¼•
CREATE INDEX idx_chip_inst_indicators ON chip_analysis_results USING GIN(institutional_indicators);
CREATE INDEX idx_chip_margin_indicators ON chip_analysis_results USING GIN(margin_indicators);

-- è‡ªå‹•æ›´æ–° updated_at
CREATE TRIGGER update_chip_results_updated_at
    BEFORE UPDATE ON chip_analysis_results
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE chip_analysis_results IS 'ç±Œç¢¼åˆ†æçµæœè¡¨ï¼ˆæŒ‰å¹´ä»½åˆ†å€ï¼‰';
COMMENT ON COLUMN chip_analysis_results.institutional_indicators IS 'ä¸‰å¤§æ³•äººè©³ç´°æŒ‡æ¨™ JSONB';
COMMENT ON COLUMN chip_analysis_results.chip_score IS 'ç±Œç¢¼è©•åˆ†ï¼ˆ0-100ï¼‰';
```

**JSONB çµæ§‹ç¯„ä¾‹**:

```json
{
  "institutional_indicators": {
    "foreign_buy": 25000000,
    "foreign_sell": 20000000,
    "foreign_buy_ratio": 14.3,
    "foreign_accumulated_5d": 18000000,
    "trust_buy": 1500000,
    "trust_sell": 700000,
    "trust_buy_ratio": 2.3,
    "dealer_buy": 500000,
    "dealer_sell": 700000,
    "institutional_agreement": "BULLISH"
  },
  "margin_indicators": {
    "margin_quota": 280000,
    "margin_change_ma5": 3200,
    "margin_usage_ma20": 42.5,
    "short_quota": 64000,
    "short_usage_rate": 12.5,
    "margin_pressure": 0.8
  },
  "concentration_indicators": {
    "retail_ratio": 24.5,
    "foreign_ratio": 70.2,
    "trust_ratio": 3.8,
    "dealer_ratio": 1.5,
    "concentration_change_5d": 0.5,
    "concentration_change_20d": 2.5,
    "margin_to_capital": 0.48
  }
}
```

---

### 2.2 chip_signals (ç±Œç¢¼ç•°å¸¸è¨Šè™Ÿè¡¨)

å„²å­˜åµæ¸¬åˆ°çš„ç±Œç¢¼ç•°å¸¸è¨Šè™Ÿã€‚

```sql
CREATE TABLE chip_signals (
    signal_id           BIGSERIAL PRIMARY KEY,
    stock_id            VARCHAR(10) NOT NULL,
    trade_date          DATE NOT NULL,

    -- è¨Šè™Ÿè³‡è¨Š
    signal_code         VARCHAR(20) NOT NULL,
    signal_name         VARCHAR(50) NOT NULL,
    signal_type         VARCHAR(20) NOT NULL,
    severity            VARCHAR(10) NOT NULL,

    -- è¨Šè™Ÿæ•¸å€¼
    signal_value        NUMERIC(20,2),
    threshold_value     NUMERIC(20,2),
    deviation           NUMERIC(10,2),

    -- æè¿°
    description         TEXT,
    recommendation      TEXT,

    -- ç‹€æ…‹
    is_active           BOOLEAN DEFAULT TRUE,
    acknowledged_at     TIMESTAMP,
    acknowledged_by     VARCHAR(50),

    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ç´„æŸ
    CHECK (severity IN ('CRITICAL', 'HIGH', 'MEDIUM', 'LOW')),
    CHECK (signal_type IN ('INSTITUTIONAL', 'MARGIN', 'CONCENTRATION', 'COMPOSITE'))
);

-- ç´¢å¼•
CREATE INDEX idx_chip_signals_stock_id ON chip_signals(stock_id);
CREATE INDEX idx_chip_signals_trade_date ON chip_signals(trade_date);
CREATE INDEX idx_chip_signals_signal_code ON chip_signals(signal_code);
CREATE INDEX idx_chip_signals_severity ON chip_signals(severity);
CREATE INDEX idx_chip_signals_is_active ON chip_signals(is_active);

-- è¤‡åˆç´¢å¼•ï¼ˆå¸¸ç”¨æŸ¥è©¢ï¼‰
CREATE INDEX idx_chip_signals_date_severity
    ON chip_signals(trade_date, severity);
CREATE INDEX idx_chip_signals_stock_date
    ON chip_signals(stock_id, trade_date);

-- è¡¨è¨»é‡‹
COMMENT ON TABLE chip_signals IS 'ç±Œç¢¼ç•°å¸¸è¨Šè™Ÿè¡¨';
COMMENT ON COLUMN chip_signals.signal_code IS 'è¨Šè™Ÿä»£ç¢¼ï¼ˆå¦‚ CHIP_SIG_001ï¼‰';
COMMENT ON COLUMN chip_signals.severity IS 'åš´é‡åº¦ï¼ˆCRITICAL, HIGH, MEDIUM, LOWï¼‰';
```

**è¨Šè™Ÿä»£ç¢¼å°ç…§è¡¨**:

| signal_code | signal_name | signal_type | é è¨­ severity |
|-------------|-------------|-------------|---------------|
| CHIP_SIG_001 | å¤–è³‡å¤§è²· | INSTITUTIONAL | HIGH |
| CHIP_SIG_002 | å¤–è³‡å¤§è³£ | INSTITUTIONAL | HIGH |
| CHIP_SIG_003 | å¤–è³‡é€£çºŒè²·è¶… | INSTITUTIONAL | MEDIUM |
| CHIP_SIG_004 | å¤–è³‡é€£çºŒè³£è¶… | INSTITUTIONAL | MEDIUM |
| CHIP_SIG_005 | æŠ•ä¿¡å¤§è²· | INSTITUTIONAL | HIGH |
| CHIP_SIG_006 | æŠ•ä¿¡é€£çºŒè²·è¶… | INSTITUTIONAL | MEDIUM |
| CHIP_SIG_007 | ä¸‰å¤§æ³•äººåŒè²· | INSTITUTIONAL | MEDIUM |
| CHIP_SIG_008 | ä¸‰å¤§æ³•äººåŒè³£ | INSTITUTIONAL | HIGH |
| CHIP_SIG_009 | èè³‡æš´å¢ | MARGIN | HIGH |
| CHIP_SIG_010 | èè³‡æ–·é ­ | MARGIN | CRITICAL |
| CHIP_SIG_011 | èåˆ¸å¤§å¢ | MARGIN | MEDIUM |
| CHIP_SIG_012 | åˆ¸è³‡æ¯”éé«˜ | MARGIN | HIGH |
| CHIP_SIG_013 | èè³‡ä½¿ç”¨ç‡éé«˜ | MARGIN | HIGH |
| CHIP_SIG_014 | ç±Œç¢¼åˆ†æ­§ | COMPOSITE | MEDIUM |

---

### 2.3 chip_rankings_cache (ç±Œç¢¼æ’è¡Œæ¦œå¿«å–è¡¨)

å¿«å–æ’è¡Œæ¦œè¨ˆç®—çµæœï¼Œå®šæœŸæ›´æ–°ã€‚

```sql
CREATE TABLE chip_rankings_cache (
    cache_id            BIGSERIAL PRIMARY KEY,
    rank_type           VARCHAR(30) NOT NULL,
    trade_date          DATE NOT NULL,
    market_type         VARCHAR(10),

    -- æ’è¡Œæ¦œå…§å®¹ï¼ˆJSONB é™£åˆ—ï¼‰
    rankings            JSONB NOT NULL,

    -- å¿«å–è³‡è¨Š
    total_count         INTEGER,
    generated_at        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at          TIMESTAMP,

    -- å”¯ä¸€ç´„æŸ
    UNIQUE (rank_type, trade_date, market_type)
);

-- ç´¢å¼•
CREATE INDEX idx_chip_rankings_type ON chip_rankings_cache(rank_type);
CREATE INDEX idx_chip_rankings_date ON chip_rankings_cache(trade_date);
CREATE INDEX idx_chip_rankings_expires ON chip_rankings_cache(expires_at);

-- è¡¨è¨»é‡‹
COMMENT ON TABLE chip_rankings_cache IS 'ç±Œç¢¼æ’è¡Œæ¦œå¿«å–è¡¨';
COMMENT ON COLUMN chip_rankings_cache.rankings IS 'æ’è¡Œæ¦œ JSONB é™£åˆ—';
```

**JSONB çµæ§‹ç¯„ä¾‹**:

```json
{
  "rankings": [
    {
      "rank": 1,
      "stock_id": "2330",
      "stock_name": "å°ç©é›»",
      "value": 15000000,
      "close_price": 580.00,
      "volume": 35000000
    },
    {
      "rank": 2,
      "stock_id": "2317",
      "stock_name": "é´»æµ·",
      "value": 12000000,
      "close_price": 105.50,
      "volume": 45000000
    }
  ]
}
```

---

### 2.4 chip_cost_estimation (ä¸»åŠ›æˆæœ¬ä¼°ç®—è¡¨)

å„²å­˜ä¸»åŠ›æŒè‚¡æˆæœ¬ä¼°ç®—çµæœã€‚

```sql
CREATE TABLE chip_cost_estimation (
    estimation_id       BIGSERIAL PRIMARY KEY,
    stock_id            VARCHAR(10) NOT NULL,
    estimation_date     DATE NOT NULL,

    -- å¤–è³‡æˆæœ¬ä¼°ç®—
    foreign_avg_cost    NUMERIC(10,2),
    foreign_holding_shares BIGINT,
    foreign_profit_rate NUMERIC(5,2) GENERATED ALWAYS AS (
        CASE WHEN foreign_avg_cost > 0
             THEN ((current_price - foreign_avg_cost) / foreign_avg_cost * 100)
             ELSE NULL
        END
    ) STORED,
    foreign_holding_days_avg INTEGER,

    -- æŠ•ä¿¡æˆæœ¬ä¼°ç®—
    trust_avg_cost      NUMERIC(10,2),
    trust_holding_shares BIGINT,
    trust_profit_rate   NUMERIC(5,2) GENERATED ALWAYS AS (
        CASE WHEN trust_avg_cost > 0
             THEN ((current_price - trust_avg_cost) / trust_avg_cost * 100)
             ELSE NULL
        END
    ) STORED,
    trust_holding_days_avg INTEGER,

    -- ç•¶å‰åƒ¹æ ¼ï¼ˆç”¨æ–¼è¨ˆç®—å ±é…¬ç‡ï¼‰
    current_price       NUMERIC(10,2) NOT NULL,

    -- è¨ˆç®—åƒæ•¸
    lookback_days       INTEGER DEFAULT 120,
    calculation_method  VARCHAR(30) DEFAULT 'WEIGHTED_AVERAGE',

    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE (stock_id, estimation_date)
);

-- ç´¢å¼•
CREATE INDEX idx_chip_cost_stock_id ON chip_cost_estimation(stock_id);
CREATE INDEX idx_chip_cost_date ON chip_cost_estimation(estimation_date);

-- è‡ªå‹•æ›´æ–° updated_at
CREATE TRIGGER update_chip_cost_updated_at
    BEFORE UPDATE ON chip_cost_estimation
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE chip_cost_estimation IS 'ä¸»åŠ›æˆæœ¬ä¼°ç®—è¡¨';
COMMENT ON COLUMN chip_cost_estimation.foreign_profit_rate IS 'å¤–è³‡å ±é…¬ç‡ï¼ˆGENERATED COLUMN è‡ªå‹•è¨ˆç®—ï¼‰';
```

---

## 3. MyBatis Mapper è¨­è¨ˆ

### 3.1 ChipAnalysisMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chris.fin_shark.m09.mapper.ChipAnalysisMapper">

    <!-- æ‰¹æ¬¡ UPSERT ç±Œç¢¼åˆ†æçµæœ -->
    <insert id="batchUpsertResults" parameterType="list">
        INSERT INTO chip_analysis_results (
            stock_id, trade_date, foreign_net, foreign_net_ma5, foreign_net_ma20,
            foreign_continuous_days, foreign_accumulated_20d, trust_net, trust_net_ma5,
            trust_continuous_days, dealer_net, total_net, margin_balance, margin_change,
            margin_usage_rate, margin_continuous_days, short_balance, short_change,
            margin_short_ratio, institutional_ratio, concentration_trend,
            institutional_indicators, margin_indicators, concentration_indicators,
            chip_score, chip_grade, calculation_time_ms
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.stockId}, #{item.tradeDate}, #{item.foreignNet},
                #{item.foreignNetMa5}, #{item.foreignNetMa20},
                #{item.foreignContinuousDays}, #{item.foreignAccumulated20d},
                #{item.trustNet}, #{item.trustNetMa5}, #{item.trustContinuousDays},
                #{item.dealerNet}, #{item.totalNet}, #{item.marginBalance},
                #{item.marginChange}, #{item.marginUsageRate},
                #{item.marginContinuousDays}, #{item.shortBalance}, #{item.shortChange},
                #{item.marginShortRatio}, #{item.institutionalRatio},
                #{item.concentrationTrend},
                #{item.institutionalIndicators, typeHandler=com.chris.fin_shark.common.handler.JsonbTypeHandler},
                #{item.marginIndicators, typeHandler=com.chris.fin_shark.common.handler.JsonbTypeHandler},
                #{item.concentrationIndicators, typeHandler=com.chris.fin_shark.common.handler.JsonbTypeHandler},
                #{item.chipScore}, #{item.chipGrade}, #{item.calculationTimeMs}
            )
        </foreach>
        ON CONFLICT (stock_id, trade_date) DO UPDATE SET
            foreign_net = EXCLUDED.foreign_net,
            foreign_net_ma5 = EXCLUDED.foreign_net_ma5,
            foreign_net_ma20 = EXCLUDED.foreign_net_ma20,
            foreign_continuous_days = EXCLUDED.foreign_continuous_days,
            foreign_accumulated_20d = EXCLUDED.foreign_accumulated_20d,
            trust_net = EXCLUDED.trust_net,
            trust_net_ma5 = EXCLUDED.trust_net_ma5,
            trust_continuous_days = EXCLUDED.trust_continuous_days,
            dealer_net = EXCLUDED.dealer_net,
            total_net = EXCLUDED.total_net,
            margin_balance = EXCLUDED.margin_balance,
            margin_change = EXCLUDED.margin_change,
            margin_usage_rate = EXCLUDED.margin_usage_rate,
            margin_continuous_days = EXCLUDED.margin_continuous_days,
            short_balance = EXCLUDED.short_balance,
            short_change = EXCLUDED.short_change,
            margin_short_ratio = EXCLUDED.margin_short_ratio,
            institutional_ratio = EXCLUDED.institutional_ratio,
            concentration_trend = EXCLUDED.concentration_trend,
            institutional_indicators = EXCLUDED.institutional_indicators,
            margin_indicators = EXCLUDED.margin_indicators,
            concentration_indicators = EXCLUDED.concentration_indicators,
            chip_score = EXCLUDED.chip_score,
            chip_grade = EXCLUDED.chip_grade,
            calculation_time_ms = EXCLUDED.calculation_time_ms,
            updated_at = CURRENT_TIMESTAMP
    </insert>

    <!-- æŸ¥è©¢ç±Œç¢¼æ’è¡Œæ¦œ -->
    <select id="selectRanking" resultType="com.chris.fin_shark.m09.dto.ChipRankingDTO">
        SELECT
            ROW_NUMBER() OVER (ORDER BY ${orderBy} ${orderDirection}) as rank,
            c.stock_id,
            s.stock_name,
            s.market_type,
            s.industry,
            ${valueColumn} as value,
            sp.close_price,
            sp.volume
        FROM chip_analysis_results c
        JOIN stocks s ON c.stock_id = s.stock_id
        LEFT JOIN stock_prices sp ON c.stock_id = sp.stock_id AND c.trade_date = sp.trade_date
        WHERE c.trade_date = #{tradeDate}
          AND s.is_active = true
          <if test="marketType != null">
              AND s.market_type = #{marketType}
          </if>
          <if test="minVolume != null and minVolume > 0">
              AND sp.volume >= #{minVolume}
          </if>
        ORDER BY ${orderBy} ${orderDirection}
        LIMIT #{limit}
    </select>

    <!-- æŸ¥è©¢é€£çºŒè²·è¶…å¤©æ•¸ -->
    <select id="selectContinuousDays" resultType="int">
        WITH consecutive AS (
            SELECT
                trade_date,
                ${column},
                SUM(CASE WHEN ${column} > 0 THEN 0 ELSE 1 END)
                    OVER (ORDER BY trade_date) as grp
            FROM institutional_trading
            WHERE stock_id = #{stockId}
              AND trade_date BETWEEN #{startDate} AND #{endDate}
        )
        SELECT
            CASE
                WHEN (SELECT ${column} FROM institutional_trading
                      WHERE stock_id = #{stockId} AND trade_date = #{endDate}) > 0
                THEN COUNT(*)
                ELSE -COUNT(*)
            END as continuous_days
        FROM consecutive
        WHERE grp = (SELECT MAX(grp) FROM consecutive)
    </select>

</mapper>
```

---

## 4. è³‡æ–™é—œè¯åœ–

```
M06 è³‡æ–™è¡¨ï¼ˆè³‡æ–™ä¾†æºï¼‰                    M09 è³‡æ–™è¡¨ï¼ˆåˆ†æçµæœï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ institutional_trading â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚ chip_analysis_results â”‚
â”‚ (ä¸‰å¤§æ³•äººè²·è³£è¶…)       â”‚                â”‚ (ç±Œç¢¼åˆ†æçµæœ)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                       â”‚
           â”‚                                       â†“
           â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                            â”‚   chip_signals       â”‚
           â”‚                            â”‚ (ç±Œç¢¼ç•°å¸¸è¨Šè™Ÿ)        â”‚
           â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    margin_trading    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚ chip_rankings_cache  â”‚
â”‚ (èè³‡èåˆ¸è³‡æ–™)        â”‚                â”‚ (æ’è¡Œæ¦œå¿«å–)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                            â”‚ chip_cost_estimation â”‚
           â”‚                            â”‚ (ä¸»åŠ›æˆæœ¬ä¼°ç®—)        â”‚
           â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                                       â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚    stock_prices      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ (è‚¡åƒ¹è³‡æ–™)           â”‚ (æˆæœ¬ä¼°ç®—éœ€è¦åƒ¹æ ¼è³‡æ–™)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       stocks         â”‚
â”‚ (è‚¡ç¥¨åŸºæœ¬è³‡æ–™)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ç´¢å¼•ç­–ç•¥

### 5.1 ä¸»è¦æŸ¥è©¢å ´æ™¯èˆ‡ç´¢å¼•

| æŸ¥è©¢å ´æ™¯ | ä½¿ç”¨ç´¢å¼• | èªªæ˜ |
|---------|---------|------|
| å–®ä¸€è‚¡ç¥¨ç±Œç¢¼æŸ¥è©¢ | idx_chip_results_stock_id | æœ€å¸¸ç”¨æŸ¥è©¢ |
| æ—¥æœŸç¯„åœæŸ¥è©¢ | idx_chip_results_trade_date | åˆ†å€è£å‰ª + ç´¢å¼• |
| æ’è¡Œæ¦œæŸ¥è©¢ | idx_chip_results_foreign_net | ä¾æ’åºæ¬„ä½ |
| ç•°å¸¸è¨Šè™ŸæŸ¥è©¢ | idx_chip_signals_date_severity | è¤‡åˆç´¢å¼• |
| JSONB è©³ç´°æŒ‡æ¨™æŸ¥è©¢ | idx_chip_inst_indicators | GIN ç´¢å¼• |

### 5.2 åˆ†å€ç­–ç•¥

- `chip_analysis_results` æŒ‰å¹´ä»½åˆ†å€
- æŸ¥è©¢æ™‚è‡ªå‹•è£å‰ªä¸ç›¸é—œåˆ†å€
- æ­¸æª”æ™‚å¯ç›´æ¥ DETACH èˆŠå¹´ä»½åˆ†å€

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [M09 åŠŸèƒ½éœ€æ±‚](../specs/functional/M09-ç±Œç¢¼åˆ†æåŠŸèƒ½éœ€æ±‚.md)
- [M09 APIè¦æ ¼](../specs/api/M09-APIè¦æ ¼.md)
- [M09 ERD](./erd/M09-ERD.md)
- [M06 è³‡æ–™åº«è¨­è¨ˆ](./M06-è³‡æ–™åº«è¨­è¨ˆ.md)

---

**æ–‡ä»¶ç¶­è­·è€…**: è³‡æ–™åº«æ¶æ§‹å¸«
**æœ€å¾Œæ›´æ–°**: 2026-01-11
**ä¸‹æ¬¡å¯©æ ¸**: 2026-03-31
