# M17-風險管理模組 業務流程

> **文件編號**: FLOW-M17
> **模組名稱**: 風險管理模組 (Risk Management Module)
> **版本**: v1.0
> **最後更新**: 2026-01-15
> **狀態**: Draft

---

## 1. 核心業務流程總覽

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      M17 風險管理核心流程                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐ │
│  │ 每日風險    │    │ 限額監控    │    │ 預警處理    │    │ 壓力測試    │ │
│  │ 計算流程    │───▶│ 流程       │───▶│ 流程       │    │ 流程       │ │
│  └────────────┘    └────────────┘    └────────────┘    └────────────┘ │
│        │                  │                  │                │        │
│        ▼                  ▼                  ▼                ▼        │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │                      風險報告生成                               │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 每日風險計算流程

### 2.1 流程圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       每日風險計算流程                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────┐                                                            │
│  │  開始   │                                                            │
│  │ (09:30) │                                                            │
│  └────┬────┘                                                            │
│       │                                                                  │
│       ▼                                                                  │
│  ┌─────────────────────┐                                                │
│  │ 1. 載入投組持倉資料   │                                                │
│  │    (M18 positions)  │                                                │
│  └──────────┬──────────┘                                                │
│             │                                                            │
│             ▼                                                            │
│  ┌─────────────────────┐                                                │
│  │ 2. 取得最新價格資料   │                                                │
│  │    (M06 prices)     │                                                │
│  └──────────┬──────────┘                                                │
│             │                                                            │
│             ▼                                                            │
│  ┌─────────────────────────────────────────────────────────┐           │
│  │ 3. 平行計算風險指標                                       │           │
│  │    ┌───────────┬───────────┬───────────┬───────────┐   │           │
│  │    │ VaR 計算   │ 波動度計算 │ Beta 計算  │ 相關性計算 │   │           │
│  │    │           │           │           │           │   │           │
│  │    │ Historical│ Daily     │ Regression│ Pearson   │   │           │
│  │    │ Parametric│ Annualized│ R-squared │ Matrix    │   │           │
│  │    │ MonteCarlo│ Downside  │           │ Clusters  │   │           │
│  │    └───────────┴───────────┴───────────┴───────────┘   │           │
│  └──────────────────────────┬──────────────────────────────┘           │
│                             │                                           │
│                             ▼                                           │
│  ┌─────────────────────────────────────────────────────────┐           │
│  │ 4. 計算風險歸因                                          │           │
│  │    ┌───────────────────────────────────────────────┐   │           │
│  │    │ • 因子風險分解 (Market, Sector, Specific)      │   │           │
│  │    │ • 個股風險貢獻 (Marginal VaR)                  │   │           │
│  │    │ • 產業曝險分析                                  │   │           │
│  │    └───────────────────────────────────────────────┘   │           │
│  └──────────────────────────┬──────────────────────────────┘           │
│                             │                                           │
│                             ▼                                           │
│  ┌─────────────────────────────────────────────────────────┐           │
│  │ 5. 計算集中度指標                                        │           │
│  │    ┌───────────────────────────────────────────────┐   │           │
│  │    │ • HHI (赫芬達爾指數)                            │   │           │
│  │    │ • Top 5 / Top 10 權重                         │   │           │
│  │    │ • 產業集中度                                    │   │           │
│  │    └───────────────────────────────────────────────┘   │           │
│  └──────────────────────────┬──────────────────────────────┘           │
│                             │                                           │
│                             ▼                                           │
│  ┌─────────────────────┐                                                │
│  │ 6. 評估風險等級      │                                                │
│  │    LOW/MED/HIGH     │                                                │
│  └──────────┬──────────┘                                                │
│             │                                                            │
│             ▼                                                            │
│  ┌─────────────────────┐                                                │
│  │ 7. 儲存風險快照      │                                                │
│  │    risk_snapshots   │                                                │
│  └──────────┬──────────┘                                                │
│             │                                                            │
│             ▼                                                            │
│  ┌─────────┐                                                            │
│  │  結束   │                                                            │
│  └─────────┘                                                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 VaR 計算公式

#### Historical VaR
```
VaR(α) = -Percentile(Portfolio Returns, 1-α)

步驟：
1. 取得過去 N 天的投組日報酬率序列
2. 計算 (1-α) 百分位數
3. 轉換為絕對金額：VaR = Portfolio Value × VaR%
```

#### Parametric VaR
```
VaR(α) = μ - Z(α) × σ

其中：
- μ = 投組預期報酬 (通常假設為 0)
- Z(α) = 標準常態分布的 α 分位數 (95%: 1.645, 99%: 2.326)
- σ = 投組日報酬標準差

投組標準差計算：
σ_p = √(w'Σw)
- w = 權重向量
- Σ = 共變異數矩陣
```

#### Monte Carlo VaR
```
步驟：
1. 估計報酬分布參數 (均值向量 μ, 共變異數矩陣 Σ)
2. 使用 Cholesky 分解生成相關隨機數
3. 模擬 N 次投組價值變化
4. 取 (1-α) 百分位數作為 VaR
```

### 2.3 風險等級評估

```
┌────────────────────────────────────────────────────────────┐
│                    風險等級評估矩陣                          │
├────────────────────────────────────────────────────────────┤
│                                                             │
│  指標權重：                                                  │
│  ┌─────────────────────────────────────────────────────┐  │
│  │ VaR(95%) 佔比        25%                            │  │
│  │ 年化波動度           25%                            │  │
│  │ 最大回撤             20%                            │  │
│  │ 集中度 (HHI)         15%                            │  │
│  │ Beta                 15%                            │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                             │
│  評分標準：                                                  │
│  ┌─────────┬──────────┬──────────┬──────────┬──────────┐ │
│  │ 指標     │ LOW(0-25) │ MED(26-50)│ M-H(51-75)│ HIGH(76+)│ │
│  ├─────────┼──────────┼──────────┼──────────┼──────────┤ │
│  │ VaR %   │ <1.5%    │ 1.5-2.5% │ 2.5-4%   │ >4%      │ │
│  │ 波動度   │ <15%     │ 15-25%   │ 25-35%   │ >35%     │ │
│  │ 回撤     │ <5%      │ 5-10%    │ 10-20%   │ >20%     │ │
│  │ HHI     │ <0.05    │ 0.05-0.1 │ 0.1-0.2  │ >0.2     │ │
│  │ Beta    │ <0.8     │ 0.8-1.0  │ 1.0-1.3  │ >1.3     │ │
│  └─────────┴──────────┴──────────┴──────────┴──────────┘ │
│                                                             │
│  最終等級：                                                  │
│  Risk Score = Σ(指標分數 × 權重)                            │
│  ┌──────────────────────────────────────────────────┐     │
│  │ 0-30:   LOW        - 低風險                       │     │
│  │ 31-50:  MEDIUM     - 中等風險                     │     │
│  │ 51-70:  MEDIUM_HIGH - 中高風險                    │     │
│  │ 71-100: HIGH       - 高風險                       │     │
│  └──────────────────────────────────────────────────┘     │
│                                                             │
└────────────────────────────────────────────────────────────┘
```

---

## 3. 限額監控流程

### 3.1 流程圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         限額監控流程                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────┐                                                            │
│  │  開始   │                                                            │
│  └────┬────┘                                                            │
│       │                                                                  │
│       ▼                                                                  │
│  ┌─────────────────────┐                                                │
│  │ 1. 載入所有啟用限額   │                                                │
│  │    (risk_limits)    │                                                │
│  └──────────┬──────────┘                                                │
│             │                                                            │
│             ▼                                                            │
│  ┌─────────────────────┐                                                │
│  │ 2. 取得當日風險快照   │                                                │
│  │    (risk_snapshots) │                                                │
│  └──────────┬──────────┘                                                │
│             │                                                            │
│             ▼                                                            │
│  ┌──────────────────────────────────────────────────────────┐          │
│  │ 3. 逐一檢查限額                                            │          │
│  │                                                            │          │
│  │    ┌────────────────────────────────────────────────┐    │          │
│  │    │  FOR EACH limit IN limits:                     │    │          │
│  │    │                                                 │    │          │
│  │    │    current_value = getRiskValue(limit.type)    │    │          │
│  │    │    utilization = current_value / limit.value   │    │          │
│  │    │                                                 │    │          │
│  │    │    IF utilization >= 1.0:                      │    │          │
│  │    │        status = BREACHED                       │    │          │
│  │    │    ELSE IF utilization >= critical_threshold:  │    │          │
│  │    │        status = CRITICAL                       │    │          │
│  │    │    ELSE IF utilization >= warning_threshold:   │    │          │
│  │    │        status = WARNING                        │    │          │
│  │    │    ELSE:                                       │    │          │
│  │    │        status = NORMAL                         │    │          │
│  │    │                                                 │    │          │
│  │    └────────────────────────────────────────────────┘    │          │
│  └──────────────────────────┬───────────────────────────────┘          │
│                             │                                           │
│                             ▼                                           │
│                    ┌────────────────┐                                   │
│                    │ status 異常?   │                                   │
│                    └───────┬────────┘                                   │
│                   Yes      │       No                                   │
│              ┌─────────────┴─────────────┐                             │
│              ▼                           ▼                             │
│  ┌─────────────────────┐    ┌─────────────────────┐                   │
│  │ 4a. 觸發預警         │    │ 4b. 更新限額狀態     │                   │
│  │     (見預警流程)     │    │     為 NORMAL       │                   │
│  └──────────┬──────────┘    └──────────┬──────────┘                   │
│             │                          │                               │
│             └──────────────┬───────────┘                               │
│                            ▼                                           │
│  ┌─────────────────────────────────────────────────────────┐          │
│  │ 5. 儲存檢查記錄 (risk_limit_checks)                      │          │
│  └──────────────────────────┬──────────────────────────────┘          │
│                             │                                           │
│                             ▼                                           │
│  ┌─────────┐                                                            │
│  │  結束   │                                                            │
│  └─────────┘                                                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 限額類型對應值

| 限額類型 | 對應風險指標 | 來源欄位 |
|---------|------------|---------|
| VAR_95 | VaR(95%) 絕對值 | risk_snapshots.var_95_daily |
| VAR_99 | VaR(99%) 絕對值 | risk_snapshots.var_99_daily |
| VAR_PCT | VaR(95%) 百分比 | var_95_daily / total_value |
| VOLATILITY | 年化波動度 | risk_snapshots.volatility_annualized |
| MAX_SINGLE_STOCK | 最大個股權重 | risk_snapshots.largest_position_pct |
| MAX_SECTOR | 最大產業權重 | sector_exposure 中最大值 |
| MAX_DRAWDOWN | 最大回撤 | risk_snapshots.max_drawdown |
| BETA | Beta 係數 | risk_snapshots.beta |

---

## 4. 預警處理流程

### 4.1 流程圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         預警處理流程                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────┐                                                │
│  │ 觸發條件成立         │                                                │
│  │ (限額/規則觸發)      │                                                │
│  └──────────┬──────────┘                                                │
│             │                                                            │
│             ▼                                                            │
│  ┌─────────────────────┐                                                │
│  │ 1. 檢查冷卻時間      │                                                │
│  │    (cooldown)       │                                                │
│  └──────────┬──────────┘                                                │
│             │                                                            │
│      ┌──────┴──────┐                                                    │
│      │ 冷卻中?      │                                                    │
│      └──────┬──────┘                                                    │
│    Yes      │      No                                                   │
│  ┌──────────┤                                                           │
│  │          ▼                                                           │
│  │  ┌─────────────────────┐                                            │
│  │  │ 2. 建立預警記錄      │                                            │
│  │  │    (risk_alerts)    │                                            │
│  │  └──────────┬──────────┘                                            │
│  │             │                                                        │
│  │             ▼                                                        │
│  │  ┌─────────────────────┐                                            │
│  │  │ 3. 決定嚴重等級      │                                            │
│  │  │    LOW/MED/HIGH/    │                                            │
│  │  │    CRITICAL         │                                            │
│  │  └──────────┬──────────┘                                            │
│  │             │                                                        │
│  │             ▼                                                        │
│  │  ┌─────────────────────────────────────────────────────┐           │
│  │  │ 4. 發送通知                                          │           │
│  │  │    ┌─────────────────────────────────────────────┐ │           │
│  │  │    │ CRITICAL → Email + Push + SMS (即時)        │ │           │
│  │  │    │ HIGH     → Email + Push (即時)              │ │           │
│  │  │    │ MEDIUM   → Email (匯總)                     │ │           │
│  │  │    │ LOW      → 記錄 (日報)                       │ │           │
│  │  │    └─────────────────────────────────────────────┘ │           │
│  │  └──────────────────────────┬──────────────────────────┘           │
│  │                             │                                       │
│  │                             ▼                                       │
│  │  ┌─────────────────────┐                                           │
│  │  │ 5. 更新規則統計      │                                           │
│  │  │    triggered_count++ │                                           │
│  │  └──────────┬──────────┘                                           │
│  │             │                                                        │
│  └─────────────┤                                                        │
│                ▼                                                        │
│  ┌─────────────────────────────────────────────────────────┐          │
│  │ 6. 等待用戶處理                                          │          │
│  │    ┌─────────────────────────────────────────────────┐ │          │
│  │    │ • ACTIVE     → 等待確認                          │ │          │
│  │    │ • ACKNOWLEDGED → 用戶已確認，待解決               │ │          │
│  │    │ • RESOLVED   → 已解決或自動恢復                  │ │          │
│  │    └─────────────────────────────────────────────────┘ │          │
│  └──────────────────────────┬──────────────────────────────┘          │
│                             │                                          │
│                             ▼                                          │
│  ┌─────────┐                                                           │
│  │  結束   │                                                           │
│  └─────────┘                                                           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 預警嚴重等級規則

```
┌────────────────────────────────────────────────────────────────────────┐
│                      預警嚴重等級判定                                    │
├────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  CRITICAL (嚴重):                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │ • 限額突破 (utilization >= 1.0)                                  │  │
│  │ • VaR 超過總值 5%                                                │  │
│  │ • 單日損失超過 3%                                                 │  │
│  │ • 壓力測試關鍵情境失敗                                            │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  HIGH (高):                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │ • 限額 critical 閾值 (utilization >= 0.95)                       │  │
│  │ • VaR 超過總值 4%                                                │  │
│  │ • 連續 3 天風險上升                                               │  │
│  │ • 波動度達歷史 90 百分位                                          │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  MEDIUM (中等):                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │ • 限額 warning 閾值 (utilization >= 0.80)                        │  │
│  │ • VaR 超過總值 3%                                                │  │
│  │ • 集中度上升                                                      │  │
│  │ • 相關性顯著變化                                                  │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  LOW (低):                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │ • 資訊性提醒                                                      │  │
│  │ • 輕微異常                                                        │  │
│  │ • 定期報告通知                                                    │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 壓力測試流程

### 5.1 流程圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         壓力測試流程                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────┐                                                            │
│  │ API 請求 │                                                            │
│  │ /stress │                                                            │
│  │  -test  │                                                            │
│  └────┬────┘                                                            │
│       │                                                                  │
│       ▼                                                                  │
│  ┌─────────────────────┐                                                │
│  │ 1. 驗證請求參數      │                                                │
│  │    - portfolioId    │                                                │
│  │    - scenarios      │                                                │
│  └──────────┬──────────┘                                                │
│             │                                                            │
│             ▼                                                            │
│  ┌─────────────────────┐                                                │
│  │ 2. 建立測試任務      │                                                │
│  │    (stress_tests)   │                                                │
│  └──────────┬──────────┘                                                │
│             │                                                            │
│             ▼                                                            │
│  ┌─────────────────────┐                                                │
│  │ 3. 載入投組持倉      │                                                │
│  │    當前價值與權重    │                                                │
│  └──────────┬──────────┘                                                │
│             │                                                            │
│             ▼                                                            │
│  ┌─────────────────────┐                                                │
│  │ 4. 載入情境定義      │                                                │
│  │    系統+自訂情境     │                                                │
│  └──────────┬──────────┘                                                │
│             │                                                            │
│             ▼                                                            │
│  ┌──────────────────────────────────────────────────────────┐          │
│  │ 5. 逐一執行情境測試                                        │          │
│  │                                                            │          │
│  │    FOR EACH scenario IN scenarios:                        │          │
│  │    ┌────────────────────────────────────────────────┐    │          │
│  │    │ a. 解析衝擊因子 (shocks)                        │    │          │
│  │    │                                                 │    │          │
│  │    │ b. 計算各持股影響                               │    │          │
│  │    │    - 市場因子衝擊                               │    │          │
│  │    │    - 產業因子衝擊                               │    │          │
│  │    │    - 個股特定衝擊                               │    │          │
│  │    │                                                 │    │          │
│  │    │ c. 彙總投組損失                                 │    │          │
│  │    │    portfolio_change = Σ(position × shock)      │    │          │
│  │    │                                                 │    │          │
│  │    │ d. 檢查限額違反                                 │    │          │
│  │    │    breached = checkLimits(new_state)           │    │          │
│  │    │                                                 │    │          │
│  │    │ e. 判定通過/失敗                                │    │          │
│  │    │    passed = (breached.isEmpty())               │    │          │
│  │    └────────────────────────────────────────────────┘    │          │
│  └──────────────────────────┬───────────────────────────────┘          │
│                             │                                           │
│                             ▼                                           │
│  ┌─────────────────────────────────────────────────────────┐          │
│  │ 6. 彙整測試結果                                          │          │
│  │    - 找出最差情境                                         │          │
│  │    - 計算平均損失                                         │          │
│  │    - 統計通過/失敗數                                      │          │
│  └──────────────────────────┬──────────────────────────────┘          │
│                             │                                           │
│                             ▼                                           │
│  ┌─────────────────────────────────────────────────────────┐          │
│  │ 7. 儲存測試結果                                          │          │
│  │    - stress_tests (摘要)                                 │          │
│  │    - stress_results (各情境)                             │          │
│  └──────────────────────────┬──────────────────────────────┘          │
│                             │                                           │
│                       ┌─────┴─────┐                                    │
│                       │ 有失敗情境? │                                    │
│                       └─────┬─────┘                                    │
│                    Yes      │      No                                   │
│              ┌──────────────┤                                          │
│              ▼              ▼                                          │
│  ┌─────────────────┐  ┌─────────────────┐                             │
│  │ 8a. 觸發預警     │  │ 8b. 記錄通過     │                             │
│  │ STRESS_TEST_FAIL│  └────────┬────────┘                             │
│  └────────┬────────┘           │                                       │
│           └────────────────────┤                                       │
│                                ▼                                       │
│  ┌─────────────────────┐                                               │
│  │ 9. 返回測試結果      │                                               │
│  └──────────┬──────────┘                                               │
│             │                                                           │
│             ▼                                                           │
│  ┌─────────┐                                                           │
│  │  結束   │                                                           │
│  └─────────┘                                                           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 情境衝擊計算

```
┌────────────────────────────────────────────────────────────────────────┐
│                      情境衝擊計算邏輯                                    │
├────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  衝擊類型：                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │ MARKET          → 整體市場衝擊，影響所有持股                      │  │
│  │ SECTOR_xxx      → 產業衝擊，影響該產業持股                        │  │
│  │ CURRENCY_xxx    → 匯率衝擊，影響相關營收持股                      │  │
│  │ INTEREST_RATE   → 利率衝擊，影響金融/高負債股                     │  │
│  │ STOCK_xxx       → 個股衝擊，直接影響指定股票                      │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  計算公式：                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                                                                   │  │
│  │  stock_impact[i] = Σ(shock[j] × sensitivity[i][j])              │  │
│  │                                                                   │  │
│  │  其中：                                                           │  │
│  │  - shock[j] = 第 j 個因子的衝擊幅度                              │  │
│  │  - sensitivity[i][j] = 第 i 檔股票對第 j 因子的敏感度            │  │
│  │                                                                   │  │
│  │  敏感度預設值：                                                   │  │
│  │  - MARKET: Beta                                                  │  │
│  │  - SECTOR: 1.0 (屬於該產業) 或 0.0 (不屬於)                      │  │
│  │  - CURRENCY: 海外營收比重                                        │  │
│  │                                                                   │  │
│  │  portfolio_impact = Σ(weight[i] × stock_impact[i])              │  │
│  │                                                                   │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  範例：2008 金融海嘯情境                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │ shocks = [                                                       │  │
│  │   {factor: "MARKET", change: -0.45},                            │  │
│  │   {factor: "SECTOR_FINANCIAL", change: -0.55}                   │  │
│  │ ]                                                                │  │
│  │                                                                   │  │
│  │ 台積電 (Beta=1.25, 非金融):                                      │  │
│  │   impact = -0.45 × 1.25 = -56.25%                               │  │
│  │                                                                   │  │
│  │ 國泰金 (Beta=0.95, 金融業):                                      │  │
│  │   impact = -0.45 × 0.95 + -0.55 × 1.0 = -97.75%                 │  │
│  │           (受雙重衝擊，損失更大)                                  │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 風險報告生成流程

### 6.1 流程圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       風險報告生成流程                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────┐                                                            │
│  │ API 請求 │                                                            │
│  │ /risk-  │                                                            │
│  │ report  │                                                            │
│  └────┬────┘                                                            │
│       │                                                                  │
│       ▼                                                                  │
│  ┌─────────────────────┐                                                │
│  │ 1. 解析報告類型      │                                                │
│  │  SUMMARY/STANDARD/  │                                                │
│  │  DETAILED           │                                                │
│  └──────────┬──────────┘                                                │
│             │                                                            │
│             ▼                                                            │
│  ┌──────────────────────────────────────────────────────────┐          │
│  │ 2. 收集報告資料                                            │          │
│  │    ┌────────────────────────────────────────────────┐    │          │
│  │    │ • risk_snapshots   → 風險指標                   │    │          │
│  │    │ • risk_var_results → VaR 詳情                   │    │          │
│  │    │ • risk_limits      → 限額狀態                   │    │          │
│  │    │ • risk_alerts      → 有效預警                   │    │          │
│  │    │ • stress_results   → 壓力測試                   │    │          │
│  │    └────────────────────────────────────────────────┘    │          │
│  └──────────────────────────┬───────────────────────────────┘          │
│                             │                                           │
│                             ▼                                           │
│  ┌──────────────────────────────────────────────────────────┐          │
│  │ 3. 組裝報告章節                                            │          │
│  │                                                            │          │
│  │  ┌──────────────────────────────────────────────────┐    │          │
│  │  │ SUMMARY 報告：                                     │    │          │
│  │  │ - executiveSummary (風險等級、關鍵發現)            │    │          │
│  │  │ - keyMetrics (VaR、波動度、Beta)                  │    │          │
│  │  └──────────────────────────────────────────────────┘    │          │
│  │                                                            │          │
│  │  ┌──────────────────────────────────────────────────┐    │          │
│  │  │ STANDARD 報告 (包含 SUMMARY +)：                   │    │          │
│  │  │ - portfolioOverview (持倉概覽)                     │    │          │
│  │  │ - riskMetrics (完整風險指標)                       │    │          │
│  │  │ - limitCompliance (限額遵循)                       │    │          │
│  │  │ - stressTestSummary (壓力測試摘要)                 │    │          │
│  │  └──────────────────────────────────────────────────┘    │          │
│  │                                                            │          │
│  │  ┌──────────────────────────────────────────────────┐    │          │
│  │  │ DETAILED 報告 (包含 STANDARD +)：                  │    │          │
│  │  │ - riskAttribution (風險歸因)                       │    │          │
│  │  │ - trendAnalysis (趨勢分析)                         │    │          │
│  │  │ - correlationMatrix (相關性矩陣)                   │    │          │
│  │  │ - historicalAnalysis (歷史分析)                    │    │          │
│  │  └──────────────────────────────────────────────────┘    │          │
│  │                                                            │          │
│  └──────────────────────────┬───────────────────────────────┘          │
│                             │                                           │
│                             ▼                                           │
│  ┌─────────────────────────────────────────────────────────┐          │
│  │ 4. 生成建議事項                                          │          │
│  │    - 基於風險指標自動生成                                  │          │
│  │    - 限額接近上限時的調整建議                              │          │
│  │    - 集中度過高時的分散建議                                │          │
│  └──────────────────────────┬──────────────────────────────┘          │
│                             │                                           │
│                             ▼                                           │
│  ┌─────────────────────┐                                               │
│  │ 5. 返回報告 JSON    │                                               │
│  └──────────┬──────────┘                                               │
│             │                                                           │
│             ▼                                                           │
│  ┌─────────┐                                                           │
│  │  結束   │                                                           │
│  └─────────┘                                                           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 系統元件互動

### 7.1 元件圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      M17 系統元件互動圖                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                         API Layer                               │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │    │
│  │  │ RiskCtrl │  │ LimitCtrl│  │ AlertCtrl│  │StressCtrl│       │    │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘       │    │
│  └───────┼─────────────┼─────────────┼─────────────┼──────────────┘    │
│          │             │             │             │                    │
│          ▼             ▼             ▼             ▼                    │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                       Service Layer                             │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │                    RiskService                            │  │    │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │  │    │
│  │  │  │calculateRisk│ │generateReport│ │getRiskHistory│          │  │    │
│  │  │  └──────────┘  └──────────┘  └──────────┘              │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │                                                                 │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │    │
│  │  │ LimitService │  │ AlertService │  │ StressService│         │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│          │             │             │             │                    │
│          ▼             ▼             ▼             ▼                    │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                       Engine Layer                              │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │                   RiskEngine                              │  │    │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │  │    │
│  │  │  │VaRCalc   │  │VolatilityCalc│ │BetaCalc   │  │CorrelationCalc│ │  │    │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │                                                                 │    │
│  │  ┌──────────────┐  ┌──────────────┐                           │    │
│  │  │ StressEngine │  │AttributionEngine│                           │    │
│  │  └──────────────┘  └──────────────┘                           │    │
│  └────────────────────────────────────────────────────────────────┘    │
│          │                                                              │
│          ▼                                                              │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                     Repository Layer                            │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │    │
│  │  │SnapshotRepo│ │ VarRepo  │  │LimitRepo │  │ AlertRepo│       │    │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 相關文檔

- [M17 功能需求](../specs/functional/M17-風險管理功能需求.md)
- [M17 API 規格](../specs/api/M17-API規格.md)
- [M17 資料庫設計](./M17-資料庫設計.md)
- [M17 ERD](./erd/M17-ERD.md)

---

**文件維護者**: 後端工程師
**最後更新**: 2026-01-15
**下次審核**: 2026-04-15
