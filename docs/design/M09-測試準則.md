# M09-ç±Œç¢¼åˆ†ææ¨¡çµ„æ¸¬è©¦æº–å‰‡

> **æ–‡ä»¶ç·¨è™Ÿ**: TEST-M09
> **æ¨¡çµ„åç¨±**: ç±Œç¢¼åˆ†ææ¨¡çµ„
> **ç‰ˆæœ¬**: v1.1
> **æœ€å¾Œæ›´æ–°**: 2026-01-15
> **ç‹€æ…‹**: Active

---

## 1. æ¸¬è©¦ç¸½è¦½

æœ¬æ–‡ä»¶å®šç¾©ç±Œç¢¼åˆ†ææ¨¡çµ„çš„æ¸¬è©¦ç­–ç•¥ã€æ¸¬è©¦å ´æ™¯èˆ‡æ¸¬è©¦æº–å‰‡ã€‚

---

## 2. å–®å…ƒæ¸¬è©¦

### 2.1 è¨ˆç®—å™¨æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™**: é©—è­‰å„ç±Œç¢¼è¨ˆç®—å™¨çš„è¨ˆç®—é‚è¼¯æ­£ç¢ºæ€§

**æ¸¬è©¦å ´æ™¯**:

#### ä¸‰å¤§æ³•äººè¨ˆç®—å™¨æ¸¬è©¦

```
æ¸¬è©¦: ForeignNetCalculator.calculate()
Given: å¤–è³‡è²·é€² 10,000,000 è‚¡ï¼Œè³£å‡º 8,000,000 è‚¡
When: åŸ·è¡Œ calculate()
Then:
  - foreign_net = 2,000,000
  - è¨ˆç®—æ­£ç¢ºç„¡èª¤

æ¸¬è©¦: ContinuousDaysCalculator.calculate() - é€£çºŒè²·è¶…
Given: æœ€è¿‘ 5 å€‹äº¤æ˜“æ—¥å¤–è³‡è²·è³£è¶…ç‚º [100, 200, 150, 80, 50]ï¼ˆçš†ç‚ºæ­£æ•¸ï¼‰
When: åŸ·è¡Œ calculate()
Then:
  - foreign_continuous_days = 5
  - è¡¨ç¤ºé€£çºŒ 5 å¤©è²·è¶…

æ¸¬è©¦: ContinuousDaysCalculator.calculate() - é€£çºŒè³£è¶…
Given: æœ€è¿‘ 5 å€‹äº¤æ˜“æ—¥å¤–è³‡è²·è³£è¶…ç‚º [-100, -200, -150, 50, 80]
When: åŸ·è¡Œ calculate()
Then:
  - foreign_continuous_days = -3
  - è¡¨ç¤ºæœ€è¿‘é€£çºŒ 3 å¤©è³£è¶…

æ¸¬è©¦: ContinuousDaysCalculator.calculate() - æ–¹å‘è½‰æ›
Given: æœ€è¿‘ 5 å€‹äº¤æ˜“æ—¥å¤–è³‡è²·è³£è¶…ç‚º [100, -50, 200, 150, 80]
When: åŸ·è¡Œ calculate()
Then:
  - foreign_continuous_days = 1
  - æœ€è¿‘ 1 å¤©ç‚ºè²·è¶…ï¼ˆæ–¹å‘è½‰æ›å¾Œé‡æ–°è¨ˆç®—ï¼‰

æ¸¬è©¦: AccumulatedCalculator.calculate()
Given: æœ€è¿‘ 20 å€‹äº¤æ˜“æ—¥å¤–è³‡è²·è³£è¶…è³‡æ–™
When: åŸ·è¡Œ calculate(period=20)
Then:
  - foreign_accumulated_20d = SUM(æœ€è¿‘ 20 æ—¥ foreign_net)
```

#### èè³‡èåˆ¸è¨ˆç®—å™¨æ¸¬è©¦

```
æ¸¬è©¦: MarginUsageCalculator.calculate()
Given: margin_balance = 125,000, margin_quota = 280,000
When: åŸ·è¡Œ calculate()
Then:
  - margin_usage_rate = 44.64 (125000/280000*100)

æ¸¬è©¦: MarginShortRatioCalculator.calculate()
Given: margin_balance = 125,000, short_balance = 8,000
When: åŸ·è¡Œ calculate()
Then:
  - margin_short_ratio = 6.40 (8000/125000*100)

æ¸¬è©¦: MarginChangeCalculator.calculate()
Given: ä»Šæ—¥ margin_balance = 125,000, æ˜¨æ—¥ margin_balance = 120,000
When: åŸ·è¡Œ calculate()
Then:
  - margin_change = 5,000
```

#### è¨Šè™Ÿåµæ¸¬å™¨æ¸¬è©¦

```
æ¸¬è©¦: InstitutionalSignalDetector.detect() - å¤–è³‡å¤§è²·
Given:
  - ç•¶æ—¥ foreign_net = 15,000,000
  - éå» 20 æ—¥å¹³å‡ = 5,000,000
  - éå» 20 æ—¥æ¨™æº–å·® = 3,000,000
When: åŸ·è¡Œ detect()
Then:
  - ç”¢ç”Ÿ CHIP_SIG_001 è¨Šè™Ÿ
  - severity = HIGH
  - deviation = 3.33 (è¶…é 2 å€‹æ¨™æº–å·®)

æ¸¬è©¦: MarginSignalDetector.detect() - èè³‡æ–·é ­
Given:
  - margin_change = -15,000
  - margin_balance (å‰æ—¥) = 100,000
  - è®ŠåŒ–ç‡ = -15%
When: åŸ·è¡Œ detect()
Then:
  - ç”¢ç”Ÿ CHIP_SIG_010 è¨Šè™Ÿ
  - severity = CRITICAL

æ¸¬è©¦: CompositeSignalDetector.detect() - ä¸‰å¤§æ³•äººåŒè²·
Given:
  - foreign_net = 1,000,000 (è²·è¶…)
  - trust_net = 500,000 (è²·è¶…)
  - dealer_net = 200,000 (è²·è¶…)
When: åŸ·è¡Œ detect()
Then:
  - ç”¢ç”Ÿ CHIP_SIG_007 è¨Šè™Ÿ
  - severity = MEDIUM
```

---

### 2.2 å¼•æ“æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™**: é©—è­‰è¨ˆç®—å¼•æ“çš„å”èª¿é‚è¼¯

```
æ¸¬è©¦: DefaultChipEngine.compute() - å®Œæ•´è¨ˆç®—
Given:
  - è‚¡ç¥¨ 2330 çš„ 60 æ—¥æ­·å²è³‡æ–™
  - å®Œæ•´è¨ˆç®—è¨ˆåŠƒ (includeAll = true)
When: åŸ·è¡Œ compute(chipDataSeries, plan)
Then:
  - çµæœåŒ…å« institutional_indicators
  - çµæœåŒ…å« margin_indicators
  - çµæœåŒ…å« concentration_indicators
  - çµæœåŒ…å« signals
  - diagnostics.successfulCalculators > 0

æ¸¬è©¦: DefaultChipEngine.compute() - è³‡æ–™ä¸è¶³
Given:
  - è‚¡ç¥¨ 2330 åƒ…æœ‰ 5 æ—¥æ­·å²è³‡æ–™
  - è¨ˆç®—è¨ˆåŠƒéœ€è¦ 20 æ—¥è³‡æ–™
When: åŸ·è¡Œ compute()
Then:
  - diagnostics åŒ…å« warning
  - éƒ¨åˆ†æŒ‡æ¨™ç‚º null
  - ä¸æ‹‹å‡ºç•°å¸¸

æ¸¬è©¦: DefaultChipEngine.batchCompute()
Given: 50 æª”è‚¡ç¥¨çš„æ­·å²è³‡æ–™
When: åŸ·è¡Œ batchCompute()
Then:
  - è¿”å› 50 ç­†è¨ˆç®—çµæœ
  - æ¯ç­†çµæœéƒ½æœ‰æ­£ç¢ºçš„ stockId
```

---

### 2.3 Service å±¤æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™**: é©—è­‰æ¥­å‹™é‚è¼¯æ­£ç¢ºæ€§

```
æ¸¬è©¦: ChipAnalysisService.getAnalysis() - å¿«å–å‘½ä¸­
Given: Redis å¿«å–ä¸­æœ‰ 2330 çš„åˆ†æçµæœ
When: å‘¼å« getAnalysis("2330", "2024-12-24")
Then:
  - ç›´æ¥è¿”å›å¿«å–çµæœ
  - ä¸æŸ¥è©¢è³‡æ–™åº«

æ¸¬è©¦: ChipAnalysisService.getAnalysis() - å¿«å–æœªå‘½ä¸­
Given: Redis å¿«å–ä¸­ç„¡è³‡æ–™ï¼Œè³‡æ–™åº«æœ‰è³‡æ–™
When: å‘¼å« getAnalysis("2330", "2024-12-24")
Then:
  - å¾è³‡æ–™åº«å–å¾—çµæœ
  - çµæœå¯«å…¥ Redis å¿«å–
  - è¿”å›æ­£ç¢ºè³‡æ–™

æ¸¬è©¦: ChipAnalysisService.calculateAndSave()
Given: 2330 è‚¡ç¥¨çš„åŸå§‹ç±Œç¢¼è³‡æ–™
When: å‘¼å« calculateAndSave("2330", "2024-12-24")
Then:
  - è¨ˆç®—å¼•æ“è¢«å‘¼å«
  - çµæœå„²å­˜åˆ° chip_analysis_results
  - å¿«å–è¢«æ›´æ–°

æ¸¬è©¦: ChipRankingService.getRanking() - å¤–è³‡è²·è¶…
Given: ç•¶æ—¥ chip_analysis_results æœ‰è³‡æ–™
When: å‘¼å« getRanking(FOREIGN_BUY, "2024-12-24", 50)
Then:
  - è¿”å› 50 ç­†æ’è¡Œè³‡æ–™
  - æŒ‰ foreign_net é™åºæ’åˆ—
  - åŒ…å«è‚¡ç¥¨åç¨±ã€ç”¢æ¥­ç­‰è³‡è¨Š
```

**Mock ç­–ç•¥**:
- Mock ChipCalculatorRegistryï¼ˆå–®å…ƒæ¸¬è©¦ï¼‰
- Mock ChipAnalysisMapperï¼ˆå–®å…ƒæ¸¬è©¦ï¼‰
- ä½¿ç”¨çœŸå¯¦ Redisï¼ˆæ•´åˆæ¸¬è©¦ï¼ŒTestcontainersï¼‰

---

### 2.4 P0/P1 å·²å¯¦ä½œè¨ˆç®—å™¨æ¸¬è©¦æ¸…å–®

> **æ–°å¢æ–¼**: 2026-01-15

ä»¥ä¸‹ç‚º P0/P1 å·²å¯¦ä½œè¨ˆç®—å™¨çš„æ¸¬è©¦é¡åˆ¥å°æ‡‰è¡¨ï¼š

#### ä¸‰å¤§æ³•äººé¡æ¸¬è©¦

| æ¸¬è©¦é¡åˆ¥ | æ¸¬è©¦é …ç›® | é©—è­‰é‡é» |
|---------|---------|---------|
| ForeignNetCalculatorTest | å¤–è³‡è²·è³£è¶…è¨ˆç®—ã€MA5/MA20ã€20æ—¥ç´¯è¨ˆ | å€¼æ­£ç¢ºæ€§ã€è³‡æ–™ä¸è¶³è™•ç† |
| TrustNetCalculatorTest | æŠ•ä¿¡è²·è³£è¶…è¨ˆç®—ã€MA5/MA20 | å€¼æ­£ç¢ºæ€§ |
| DealerNetCalculatorTest | è‡ªç‡Ÿå•†è²·è³£è¶…è¨ˆç®—ã€total_net åˆè¨ˆ | å€¼æ­£ç¢ºæ€§ |
| ContinuousDaysCalculatorTest | é€£çºŒå¤©æ•¸è¨ˆç®—ã€æ–¹å‘è½‰æ› | é€£çºŒè²·è¶…/è³£è¶…åˆ¤æ–·ã€é‚Šç•Œæ¢ä»¶ |

```
æ¸¬è©¦: ForeignNetCalculator.calculate() - MA5 è¨ˆç®—
Given: å¤–è³‡è²·è³£è¶…åºåˆ— [1000000, 2000000, 1500000, 1800000, 1200000] (5æ—¥)
When: åŸ·è¡Œ calculate()
Then:
  - foreign_net_ma5 = 1500000
  - ç²¾ç¢ºåˆ°å°æ•¸é»å¾Œ 2 ä½
```

#### èè³‡èåˆ¸é¡æ¸¬è©¦

| æ¸¬è©¦é¡åˆ¥ | æ¸¬è©¦é …ç›® | é©—è­‰é‡é» |
|---------|---------|---------|
| MarginBalanceCalculatorTest | èè³‡é¤˜é¡è¨ˆç®—ã€èè³‡å¢æ¸›ã€ä½¿ç”¨ç‡ | å€¼æ­£ç¢ºæ€§ã€ç™¾åˆ†æ¯”è¨ˆç®— |
| ShortBalanceCalculatorTest | èåˆ¸é¤˜é¡è¨ˆç®—ã€èåˆ¸å¢æ¸› | å€¼æ­£ç¢ºæ€§ |
| MarginShortRatioCalculatorTest | åˆ¸è³‡æ¯”è¨ˆç®— | å€¼æ­£ç¢ºæ€§ã€é™¤é›¶è™•ç† |

```
æ¸¬è©¦: MarginShortRatioCalculator.calculate()
Given: margin_balance = 125000, short_balance = 8000
When: åŸ·è¡Œ calculate()
Then:
  - margin_short_ratio = 6.40%
  - è™•ç† margin_balance = 0 çš„æƒ…æ³
```

#### è¨Šè™Ÿåµæ¸¬é¡æ¸¬è©¦

| æ¸¬è©¦é¡åˆ¥ | æ¸¬è©¦é …ç›® | é©—è­‰é‡é» |
|---------|---------|---------|
| InstitutionalSignalDetectorTest | CHIP_SIG_001~008 è¨Šè™Ÿç”¢ç”Ÿ | é–€æª»å€¼åˆ¤æ–·ã€åš´é‡åº¦è¨­å®š |
| MarginSignalDetectorTest | CHIP_SIG_009~013 è¨Šè™Ÿç”¢ç”Ÿ | é–€æª»å€¼åˆ¤æ–·ã€åš´é‡åº¦è¨­å®š |

```
æ¸¬è©¦: InstitutionalSignalDetector.detect() - å¤–è³‡å¤§é‡è²·è¶…è¨Šè™Ÿ
Given:
  - foreign_net = 20,000,000 (ç•¶æ—¥)
  - éå» 20 æ—¥å¹³å‡ = 5,000,000
  - threshold = 3 æ¨™æº–å·®
When: åŸ·è¡Œ detect()
Then:
  - ç”¢ç”Ÿ CHIP_SIG_001 è¨Šè™Ÿ
  - severity = HIGH
  - signal_value = 20000000
```

---

## 3. æ•´åˆæ¸¬è©¦

### 3.1 è³‡æ–™åº«æ•´åˆæ¸¬è©¦

**æ¸¬è©¦ç’°å¢ƒ**: ä½¿ç”¨ Testcontainers å•Ÿå‹• PostgreSQL å®¹å™¨

```
æ¸¬è©¦: ChipAnalysisMapper.batchUpsertResults()
Given: æº–å‚™ 100 ç­†ç±Œç¢¼åˆ†æçµæœ
When: åŸ·è¡Œæ‰¹æ¬¡ UPSERT
Then:
  - åŸ·è¡Œæ™‚é–“ < 500ms
  - æ‰€æœ‰è³‡æ–™æ­£ç¢ºå„²å­˜
  - å”¯ä¸€éµç´„æŸç”Ÿæ•ˆ

æ¸¬è©¦: ChipAnalysisMapper.selectRanking()
Given: chip_analysis_results è¡¨æœ‰ 1000 ç­†è³‡æ–™
When: æŸ¥è©¢å¤–è³‡è²·è¶…æ’è¡Œæ¦œï¼ˆå‰ 50 åï¼‰
Then:
  - æŸ¥è©¢æ™‚é–“ < 100ms
  - çµæœæ­£ç¢ºæ’åº
  - JOIN è‚¡ç¥¨è³‡æ–™æ­£ç¢º

æ¸¬è©¦: JSONB æŸ¥è©¢
Given: chip_analysis_results è¡¨æœ‰ JSONB æŒ‡æ¨™è³‡æ–™
When: æŸ¥è©¢ institutional_indicators->>'foreign_buy_ratio' > 10
Then:
  - ä½¿ç”¨ GIN ç´¢å¼•
  - æŸ¥è©¢æ™‚é–“ < 100ms

æ¸¬è©¦: åˆ†å€è£å‰ª
Given: chip_analysis_results æœ‰ 2023-2025 å¹´è³‡æ–™ï¼ˆåˆ†å€ï¼‰
When: æŸ¥è©¢ 2024 å¹´è³‡æ–™
Then:
  - åªæƒæ chip_analysis_results_2024 åˆ†å€
  - æŸ¥è©¢æ•ˆèƒ½å„ªæ–¼å…¨è¡¨æƒæ
```

---

### 3.2 å¿«å–æ•´åˆæ¸¬è©¦

**æ¸¬è©¦ç’°å¢ƒ**: ä½¿ç”¨ Testcontainers å•Ÿå‹• Redis å®¹å™¨

```
æ¸¬è©¦: å¿«å–å¯«å…¥èˆ‡è®€å–
Given: ç±Œç¢¼åˆ†æçµæœ DTO
When: å¯«å…¥ Redis å¿«å–å¾Œè®€å–
Then:
  - è³‡æ–™æ­£ç¢ºåºåˆ—åŒ–/ååºåˆ—åŒ–
  - TTL è¨­å®šæ­£ç¢º

æ¸¬è©¦: å¿«å–å¤±æ•ˆ
Given: Redis å¿«å–æœ‰è³‡æ–™ï¼ŒTTL = 1 ç§’
When: ç­‰å¾… 2 ç§’å¾Œè®€å–
Then:
  - å¿«å–æœªå‘½ä¸­
  - é‡æ–°è¨ˆç®—ä¸¦å¿«å–

æ¸¬è©¦: å¿«å–ç©¿é€é˜²è­·
Given: æŸ¥è©¢ä¸å­˜åœ¨çš„è‚¡ç¥¨ä»£ç¢¼ "9999"
When: é€£çºŒæŸ¥è©¢ 10 æ¬¡
Then:
  - ç¬¬ä¸€æ¬¡æŸ¥è©¢è³‡æ–™åº«
  - å¾ŒçºŒæŸ¥è©¢å‘½ä¸­ç©ºå€¼å¿«å–
  - ä¸æœƒé€ æˆè³‡æ–™åº«å£“åŠ›
```

---

### 3.3 M06 ä¾è³´æ•´åˆæ¸¬è©¦

```
æ¸¬è©¦: å¾ M06 å–å¾—åŸå§‹è³‡æ–™
Given: institutional_tradingã€margin_trading è¡¨æœ‰è³‡æ–™
When: å‘¼å« ChipDataLoader.loadData("2330", 60)
Then:
  - æ­£ç¢ºè¼‰å…¥ 60 æ—¥æ³•äººè³‡æ–™
  - æ­£ç¢ºè¼‰å…¥ 60 æ—¥èè³‡èåˆ¸è³‡æ–™
  - æ­£ç¢ºè¼‰å…¥ 60 æ—¥è‚¡åƒ¹è³‡æ–™
  - è³‡æ–™æŒ‰æ—¥æœŸæ’åº

æ¸¬è©¦: M06 è³‡æ–™ä¸å®Œæ•´è™•ç†
Given: æŸè‚¡ç¥¨åªæœ‰ 10 æ—¥æ³•äººè³‡æ–™
When: è¼‰å…¥è³‡æ–™ä¸¦è¨ˆç®—
Then:
  - ä¸æ‹‹å‡ºç•°å¸¸
  - è¿”å›å¯è¨ˆç®—çš„æŒ‡æ¨™
  - diagnostics åŒ…å« warning
```

---

## 4. API æ¸¬è©¦

**æ¸¬è©¦å·¥å…·**: MockMvc æˆ– RestAssured

### 4.1 æˆåŠŸå ´æ™¯

```
æ¸¬è©¦: GET /api/v1/chip/2330/analysis
Given: è³‡æ–™åº«ä¸­æœ‰ 2330 çš„ç±Œç¢¼åˆ†æè³‡æ–™
When: GET /api/v1/chip/2330/analysis?date=2024-12-24
Then:
  - HTTP 200
  - Response æ ¼å¼ç¬¦åˆ API è¦ç¯„
  - åŒ…å« institutional_analysis
  - åŒ…å« margin_analysis
  - åŒ…å« signals

æ¸¬è©¦: GET /api/v1/chip/ranking/foreign_buy
Given: ç•¶æ—¥æœ‰æ’è¡Œæ¦œè³‡æ–™
When: GET /api/v1/chip/ranking/foreign_buy?limit=50
Then:
  - HTTP 200
  - è¿”å› 50 ç­†è³‡æ–™
  - æŒ‰ foreign_net é™åºæ’åˆ—

æ¸¬è©¦: GET /api/v1/chip/scan/signals
Given: ç•¶æ—¥æœ‰ç•°å¸¸è¨Šè™Ÿè³‡æ–™
When: GET /api/v1/chip/scan/signals?severity=HIGH
Then:
  - HTTP 200
  - åªè¿”å› HIGH åš´é‡åº¦è¨Šè™Ÿ
```

### 4.2 éŒ¯èª¤å ´æ™¯

```
æ¸¬è©¦: è‚¡ç¥¨ä¸å­˜åœ¨
When: GET /api/v1/chip/9999/analysis
Then:
  - HTTP 404
  - error_code = "M09_CHIP_001"

æ¸¬è©¦: è³‡æ–™ä¸è¶³
Given: è‚¡ç¥¨ 2330 åªæœ‰ 5 æ—¥è³‡æ–™
When: GET /api/v1/chip/2330/analysis
Then:
  - HTTP 400
  - error_code = "M09_CHIP_002"

æ¸¬è©¦: æ—¥æœŸæ ¼å¼éŒ¯èª¤
When: GET /api/v1/chip/2330/analysis?date=2024-13-01
Then:
  - HTTP 400
  - error_code = "M09_PARAM_001"

æ¸¬è©¦: ä¸æ”¯æ´çš„æ’è¡Œæ¦œé¡å‹
When: GET /api/v1/chip/ranking/invalid_type
Then:
  - HTTP 400
  - error_code = "M09_CHIP_004"
```

---

## 5. æ•ˆèƒ½æ¸¬è©¦

**æ¸¬è©¦å·¥å…·**: JMeter æˆ– Gatling

```
æ¸¬è©¦: å–®è‚¡ç±Œç¢¼æŸ¥è©¢æ•ˆèƒ½ï¼ˆå¿«å–å‘½ä¸­ï¼‰
Given: 100 å€‹ä½µç™¼ä½¿ç”¨è€…
When: æ¯ç§’æŸ¥è©¢ /api/v1/chip/2330/analysis
Then:
  - P95 å›æ‡‰æ™‚é–“ < 100ms
  - å¿«å–å‘½ä¸­ç‡ > 90%
  - ç„¡éŒ¯èª¤ç™¼ç”Ÿ

æ¸¬è©¦: æ’è¡Œæ¦œæŸ¥è©¢æ•ˆèƒ½
Given: 50 å€‹ä½µç™¼ä½¿ç”¨è€…
When: æ¯ç§’æŸ¥è©¢ /api/v1/chip/ranking/foreign_buy
Then:
  - P95 å›æ‡‰æ™‚é–“ < 150ms
  - ç„¡éŒ¯èª¤ç™¼ç”Ÿ

æ¸¬è©¦: æ‰¹æ¬¡è¨ˆç®— Job æ•ˆèƒ½
Given: 1800 æª”è‚¡ç¥¨éœ€è¦è¨ˆç®—
When: åŸ·è¡Œ CALC_CHIP_ANALYSIS Job
Then:
  - åŸ·è¡Œæ™‚é–“ < 8 åˆ†é˜
  - æˆåŠŸç‡ > 95%
  - è³‡æ–™åº«é€£ç·šæ± æœªè€—ç›¡

æ¸¬è©¦: å…¨å¸‚å ´è¨Šè™Ÿæƒææ•ˆèƒ½
Given: 1800 æª”è‚¡ç¥¨çš„ç±Œç¢¼è³‡æ–™
When: åŸ·è¡Œç•°å¸¸è¨Šè™Ÿæƒæ
Then:
  - åŸ·è¡Œæ™‚é–“ < 5 ç§’
  - åµæ¸¬åˆ°çš„è¨Šè™Ÿæ­£ç¢º
```

---

## 6. è¨ˆç®—æ­£ç¢ºæ€§æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™**: é©—è­‰ç±Œç¢¼æŒ‡æ¨™è¨ˆç®—çµæœçš„æ­£ç¢ºæ€§

```
æ¸¬è©¦: å¤–è³‡è²·è³£è¶… MA è¨ˆç®—
Given: å¤–è³‡è²·è³£è¶…åºåˆ— [100, 200, 150, 180, 170] (5æ—¥)
When: è¨ˆç®— MA5
Then:
  - MA5 = (100+200+150+180+170) / 5 = 160
  - ç²¾ç¢ºåˆ°å°æ•¸é»å¾Œ 2 ä½

æ¸¬è©¦: èè³‡ä½¿ç”¨ç‡è¨ˆç®—
Given: margin_balance = 125000, margin_quota = 280000
When: è¨ˆç®— margin_usage_rate
Then:
  - margin_usage_rate = 44.64%
  - ç²¾ç¢ºåˆ°å°æ•¸é»å¾Œ 2 ä½

æ¸¬è©¦: é€£çºŒå¤©æ•¸é‚Šç•Œæ¢ä»¶
Given: è²·è³£è¶…åºåˆ— [0, 100, 200] (0 è¡¨ç¤ºå¹³ç›¤)
When: è¨ˆç®—é€£çºŒå¤©æ•¸
Then:
  - è™•ç† 0 å€¼çš„é‚è¼¯æ­£ç¢ºï¼ˆè¦–ç‚ºä¸­æ–·æˆ–å¿½ç•¥ï¼‰

æ¸¬è©¦: Z-Score ç•°å¸¸åµæ¸¬
Given:
  - ç•¶å‰å€¼ = 15,000,000
  - æ­·å²å¹³å‡ = 5,000,000
  - æ­·å²æ¨™æº–å·® = 3,000,000
When: è¨ˆç®— Z-Score
Then:
  - Z-Score = (15000000 - 5000000) / 3000000 = 3.33
  - è¶…éé–€æª» 2.0ï¼Œåˆ¤å®šç‚ºç•°å¸¸
```

---

## 7. æ¸¬è©¦è¦†è“‹ç‡ç›®æ¨™

| å±¤ç´š | è¦†è“‹ç‡ç›®æ¨™ | èªªæ˜ |
|-----|----------|------|
| Calculator å±¤ | > 95% | è¨ˆç®—é‚è¼¯å¿…é ˆå®Œæ•´æ¸¬è©¦ |
| Engine å±¤ | > 90% | å¼•æ“å”èª¿é‚è¼¯å¿…é ˆæ¸¬è©¦ |
| Service å±¤ | > 80% | æ ¸å¿ƒæ¥­å‹™é‚è¼¯å¿…é ˆæ¸¬è©¦ |
| Controller å±¤ | > 70% | ä¸»è¦ API ç«¯é»å¿…é ˆæ¸¬è©¦ |
| æ•´é«” | > 80% | æ•´é«”ç¨‹å¼ç¢¼è¦†è“‹ç‡ |

**æ¸¬è©¦å„ªå…ˆç´š**:
1. P0 åŠŸèƒ½ï¼š100% æ¸¬è©¦è¦†è“‹ï¼ˆæ³•äººæŒ‡æ¨™ã€èè³‡æŒ‡æ¨™ã€ç•°å¸¸åµæ¸¬ï¼‰
2. P1 åŠŸèƒ½ï¼š> 80% æ¸¬è©¦è¦†è“‹
3. P2 åŠŸèƒ½ï¼š> 60% æ¸¬è©¦è¦†è“‹

---

## 8. æ¸¬è©¦è³‡æ–™æº–å‚™

### 8.1 æ¸¬è©¦è³‡æ–™é›†

```java
@TestConfiguration
public class ChipTestDataConfig {

    // æ¨™æº–æ¸¬è©¦è³‡æ–™ï¼š60 æ—¥å®Œæ•´è³‡æ–™
    public static ChipDataSeries createStandardTestData(String stockId) {
        List<InstitutionalTradingData> instData = new ArrayList<>();
        List<MarginTradingData> marginData = new ArrayList<>();

        for (int i = 0; i < 60; i++) {
            LocalDate date = LocalDate.now().minusDays(i);

            // æ¨¡æ“¬æ³•äººè³‡æ–™
            instData.add(InstitutionalTradingData.builder()
                .stockId(stockId)
                .tradeDate(date)
                .foreignBuy(randomLong(1000000, 10000000))
                .foreignSell(randomLong(1000000, 10000000))
                .trustBuy(randomLong(100000, 1000000))
                .trustSell(randomLong(100000, 1000000))
                .dealerBuy(randomLong(50000, 500000))
                .dealerSell(randomLong(50000, 500000))
                .build());

            // æ¨¡æ“¬èè³‡èåˆ¸è³‡æ–™
            marginData.add(MarginTradingData.builder()
                .stockId(stockId)
                .tradeDate(date)
                .marginBalance(randomLong(100000, 200000))
                .marginQuota(280000L)
                .shortBalance(randomLong(5000, 15000))
                .shortQuota(64000L)
                .build());
        }

        return new ChipDataSeries(stockId, instData, marginData);
    }

    // é‚Šç•Œæ¢ä»¶æ¸¬è©¦è³‡æ–™
    public static ChipDataSeries createEdgeCaseData() {
        // è³‡æ–™ä¸è¶³å ´æ™¯
        // å…¨ç‚º 0 å ´æ™¯
        // æ¥µç«¯å€¼å ´æ™¯
    }
}
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [M09 åŠŸèƒ½éœ€æ±‚](../specs/functional/M09-ç±Œç¢¼åˆ†æåŠŸèƒ½éœ€æ±‚.md)
- [M09 APIè¦æ ¼](../specs/api/M09-APIè¦æ ¼.md)
- [M09 è³‡æ–™åº«è¨­è¨ˆ](./M09-è³‡æ–™åº«è¨­è¨ˆ.md)
- [é–‹ç™¼æº–å‰‡](../specs/technical/00-é–‹ç™¼æº–å‰‡.md)

---

**æ–‡ä»¶ç¶­è­·è€…**: æ¸¬è©¦å·¥ç¨‹å¸«
**æœ€å¾Œæ›´æ–°**: 2026-01-15
**ä¸‹æ¬¡å¯©æ ¸**: 2026-03-31
