# M09-籌碼分析模組效能考量

> **文件編號**: PERF-M09
> **模組名稱**: 籌碼分析模組
> **版本**: v1.0
> **最後更新**: 2026-01-11
> **狀態**: Draft

---

## 1. 效能目標

| 指標 | 目標值 | 測量方式 | 說明 |
|-----|-------|---------|------|
| 單股籌碼查詢（快取命中） | P95 < 50ms | APM 監控 | Redis 快取命中 |
| 單股籌碼查詢（快取未命中） | P95 < 150ms | APM 監控 | 資料庫查詢 |
| 單股即時計算 | P95 < 200ms | APM 監控 | 完整計算所有指標 |
| 排行榜查詢 | P95 < 100ms | APM 監控 | 50 筆結果 |
| 異常訊號掃描（全市場） | < 5s | Job 執行記錄 | 1800 檔股票 |
| 每日籌碼批次計算 | < 8 分鐘 | Job 執行記錄 | 1800 檔股票 |
| 快取命中率 | > 80% | Redis 統計 | 熱門股票 |
| 資料庫查詢時間 | < 50ms | 慢查詢日誌 | 單表查詢 |

---

## 2. 效能優化策略

### 2.1 計算引擎優化

**批次計算優化**:
```
┌─────────────────────────────────────────────────────────────────┐
│                    批次計算架構                                   │
└─────────────────────────────────────────────────────────────────┘

                    ┌─────────────────┐
                    │   股票清單       │
                    │ (1800 檔)       │
                    └─────────────────┘
                            │
                            ▼
                    ┌─────────────────┐
                    │   分批處理       │ ← batch_size = 50
                    │ (36 批)         │
                    └─────────────────┘
                            │
            ┌───────────────┼───────────────┐
            ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │  Thread 1   │ │  Thread 2   │ │  Thread N   │
    │  Batch 1-12 │ │  Batch 13-24│ │  Batch 25-36│
    └─────────────┘ └─────────────┘ └─────────────┘
            │               │               │
            └───────────────┴───────────────┘
                            │
                            ▼
                    ┌─────────────────┐
                    │  MyBatis 批次   │
                    │  UPSERT         │
                    │ (100 筆/批)     │
                    └─────────────────┘
```

**執行緒池配置**:
```java
@Configuration
public class ChipEngineConfig {

    @Bean("chipCalculationExecutor")
    public ThreadPoolTaskExecutor chipCalculationExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(4);           // CPU 核心數
        executor.setMaxPoolSize(8);            // 最大執行緒數
        executor.setQueueCapacity(100);        // 任務佇列
        executor.setKeepAliveSeconds(60);
        executor.setThreadNamePrefix("chip-calc-");
        executor.setRejectedExecutionHandler(new CallerRunsPolicy());
        return executor;
    }
}
```

**計算器快取**:
- 中間計算結果快取（如 MA5 可複用計算 MA20）
- 使用 ThreadLocal 避免重複計算

---

### 2.2 資料庫優化

**索引策略**:

| 表名 | 索引 | 查詢場景 |
|-----|------|---------|
| chip_analysis_results | (stock_id) | 單股查詢 |
| chip_analysis_results | (trade_date) | 日期查詢 + 分區裁剪 |
| chip_analysis_results | (foreign_net) | 外資排行榜 |
| chip_analysis_results | (total_net) | 法人合計排行榜 |
| chip_analysis_results | (chip_score) | 籌碼評分排行 |
| chip_signals | (trade_date, severity) | 當日異常訊號查詢 |
| chip_signals | (stock_id, trade_date) | 單股訊號查詢 |

**分區策略**:
```sql
-- chip_analysis_results 按年份分區
-- 查詢時自動裁剪不相關年份

-- 範例：查詢 2024 年資料
EXPLAIN ANALYZE
SELECT * FROM chip_analysis_results
WHERE stock_id = '2330'
  AND trade_date BETWEEN '2024-01-01' AND '2024-12-31';

-- 預期結果：只掃描 chip_analysis_results_2024 分區
```

**批次寫入優化**:
```sql
-- MyBatis 批次 UPSERT（每批 100 筆）
INSERT INTO chip_analysis_results (
    stock_id, trade_date, foreign_net, ...
) VALUES
    (row1), (row2), ..., (row100)
ON CONFLICT (stock_id, trade_date) DO UPDATE SET
    foreign_net = EXCLUDED.foreign_net,
    ...
    updated_at = CURRENT_TIMESTAMP;
```

**連線池配置**:
```yaml
spring:
  datasource:
    hikari:
      minimum-idle: 10
      maximum-pool-size: 50
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

---

### 2.3 快取優化

**多層快取架構**:
```
┌─────────────────────────────────────────────────────────────────┐
│                        快取層級                                   │
└─────────────────────────────────────────────────────────────────┘

請求
  │
  ▼
┌─────────────────────┐
│  L1: 本地快取        │ ← Caffeine Cache
│  TTL: 5 分鐘        │     最熱門 100 檔股票
│  Size: 1000 entries │
└─────────────────────┘
  │ 未命中
  ▼
┌─────────────────────┐
│  L2: Redis 快取     │ ← 分散式快取
│  TTL: 1-6 小時      │     所有計算結果
└─────────────────────┘
  │ 未命中
  ▼
┌─────────────────────┐
│  L3: PostgreSQL     │ ← 持久化儲存
└─────────────────────┘
```

**Redis 快取配置**:
```java
@Configuration
public class ChipCacheConfig {

    @Bean
    public RedisCacheConfiguration chipCacheConfig() {
        return RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofHours(6))
            .serializeKeysWith(
                RedisSerializationContext.SerializationPair
                    .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(
                RedisSerializationContext.SerializationPair
                    .fromSerializer(new GenericJackson2JsonRedisSerializer()));
    }
}
```

**快取 Key 設計**:

| 快取類型 | Key Pattern | TTL | 說明 |
|---------|-------------|-----|------|
| 單股分析 | `chip:analysis:{stockId}:{date}` | 6 小時 | 當日分析結果 |
| 排行榜 | `chip:rank:{type}:{date}:{market}` | 30 分鐘 | 排行榜結果 |
| 異常訊號 | `chip:signals:{date}` | 1 小時 | 當日異常 |
| 元數據 | `chip:metadata:indicators` | 24 小時 | 指標元數據 |

**快取預熱**:
```java
@Component
public class ChipCacheWarmer implements ApplicationRunner {

    @Override
    public void run(ApplicationArguments args) {
        // 1. 預載熱門股票清單（市值前 100）
        List<String> hotStocks = stockService.getHotStocks(100);

        // 2. 預載最新交易日的籌碼分析結果
        LocalDate latestDate = tradingCalendarService.getLatestTradingDay();
        for (String stockId : hotStocks) {
            chipAnalysisService.getAnalysis(stockId, latestDate);
        }

        // 3. 預載各類排行榜
        for (RankType type : RankType.values()) {
            rankingService.getRanking(type, latestDate);
        }
    }
}
```

**快取防護策略**:

| 問題 | 解決方案 |
|-----|---------|
| 快取穿透 | 布隆過濾器 + 空值快取（TTL 5分鐘） |
| 快取雪崩 | TTL 隨機化（±10%） |
| 快取擊穿 | 分散式鎖（Redisson） |

---

### 2.4 查詢優化

**排行榜查詢優化**:
```sql
-- 使用覆蓋索引
CREATE INDEX idx_chip_ranking_foreign
ON chip_analysis_results (trade_date, foreign_net DESC)
INCLUDE (stock_id, trust_net, dealer_net, total_net);

-- 查詢時直接從索引取得資料
SELECT stock_id, foreign_net, trust_net, dealer_net, total_net
FROM chip_analysis_results
WHERE trade_date = '2024-12-24'
ORDER BY foreign_net DESC
LIMIT 50;
```

**連續天數查詢優化**:
```sql
-- 預計算並儲存連續天數，避免即時遞迴計算
-- 在 chip_analysis_results 表中已有 foreign_continuous_days 欄位
SELECT stock_id, foreign_continuous_days
FROM chip_analysis_results
WHERE trade_date = '2024-12-24'
  AND foreign_continuous_days >= 5
ORDER BY foreign_continuous_days DESC;
```

---

## 3. 容量規劃

### 3.1 資料量估算

**chip_analysis_results 表**:
```
每日新增: 1800 檔股票 × 1 筆 = 1,800 筆/日
每年新增: 1,800 × 250 交易日 = 450,000 筆/年
5 年累積: 2,250,000 筆

單筆大小估算:
- 固定欄位: ~200 bytes
- JSONB 欄位: ~500 bytes
- 總計: ~700 bytes/筆

5 年總容量: 2,250,000 × 700 bytes ≈ 1.5 GB
含索引: 約 3-4 GB
```

**chip_signals 表**:
```
假設每日產生訊號: 約 100 筆（異常股票）
每年: 100 × 250 = 25,000 筆
保留 90 天: 約 9,000 筆

單筆大小: ~300 bytes
總容量: < 10 MB
```

**chip_rankings_cache 表**:
```
排行榜類型: 10 種
市場類型: 3 種（TWSE, OTC, ALL）
每日: 10 × 3 = 30 筆

保留 7 天: 210 筆
JSONB 大小: ~10 KB/筆
總容量: < 5 MB
```

### 3.2 Redis 記憶體估算

```
快取項目:
- 單股分析: 1800 × 2 KB = 3.6 MB
- 排行榜: 30 × 50 KB = 1.5 MB
- 異常訊號: 1 × 100 KB = 0.1 MB
- 其他: 1 MB

總計: 約 10 MB（單日）
建議分配: 100-200 MB（含歷史資料）
```

### 3.3 硬體需求

**開發/測試環境**:
- CPU: 2 核
- RAM: 4 GB
- Disk: 20 GB SSD
- Redis: 256 MB

**生產環境（單機）**:
- CPU: 4 核
- RAM: 16 GB
- Disk: 100 GB SSD
- Redis: 1 GB
- PostgreSQL shared_buffers: 4 GB

---

## 4. 監控指標

| 指標類型 | 指標名稱 | 閾值 | 告警等級 |
|---------|---------|------|---------|
| API 效能 | P95 回應時間 | > 300ms | WARNING |
| API 效能 | P99 回應時間 | > 500ms | ERROR |
| 計算效能 | 單股計算時間 | > 500ms | WARNING |
| 批次效能 | Job 執行時長 | > 預估 × 2 | WARNING |
| 快取 | Redis 命中率 | < 70% | WARNING |
| 快取 | Redis 記憶體使用率 | > 80% | WARNING |
| 資料庫 | 慢查詢數量 | > 10/分鐘 | WARNING |
| 資料庫 | 連線池使用率 | > 80% | WARNING |

---

## 5. 效能測試場景

| 測試場景 | 預期結果 | 說明 |
|---------|---------|------|
| 100 併發單股查詢（快取命中） | P95 < 50ms | 熱門股票查詢 |
| 100 併發單股查詢（快取未命中） | P95 < 200ms | 冷門股票查詢 |
| 50 併發排行榜查詢 | P95 < 150ms | 各類排行榜 |
| 批次計算 1800 股 | < 8 分鐘 | 每日 Job |
| 全市場訊號掃描 | < 5 秒 | 異常偵測 |

---

## 📚 相關文檔

- [M09 功能需求](../specs/functional/M09-籌碼分析功能需求.md)
- [M09 資料庫設計](./M09-資料庫設計.md)
- [M09 Job排程配置](../deployment/M09-Job排程配置.md)
- [NFR非功能性需求](../specs/technical/00-NFR非功能性需求.md)

---

**文件維護者**: 效能工程師
**最後更新**: 2026-01-11
**下次審核**: 2026-03-31
