# M09-籌碼分析模組開發記錄

> **文件編號**: DEV-M09
> **模組名稱**: 籌碼分析模組
> **版本**: v1.0
> **最後更新**: 2026-01-15
> **狀態**: Active

---

## 開發進度總覽

| 優先級 | 計畫數量 | 已完成 | 進度 |
|-------|---------|-------|------|
| P0 基礎組 | 3 | 3 | ✅ 100% |
| P1 進階組 | 4 | 4 | ✅ 100% |
| P2 專業組 | 2 | 0 | ⏳ 0% |

---

## P0 基礎組（已完成）

### 完成日期
2026-01-15

### 功能清單

#### 三大法人指標計算器（4 個）

| 類別 | 名稱 | 檔案路徑 | 狀態 | 備註 |
|------|------|----------|------|------|
| INSTITUTIONAL | 外資買賣超 | `calculator/institutional/ForeignNetCalculator.java` | ✅ | 含 MA5, MA20, 累計 |
| INSTITUTIONAL | 投信買賣超 | `calculator/institutional/TrustNetCalculator.java` | ✅ | 含 MA5, MA20 |
| INSTITUTIONAL | 自營商買賣超 | `calculator/institutional/DealerNetCalculator.java` | ✅ | 含合計 total_net |
| INSTITUTIONAL | 連續買賣超天數 | `calculator/institutional/ContinuousDaysCalculator.java` | ✅ | 外資/投信/融資連續天數 |

#### 融資融券指標計算器（3 個）

| 類別 | 名稱 | 檔案路徑 | 狀態 | 備註 |
|------|------|----------|------|------|
| MARGIN | 融資餘額 | `calculator/margin/MarginBalanceCalculator.java` | ✅ | 含增減、使用率 |
| MARGIN | 融券餘額 | `calculator/margin/ShortBalanceCalculator.java` | ✅ | 含增減 |
| MARGIN | 券資比 | `calculator/margin/MarginShortRatioCalculator.java` | ✅ | |

#### 籌碼異常訊號偵測器（2 個）

| 類別 | 名稱 | 檔案路徑 | 狀態 | 備註 |
|------|------|----------|------|------|
| SIGNAL | 法人訊號偵測 | `calculator/signal/InstitutionalSignalDetector.java` | ✅ | CHIP_SIG_001~008 |
| SIGNAL | 融資融券訊號偵測 | `calculator/signal/MarginSignalDetector.java` | ✅ | CHIP_SIG_009~013 |

### 引擎核心元件

| 類型 | 名稱 | 檔案路徑 | 狀態 |
|------|------|----------|------|
| Interface | ChipCalculator | `engine/calculator/ChipCalculator.java` | ✅ |
| Interface | ChipEngine | `engine/ChipEngine.java` | ✅ |
| Implementation | DefaultChipEngine | `engine/DefaultChipEngine.java` | ✅ |
| Registry | ChipRegistry | `engine/ChipRegistry.java` | ✅ |
| Plan | ChipPlan | `engine/ChipPlan.java` | ✅ |
| Result | ChipResult | `engine/ChipResult.java` | ✅ |

### 模型類別

| 類型 | 名稱 | 檔案路徑 | 狀態 |
|------|------|----------|------|
| Input Model | ChipSeries | `engine/model/ChipSeries.java` | ✅ |
| Metadata | ChipMetadata | `engine/model/ChipMetadata.java` | ✅ |
| Signal Model | ChipSignal | `engine/model/ChipSignal.java` | ✅ |
| Diagnostics | Diagnostics | `engine/model/Diagnostics.java` | ✅ |

---

## P1 進階組（已完成）

### 完成日期
2026-01-15

### 功能清單

#### 資料存取層

| 類型 | 名稱 | 檔案路徑 | 狀態 | 備註 |
|------|------|----------|------|------|
| Provider | ChipSeriesProvider | `provider/ChipSeriesProvider.java` | ✅ | 從 M06 取得籌碼資料 |
| Entity | ChipAnalysisResult | `domain/ChipAnalysisResult.java` | ✅ | JSONB 欄位 |
| Entity | ChipSignalEntity | `domain/ChipSignalEntity.java` | ✅ | |
| JPA Repository | ChipAnalysisResultRepository | `repository/ChipAnalysisResultRepository.java` | ✅ | |
| JPA Repository | ChipSignalRepository | `repository/ChipSignalRepository.java` | ✅ | |
| MyBatis Mapper | ChipAnalysisMapper | `mapper/ChipAnalysisMapper.java` | ✅ | 排行榜查詢 |

#### DTO 與轉換器

| 類型 | 名稱 | 檔案路徑 | 狀態 |
|------|------|----------|------|
| DTO | ChipAnalysisResultDTO | `dto/ChipAnalysisResultDTO.java` | ✅ |
| DTO | ChipSignalDTO | `dto/ChipSignalDTO.java` | ✅ |
| DTO | ChipRankingDTO | `dto/ChipRankingDTO.java` | ✅ |
| Request | ChipQueryRequest | `dto/request/ChipQueryRequest.java` | ✅ |
| Request | ChipCalculationRequest | `dto/request/ChipCalculationRequest.java` | ✅ |
| Request | ChipRankingRequest | `dto/request/ChipRankingRequest.java` | ✅ |
| Response | StockChipResponse | `dto/response/StockChipResponse.java` | ✅ |
| Response | ChipRankingResponse | `dto/response/ChipRankingResponse.java` | ✅ |
| Response | ChipSignalsResponse | `dto/response/ChipSignalsResponse.java` | ✅ |
| Converter | ChipAnalysisResultConverter | `converter/ChipAnalysisResultConverter.java` | ✅ |
| Converter | ChipSignalConverter | `converter/ChipSignalConverter.java` | ✅ |

#### 服務層

| 類型 | 名稱 | 檔案路徑 | 狀態 | 備註 |
|------|------|----------|------|------|
| Service | ChipCalculationService | `service/ChipCalculationService.java` | ✅ | 整合 Engine 執行計算 |
| Service | ChipQueryService | `service/ChipQueryService.java` | ✅ | 提供查詢 API |

#### 控制器層

| 類型 | 名稱 | 檔案路徑 | 狀態 | 備註 |
|------|------|----------|------|------|
| Controller | ChipQueryController | `controller/ChipQueryController.java` | ✅ | 6 個 API 端點 |
| Controller | ChipJobController | `controller/ChipJobController.java` | ✅ | 計算觸發 API |

#### 列舉與例外

| 類型 | 名稱 | 檔案路徑 | 狀態 |
|------|------|----------|------|
| Enum | M09ErrorCode | `enums/M09ErrorCode.java` | ✅ |
| Enum | ChipCategory | `enums/ChipCategory.java` | ✅ |
| Enum | SignalSeverity | `enums/SignalSeverity.java` | ✅ |
| Exception | ChipCalculationException | `exception/ChipCalculationException.java` | ✅ |
| Exception | ChipNotFoundException | `exception/ChipNotFoundException.java` | ✅ |
| Exception | ChipSignalNotFoundException | `exception/ChipSignalNotFoundException.java` | ✅ |

### 已實作 API 端點

| API 編號 | Method | 路徑 | 說明 |
|---------|--------|------|------|
| API-M09-001 | GET | `/api/stocks/{stockId}/chip` | 查詢個股籌碼分析 |
| API-M09-002 | GET | `/api/chip/latest` | 批次查詢最新籌碼 |
| API-M09-003 | POST/GET | `/api/chip/rankings` | 查詢籌碼排行榜 |
| API-M09-004 | GET | `/api/chip/signals` | 查詢籌碼異常訊號 |
| API-M09-005 | GET | `/api/stocks/{stockId}/chip/signals` | 查詢個股籌碼訊號 |
| API-M09-006 | POST | `/api/jobs/calculate-chip` | 手動觸發籌碼計算 |

### 測試覆蓋

| 測試類別 | 檔案路徑 | 測試項目數 |
|---------|----------|-----------|
| ForeignNetCalculatorTest | `test/.../institutional/ForeignNetCalculatorTest.java` | 4 |
| ContinuousDaysCalculatorTest | `test/.../institutional/ContinuousDaysCalculatorTest.java` | 7 |
| MarginBalanceCalculatorTest | `test/.../margin/MarginBalanceCalculatorTest.java` | 5 |
| MarginShortRatioCalculatorTest | `test/.../margin/MarginShortRatioCalculatorTest.java` | 6 |
| InstitutionalSignalDetectorTest | `test/.../signal/InstitutionalSignalDetectorTest.java` | 7 |

> **總計**: 29 個測試項目，全部通過

---

## 新增目錄結構

```
src/main/java/com/chris/fin_shark/m09/
├── controller/
│   ├── ChipQueryController.java
│   └── ChipJobController.java
├── converter/
│   ├── ChipAnalysisResultConverter.java
│   └── ChipSignalConverter.java
├── domain/
│   ├── ChipAnalysisResult.java
│   └── ChipSignalEntity.java
├── dto/
│   ├── ChipAnalysisResultDTO.java
│   ├── ChipSignalDTO.java
│   ├── ChipRankingDTO.java
│   ├── request/
│   │   ├── ChipQueryRequest.java
│   │   ├── ChipCalculationRequest.java
│   │   └── ChipRankingRequest.java
│   └── response/
│       ├── StockChipResponse.java
│       ├── ChipRankingResponse.java
│       └── ChipSignalsResponse.java
├── engine/
│   ├── ChipEngine.java
│   ├── DefaultChipEngine.java
│   ├── ChipRegistry.java
│   ├── ChipPlan.java
│   ├── ChipResult.java
│   ├── calculator/
│   │   ├── ChipCalculator.java
│   │   ├── institutional/
│   │   │   ├── ForeignNetCalculator.java
│   │   │   ├── TrustNetCalculator.java
│   │   │   ├── DealerNetCalculator.java
│   │   │   └── ContinuousDaysCalculator.java
│   │   ├── margin/
│   │   │   ├── MarginBalanceCalculator.java
│   │   │   ├── ShortBalanceCalculator.java
│   │   │   └── MarginShortRatioCalculator.java
│   │   └── signal/
│   │       ├── ChipSignalDetector.java
│   │       ├── InstitutionalSignalDetector.java
│   │       └── MarginSignalDetector.java
│   └── model/
│       ├── ChipSeries.java
│       ├── ChipMetadata.java
│       ├── ChipSignal.java
│       └── Diagnostics.java
├── enums/
│   ├── M09ErrorCode.java
│   ├── ChipCategory.java
│   └── SignalSeverity.java
├── exception/
│   ├── ChipCalculationException.java
│   ├── ChipNotFoundException.java
│   └── ChipSignalNotFoundException.java
├── mapper/
│   └── ChipAnalysisMapper.java
├── provider/
│   └── ChipSeriesProvider.java
├── repository/
│   ├── ChipAnalysisResultRepository.java
│   └── ChipSignalRepository.java
└── service/
    ├── ChipCalculationService.java
    └── ChipQueryService.java

src/main/resources/mapper/
└── ChipAnalysisMapper.xml
```

---

## 待確認項目（TODO）

| 項目 | 待確認事項 | 優先級 |
|------|-----------|-------|
| Signal Detector | 訊號偵測器的回傳格式在 DefaultChipEngine 中的處理方式 | 中 |
| ChipSeries | 是否需要支援更多 M06 資料欄位 | 低 |
| 排行榜 | minVolume 參數在 Mapper XML 中的實作 | 低 |

---

## P2 專業組（待開發）

根據 `M09-籌碼分析功能需求.md`，P2 專業組包括：

| 功能編號 | 功能名稱 | 說明 |
|---------|---------|------|
| F-M09-003 | 籌碼集中度分析 | 大戶/散戶持股比例分析 |
| F-M09-004 | 主力成本估算 | 推估主力進出成本區間 |

**計畫**：按需開發

---

## 變更歷史

| 日期 | 版本 | 變更內容 | 作者 |
|------|------|---------|------|
| 2026-01-15 | v1.0 | 初版：P0 + P1 開發完成記錄 | backend-architect |

---

## 相關文檔

- [M09 功能需求](../specs/functional/M09-籌碼分析功能需求.md)
- [M09 API 規格](../specs/api/M09-API規格.md)
- [M09 測試準則](./M09-測試準則.md)
- [M09 資料庫設計](./M09-資料庫設計.md)
