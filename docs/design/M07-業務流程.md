# M07-技術分析模組業務流程

> **文件編號**: FLOW-M07  
> **模組名稱**: 技術分析模組  
> **版本**: v2.0  
> **最後更新**: 2025-12-31  
> **狀態**: Draft

---

## 📋 業務流程總覽

本文件定義 技術分析模組的資料流與業務邏輯。

---

## 5. 資料流設計

### 5.1 資料流總覽

```
┌─────────────────────────────────────────────────────┐
│             M06 資料管理模組                          │
│         StockPriceUpdated 事件發布                   │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│                M07 技術分析模組                       │
│                                                     │
│  1. 接收事件 → 觸發指標計算 Job                      │
│  2. 查詢歷史股價（stock_prices）                     │
│  3. pandas-ta 批次計算指標                          │
│  4. 驗證計算結果                                    │
│  5. 儲存至 technical_indicators 表                  │
│  6. 回寫常用指標至 stock_prices                      │
│  7. 更新 Redis 快取                                 │
│  8. 偵測技術信號（交叉、超買超賣）                   │
│  9. 產生信號（遵守 Signal Contract）                 │
│ 10. 發布 TechnicalSignalDetected 事件               │
│                                                     │
└─────────────────────────────────────────────────────┘
                         ↓
        ┌────────────────┴────────────────┐
        ↓                                 ↓
┌──────────────┐                  ┌──────────────┐
│  M13 信號    │                  │  M14 選股    │
│  判斷引擎    │                  │  引擎        │
└──────────────┘                  └──────────────┘
```

---

### 5.2 核心流程：每日技術指標計算

```
START: 每日技術指標計算 Job
  ↓
1. 觸發條件
   - 時間：每日 15:30（盤後）
   - 或接收到 StockPriceUpdated 事件
  ↓
2. 建立 Job 執行記錄
   - 插入 indicator_calculation_jobs 表
   - status = 'RUNNING'
  ↓
3. 載入配置
   - 從 indicator_definitions 表載入啟用的指標
   - 依 priority 分組（P0 優先）
  ↓
4. 查詢需計算的股票清單
   - 若為事件觸發 → 從事件取得 stock_ids
   - 若為排程觸發 → 查詢所有活躍股票
  ↓
5. 批次處理（每批 50 檔股票）
   ↓
   5.1 對每檔股票：
       - 查詢歷史股價（最近 250 交易日）
       - 驗證資料充足性（min_data_points）
       ↓
   5.2 使用 pandas-ta 批次計算
       - 轉換為 pandas DataFrame
       - 呼叫 pandas-ta 函數（df.ta.rsi(), df.ta.macd()...）
       - 處理 NaN 值
       ↓
   5.3 驗證計算結果
       - 檢查值域範圍（RSI: 0-100）
       - 檢查 NaN、Inf
       - 記錄異常值
       ↓
   5.4 組裝 JSONB 資料
       - 依類別組裝（trend_indicators, momentum_indicators...）
       - 填充冗餘欄位（ma5, rsi_14...）
       ↓
   5.5 批次 UPSERT（MyBatis）
       - 儲存至 technical_indicators 表
       - ON CONFLICT DO UPDATE
       ↓
   5.6 回寫常用指標
       - UPDATE stock_prices SET ma5=?, ma20=?, volume_ma5=?
       ↓
   5.7 更新 Redis 快取
       - 若為熱門股票 → 主動更新快取
       - 清除舊快取鍵
  ↓
6. 偵測技術信號
   - 黃金交叉/死亡交叉偵測
   - KD 交叉偵測
   - 超買超賣偵測
   ↓
7. 產生信號（遵守總綱 4.1 Signal Contract）
   - signal_source = 'M07_TECHNICAL_ANALYSIS'
   - signal_name = 'MA_GOLDEN_CROSS' / 'RSI_OVERBOUGHT'...
   - evidence_data 填充指標值
  ↓
8. 發布事件
   - TechnicalSignalDetected 事件
   - 訂閱者：M13 信號判斷引擎
  ↓
9. 更新 Job 執行記錄
   - status = 'SUCCESS' / 'FAILED'
   - statistics 填充（成功筆數、失敗筆數）
   - end_time, duration_seconds
  ↓
END
```

---

### 5.3 流程：查詢技術指標（含快取）

```
START: API 請求查詢指標
  ↓
1. 接收請求
   - stock_id, start_date, end_date, indicators
  ↓
2. 參數驗證
   - 股票代碼格式
   - 日期範圍合理性（不超過 1 年）
   - 指標名稱有效性
   ↓
3. 檢查 Redis 快取
   - Key: tech:indicators:{stock_id}:{start_date}:{end_date}
   ├─ 命中 → 返回快取資料
   └─ 未命中 → 繼續
  ↓
4. 查詢 PostgreSQL
   - 使用 MyBatis 複雜查詢
   - 解析 JSONB 欄位
   - 過濾指定日期範圍
  ↓
5. 資料轉換
   - 將 JSONB 展開為 JSON 物件
   - 組裝 Response 格式
  ↓
6. 寫入 Redis 快取
   - 序列化為 JSON
   - 設定 TTL（6 小時）
  ↓
7. 返回結果
   - 遵守總綱 4.4 API Response 格式
  ↓
END
```

---

### 5.4 流程：交叉信號偵測


START: 偵測黃金交叉信號
  ↓
1. 取得今日指標
   - 查詢 technical_indicators
   - WHERE calculation_date = TODAY
   - 取得 ma5, ma20
  ↓
2. 取得昨日指標
   - 查詢 technical_indicators
   - WHERE calculation_date = YESTERDAY
   - 取得 ma5, ma20
  ↓
3. 判斷交叉條件
   ├─ 昨日：ma5 < ma20 AND 今日：ma5 > ma20
   │   → 黃金交叉（GOLDEN_CROSS）
   │
   ├─ 昨日：ma5 > ma20 AND 今日：ma5 < ma20
   │   → 死亡交叉（DEATH_CROSS）
   │
   └─ 否 → 無交叉，結束
  ↓
4. 產生信號（遵守總綱 4.1 Signal Contract）
   - signal_uuid = UUID
   - signal_type = 'BUY' / 'SELL'
   - signal_source = 'M07_TECHNICAL_ANALYSIS'
   - signal_name = 'MA_GOLDEN_CROSS' / 'MA_DEATH_CROSS'
   - signal_category = 'TREND_CROSS'
   - confidence_score = 70
   - evidence_data = {
       indicator: 'MA',
       short_period: 5,
       long_period: 20,
       today_ma5: 值,
       today_ma20: 值,
       yesterday_ma5: 值,
       yesterday_ma20: 值,
       cross_date: 日期
     }
  ↓
5. 儲存信號（發送至 M13）
   - 插入 signals 表（遵守 Signal Contract）
   - 或透過 Event 發布給 M13
  



---

## 7. 業務邏輯設計

> **說明**: 本節以文字描述業務邏輯與演算法，不包含程式碼實作

### 7.1 Service 層架構

```
IndicatorCalculationService (指標計算服務 - 門面)
    │
    ├─→ PandasTaCalculationEngine (pandas-ta 計算引擎)
    │       ├─ 職責: 呼叫 pandas-ta 計算技術指標
    │       ├─ 依賴: JPype / REST API
    │       └─ 核心方法: calculate(stockId, prices, priority)
    │
    ├─→ SignalDetectionService (信號偵測服務)
    │       ├─ 職責: 偵測交叉、超買超賣、背離信號
    │       ├─ 依賴: TechnicalIndicatorRepository (JPA), TechnicalIndicatorMapper (MyBatis)
    │       └─ 核心方法: detectCrossSignals(), detectOverboughtOversold()
    │
    ├─→ IndicatorQueryService (指標查詢服務)
    │       ├─ 職責: 提供指標查詢介面、快取管理
    │       ├─ 依賴: TechnicalIndicatorMapper (MyBatis), RedisTemplate
    │       └─ 核心方法: queryIndicators(), queryLatestIndicatorsBatch()
    │
    ├─→ IndicatorValidationService (指標驗證服務)
    │       ├─ 職責: 驗證指標計算結果的正確性與合理性
    │       ├─ 依賴: IndicatorDefinitionRepository (JPA)
    │       └─ 核心方法: validateRange(), validateConsistency()
    │
    └─→ CacheManagementService (快取管理服務)
            ├─ 職責: 快取預熱、快取更新、快取失效
            ├─ 依賴: RedisTemplate
            └─ 核心方法: warmupCache(), updateCache(), invalidateCache()
```

---

### 7.2 指標計算邏輯

#### 7.2.1 計算流程總覽

**輸入**: stock_id, calculation_date, indicator_priority  
**輸出**: 計算完成的技術指標資料

**處理步驟**:

**步驟 1: 查詢歷史股價**
- 從 stock_prices 表查詢最近 250 個交易日的股價資料
- 檢查資料充足性（至少需要 10 個交易日）
- 若資料不足，標記並跳過長週期指標

**步驟 2: 資料格式轉換**
- 將股價資料轉換為 pandas DataFrame 格式
- 欄位對應：trade_date → date, close_price → close, high_price → high, low_price → low, volume → volume

**步驟 3: 依優先級載入指標定義**
- P0 基礎組：11 個指標（MA、EMA、RSI、KD、MACD、BBands、ATR、OBV、Volume MA、ADX、VWAP）
- P1 進階組：20 個指標（WMA、HMA、Stochastic RSI、Williams %R、CCI、MFI 等）
- P2 專業組：40 個指標（DEMA、TEMA、Ultimate Oscillator、Hurst Exponent 等）

**步驟 4: 呼叫 pandas-ta 批次計算**
- 使用 pandas-ta 的 `df.ta.*` 方法計算指標
- 批次計算同類別指標（如所有 MA 週期一次計算完成）
- 處理 NaN 值（資料不足期間允許 NaN）

**步驟 5: 驗證計算結果**
- 檢查值域範圍（RSI: 0-100, Stochastic: 0-100 等）
- 檢查 NaN、Inf 異常值
- 檢查合理性（MA 值應接近收盤價）

**步驟 6: 組裝 JSONB 資料**
- 依類別組裝 JSONB（trend_indicators, momentum_indicators, volatility_indicators 等）
- 填充冗餘欄位（ma5, ma20, rsi_14, stoch_k, stoch_d 等）

**步驟 7: 儲存至資料庫**
- 使用 MyBatis 批次 UPSERT（ON CONFLICT DO UPDATE）
- 確保冪等性（重複執行不產生重複資料）

**步驟 8: 回寫常用指標至 stock_prices**
- UPDATE stock_prices SET ma5=?, ma20=?, volume_ma5=? WHERE stock_id=? AND trade_date=?

**步驟 9: 更新快取**
- 若為熱門股票（市值前 50），主動更新 Redis 快取
- 清除舊快取鍵

---

#### 7.2.2 pandas-ta 整合策略

**方案 1: JPype 整合（推薦）**

**初始化**:
```
系統啟動時:
1. 檢查 Python 環境是否存在
2. 啟動 JVM（JPype.startJVM()）
3. 載入 pandas、pandas_ta 模組
4. 測試連線與計算功能
```

**計算流程**:
```
1. 從 Java 傳遞股價資料至 Python
   - 轉換為 Python dict 格式
   - 建立 pandas DataFrame

2. 呼叫 pandas-ta 函數
   - df.ta.sma(length=[5, 20, 60])  # 一次計算多個週期
   - df.ta.ema(length=[12, 26, 50])
   - df.ta.macd(fast=12, slow=26, signal=9)
   - df.ta.rsi(length=14)
   - df.ta.stoch(k=9, d=3, smooth_k=3)
   - df.ta.bbands(length=20, std=2)
   - df.ta.atr(length=14)
   - df.ta.obv()
   - df.ta.vwap()
   - df.ta.adx(length=14)

3. 取得計算結果
   - 從 Python 回傳結果至 Java
   - 轉換為 Java 物件（IndicatorCalculationResult）
```

**錯誤處理**:
```
IF Python 環境不存在:
  - 記錄錯誤: "pandas-ta 環境未安裝"
  - 降級使用 Java 原生實作（ta4j）或拋出異常

IF 計算超時（> 30 秒）:
  - 中斷計算
  - 記錄警告: "指標計算超時"
  - 跳過該股票

IF 計算異常（Exception）:
  - 記錄錯誤與 stack trace
  - 標記該股票計算失敗
  - 繼續處理其他股票
```

---

**方案 2: REST API 整合**

**架構**:
```
Java Service → HTTP Request → Python Flask API → pandas-ta → Response → Java
```

**Python Flask API 端點**:
```
POST /api/calculate
Request Body:
{
  "stock_id": "2330",
  "prices": [
    {"date": "2024-12-24", "close": 580.0, "high": 585.0, "low": 575.0, "volume": 35000000},
    ...
  ],
  "indicators": ["MA", "RSI", "MACD", "KD", "BBANDS", "ATR"]
}

Response:
{
  "stock_id": "2330",
  "indicators": {
    "MA": {"ma5": 580.5, "ma20": 570.8, "ma60": 565.0},
    "RSI": {"rsi_14": 65.5},
    ...
  }
}
```

**Java 呼叫邏輯**:
```
1. 組裝 HTTP Request
   - URL: http://localhost:8001/api/calculate
   - Method: POST
   - Body: JSON（股價資料 + 指標清單）

2. 發送請求（RestTemplate / WebClient）
   - 設定超時時間: 30 秒
   - 設定重試策略: 最多 3 次

3. 解析 Response
   - 反序列化 JSON 為 Java 物件
   - 驗證結果完整性

4. 返回計算結果
```

**優點**:
- 解耦合，Java 和 Python 獨立部署
- 易於擴展（多個 Python 節點負載平衡）
- 易於監控（API 呼叫日誌、效能指標）

**缺點**:
- 網路延遲（增加 10-50ms）
- 需要額外維護 Python 服務
- 序列化/反序列化開銷

---

#### 7.2.3 指標計算參數管理

**載入指標定義**:
```
查詢 indicator_definitions 表:
SELECT * FROM indicator_definitions 
WHERE priority = 'P0' 
  AND is_active = true
ORDER BY indicator_name

結果:
[
  {indicator_name: 'MA', default_params: {periods: [5, 20, 60]}, pandas_ta_function: 'sma'},
  {indicator_name: 'RSI', default_params: {period: 14}, pandas_ta_function: 'rsi'},
  ...
]
```

**動態組裝計算參數**:
```
FOR EACH 指標定義:
  提取 pandas_ta_function 名稱
  提取 default_params 參數
  
  範例:
  指標: MA
  函數: df.ta.sma
  參數: length=[5, 20, 60]
  
  呼叫: df.ta.sma(length=[5, 20, 60])
  結果欄位: SMA_5, SMA_20, SMA_60
```

**參數驗證**:
```
檢查參數範圍（param_ranges）:
IF (實際參數 < min 或 實際參數 > max) THEN
  記錄警告: "參數超出建議範圍"
  使用預設參數
END IF

範例:
RSI 期間範圍: [5, 30]
若使用者設定 period=50 → 警告並使用預設 14
```

---

### 7.3 信號偵測邏輯

#### 7.3.1 黃金交叉偵測

**輸入**: stock_id, calculation_date  
**輸出**: 黃金交叉信號（若偵測到）

**處理步驟**:

**步驟 1: 取得今日與昨日指標**
```
查詢今日指標:
SELECT ma5, ma20, ma60 
FROM technical_indicators 
WHERE stock_id = '2330' 
  AND calculation_date = '2024-12-24'

查詢昨日指標:
SELECT ma5, ma20, ma60 
FROM technical_indicators 
WHERE stock_id = '2330' 
  AND calculation_date = '2024-12-23'
```

**步驟 2: 判斷 MA5 x MA20 交叉**
```
IF (昨日 ma5 < 昨日 ma20) AND (今日 ma5 > 今日 ma20) THEN
  偵測到黃金交叉
  
  計算交叉強度:
  cross_strength = (今日 ma5 - 今日 ma20) / 今日 ma20 × 100
  
  IF (cross_strength > 1%) THEN
    signal_strength = 'STRONG'
    confidence_score = 75
  ELSE
    signal_strength = 'WEAK'
    confidence_score = 70
  END IF
END IF
```

**步驟 3: 判斷 MA20 x MA60 交叉（長期趨勢）**
```
IF (昨日 ma20 < 昨日 ma60) AND (今日 ma20 > 今日 ma60) THEN
  偵測到長期黃金交叉
  
  signal_strength = 'VERY_STRONG'  // 長期交叉更具意義
  confidence_score = 80
END IF
```

**步驟 4: 產生信號（遵守總綱 4.1 Signal Contract）**
```
信號內容:
- signal_uuid = UUID 生成
- stock_id = '2330'
- signal_type = 'BUY'
- signal_source = 'M07_TECHNICAL_ANALYSIS'
- signal_name = 'MA_GOLDEN_CROSS'
- signal_category = 'TREND_CROSS'
- trigger_price = 當期收盤價
- confidence_score = 70-80（依交叉強度）
- evidence_data = {
    indicator: 'MA',
    short_period: 5,
    long_period: 20,
    today_ma5: 580.50,
    today_ma20: 570.80,
    yesterday_ma5: 568.20,
    yesterday_ma20: 570.50,
    cross_date: '2024-12-24',
    cross_strength: 1.7
  }
- detected_at = 當前時間
```

**步驟 5: 儲存信號並發布事件**
```
儲存至 signals 表（遵守總綱 Signal Contract）

發布事件:
Event Type: TechnicalSignalDetected
Event Data: {signal_uuid, stock_id, signal_type, signal_name, confidence_score}
訂閱者: M13 信號判斷引擎
```

---

#### 7.3.2 死亡交叉偵測

**判斷邏輯**:
```
IF (昨日 ma5 > 昨日 ma20) AND (今日 ma5 < 今日 ma20) THEN
  偵測到死亡交叉
  
  信號內容:
  - signal_type = 'SELL'
  - signal_name = 'MA_DEATH_CROSS'
  - confidence_score = 70
END IF
```

---

#### 7.3.3 KD 交叉偵測

**低檔黃金交叉（強勢買進信號）**:
```
IF (昨日 K < 昨日 D) AND (今日 K > 今日 D) AND (今日 K < 20) THEN
  偵測到 KD 低檔黃金交叉
  
  信號內容:
  - signal_type = 'BUY'
  - signal_name = 'KD_GOLDEN_CROSS_LOW'
  - signal_category = 'MOMENTUM_CROSS'
  - confidence_score = 80  // 低檔交叉，信心度更高
  - evidence_data = {
      indicator: 'KD',
      today_k: 18.5,
      today_d: 15.2,
      yesterday_k: 14.8,
      yesterday_d: 16.3,
      cross_position: 'LOW'  // 低檔（< 20）
    }
END IF
```

**高檔死亡交叉（強勢賣出信號）**:
```
IF (昨日 K > 昨日 D) AND (今日 K < 今日 D) AND (今日 K > 80) THEN
  偵測到 KD 高檔死亡交叉
  
  信號內容:
  - signal_type = 'SELL'
  - signal_name = 'KD_DEATH_CROSS_HIGH'
  - confidence_score = 80
  - evidence_data.cross_position = 'HIGH'  // 高檔（> 80）
END IF
```

**一般交叉（弱勢信號）**:
```
IF (昨日 K < 昨日 D) AND (今日 K > 今日 D) AND (20 <= 今日 K <= 80) THEN
  偵測到 KD 一般黃金交叉
  
  信號內容:
  - signal_type = 'BUY'
  - signal_name = 'KD_GOLDEN_CROSS'
  - confidence_score = 65  // 中性區交叉，信心度較低
  - evidence_data.cross_position = 'MIDDLE'
END IF
```

---

#### 7.3.4 超買超賣偵測

**RSI 超買偵測**:

**步驟 1: 取得當期 RSI 值**
```
查詢最新 RSI:
SELECT rsi_14 
FROM technical_indicators 
WHERE stock_id = '2330' 
  AND calculation_date = '2024-12-24'

結果: rsi_14 = 78.5
```

**步驟 2: 計算持續超買天數**
```
查詢最近 7 天 RSI:
SELECT calculation_date, rsi_14 
FROM technical_indicators 
WHERE stock_id = '2330' 
  AND calculation_date >= '2024-12-18'
  AND calculation_date <= '2024-12-24'
ORDER BY calculation_date DESC

計算持續天數:
duration_days = 0
FOR EACH 日期（從今日往前）:
  IF (rsi_14 > 70) THEN
    duration_days += 1
  ELSE
    BREAK  // 中斷，不再計算
  END IF
END FOR

結果: duration_days = 3（連續 3 天超買）
```

**步驟 3: 產生超買信號**
```
IF (rsi_14 > 70) THEN
  判斷信號強度:
  IF (duration_days >= 5) THEN
    confidence_score = 75  // 持續 5 天以上，反轉機率高
    signal_strength = 'VERY_STRONG'
  ELSE IF (duration_days >= 3) THEN
    confidence_score = 70  // 持續 3-4 天
    signal_strength = 'STRONG'
  ELSE
    confidence_score = 60  // 剛進入超買
    signal_strength = 'WEAK'
  END IF
  
  信號內容:
  - signal_type = 'SELL'
  - signal_name = 'RSI_OVERBOUGHT'
  - signal_category = 'MOMENTUM_EXTREME'
  - confidence_score = 60-75（依持續天數）
  - evidence_data = {
      indicator: 'RSI',
      rsi_value: 78.5,
      threshold: 70,
      duration_days: 3,
      signal_strength: 'STRONG'
    }
END IF
```

**RSI 超賣偵測**:
```
IF (rsi_14 < 30) THEN
  計算持續超賣天數（同上邏輯）
  
  信號內容:
  - signal_type = 'BUY'
  - signal_name = 'RSI_OVERSOLD'
  - confidence_score = 60-75
END IF
```

---

**Stochastic KD 超買超賣偵測**:
```
IF (K > 80 AND D > 80) THEN
  信號內容:
  - signal_type = 'SELL'
  - signal_name = 'STOCH_OVERBOUGHT'
  - confidence_score = 65
  - evidence_data = {k: 85.2, d: 82.3}
END IF

IF (K < 20 AND D < 20) THEN
  信號內容:
  - signal_type = 'BUY'
  - signal_name = 'STOCH_OVERSOLD'
  - confidence_score = 65
END IF
```

---

**Williams %R 超買超賣偵測**:
```
IF (Williams %R > -20) THEN
  信號內容:
  - signal_type = 'SELL'
  - signal_name = 'WILLR_OVERBOUGHT'
  - confidence_score = 60
END IF

IF (Williams %R < -80) THEN
  信號內容:
  - signal_type = 'BUY'
  - signal_name = 'WILLR_OVERSOLD'
  - confidence_score = 60
END IF
```

---

### 7.4 指標驗證邏輯

#### 7.4.1 範圍驗證

**RSI 範圍驗證**:
```
IF (RSI < 0 OR RSI > 100) THEN
  驗證失敗
  錯誤訊息: "RSI 超出範圍 [0, 100]，當前值: {RSI}"
  處理方式: 標記為計算異常，不儲存該筆指標
END IF
```

**Stochastic KD 範圍驗證**:
```
IF (K < 0 OR K > 100 OR D < 0 OR D > 100) THEN
  驗證失敗
  錯誤訊息: "KD 超出範圍 [0, 100]"
  處理方式: 標記為計算異常
END IF
```

**Williams %R 範圍驗證**:
```
IF (Williams %R < -100 OR Williams %R > 0) THEN
  驗證失敗
  錯誤訊息: "Williams %R 超出範圍 [-100, 0]"
END IF
```

**ADX 範圍驗證**:
```
IF (ADX < 0 OR ADX > 100) THEN
  驗證失敗
  錯誤訊息: "ADX 超出範圍 [0, 100]"
END IF
```

---

#### 7.4.2 合理性驗證

**MA 值合理性檢查**:
```
計算 MA 與收盤價的偏離度:
deviation = ABS(MA - close_price) / close_price

IF (deviation > 0.2) THEN  // 偏離超過 20%
  記錄警告: "MA 值與收盤價偏離過大"
  警告內容: {
    ma_value: 580.5,
    close_price: 450.0,
    deviation: 0.29  // 29%
  }
  處理方式: 記錄警告但仍儲存資料（可能是長期均線）
END IF
```

**Bollinger Bands 合理性檢查**:
```
IF (upper < middle OR lower > middle) THEN
  驗證失敗
  錯誤訊息: "Bollinger Bands 上下軌順序錯誤"
  處理方式: 不儲存，標記為計算錯誤
END IF

IF (upper - lower < 0) THEN
  驗證失敗
  錯誤訊息: "Bollinger Bands 寬度為負值"
END IF

IF ((upper - lower) / middle > 0.5) THEN  // 寬度超過中軌的 50%
  記錄警告: "Bollinger Bands 寬度異常大"
  處理方式: 記錄警告但仍儲存（可能是高波動期）
END IF
```

**MACD 合理性檢查**:
```
計算 MACD 柱狀圖與收盤價的比例:
ratio = ABS(macd_histogram) / close_price

IF (ratio > 0.1) THEN  // 柱狀圖超過收盤價的 10%
  記錄警告: "MACD 柱狀圖異常大"
  處理方式: 記錄警告但仍儲存
END IF
```

---

#### 7.4.3 完整性驗證

**JSONB 欄位完整性**:
```
檢查 trend_indicators:
IF (trend_indicators IS NULL OR trend_indicators = '{}') THEN
  記錄警告: "趨勢指標為空"
END IF

檢查必要指標存在:
required_indicators = ['ma', 'ema', 'macd']  // P0 基礎組必須有

FOR EACH required IN required_indicators:
  IF (trend_indicators 不包含 required) THEN
    記錄警告: "缺少必要指標: {required}"
  END IF
END FOR
```

**NaN 值處理**:
```
FOR EACH 指標值 IN 計算結果:
  IF (值 IS NULL OR 值 = 'NaN' OR 值 = 'Infinity') THEN
    檢查是否為資料不足期間:
    IF (日期 < 上市日期 + min_data_points 天) THEN
      允許 NaN（標記為 "資料不足期間"）
    ELSE
      驗證失敗: "計算異常，產生 NaN"
      處理方式: 記錄到 data_quality_issues 表
    END IF
  END IF
END FOR
```

**驗證失敗處理流程**:
```
驗證失敗 →
  ├─ 嚴重錯誤（範圍錯誤、NaN）
  │   ├─ 不儲存該筆指標
  │   ├─ 記錄到 data_quality_issues 表
  │   ├─ 嚴重度: HIGH
  │   └─ 觸發告警（若連續失敗）
  │
  └─ 輕微警告（合理性偏離）
      ├─ 儲存指標資料
      ├─ 記錄警告日誌
      └─ 嚴重度: LOW
```

---

### 7.5 批次處理邏輯

#### 7.5.1 批次大小決策

**決策依據**:
- 股價資料量（250 天 × 股票數）
- pandas-ta 計算時間（平均 200ms/股）
- 資料庫寫入效能（100 筆/批次最佳）
- 記憶體使用量

**建議批次大小**:
| 資料類型 | 批次大小 | 理由 |
|---------|---------|------|
| 股價查詢 | 50 檔股票 | 避免單次查詢資料量過大 |
| 指標計算 | 50 檔股票 | 平衡記憶體使用與效能 |
| 資料庫 UPSERT | 100 筆 | PostgreSQL UPSERT 最佳效能 |
| Redis 批次寫入 | 100 筆 | Pipeline 批次操作 |

---

#### 7.5.2 批次處理流程

```
總資料集（1800 檔股票）
  ↓
載入指標定義（P0 基礎組）
  ↓
分批處理（batch_size = 50）
  ↓
批次 1: 股票 1-50
├─ 查詢歷史股價（250 天 × 50 檔）
├─ pandas-ta 批次計算
│   ├─ 轉換為 DataFrame
│   ├─ 計算 MA、EMA、RSI、KD、MACD、BBands、ATR、OBV、ADX、VWAP
│   └─ 處理 NaN 值
├─ 驗證計算結果
│   ├─ 範圍驗證
│   ├─ 合理性驗證
│   └─ 完整性驗證
├─ 組裝 JSONB 資料
├─ 批次 UPSERT（MyBatis）
│   └─ INSERT ... ON CONFLICT DO UPDATE
├─ 回寫 stock_prices（ma5, ma20, volume_ma5）
└─ 記錄處理結果（成功/失敗）
  ↓
批次 2: 股票 51-100
├─ （同上）
└─ ...
  ↓
...
  ↓
批次 36: 股票 1751-1800
├─ （同上）
└─ 完成
  ↓
彙總統計
├─ 成功筆數: 1785
├─ 失敗筆數: 15
├─ 平均處理時間: 245ms/股
└─ 記錄到 indicator_calculation_jobs 表
```

**批次失敗處理**:
```
IF 批次計算失敗:
  ├─ 記錄失敗的股票清單
  ├─ 繼續處理下一批次（不中斷整體流程）
  ├─ Job 結束後統計失敗筆數
  └─ 失敗批次可單獨重跑
```

---

### 7.6 快取策略

#### 7.6.1 快取鍵設計

**單日指標資料**:
```
Key: tech:indicators:{stock_id}:{calculation_date}
範例: tech:indicators:2330:2024-12-24
Value: TechnicalIndicator JSON（含所有 8 類指標）
TTL: 6 小時

結構:
{
  "stock_id": "2330",
  "calculation_date": "2024-12-24",
  "trend": {"ma5": 580.5, "ma20": 570.8, ...},
  "momentum": {"rsi_14": 65.5, "stoch_k": 75.2, ...},
  "volatility": {"bbands_upper": 590.0, ...},
  "volume": {"obv": 125000000000, ...}
}
```

**單一指標單日資料**:
```
Key: tech:indicator:{stock_id}:{indicator_name}:{calculation_date}
範例: tech:indicator:2330:RSI:2024-12-24
Value: {"rsi_14": 65.5}
TTL: 6 小時
```

**範圍查詢**:
```
Key: tech:indicators:range:{stock_id}:{start_date}:{end_date}
範例: tech:indicators:range:2330:2024-12-01:2024-12-24
Value: List<TechnicalIndicator> JSON
TTL: 12 小時
```

**指標配置**:
```
Key: tech:config:indicators
Value: List<IndicatorDefinition> JSON（71 個指標定義）
TTL: 永久（或 7 天）
```

**熱門股票清單**:
```
Key: tech:hot:stocks
Value: ["2330", "2317", "2454", ...]（市值前 50 檔）
TTL: 24 小時
```

---

#### 7.6.2 TTL 設定策略

| 資料類型 | TTL | 理由 |
|---------|-----|------|
| 熱門股票指標（市值前 50） | 1 小時 | Job 完成後主動更新 |
| 一般股票指標（當日） | 6 小時 | 盤後可能有修正 |
| 歷史指標（範圍查詢） | 12 小時 | 不常變動 |
| 指標定義配置 | 永久 | 配置變更時主動更新 |
| 熱門股票清單 | 24 小時 | 每日更新一次 |

---

#### 7.6.3 快取更新策略

**Cache-Aside 模式**:
```
讀取流程:
1. 查詢 Redis 快取
   ├─ 命中 → 返回快取資料
   └─ 未命中 → 查詢 PostgreSQL
       ├─ 查詢成功 → 寫入快取 → 返回資料
       └─ 查詢失敗 → 返回錯誤

寫入流程（指標計算完成後）:
1. 寫入 PostgreSQL 資料庫（MyBatis UPSERT）
2. 若為熱門股票 → 主動更新快取
3. 清除舊快取鍵（若日期範圍變更）
```

**快取預熱**:
```
系統啟動時:
1. 載入指標定義配置
   Redis.set("tech:config:indicators", definitions, TTL=永久)

2. 載入熱門股票清單（市值前 50）
   Redis.set("tech:hot:stocks", hot_stocks, TTL=24h)

3. 預載熱門股票最新指標
   FOR EACH hot_stock:
     latest_indicators = 查詢最新指標
     Redis.set("tech:indicators:{stock_id}:{date}", indicators, TTL=1h)
   END FOR

Job 完成後（JOB-M07-001）:
1. 更新熱門股票快取（市值前 50）
2. 清除過期日期的快取
```

**快取失效觸發時機**:
```
指標計算 Job 完成 →
  ├─ 清除 tech:indicators:{stock_id}:* 相關快取（受影響股票）
  ├─ 更新熱門股票快取（主動更新）
  └─ 清除範圍查詢快取（含受影響日期的範圍）

指標定義更新 →
  ├─ 清除 tech:config:indicators
  └─ 重新載入指標定義
```

**快取穿透防護**:
```
使用布隆過濾器（Bloom Filter）:
1. 系統啟動時，將所有活躍股票 ID 加入布隆過濾器
2. 查詢前先檢查布隆過濾器
   ├─ 不存在 → 直接返回 404，不查詢資料庫
   └─ 可能存在 → 繼續查詢流程

空值快取:
IF (查詢資料庫後發現資料不存在) THEN
  快取空值: Redis.set(key, "NULL", TTL=5分鐘)
  避免重複查詢資料庫
END IF
```

**快取雪崩防護**:
```
TTL 加入隨機值:
base_ttl = 6 小時
random_offset = RANDOM(-36分鐘, +36分鐘)
actual_ttl = base_ttl + random_offset

範例:
快取 1: TTL = 5.4 小時
快取 2: TTL = 6.3 小時
快取 3: TTL = 6.6 小時

避免大量快取同時失效
```

---


---

## 8. 整合點

### 8.1 對外部系統的依賴

| 外部系統 | 用途 | 協議 | 認證方式 | 限制 | 備援方案 |
|---------|------|------|---------|------|---------|
| M06 資料管理模組 | 股價歷史資料 | REST API | Internal | 無 | - |
| pandas-ta (Python) | 技術指標計算引擎 | Python Library / REST API | 無 | 計算效能 | 自行實作 Java 版本 |
| Redis | 快取 | Redis Protocol | 無 | 記憶體容量 | - |
| PostgreSQL | 資料儲存 | JDBC | 帳密 | 連線數 | - |

**pandas-ta 整合方式**:

**方案 1: JPype（推薦）**
- 使用 JPype 從 Java 呼叫 Python pandas-ta
- 優點：直接使用原生 pandas-ta，計算準確
- 缺點：需要安裝 Python 環境

**方案 2: REST API 包裝**
- 建立獨立的 Python 微服務，提供 REST API
- 優點：解耦合，易於擴展
- 缺點：增加網路延遲

**方案 3: Java 原生實作**
- 使用 ta4j 或自行實作技術指標
- 優點：無外部依賴
- 缺點：開發成本高，需驗證準確性

---

### 8.2 對內部模組的提供

| 下游模組 | 使用的 API | 資料類型 | 呼叫頻率 | 快取策略 |
|---------|-----------|---------|---------|---------|
| M13 信號判斷引擎 | GET /stocks/{id}/indicators | 技術指標 | 信號判斷時 | 6 小時 TTL |
| M14 選股引擎 | GET /indicators/latest | 最新指標 | 選股執行時 | 1 小時 TTL |
| M16 回測系統 | GET /stocks/{id}/indicators | 歷史指標 | 回測執行時 | 12 小時 TTL |
| M17 風險管理 | GET /stocks/{id}/indicators/ATR | ATR 波動率 | 風險計算時 | 6 小時 TTL |
| M10 型態辨識 | GET /stocks/{id}/indicators | 價格與指標 | 型態分析時 | 6 小時 TTL |

---

### 8.3 事件發布

**發布的事件**（遵守總綱事件規範）:

| 事件名稱 | 觸發條件 | 事件內容 | 訂閱者 | 用途 |
|---------|---------|---------|-------|------|
| BasicIndicatorsCalculated | 基礎指標計算完成 | calculation_date, stock_count, indicators | M13, M14 | 觸發信號判斷、選股 |
| TechnicalSignalDetected | 偵測到技術信號 | signal_uuid, stock_id, signal_type, signal_name | M13 | 信號判斷引擎處理 |
| IndicatorCalculationFailed | 指標計算失敗 | stock_id, failed_indicators, error_message | M15 監控系統 | 觸發告警 |

**事件格式範例**:

**BasicIndicatorsCalculated**:
```json
{
  "event_id": "evt_abc123",
  "event_type": "BasicIndicatorsCalculated",
  "event_time": "2024-12-24T16:00:00+08:00",
  "source": "M07",
  "version": "1.0",
  "data": {
    "calculation_date": "2024-12-24",
    "total_stocks": 1800,
    "success_count": 1785,
    "failed_count": 15,
    "indicators": ["MA", "EMA", "MACD", "RSI", "KD", "BBANDS", "ATR", "OBV", "VOLUME_MA", "ADX", "VWAP"],
    "job_id": 12345
  }
}
```

**TechnicalSignalDetected**:
```json
{
  "event_id": "evt_def456",
  "event_type": "TechnicalSignalDetected",
  "event_time": "2024-12-24T16:35:00+08:00",
  "source": "M07",
  "version": "1.0",
  "data": {
    "signal_uuid": "550e8400-e29b-41d4-a716-446655440000",
    "stock_id": "2330",
    "stock_name": "台積電",
    "signal_type": "BUY",
    "signal_name": "MA_GOLDEN_CROSS",
    "signal_category": "TREND_CROSS",
    "trigger_price": 580.00,
    "confidence_score": 70,
    "evidence": {
      "indicator": "MA",
      "short_period": 5,
      "long_period": 20,
      "today_ma5": 580.50,
      "today_ma20": 570.80,
      "yesterday_ma5": 568.20,
      "yesterday_ma20": 570.50
    }
  }
}
```

---

### 8.4 對上游模組的依賴

**M06 資料管理模組**:

**訂閱的事件**:
| 事件名稱 | 用途 | 處理方式 |
|---------|------|---------|
| StockPriceUpdated | 觸發指標計算 | 延遲 30 分鐘後觸發 JOB-M07-001 |
| StockListUpdated | 更新股票清單 | 重新載入活躍股票清單 |

**呼叫的 API**:
| API | 用途 | 快取 |
|-----|------|------|
| GET /stocks/{id}/prices | 查詢歷史股價 | 6 小時 TTL |
| GET /stocks | 查詢股票清單 | 24 小時 TTL |
| GET /trading-calendar/{year} | 查詢交易日曆 | 7 天 TTL |

---


---

## 📚 相關文檔

- [M07 功能需求](../specs/functional/M07-技術分析功能需求.md)
- [M07 API規格](../specs/technical/api/M07-API規格.md)
- [M07 資料庫設計](./M07-資料庫設計.md)

---

**文件維護者**: 系統架構師  
**最後更新**: 2025-12-31
