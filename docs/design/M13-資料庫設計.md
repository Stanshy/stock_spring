# M13-信號判斷引擎 資料庫設計

> **文件編號**: DB-M13
> **模組名稱**: 信號判斷引擎 (Signal Judgment Engine)
> **版本**: v1.0
> **最後更新**: 2026-01-14
> **狀態**: Draft

---

## 1. 設計概述

### 1.1 設計目標

- 高效儲存來自 6 個上游模組的原始信號
- 支援信號去重、合併、評分的完整處理流程
- 提供統一信號的多維度查詢能力
- 追蹤信號消費狀態與處理歷程
- 支援訂閱機制配置

### 1.2 持久層策略

| 操作類型 | 技術選擇 | 說明 |
|---------|---------|------|
| 信號實體 CRUD | JPA | 標準增刪改查 |
| 複雜信號聚合查詢 | MyBatis | 多表關聯、統計查詢 |
| 歷史績效統計 | MyBatis | 複雜跨表聚合 |
| 快取 | Redis | 統一信號快取、排行榜 |

### 1.3 表格總覽

| # | 表格名稱 | 說明 | 預估資料量 |
|---|---------|------|-----------|
| 1 | raw_signals | 原始信號（收集） | 1000 萬筆/年 |
| 2 | unified_signals | 統一信號（合併後） | 200 萬筆/年 |
| 3 | signal_contributors | 統一信號組成明細 | 800 萬筆/年 |
| 4 | signal_dedup_log | 去重處理記錄 | 500 萬筆/年 |
| 5 | signal_scoring_details | 評分計算明細 | 200 萬筆/年 |
| 6 | signal_consumption_log | 信號消費記錄 | 500 萬筆/年 |
| 7 | signal_subscriptions | 信號訂閱配置 | 1000 筆 |
| 8 | daily_recommendations | 每日推薦清單 | 10 萬筆/年 |
| 9 | signal_semantic_groups | 語義信號群組定義 | 100 筆 |
| 10 | signal_processing_batch | 批次處理記錄 | 1000 筆/年 |

---

## 2. 表格詳細設計

### 2.1 raw_signals（原始信號表）

儲存從上游模組收集的原始信號。

```sql
CREATE TABLE raw_signals (
    id                  BIGSERIAL PRIMARY KEY,
    raw_signal_id       VARCHAR(50) NOT NULL UNIQUE,
    source_signal_id    VARCHAR(50) NOT NULL,
    source_module       VARCHAR(10) NOT NULL,
    signal_type         VARCHAR(20) NOT NULL,
    signal_code         VARCHAR(50) NOT NULL,
    signal_name         VARCHAR(100) NOT NULL,
    stock_id            VARCHAR(10) NOT NULL,
    signal_date         DATE NOT NULL,
    signal_direction    VARCHAR(10) NOT NULL,
    source_confidence   DECIMAL(5,4),
    signal_metadata     JSONB,
    dedup_status        VARCHAR(20) DEFAULT 'PENDING',
    unified_signal_id   VARCHAR(50),
    batch_id            VARCHAR(50),
    collected_at        TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_source_module CHECK (source_module IN ('M07', 'M08', 'M09', 'M10', 'M11', 'M12')),
    CONSTRAINT chk_signal_type CHECK (signal_type IN ('TECHNICAL', 'FUNDAMENTAL', 'CHIP', 'PATTERN', 'STRATEGY', 'INDUSTRY')),
    CONSTRAINT chk_direction CHECK (signal_direction IN ('BUY', 'SELL', 'HOLD')),
    CONSTRAINT chk_dedup_status CHECK (dedup_status IN ('PENDING', 'KEPT', 'MERGED', 'REMOVED'))
);

-- 索引
CREATE INDEX idx_raw_signals_stock_date ON raw_signals(stock_id, signal_date);
CREATE INDEX idx_raw_signals_source_module ON raw_signals(source_module, signal_date);
CREATE INDEX idx_raw_signals_signal_code ON raw_signals(signal_code);
CREATE INDEX idx_raw_signals_dedup_status ON raw_signals(dedup_status);
CREATE INDEX idx_raw_signals_unified ON raw_signals(unified_signal_id);
CREATE INDEX idx_raw_signals_batch ON raw_signals(batch_id);
CREATE INDEX idx_raw_signals_collected_at ON raw_signals(collected_at);

COMMENT ON TABLE raw_signals IS '原始信號收集表';
COMMENT ON COLUMN raw_signals.source_signal_id IS '上游模組原始信號 ID';
COMMENT ON COLUMN raw_signals.dedup_status IS '去重狀態：PENDING 待處理, KEPT 保留, MERGED 已合併, REMOVED 已移除';
```

**JPA Entity**:
```java
@Entity
@Table(name = "raw_signals")
public class RawSignal {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "raw_signal_id", nullable = false, unique = true)
    private String rawSignalId;

    @Column(name = "source_signal_id", nullable = false)
    private String sourceSignalId;

    @Enumerated(EnumType.STRING)
    @Column(name = "source_module", nullable = false)
    private SourceModule sourceModule;

    @Enumerated(EnumType.STRING)
    @Column(name = "signal_type", nullable = false)
    private SignalType signalType;

    @Column(name = "signal_code", nullable = false)
    private String signalCode;

    @Column(name = "signal_name", nullable = false)
    private String signalName;

    @Column(name = "stock_id", nullable = false)
    private String stockId;

    @Column(name = "signal_date", nullable = false)
    private LocalDate signalDate;

    @Enumerated(EnumType.STRING)
    @Column(name = "signal_direction", nullable = false)
    private SignalDirection signalDirection;

    @Column(name = "source_confidence")
    private BigDecimal sourceConfidence;

    @Type(JsonBinaryType.class)
    @Column(name = "signal_metadata", columnDefinition = "jsonb")
    private Map<String, Object> signalMetadata;

    @Enumerated(EnumType.STRING)
    @Column(name = "dedup_status")
    private DedupStatus dedupStatus = DedupStatus.PENDING;

    @Column(name = "unified_signal_id")
    private String unifiedSignalId;

    @Column(name = "batch_id")
    private String batchId;

    @Column(name = "collected_at", nullable = false)
    private OffsetDateTime collectedAt;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;
}
```

---

### 2.2 unified_signals（統一信號表）

儲存合併、評分後的統一信號。

```sql
CREATE TABLE unified_signals (
    id                      BIGSERIAL PRIMARY KEY,
    signal_id               VARCHAR(50) NOT NULL UNIQUE,
    stock_id                VARCHAR(10) NOT NULL,
    stock_name              VARCHAR(50),
    sector_code             VARCHAR(20),
    trade_date              DATE NOT NULL,
    unified_direction       VARCHAR(10) NOT NULL,
    direction_strength      VARCHAR(20) NOT NULL,
    unified_score           DECIMAL(5,2) NOT NULL,
    grade                   VARCHAR(5) NOT NULL,
    dimension_coverage      INTEGER NOT NULL,
    unified_confidence      DECIMAL(5,4),
    signal_types            VARCHAR(200),
    validity_period         VARCHAR(20),
    key_factors             TEXT,
    source_modules          VARCHAR(50),
    contributing_count      INTEGER DEFAULT 0,
    is_consumed             BOOLEAN DEFAULT FALSE,
    batch_id                VARCHAR(50),
    created_at              TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_unified_direction CHECK (unified_direction IN ('BUY', 'SELL', 'HOLD')),
    CONSTRAINT chk_direction_strength CHECK (direction_strength IN ('STRONG', 'MODERATE', 'WEAK', 'CONFLICT')),
    CONSTRAINT chk_grade CHECK (grade IN ('A+', 'A', 'B+', 'B', 'C', 'D')),
    CONSTRAINT chk_validity_period CHECK (validity_period IN ('INTRADAY', 'SHORT_TERM', 'MEDIUM_TERM', 'LONG_TERM'))
);

-- 索引
CREATE INDEX idx_unified_signals_stock_date ON unified_signals(stock_id, trade_date);
CREATE INDEX idx_unified_signals_date_score ON unified_signals(trade_date, unified_score DESC);
CREATE INDEX idx_unified_signals_direction ON unified_signals(unified_direction, trade_date);
CREATE INDEX idx_unified_signals_grade ON unified_signals(grade, trade_date);
CREATE INDEX idx_unified_signals_consumed ON unified_signals(is_consumed, trade_date);
CREATE INDEX idx_unified_signals_sector ON unified_signals(sector_code, trade_date);
CREATE INDEX idx_unified_signals_batch ON unified_signals(batch_id);

-- 複合索引：每日排行榜查詢
CREATE INDEX idx_unified_signals_daily_rank ON unified_signals(trade_date, unified_direction, unified_score DESC);

COMMENT ON TABLE unified_signals IS '統一信號表';
COMMENT ON COLUMN unified_signals.direction_strength IS '方向強度：STRONG 強, MODERATE 中, WEAK 弱, CONFLICT 衝突';
COMMENT ON COLUMN unified_signals.dimension_coverage IS '覆蓋的分析維度數量（1-6）';
COMMENT ON COLUMN unified_signals.signal_types IS '信號類型標籤，逗號分隔';
```

**JPA Entity**:
```java
@Entity
@Table(name = "unified_signals")
public class UnifiedSignal {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "signal_id", nullable = false, unique = true)
    private String signalId;

    @Column(name = "stock_id", nullable = false)
    private String stockId;

    @Column(name = "stock_name")
    private String stockName;

    @Column(name = "sector_code")
    private String sectorCode;

    @Column(name = "trade_date", nullable = false)
    private LocalDate tradeDate;

    @Enumerated(EnumType.STRING)
    @Column(name = "unified_direction", nullable = false)
    private SignalDirection unifiedDirection;

    @Enumerated(EnumType.STRING)
    @Column(name = "direction_strength", nullable = false)
    private DirectionStrength directionStrength;

    @Column(name = "unified_score", nullable = false)
    private BigDecimal unifiedScore;

    @Enumerated(EnumType.STRING)
    @Column(name = "grade", nullable = false)
    private SignalGrade grade;

    @Column(name = "dimension_coverage", nullable = false)
    private Integer dimensionCoverage;

    @Column(name = "unified_confidence")
    private BigDecimal unifiedConfidence;

    @Column(name = "signal_types")
    private String signalTypes;

    @Enumerated(EnumType.STRING)
    @Column(name = "validity_period")
    private ValidityPeriod validityPeriod;

    @Column(name = "key_factors")
    private String keyFactors;

    @Column(name = "source_modules")
    private String sourceModules;

    @Column(name = "contributing_count")
    private Integer contributingCount;

    @Column(name = "is_consumed")
    private Boolean isConsumed = false;

    @Column(name = "batch_id")
    private String batchId;

    @OneToMany(mappedBy = "unifiedSignal", cascade = CascadeType.ALL)
    private List<SignalContributor> contributors;

    @OneToOne(mappedBy = "unifiedSignal", cascade = CascadeType.ALL)
    private SignalScoringDetail scoringDetail;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;

    @Column(name = "updated_at")
    private OffsetDateTime updatedAt;
}
```

---

### 2.3 signal_contributors（信號組成明細表）

記錄統一信號由哪些原始信號組成。

```sql
CREATE TABLE signal_contributors (
    id                  BIGSERIAL PRIMARY KEY,
    unified_signal_id   VARCHAR(50) NOT NULL,
    raw_signal_id       VARCHAR(50) NOT NULL,
    source_module       VARCHAR(10) NOT NULL,
    signal_type         VARCHAR(20) NOT NULL,
    signal_code         VARCHAR(50) NOT NULL,
    signal_name         VARCHAR(100) NOT NULL,
    signal_direction    VARCHAR(10) NOT NULL,
    source_confidence   DECIMAL(5,4),
    weight              DECIMAL(5,4),
    weighted_confidence DECIMAL(5,4),
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_contributor_unified FOREIGN KEY (unified_signal_id)
        REFERENCES unified_signals(signal_id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_contributors_unified ON signal_contributors(unified_signal_id);
CREATE INDEX idx_contributors_raw ON signal_contributors(raw_signal_id);
CREATE INDEX idx_contributors_source ON signal_contributors(source_module);

COMMENT ON TABLE signal_contributors IS '統一信號組成明細表';
COMMENT ON COLUMN signal_contributors.weight IS '該來源模組的權重';
COMMENT ON COLUMN signal_contributors.weighted_confidence IS '加權後的信心度';
```

**JPA Entity**:
```java
@Entity
@Table(name = "signal_contributors")
public class SignalContributor {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "unified_signal_id", referencedColumnName = "signal_id")
    private UnifiedSignal unifiedSignal;

    @Column(name = "raw_signal_id", nullable = false)
    private String rawSignalId;

    @Enumerated(EnumType.STRING)
    @Column(name = "source_module", nullable = false)
    private SourceModule sourceModule;

    @Enumerated(EnumType.STRING)
    @Column(name = "signal_type", nullable = false)
    private SignalType signalType;

    @Column(name = "signal_code", nullable = false)
    private String signalCode;

    @Column(name = "signal_name", nullable = false)
    private String signalName;

    @Enumerated(EnumType.STRING)
    @Column(name = "signal_direction", nullable = false)
    private SignalDirection signalDirection;

    @Column(name = "source_confidence")
    private BigDecimal sourceConfidence;

    @Column(name = "weight")
    private BigDecimal weight;

    @Column(name = "weighted_confidence")
    private BigDecimal weightedConfidence;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;
}
```

---

### 2.4 signal_dedup_log（去重處理記錄表）

記錄信號去重的處理過程。

```sql
CREATE TABLE signal_dedup_log (
    id                  BIGSERIAL PRIMARY KEY,
    batch_id            VARCHAR(50) NOT NULL,
    trade_date          DATE NOT NULL,
    stock_id            VARCHAR(10) NOT NULL,
    dedup_type          VARCHAR(30) NOT NULL,
    original_signal_ids TEXT NOT NULL,
    result_action       VARCHAR(20) NOT NULL,
    kept_signal_id      VARCHAR(50),
    removed_signal_ids  TEXT,
    merge_reason        VARCHAR(200),
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_dedup_type CHECK (dedup_type IN ('EXACT_DUPLICATE', 'SEMANTIC_DUPLICATE', 'TEMPORAL_DUPLICATE', 'SOURCE_DUPLICATE')),
    CONSTRAINT chk_result_action CHECK (result_action IN ('KEEP_ONE', 'MERGE', 'REMOVE_ALL'))
);

-- 索引
CREATE INDEX idx_dedup_log_batch ON signal_dedup_log(batch_id);
CREATE INDEX idx_dedup_log_stock_date ON signal_dedup_log(stock_id, trade_date);
CREATE INDEX idx_dedup_log_type ON signal_dedup_log(dedup_type);

COMMENT ON TABLE signal_dedup_log IS '信號去重處理記錄表';
COMMENT ON COLUMN signal_dedup_log.dedup_type IS '去重類型：完全重複/語義重複/時間重複/來源重複';
COMMENT ON COLUMN signal_dedup_log.original_signal_ids IS '參與去重的原始信號 ID 列表，逗號分隔';
```

**JPA Entity**:
```java
@Entity
@Table(name = "signal_dedup_log")
public class SignalDedupLog {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "batch_id", nullable = false)
    private String batchId;

    @Column(name = "trade_date", nullable = false)
    private LocalDate tradeDate;

    @Column(name = "stock_id", nullable = false)
    private String stockId;

    @Enumerated(EnumType.STRING)
    @Column(name = "dedup_type", nullable = false)
    private DedupType dedupType;

    @Column(name = "original_signal_ids", nullable = false, columnDefinition = "TEXT")
    private String originalSignalIds;

    @Enumerated(EnumType.STRING)
    @Column(name = "result_action", nullable = false)
    private ResultAction resultAction;

    @Column(name = "kept_signal_id")
    private String keptSignalId;

    @Column(name = "removed_signal_ids", columnDefinition = "TEXT")
    private String removedSignalIds;

    @Column(name = "merge_reason")
    private String mergeReason;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;
}
```

---

### 2.5 signal_scoring_details（評分計算明細表）

記錄統一信號的評分計算過程。

```sql
CREATE TABLE signal_scoring_details (
    id                              BIGSERIAL PRIMARY KEY,
    unified_signal_id               VARCHAR(50) NOT NULL UNIQUE,

    -- 信號強度維度
    strength_score                  DECIMAL(5,2) NOT NULL,
    strength_weight                 DECIMAL(4,3) DEFAULT 0.30,
    strength_weighted               DECIMAL(5,2),
    direction_score                 DECIMAL(5,2),
    confidence_score                DECIMAL(5,2),

    -- 維度覆蓋維度
    coverage_score                  DECIMAL(5,2) NOT NULL,
    coverage_weight                 DECIMAL(4,3) DEFAULT 0.25,
    coverage_weighted               DECIMAL(5,2),
    coverage_base_score             DECIMAL(5,2),
    coverage_bonus                  DECIMAL(5,2),

    -- 歷史績效維度
    historical_score                DECIMAL(5,2) NOT NULL,
    historical_weight               DECIMAL(4,3) DEFAULT 0.20,
    historical_weighted             DECIMAL(5,2),
    historical_accuracy             DECIMAL(5,4),
    historical_sample_count         INTEGER,

    -- 市場環境維度
    market_score                    DECIMAL(5,2) NOT NULL,
    market_weight                   DECIMAL(4,3) DEFAULT 0.15,
    market_weighted                 DECIMAL(5,2),
    market_trend                    VARCHAR(20),
    sector_strength                 VARCHAR(20),

    -- 時效性維度
    freshness_score                 DECIMAL(5,2) NOT NULL,
    freshness_weight                DECIMAL(4,3) DEFAULT 0.10,
    freshness_weighted              DECIMAL(5,2),
    signal_age_hours                INTEGER,

    -- 總分與調整
    base_total_score                DECIMAL(5,2) NOT NULL,
    adjustment_factors              JSONB,
    final_score                     DECIMAL(5,2) NOT NULL,
    grade                           VARCHAR(5) NOT NULL,

    created_at                      TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_scoring_unified FOREIGN KEY (unified_signal_id)
        REFERENCES unified_signals(signal_id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_scoring_unified ON signal_scoring_details(unified_signal_id);
CREATE INDEX idx_scoring_final ON signal_scoring_details(final_score DESC);

COMMENT ON TABLE signal_scoring_details IS '信號評分計算明細表';
COMMENT ON COLUMN signal_scoring_details.adjustment_factors IS '評分調整因素（JSON 格式）';
```

**JPA Entity**:
```java
@Entity
@Table(name = "signal_scoring_details")
public class SignalScoringDetail {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @OneToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "unified_signal_id", referencedColumnName = "signal_id")
    private UnifiedSignal unifiedSignal;

    // 信號強度維度
    @Column(name = "strength_score", nullable = false)
    private BigDecimal strengthScore;

    @Column(name = "strength_weight")
    private BigDecimal strengthWeight;

    @Column(name = "strength_weighted")
    private BigDecimal strengthWeighted;

    @Column(name = "direction_score")
    private BigDecimal directionScore;

    @Column(name = "confidence_score")
    private BigDecimal confidenceScore;

    // 維度覆蓋維度
    @Column(name = "coverage_score", nullable = false)
    private BigDecimal coverageScore;

    @Column(name = "coverage_weight")
    private BigDecimal coverageWeight;

    @Column(name = "coverage_weighted")
    private BigDecimal coverageWeighted;

    @Column(name = "coverage_base_score")
    private BigDecimal coverageBaseScore;

    @Column(name = "coverage_bonus")
    private BigDecimal coverageBonus;

    // 歷史績效維度
    @Column(name = "historical_score", nullable = false)
    private BigDecimal historicalScore;

    @Column(name = "historical_weight")
    private BigDecimal historicalWeight;

    @Column(name = "historical_weighted")
    private BigDecimal historicalWeighted;

    @Column(name = "historical_accuracy")
    private BigDecimal historicalAccuracy;

    @Column(name = "historical_sample_count")
    private Integer historicalSampleCount;

    // 市場環境維度
    @Column(name = "market_score", nullable = false)
    private BigDecimal marketScore;

    @Column(name = "market_weight")
    private BigDecimal marketWeight;

    @Column(name = "market_weighted")
    private BigDecimal marketWeighted;

    @Column(name = "market_trend")
    private String marketTrend;

    @Column(name = "sector_strength")
    private String sectorStrength;

    // 時效性維度
    @Column(name = "freshness_score", nullable = false)
    private BigDecimal freshnessScore;

    @Column(name = "freshness_weight")
    private BigDecimal freshnessWeight;

    @Column(name = "freshness_weighted")
    private BigDecimal freshnessWeighted;

    @Column(name = "signal_age_hours")
    private Integer signalAgeHours;

    // 總分
    @Column(name = "base_total_score", nullable = false)
    private BigDecimal baseTotalScore;

    @Type(JsonBinaryType.class)
    @Column(name = "adjustment_factors", columnDefinition = "jsonb")
    private Map<String, Object> adjustmentFactors;

    @Column(name = "final_score", nullable = false)
    private BigDecimal finalScore;

    @Enumerated(EnumType.STRING)
    @Column(name = "grade", nullable = false)
    private SignalGrade grade;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;
}
```

---

### 2.6 signal_consumption_log（信號消費記錄表）

記錄信號被下游模組消費的歷史。

```sql
CREATE TABLE signal_consumption_log (
    id                  BIGSERIAL PRIMARY KEY,
    unified_signal_id   VARCHAR(50) NOT NULL,
    consumer_module     VARCHAR(10) NOT NULL,
    consumer_action     VARCHAR(50),
    notes               VARCHAR(200),
    consumed_at         TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_consumer_module CHECK (consumer_module IN ('M14', 'M15', 'M16', 'M17', 'M18')),
    CONSTRAINT fk_consumption_unified FOREIGN KEY (unified_signal_id)
        REFERENCES unified_signals(signal_id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_consumption_unified ON signal_consumption_log(unified_signal_id);
CREATE INDEX idx_consumption_consumer ON signal_consumption_log(consumer_module);
CREATE INDEX idx_consumption_time ON signal_consumption_log(consumed_at);

-- 唯一約束：同一信號同一模組只能消費一次
CREATE UNIQUE INDEX idx_consumption_unique ON signal_consumption_log(unified_signal_id, consumer_module);

COMMENT ON TABLE signal_consumption_log IS '信號消費記錄表';
COMMENT ON COLUMN signal_consumption_log.consumer_module IS '消費模組：M14 選股, M15 警報, M16 回測, M17 風險, M18 投組';
```

**JPA Entity**:
```java
@Entity
@Table(name = "signal_consumption_log")
public class SignalConsumptionLog {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "unified_signal_id", nullable = false)
    private String unifiedSignalId;

    @Enumerated(EnumType.STRING)
    @Column(name = "consumer_module", nullable = false)
    private ConsumerModule consumerModule;

    @Column(name = "consumer_action")
    private String consumerAction;

    @Column(name = "notes")
    private String notes;

    @Column(name = "consumed_at", nullable = false)
    private OffsetDateTime consumedAt;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;
}
```

---

### 2.7 signal_subscriptions（信號訂閱配置表）

儲存信號訂閱條件配置。

```sql
CREATE TABLE signal_subscriptions (
    id                      BIGSERIAL PRIMARY KEY,
    subscription_id         VARCHAR(50) NOT NULL UNIQUE,
    subscription_name       VARCHAR(100) NOT NULL,
    consumer_module         VARCHAR(10) NOT NULL,
    conditions              JSONB NOT NULL,
    notification_channel    VARCHAR(20) DEFAULT 'EVENT',
    webhook_url             VARCHAR(500),
    is_active               BOOLEAN DEFAULT TRUE,
    triggered_count         INTEGER DEFAULT 0,
    last_triggered_at       TIMESTAMP WITH TIME ZONE,
    created_at              TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_sub_consumer CHECK (consumer_module IN ('M14', 'M15', 'M16', 'M17', 'M18')),
    CONSTRAINT chk_notification_channel CHECK (notification_channel IN ('EVENT', 'WEBHOOK'))
);

-- 索引
CREATE INDEX idx_subscriptions_consumer ON signal_subscriptions(consumer_module);
CREATE INDEX idx_subscriptions_active ON signal_subscriptions(is_active);

COMMENT ON TABLE signal_subscriptions IS '信號訂閱配置表';
COMMENT ON COLUMN signal_subscriptions.conditions IS '訂閱條件（JSON 格式）';
```

**JPA Entity**:
```java
@Entity
@Table(name = "signal_subscriptions")
public class SignalSubscription {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "subscription_id", nullable = false, unique = true)
    private String subscriptionId;

    @Column(name = "subscription_name", nullable = false)
    private String subscriptionName;

    @Enumerated(EnumType.STRING)
    @Column(name = "consumer_module", nullable = false)
    private ConsumerModule consumerModule;

    @Type(JsonBinaryType.class)
    @Column(name = "conditions", nullable = false, columnDefinition = "jsonb")
    private SubscriptionConditions conditions;

    @Enumerated(EnumType.STRING)
    @Column(name = "notification_channel")
    private NotificationChannel notificationChannel;

    @Column(name = "webhook_url")
    private String webhookUrl;

    @Column(name = "is_active")
    private Boolean isActive = true;

    @Column(name = "triggered_count")
    private Integer triggeredCount = 0;

    @Column(name = "last_triggered_at")
    private OffsetDateTime lastTriggeredAt;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;

    @Column(name = "updated_at")
    private OffsetDateTime updatedAt;
}
```

---

### 2.8 daily_recommendations（每日推薦清單表）

儲存每日產生的推薦清單。

```sql
CREATE TABLE daily_recommendations (
    id                  BIGSERIAL PRIMARY KEY,
    trade_date          DATE NOT NULL,
    direction           VARCHAR(10) NOT NULL,
    rank                INTEGER NOT NULL,
    unified_signal_id   VARCHAR(50) NOT NULL,
    stock_id            VARCHAR(10) NOT NULL,
    stock_name          VARCHAR(50),
    sector_name         VARCHAR(50),
    unified_score       DECIMAL(5,2) NOT NULL,
    grade               VARCHAR(5) NOT NULL,
    direction_strength  VARCHAR(20) NOT NULL,
    dimension_coverage  INTEGER NOT NULL,
    key_factors         TEXT,
    signal_types        VARCHAR(200),
    generated_at        TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_rec_direction CHECK (direction IN ('BUY', 'SELL')),
    CONSTRAINT fk_rec_unified FOREIGN KEY (unified_signal_id)
        REFERENCES unified_signals(signal_id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_recommendations_date_direction ON daily_recommendations(trade_date, direction);
CREATE INDEX idx_recommendations_rank ON daily_recommendations(trade_date, direction, rank);
CREATE UNIQUE INDEX idx_recommendations_unique ON daily_recommendations(trade_date, direction, rank);

COMMENT ON TABLE daily_recommendations IS '每日推薦清單表';
COMMENT ON COLUMN daily_recommendations.rank IS '當日該方向的排名（1 為最佳）';
```

**JPA Entity**:
```java
@Entity
@Table(name = "daily_recommendations")
public class DailyRecommendation {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "trade_date", nullable = false)
    private LocalDate tradeDate;

    @Enumerated(EnumType.STRING)
    @Column(name = "direction", nullable = false)
    private SignalDirection direction;

    @Column(name = "rank", nullable = false)
    private Integer rank;

    @Column(name = "unified_signal_id", nullable = false)
    private String unifiedSignalId;

    @Column(name = "stock_id", nullable = false)
    private String stockId;

    @Column(name = "stock_name")
    private String stockName;

    @Column(name = "sector_name")
    private String sectorName;

    @Column(name = "unified_score", nullable = false)
    private BigDecimal unifiedScore;

    @Enumerated(EnumType.STRING)
    @Column(name = "grade", nullable = false)
    private SignalGrade grade;

    @Enumerated(EnumType.STRING)
    @Column(name = "direction_strength", nullable = false)
    private DirectionStrength directionStrength;

    @Column(name = "dimension_coverage", nullable = false)
    private Integer dimensionCoverage;

    @Column(name = "key_factors")
    private String keyFactors;

    @Column(name = "signal_types")
    private String signalTypes;

    @Column(name = "generated_at", nullable = false)
    private OffsetDateTime generatedAt;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;
}
```

---

### 2.9 signal_semantic_groups（語義信號群組定義表）

定義語義相關的信號群組，用於去重。

```sql
CREATE TABLE signal_semantic_groups (
    id                  BIGSERIAL PRIMARY KEY,
    group_code          VARCHAR(50) NOT NULL UNIQUE,
    group_name          VARCHAR(100) NOT NULL,
    signal_codes        TEXT NOT NULL,
    merge_strategy      VARCHAR(20) DEFAULT 'HIGHEST_CONFIDENCE',
    description         VARCHAR(500),
    is_active           BOOLEAN DEFAULT TRUE,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_merge_strategy CHECK (merge_strategy IN ('HIGHEST_CONFIDENCE', 'AVERAGE', 'LATEST'))
);

-- 初始資料
INSERT INTO signal_semantic_groups (group_code, group_name, signal_codes, description) VALUES
('OVERSOLD_GROUP', '超賣指標群組', 'RSI_OVERSOLD,KD_OVERSOLD,WILLIAMS_OVERSOLD,STOCH_OVERSOLD', '多個超賣指標視為同一信號'),
('OVERBOUGHT_GROUP', '超買指標群組', 'RSI_OVERBOUGHT,KD_OVERBOUGHT,WILLIAMS_OVERBOUGHT,STOCH_OVERBOUGHT', '多個超買指標視為同一信號'),
('GOLDEN_CROSS_GROUP', '黃金交叉群組', 'MACD_GOLDEN_CROSS,MA_GOLDEN_CROSS,KD_GOLDEN_CROSS', '多種黃金交叉視為同一信號'),
('DEATH_CROSS_GROUP', '死亡交叉群組', 'MACD_DEATH_CROSS,MA_DEATH_CROSS,KD_DEATH_CROSS', '多種死亡交叉視為同一信號'),
('INSTITUTIONAL_BUY_GROUP', '法人買超群組', 'FOREIGN_BUY,TRUST_BUY,DEALER_BUY,TOTAL_INSTITUTIONAL_BUY', '多種法人買超視為同一信號'),
('INSTITUTIONAL_SELL_GROUP', '法人賣超群組', 'FOREIGN_SELL,TRUST_SELL,DEALER_SELL,TOTAL_INSTITUTIONAL_SELL', '多種法人賣超視為同一信號');

COMMENT ON TABLE signal_semantic_groups IS '語義信號群組定義表';
COMMENT ON COLUMN signal_semantic_groups.signal_codes IS '屬於該群組的信號代碼，逗號分隔';
COMMENT ON COLUMN signal_semantic_groups.merge_strategy IS '合併策略：取最高信心度/平均/最新';
```

**JPA Entity**:
```java
@Entity
@Table(name = "signal_semantic_groups")
public class SignalSemanticGroup {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "group_code", nullable = false, unique = true)
    private String groupCode;

    @Column(name = "group_name", nullable = false)
    private String groupName;

    @Column(name = "signal_codes", nullable = false, columnDefinition = "TEXT")
    private String signalCodes;

    @Enumerated(EnumType.STRING)
    @Column(name = "merge_strategy")
    private MergeStrategy mergeStrategy;

    @Column(name = "description")
    private String description;

    @Column(name = "is_active")
    private Boolean isActive = true;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;

    @Column(name = "updated_at")
    private OffsetDateTime updatedAt;

    public List<String> getSignalCodeList() {
        return Arrays.asList(signalCodes.split(","));
    }
}
```

---

### 2.10 signal_processing_batch（批次處理記錄表）

記錄信號處理批次的執行狀態。

```sql
CREATE TABLE signal_processing_batch (
    id                      BIGSERIAL PRIMARY KEY,
    batch_id                VARCHAR(50) NOT NULL UNIQUE,
    trade_date              DATE NOT NULL,
    batch_type              VARCHAR(30) NOT NULL,
    status                  VARCHAR(20) NOT NULL DEFAULT 'PENDING',

    -- 收集階段
    collection_started_at   TIMESTAMP WITH TIME ZONE,
    collection_completed_at TIMESTAMP WITH TIME ZONE,
    raw_signals_collected   INTEGER DEFAULT 0,

    -- 去重階段
    dedup_started_at        TIMESTAMP WITH TIME ZONE,
    dedup_completed_at      TIMESTAMP WITH TIME ZONE,
    signals_after_dedup     INTEGER DEFAULT 0,

    -- 合併階段
    merge_started_at        TIMESTAMP WITH TIME ZONE,
    merge_completed_at      TIMESTAMP WITH TIME ZONE,
    unified_signals_created INTEGER DEFAULT 0,

    -- 評分階段
    scoring_started_at      TIMESTAMP WITH TIME ZONE,
    scoring_completed_at    TIMESTAMP WITH TIME ZONE,

    -- 發布階段
    publish_started_at      TIMESTAMP WITH TIME ZONE,
    publish_completed_at    TIMESTAMP WITH TIME ZONE,

    -- 總結
    total_execution_time_ms BIGINT,
    error_message           TEXT,

    created_at              TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_batch_type CHECK (batch_type IN ('DAILY_FULL', 'INCREMENTAL', 'MANUAL')),
    CONSTRAINT chk_batch_status CHECK (status IN ('PENDING', 'COLLECTING', 'DEDUPLICATING', 'MERGING', 'SCORING', 'PUBLISHING', 'COMPLETED', 'FAILED'))
);

-- 索引
CREATE INDEX idx_batch_date ON signal_processing_batch(trade_date);
CREATE INDEX idx_batch_status ON signal_processing_batch(status);

COMMENT ON TABLE signal_processing_batch IS '信號處理批次記錄表';
COMMENT ON COLUMN signal_processing_batch.batch_type IS '批次類型：DAILY_FULL 每日全量, INCREMENTAL 增量, MANUAL 手動';
```

**JPA Entity**:
```java
@Entity
@Table(name = "signal_processing_batch")
public class SignalProcessingBatch {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "batch_id", nullable = false, unique = true)
    private String batchId;

    @Column(name = "trade_date", nullable = false)
    private LocalDate tradeDate;

    @Enumerated(EnumType.STRING)
    @Column(name = "batch_type", nullable = false)
    private BatchType batchType;

    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false)
    private BatchStatus status = BatchStatus.PENDING;

    // 收集階段
    @Column(name = "collection_started_at")
    private OffsetDateTime collectionStartedAt;

    @Column(name = "collection_completed_at")
    private OffsetDateTime collectionCompletedAt;

    @Column(name = "raw_signals_collected")
    private Integer rawSignalsCollected = 0;

    // 去重階段
    @Column(name = "dedup_started_at")
    private OffsetDateTime dedupStartedAt;

    @Column(name = "dedup_completed_at")
    private OffsetDateTime dedupCompletedAt;

    @Column(name = "signals_after_dedup")
    private Integer signalsAfterDedup = 0;

    // 合併階段
    @Column(name = "merge_started_at")
    private OffsetDateTime mergeStartedAt;

    @Column(name = "merge_completed_at")
    private OffsetDateTime mergeCompletedAt;

    @Column(name = "unified_signals_created")
    private Integer unifiedSignalsCreated = 0;

    // 評分階段
    @Column(name = "scoring_started_at")
    private OffsetDateTime scoringStartedAt;

    @Column(name = "scoring_completed_at")
    private OffsetDateTime scoringCompletedAt;

    // 發布階段
    @Column(name = "publish_started_at")
    private OffsetDateTime publishStartedAt;

    @Column(name = "publish_completed_at")
    private OffsetDateTime publishCompletedAt;

    // 總結
    @Column(name = "total_execution_time_ms")
    private Long totalExecutionTimeMs;

    @Column(name = "error_message", columnDefinition = "TEXT")
    private String errorMessage;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;

    @Column(name = "updated_at")
    private OffsetDateTime updatedAt;
}
```

---

## 3. 枚舉類型定義

```java
// 來源模組
public enum SourceModule {
    M07, M08, M09, M10, M11, M12
}

// 信號類型
public enum SignalType {
    TECHNICAL, FUNDAMENTAL, CHIP, PATTERN, STRATEGY, INDUSTRY
}

// 信號方向
public enum SignalDirection {
    BUY, SELL, HOLD
}

// 方向強度
public enum DirectionStrength {
    STRONG, MODERATE, WEAK, CONFLICT
}

// 信號評級
public enum SignalGrade {
    @JsonProperty("A+") A_PLUS,
    A,
    @JsonProperty("B+") B_PLUS,
    B, C, D
}

// 有效期間
public enum ValidityPeriod {
    INTRADAY, SHORT_TERM, MEDIUM_TERM, LONG_TERM
}

// 去重狀態
public enum DedupStatus {
    PENDING, KEPT, MERGED, REMOVED
}

// 去重類型
public enum DedupType {
    EXACT_DUPLICATE, SEMANTIC_DUPLICATE, TEMPORAL_DUPLICATE, SOURCE_DUPLICATE
}

// 去重結果動作
public enum ResultAction {
    KEEP_ONE, MERGE, REMOVE_ALL
}

// 消費模組
public enum ConsumerModule {
    M14, M15, M16, M17, M18
}

// 通知方式
public enum NotificationChannel {
    EVENT, WEBHOOK
}

// 合併策略
public enum MergeStrategy {
    HIGHEST_CONFIDENCE, AVERAGE, LATEST
}

// 批次類型
public enum BatchType {
    DAILY_FULL, INCREMENTAL, MANUAL
}

// 批次狀態
public enum BatchStatus {
    PENDING, COLLECTING, DEDUPLICATING, MERGING, SCORING, PUBLISHING, COMPLETED, FAILED
}
```

---

## 4. MyBatis Mapper 設計

### 4.1 UnifiedSignalMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chris.fin_shark.m13.mapper.UnifiedSignalMapper">

    <!-- 多維度查詢統一信號 -->
    <select id="findByConditions" resultType="UnifiedSignalDto">
        SELECT
            us.signal_id,
            us.stock_id,
            us.stock_name,
            us.sector_code,
            us.trade_date,
            us.unified_direction,
            us.direction_strength,
            us.unified_score,
            us.grade,
            us.dimension_coverage,
            us.unified_confidence,
            us.signal_types,
            us.key_factors,
            us.source_modules,
            us.is_consumed,
            us.created_at
        FROM unified_signals us
        WHERE 1=1
        <if test="tradeDate != null">
            AND us.trade_date = #{tradeDate}
        </if>
        <if test="startDate != null">
            AND us.trade_date >= #{startDate}
        </if>
        <if test="endDate != null">
            AND us.trade_date &lt;= #{endDate}
        </if>
        <if test="stockId != null">
            AND us.stock_id = #{stockId}
        </if>
        <if test="direction != null">
            AND us.unified_direction = #{direction}
        </if>
        <if test="grade != null">
            AND us.grade = #{grade}
        </if>
        <if test="minGrade != null">
            AND (
                CASE us.grade
                    WHEN 'A+' THEN 6
                    WHEN 'A' THEN 5
                    WHEN 'B+' THEN 4
                    WHEN 'B' THEN 3
                    WHEN 'C' THEN 2
                    WHEN 'D' THEN 1
                END
            ) >= (
                CASE #{minGrade}
                    WHEN 'A+' THEN 6
                    WHEN 'A' THEN 5
                    WHEN 'B+' THEN 4
                    WHEN 'B' THEN 3
                    WHEN 'C' THEN 2
                    WHEN 'D' THEN 1
                END
            )
        </if>
        <if test="minScore != null">
            AND us.unified_score >= #{minScore}
        </if>
        <if test="directionStrength != null">
            AND us.direction_strength = #{directionStrength}
        </if>
        <if test="isConsumed != null">
            AND us.is_consumed = #{isConsumed}
        </if>
        <if test="sectorCode != null">
            AND us.sector_code = #{sectorCode}
        </if>
        <if test="signalTypes != null and signalTypes.size() > 0">
            AND (
                <foreach collection="signalTypes" item="type" separator=" OR ">
                    us.signal_types LIKE CONCAT('%', #{type}, '%')
                </foreach>
            )
        </if>
        <if test="sourceModules != null and sourceModules.size() > 0">
            AND (
                <foreach collection="sourceModules" item="module" separator=" OR ">
                    us.source_modules LIKE CONCAT('%', #{module}, '%')
                </foreach>
            )
        </if>
        ORDER BY
        <choose>
            <when test="sort == 'score_asc'">us.unified_score ASC</when>
            <when test="sort == 'date_desc'">us.trade_date DESC, us.unified_score DESC</when>
            <when test="sort == 'date_asc'">us.trade_date ASC, us.unified_score DESC</when>
            <otherwise>us.unified_score DESC</otherwise>
        </choose>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 每日推薦排行榜 -->
    <select id="findDailyTopSignals" resultType="UnifiedSignalDto">
        SELECT
            us.signal_id,
            us.stock_id,
            us.stock_name,
            us.sector_code,
            us.trade_date,
            us.unified_direction,
            us.direction_strength,
            us.unified_score,
            us.grade,
            us.dimension_coverage,
            us.key_factors,
            us.signal_types
        FROM unified_signals us
        WHERE us.trade_date = #{tradeDate}
          AND us.unified_direction = #{direction}
          AND (
              CASE us.grade
                  WHEN 'A+' THEN 6 WHEN 'A' THEN 5 WHEN 'B+' THEN 4
                  WHEN 'B' THEN 3 WHEN 'C' THEN 2 WHEN 'D' THEN 1
              END
          ) >= (
              CASE #{minGrade}
                  WHEN 'A+' THEN 6 WHEN 'A' THEN 5 WHEN 'B+' THEN 4
                  WHEN 'B' THEN 3 WHEN 'C' THEN 2 WHEN 'D' THEN 1
              END
          )
        ORDER BY us.unified_score DESC
        LIMIT #{topN}
    </select>

    <!-- 統計概覽 -->
    <select id="getStatisticsOverview" resultType="SignalStatisticsDto">
        SELECT
            COUNT(*) as total_unified_signals,
            COUNT(CASE WHEN unified_direction = 'BUY' THEN 1 END) as buy_signals,
            COUNT(CASE WHEN unified_direction = 'SELL' THEN 1 END) as sell_signals,
            COUNT(CASE WHEN unified_direction = 'HOLD' THEN 1 END) as hold_signals,
            COUNT(CASE WHEN direction_strength = 'STRONG' THEN 1 END) as strong_count,
            COUNT(CASE WHEN direction_strength = 'MODERATE' THEN 1 END) as moderate_count,
            COUNT(CASE WHEN direction_strength = 'WEAK' THEN 1 END) as weak_count,
            COUNT(CASE WHEN direction_strength = 'CONFLICT' THEN 1 END) as conflict_count,
            AVG(unified_score) as avg_score,
            AVG(dimension_coverage) as avg_dimension_coverage,
            COUNT(CASE WHEN is_consumed THEN 1 END)::DECIMAL / COUNT(*) as consumption_rate
        FROM unified_signals
        WHERE trade_date = #{tradeDate}
    </select>

    <!-- 評級分布統計 -->
    <select id="getGradeDistribution" resultType="GradeDistributionDto">
        SELECT
            grade,
            COUNT(*) as count,
            COUNT(*)::DECIMAL / SUM(COUNT(*)) OVER () as percentage,
            AVG(unified_score) as avg_score,
            COUNT(CASE WHEN unified_direction = 'BUY' THEN 1 END) as buy_count,
            COUNT(CASE WHEN unified_direction = 'SELL' THEN 1 END) as sell_count
        FROM unified_signals
        WHERE trade_date BETWEEN #{startDate} AND #{endDate}
        <if test="direction != null">
            AND unified_direction = #{direction}
        </if>
        GROUP BY grade
        ORDER BY
            CASE grade
                WHEN 'A+' THEN 1 WHEN 'A' THEN 2 WHEN 'B+' THEN 3
                WHEN 'B' THEN 4 WHEN 'C' THEN 5 WHEN 'D' THEN 6
            END
    </select>

    <!-- 來源模組統計 -->
    <select id="getSourceModuleStatistics" resultType="SourceStatisticsDto">
        SELECT
            rs.source_module,
            COUNT(*) as total_signals,
            COUNT(*)::DECIMAL / #{days} as avg_daily_signals,
            COUNT(CASE WHEN rs.signal_direction = 'BUY' THEN 1 END) as buy_signals,
            COUNT(CASE WHEN rs.signal_direction = 'SELL' THEN 1 END) as sell_signals,
            AVG(rs.source_confidence) as avg_confidence
        FROM raw_signals rs
        WHERE rs.signal_date BETWEEN #{startDate} AND #{endDate}
          AND rs.dedup_status != 'REMOVED'
        GROUP BY rs.source_module
        ORDER BY total_signals DESC
    </select>

</mapper>
```

---

## 5. 索引策略

### 5.1 查詢模式分析

| 查詢場景 | 使用頻率 | 關鍵欄位 |
|---------|---------|---------|
| 每日推薦排行榜 | 極高 | trade_date, direction, score |
| 股票信號歷史 | 高 | stock_id, trade_date |
| 評級篩選 | 高 | grade, trade_date |
| 來源追溯 | 中 | unified_signal_id |
| 消費狀態查詢 | 中 | is_consumed, trade_date |

### 5.2 核心索引

```sql
-- unified_signals 核心索引
CREATE INDEX idx_unified_daily_rank ON unified_signals(trade_date, unified_direction, unified_score DESC);
CREATE INDEX idx_unified_stock_history ON unified_signals(stock_id, trade_date DESC);
CREATE INDEX idx_unified_grade_filter ON unified_signals(trade_date, grade, unified_score DESC);

-- raw_signals 核心索引
CREATE INDEX idx_raw_collection ON raw_signals(signal_date, source_module);
CREATE INDEX idx_raw_dedup ON raw_signals(stock_id, signal_code, signal_date);
```

---

## 6. 資料保留策略

| 表格 | 保留期限 | 清理策略 |
|-----|---------|---------|
| raw_signals | 90 天 | 每日清理已處理且超期的原始信號 |
| unified_signals | 2 年 | 超期資料歸檔至歷史表 |
| signal_contributors | 2 年 | 隨 unified_signals 歸檔 |
| signal_scoring_details | 2 年 | 隨 unified_signals 歸檔 |
| signal_dedup_log | 30 天 | 每日清理超期記錄 |
| signal_consumption_log | 1 年 | 年度歸檔 |
| daily_recommendations | 2 年 | 隨 unified_signals 歸檔 |

---

## 7. 相關文檔

- [M13 功能需求](../specs/functional/M13-信號引擎功能需求.md)
- [M13 API 規格](../specs/api/M13-API規格.md)
- [M13 ERD](./erd/M13-ERD.md)

---

**文件維護者**: 後端工程師
**最後更新**: 2026-01-14
**下次審核**: 2026-04-14
