# M07-技術分析模組測試準則

> **文件編號**: TEST-M07  
> **模組名稱**: 技術分析模組  
> **版本**: v2.0  
> **最後更新**: 2026-01-15  
> **狀態**: Draft

---

## 10. 測試準則

### 10.1 單元測試

**測試場景**:

**IndicatorCalculationService 測試**:
```
測試: 計算 MA 指標
Given: 台積電 250 個交易日股價資料
When: 呼叫 calculateMA(stockId="2330", periods=[5, 20, 60])
Then: 
  - 返回 MA5, MA20, MA60 值
  - MA5 值等於最近 5 日收盤價平均
  - 誤差 < 0.01%

測試: 資料不足處理
Given: 台積電只有 10 個交易日股價資料
When: 呼叫 calculateMA(stockId="2330", periods=[5, 20, 60])
Then:
  - MA5 有值（資料充足）
  - MA20 為 NaN（資料不足）
  - 不拋出異常
```

**SignalDetectionService 測試**:
```
測試: 黃金交叉偵測
Given:
  - 昨日 MA5=98, MA20=100
  - 今日 MA5=101, MA20=100
When: 呼叫 detectCrossSignals(stockId="2330", date="2024-12-24")
Then:
  - 產生 BUY 信號
  - signal_name = 'MA_GOLDEN_CROSS'
  - confidence_score = 70
```

---

### 10.1.1 P1 指標計算器測試

**趨勢類指標測試**:

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| WMACalculatorTest | WMA 計算正確性、多週期計算 | 權重計算、短週期 > 長週期 |
| AroonCalculatorTest | 強勢上漲/下跌趨勢 | Aroon Up/Down 範圍 0-100 |

```
測試: WMA 多週期計算
Given: 25 天連續上漲的價格序列
When: 呼叫 calculate(series, periods=[10, 20])
Then:
  - wma_10 > wma_20（短週期更接近最新價格）
  - 值在合理範圍內

測試: Aroon 強勢上漲趨勢
Given: 30 天持續創新高的價格序列
When: 呼叫 calculate(series, period=25)
Then:
  - aroon_up_25 > 70
  - aroon_down_25 < 30
  - aroon_signal = "STRONG_UPTREND"
```

**動能類指標測試**:

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| ROCCalculatorTest | 計算正確性、多空信號 | 百分比變動計算 |
| WilliamsRCalculatorTest | 範圍驗證、超買超賣 | 範圍 -100 到 0 |
| CCICalculatorTest | 超買超賣信號 | > 100 超買, < -100 超賣 |

```
測試: Williams %R 超買信號
Given: 收盤價持續接近區間最高價
When: 呼叫 calculate(series, period=14)
Then:
  - willr_14 > -20
  - willr_signal = "OVERBOUGHT"

測試: CCI 超賣信號
Given: 價格大幅低於統計平均
When: 呼叫 calculate(series, period=20)
Then:
  - cci_20 < -100
  - cci_signal = "OVERSOLD"
```

**波動類指標測試**:

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| DonchianChannelCalculatorTest | 通道計算、突破信號 | 上軌=最高價, 下軌=最低價 |

```
測試: Donchian 通道計算
Given: 期間內最高價 120, 最低價 80
When: 呼叫 calculate(series, period=20)
Then:
  - donchian_upper_20 = 120
  - donchian_lower_20 = 80
  - donchian_middle_20 = 100
```

**成交量類指標測試**:

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| CMFCalculatorTest | 範圍驗證、買賣盤信號 | CMF 範圍 -1 到 +1 |

```
測試: CMF 強勁買盤
Given: 收盤價持續接近最高價
When: 呼叫 calculate(series, period=20)
Then:
  - cmf_20 > 0
  - cmf_signal 為買盤相關信號
```

**支撐壓力類指標測試**:

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| PivotPointsCalculatorTest | 標準/Fibonacci Pivot | PP, R1, S1 計算正確 |

```
測試: 標準 Pivot Points 計算
Given: 前一天 High=110, Low=90, Close=100
When: 呼叫 calculate(series, type="standard")
Then:
  - pivot_pp = 100  // (110+90+100)/3
  - pivot_r1 = 110  // 2*100-90
  - pivot_s1 = 90   // 2*100-110
```

**統計類指標測試**:

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| LinearRegressionCalculatorTest | 線性趨勢、R² | 完美線性 R²=1 |

```
測試: 完美線性上升
Given: 價格序列 y = x + 100（完美線性）
When: 呼叫 calculate(series, period=14)
Then:
  - linreg_slope_14 ≈ 1.0
  - linreg_r2_14 ≈ 1.0
  - linreg_signal = "STRONG_UPTREND"
```

---

### 10.2 整合測試

**完整指標計算流程測試**:
```
測試: 端到端指標計算
Given: 
  - stock_prices 表有台積電最新 250 天股價資料
  - indicator_definitions 表有基礎指標定義
When: 
  - 觸發 JOB-M07-001（基礎指標計算）
Then:
  - Job 狀態變為 RUNNING
  - technical_indicators 表新增台積電指標記錄
  - Redis 快取被更新
  - Job 狀態變為 SUCCESS
```

---

### 10.3 效能測試

**負載測試**:
```
測試: API 並發查詢
場景: 100 個並發請求查詢不同股票的最新指標
預期:
  - P95 回應時間 < 150ms
  - 錯誤率 < 0.1%
  - 快取命中率 > 85%
```

---

### 10.4 測試覆蓋率目標

| 層級 | 覆蓋率目標 | 測試工具 |
|-----|----------|---------|
| Repository (JPA) | > 90% | JUnit 5, Spring Boot Test |
| Mapper (MyBatis) | > 85% | MyBatis Test |
| Service | > 80% | JUnit 5, Mockito |
| Controller | > 70% | MockMvc, RestAssured |
| 整體專案 | > 75% | JaCoCo |

---



---

## 📚 相關文檔

- [M07 功能需求](../specs/functional/M07-技術分析功能需求.md)
- [M07 API規格](../specs/technical/api/M07-API規格.md)
- [M07 業務流程](./M07-業務流程.md)
- [開發準則](../specs/technical/00-開發準則.md)

---

**文件維護者**: 測試工程師  
**最後更新**: 2025-12-31  
**下次審核**: 2026-02-28
