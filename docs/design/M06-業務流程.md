# M06-資料管理模組業務流程

> **文件編號**: FLOW-M06  
> **模組名稱**: 資料管理模組  
> **版本**: v2.0  
> **最後更新**: 2025-12-31  
> **狀態**: Draft

---

## 📋 業務流程總覽

本文件定義 資料管理模組的資料流與業務邏輯。

---

## 5. 資料流設計

### 5.1 資料流總覽

```
┌─────────────────────────────────────────────────────────────┐
│                    外部資料來源                               │
│  Yahoo Finance / 證交所 / 公開資訊觀測站 / FinMind           │
└─────────────────────────────────────────────────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  資料獲取層      │
                    │  - API 呼叫     │
                    │  - 錯誤處理     │
                    │  - 重試機制     │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  資料清洗層      │
                    │  - 格式轉換     │
                    │  - 欄位對應     │
                    │  - 異常值處理   │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  資料驗證層      │
                    │  - 完整性檢查   │
                    │  - 一致性檢查   │
                    │  - 業務規則驗證 │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  資料儲存層      │
                    │  - UPSERT       │
                    │  - Transaction  │
                    │  - 索引更新     │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  快取更新層      │
                    │  - Redis 寫入   │
                    │  - 設定 TTL     │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  結果記錄層      │
                    │  - Job 記錄     │
                    │  - 統計資訊     │
                    │  - 告警觸發     │
                    └─────────────────┘
```

### 5.2 股價資料同步流程

```
START: 股價資料同步 Job 觸發（每交易日 15:00）
  ↓
1. 檢查是否為交易日（查詢 trading_calendar 表）
   ├─ 否 → 記錄 SKIPPED 狀態 → END
   └─ 是 → 繼續
  ↓
2. 建立 Job 執行記錄（job_executions 表）
   - job_name = 'SYNC_STOCK_PRICES'
   - job_status = 'RUNNING'
   - start_time = CURRENT_TIMESTAMP
  ↓
3. 從 stocks 表查詢所有活躍股票（is_active = true）
  ↓
4. 批次處理（每批 50 檔股票）
  ↓
5. 呼叫 Yahoo Finance API 獲取股價
   ├─ 成功 → 繼續
   └─ 失敗 → 重試 3 次
       ├─ 成功 → 繼續
       └─ 仍失敗 → 切換資料源（證交所 API）
           ├─ 成功 → 繼續
           └─ 仍失敗 → 記錄錯誤，跳過該批次
  ↓
6. 資料清洗與轉換
   - 格式標準化（日期、數值）
   - 計算 change_price, change_percent
  ↓
7. 資料驗證（參照總綱 4.7）
   - 四價關係檢查
   - 價格合理性檢查（漲跌停幅度）
   - 成交量非負檢查
   ├─ 通過 → 繼續
   └─ 失敗 → 記錄到 data_quality_issues 表，跳過該股票
  ↓
8. 使用 MyBatis 批次 UPSERT
   - ON CONFLICT (stock_id, trade_date) DO UPDATE
   - Transaction 保護
  ↓
9. 更新 Redis 快取（僅熱門股票）
   - Key: stock:price:{stock_id}:{date}
   - TTL: 1 小時
  ↓
10. 更新 Job 執行記錄
   - job_status = 'SUCCESS' / 'FAILED'
   - end_time = CURRENT_TIMESTAMP
   - success_items, failed_items
  ↓
11. 發布事件（StockPriceUpdated）
  ↓
12. 檢查失敗率
   ├─ 失敗率 > 10% → 發送告警
   └─ 否 → 正常結束
  ↓
END
```

### 5.3 財報資料同步流程

```
START: 財報資料同步 Job 觸發（檢測到新財報公告）
  ↓
1. 從公開資訊觀測站查詢新公告清單
  ↓
2. 篩選尚未同步的財報
  ↓
3. 逐筆處理財報
  ↓
4. 下載財報檔案（PDF 或 XBRL）
   ├─ 成功 → 繼續
   └─ 失敗 → 重試 3 次 → 仍失敗 → 記錄錯誤，人工處理
  ↓
5. 解析財報資料
   - XBRL 解析（優先）
   - PDF OCR 解析（備援）
  ↓
6. 資料驗證
   - 必填欄位檢查
   - 資產負債平衡檢查（total_assets = total_liabilities + equity）
   ├─ 通過 → 繼續
   └─ 失敗 → 記錄錯誤，人工確認
  ↓
7. 資料儲存（UPSERT）
   - INSERT ... ON DUPLICATE KEY UPDATE
  ↓
8. 更新 Redis 快取（清除相關快取）
  ↓
9. 記錄 Job 執行結果
  ↓
END
```
---


---

## 7. 業務邏輯設計

> **說明**: 本節以文字描述業務邏輯與演算法，不包含程式碼實作

### 7.1 Service 層架構

```
StockDataService (股票資料服務 - 門面)
    │
    ├─→ StockPriceSyncService (股價同步服務)
    │       ├─ 職責: 股價資料同步、驗證與儲存
    │       ├─ 依賴: StockRepository (JPA), StockPriceMapper (MyBatis)
    │       └─ 核心方法: syncStockPrices(tradeDate)
    │
    ├─→ FinancialStatementSyncService (財報同步服務)
    │       ├─ 職責: 財報資料同步、XBRL解析、驗證
    │       ├─ 依賴: FinancialStatementMapper (MyBatis)
    │       └─ 核心方法: syncFinancialStatements()
    │
    ├─→ ChipDataSyncService (籌碼同步服務)
    │       ├─ 職責: 三大法人、融資融券資料同步
    │       ├─ 依賴: InstitutionalTradingMapper, MarginTradingMapper (MyBatis)
    │       └─ 核心方法: syncChipData(tradeDate)
    │
    ├─→ TradingCalendarService (交易日曆服務)
    │       ├─ 職責: 交易日判斷、日期計算
    │       ├─ 依賴: TradingCalendarRepository (JPA)
    │       └─ 核心方法: isTradingDay(date), getNextTradingDay(date)
    │
    └─→ DataQualityService (資料品質服務)
            ├─ 職責: 資料驗證、品質檢核、異常記錄
            ├─ 依賴: DataQualityIssueRepository (JPA)
            └─ 核心方法: validateStockPrice(price), runQualityChecks()
```

---

### 7.2 資料獲取邏輯

#### 7.2.1 資料源選擇策略

**決策流程**:
1. 根據資料類型（stock_price, financial_data, chip_data）查詢可用資料源
2. 按優先順序排序（priority 越小越優先）
3. 依序嘗試，直到成功或全部失敗
4. 記錄使用的資料源與失敗原因

**範例**:
```
資料類型: stock_price
資料源清單:
├── Yahoo Finance (priority=1, status=ACTIVE)
├── 證交所 API (priority=2, status=ACTIVE)
└── FinMind API (priority=3, status=INACTIVE)

執行順序:
1. 嘗試 Yahoo Finance
   └─ 成功 → 返回資料，記錄使用 Yahoo Finance
2. 失敗 → 嘗試證交所 API
   └─ 成功 → 返回資料，記錄切換到證交所 API
3. 失敗 → 全部失敗
   └─ 記錄錯誤，觸發告警
```

#### 7.2.2 請求重試策略

**重試條件**:
- 網路超時（Timeout）
- HTTP 5xx 錯誤（伺服器錯誤）
- 連線中斷（Connection Reset）

**不重試條件**:
- HTTP 4xx 錯誤（客戶端錯誤，如 401, 404）
- 資料格式錯誤
- 業務邏輯錯誤

**重試策略**:
- 重試次數: 3 次
- 延遲策略: Exponential Backoff
  - 第 1 次重試: 延遲 1 秒
  - 第 2 次重試: 延遲 2 秒
  - 第 3 次重試: 延遲 4 秒
- 超時時間: 10 秒

**重試流程**:
```
API 呼叫
  ↓
成功？
├─ 是 → 返回資料
└─ 否 → 檢查錯誤類型
    ├─ 可重試錯誤 → 延遲後重試（最多 3 次）
    │   ├─ 重試成功 → 返回資料
    │   └─ 重試失敗 → 切換資料源
    └─ 不可重試錯誤 → 立即切換資料源
```

---

### 7.3 資料清洗邏輯

#### 7.3.1 股價資料清洗

**輸入**: 從外部 API 獲取的原始股價資料  
**輸出**: 標準化的股價資料

**處理步驟**:

**步驟 1: 日期格式標準化**
- 統一轉換為 ISO 8601 格式（YYYY-MM-DD）
- 處理時區問題（轉為台灣時區 UTC+8）
- 範例:
  - `2024/12/24` → `2024-12-24`
  - `Dec 24, 2024` → `2024-12-24`

**步驟 2: 數值格式標準化**
- 移除千分位符號（1,000 → 1000）
- 轉換為 NUMERIC 型別
- 保留小數點後 2 位
- 範例:
  - `"580.5"` → `580.50`
  - `"35,000,000"` → `35000000`

**步驟 3: 計算衍生欄位**
- change_price = close_price - 前一交易日 close_price
- change_percent = (change_price / 前一交易日 close_price) × 100
- turnover = close_price × volume（若資料源未提供）

**步驟 4: 異常值處理**
- 價格為 0 或負數 → 標記為異常，不儲存
- 成交量為負數 → 標記為異常，不儲存
- 四價關係錯誤 → 標記為異常，不儲存
- 記錄異常值到 data_quality_issues 表

---

#### 7.3.2 財報資料清洗

**輸入**: 從 PDF/XBRL 解析的財報資料  
**輸出**: 標準化的財報資料

**處理步驟**:

**步驟 1: 單位統一**
- 所有金額統一為「千元」（與公開資訊觀測站一致）
- 每股指標統一為「元」
- 範例:
  - 營收 100 億元 → revenue = 10000000（千元）
  - EPS 11.5 元 → eps = 11.50

**步驟 2: 欄位對應**
- 不同資料源的欄位名稱不同，需對應到統一欄位
- 維護欄位對應表:
  ```
  公開資訊觀測站欄位 → 資料表欄位
  "營業收入淨額" → revenue
  "稅後淨利" → net_income
  "資產總額" → total_assets
  ```

**步驟 3: 計算衍生欄位**
- free_cash_flow = operating_cash_flow - 資本支出（從 investing_cash_flow 提取）
- 若核心欄位缺失，嘗試從 JSONB 詳細資料計算

**步驟 4: JSONB 結構化**
- 將完整財報資料儲存到 income_statement, balance_sheet, cash_flow_statement 欄位
- 確保 JSON 格式正確
- 範例結構參見 3.2.3 節

---

### 7.4 資料驗證邏輯

#### 7.4.1 股價資料驗證規則

**規則 1: 完整性檢查**
```
必填欄位: stock_id, trade_date, open_price, high_price, low_price, close_price, volume
檢查: 所有必填欄位不可為 NULL
```

**規則 2: 四價關係**
```
low_price <= open_price <= high_price
low_price <= close_price <= high_price

檢查邏輯:
IF (low_price > open_price OR low_price > close_price) THEN
    驗證失敗，記錄錯誤: "low_price 超過 open_price 或 close_price"
END IF

IF (high_price < open_price OR high_price < close_price) THEN
    驗證失敗，記錄錯誤: "high_price 低於 open_price 或 close_price"
END IF
```

**規則 3: 漲跌停限制**
```
若前一交易日 close_price 為 prev_close:
limit_up = prev_close × 1.10
limit_down = prev_close × 0.90

檢查邏輯:
IF (high_price > limit_up + 容許誤差) THEN
    驗證失敗，記錄警告: "超過漲停價"
END IF

IF (low_price < limit_down - 容許誤差) THEN
    驗證失敗，記錄警告: "低於跌停價"
END IF

容許誤差 = 0.01 元（考慮計算精度）
```

**規則 4: 成交量非負**
```
IF (volume < 0) THEN
    驗證失敗，記錄錯誤: "成交量為負數"
END IF
```

**規則 5: 交易日期有效性**
```
查詢 trading_calendar 表:
IF (trade_date 不存在 OR is_trading_day = false) THEN
    驗證失敗，記錄錯誤: "非交易日"
END IF
```

**驗證失敗處理**:
- 記錄到 data_quality_issues 表
- 標記嚴重度（HIGH, MEDIUM, LOW）
- 不儲存該筆資料
- 繼續處理其他資料

---

#### 7.4.2 財報資料驗證規則

**規則 1: 資產負債平衡**
```
檢查: total_assets = total_liabilities + equity

允許誤差: 1000 元（千元為單位，即實際 1 元）

檢查邏輯:
difference = ABS(total_assets - (total_liabilities + equity))
IF (difference > 1000) THEN
    IF (difference > 10000) THEN
        驗證失敗，記錄錯誤: "資產負債差異過大"
    ELSE
        驗證通過，記錄警告: "資產負債有輕微差異"
    END IF
END IF
```

**規則 2: 必填欄位檢查**
```
必填欄位: revenue, net_income, total_assets, equity

IF (任一必填欄位為 NULL) THEN
    驗證失敗，記錄錯誤: "缺少必填欄位"
END IF
```

**規則 3: 邏輯一致性**
```
檢查 1: gross_profit = revenue - 營業成本
檢查 2: operating_income = gross_profit - operating_expense

IF (檢查失敗) THEN
    記錄警告: "財報數值邏輯不一致"（不阻擋儲存）
END IF
```

**規則 4: 合理性檢查**
```
檢查 ROE 範圍:
roe = (net_income / equity) × 100

IF (roe < -100 OR roe > 100) THEN
    記錄警告: "ROE 超出合理範圍"
END IF
```

**驗證失敗處理**:
- HIGH 嚴重度錯誤 → 標記為 MANUAL_REVIEW，不自動儲存
- MEDIUM/LOW 警告 → 儲存資料，但記錄警告

---

### 7.5 批次處理邏輯

#### 7.5.1 批次大小決策

**決策依據**:
- 資料量大小
- API 速率限制
- 資料庫寫入效能
- 記憶體使用量

**建議批次大小**:
| 資料類型 | 批次大小 | 理由 |
|---------|---------|------|
| 股價同步 | 50 檔股票 | API 呼叫次數限制 |
| 股價寫入 | 100 筆 | 資料庫 UPSERT 效能 |
| 籌碼同步 | 100 檔股票 | 資料量較小 |
| 財報解析 | 10 份財報 | CPU 密集型任務 |

#### 7.5.2 批次處理流程

```
總資料集（如 1800 檔股票）
  ↓
分批處理（batch_size = 50）
  ↓
批次 1: 股票 1-50
├─ API 呼叫
├─ 資料清洗
├─ 資料驗證
├─ 批次寫入資料庫（MyBatis）
└─ 記錄處理結果
  ↓
批次 2: 股票 51-100
├─ （同上）
└─ ...
  ↓
...
  ↓
批次 36: 股票 1751-1800
├─ （同上）
└─ 完成
  ↓
彙總統計
├─ 成功筆數
├─ 失敗筆數
└─ 記錄到 job_executions
```

**批次失敗處理**:
- 單一批次失敗不影響其他批次
- 記錄失敗批次的股票清單
- 支援重跑失敗批次

---

### 7.6 快取策略

#### 7.6.1 快取鍵設計

**股價資料**:
```
單日股價:
  Key: stock:price:{stock_id}:{trade_date}
  範例: stock:price:2330:2024-12-24
  Value: StockPrice JSON
  TTL: 1 小時

範圍查詢:
  Key: stock:prices:{stock_id}:{start_date}:{end_date}
  範例: stock:prices:2330:2024-01-01:2024-12-24
  Value: List<StockPrice> JSON
  TTL: 6 小時
```

**股票基本資料**:
```
Key: stock:info:{stock_id}
範例: stock:info:2330
Value: Stock JSON
TTL: 24 小時
```

**股票清單**:
```
全部活躍股票:
  Key: stocks:list:active
  Value: List<Stock> JSON
  TTL: 24 小時

依市場分類:
  Key: stocks:list:market:{market_type}
  範例: stocks:list:market:TWSE
  Value: List<Stock> JSON
  TTL: 24 小時

依產業分類:
  Key: stocks:list:industry:{industry}
  範例: stocks:list:industry:半導體
  Value: List<Stock> JSON
  TTL: 24 小時
```

**交易日曆**:
```
Key: trading:calendar:{year}
範例: trading:calendar:2024
Value: List<TradingDay> JSON
TTL: 7 天
```

#### 7.6.2 TTL 設定策略

| 資料類型 | TTL | 理由 |
|---------|-----|------|
| 當日股價（盤後） | 1 小時 | 盤後可能有修正 |
| 歷史股價 | 6 小時 | 不常變動 |
| 股票基本資料 | 24 小時 | 變動頻率低 |
| 股票清單 | 24 小時 | 每日更新一次 |
| 財報資料 | 7 天 | 每季更新 |
| 交易日曆 | 7 天 | 提前一年預載 |

#### 7.6.3 快取更新策略

**Cache-Aside 模式**:
```
讀取流程:
1. 查詢 Redis 快取
   ├─ 命中 → 返回快取資料
   └─ 未命中 → 查詢資料庫
       ├─ 查詢成功 → 寫入快取 → 返回資料
       └─ 查詢失敗 → 返回錯誤

寫入流程:
1. 寫入 PostgreSQL 資料庫
2. 刪除相關快取（或更新快取）
3. 下次讀取時重新載入
```

**快取預熱**:
```
系統啟動時:
1. 載入熱門股票（市值前 50）最新股價
2. 載入當年度交易日曆
3. 載入活躍股票清單

Job 完成後:
1. 更新熱門股票快取
2. 更新股票清單快取（若有變動）
```

**快取失效觸發時機**:
- 股價同步 Job 完成 → 清除 stock:price:* 相關快取
- 股票清單更新 → 清除 stocks:list:* 相關快取
- 財報同步完成 → 清除 stock:financial:* 相關快取

---


---

## 8. 整合點

### 8.1 對外部系統的依賴

| 外部系統 | 用途 | 協議 | 認證方式 | 限制 | 備援方案 |
|---------|------|------|---------|------|---------|
| Yahoo Finance API | 股價資料 | REST | 無（公開） | 100 req/hour | 證交所 API |
| 證交所公開資訊 | 股價、法人、融資融券 | REST | 無（公開） | 無明確限制 | FinMind API |
| 公開資訊觀測站 | 財報資料 | HTTP | 無（公開） | 需爬蟲解析 | 手動上傳 |
| FinMind API | 綜合資料（備援） | REST | API Key | 依方案不同 | - |

**外部 API 呼叫規範**:
- 設定 User-Agent 標頭
- 遵守 robots.txt 規則
- 實作重試與 Exponential Backoff
- 記錄 API 呼叫日誌（請求時間、狀態碼、回應時間）

---

### 8.2 對內部模組的提供

| 下游模組 | 使用的 API | 資料類型 | 呼叫頻率 | 快取策略 |
|---------|-----------|---------|---------|---------|
| M07 技術分析 | GET /stocks/{id}/prices | 股價歷史 | 每次計算指標 | 6 小時 TTL |
| M08 基本面分析 | GET /stocks/{id}/financials | 財務報表 | 每季更新 | 7 天 TTL |
| M09 籌碼分析 | GET /stocks/{id}/institutional<br>GET /stocks/{id}/margin | 法人、融資融券 | 每日更新 | 6 小時 TTL |
| M13 信號判斷引擎 | GET /stocks | 股票清單 | 初始化時 | 24 小時 TTL |
| M14 選股引擎 | GET /stocks<br>GET /stocks/{id}/prices | 股票清單、股價 | 選股執行時 | 6 小時 TTL |
| M16 回測系統 | GET /stocks/{id}/prices | 歷史股價 | 回測執行時 | 6 小時 TTL |

**服務間通訊規範**:
- 使用 REST API（同步）
- 使用事件（非同步）
- 遵守總綱 4.4 API 規範
- 統一錯誤碼格式

---

### 8.3 事件發布

**發布的事件**（遵守總綱事件規範）:

| 事件名稱 | 觸發條件 | 事件內容 | 訂閱者 | 用途 |
|---------|---------|---------|-------|------|
| StockPriceUpdated | 股價資料同步完成 | stock_id, trade_date, price_id | M07, M13 | 觸發指標計算、信號判斷 |
| FinancialStatementUpdated | 財報資料同步完成 | stock_id, year, quarter | M08, M13 | 觸發基本面分析 |
| StockListUpdated | 股票清單更新 | added_stocks[], removed_stocks[] | M07, M08, M13 | 更新股票池 |
| DataQualityIssueDetected | 發現資料品質問題 | issue_id, severity, affected_table | M15 監控系統 | 觸發告警 |

**事件格式範例**:
```json
{
  "event_id": "evt_abc123",
  "event_type": "StockPriceUpdated",
  "event_time": "2024-12-24T15:30:00+08:00",
  "source": "M06",
  "version": "1.0",
  "data": {
    "stock_id": "2330",
    "trade_date": "2024-12-24",
    "price_id": 123456,
    "affected_count": 1800
  }
}
```

**事件發布機制**:
- 使用 Spring ApplicationEventPublisher（同一 JVM）
- 或使用 Message Queue（Kafka/RabbitMQ，跨服務）
- 確保事件順序性（同一股票的事件按時間順序）

---

### 8.4 資料匯出介面

**用途**: 提供給外部系統或報表工具使用

**API**:
```
GET /api/export/stock-prices?stock_id=2330&start_date=2024-01-01&end_date=2024-12-31&format=csv

支援格式: CSV, JSON, Excel
權限: EXPORT_DATA
```

**匯出限制**:
- 單次最多匯出 1 年資料
- 每日匯出次數限制: 10 次
- 檔案大小限制: 50 MB

---


---

## 📚 相關文檔

- [M06 功能需求](../specs/functional/M06-資料管理功能需求.md)
- [M06 API規格](../specs/technical/api/M06-API規格.md)
- [M06 資料庫設計](./M06-資料庫設計.md)

---

**文件維護者**: 系統架構師  
**最後更新**: 2025-12-31
