# M16-回測系統 資料庫設計

> **文件編號**: DB-M16
> **模組名稱**: 回測系統 (Backtesting System)
> **版本**: v1.0
> **最後更新**: 2026-01-15
> **狀態**: Draft

---

## 1. 資料表清單

| 序號 | 資料表名稱 | 中文名稱 | 說明 |
|-----|-----------|---------|------|
| 1 | backtest_tasks | 回測任務表 | 回測任務設定與狀態 |
| 2 | backtest_trades | 回測交易記錄表 | 模擬交易明細 |
| 3 | backtest_daily_snapshots | 每日快照表 | 每日投組狀態 |
| 4 | backtest_results | 回測結果表 | 績效指標與統計 |
| 5 | backtest_drawdowns | 回撤記錄表 | 回撤分析 |
| 6 | backtest_optimizations | 參數最佳化表 | 最佳化任務 |
| 7 | backtest_optimization_results | 最佳化結果表 | 各組合結果 |
| 8 | backtest_templates | 回測範本表 | 常用設定範本 |
| 9 | backtest_comparisons | 策略比較表 | 多策略比較 |

---

## 2. 資料表詳細設計

### 2.1 backtest_tasks (回測任務表)

儲存回測任務的設定與執行狀態。

```sql
CREATE TABLE backtest_tasks (
    id                    BIGSERIAL PRIMARY KEY,
    backtest_id           VARCHAR(50) NOT NULL UNIQUE,
    user_id               VARCHAR(50) NOT NULL,
    backtest_name         VARCHAR(200) NOT NULL,

    -- 信號來源
    signal_source         VARCHAR(20) NOT NULL,  -- STRATEGY | SIGNAL | CUSTOM
    strategy_id           VARCHAR(50),           -- M11 策略 ID
    strategy_name         VARCHAR(200),

    -- 目標股票
    target_mode           VARCHAR(20) NOT NULL,  -- SPECIFIC | WATCHLIST | FILTER
    target_stock_ids      TEXT[],                -- 股票代碼陣列
    watchlist_id          VARCHAR(50),
    filter_conditions     JSONB,

    -- 回測期間
    start_date            DATE NOT NULL,
    end_date              DATE NOT NULL,
    trading_days          INTEGER,

    -- 資金設定
    initial_capital       DECIMAL(15,2) NOT NULL,

    -- 交易設定 (JSONB)
    trading_settings      JSONB NOT NULL,

    -- 出場規則 (JSONB)
    exit_rules            JSONB,

    -- 執行狀態
    status                VARCHAR(20) NOT NULL DEFAULT 'CREATED',
    progress_percent      DECIMAL(5,2) DEFAULT 0,
    progress_current_day  DATE,

    -- 執行時間
    started_at            TIMESTAMP WITH TIME ZONE,
    completed_at          TIMESTAMP WITH TIME ZONE,
    execution_time_ms     BIGINT,

    -- 錯誤資訊
    error_message         TEXT,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_backtest_tasks_user ON backtest_tasks(user_id, created_at DESC);
CREATE INDEX idx_backtest_tasks_status ON backtest_tasks(status);
CREATE INDEX idx_backtest_tasks_strategy ON backtest_tasks(strategy_id);

-- 狀態約束
ALTER TABLE backtest_tasks
ADD CONSTRAINT chk_backtest_status
CHECK (status IN ('CREATED', 'RUNNING', 'COMPLETED', 'FAILED', 'CANCELLED'));
```

**JSONB 結構範例**

`trading_settings`:
```json
{
  "positionSizing": "FIXED_AMOUNT",
  "fixedAmount": 100000,
  "percentOfCapital": null,
  "maxPositions": 5,
  "allowShort": false,
  "tradingCost": {
    "commissionRate": 0.001425,
    "taxRate": 0.003,
    "slippage": 0.001
  }
}
```

`exit_rules`:
```json
{
  "stopLoss": 0.07,
  "takeProfit": 0.15,
  "trailingStop": null,
  "maxHoldingDays": 30
}
```

---

### 2.2 backtest_trades (回測交易記錄表)

儲存回測過程中的模擬交易明細。

```sql
CREATE TABLE backtest_trades (
    id                    BIGSERIAL PRIMARY KEY,
    trade_id              VARCHAR(50) NOT NULL UNIQUE,
    backtest_id           VARCHAR(50) NOT NULL,

    -- 交易標的
    stock_id              VARCHAR(20) NOT NULL,
    stock_name            VARCHAR(100),

    -- 交易資訊
    trade_type            VARCHAR(10) NOT NULL,  -- BUY | SELL
    trade_date            DATE NOT NULL,
    trade_price           DECIMAL(10,2) NOT NULL,
    shares                INTEGER NOT NULL,
    trade_amount          DECIMAL(15,2) NOT NULL,

    -- 交易成本
    commission            DECIMAL(10,2) DEFAULT 0,
    tax                   DECIMAL(10,2) DEFAULT 0,
    slippage              DECIMAL(10,2) DEFAULT 0,
    net_amount            DECIMAL(15,2) NOT NULL,

    -- 信號來源
    signal_source         VARCHAR(50),          -- M11_STRATEGY | M13_SIGNAL | EXIT_RULE
    signal_id             VARCHAR(50),
    signal_grade          VARCHAR(10),

    -- 出場資訊 (賣出時填入)
    exit_reason           VARCHAR(30),
    entry_trade_id        VARCHAR(50),          -- 對應的買入交易 ID
    holding_days          INTEGER,
    profit_loss           DECIMAL(15,2),
    return_pct            DECIMAL(8,4),

    -- 持倉變化
    position_before       INTEGER DEFAULT 0,
    position_after        INTEGER NOT NULL,
    cash_before           DECIMAL(15,2),
    cash_after            DECIMAL(15,2),

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_backtest_trades_backtest ON backtest_trades(backtest_id, trade_date);
CREATE INDEX idx_backtest_trades_stock ON backtest_trades(backtest_id, stock_id);
CREATE INDEX idx_backtest_trades_type ON backtest_trades(backtest_id, trade_type);

-- 外鍵
ALTER TABLE backtest_trades
ADD CONSTRAINT fk_backtest_trades_task
FOREIGN KEY (backtest_id) REFERENCES backtest_tasks(backtest_id) ON DELETE CASCADE;

-- 交易類型約束
ALTER TABLE backtest_trades
ADD CONSTRAINT chk_trade_type
CHECK (trade_type IN ('BUY', 'SELL'));

-- 出場原因約束
ALTER TABLE backtest_trades
ADD CONSTRAINT chk_exit_reason
CHECK (exit_reason IS NULL OR exit_reason IN (
    'SIGNAL_EXIT', 'STOP_LOSS', 'TAKE_PROFIT',
    'TRAILING_STOP', 'MAX_HOLDING', 'FORCE_CLOSE'
));
```

---

### 2.3 backtest_daily_snapshots (每日快照表)

儲存回測期間每日的投組狀態。

```sql
CREATE TABLE backtest_daily_snapshots (
    id                    BIGSERIAL PRIMARY KEY,
    backtest_id           VARCHAR(50) NOT NULL,
    snapshot_date         DATE NOT NULL,

    -- 投組價值
    portfolio_value       DECIMAL(15,2) NOT NULL,
    cash                  DECIMAL(15,2) NOT NULL,
    position_value        DECIMAL(15,2) NOT NULL,

    -- 報酬
    daily_return          DECIMAL(10,6),
    cumulative_return     DECIMAL(10,6),

    -- 回撤
    high_water_mark       DECIMAL(15,2),
    drawdown              DECIMAL(10,6),

    -- 持倉明細 (JSONB)
    positions             JSONB,

    -- 基準對照
    benchmark_value       DECIMAL(15,4),
    benchmark_return      DECIMAL(10,6),

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(backtest_id, snapshot_date)
);

-- 索引
CREATE INDEX idx_daily_snapshots_backtest ON backtest_daily_snapshots(backtest_id, snapshot_date);

-- 外鍵
ALTER TABLE backtest_daily_snapshots
ADD CONSTRAINT fk_daily_snapshots_task
FOREIGN KEY (backtest_id) REFERENCES backtest_tasks(backtest_id) ON DELETE CASCADE;
```

**JSONB 結構範例**

`positions`:
```json
[
  {
    "stockId": "2330",
    "stockName": "台積電",
    "shares": 2000,
    "avgCost": 525.00,
    "currentPrice": 550.00,
    "marketValue": 1100000,
    "unrealizedPnL": 50000,
    "unrealizedReturn": 0.0476,
    "weight": 0.45
  }
]
```

---

### 2.4 backtest_results (回測結果表)

儲存回測完成後的績效指標與統計。

```sql
CREATE TABLE backtest_results (
    id                    BIGSERIAL PRIMARY KEY,
    backtest_id           VARCHAR(50) NOT NULL UNIQUE,

    -- 基本績效
    final_value           DECIMAL(15,2) NOT NULL,
    total_return          DECIMAL(10,6) NOT NULL,
    annualized_return     DECIMAL(10,6),

    -- 風險調整報酬
    sharpe_ratio          DECIMAL(8,4),
    sortino_ratio         DECIMAL(8,4),
    calmar_ratio          DECIMAL(8,4),

    -- 波動與風險
    volatility            DECIMAL(8,4),
    downside_volatility   DECIMAL(8,4),
    max_drawdown          DECIMAL(8,4),
    max_drawdown_duration INTEGER,
    var_95                DECIMAL(8,4),
    cvar_95               DECIMAL(8,4),

    -- 基準比較
    benchmark_code        VARCHAR(20),
    benchmark_return      DECIMAL(10,6),
    alpha                 DECIMAL(8,4),
    beta                  DECIMAL(8,4),

    -- 交易統計
    total_trades          INTEGER DEFAULT 0,
    winning_trades        INTEGER DEFAULT 0,
    losing_trades         INTEGER DEFAULT 0,
    win_rate              DECIMAL(6,4),
    avg_win               DECIMAL(15,2),
    avg_loss              DECIMAL(15,2),
    payoff_ratio          DECIMAL(8,4),
    profit_factor         DECIMAL(8,4),

    -- 其他統計
    avg_holding_days      DECIMAL(8,2),
    max_consecutive_wins  INTEGER,
    max_consecutive_losses INTEGER,
    largest_win           DECIMAL(15,2),
    largest_loss          DECIMAL(15,2),

    -- 成本統計
    total_commission      DECIMAL(15,2) DEFAULT 0,
    total_tax             DECIMAL(15,2) DEFAULT 0,
    total_slippage        DECIMAL(15,2) DEFAULT 0,
    turnover_rate         DECIMAL(8,4),

    -- 月度報酬 (JSONB)
    monthly_returns       JSONB,

    -- 各股表現 (JSONB)
    stock_performance     JSONB,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 外鍵
ALTER TABLE backtest_results
ADD CONSTRAINT fk_backtest_results_task
FOREIGN KEY (backtest_id) REFERENCES backtest_tasks(backtest_id) ON DELETE CASCADE;
```

**JSONB 結構範例**

`monthly_returns`:
```json
{
  "2023": {
    "Jan": 0.032, "Feb": -0.015, "Mar": 0.045,
    "Apr": 0.028, "May": -0.008, "Jun": 0.052,
    "Jul": -0.025, "Aug": 0.018, "Sep": 0.035,
    "Oct": -0.012, "Nov": 0.041, "Dec": 0.022
  },
  "2024": {},
  "2025": {}
}
```

`stock_performance`:
```json
[
  {
    "stockId": "2330",
    "stockName": "台積電",
    "trades": 30,
    "winRate": 0.60,
    "totalPnL": 150000,
    "avgReturn": 0.045
  }
]
```

---

### 2.5 backtest_drawdowns (回撤記錄表)

儲存回測期間的回撤事件。

```sql
CREATE TABLE backtest_drawdowns (
    id                    BIGSERIAL PRIMARY KEY,
    backtest_id           VARCHAR(50) NOT NULL,
    rank                  INTEGER NOT NULL,

    -- 回撤期間
    start_date            DATE NOT NULL,
    end_date              DATE NOT NULL,
    recovery_date         DATE,

    -- 回撤數值
    peak_value            DECIMAL(15,2),
    trough_value          DECIMAL(15,2),
    drawdown_depth        DECIMAL(8,4) NOT NULL,

    -- 持續天數
    drawdown_duration     INTEGER NOT NULL,
    recovery_days         INTEGER,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(backtest_id, rank)
);

-- 索引
CREATE INDEX idx_drawdowns_backtest ON backtest_drawdowns(backtest_id, rank);

-- 外鍵
ALTER TABLE backtest_drawdowns
ADD CONSTRAINT fk_drawdowns_task
FOREIGN KEY (backtest_id) REFERENCES backtest_tasks(backtest_id) ON DELETE CASCADE;
```

---

### 2.6 backtest_optimizations (參數最佳化表)

儲存參數最佳化任務。

```sql
CREATE TABLE backtest_optimizations (
    id                    BIGSERIAL PRIMARY KEY,
    optimization_id       VARCHAR(50) NOT NULL UNIQUE,
    backtest_id           VARCHAR(50) NOT NULL,
    user_id               VARCHAR(50) NOT NULL,

    -- 最佳化設定
    optimization_method   VARCHAR(30) NOT NULL,  -- GRID_SEARCH | RANDOM_SEARCH | GENETIC
    target_metric         VARCHAR(30) NOT NULL,  -- SHARPE_RATIO | TOTAL_RETURN | CALMAR_RATIO
    parameters            JSONB NOT NULL,        -- 待最佳化參數
    constraints           JSONB,                 -- 約束條件

    -- 執行狀態
    status                VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    total_combinations    INTEGER NOT NULL,
    completed_combinations INTEGER DEFAULT 0,

    -- 最佳結果摘要
    best_params           JSONB,
    best_metric_value     DECIMAL(10,4),

    -- 執行時間
    started_at            TIMESTAMP WITH TIME ZONE,
    completed_at          TIMESTAMP WITH TIME ZONE,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_optimizations_backtest ON backtest_optimizations(backtest_id);
CREATE INDEX idx_optimizations_user ON backtest_optimizations(user_id, created_at DESC);

-- 外鍵
ALTER TABLE backtest_optimizations
ADD CONSTRAINT fk_optimizations_task
FOREIGN KEY (backtest_id) REFERENCES backtest_tasks(backtest_id) ON DELETE CASCADE;
```

**JSONB 結構範例**

`parameters`:
```json
[
  {
    "name": "stopLoss",
    "type": "RANGE",
    "min": 0.05,
    "max": 0.15,
    "step": 0.01
  },
  {
    "name": "maxHoldingDays",
    "type": "VALUES",
    "values": [10, 20, 30, 60]
  }
]
```

---

### 2.7 backtest_optimization_results (最佳化結果表)

儲存每個參數組合的回測結果。

```sql
CREATE TABLE backtest_optimization_results (
    id                    BIGSERIAL PRIMARY KEY,
    optimization_id       VARCHAR(50) NOT NULL,
    combination_index     INTEGER NOT NULL,

    -- 參數組合
    parameters            JSONB NOT NULL,

    -- 績效結果
    total_return          DECIMAL(10,6),
    annualized_return     DECIMAL(10,6),
    sharpe_ratio          DECIMAL(8,4),
    sortino_ratio         DECIMAL(8,4),
    calmar_ratio          DECIMAL(8,4),
    max_drawdown          DECIMAL(8,4),
    win_rate              DECIMAL(6,4),
    profit_factor         DECIMAL(8,4),
    total_trades          INTEGER,

    -- 排名
    rank_by_target        INTEGER,

    -- 是否符合約束
    meets_constraints     BOOLEAN DEFAULT TRUE,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(optimization_id, combination_index)
);

-- 索引
CREATE INDEX idx_opt_results_optimization ON backtest_optimization_results(optimization_id, rank_by_target);

-- 外鍵
ALTER TABLE backtest_optimization_results
ADD CONSTRAINT fk_opt_results_optimization
FOREIGN KEY (optimization_id) REFERENCES backtest_optimizations(optimization_id) ON DELETE CASCADE;
```

---

### 2.8 backtest_templates (回測範本表)

儲存用戶的回測設定範本。

```sql
CREATE TABLE backtest_templates (
    id                    BIGSERIAL PRIMARY KEY,
    template_id           VARCHAR(50) NOT NULL UNIQUE,
    user_id               VARCHAR(50) NOT NULL,
    template_name         VARCHAR(200) NOT NULL,
    description           TEXT,

    -- 範本設定
    trading_settings      JSONB NOT NULL,
    exit_rules            JSONB,

    -- 使用統計
    usage_count           INTEGER DEFAULT 0,
    last_used_at          TIMESTAMP WITH TIME ZONE,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_templates_user ON backtest_templates(user_id);
```

---

### 2.9 backtest_comparisons (策略比較表)

儲存多策略比較結果。

```sql
CREATE TABLE backtest_comparisons (
    id                    BIGSERIAL PRIMARY KEY,
    comparison_id         VARCHAR(50) NOT NULL UNIQUE,
    user_id               VARCHAR(50) NOT NULL,

    -- 比較設定
    backtest_ids          TEXT[] NOT NULL,
    benchmark_code        VARCHAR(20),

    -- 比較結果 (JSONB)
    comparison_result     JSONB NOT NULL,
    correlation_matrix    JSONB,

    created_at            TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_comparisons_user ON backtest_comparisons(user_id, created_at DESC);
```

---

## 3. MyBatis Mapper 設計

### 3.1 BacktestTaskMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.chris.fin_shark.m16.mapper.BacktestTaskMapper">

    <!-- 查詢用戶回測清單 -->
    <select id="findByUserId" resultType="BacktestTask">
        SELECT
            backtest_id,
            backtest_name,
            strategy_name,
            status,
            array_length(target_stock_ids, 1) as target_stocks_count,
            start_date,
            end_date,
            initial_capital,
            created_at
        FROM backtest_tasks
        WHERE user_id = #{userId}
        <if test="status != null">
            AND status = #{status}
        </if>
        <if test="strategyId != null">
            AND strategy_id = #{strategyId}
        </if>
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 更新執行進度 -->
    <update id="updateProgress">
        UPDATE backtest_tasks
        SET progress_percent = #{progressPercent},
            progress_current_day = #{currentDay},
            updated_at = CURRENT_TIMESTAMP
        WHERE backtest_id = #{backtestId}
    </update>

    <!-- 更新執行狀態 -->
    <update id="updateStatus">
        UPDATE backtest_tasks
        SET status = #{status},
            <if test="status == 'RUNNING'">
                started_at = CURRENT_TIMESTAMP,
            </if>
            <if test="status == 'COMPLETED' or status == 'FAILED'">
                completed_at = CURRENT_TIMESTAMP,
                execution_time_ms = EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - started_at)) * 1000,
            </if>
            <if test="errorMessage != null">
                error_message = #{errorMessage},
            </if>
            updated_at = CURRENT_TIMESTAMP
        WHERE backtest_id = #{backtestId}
    </update>

    <!-- 清理過期回測 -->
    <delete id="deleteExpiredBacktests">
        DELETE FROM backtest_tasks
        WHERE created_at &lt; #{expireDate}
          AND status IN ('COMPLETED', 'FAILED', 'CANCELLED')
    </delete>

</mapper>
```

### 3.2 BacktestTradeMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.chris.fin_shark.m16.mapper.BacktestTradeMapper">

    <!-- 批次插入交易記錄 -->
    <insert id="batchInsert">
        INSERT INTO backtest_trades (
            trade_id, backtest_id, stock_id, stock_name,
            trade_type, trade_date, trade_price, shares, trade_amount,
            commission, tax, slippage, net_amount,
            signal_source, signal_id, signal_grade,
            exit_reason, entry_trade_id, holding_days, profit_loss, return_pct,
            position_before, position_after, cash_before, cash_after
        ) VALUES
        <foreach collection="trades" item="t" separator=",">
            (
                #{t.tradeId}, #{t.backtestId}, #{t.stockId}, #{t.stockName},
                #{t.tradeType}, #{t.tradeDate}, #{t.tradePrice}, #{t.shares}, #{t.tradeAmount},
                #{t.commission}, #{t.tax}, #{t.slippage}, #{t.netAmount},
                #{t.signalSource}, #{t.signalId}, #{t.signalGrade},
                #{t.exitReason}, #{t.entryTradeId}, #{t.holdingDays}, #{t.profitLoss}, #{t.returnPct},
                #{t.positionBefore}, #{t.positionAfter}, #{t.cashBefore}, #{t.cashAfter}
            )
        </foreach>
    </insert>

    <!-- 查詢交易清單 -->
    <select id="findByBacktestId" resultType="BacktestTrade">
        SELECT *
        FROM backtest_trades
        WHERE backtest_id = #{backtestId}
        <if test="stockId != null">
            AND stock_id = #{stockId}
        </if>
        <if test="tradeType != null">
            AND trade_type = #{tradeType}
        </if>
        <if test="startDate != null">
            AND trade_date >= #{startDate}
        </if>
        <if test="endDate != null">
            AND trade_date &lt;= #{endDate}
        </if>
        ORDER BY trade_date, id
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 統計交易數據 -->
    <select id="getTradeStatistics" resultType="TradeStatistics">
        SELECT
            COUNT(*) as total_trades,
            COUNT(*) FILTER (WHERE trade_type = 'BUY') as buy_trades,
            COUNT(*) FILTER (WHERE trade_type = 'SELL') as sell_trades,
            SUM(commission) as total_commission,
            SUM(tax) as total_tax,
            SUM(slippage) as total_slippage,
            COUNT(*) FILTER (WHERE profit_loss > 0) as winning_trades,
            COUNT(*) FILTER (WHERE profit_loss &lt; 0) as losing_trades,
            AVG(CASE WHEN profit_loss > 0 THEN profit_loss END) as avg_win,
            AVG(CASE WHEN profit_loss &lt; 0 THEN ABS(profit_loss) END) as avg_loss,
            MAX(profit_loss) as largest_win,
            MIN(profit_loss) as largest_loss,
            AVG(holding_days) FILTER (WHERE holding_days IS NOT NULL) as avg_holding_days
        FROM backtest_trades
        WHERE backtest_id = #{backtestId}
    </select>

    <!-- 各股績效統計 -->
    <select id="getPerformanceByStock" resultType="StockPerformance">
        SELECT
            stock_id,
            stock_name,
            COUNT(*) FILTER (WHERE trade_type = 'SELL') as trades,
            COUNT(*) FILTER (WHERE profit_loss > 0)::DECIMAL /
                NULLIF(COUNT(*) FILTER (WHERE trade_type = 'SELL'), 0) as win_rate,
            SUM(profit_loss) as total_pnl,
            AVG(return_pct) FILTER (WHERE return_pct IS NOT NULL) as avg_return
        FROM backtest_trades
        WHERE backtest_id = #{backtestId}
        GROUP BY stock_id, stock_name
        ORDER BY total_pnl DESC
    </select>

</mapper>
```

### 3.3 BacktestSnapshotMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.chris.fin_shark.m16.mapper.BacktestSnapshotMapper">

    <!-- 批次插入每日快照 -->
    <insert id="batchInsert">
        INSERT INTO backtest_daily_snapshots (
            backtest_id, snapshot_date, portfolio_value, cash, position_value,
            daily_return, cumulative_return, high_water_mark, drawdown,
            positions, benchmark_value, benchmark_return
        ) VALUES
        <foreach collection="snapshots" item="s" separator=",">
            (
                #{s.backtestId}, #{s.snapshotDate}, #{s.portfolioValue},
                #{s.cash}, #{s.positionValue},
                #{s.dailyReturn}, #{s.cumulativeReturn},
                #{s.highWaterMark}, #{s.drawdown},
                #{s.positions}::jsonb, #{s.benchmarkValue}, #{s.benchmarkReturn}
            )
        </foreach>
    </insert>

    <!-- 取得淨值曲線 -->
    <select id="getEquityCurve" resultType="EquityCurvePoint">
        SELECT
            snapshot_date as date,
            portfolio_value,
            cash,
            position_value,
            daily_return,
            cumulative_return,
            drawdown,
            benchmark_value,
            benchmark_return
        FROM backtest_daily_snapshots
        WHERE backtest_id = #{backtestId}
        <if test="interval == 'WEEKLY'">
            AND EXTRACT(DOW FROM snapshot_date) = 5
        </if>
        <if test="interval == 'MONTHLY'">
            AND snapshot_date = (
                SELECT MAX(snapshot_date)
                FROM backtest_daily_snapshots s2
                WHERE s2.backtest_id = backtest_daily_snapshots.backtest_id
                  AND DATE_TRUNC('month', s2.snapshot_date) = DATE_TRUNC('month', backtest_daily_snapshots.snapshot_date)
            )
        </if>
        ORDER BY snapshot_date
    </select>

    <!-- 取得最高水位與最低點 -->
    <select id="getExtremes" resultType="EquityExtremes">
        SELECT
            (SELECT snapshot_date FROM backtest_daily_snapshots
             WHERE backtest_id = #{backtestId}
             ORDER BY portfolio_value DESC LIMIT 1) as high_water_mark_date,
            (SELECT MAX(portfolio_value) FROM backtest_daily_snapshots
             WHERE backtest_id = #{backtestId}) as high_water_mark_value,
            (SELECT snapshot_date FROM backtest_daily_snapshots
             WHERE backtest_id = #{backtestId}
             ORDER BY portfolio_value ASC LIMIT 1) as low_point_date,
            (SELECT MIN(portfolio_value) FROM backtest_daily_snapshots
             WHERE backtest_id = #{backtestId}) as low_point_value
    </select>

    <!-- 計算月度報酬 -->
    <select id="getMonthlyReturns" resultType="MonthlyReturn">
        SELECT
            TO_CHAR(snapshot_date, 'YYYY') as year,
            TO_CHAR(snapshot_date, 'Mon') as month,
            (LAST_VALUE(cumulative_return) OVER (
                PARTITION BY DATE_TRUNC('month', snapshot_date)
                ORDER BY snapshot_date
                ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) - FIRST_VALUE(cumulative_return) OVER (
                PARTITION BY DATE_TRUNC('month', snapshot_date)
                ORDER BY snapshot_date
                ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            )) / (1 + FIRST_VALUE(cumulative_return) OVER (
                PARTITION BY DATE_TRUNC('month', snapshot_date)
                ORDER BY snapshot_date
                ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            )) as monthly_return
        FROM backtest_daily_snapshots
        WHERE backtest_id = #{backtestId}
          AND snapshot_date = (
              SELECT MAX(snapshot_date)
              FROM backtest_daily_snapshots s2
              WHERE s2.backtest_id = backtest_daily_snapshots.backtest_id
                AND DATE_TRUNC('month', s2.snapshot_date) = DATE_TRUNC('month', backtest_daily_snapshots.snapshot_date)
          )
        ORDER BY snapshot_date
    </select>

</mapper>
```

---

## 4. 資料關聯圖

```
┌─────────────────────────────────────────────────────────────────┐
│                      M16 資料關聯圖                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────┐                                        │
│  │  backtest_tasks     │                                        │
│  │  (回測任務)          │                                        │
│  └──────────┬──────────┘                                        │
│             │                                                    │
│    ┌────────┼────────┬────────────┬────────────┐                │
│    │        │        │            │            │                │
│    ▼        ▼        ▼            ▼            ▼                │
│ ┌──────┐ ┌──────┐ ┌──────┐   ┌──────┐    ┌──────┐              │
│ │trades│ │daily │ │results│  │draw  │    │optim │              │
│ │      │ │snap  │ │       │  │downs │    │izat  │              │
│ └──────┘ └──────┘ └──────┘   └──────┘    └───┬──┘              │
│                                              │                  │
│                                              ▼                  │
│                                         ┌──────┐               │
│                                         │optim │               │
│                                         │result│               │
│                                         └──────┘               │
│                                                                 │
│  獨立表：                                                        │
│  ┌──────────────┐  ┌──────────────┐                            │
│  │ templates    │  │ comparisons  │                            │
│  │ (回測範本)    │  │ (策略比較)    │                            │
│  └──────────────┘  └──────────────┘                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 相關文檔

- [M16 功能需求](../specs/functional/M16-回測系統功能需求.md)
- [M16 API 規格](../specs/api/M16-API規格.md)
- [M16 ERD](./erd/M16-ERD.md)

---

**文件維護者**: 後端工程師
**最後更新**: 2026-01-15
**下次審核**: 2026-04-15
