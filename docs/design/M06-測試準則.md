# M06-資料管理模組測試準則

> **文件編號**: TEST-M06
> **模組名稱**: 資料管理模組
> **版本**: v2.1
> **最後更新**: 2026-01-15
> **狀態**: Active

---

## 10. 測試準則

### 10.1 單元測試

#### 10.1.1 Repository 層測試

**測試目標**: 驗證資料庫操作正確性

**測試場景**:
- 測試 CRUD 基本操作
- 測試唯一鍵約束
- 測試外鍵約束
- 測試查詢方法（findBy...）
- 測試 JSONB 欄位讀寫
- 測試陣列欄位讀寫

**測試範例**:
```
測試: StockRepository.findByStockId()
Given: 資料庫中存在 stock_id='2330'
When: 呼叫 findByStockId("2330")
Then: 應返回對應的 Stock 物件

測試: StockPriceRepository.saveWithDuplicateDate()
Given: 已存在 (stock_id='2330', trade_date='2024-12-24') 的記錄
When: 嘗試插入相同 (stock_id, trade_date) 的新記錄（使用 UPSERT）
Then: 應更新現有記錄而非插入新記錄

測試: StockRepository.findByTag()
Given: stocks 表中有股票標籤包含 'AI'
When: 呼叫 findByTag("AI")
Then: 應返回所有包含 'AI' 標籤的股票
```

**測試工具**:
- JUnit 5
- Spring Boot Test
- Testcontainers（啟動 PostgreSQL 容器）

---

#### 10.1.2 Service 層測試

**測試目標**: 驗證業務邏輯正確性

**測試場景**:
- 測試業務邏輯正確性
- 測試異常處理
- 測試交易邊界
- Mock 外部依賴（Repository, API Client）

**測試範例**:
```
測試: StockPriceSyncService.syncStockPrices()
Given: Yahoo Finance API 返回正常資料
When: 執行 syncStockPrices("2024-12-24")
Then: 
  - 資料應正確儲存到資料庫
  - Redis 快取應更新
  - Job 執行記錄應為 SUCCESS

測試: StockPriceSyncService.syncStockPrices_ValidationFail()
Given: Yahoo Finance API 返回違反四價關係的資料
When: 執行 syncStockPrices("2024-12-24")
Then:
  - 該筆資料不應儲存
  - 錯誤應記錄到 data_quality_issues
  - Job 執行記錄應包含失敗明細

測試: DataQualityService.validateStockPrice_FourPriceError()
Given: 準備違反四價關係的股價資料（high < low）
When: 執行 validateStockPrice(price)
Then:
  - 驗證應失敗
  - 返回錯誤訊息包含 "四價關係不一致"
```

**Mock 策略**:
- Mock 外部 API Client（Yahoo Finance, 證交所）
- Mock Repository 層
- 使用真實 Redis（Testcontainers）

---

### 10.1.3 P0/P1 已實作測試

> **新增於**: 2026-01-15

以下為 P0/P1 功能已完成的測試：

#### Repository 層測試

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| StockRepositoryTest | 4 個測試 | CRUD、市場類型查詢、活躍狀態篩選、存在性檢查 |

```
測試: testSaveAndFindById
Given: 準備一筆股票資料（2330 台積電）
When: 執行 save() 和 findById()
Then:
  - 儲存成功
  - 查詢結果與儲存資料一致

測試: testFindByMarketType
Given: 資料庫中有 TWSE 和 OTC 股票
When: 執行 findByMarketType("TWSE")
Then:
  - 只返回 TWSE 市場的股票
  - 數量與預期一致

測試: testFindByIsActiveTrue
Given: 資料庫中有活躍和非活躍股票
When: 執行 findByIsActiveTrue()
Then:
  - 只返回活躍股票
  - 非活躍股票不在結果中

測試: testExistsByStockId
Given: 資料庫中存在股票 2330
When: 執行 existsByStockId()
Then:
  - 2330 返回 true
  - 9999 返回 false
```

#### Service 層測試

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| StockServiceTest | 3 個測試 | 查詢成功、查詢不存在、新增成功 |

```
測試: testGetStockById_Success
Given: Repository 返回股票資料
When: 執行 getStockById("2330")
Then:
  - 返回正確的 StockDTO
  - 呼叫 Repository 和 Converter

測試: testGetStockById_NotFound
Given: Repository 返回 empty
When: 執行 getStockById("9999")
Then:
  - 拋出 StockNotFoundException
  - Converter 未被呼叫

測試: testCreateStock_Success
Given: 股票不存在
When: 執行 createStock()
Then:
  - 成功建立股票
  - 返回正確的 StockDTO
```

#### 新增 Service 層測試（2026-01-15）

| 測試類別 | 測試項目 | 驗證重點 |
|---------|---------|---------|
| StockPriceSyncServiceTest | 10 個測試 | 交易日判斷、同步流程、資料轉換、錯誤處理 |
| DataQualityServiceTest | 11 個測試 | 檢核規則查詢、問題查詢、品質分數計算 |
| TradingCalendarServiceTest | 10 個測試 | 交易日查詢、日期範圍、上下交易日 |
| MarketDataQueryServiceTest | 9 個測試 | 股價查詢、法人查詢、融資融券查詢 |

```
測試: shouldSkipSyncOnNonTradingDay
Given: 指定日期為非交易日
When: 執行 syncStockPricesForDate()
Then:
  - 返回 CANCELLED 狀態
  - 錯誤訊息包含 "非交易日"
  - 不呼叫外部 API

測試: shouldCalculateQualitySummary
Given: 資料庫中有品質問題記錄
When: 執行 getQualitySummary()
Then:
  - 正確統計各嚴重性問題數量
  - 品質分數計算正確
  - 分數範圍在 0-100 之間

測試: shouldThrowWhenStockNotFound
Given: 查詢不存在的股票代碼
When: 執行 queryStockPrices("9999")
Then:
  - 拋出 StockNotFoundException
  - 不查詢股價資料
```

#### 待補充測試

| 功能 | 待補充測試 | 優先級 |
|------|-----------|-------|
| 法人同步 | InstitutionalTradingSyncServiceTest | 中 |
| 融資融券 | MarginTradingSyncServiceTest | 中 |
| 財報同步 | FinancialStatementSyncServiceTest | 中 |
| 資料補齊 | DataRepairServiceTest | 低 |

---

### 10.2 整合測試

#### 10.2.1 資料庫整合測試

**測試環境**: 使用 Testcontainers 啟動 PostgreSQL 容器

**測試場景**:
- 測試資料插入與查詢
- 測試交易回滾
- 測試索引效能
- 測試分區功能
- 測試 JSONB 查詢
- 測試 GENERATED COLUMN 計算

**測試範例**:
```
測試: 股價資料批次插入效能
Given: 準備 1000 筆股價資料
When: 使用 MyBatis 批次 UPSERT 插入
Then:
  - 執行時間 < 1 秒
  - 所有資料正確儲存
  - 唯一鍵約束生效（重複執行不產生重複資料）

測試: JSONB 查詢效能
Given: financial_statements 表有 10000 筆資料
When: 查詢 ROE > 15% 的股票
Then:
  - 查詢時間 < 100ms
  - 結果正確

測試: 分區裁剪
Given: stock_prices 表有 2023-2025 年資料（分區）
When: 查詢 2024 年資料
Then:
  - 只掃描 stock_prices_2024 分區
  - 查詢時間 < 2023-2025 全表掃描時間的 1/3
```

---

#### 10.2.2 外部 API 整合測試

**測試環境**: 使用 WireMock 模擬外部 API

**測試場景**:
- 測試正常回應
- 測試超時
- 測試錯誤回應（4xx, 5xx）
- 測試重試機制
- 測試備援切換

**測試範例**:
```
測試: Yahoo Finance API 超時重試
Given: WireMock 模擬 API 第 1-2 次請求超時，第 3 次成功
When: 執行 fetchStockPrice("2330")
Then:
  - 應重試 3 次
  - 最終返回成功結果
  - 重試延遲符合 Exponential Backoff（1s, 2s, 4s）

測試: 備援資料源切換
Given: WireMock 模擬 Yahoo Finance API 持續失敗
When: 執行 fetchStockPrice("2330")
Then:
  - 應自動切換至證交所 API
  - 最終返回成功結果
  - 記錄切換事件
```

---

### 10.3 API 測試

**測試工具**: MockMvc 或 RestAssured

**測試場景**:
- 測試成功回應格式（遵守總綱 4.4 API 規範）
- 測試錯誤回應格式
- 測試參數驗證
- 測試權限控制（Spring Security）
- 測試分頁功能

**測試範例**:
```
測試: GET /api/stocks/2330/prices
Given: 資料庫中存在 2330 的股價資料
When: GET /api/stocks/2330/prices?start_date=2024-01-01&end_date=2024-12-24
Then:
  - HTTP 200
  - Response 格式符合總綱 API 規範
  - 返回資料筆數正確
  - 日期範圍正確

測試: GET /api/stocks/9999（不存在的股票）
When: GET /api/stocks/9999
Then:
  - HTTP 404
  - error_code = "M06_STOCK_001"
  - error_message 清楚說明問題

測試: 參數驗證
When: GET /api/stocks/2330/prices?start_date=2024-13-01
Then:
  - HTTP 400
  - error_code = "M06_PARAM_001"
  - error_detail 說明日期格式錯誤
```

---

### 10.4 效能測試

**測試工具**: JMeter 或 Gatling

**測試場景**:
- 併發查詢測試（100-500 req/s）
- 大量資料查詢測試（查詢 5 年股價）
- 快取命中率測試
- Job 執行時間測試

**測試範例**:
```
測試: 熱門股票查詢效能
Given: 100 個併發使用者
When: 每秒查詢 /api/stocks/2330/prices（最近 30 天）
Then:
  - P95 回應時間 < 100ms
  - 快取命中率 > 80%
  - 無錯誤發生

測試: 股價同步 Job 效能
Given: 1800 檔股票需要同步
When: 執行 SYNC_STOCK_PRICES Job
Then:
  - 執行時間 < 5 分鐘
  - 成功率 > 90%
  - 資料庫連線池未耗盡
```

---

### 10.5 資料品質測試

**測試場景**:
- 測試資料驗證規則
- 測試資料完整性檢查
- 測試資料一致性檢查

**測試範例**:
```
測試: 股價四價關係驗證
Given: 準備違反四價關係的測試資料（high < low）
When: 執行資料驗證
Then:
  - 驗證失敗
  - 資料不應儲存
  - 錯誤記錄到 data_quality_issues

測試: 財報資產負債平衡檢查
Given: 準備 total_assets ≠ total_liabilities + equity 的測試資料
When: 執行資料驗證
Then:
  - 驗證失敗
  - 標記為需人工確認
  - 記錄到 data_quality_issues
```

---

### 10.6 測試覆蓋率目標

| 層級 | 覆蓋率目標 | 說明 |
|-----|----------|------|
| Repository 層 | > 90% | 重要的資料庫操作必須測試 |
| Service 層 | > 80% | 核心業務邏輯必須測試 |
| Controller 層 | > 70% | 主要 API 端點必須測試 |
| 整體 | > 75% | 整體程式碼覆蓋率 |

**測試優先級**:
1. P0 功能：100% 測試覆蓋（如股價同步、資料驗證）
2. P1 功能：> 80% 測試覆蓋
3. P2 功能：> 60% 測試覆蓋

---



---

## 📚 相關文檔

- [M06 功能需求](../specs/functional/M06-資料管理功能需求.md)
- [M06 API規格](../specs/technical/api/M06-API規格.md)
- [M06 業務流程](./M06-業務流程.md)
- [開發準則](../specs/technical/00-開發準則.md)

---

**文件維護者**: 測試工程師  
**最後更新**: 2025-12-31  
**下次審核**: 2026-02-28
