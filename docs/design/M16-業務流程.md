# M16-回測系統 業務流程

> **文件編號**: FLOW-M16
> **模組名稱**: 回測系統 (Backtesting System)
> **版本**: v1.0
> **最後更新**: 2026-01-15
> **狀態**: Draft

---

## 1. 核心流程總覽

```
┌─────────────────────────────────────────────────────────────────┐
│                    M16 回測系統核心流程                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐     │
│  │ 1.建立   │   │ 2.執行   │   │ 3.績效   │   │ 4.報告   │     │
│  │   回測   │ → │   回測   │ → │   計算   │ → │   產生   │     │
│  └──────────┘   └──────────┘   └──────────┘   └──────────┘     │
│                                                                  │
│  進階功能：                                                       │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐                    │
│  │ 5.參數   │   │ 6.策略   │   │ 7.滾動   │                    │
│  │   最佳化 │   │   比較   │   │   回測   │                    │
│  └──────────┘   └──────────┘   └──────────┘                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 回測建立流程

### 2.1 流程圖

```
┌─────────────────────────────────────────────────────────────────┐
│                      回測建立流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────┐                                            │
│  │    用戶請求      │                                            │
│  │  建立回測任務    │                                            │
│  └────────┬────────┘                                            │
│           │                                                      │
│           ▼                                                      │
│  ┌─────────────────┐                                            │
│  │   參數驗證       │                                            │
│  │  • 期間合法性    │                                            │
│  │  • 股票數量限制  │                                            │
│  │  • 資金設定      │                                            │
│  └────────┬────────┘                                            │
│           │                                                      │
│     ┌─────┴─────┐                                               │
│     │ 驗證通過？ │                                               │
│     └─────┬─────┘                                               │
│       Yes │  No──────────────────┐                              │
│           │                       │                              │
│           ▼                       ▼                              │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │  檢查歷史數據    │    │   回傳錯誤       │                    │
│  │  是否充足       │    │   M16-002       │                    │
│  └────────┬────────┘    └─────────────────┘                    │
│           │                                                      │
│     ┌─────┴─────┐                                               │
│     │ 數據充足？ │                                               │
│     └─────┬─────┘                                               │
│       Yes │  No──────────────────┐                              │
│           │                       │                              │
│           ▼                       ▼                              │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │  建立回測任務    │    │   回傳錯誤       │                    │
│  │  status=CREATED │    │   M16-006       │                    │
│  └────────┬────────┘    └─────────────────┘                    │
│           │                                                      │
│           ▼                                                      │
│  ┌─────────────────┐                                            │
│  │  估算執行時間    │                                            │
│  │  回傳任務資訊    │                                            │
│  └─────────────────┘                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 參數驗證規則

| 驗證項目 | 規則 | 錯誤碼 |
|---------|------|-------|
| 回測期間 | 開始日期 < 結束日期，不超過 10 年 | M16-003 |
| 股票數量 | 1 ~ 200 檔 | M16-004 |
| 初始資金 | > 0，足以執行至少一筆交易 | M16-005 |
| 歷史數據 | 回測期間必須有足夠的價格數據 | M16-006 |
| 策略存在 | 若指定策略 ID，必須存在 | M16-007 |

---

## 3. 回測執行流程

### 3.1 主流程圖

```
┌─────────────────────────────────────────────────────────────────┐
│                      回測執行主流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    初始化階段                            │    │
│  │  ┌────────────────────────────────────────────────────┐ │    │
│  │  │ 1. 載入回測設定                                     │ │    │
│  │  │ 2. 載入歷史價格數據 (M06)                          │ │    │
│  │  │ 3. 載入技術指標數據 (M07)                          │ │    │
│  │  │ 4. 載入策略/信號數據 (M11/M13)                     │ │    │
│  │  │ 5. 初始化虛擬投組 (現金 = 初始資金)                │ │    │
│  │  └────────────────────────────────────────────────────┘ │    │
│  └────────────────────────┬────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                  逐日迭代 (Day Loop)                     │    │
│  │                                                          │    │
│  │  for each trading_day in [start_date, end_date]:        │    │
│  │                                                          │    │
│  │    ┌────────────────────────────────────────────────┐   │    │
│  │    │ Step 1: 更新持倉市值                            │   │    │
│  │    │   • 取得當日收盤價                              │   │    │
│  │    │   • 計算各持股市值                              │   │    │
│  │    │   • 計算投組總價值                              │   │    │
│  │    └────────────────────────────────────────────────┘   │    │
│  │                         │                                │    │
│  │                         ▼                                │    │
│  │    ┌────────────────────────────────────────────────┐   │    │
│  │    │ Step 2: 檢查出場條件                            │   │    │
│  │    │   • 停損檢查 (price <= entry * (1 - stopLoss)) │   │    │
│  │    │   • 停利檢查 (price >= entry * (1 + takeProfit))│   │    │
│  │    │   • 移動停損檢查                                │   │    │
│  │    │   • 最大持有天數檢查                            │   │    │
│  │    │   → 觸發則執行賣出                              │   │    │
│  │    └────────────────────────────────────────────────┘   │    │
│  │                         │                                │    │
│  │                         ▼                                │    │
│  │    ┌────────────────────────────────────────────────┐   │    │
│  │    │ Step 3: 掃描進場信號                            │   │    │
│  │    │   • 依信號來源掃描 (M11 策略 / M13 信號)       │   │    │
│  │    │   • 檢查是否已持有該股                          │   │    │
│  │    │   • 檢查持股數量上限                            │   │    │
│  │    │   • 檢查可用資金                                │   │    │
│  │    └────────────────────────────────────────────────┘   │    │
│  │                         │                                │    │
│  │                         ▼                                │    │
│  │    ┌────────────────────────────────────────────────┐   │    │
│  │    │ Step 4: 執行交易                                │   │    │
│  │    │   • 計算部位大小                                │   │    │
│  │    │   • 計算交易成本 (手續費 + 稅 + 滑價)          │   │    │
│  │    │   • 更新持倉與現金                              │   │    │
│  │    │   • 記錄交易明細                                │   │    │
│  │    └────────────────────────────────────────────────┘   │    │
│  │                         │                                │    │
│  │                         ▼                                │    │
│  │    ┌────────────────────────────────────────────────┐   │    │
│  │    │ Step 5: 記錄每日快照                            │   │    │
│  │    │   • 投組價值                                    │   │    │
│  │    │   • 現金/持倉價值                               │   │    │
│  │    │   • 日報酬/累計報酬                             │   │    │
│  │    │   • 回撤計算                                    │   │    │
│  │    └────────────────────────────────────────────────┘   │    │
│  │                                                          │    │
│  └────────────────────────┬────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    結算階段                              │    │
│  │  ┌────────────────────────────────────────────────────┐ │    │
│  │  │ 1. 強制平倉剩餘持股 (exit_reason = FORCE_CLOSE)   │ │    │
│  │  │ 2. 計算最終績效指標                                │ │    │
│  │  │ 3. 分析回撤事件                                    │ │    │
│  │  │ 4. 產生回測報告                                    │ │    │
│  │  │ 5. 更新狀態為 COMPLETED                            │ │    │
│  │  └────────────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 交易執行細節

```
┌─────────────────────────────────────────────────────────────────┐
│                      交易執行流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────┐                                       │
│  │    收到交易信號       │                                       │
│  │  (BUY / SELL)        │                                       │
│  └───────────┬──────────┘                                       │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────┐                                       │
│  │   決定成交價格        │                                       │
│  │  price = close_price │                                       │
│  │        × (1 ± slippage)                                      │
│  └───────────┬──────────┘                                       │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────┐                                       │
│  │   計算部位大小        │                                       │
│  │                       │                                       │
│  │  FIXED_AMOUNT:        │                                       │
│  │    shares = floor(fixedAmount / price)                       │
│  │                       │                                       │
│  │  PERCENT:             │                                       │
│  │    shares = floor(portfolioValue × pct / price)              │
│  │                       │                                       │
│  │  EQUAL_WEIGHT:        │                                       │
│  │    shares = floor(portfolioValue / maxPositions / price)     │
│  │                       │                                       │
│  └───────────┬──────────┘                                       │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────┐                                       │
│  │   計算交易成本        │                                       │
│  │                       │                                       │
│  │  amount = price × shares                                     │
│  │  commission = amount × commissionRate                        │
│  │  tax = amount × taxRate (賣出時)                             │
│  │  slippage_cost = amount × slippage                           │
│  │                       │                                       │
│  │  BUY:  netAmount = amount + commission + slippage_cost       │
│  │  SELL: netAmount = amount - commission - tax - slippage_cost │
│  └───────────┬──────────┘                                       │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────┐                                       │
│  │   更新投組狀態        │                                       │
│  │                       │                                       │
│  │  BUY:                 │                                       │
│  │    cash -= netAmount  │                                       │
│  │    positions[stock] += shares                                │
│  │                       │                                       │
│  │  SELL:                │                                       │
│  │    cash += netAmount  │                                       │
│  │    positions[stock] -= shares                                │
│  └───────────┬──────────┘                                       │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────┐                                       │
│  │   記錄交易明細        │                                       │
│  │  → backtest_trades   │                                       │
│  └──────────────────────┘                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 績效計算流程

### 4.1 績效指標計算

```
┌─────────────────────────────────────────────────────────────────┐
│                      績效計算流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  輸入：每日快照 (daily_snapshots)、交易記錄 (trades)            │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  基本報酬計算                             │   │
│  │                                                           │   │
│  │  total_return = (final_value - initial_capital)          │   │
│  │                 / initial_capital                         │   │
│  │                                                           │   │
│  │  annualized_return = (1 + total_return)^(252/trading_days)│   │
│  │                      - 1                                  │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  風險指標計算                             │   │
│  │                                                           │   │
│  │  daily_returns[] = (value[t] - value[t-1]) / value[t-1]  │   │
│  │                                                           │   │
│  │  volatility = std(daily_returns) × sqrt(252)             │   │
│  │                                                           │   │
│  │  downside_returns = daily_returns.filter(r < 0)          │   │
│  │  downside_vol = std(downside_returns) × sqrt(252)        │   │
│  │                                                           │   │
│  │  max_drawdown = max((peak - trough) / peak)              │   │
│  │                                                           │   │
│  │  VaR_95 = percentile(daily_returns, 5)                   │   │
│  │  CVaR_95 = mean(daily_returns.filter(r <= VaR_95))       │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                風險調整報酬計算                           │   │
│  │                                                           │   │
│  │  risk_free_rate = 0.02  (假設年化 2%)                    │   │
│  │                                                           │   │
│  │  sharpe_ratio = (annualized_return - risk_free_rate)     │   │
│  │                 / volatility                              │   │
│  │                                                           │   │
│  │  sortino_ratio = (annualized_return - risk_free_rate)    │   │
│  │                  / downside_vol                           │   │
│  │                                                           │   │
│  │  calmar_ratio = annualized_return / max_drawdown         │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  交易統計計算                             │   │
│  │                                                           │   │
│  │  winning_trades = trades.filter(pnl > 0).count()         │   │
│  │  losing_trades = trades.filter(pnl < 0).count()          │   │
│  │                                                           │   │
│  │  win_rate = winning_trades / total_trades                │   │
│  │                                                           │   │
│  │  avg_win = mean(trades.filter(pnl > 0).pnl)              │   │
│  │  avg_loss = mean(trades.filter(pnl < 0).abs(pnl))        │   │
│  │                                                           │   │
│  │  payoff_ratio = avg_win / avg_loss                       │   │
│  │                                                           │   │
│  │  profit_factor = sum(wins) / sum(losses)                 │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  基準比較計算                             │   │
│  │                                                           │   │
│  │  benchmark_returns[] = 基準指數日報酬                    │   │
│  │                                                           │   │
│  │  beta = cov(portfolio_returns, benchmark_returns)        │   │
│  │         / var(benchmark_returns)                          │   │
│  │                                                           │   │
│  │  alpha = annualized_return                               │   │
│  │          - (risk_free + beta × (benchmark_ann - risk_free))│   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 回撤分析

```
┌─────────────────────────────────────────────────────────────────┐
│                      回撤分析流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  輸入：每日投組價值序列 values[]                                 │
│                                                                  │
│  Algorithm: 識別回撤事件                                         │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  high_water_mark = values[0]                                    │
│  drawdown_events = []                                           │
│  current_drawdown = null                                        │
│                                                                  │
│  for i in 1 to len(values):                                     │
│                                                                  │
│    if values[i] > high_water_mark:                              │
│      # 創新高                                                    │
│      high_water_mark = values[i]                                │
│                                                                  │
│      if current_drawdown is not null:                           │
│        # 回撤結束，記錄恢復日期                                  │
│        current_drawdown.recovery_date = dates[i]                │
│        drawdown_events.append(current_drawdown)                 │
│        current_drawdown = null                                  │
│                                                                  │
│    else:                                                        │
│      # 在回撤中                                                  │
│      drawdown = (high_water_mark - values[i]) / high_water_mark │
│                                                                  │
│      if current_drawdown is null:                               │
│        # 新回撤開始                                              │
│        current_drawdown = {                                     │
│          start_date: dates[i-1],                                │
│          peak_value: high_water_mark                            │
│        }                                                        │
│                                                                  │
│      if values[i] < current_drawdown.trough_value:              │
│        # 更新谷底                                                │
│        current_drawdown.trough_value = values[i]                │
│        current_drawdown.end_date = dates[i]                     │
│        current_drawdown.depth = drawdown                        │
│                                                                  │
│  # 排序並取 Top N                                                │
│  drawdown_events.sort_by(depth, DESC)                           │
│  return drawdown_events[:10]                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 參數最佳化流程

### 5.1 網格搜尋流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    參數最佳化流程 (Grid Search)                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────┐                                        │
│  │   載入基準回測設定   │                                        │
│  └──────────┬──────────┘                                        │
│             │                                                    │
│             ▼                                                    │
│  ┌─────────────────────┐                                        │
│  │   產生參數組合       │                                        │
│  │                      │                                        │
│  │  parameters:         │                                        │
│  │    stopLoss: [0.05, 0.06, ..., 0.15]  (11個)                │
│  │    takeProfit: [0.10, 0.12, ..., 0.30] (11個)               │
│  │    maxHoldingDays: [10, 20, 30, 60]    (4個)                │
│  │                      │                                        │
│  │  total = 11 × 11 × 4 = 484 組合                             │
│  │                      │                                        │
│  └──────────┬──────────┘                                        │
│             │                                                    │
│             ▼                                                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  平行執行回測                             │   │
│  │                                                           │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐       ┌─────────┐  │   │
│  │  │組合 1   │ │組合 2   │ │組合 3   │  ...  │組合 N   │  │   │
│  │  │回測     │ │回測     │ │回測     │       │回測     │  │   │
│  │  └────┬────┘ └────┬────┘ └────┬────┘       └────┬────┘  │   │
│  │       │           │           │                 │        │   │
│  │       ▼           ▼           ▼                 ▼        │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐       ┌─────────┐  │   │
│  │  │績效指標 │ │績效指標 │ │績效指標 │  ...  │績效指標 │  │   │
│  │  └─────────┘ └─────────┘ └─────────┘       └─────────┘  │   │
│  │                                                           │   │
│  └──────────────────────────┬────────────────────────────────┘   │
│                             │                                    │
│                             ▼                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    結果彙整                              │    │
│  │                                                          │    │
│  │  1. 檢查約束條件 (minTrades >= 20, maxDrawdown <= 0.25) │    │
│  │  2. 依目標指標排序 (e.g., sharpeRatio DESC)             │    │
│  │  3. 記錄各組合結果                                       │    │
│  │  4. 標記最佳組合                                         │    │
│  │  5. 分析參數敏感度                                       │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 參數敏感度分析

```
┌─────────────────────────────────────────────────────────────────┐
│                    參數敏感度分析                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  目的：了解各參數對績效的影響程度                                │
│                                                                  │
│  方法：計算參數值與目標指標的相關係數                            │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                                                           │   │
│  │  stopLoss vs Sharpe Ratio                                │   │
│  │                                                           │   │
│  │  Sharpe │                                                 │   │
│  │   1.5   │        ●●●                                     │   │
│  │   1.4   │      ●     ●                                   │   │
│  │   1.3   │    ●         ●                                 │   │
│  │   1.2   │  ●             ●                               │   │
│  │   1.1   │●                 ●                             │   │
│  │         └────────────────────────                        │   │
│  │           0.05  0.07  0.10  0.15   stopLoss              │   │
│  │                                                           │   │
│  │  分析結果：                                               │   │
│  │  • 相關係數: -0.35 (負相關)                              │   │
│  │  • 最佳範圍: 0.06 ~ 0.08                                 │   │
│  │  • 影響程度: HIGH                                        │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  輸出：                                                          │
│  {                                                               │
│    "stopLoss": {"impact": "HIGH", "optimalRange": [0.06, 0.08]},│
│    "takeProfit": {"impact": "MEDIUM", "optimalRange": [0.18, 0.22]},
│    "maxHoldingDays": {"impact": "LOW", "optimalRange": [15, 25]} │
│  }                                                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 策略比較流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      策略比較流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────┐                                        │
│  │  輸入回測 ID 清單    │                                        │
│  │  [BT_001, BT_002, BT_003]                                   │
│  └──────────┬──────────┘                                        │
│             │                                                    │
│             ▼                                                    │
│  ┌─────────────────────┐                                        │
│  │   載入各回測結果     │                                        │
│  │   backtest_results  │                                        │
│  └──────────┬──────────┘                                        │
│             │                                                    │
│             ▼                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    指標比較                              │    │
│  │                                                          │    │
│  │  ┌──────────┬──────────┬──────────┬──────────┐          │    │
│  │  │  指標     │  BT_001  │  BT_002  │  BT_003  │          │    │
│  │  ├──────────┼──────────┼──────────┼──────────┤          │    │
│  │  │ 總報酬   │   35%    │   28%    │   22%    │          │    │
│  │  │ Sharpe   │   1.45   │   1.10   │   0.95   │          │    │
│  │  │ 最大回撤 │  -12%    │  -15%    │  -18%    │          │    │
│  │  │ 勝率     │   62%    │   52%    │   48%    │          │    │
│  │  └──────────┴──────────┴──────────┴──────────┘          │    │
│  │                                                          │    │
│  └──────────────────────────┬───────────────────────────────┘    │
│                             │                                    │
│                             ▼                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    排名計算                              │    │
│  │                                                          │    │
│  │  byTotalReturn: [BT_001, BT_002, BT_003]                │    │
│  │  bySharpeRatio: [BT_001, BT_002, BT_003]                │    │
│  │  byMaxDrawdown: [BT_001, BT_002, BT_003]                │    │
│  │                                                          │    │
│  └──────────────────────────┬───────────────────────────────┘    │
│                             │                                    │
│                             ▼                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                  相關性分析                              │    │
│  │                                                          │    │
│  │  計算各策略日報酬的相關係數矩陣：                        │    │
│  │                                                          │    │
│  │        BT_001  BT_002  BT_003                           │    │
│  │  BT_001  1.00    0.65    0.42                           │    │
│  │  BT_002  0.65    1.00    0.58                           │    │
│  │  BT_003  0.42    0.58    1.00                           │    │
│  │                                                          │    │
│  │  用途：評估策略組合的分散效果                            │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 引擎元件架構

```
┌─────────────────────────────────────────────────────────────────┐
│                    BacktestEngine 元件架構                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      BacktestEngine                        │  │
│  │                                                            │  │
│  │   + execute(BacktestTask task): BacktestResult            │  │
│  │   + cancel(String backtestId): void                       │  │
│  │   + getProgress(String backtestId): Progress              │  │
│  │                                                            │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │                    Components                        │  │  │
│  │  │                                                      │  │  │
│  │  │  ┌──────────────┐    ┌──────────────┐              │  │  │
│  │  │  │ DataLoader   │    │ SignalScanner│              │  │  │
│  │  │  │              │    │              │              │  │  │
│  │  │  │ • loadPrices │    │ • scanEntry  │              │  │  │
│  │  │  │ • loadSignals│    │ • scanExit   │              │  │  │
│  │  │  └──────────────┘    └──────────────┘              │  │  │
│  │  │                                                      │  │  │
│  │  │  ┌──────────────┐    ┌──────────────┐              │  │  │
│  │  │  │ Portfolio    │    │TradeExecutor │              │  │  │
│  │  │  │              │    │              │              │  │  │
│  │  │  │ • positions  │    │ • executeBuy │              │  │  │
│  │  │  │ • cash       │    │ • executeSell│              │  │  │
│  │  │  │ • getValue() │    │ • calcCost() │              │  │  │
│  │  │  └──────────────┘    └──────────────┘              │  │  │
│  │  │                                                      │  │  │
│  │  │  ┌──────────────┐    ┌──────────────┐              │  │  │
│  │  │  │ RiskChecker  │    │ MetricsCalc  │              │  │  │
│  │  │  │              │    │              │              │  │  │
│  │  │  │ • stopLoss   │    │ • sharpe     │              │  │  │
│  │  │  │ • takeProfit │    │ • drawdown   │              │  │  │
│  │  │  │ • trailing   │    │ • winRate    │              │  │  │
│  │  │  └──────────────┘    └──────────────┘              │  │  │
│  │  │                                                      │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 相關文檔

- [M16 功能需求](../specs/functional/M16-回測系統功能需求.md)
- [M16 API 規格](../specs/api/M16-API規格.md)
- [M16 資料庫設計](./M16-資料庫設計.md)
- [M16 ERD](./erd/M16-ERD.md)

---

**文件維護者**: 後端工程師
**最後更新**: 2026-01-15
**下次審核**: 2026-04-15
