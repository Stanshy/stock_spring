# M07-技術分析模組效能考量

> **文件編號**: PERF-M07  
> **模組名稱**: 技術分析模組  
> **版本**: v2.0  
> **最後更新**: 2025-12-31  
> **狀態**: Draft

---

## 9. 效能考量

### 9.1 效能目標

| 指標 | 目標值 | 測量方式 | 說明 |
|-----|-------|---------|------|
| API 回應時間（單一股票） | P95 < 150ms | APM 監控 | 含快取命中 |
| API 回應時間（批次查詢） | P95 < 500ms | APM 監控 | 50 檔股票 |
| 基礎指標計算 Job 執行時間 | < 20 分鐘 | Job 執行記錄 | 1800 檔股票，11 個指標 |
| 進階指標計算 Job 執行時間 | < 25 分鐘 | Job 執行記錄 | 1800 檔股票，20 個指標 |
| 快取命中率 | > 85% | Redis 統計 | 熱門股票 |
| 資料庫查詢時間 | < 80ms | 慢查詢日誌 | 單表查詢，有索引 |
| JSONB 查詢時間 | < 120ms | 慢查詢日誌 | 使用 GIN 索引 |
| 單檔股票指標計算時間 | < 250ms | 計算引擎統計 | pandas-ta 計算 |

---

### 9.2 效能優化策略

#### 9.2.1 資料庫優化

**索引優化**:
- 所有常用查詢欄位都建立索引
- GIN 索引加速 JSONB 查詢
- 複合索引順序：(stock_id, calculation_date)
- 定期執行 `ANALYZE` 更新統計資訊

**查詢優化**:
```sql
-- 不良範例：循環查詢
FOR EACH stock IN stock_list:
    SELECT * FROM technical_indicators WHERE stock_id = stock;
END FOR

-- 良好範例：批次查詢
SELECT * FROM technical_indicators 
WHERE stock_id IN ('2330', '2317', '2454', ...)
  AND calculation_date = '2024-12-24';
```

**JSONB 查詢優化**:
```sql
-- 使用 GIN 索引加速
SELECT * FROM technical_indicators 
WHERE trend_indicators ? 'ma'  -- 檢查鍵存在
  AND (trend_indicators->'ma'->>'ma5')::numeric > 100;

-- 使用冗餘欄位加速常用查詢
SELECT * FROM technical_indicators 
WHERE ma5 > 100  -- 直接查詢冗餘欄位，更快
  AND calculation_date = '2024-12-24';
```

**分區優化**:
- technical_indicators 表按年份分區
- 查詢時自動裁剪不相關分區
- 範例：查詢 2024 年資料，只掃描 technical_indicators_2024 分區

---

#### 9.2.2 計算引擎優化

**批次計算**:
- 使用批次處理（batch_size = 50）
- 減少資料庫連線次數
- 使用 pandas-ta 的批次計算功能

**平行計算**:
- 使用執行緒池（ThreadPoolExecutor）
- 執行緒池大小：CPU 核心數 × 2
- 每個執行緒處理一批股票（batch_size = 50）

**結果快取**:
- 計算結果立即快取至 Redis
- 批次寫入資料庫（減少 I/O）

---

#### 9.2.3 快取優化

**多層快取架構**:
```
請求 
  ↓
本地快取（Caffeine，TTL 5 分鐘）
  ↓ 未命中
Redis（L1 快取，熱資料，TTL 1-6 小時）
  ↓ 未命中
PostgreSQL（資料庫）
  ↓
返回資料並寫入快取
```

**快取預熱**:
- 系統啟動時預載熱門股票（市值前 50）最新指標
- Job 完成後批次更新快取

**快取失效策略**:
- 新指標計算完成後主動更新快取
- TTL 過期自動清除

---

### 9.3 容量規劃

#### 9.3.1 資料量估算

**technical_indicators 表**:
```
每檔股票每日 1 筆記錄
台股約 1800 檔股票
每年約 250 個交易日

年度資料量 = 1800 × 250 = 450,000 筆/年
10 年資料量 = 4,500,000 筆

單筆記錄大小估算:
- 固定欄位: ~200 bytes
- JSONB 欄位 (trend_indicators): ~2 KB
- JSONB 欄位 (momentum_indicators): ~1.5 KB
- JSONB 欄位 (volatility_indicators): ~1 KB
- JSONB 欄位 (volume_indicators): ~1 KB
- 冗餘欄位 + 其他: ~500 bytes
單筆 ≈ 6 KB

年度儲存空間 = 450,000 × 6 KB ≈ 2.7 GB
10 年儲存空間 ≈ 27 GB
```

**Redis 快取容量**:
```
熱門股票（50 檔）最新指標快取:
50 檔 × 6 KB ≈ 300 KB

一般快取（LRU，最多 500 檔股票 × 30 天）:
500 × 30 × 6 KB ≈ 90 MB

總 Redis 容量需求: ~100 MB
建議配置: 512 MB（留有充足餘裕）
```

---



---

## 📚 相關文檔

- [M07 功能需求](../specs/functional/M07-技術分析功能需求.md)
- [M07 資料庫設計](./M07-資料庫設計.md)
- [M07 Job排程配置](../deployment/M07-Job排程配置.md)
- [NFR非功能性需求](../specs/technical/00-NFR非功能性需求.md)

---

**文件維護者**: 效能工程師  
**最後更新**: 2025-12-31  
**下次審核**: 2026-02-28
