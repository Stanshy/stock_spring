# DOC-03-M08 基本面分析模組 (Fundamental Analysis Module)

## 文件資訊
- **文件編號**: DOC-03-M08
- **模組名稱**: 基本面分析模組 (Fundamental Analysis Module)
- **模組代碼**: M08
- **版本**: v1.0
- **建立日期**: 2025-12-27
- **最後更新**: 2025-12-27
- **文件狀態**: Draft
- **負責人**: [待填寫]
- **依賴模組**: M06 資料管理模組
- **技術棧**: PostgreSQL 15+ / JPA + MyBatis / Redis 7.0

---

## 📑 目錄

1. [模組概述](#1-模組概述)
2. [功能需求](#2-功能需求)
3. [資料設計](#3-資料設計)
4. [API 設計](#4-api-設計)
5. [資料流設計](#5-資料流設計)
6. [Job/排程設計](#6-job排程設計)
7. [業務邏輯設計](#7-業務邏輯設計)
8. [整合點](#8-整合點)
9. [效能考量](#9-效能考量)
10. [測試準則](#10-測試準則)

---

## 1. 模組概述

### 1.1 模組定位

基本面分析模組是整個系統的**分析層（Layer 2）**，負責：
- 計算 75 個基本面財務指標（估值、獲利、財務結構、償債、效率、現金流、成長、股利、綜合評分）
- 儲存指標計算結果至 PostgreSQL 資料庫
- 提供財務指標查詢 API 給信號判斷引擎、選股引擎使用
- 偵測財務異常、盈餘品質問題
- 管理指標計算的排程與冪等性

**核心價值**: 為信號判斷、選股篩選、策略回測提供完整的基本面量化指標。

### 1.2 模組目標

- ✅ 完整財務指標庫：支援 75 個基本面指標（參照 fundamental_indicators_complete.md）
- ✅ 自動化計算：每季財報公告後自動計算財務指標（遵守總綱 4.5 Job 模型）
- ✅ 歷史趨勢分析：計算指標成長率、趨勢方向
- ✅ 冪等性保證：所有 Job 遵守總綱 4.5 冪等性要求
- ✅ 快取優化：熱門股票財務指標快取至 Redis，提升查詢效能
- ✅ 綜合評分：提供 Piotroski F-Score、Altman Z-Score 等綜合評分

### 1.3 功能範圍

**包含功能**:
1. **估值指標計算**（15 個）: P/E、P/B、P/S、P/CF、P/FCF、PEG、EV/EBITDA、Graham Number、Tobin's Q 等
2. **獲利能力指標計算**（12 個）: 毛利率、營業利益率、淨利率、ROE、ROA、ROIC、EPS、EBITDA Margin 等
3. **財務結構指標計算**（4 個）: 負債權益比、負債比率、權益比率、長期負債權益比
4. **償債能力指標計算**（6 個）: 流動比率、速動比率、現金比率、利息保障倍數、償債覆蓋率等
5. **經營效率指標計算**（10 個）: 總資產週轉率、存貨週轉率、應收帳款週轉率、現金週轉週期等
6. **現金流量指標計算**（6 個）: 自由現金流、FCF Yield、營運現金流比率、應計項目比率等
7. **成長性指標計算**（5 個）: 營收成長率、EPS 成長率、淨利成長率、ROE 成長率等
8. **股利政策指標計算**（4 個）: 現金殖利率、股利發放率、股利成長率、股利保障倍數
9. **綜合評分計算**（4 個）: Piotroski F-Score、Altman Z-Score、Beneish M-Score、Graham 評分
10. **財務指標查詢 API**: 提供單一/批次財務指標查詢介面

**不包含功能**:
- 技術指標計算（由 M07 負責）
- 籌碼指標計算（由 M09 負責）
- 信號評分與合併（由 M13 負責）

### 1.4 依賴關係

**上游依賴**: 
- M06 資料管理模組（財務報表資料）

**下游依賴**: 
- M13 信號判斷引擎
- M14 選股引擎
- M16 回測系統
- M17 風險管理模組

**外部依賴**:
- PostgreSQL（資料儲存）
- Redis（快取）

---

## 2. 功能需求

### 2.1 功能清單

| 功能編號 | 功能名稱 | 優先級 | 說明 | 持久層 |
|---------|---------|-------|------|-------|
| F-M08-001 | 估值指標計算 | P0 | P/E、P/B、P/S、PEG 等 15 個指標 | JPA + MyBatis |
| F-M08-002 | 獲利能力指標計算 | P0 | 毛利率、淨利率、ROE、EPS 等 12 個指標 | JPA + MyBatis |
| F-M08-003 | 財務結構指標計算 | P0 | 負債比、權益比等 4 個指標 | JPA |
| F-M08-004 | 償債能力指標計算 | P0 | 流動比率、速動比率等 6 個指標 | JPA |
| F-M08-005 | 經營效率指標計算 | P1 | 週轉率、現金週轉週期等 10 個指標 | JPA + MyBatis |
| F-M08-006 | 現金流量指標計算 | P0 | FCF、FCF Yield 等 6 個指標 | JPA + MyBatis |
| F-M08-007 | 成長性指標計算 | P1 | 營收成長率、EPS 成長率等 5 個指標 | MyBatis |
| F-M08-008 | 股利政策指標計算 | P1 | 殖利率、股利發放率等 4 個指標 | JPA |
| F-M08-009 | 綜合評分計算 | P1 | Piotroski F-Score、Altman Z-Score 等 | MyBatis |
| F-M08-010 | 財務指標查詢 API | P0 | 單一/批次財務指標查詢 | JPA + MyBatis |
| F-M08-011 | 歷史趨勢分析 | P1 | 計算指標成長率、趨勢方向 | MyBatis |
| F-M08-012 | 財務異常偵測 | P1 | 盈餘品質、會計操縱風險 | MyBatis |
| F-M08-013 | 指標排程計算 | P0 | 每季財報公告後自動計算 | - |
| F-M08-014 | 指標快取管理 | P1 | 熱門股票財務指標快取 | - |

### 2.2 用例說明

#### UC-M08-001: 每季財務指標計算

**參與者**: 系統排程器  
**前置條件**: 
- M06 財報資料同步已完成
- 收到 FinancialStatementUpdated 事件

**主要流程**:
1. 系統於每週一 09:00 觸發財務指標計算 Job（遵守總綱 4.5 Job 模型）
2. 建立 Job 執行記錄（job_executions 表，status='RUNNING'）
3. 查詢最近一季新增或更新的財報資料（從 M06 FinancialStatementUpdated 事件）
4. 對每檔股票每季財報執行指標計算：
   - 從 financial_statements 表查詢該季財報資料
   - 從 stock_prices 表查詢計算日當天的收盤價（用於估值指標）
   - 計算基礎指標組（估值、獲利、財務結構、償債能力）
   - 查詢歷史財報計算成長性指標（營收成長率、EPS 成長率）
   - 計算綜合評分（Piotroski F-Score、Altman Z-Score）
   - 驗證計算結果（非 NULL、非 NaN、範圍合理）
   - 使用 MyBatis 批次 UPSERT 儲存至 fundamental_indicators 表
5. 更新 Redis 快取（熱門股票前 50 檔）
6. 偵測財務異常（盈餘品質惡化、負債比過高、現金流轉負）
7. 產生信號並發布（遵守總綱 4.2 Signal Contract）
8. 更新 Job 執行記錄（status='SUCCESS', 統計資訊）

**後置條件**:
- 該季財務指標已計算並儲存
- Job 執行記錄狀態為 SUCCESS
- Redis 快取已更新
- 財務異常信號已發布至 M13

**替代流程**:
- 4a. 財報資料不完整（缺少必要欄位）→ 記錄 data_quality_issues，跳過該股票
- 4b. 計算結果異常（NaN、Inf、負數ROE但公司獲利）→ 記錄異常，跳過該股票
- 4c. 資料庫錯誤 → 回滾交易，Job 狀態設為 FAILED，觸發重試
- 6a. 偵測到財務異常 → 產生 SELL/HOLD 信號（遵守總綱 4.2）

---

#### UC-M08-002: 財務指標批次查詢

**參與者**: M14 選股引擎、M13 信號判斷引擎  
**前置條件**: 
- 財務指標已計算並儲存

**主要流程**:
1. 下游模組發送批次查詢請求（股票清單、指標清單、時間範圍）
2. 檢查 Redis 快取是否命中
3. 若快取未命中，使用 MyBatis 批次查詢資料庫
4. 組裝查詢結果（遵守總綱 4.4 API 統一規範）
5. 更新 Redis 快取（設定 TTL）
6. 返回結果

**後置條件**:
- 查詢結果已返回
- 快取已更新（若未命中）

**替代流程**:
- 2a. 快取命中 → 直接返回快取結果，跳至步驟 6
- 3a. 資料庫無資料 → 返回空結果，error_code='M08_DATA_001'

---

#### UC-M08-003: 財務異常偵測

**參與者**: 系統排程器  
**前置條件**: 
- 財務指標已計算完成

**主要流程**:
1. 讀取當季財務指標
2. 執行異常偵測規則：
   - 盈餘品質：應計項目比率 > 10%（可能會計操縱）
   - 負債風險：負債比 > 70%（財務風險高）
   - 流動性風險：流動比 < 1.0（短期償債能力不足）
   - 現金流問題：自由現金流連續 2 季為負（燒錢）
   - ROE 惡化：ROE 連續 2 季下降且 < 10%
3. 若偵測到異常，產生警示信號
4. 記錄異常至 financial_alerts 表
5. 發布事件至 M13 信號判斷引擎

**後置條件**:
- 財務異常已記錄
- 警示信號已發布

---

### 2.3 業務規則

#### BR-M08-001: 財務指標計算優先級

**核心組（P0 - 每季必算）**:
- 估值指標：P/E, P/B, P/S, PEG, EV/EBITDA
- 獲利能力：毛利率, 營業利益率, 淨利率, ROE, ROA, EPS
- 財務結構：負債權益比, 負債比率, 權益比率
- 償債能力：流動比率, 速動比率, 利息保障倍數
- 現金流量：自由現金流, FCF Yield, 營運現金流比率

**進階組（P1 - 每季計算）**:
- 經營效率：總資產週轉率, 存貨週轉率, 應收帳款週轉率, 現金週轉週期
- 成長性：營收成長率, EPS 成長率, 淨利成長率
- 股利政策：現金殖利率, 股利發放率
- 綜合評分：Piotroski F-Score, Altman Z-Score

**專業組（P2 - 按需計算）**:
- 進階估值：Tobin's Q, Graham Number, Shiller P/E
- 進階獲利：ROIC, ROTA
- 進階償債：償債覆蓋率, 現金比率
- 進階現金流：應計項目比率, 現金流營收比
- 進階成長：CAGR (3年、5年)
- 進階評分：Beneish M-Score, Graham 評分

---

#### BR-M08-002: 指標計算參數標準化

所有指標使用統一的計算方法，遵循財務會計準則：

| 指標 | 計算公式 | 資料來源 |
|-----|---------|---------|
| P/E | 股價 / 每股盈餘(EPS) | stock_prices, financial_statements |
| P/B | 股價 / 每股淨值 | stock_prices, financial_statements |
| P/S | 股價 / 每股營收 | stock_prices, financial_statements |
| ROE | 稅後淨利 / 股東權益 × 100% | financial_statements |
| ROA | 稅後淨利 / 總資產 × 100% | financial_statements |
| 毛利率 | (營收 - 營業成本) / 營收 × 100% | financial_statements |
| 淨利率 | 稅後淨利 / 營收 × 100% | financial_statements |
| 負債比 | 總負債 / 總資產 × 100% | financial_statements |
| 流動比 | 流動資產 / 流動負債 | financial_statements |
| FCF | 營運現金流 - 資本支出 | financial_statements |
| EPS 成長率 | (本季EPS - 去年同季EPS) / 去年同季EPS × 100% | financial_statements (歷史) |

---

#### BR-M08-003: 指標驗證規則

**完整性**:
- 計算後的指標值不可為 NULL（允許 NaN 用於資料不足期間）
- 財報資料必須包含核心欄位（營收、淨利、總資產、股東權益）

**準確性**:
- ROE、ROA、各利潤率範圍：-100% 到 100%（虧損公司可為負）
- 負債比範圍：0% 到 200%（超過 100% 表示淨值為負）
- 流動比、速動比範圍：> 0
- P/E、P/B、P/S 範圍：> 0（負值表示虧損，需特殊處理）

**合理性**:
- ROE > 100%：異常高，需人工檢查
- 負債比 > 90%：高風險，觸發警示
- 流動比 < 0.5：流動性風險，觸發警示
- 毛利率 < 0% 或 > 80%：異常值，需檢查

**一致性**:
- 同一股票、同一季度、同一指標只能有一筆記錄
- 權益比 + 負債比 ≈ 100%（容許 ±1% 誤差）

---

#### BR-M08-004: 財務異常偵測規則

**盈餘品質警示**:
- 應計項目比率 > 10%：可能會計操縱
- 營運現金流 < 淨利 × 0.7：盈餘品質不佳
- 自由現金流連續 2 季為負：燒錢警示

**財務結構警示**:
- 負債比 > 70%：高負債風險
- 負債權益比 > 2.0：財務槓桿過高
- 權益比 < 30%：自有資金不足

**償債能力警示**:
- 流動比 < 1.0：短期償債能力不足
- 速動比 < 0.8：流動性風險
- 利息保障倍數 < 1.5：利息支付能力不足

**獲利能力警示**:
- ROE 連續 2 季下降且 < 10%：獲利惡化
- 毛利率連續 2 季下降且 < 15%：競爭力下降
- 淨利率 < 3%：獲利能力弱

---

#### BR-M08-005: 快取策略

參照總綱快取策略：

| 資料類型 | 快取位置 | TTL | 預熱策略 | 失效策略 |
|---------|---------|-----|---------|---------|
| 熱門股票財務指標（市值前 50） | Redis | 24 小時 | Job 完成後主動更新 | 新財報計算完成後主動更新 |
| 一般股票財務指標 | Redis | 48 小時 | 首次查詢時載入 | LRU 自動淘汰 |
| 單季指標快照 | Redis | 7 天 | 不預熱 | TTL 自動過期 |
| 綜合評分 | Redis | 24 小時 | 計算完成後主動更新 | 新評分計算後主動更新 |

**快取 Key 設計**:
```
fund:indicators:{stock_id}:{year}:{quarter}                → 單季所有指標
fund:indicator:{stock_id}:{indicator_name}:{year}:{quarter} → 單一指標單季值
fund:trend:{stock_id}:{indicator_name}:{periods}           → 指標歷史趨勢
fund:score:{stock_id}:{score_type}:{year}:{quarter}        → 綜合評分
fund:hot:stocks                                            → 熱門股票清單
```

---

## 3. 資料設計

### 3.1 資料表清單

| 表名 | 說明 | 持久層 | 特殊功能 |
|-----|------|-------|---------|
| fundamental_indicators | 基本面指標主表 | JPA + MyBatis | JSONB、GIN 索引 |
| financial_scores | 綜合評分表 | JPA | - |
| financial_alerts | 財務異常警示表 | JPA | - |

### 3.2 資料表設計

#### 3.2.1 fundamental_indicators (基本面指標主表)

```sql
-- PostgreSQL 建表語法
CREATE TABLE fundamental_indicators (
    indicator_id        BIGSERIAL PRIMARY KEY,
    stock_id            VARCHAR(10) NOT NULL,
    year                INTEGER NOT NULL,
    quarter             INTEGER NOT NULL CHECK (quarter BETWEEN 1 AND 4),
    report_type         VARCHAR(10) NOT NULL CHECK (report_type IN ('Q', 'H', 'Y')),
    
    -- 估值指標（使用 JSONB 儲存）
    valuation_indicators JSONB DEFAULT '{}',
    
    -- 獲利能力指標
    profitability_indicators JSONB DEFAULT '{}',
    
    -- 財務結構指標
    financial_structure_indicators JSONB DEFAULT '{}',
    
    -- 償債能力指標
    solvency_indicators JSONB DEFAULT '{}',
    
    -- 經營效率指標
    efficiency_indicators JSONB DEFAULT '{}',
    
    -- 現金流量指標
    cash_flow_indicators JSONB DEFAULT '{}',
    
    -- 成長性指標
    growth_indicators JSONB DEFAULT '{}',
    
    -- 股利政策指標
    dividend_indicators JSONB DEFAULT '{}',
    
    -- 快速查詢欄位（冗餘，用於常用指標）
    pe_ratio            NUMERIC(10,2),
    pb_ratio            NUMERIC(10,2),
    ps_ratio            NUMERIC(10,2),
    roe                 NUMERIC(10,2),
    roa                 NUMERIC(10,2),
    gross_margin        NUMERIC(10,2),
    operating_margin    NUMERIC(10,2),
    net_margin          NUMERIC(10,2),
    eps                 NUMERIC(10,2),
    debt_ratio          NUMERIC(10,2),
    current_ratio       NUMERIC(10,2),
    quick_ratio         NUMERIC(10,2),
    fcf                 BIGINT,
    fcf_yield           NUMERIC(10,2),
    dividend_yield      NUMERIC(10,2),
    revenue_growth      NUMERIC(10,2),
    eps_growth          NUMERIC(10,2),
    
    -- 計算資訊
    calculation_date    DATE NOT NULL,
    stock_price         NUMERIC(10,2),
    calculation_version VARCHAR(10),
    
    -- 審計欄位
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE (stock_id, year, quarter, report_type),
    
    FOREIGN KEY (stock_id) REFERENCES stocks(stock_id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_fundamental_indicators_stock_id ON fundamental_indicators(stock_id);
CREATE INDEX idx_fundamental_indicators_year_quarter ON fundamental_indicators(year, quarter);
CREATE INDEX idx_fundamental_indicators_calculation_date ON fundamental_indicators(calculation_date);

-- GIN 索引（加速 JSONB 查詢）
CREATE INDEX idx_fundamental_indicators_valuation ON fundamental_indicators USING GIN(valuation_indicators);
CREATE INDEX idx_fundamental_indicators_profitability ON fundamental_indicators USING GIN(profitability_indicators);
CREATE INDEX idx_fundamental_indicators_structure ON fundamental_indicators USING GIN(financial_structure_indicators);
CREATE INDEX idx_fundamental_indicators_cashflow ON fundamental_indicators USING GIN(cash_flow_indicators);

-- 自動更新 updated_at 觸發器
CREATE TRIGGER update_fundamental_indicators_updated_at
    BEFORE UPDATE ON fundamental_indicators
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 表註釋
COMMENT ON TABLE fundamental_indicators IS '基本面指標主表（使用 JSONB 優化）';
COMMENT ON COLUMN fundamental_indicators.valuation_indicators IS '估值指標 JSONB（P/E、P/B、P/S等）';
COMMENT ON COLUMN fundamental_indicators.pe_ratio IS '本益比（冗餘欄位，用於快速查詢）';
```

**設計說明**:
- 使用 **JSONB** 儲存各類別指標，彈性擴充
- 提供冗餘欄位（pe_ratio, roe 等）用於高頻查詢，避免解析 JSON
- GIN 索引加速 JSONB 查詢
- UNIQUE 約束：(stock_id, year, quarter, report_type)

**JSONB 結構範例**:

**valuation_indicators**:
```json
{
  "pe_ratio": 18.50,
  "forward_pe": 16.20,
  "trailing_pe": 19.30,
  "pb_ratio": 3.20,
  "ps_ratio": 4.50,
  "pcf_ratio": 12.30,
  "pfcf_ratio": 15.80,
  "peg_ratio": 1.25,
  "ev_ebitda": 10.50,
  "tobins_q": 1.80,
  "graham_number": 650.00,
  "ev": 18500000000000,
  "market_cap": 15000000000000
}
```

**profitability_indicators**:
```json
{
  "gross_margin": 53.50,
  "operating_margin": 42.30,
  "net_margin": 41.20,
  "ebitda_margin": 48.50,
  "roe": 26.70,
  "roa": 18.70,
  "roic": 22.50,
  "rota": 20.30,
  "eps": 36.05,
  "diluted_eps": 35.80,
  "operating_eps": 38.20,
  "ebitda": 1100000000000
}
```

**financial_structure_indicators**:
```json
{
  "debt_to_equity": 0.35,
  "debt_ratio": 26.00,
  "equity_ratio": 74.00,
  "long_term_debt_to_equity": 0.20
}
```

**solvency_indicators**:
```json
{
  "current_ratio": 2.10,
  "quick_ratio": 1.85,
  "cash_ratio": 1.20,
  "interest_coverage": 45.30,
  "debt_service_coverage": 3.80,
  "ocf_to_current_liabilities": 2.50
}
```

**efficiency_indicators**:
```json
{
  "asset_turnover": 0.75,
  "inventory_turnover": 8.50,
  "receivables_turnover": 12.30,
  "payables_turnover": 9.80,
  "dio": 42.94,
  "dso": 29.67,
  "dpo": 37.24,
  "cash_conversion_cycle": 35.37,
  "operating_cycle": 72.61,
  "total_asset_turnover": 0.75
}
```

**cash_flow_indicators**:
```json
{
  "operating_cash_flow": 1000000000000,
  "free_cash_flow": 700000000000,
  "fcf_yield": 4.67,
  "ocf_ratio": 1.25,
  "cf_to_sales": 44.18,
  "accrual_ratio": -0.05
}
```

**growth_indicators**:
```json
{
  "revenue_growth_yoy": 18.50,
  "revenue_growth_qoq": 5.20,
  "eps_growth_yoy": 25.30,
  "eps_growth_qoq": 8.10,
  "net_income_growth_yoy": 22.80,
  "roe_growth_yoy": 3.50,
  "revenue_cagr_3y": 20.10,
  "revenue_cagr_5y": 22.50,
  "eps_cagr_3y": 28.30,
  "eps_cagr_5y": 30.20
}
```

**dividend_indicators**:
```json
{
  "dividend_yield": 1.90,
  "dividend_payout_ratio": 42.50,
  "dividend_per_share": 11.00,
  "dividend_growth_yoy": 15.80,
  "dividend_coverage": 2.35
}
```

**JSONB 查詢範例**:
```sql
-- 查詢 ROE > 20% 的股票
SELECT stock_id, year, quarter, 
       profitability_indicators->>'roe' as roe
FROM fundamental_indicators 
WHERE (profitability_indicators->>'roe')::numeric > 20.0
  AND year = 2024 AND quarter = 3;

-- 查詢本益比 < 15 且負債比 < 50% 的股票
SELECT stock_id, year, quarter,
       valuation_indicators->>'pe_ratio' as pe,
       financial_structure_indicators->>'debt_ratio' as debt_ratio
FROM fundamental_indicators 
WHERE (valuation_indicators->>'pe_ratio')::numeric < 15.0
  AND (financial_structure_indicators->>'debt_ratio')::numeric < 50.0
  AND year = 2024 AND quarter = 3;

-- 查詢包含特定指標的記錄
SELECT * FROM fundamental_indicators 
WHERE valuation_indicators ? 'peg_ratio'  -- 檢查 JSON 鍵是否存在
  AND year = 2024;
```

**UPSERT 語法（MyBatis）**:
```sql
INSERT INTO fundamental_indicators (
    stock_id, year, quarter, report_type,
    valuation_indicators, profitability_indicators,
    financial_structure_indicators, solvency_indicators,
    efficiency_indicators, cash_flow_indicators,
    growth_indicators, dividend_indicators,
    pe_ratio, pb_ratio, roe, eps,
    calculation_date, stock_price
) VALUES (
    '2330', 2024, 3, 'Q',
    '{"pe_ratio": 18.5, "pb_ratio": 3.2}'::jsonb,
    '{"roe": 26.7, "roa": 18.7, "net_margin": 41.2}'::jsonb,
    '{"debt_ratio": 26.0, "equity_ratio": 74.0}'::jsonb,
    '{"current_ratio": 2.1, "quick_ratio": 1.85}'::jsonb,
    '{"asset_turnover": 0.75, "dio": 42.94}'::jsonb,
    '{"fcf": 700000000000, "fcf_yield": 4.67}'::jsonb,
    '{"revenue_growth_yoy": 18.5, "eps_growth_yoy": 25.3}'::jsonb,
    '{"dividend_yield": 1.9, "dividend_payout_ratio": 42.5}'::jsonb,
    18.5, 3.2, 26.7, 36.05,
    '2024-11-14', 580.00
)
ON CONFLICT (stock_id, year, quarter, report_type)
DO UPDATE SET
    valuation_indicators = EXCLUDED.valuation_indicators,
    profitability_indicators = EXCLUDED.profitability_indicators,
    financial_structure_indicators = EXCLUDED.financial_structure_indicators,
    solvency_indicators = EXCLUDED.solvency_indicators,
    efficiency_indicators = EXCLUDED.efficiency_indicators,
    cash_flow_indicators = EXCLUDED.cash_flow_indicators,
    growth_indicators = EXCLUDED.growth_indicators,
    dividend_indicators = EXCLUDED.dividend_indicators,
    pe_ratio = EXCLUDED.pe_ratio,
    pb_ratio = EXCLUDED.pb_ratio,
    roe = EXCLUDED.roe,
    eps = EXCLUDED.eps,
    calculation_date = EXCLUDED.calculation_date,
    stock_price = EXCLUDED.stock_price,
    updated_at = CURRENT_TIMESTAMP;
```

---

#### 3.2.2 financial_scores (綜合評分表)

```sql
-- PostgreSQL 建表語法
CREATE TABLE financial_scores (
    score_id            BIGSERIAL PRIMARY KEY,
    stock_id            VARCHAR(10) NOT NULL,
    year                INTEGER NOT NULL,
    quarter             INTEGER NOT NULL CHECK (quarter BETWEEN 1 AND 4),
    
    -- Piotroski F-Score (0-9)
    piotroski_f_score   INTEGER CHECK (piotroski_f_score BETWEEN 0 AND 9),
    piotroski_details   JSONB,
    
    -- Altman Z-Score
    altman_z_score      NUMERIC(10,2),
    altman_status       VARCHAR(20) CHECK (altman_status IN ('SAFE', 'GREY', 'DISTRESS')),
    altman_details      JSONB,
    
    -- Beneish M-Score
    beneish_m_score     NUMERIC(10,2),
    beneish_status      VARCHAR(20) CHECK (beneish_status IN ('CLEAN', 'WARNING', 'MANIPULATOR')),
    beneish_details     JSONB,
    
    -- Graham Score (0-10)
    graham_score        INTEGER CHECK (graham_score BETWEEN 0 AND 10),
    graham_details      JSONB,
    
    -- 自訂綜合評分 (0-100)
    composite_score     NUMERIC(5,2) CHECK (composite_score BETWEEN 0 AND 100),
    composite_grade     VARCHAR(5) CHECK (composite_grade IN ('A+', 'A', 'B+', 'B', 'C+', 'C', 'D', 'F')),
    
    -- 計算資訊
    calculation_date    DATE NOT NULL,
    
    -- 審計欄位
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE (stock_id, year, quarter),
    
    FOREIGN KEY (stock_id) REFERENCES stocks(stock_id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_financial_scores_stock_id ON financial_scores(stock_id);
CREATE INDEX idx_financial_scores_year_quarter ON financial_scores(year, quarter);
CREATE INDEX idx_financial_scores_piotroski ON financial_scores(piotroski_f_score DESC);
CREATE INDEX idx_financial_scores_composite ON financial_scores(composite_score DESC);

-- 自動更新 updated_at 觸發器
CREATE TRIGGER update_financial_scores_updated_at
    BEFORE UPDATE ON financial_scores
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 表註釋
COMMENT ON TABLE financial_scores IS '綜合財務評分表';
COMMENT ON COLUMN financial_scores.piotroski_f_score IS 'Piotroski F-Score (0-9，越高越好)';
COMMENT ON COLUMN financial_scores.altman_z_score IS 'Altman Z-Score (>2.99安全，<1.81危險)';
COMMENT ON COLUMN financial_scores.composite_score IS '自訂綜合評分 (0-100)';
```

**JSONB 結構範例**:

**piotroski_details**:
```json
{
  "profitability": {
    "roa_positive": 1,
    "ocf_positive": 1,
    "roa_increasing": 1,
    "ocf_gt_ni": 1,
    "total": 4
  },
  "leverage": {
    "debt_decreasing": 1,
    "current_ratio_increasing": 1,
    "shares_not_increasing": 1,
    "total": 3
  },
  "operating_efficiency": {
    "gross_margin_increasing": 1,
    "asset_turnover_increasing": 1,
    "total": 2
  }
}
```

**altman_details**:
```json
{
  "working_capital_to_assets": 0.35,
  "retained_earnings_to_assets": 0.45,
  "ebit_to_assets": 0.18,
  "market_value_to_liabilities": 5.20,
  "sales_to_assets": 0.75,
  "z_score": 3.85,
  "interpretation": "安全區：破產風險低"
}
```

**beneish_details**:
```json
{
  "dsri": 1.05,
  "gmi": 0.95,
  "aqi": 1.02,
  "sgi": 1.18,
  "depi": 0.98,
  "sgai": 0.92,
  "lvgi": 1.03,
  "tata": -0.05,
  "m_score": -2.50,
  "interpretation": "盈餘品質良好"
}
```

---

#### 3.2.3 financial_alerts (財務異常警示表)

```sql
-- PostgreSQL 建表語法
CREATE TABLE financial_alerts (
    alert_id            BIGSERIAL PRIMARY KEY,
    stock_id            VARCHAR(10) NOT NULL,
    year                INTEGER NOT NULL,
    quarter             INTEGER NOT NULL,
    
    -- 警示資訊
    alert_type          VARCHAR(50) NOT NULL,
    alert_category      VARCHAR(50) NOT NULL CHECK (alert_category IN 
        ('EARNINGS_QUALITY', 'DEBT_RISK', 'LIQUIDITY_RISK', 'PROFITABILITY_DECLINE', 'OTHER')),
    severity            VARCHAR(20) NOT NULL CHECK (severity IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')),
    
    alert_message       TEXT NOT NULL,
    alert_detail        JSONB,
    
    -- 觸發條件
    trigger_indicator   VARCHAR(50),
    trigger_value       NUMERIC(15,2),
    threshold_value     NUMERIC(15,2),
    
    -- 狀態管理
    alert_status        VARCHAR(20) DEFAULT 'ACTIVE' CHECK (alert_status IN ('ACTIVE', 'RESOLVED', 'IGNORED')),
    is_notified         BOOLEAN DEFAULT FALSE,
    resolved_at         TIMESTAMP,
    
    -- 審計欄位
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (stock_id) REFERENCES stocks(stock_id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_financial_alerts_stock_id ON financial_alerts(stock_id);
CREATE INDEX idx_financial_alerts_year_quarter ON financial_alerts(year, quarter);
CREATE INDEX idx_financial_alerts_severity ON financial_alerts(severity);
CREATE INDEX idx_financial_alerts_status ON financial_alerts(alert_status);
CREATE INDEX idx_financial_alerts_category ON financial_alerts(alert_category);

-- 自動更新 updated_at 觸發器
CREATE TRIGGER update_financial_alerts_updated_at
    BEFORE UPDATE ON financial_alerts
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 表註釋
COMMENT ON TABLE financial_alerts IS '財務異常警示表';
COMMENT ON COLUMN financial_alerts.alert_category IS '警示類別（盈餘品質、負債風險、流動性風險等）';
COMMENT ON COLUMN financial_alerts.severity IS '嚴重程度（LOW、MEDIUM、HIGH、CRITICAL）';
```


---

### 3.3 資料關聯圖
```
┌──────────────────────┐
│      stocks          │ ← 股票主表（來自 M06）
└──────────────────────┘
            │
            │ (讀取，不修改)
            ↓
┌──────────────────────┐
│ financial_statements │ ← 財務報表（來自 M06）
│  - JSONB 儲存        │   - 讀取營收、淨利、總資產等
│  - GIN 索引          │   - 計算指標的資料來源
└──────────────────────┘
            │
            ↓
┌──────────────────────────────┐
│   fundamental_indicators     │ ← 基本面指標主表（M08 核心）
│    - JSONB 儲存各類指標      │   - 8 大類 JSONB 欄位
│    - GIN 索引               │   - 冗餘欄位（高頻查詢）
│    - 唯一鍵: (stock_id,     │
│       year, quarter)         │
└──────────────────────────────┘
            │
            ├──────────────→ financial_scores (1:1)
            │                 - 綜合評分
            │                 - Piotroski、Altman、Beneish
            │
            └──────────────→ financial_alerts (1:N)
                              - 財務異常警示
                              - 觸發信號

┌──────────────────────┐
│   stock_prices       │ ← 股價資料（來自 M06）
└──────────────────────┘   - 讀取收盤價（計算估值指標）
                           - 計算市值
```

**說明**:
- M08 **不修改** M06 的資料表
- M08 **讀取** financial_statements 和 stock_prices
- M08 **寫入** fundamental_indicators, financial_scores, financial_alerts
- fundamental_indicators 是核心表，使用 JSONB 儲存 75 個指標
- financial_scores 與 fundamental_indicators 是 1:1 關聯
- financial_alerts 與 fundamental_indicators 是 1:N 關聯（一季可能有多個警示）

---

### 3.4 JPA vs MyBatis 使用場景

| 資料表 | 簡單 CRUD | 複雜查詢 | 批次操作 | 統計查詢 |
|-------|----------|---------|---------|---------|
| fundamental_indicators | JPA | **MyBatis** | **MyBatis** | **MyBatis** |
| financial_scores | JPA | JPA | **MyBatis** | MyBatis |
| financial_alerts | JPA | MyBatis | JPA | MyBatis |

**使用原則**:
- **JPA**: 單筆查詢、簡單條件查詢
- **MyBatis**: 批次 UPSERT、JSONB 查詢、複雜統計

**具體場景**:

**fundamental_indicators**:
- 簡單查詢（單一股票單季）→ JPA
```java
  repository.findByStockIdAndYearAndQuarter("2330", 2024, 3)
```
- JSONB 查詢（ROE > 20%）→ MyBatis
```sql
  SELECT * FROM fundamental_indicators 
  WHERE (profitability_indicators->>'roe')::numeric > 20.0
```
- 批次 UPSERT（計算完成後儲存）→ MyBatis
```sql
  INSERT INTO fundamental_indicators (...) VALUES (...), (...), (...)
  ON CONFLICT (stock_id, year, quarter, report_type) DO UPDATE SET ...
```
- 統計查詢（產業平均 ROE）→ MyBatis
```sql
  SELECT industry, AVG((profitability_indicators->>'roe')::numeric)
  FROM fundamental_indicators
  GROUP BY industry
```

**financial_scores**:
- 單筆查詢 → JPA
- 批次插入（評分計算完成）→ MyBatis

**financial_alerts**:
- 單筆插入（單一警示）→ JPA
- 條件查詢（某股票的高嚴重度警示）→ MyBatis

**判斷標準**:
- ✅ 使用 MyBatis 的情況：
  - JSONB 欄位條件查詢
  - 批次 UPSERT（>10 筆）
  - 複雜聚合統計
  - 多表 JOIN + 動態條件
  
- ✅ 使用 JPA 的情況：
  - 單筆 findById
  - 簡單條件查詢（不涉及 JSONB）
  - Spring Data JPA 分頁查詢



---

## 4. API 設計

### 4.1 API 列表總覽

| API 編號 | 端點 | 方法 | 說明 | 權限 |
|---------|------|------|------|------|
| API-M08-001 | /api/stocks/{stockId}/fundamentals | GET | 查詢財務指標 | USER |
| API-M08-002 | /api/stocks/{stockId}/scores | GET | 查詢綜合評分 | USER |
| API-M08-003 | /api/stocks/{stockId}/alerts | GET | 查詢財務警示 | USER |
| API-M08-004 | /api/fundamentals/batch | POST | 批次查詢財務指標 | USER |
| API-M08-005 | /api/fundamentals/trends | POST | 查詢指標歷史趨勢 | USER |
| API-M08-006 | /api/jobs/calculate-fundamentals | POST | 手動觸發財務指標計算 | ADMIN |

### 4.2 核心 API 設計

#### API-M08-001: 查詢財務指標

**Request**:
```
GET /api/stocks/2330/fundamentals?year=2024&quarter=3&indicators=pe_ratio,roe,debt_ratio
Authorization: Bearer {jwt_token}
```

**Path Parameters**:
| 參數 | 類型 | 說明 |
|-----|------|------|
| stockId | String | 股票代碼（如 2330） |

**Query Parameters**:
| 參數 | 類型 | 必填 | 說明 | 預設值 |
|-----|------|------|------|-------|
| year | Integer | N | 年度 | 最新年度 |
| quarter | Integer | N | 季度（1-4） | 最新季度 |
| indicators | String | N | 指標清單（逗號分隔） | 全部 |

**Response** (遵守總綱 4.4 API 統一規範):
```json
{
  "success": true,
  "timestamp": "2024-12-27T10:30:00+08:00",
  "data": {
    "stock_id": "2330",
    "stock_name": "台積電",
    "year": 2024,
    "quarter": 3,
    "report_type": "Q",
    "calculation_date": "2024-11-14",
    "stock_price": 580.00,
    "valuation": {
      "pe_ratio": 18.50,
      "pb_ratio": 3.20,
      "ps_ratio": 4.50,
      "peg_ratio": 1.25
    },
    "profitability": {
      "roe": 26.70,
      "roa": 18.70,
      "gross_margin": 53.50,
      "operating_margin": 42.30,
      "net_margin": 41.20,
      "eps": 36.05
    },
    "financial_structure": {
      "debt_to_equity": 0.35,
      "debt_ratio": 26.00,
      "equity_ratio": 74.00
    },
    "solvency": {
      "current_ratio": 2.10,
      "quick_ratio": 1.85,
      "cash_ratio": 1.20
    },
    "cash_flow": {
      "free_cash_flow": 700000000000,
      "fcf_yield": 4.67,
      "operating_cash_flow": 1000000000000
    },
    "growth": {
      "revenue_growth_yoy": 18.50,
      "eps_growth_yoy": 25.30,
      "net_income_growth_yoy": 22.80
    },
    "dividend": {
      "dividend_yield": 1.90,
      "dividend_payout_ratio": 42.50,
      "dividend_per_share": 11.00
    }
  },
  "error": null
}
```

**Response** (股票不存在):
```json
{
  "success": false,
  "timestamp": "2024-12-27T10:30:00+08:00",
  "data": null,
  "error": {
    "error_code": "M08_STOCK_001",
    "error_message": "股票不存在",
    "error_detail": "Stock not found: 9999",
    "trace_id": "req_abc123",
    "path": "/api/stocks/9999/fundamentals"
  }
}
```

---

#### API-M08-002: 查詢綜合評分

**Request**:
```
GET /api/stocks/2330/scores?year=2024&quarter=3
Authorization: Bearer {jwt_token}
```

**Query Parameters**:
| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| year | Integer | N | 年度（預設最新） |
| quarter | Integer | N | 季度（1-4，預設最新） |

**Response** (成功):
```json
{
  "success": true,
  "timestamp": "2024-12-27T10:30:00+08:00",
  "data": {
    "stock_id": "2330",
    "stock_name": "台積電",
    "year": 2024,
    "quarter": 3,
    "calculation_date": "2024-11-14",
    "piotroski_f_score": 8,
    "piotroski_interpretation": "優秀（8-9分）",
    "piotroski_details": {
      "profitability": 4,
      "leverage": 3,
      "operating_efficiency": 2
    },
    "altman_z_score": 3.85,
    "altman_status": "SAFE",
    "altman_interpretation": "安全區：破產風險低",
    "beneish_m_score": -2.50,
    "beneish_status": "CLEAN",
    "beneish_interpretation": "盈餘品質良好",
    "graham_score": 9,
    "composite_score": 88.50,
    "composite_grade": "A"
  },
  "error": null
}
```

---

#### API-M08-003: 查詢財務警示

**Request**:
```
GET /api/stocks/2330/alerts?year=2024&quarter=3&severity=HIGH,CRITICAL&status=ACTIVE
Authorization: Bearer {jwt_token}
```

**Query Parameters**:
| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| year | Integer | N | 年度 |
| quarter | Integer | N | 季度 |
| severity | String | N | 嚴重程度（逗號分隔） |
| status | String | N | 警示狀態 |

**Response** (成功):
```json
{
  "success": true,
  "timestamp": "2024-12-27T10:30:00+08:00",
  "data": {
    "stock_id": "2330",
    "stock_name": "台積電",
    "alerts": [
      {
        "alert_id": 12345,
        "year": 2024,
        "quarter": 3,
        "alert_type": "HIGH_DEBT_RATIO",
        "alert_category": "DEBT_RISK",
        "severity": "MEDIUM",
        "alert_message": "負債比率偏高",
        "alert_detail": {
          "current_debt_ratio": 68.50,
          "threshold": 70.00,
          "trend": "上升"
        },
        "trigger_indicator": "debt_ratio",
        "trigger_value": 68.50,
        "threshold_value": 70.00,
        "alert_status": "ACTIVE",
        "created_at": "2024-11-14T10:00:00+08:00"
      }
    ],
    "total_count": 1
  },
  "error": null
}
```

---

#### API-M08-004: 批次查詢財務指標

**Request**:
```
POST /api/fundamentals/batch
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "stock_ids": ["2330", "2317", "2454"],
  "year": 2024,
  "quarter": 3,
  "indicators": ["pe_ratio", "roe", "debt_ratio", "eps_growth_yoy"]
}
```

**Request Body**:
| 欄位 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| stock_ids | Array[String] | Y | 股票代碼清單 |
| year | Integer | N | 年度 |
| quarter | Integer | N | 季度 |
| indicators | Array[String] | N | 指標清單 |

**Response** (成功):
```json
{
  "success": true,
  "timestamp": "2024-12-27T10:30:00+08:00",
  "data": {
    "results": [
      {
        "stock_id": "2330",
        "stock_name": "台積電",
        "year": 2024,
        "quarter": 3,
        "indicators": {
          "pe_ratio": 18.50,
          "roe": 26.70,
          "debt_ratio": 26.00,
          "eps_growth_yoy": 25.30
        }
      },
      {
        "stock_id": "2317",
        "stock_name": "鴻海",
        "year": 2024,
        "quarter": 3,
        "indicators": {
          "pe_ratio": 12.30,
          "roe": 18.50,
          "debt_ratio": 45.00,
          "eps_growth_yoy": 15.20
        }
      },
      {
        "stock_id": "2454",
        "stock_name": "聯發科",
        "year": 2024,
        "quarter": 3,
        "indicators": {
          "pe_ratio": 16.80,
          "roe": 22.30,
          "debt_ratio": 32.50,
          "eps_growth_yoy": 30.50
        }
      }
    ],
    "total_count": 3
  },
  "error": null
}
```

---

#### API-M08-005: 查詢指標歷史趨勢

**Request**:
```
POST /api/fundamentals/trends
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "stock_id": "2330",
  "indicator": "roe",
  "start_year": 2020,
  "start_quarter": 1,
  "end_year": 2024,
  "end_quarter": 3
}
```

**Response** (成功):
```json
{
  "success": true,
  "timestamp": "2024-12-27T10:30:00+08:00",
  "data": {
    "stock_id": "2330",
    "stock_name": "台積電",
    "indicator": "roe",
    "indicator_name": "股東權益報酬率",
    "unit": "%",
    "trend_data": [
      {"year": 2020, "quarter": 1, "value": 22.50},
      {"year": 2020, "quarter": 2, "value": 23.10},
      {"year": 2020, "quarter": 3, "value": 24.20},
      {"year": 2020, "quarter": 4, "value": 24.80},
      {"year": 2021, "quarter": 1, "value": 25.20},
      {"year": 2021, "quarter": 2, "value": 25.50},
      {"year": 2021, "quarter": 3, "value": 26.00},
      {"year": 2021, "quarter": 4, "value": 26.30},
      {"year": 2022, "quarter": 1, "value": 26.50},
      {"year": 2022, "quarter": 2, "value": 26.80},
      {"year": 2022, "quarter": 3, "value": 27.00},
      {"year": 2022, "quarter": 4, "value": 27.20},
      {"year": 2023, "quarter": 1, "value": 26.80},
      {"year": 2023, "quarter": 2, "value": 26.50},
      {"year": 2023, "quarter": 3, "value": 26.30},
      {"year": 2023, "quarter": 4, "value": 26.00},
      {"year": 2024, "quarter": 1, "value": 26.20},
      {"year": 2024, "quarter": 2, "value": 26.50},
      {"year": 2024, "quarter": 3, "value": 26.70}
    ],
    "statistics": {
      "min": 22.50,
      "max": 27.20,
      "avg": 25.87,
      "latest": 26.70,
      "trend": "上升",
      "volatility": 1.52
    }
  },
  "error": null
}
```

---

#### API-M08-006: 手動觸發財務指標計算（管理員）

**Request**:
```
POST /api/jobs/calculate-fundamentals
Authorization: Bearer {admin_jwt_token}
Content-Type: application/json

{
  "stock_ids": ["2330", "2317"],
  "year": 2024,
  "quarter": 3,
  "force": false
}
```

**Request Body**:
| 欄位 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| stock_ids | Array[String] | N | 指定股票代碼（空則全部） |
| year | Integer | N | 指定年度（空則最新） |
| quarter | Integer | N | 指定季度（空則最新） |
| force | Boolean | N | 是否強制重新計算 |

**Response** (成功):
```json
{
  "success": true,
  "timestamp": "2024-12-27T09:05:00+08:00",
  "data": {
    "execution_id": 12345,
    "job_name": "CALCULATE_FUNDAMENTALS",
    "job_status": "RUNNING",
    "start_time": "2024-12-27T09:05:00+08:00",
    "parameters": {
      "stock_ids": ["2330", "2317"],
      "year": 2024,
      "quarter": 3,
      "force": false
    },
    "estimated_duration": "5 minutes"
  },
  "error": null
}
```

---

### 4.3 錯誤碼定義

遵守總綱 4.4 錯誤碼規範。

| 錯誤碼 | HTTP Status | 說明 | 處理建議 |
|-------|------------|------|---------|
| M08_STOCK_001 | 404 | 股票不存在 | 檢查股票代碼 |
| M08_DATA_001 | 404 | 查無財務資料 | 確認年度季度或補齊資料 |
| M08_PARAM_001 | 400 | 參數錯誤 | 檢查參數格式與值域 |
| M08_CALCULATION_001 | 422 | 財務指標計算失敗 | 檢查財報資料完整性 |
| M08_INDICATOR_001 | 400 | 不支援的指標 | 檢查指標名稱 |
| M08_JOB_001 | 409 | Job 已在執行中 | 等待當前 Job 完成 |
| M08_DB_001 | 500 | 資料庫錯誤 | 聯絡系統管理員 |

---

## 5. 資料流設計

### 5.1 資料流總覽

```
┌─────────────────────────────────────────────────────────────┐
│                M06 資料管理模組                              │
│           financial_statements 表                            │
│           (營收、淨利、總資產、現金流等)                      │
└─────────────────────────────────────────────────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  財報資料讀取層  │
                    │  - 查詢最新財報  │
                    │  - 查詢歷史財報  │
                    │  - 資料驗證      │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  指標計算層      │
                    │  - 估值指標      │
                    │  - 獲利指標      │
                    │  - 財務結構      │
                    │  - 償債能力      │
                    │  - 經營效率      │
                    │  - 現金流量      │
                    │  - 成長性        │
                    │  - 股利政策      │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  綜合評分層      │
                    │  - Piotroski    │
                    │  - Altman       │
                    │  - Beneish      │
                    │  - Graham       │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  異常偵測層      │
                    │  - 盈餘品質檢查  │
                    │  - 負債風險檢查  │
                    │  - 流動性檢查    │
                    │  - 獲利惡化檢查  │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  資料儲存層      │
                    │  - UPSERT 指標   │
                    │  - UPSERT 評分   │
                    │  - INSERT 警示   │
                    │  - Transaction   │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  快取更新層      │
                    │  - Redis 寫入    │
                    │  - 設定 TTL      │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │  結果記錄層      │
                    │  - Job 記錄      │
                    │  - 統計資訊      │
                    │  - 告警觸發      │
                    └─────────────────┘
```

### 5.2 財務指標計算流程

```
START: 財務指標計算 Job 觸發（每週一 09:00 或事件觸發）
  ↓
1. 建立 Job 執行記錄（job_executions 表）
   - job_name = 'CALCULATE_FUNDAMENTALS'
   - job_status = 'RUNNING'
   - start_time = CURRENT_TIMESTAMP
  ↓
2. 查詢最近一季新增或更新的財報資料
   - 從 financial_statements 表
   - WHERE updated_at > last_job_time
   - 或手動指定 stock_ids, year, quarter
  ↓
3. 對每檔股票每季財報執行計算
  ↓
4. 讀取財報資料
   - 查詢 financial_statements 表
   - 驗證資料完整性（營收、淨利、總資產、股東權益必填）
   ├─ 資料不完整 → 記錄 data_quality_issues，跳過該股票
   └─ 資料完整 → 繼續
  ↓
5. 查詢股價（用於估值指標）
   - 從 stock_prices 表查詢財報公告日收盤價
   - 若當日無交易，取最近交易日收盤價
  ↓
6. 計算估值指標
   - P/E = 股價 / EPS
   - P/B = 股價 / (股東權益 / 流通股數)
   - P/S = 股價 / (營收 / 流通股數)
   - P/CF = 股價 / (營運現金流 / 流通股數)
   - P/FCF = 股價 / (自由現金流 / 流通股數)
   - PEG = P/E / EPS成長率
   - EV/EBITDA = (市值 + 負債 - 現金) / EBITDA
  ↓
7. 計算獲利能力指標
   - 毛利率 = (營收 - 營業成本) / 營收 × 100%
   - 營業利益率 = 營業利益 / 營收 × 100%
   - 淨利率 = 稅後淨利 / 營收 × 100%
   - ROE = 稅後淨利 / 股東權益 × 100%
   - ROA = 稅後淨利 / 總資產 × 100%
   - EPS = 稅後淨利 / 流通股數
  ↓
8. 計算財務結構指標
   - 負債權益比 = 總負債 / 股東權益
   - 負債比率 = 總負債 / 總資產 × 100%
   - 權益比率 = 股東權益 / 總資產 × 100%
  ↓
9. 計算償債能力指標
   - 流動比率 = 流動資產 / 流動負債
   - 速動比率 = (流動資產 - 存貨) / 流動負債
   - 現金比率 = (現金 + 約當現金) / 流動負債
   - 利息保障倍數 = EBIT / 利息費用
  ↓
10. 計算經營效率指標
    - 總資產週轉率 = 營收 / 平均總資產
    - 存貨週轉率 = 營業成本 / 平均存貨
    - 應收帳款週轉率 = 營收 / 平均應收帳款
    - DIO = 365 / 存貨週轉率
    - DSO = 365 / 應收帳款週轉率
    - DPO = 365 / 應付帳款週轉率
    - 現金週轉週期 = DIO + DSO - DPO
  ↓
11. 計算現金流量指標
    - 自由現金流 = 營運現金流 - 資本支出
    - FCF Yield = FCF / 市值 × 100%
    - 營運現金流比率 = 營運現金流 / 流動負債
    - 應計項目比率 = (淨利 - 營運現金流) / 總資產
  ↓
12. 計算成長性指標（需查詢歷史財報）
    - 營收成長率 YoY = (本季營收 - 去年同季營收) / 去年同季營收 × 100%
    - EPS成長率 YoY = (本季EPS - 去年同季EPS) / 去年同季EPS × 100%
    - 營收 CAGR 3年/5年
    - EPS CAGR 3年/5年
  ↓
13. 計算股利政策指標
    - 現金殖利率 = 每股股利 / 股價 × 100%
    - 股利發放率 = 每股股利 / EPS × 100%
  ↓
14. 驗證計算結果
    - 檢查 NULL、NaN、Inf
    - 檢查範圍合理性（如 ROE > 100%）
    - 檢查一致性（權益比 + 負債比 ≈ 100%）
    ├─ 驗證失敗 → 記錄 data_quality_issues，標記異常值
    └─ 驗證通過 → 繼續
  ↓
15. 計算綜合評分
    - Piotroski F-Score (0-9)
    - Altman Z-Score
    - Beneish M-Score
    - Graham Score
    - 自訂綜合評分 (0-100)
  ↓
16. 偵測財務異常
    - 應計項目比率 > 10% → 盈餘品質警示
    - 負債比 > 70% → 高負債警示
    - 流動比 < 1.0 → 流動性風險警示
    - FCF 連續 2 季為負 → 現金流警示
    - ROE 連續 2 季下降且 < 10% → 獲利惡化警示
  ↓
17. 使用 MyBatis 批次 UPSERT 儲存
    - INSERT INTO fundamental_indicators ... ON CONFLICT DO UPDATE
    - INSERT INTO financial_scores ... ON CONFLICT DO UPDATE
    - INSERT INTO financial_alerts ... (若偵測到異常)
    - Transaction 保護
  ↓
18. 更新 Redis 快取（僅熱門股票）
    - Key: fund:indicators:{stock_id}:{year}:{quarter}
    - TTL: 24 小時
  ↓
19. 產生信號並發布（若偵測到異常）
    - 遵守總綱 4.2 Signal Contract
    - signal_type = 'SELL' 或 'HOLD'
    - signal_source = 'M08_FUNDAMENTAL'
    - evidence_data 包含異常細節
  ↓
20. 更新 Job 執行記錄
    - job_status = 'SUCCESS'
    - end_time = CURRENT_TIMESTAMP
    - processed_count, success_count, failed_count
  ↓
END
```

### 5.3 綜合評分計算流程

```
START: 綜合評分計算（在指標計算完成後）
  ↓
1. Piotroski F-Score 計算 (0-9)
  ↓
  1a. 獲利能力 (4分)
      - ROA > 0 → +1
      - 營運現金流 > 0 → +1
      - ROA 增加 → +1
      - 營運現金流 > 淨利 → +1
  ↓
  1b. 財務結構/槓桿 (3分)
      - 長期負債減少 → +1
      - 流動比率增加 → +1
      - 未發行新股稀釋 → +1
  ↓
  1c. 經營效率 (2分)
      - 毛利率增加 → +1
      - 總資產週轉率增加 → +1
  ↓
2. Altman Z-Score 計算
  ↓
  Z = 1.2 × (營運資金/總資產)
    + 1.4 × (保留盈餘/總資產)
    + 3.3 × (稅前息前盈餘/總資產)
    + 0.6 × (股東權益市值/總負債)
    + 1.0 × (營收/總資產)
  ↓
  判斷:
  - Z > 2.99 → SAFE (安全)
  - 1.81 < Z < 2.99 → GREY (灰色地帶)
  - Z < 1.81 → DISTRESS (財務困境)
  ↓
3. Beneish M-Score 計算（會計操縱偵測）
  ↓
  M = -4.84 + 0.92×DSRI + 0.528×GMI + 0.404×AQI
    + 0.892×SGI + 0.115×DEPI - 0.172×SGAI
    + 4.679×TATA - 0.327×LVGI
  ↓
  判斷:
  - M < -2.22 → CLEAN (盈餘品質良好)
  - -2.22 < M < -1.78 → WARNING (需注意)
  - M > -1.78 → MANIPULATOR (可能會計操縱)
  ↓
4. Graham Score 計算 (0-10)
  ↓
  評分項目:
  - EPS 連續 5 年成長 → +1
  - 股利連續 20 年發放 → +1
  - 負債比 < 50% → +1
  - 流動比 > 2.0 → +1
  - P/E < 15 → +1
  - P/B < 1.5 → +1
  - ROE > 15% → +1
  - 毛利率 > 40% → +1
  - 自由現金流 > 0 → +1
  - 殖利率 > 3% → +1
  ↓
5. 自訂綜合評分 (0-100)
  ↓
  - 估值 (20分): P/E, P/B, PEG
  - 獲利 (30分): ROE, 淨利率, EPS成長
  - 財務健全 (20分): 負債比, 流動比, FCF
  - 成長性 (15分): 營收成長, EPS成長
  - 股利 (15分): 殖利率, 股利發放率
  ↓
  評級:
  - 90-100 → A+
  - 80-89 → A
  - 70-79 → B+
  - 60-69 → B
  - 50-59 → C+
  - 40-49 → C
  - 30-39 → D
  - 0-29 → F
  ↓
6. 儲存評分結果
   - INSERT INTO financial_scores
  ↓
END
```

### 5.4 財務異常偵測流程

```
START: 財務異常偵測（在指標計算完成後）
  ↓
1. 盈餘品質檢查
  ↓
  1a. 應計項目比率檢查
      - 應計比率 = (淨利 - 營運現金流) / 總資產
      - 若 應計比率 > 10% → 觸發 EARNINGS_QUALITY 警示
  ↓
  1b. 現金流與淨利比較
      - 若 營運現金流 < 淨利 × 0.7 → 觸發 EARNINGS_QUALITY 警示
  ↓
  1c. 自由現金流趨勢
      - 查詢最近 2 季 FCF
      - 若連續 2 季 FCF < 0 → 觸發 EARNINGS_QUALITY 警示（燒錢）
  ↓
2. 負債風險檢查
  ↓
  2a. 負債比率檢查
      - 若 負債比 > 70% → 觸發 DEBT_RISK 警示（HIGH）
      - 若 負債比 > 60% → 觸發 DEBT_RISK 警示（MEDIUM）
  ↓
  2b. 負債權益比檢查
      - 若 負債權益比 > 2.0 → 觸發 DEBT_RISK 警示
  ↓
  2c. 利息保障倍數檢查
      - 若 利息保障倍數 < 1.5 → 觸發 DEBT_RISK 警示（CRITICAL）
  ↓
3. 流動性風險檢查
  ↓
  3a. 流動比率檢查
      - 若 流動比 < 1.0 → 觸發 LIQUIDITY_RISK 警示（HIGH）
      - 若 流動比 < 1.5 → 觸發 LIQUIDITY_RISK 警示（MEDIUM）
  ↓
  3b. 速動比率檢查
      - 若 速動比 < 0.8 → 觸發 LIQUIDITY_RISK 警示
  ↓
  3c. 現金比率檢查
      - 若 現金比 < 0.3 → 觸發 LIQUIDITY_RISK 警示
  ↓
4. 獲利能力惡化檢查
  ↓
  4a. ROE 趨勢檢查
      - 查詢最近 2 季 ROE
      - 若連續 2 季下降且最新 ROE < 10% → 觸發 PROFITABILITY_DECLINE 警示
  ↓
  4b. 毛利率趨勢檢查
      - 查詢最近 2 季毛利率
      - 若連續 2 季下降且最新毛利率 < 15% → 觸發 PROFITABILITY_DECLINE 警示
  ↓
  4c. 淨利率檢查
      - 若 淨利率 < 3% → 觸發 PROFITABILITY_DECLINE 警示
  ↓
5. 記錄警示
   - 若偵測到任何異常
   - INSERT INTO financial_alerts
   - 設定 severity (LOW, MEDIUM, HIGH, CRITICAL)
  ↓
6. 產生信號（若 severity >= MEDIUM）
   - 遵守總綱 4.2 Signal Contract
   - signal_type = 'SELL' 或 'HOLD'
   - signal_source = 'M08_FUNDAMENTAL_ALERT'
   - signal_name = alert_type
   - confidence_score = 根據 severity 設定（HIGH=75, MEDIUM=60）
   - evidence_data = alert_detail
  ↓
7. 發布事件
   - 發布 FinancialAlertDetected 事件至 M13
  ↓
END
```
## 6. Job/排程設計

### 6.1 Job 清單

| Job 編號 | Job 名稱 | 執行頻率 | 優先級 | 說明 |
|---------|---------|---------|-------|------|
| JOB-M08-001 | 財務指標計算 | 每週一 09:00 | P0 | 計算最新一季財務指標 |
| JOB-M08-002 | 綜合評分計算 | 每週一 09:30 | P0 | 計算 Piotroski、Altman 等評分 |
| JOB-M08-003 | 財務異常偵測 | 每週一 10:00 | P0 | 偵測財務異常並產生警示 |
| JOB-M08-004 | 歷史趨勢更新 | 每週一 11:00 | P1 | 更新指標歷史趨勢資料 |
| JOB-M08-005 | 快取預熱 | 每週一 11:30 | P1 | 熱門股票財務指標快取預熱 |
| JOB-M08-006 | 過期警示清理 | 每週日 02:00 | P2 | 清理已解決的舊警示記錄 |

### 6.2 核心 Job 設計

#### JOB-M08-001: 財務指標計算

**觸發方式**: 
- 定期排程：每週一 09:00
- 事件觸發：收到 M06 FinancialStatementUpdated 事件時立即執行

**Cron 表達式**: `0 0 9 * * MON`

**執行邏輯**:
1. 建立 Job 執行記錄（job_executions 表，status='RUNNING'）
2. 查詢最近一週新增或更新的財報資料
   - SELECT stock_id, year, quarter FROM financial_statements WHERE updated_at > :last_job_time
3. 批次處理（每批 20 檔股票）
4. 對每檔股票執行指標計算：
   - 從 financial_statements 表讀取財報資料
   - 從 stock_prices 表查詢股價（財報公告日）
   - 查詢歷史財報（用於計算成長率）
   - 計算 8 大類指標（估值、獲利、財務結構、償債、效率、現金流、成長、股利）
   - 驗證計算結果
   - 使用 MyBatis 批次 UPSERT 儲存至 fundamental_indicators 表
5. 更新 Redis 快取（熱門股票前 50 檔）
6. 記錄處理統計（成功、失敗、跳過）
7. 更新 Job 執行記錄（status='SUCCESS', 統計資訊）

**資料來源**:
- financial_statements 表（M06）
- stock_prices 表（M06）
- stocks 表（M06）

**冪等性設計**（遵守總綱 4.5 Job 模型）:
- 唯一鍵: (stock_id, year, quarter, report_type)
- 使用 UPSERT 機制（ON CONFLICT DO UPDATE）
- 若財報被修正，重新計算會覆蓋舊值
- 重複執行結果一致

**失敗處理**:
- 單一股票計算失敗不影響其他股票
- 記錄失敗原因至 data_quality_issues 表
- Job 整體失敗後觸發重試（最多 3 次）
- 連續失敗 3 次後發送告警

**效能優化**:
- 批次查詢財報資料（避免 N+1 查詢）
- 批次 UPSERT（每批 20 筆）
- 使用 MyBatis 動態 SQL 優化查詢
- 並行處理（5 個工作執行緒）

**執行時長估算**:
- 單檔股票：約 0.5 秒
- 1000 檔股票：約 8-10 分鐘
- 2000 檔股票：約 15-20 分鐘

---

#### JOB-M08-002: 綜合評分計算

**Cron 表達式**: `0 30 9 * * MON`

**執行邏輯**:
1. 查詢已完成指標計算的股票清單
   - SELECT stock_id, year, quarter FROM fundamental_indicators WHERE calculation_date = CURRENT_DATE
2. 對每檔股票計算綜合評分：
   - Piotroski F-Score（需查詢去年同期資料比較）
   - Altman Z-Score
   - Beneish M-Score（需查詢去年同期資料）
   - Graham Score
   - 自訂綜合評分（加權計算）
3. 使用 JPA 批次儲存至 financial_scores 表
4. 更新 Redis 快取
5. 記錄執行結果

**冪等性設計**:
- 唯一鍵: (stock_id, year, quarter)
- 使用 UPSERT 機制

**資料依賴**:
- JOB-M08-001 必須先執行完成
- 需要當季與去年同季的財務指標

**計算邏輯**:

**Piotroski F-Score**:
```
獲利能力 (4分):
1. ROA > 0 → +1
2. 營運現金流 > 0 → +1
3. ROA 增加（相較去年同季）→ +1
4. 營運現金流 > 淨利 → +1

財務結構/槓桿 (3分):
5. 長期負債減少（相較去年同季）→ +1
6. 流動比率增加（相較去年同季）→ +1
7. 未發行新股稀釋（流通股數不增加）→ +1

經營效率 (2分):
8. 毛利率增加（相較去年同季）→ +1
9. 總資產週轉率增加（相較去年同季）→ +1

總分: 0-9 分
- 8-9 分: 優秀
- 6-7 分: 良好
- 4-5 分: 普通
- 0-3 分: 較差
```

**Altman Z-Score**:
```
Z = 1.2 × X1 + 1.4 × X2 + 3.3 × X3 + 0.6 × X4 + 1.0 × X5

X1 = 營運資金 / 總資產
X2 = 保留盈餘 / 總資產
X3 = 稅前息前盈餘(EBIT) / 總資產
X4 = 股東權益市值 / 總負債
X5 = 營收 / 總資產

判斷:
- Z > 2.99: SAFE（安全區，破產風險低）
- 1.81 < Z < 2.99: GREY（灰色地帶）
- Z < 1.81: DISTRESS（財務困境區，破產風險高）
```

**Beneish M-Score**:
```
M = -4.84 + 0.92×DSRI + 0.528×GMI + 0.404×AQI + 0.892×SGI 
    + 0.115×DEPI - 0.172×SGAI + 4.679×TATA - 0.327×LVGI

其中:
DSRI = 應收帳款比率指數
GMI = 毛利率指數
AQI = 資產品質指數
SGI = 營收成長指數
DEPI = 折舊指數
SGAI = 銷管費用指數
TATA = 總應計項目
LVGI = 槓桿指數

判斷:
- M < -2.22: CLEAN（盈餘品質良好）
- -2.22 < M < -1.78: WARNING（需注意）
- M > -1.78: MANIPULATOR（可能會計操縱）
```

---

#### JOB-M08-003: 財務異常偵測

**Cron 表達式**: `0 0 10 * * MON`

**執行邏輯**:
1. 查詢已完成指標計算的股票清單
2. 對每檔股票執行異常偵測規則：
   - 盈餘品質檢查（應計項目比率、現金流與淨利比較）
   - 負債風險檢查（負債比、負債權益比、利息保障倍數）
   - 流動性風險檢查（流動比、速動比、現金比）
   - 獲利能力惡化檢查（ROE 趨勢、毛利率趨勢）
3. 若偵測到異常：
   - INSERT INTO financial_alerts（記錄警示）
   - 產生信號（遵守總綱 4.2 Signal Contract）
   - 發布 FinancialAlertDetected 事件至 M13
4. 記錄執行結果

**冪等性設計**:
- 同一股票、同一季度、同一異常類型只產生一次警示
- 若異常已存在且狀態為 ACTIVE，跳過重複警示

**異常偵測規則**:

**規則 1: 應計項目比率過高**
```sql
應計項目比率 = (淨利 - 營運現金流) / 總資產

IF 應計項目比率 > 10% THEN
  INSERT INTO financial_alerts (
    alert_type = 'HIGH_ACCRUAL_RATIO',
    alert_category = 'EARNINGS_QUALITY',
    severity = 'HIGH',
    alert_message = '應計項目比率過高，可能存在會計操縱風險'
  )
END IF
```

**規則 2: 負債比率過高**
```sql
IF 負債比 > 70% THEN
  INSERT INTO financial_alerts (
    alert_type = 'HIGH_DEBT_RATIO',
    alert_category = 'DEBT_RISK',
    severity = 'HIGH',
    alert_message = '負債比率過高，財務風險較大'
  )
ELSIF 負債比 > 60% THEN
  INSERT INTO financial_alerts (
    severity = 'MEDIUM'
  )
END IF
```

**規則 3: 流動比率過低**
```sql
IF 流動比 < 1.0 THEN
  INSERT INTO financial_alerts (
    alert_type = 'LOW_CURRENT_RATIO',
    alert_category = 'LIQUIDITY_RISK',
    severity = 'HIGH',
    alert_message = '流動比率小於1，短期償債能力不足'
  )
END IF
```

**規則 4: 自由現金流連續為負**
```sql
-- 查詢最近 2 季 FCF
SELECT fcf FROM fundamental_indicators 
WHERE stock_id = :stock_id 
ORDER BY year DESC, quarter DESC 
LIMIT 2

IF 兩季 FCF 皆 < 0 THEN
  INSERT INTO financial_alerts (
    alert_type = 'NEGATIVE_FCF_TREND',
    alert_category = 'EARNINGS_QUALITY',
    severity = 'MEDIUM',
    alert_message = '自由現金流連續2季為負，公司持續燒錢'
  )
END IF
```

**規則 5: ROE 持續惡化**
```sql
-- 查詢最近 2 季 ROE
SELECT roe FROM fundamental_indicators 
WHERE stock_id = :stock_id 
ORDER BY year DESC, quarter DESC 
LIMIT 2

IF ROE[0] < ROE[1] AND ROE[1] < ROE[2] AND ROE[0] < 10 THEN
  INSERT INTO financial_alerts (
    alert_type = 'ROE_DETERIORATION',
    alert_category = 'PROFITABILITY_DECLINE',
    severity = 'MEDIUM',
    alert_message = 'ROE連續下降且低於10%，獲利能力惡化'
  )
END IF
```

---

#### JOB-M08-004: 歷史趨勢更新

**Cron 表達式**: `0 0 11 * * MON`

**執行邏輯**:
1. 查詢已完成指標計算的股票清單
2. 對每檔股票更新指標歷史趨勢：
   - 查詢最近 20 季財務指標
   - 計算趨勢方向（上升、下降、震盪）
   - 計算波動率（標準差）
   - 計算最大值、最小值、平均值
3. 更新 Redis 快取（趨勢資料）
4. 記錄執行結果

**趨勢計算邏輯**:
```
對於每個指標（如 ROE）:
1. 查詢最近 20 季資料
2. 計算線性迴歸斜率
   - 斜率 > 0.5 → 上升趨勢
   - 斜率 < -0.5 → 下降趨勢
   - -0.5 <= 斜率 <= 0.5 → 震盪
3. 計算標準差（波動率）
4. 計算統計值（min, max, avg, median）
5. 更新 Redis:
   - Key: fund:trend:{stock_id}:{indicator}:20q
   - Value: {trend, volatility, statistics}
   - TTL: 7 天
```

---

#### JOB-M08-005: 快取預熱

**Cron 表達式**: `0 30 11 * * MON`

**執行邏輯**:
1. 查詢熱門股票清單（市值前 50 檔）
2. 對每檔熱門股票：
   - 載入最新一季財務指標
   - 載入最新綜合評分
   - 載入指標歷史趨勢（最近 20 季）
3. 批次寫入 Redis
4. 設定 TTL（24 小時）
5. 記錄快取命中率統計

**快取 Key 設計**:
```
fund:indicators:{stock_id}:{year}:{quarter}        → 單季所有指標
fund:score:{stock_id}:{year}:{quarter}             → 綜合評分
fund:trend:{stock_id}:{indicator}:20q              → 20季趨勢
fund:hot:stocks                                    → 熱門股票清單
```

**預熱策略**:
- 優先載入市值前 50 檔股票
- 包含最新 4 季資料（支援 QoQ、YoY 比較）
- 包含常用指標的 20 季歷史趨勢

---

#### JOB-M08-006: 過期警示清理

**Cron 表達式**: `0 0 2 * * SUN`（每週日 02:00）

**執行邏輯**:
1. 查詢已解決且超過 90 天的警示記錄
2. 批次刪除這些記錄
3. 記錄清理統計

**SQL 邏輯**:
```sql
-- 刪除已解決且超過 90 天的警示
DELETE FROM financial_alerts
WHERE alert_status = 'RESOLVED'
  AND resolved_at < CURRENT_TIMESTAMP - INTERVAL '90 days';

-- 刪除被忽略且超過 180 天的警示
DELETE FROM financial_alerts
WHERE alert_status = 'IGNORED'
  AND created_at < CURRENT_TIMESTAMP - INTERVAL '180 days';
```

---

### 6.3 Job 依賴關係

```
每週一:
09:00 - CALCULATE_FUNDAMENTALS (JOB-M08-001)
          ↓
09:30 - CALCULATE_SCORES (JOB-M08-002)
          ↓
10:00 - DETECT_FINANCIAL_ALERTS (JOB-M08-003)
          ↓
11:00 - UPDATE_TRENDS (JOB-M08-004)
          ↓
11:30 - WARM_UP_CACHE (JOB-M08-005)

每週日:
02:00 - CLEANUP_OLD_ALERTS (JOB-M08-006)
```

**關鍵依賴**:
- JOB-M08-002 依賴 JOB-M08-001（需要指標計算完成）
- JOB-M08-003 依賴 JOB-M08-001（需要指標計算完成）
- JOB-M08-004 依賴 JOB-M08-001（需要指標計算完成）
- JOB-M08-005 依賴 JOB-M08-001, JOB-M08-002（需要指標與評分完成）

---

### 6.4 Job 監控與告警

**監控指標**:
| 指標 | 閾值 | 告警等級 | 處理方式 |
|-----|------|---------|---------|
| Job 執行時長 | > 30 分鐘 | WARNING | 記錄慢查詢，優化批次大小 |
| Job 失敗率 | > 5% | ERROR | 立即告警，檢查資料品質 |
| Job 連續失敗 | >= 3 次 | CRITICAL | 立即告警並暫停，人工介入 |
| 計算失敗股票數 | > 100 檔 | WARNING | 檢查資料來源 |
| 財務異常警示數 | > 50 筆（HIGH以上） | WARNING | 檢視異常股票清單 |

**告警通道**（透過 M15 告警系統）:
- Email
- Slack
- SMS（CRITICAL 等級）

---

## 7. 業務邏輯設計

> **說明**: 本節以文字描述業務邏輯與演算法，不包含程式碼實作

### 7.1 Service 層架構

```
FundamentalAnalysisService (基本面分析服務 - 門面)
    │
    ├─→ IndicatorCalculationService (指標計算服務)
    │       ├─ 職責: 財務指標計算、驗證與儲存
    │       ├─ 依賴: FundamentalIndicatorRepository (JPA), IndicatorMapper (MyBatis)
    │       └─ 核心方法: 
    │           - calculateIndicators(stockId, year, quarter)
    │           - calculateValuationIndicators(financialData, stockPrice)
    │           - calculateProfitabilityIndicators(financialData)
    │           - calculateGrowthIndicators(currentData, historicalData)
    │
    ├─→ ScoreCalculationService (評分計算服務)
    │       ├─ 職責: 綜合評分計算（Piotroski、Altman、Beneish、Graham）
    │       ├─ 依賴: FinancialScoreRepository (JPA), IndicatorMapper (MyBatis)
    │       └─ 核心方法:
    │           - calculatePiotroskiScore(currentData, previousData)
    │           - calculateAltmanZScore(financialData, marketData)
    │           - calculateBeneishMScore(currentData, previousData)
    │           - calculateGrahamScore(indicators)
    │           - calculateCompositeScore(indicators)
    │
    ├─→ AnomalyDetectionService (異常偵測服務)
    │       ├─ 職責: 財務異常偵測、警示產生
    │       ├─ 依賴: FinancialAlertRepository (JPA), IndicatorMapper (MyBatis)
    │       └─ 核心方法:
    │           - detectEarningsQualityIssues(indicators)
    │           - detectDebtRisks(indicators)
    │           - detectLiquidityRisks(indicators)
    │           - detectProfitabilityDecline(indicators, historical)
    │           - generateAlert(alertType, severity, detail)
    │
    ├─→ TrendAnalysisService (趨勢分析服務)
    │       ├─ 職責: 指標歷史趨勢計算、統計分析
    │       ├─ 依賴: IndicatorMapper (MyBatis)
    │       └─ 核心方法:
    │           - calculateTrend(stockId, indicator, periods)
    │           - calculateStatistics(historicalData)
    │           - detectTrendDirection(historicalData)
    │
    ├─→ FinancialDataService (財務資料服務)
    │       ├─ 職責: 財報資料讀取、驗證
    │       ├─ 依賴: FinancialStatementMapper (MyBatis, 來自 M06)
    │       └─ 核心方法:
    │           - getFinancialStatement(stockId, year, quarter)
    │           - getHistoricalStatements(stockId, periods)
    │           - validateFinancialData(financialData)
    │
    └─→ CacheManagementService (快取管理服務)
            ├─ 職責: Redis 快取管理、預熱、失效
            ├─ 依賴: RedisTemplate
            └─ 核心方法:
                - cacheIndicators(stockId, year, quarter, indicators)
                - getIndicatorsFromCache(stockId, year, quarter)
                - warmUpCache(stockIds)
                - invalidateCache(stockId)
```

---

### 7.2 指標計算邏輯

#### 7.2.1 估值指標計算

**輸入**:
- 財報資料: 營收、淨利、總資產、股東權益、負債、現金、EBITDA
- 股價資料: 財報公告日收盤價
- 股本資料: 流通股數

**計算步驟**:

**步驟 1: 計算每股數值**
```
EPS = 稅後淨利 / 流通股數
BVPS (每股淨值) = 股東權益 / 流通股數
SPS (每股營收) = 營收 / 流通股數
CFPS (每股營運現金流) = 營運現金流 / 流通股數
FCFPS (每股自由現金流) = 自由現金流 / 流通股數
```

**步驟 2: 計算估值比率**
```
P/E = 股價 / EPS
P/B = 股價 / BVPS
P/S = 股價 / SPS
P/CF = 股價 / CFPS
P/FCF = 股價 / FCFPS
```

**步驟 3: 計算進階估值指標**
```
市值 = 股價 × 流通股數
企業價值 (EV) = 市值 + 總負債 - 現金及約當現金
EV/EBITDA = EV / EBITDA

PEG = P/E / EPS成長率
  - 需要查詢去年同季 EPS 計算成長率
  - 若成長率為負，PEG 設為 NULL

Tobin's Q = 市值 / 資產重置成本
  - 資產重置成本 ≈ 總資產（簡化計算）
  
Graham Number = √(22.5 × EPS × BVPS)
```

**驗證規則**:
- P/E、P/B、P/S 應 > 0（若為負表示虧損或淨值為負）
- 若 EPS < 0，P/E 設為 NULL
- 若 BVPS < 0，P/B 設為 NULL
- PEG 範圍通常 0-5（超過 5 可能異常）

---

#### 7.2.2 獲利能力指標計算

**輸入**:
- 財報資料: 營收、營業成本、營業利益、稅後淨利、總資產、股東權益

**計算步驟**:

**步驟 1: 計算利潤率**
```
毛利 = 營收 - 營業成本
毛利率 = 毛利 / 營收 × 100%

營業利益率 = 營業利益 / 營收 × 100%

淨利率 = 稅後淨利 / 營收 × 100%

EBITDA = 稅前息前盈餘 + 折舊 + 攤銷
EBITDA Margin = EBITDA / 營收 × 100%
```

**步驟 2: 計算報酬率**
```
ROE = 稅後淨利 / 股東權益 × 100%

ROA = 稅後淨利 / 總資產 × 100%

ROIC = NOPAT / 投入資本 × 100%
  - NOPAT (稅後營業利益) = 營業利益 × (1 - 稅率)
  - 投入資本 = 股東權益 + 有息負債
  - 稅率 = (稅前淨利 - 稅後淨利) / 稅前淨利
```

**步驟 3: 計算每股盈餘**
```
基本 EPS = 稅後淨利 / 流通股數

營業 EPS = 營業利益 / 流通股數

稀釋 EPS = 稅後淨利 / (流通股數 + 潛在稀釋股數)
  - 潛在稀釋股數包含可轉債、認股權等
```

**驗證規則**:
- 各利潤率範圍：-100% 到 100%（虧損公司可為負）
- ROE、ROA 範圍：-100% 到 100%
- ROE > 100% 視為異常，標記需人工檢查
- 毛利率 > 營業利益率 > 淨利率（正常情況）

---

#### 7.2.3 成長性指標計算

**輸入**:
- 當季財報資料
- 去年同季財報資料（YoY）
- 上季財報資料（QoQ）
- 過去 3 年、5 年財報資料（CAGR）

**計算步驟**:

**步驟 1: 計算年增率（YoY）**
```
營收成長率 YoY = (本季營收 - 去年同季營收) / 去年同季營收 × 100%

EPS 成長率 YoY = (本季EPS - 去年同季EPS) / 去年同季EPS × 100%

淨利成長率 YoY = (本季淨利 - 去年同季淨利) / 去年同季淨利 × 100%

ROE 成長率 YoY = (本季ROE - 去年同季ROE) / 去年同季ROE × 100%
```

**步驟 2: 計算季增率（QoQ）**
```
營收成長率 QoQ = (本季營收 - 上季營收) / 上季營收 × 100%

EPS 成長率 QoQ = (本季EPS - 上季EPS) / 上季EPS × 100%
```

**步驟 3: 計算複合年成長率（CAGR）**
```
營收 CAGR 3年 = [(本季營收 / 3年前同季營收)^(1/3) - 1] × 100%

營收 CAGR 5年 = [(本季營收 / 5年前同季營收)^(1/5) - 1] × 100%

EPS CAGR 3年 = [(本季EPS / 3年前同季EPS)^(1/3) - 1] × 100%

EPS CAGR 5年 = [(本季EPS / 5年前同季EPS)^(1/5) - 1] × 100%
```

**特殊處理**:
- 若去年同季值為 0，成長率設為 NULL
- 若去年同季為負、本季為正（虧轉盈），成長率設為 999%（標記特殊情況）
- 若去年同季為正、本季為負（盈轉虧），成長率設為 -999%（標記特殊情況）
- 若歷史資料不足 3 年或 5 年，CAGR 設為 NULL

---

#### 7.2.4 現金流量指標計算

**輸入**:
- 財報資料: 營運現金流、資本支出、淨利、總資產、流動負債、營收

**計算步驟**:

**步驟 1: 計算自由現金流**
```
自由現金流 (FCF) = 營運現金流 - 資本支出
```

**步驟 2: 計算現金流比率**
```
FCF Yield = FCF / 市值 × 100%

營運現金流比率 = 營運現金流 / 流動負債

現金流營收比 = 營運現金流 / 營收 × 100%
```

**步驟 3: 計算應計項目比率（盈餘品質）**
```
應計項目 = 稅後淨利 - 營運現金流

應計項目比率 = 應計項目 / 總資產 × 100%
```

**解讀**:
- FCF > 0: 公司有剩餘現金可分配
- FCF < 0: 公司資本支出大於營運現金流，可能在擴張期
- 應計項目比率 < 5%: 盈餘品質良好
- 應計項目比率 > 10%: 盈餘品質堪慮，可能有會計操縱

---

### 7.3 綜合評分計算邏輯

#### 7.3.1 Piotroski F-Score 計算

**資料需求**:
- 當季指標
- 去年同季指標（用於比較）
- 流通股數（當季與去年同季）

**計算步驟**:

**獲利能力 (4分)**:
```
1. ROA > 0 → +1 分
2. 營運現金流 > 0 → +1 分
3. ROA 增加（當季 ROA > 去年同季 ROA）→ +1 分
4. 營運現金流 > 淨利（現金獲利能力強）→ +1 分
```

**財務結構/槓桿 (3分)**:
```
5. 長期負債減少（當季長期負債 < 去年同季長期負債）→ +1 分
6. 流動比率增加（當季流動比 > 去年同季流動比）→ +1 分
7. 未發行新股稀釋（當季流通股數 <= 去年同季流通股數）→ +1 分
```

**經營效率 (2分)**:
```
8. 毛利率增加（當季毛利率 > 去年同季毛利率）→ +1 分
9. 總資產週轉率增加（當季週轉率 > 去年同季週轉率）→ +1 分
```

**總分範圍**: 0-9 分
- 8-9 分: 優秀（財務體質非常健全）
- 6-7 分: 良好
- 4-5 分: 普通
- 0-3 分: 較差（財務體質不佳）

**JSONB 儲存格式**:
```json
{
  "profitability": {
    "roa_positive": 1,
    "ocf_positive": 1,
    "roa_increasing": 1,
    "ocf_gt_ni": 1,
    "total": 4
  },
  "leverage": {
    "debt_decreasing": 1,
    "current_ratio_increasing": 1,
    "shares_not_increasing": 0,
    "total": 2
  },
  "operating_efficiency": {
    "gross_margin_increasing": 1,
    "asset_turnover_increasing": 1,
    "total": 2
  },
  "total_score": 8
}
```

---

#### 7.3.2 Altman Z-Score 計算

**資料需求**:
- 財報資料: 營運資金、保留盈餘、EBIT、總資產、總負債、營收
- 市場資料: 股價、流通股數（計算市值）

**計算步驟**:

**步驟 1: 計算各項係數**
```
X1 = 營運資金 / 總資產
  - 營運資金 = 流動資產 - 流動負債

X2 = 保留盈餘 / 總資產
  - 保留盈餘 = 股東權益 - 股本

X3 = 稅前息前盈餘(EBIT) / 總資產

X4 = 股東權益市值 / 總負債
  - 股東權益市值 = 股價 × 流通股數

X5 = 營收 / 總資產
  - 即總資產週轉率
```

**步驟 2: 計算 Z-Score**
```
Z = 1.2 × X1 + 1.4 × X2 + 3.3 × X3 + 0.6 × X4 + 1.0 × X5
```

**步驟 3: 判斷財務狀況**
```
IF Z > 2.99 THEN
  status = 'SAFE'
  interpretation = '安全區：破產風險低'
ELSIF Z > 1.81 THEN
  status = 'GREY'
  interpretation = '灰色地帶：需持續關注'
ELSE
  status = 'DISTRESS'
  interpretation = '財務困境區：破產風險高'
END IF
```

**JSONB 儲存格式**:
```json
{
  "working_capital_to_assets": 0.35,
  "retained_earnings_to_assets": 0.45,
  "ebit_to_assets": 0.18,
  "market_value_to_liabilities": 5.20,
  "sales_to_assets": 0.75,
  "z_score": 3.85,
  "status": "SAFE",
  "interpretation": "安全區：破產風險低"
}
```

---

#### 7.3.3 Beneish M-Score 計算（會計操縱偵測）

**資料需求**:
- 當季財報
- 去年同季財報（用於計算各項指數）

**計算步驟**:

**步驟 1: 計算 8 個指數**
```
DSRI (應收帳款比率指數) = (應收帳款t / 營收t) / (應收帳款t-1 / 營收t-1)

GMI (毛利率指數) = 毛利率t-1 / 毛利率t
  - 毛利率下降時 GMI > 1

AQI (資產品質指數) = (1 - 流動資產t - 固定資產t) / (1 - 流動資產t-1 - 固定資產t-1)

SGI (營收成長指數) = 營收t / 營收t-1

DEPI (折舊指數) = 折舊率t-1 / 折舊率t

SGAI (銷管費用指數) = (銷管費用t / 營收t) / (銷管費用t-1 / 營收t-1)

LVGI (槓桿指數) = 槓桿t / 槓桿t-1
  - 槓桿 = (流動負債 + 長期負債) / 總資產

TATA (總應計項目) = (營運資金變動 - 折舊) / 總資產
```

**步驟 2: 計算 M-Score**
```
M = -4.84 + 0.92×DSRI + 0.528×GMI + 0.404×AQI + 0.892×SGI 
    + 0.115×DEPI - 0.172×SGAI + 4.679×TATA - 0.327×LVGI
```

**步驟 3: 判斷盈餘品質**
```
IF M < -2.22 THEN
  status = 'CLEAN'
  interpretation = '盈餘品質良好，會計操縱風險低'
ELSIF M < -1.78 THEN
  status = 'WARNING'
  interpretation = '需注意，存在部分會計操縱跡象'
ELSE
  status = 'MANIPULATOR'
  interpretation = '高度懷疑會計操縱，盈餘品質堪慮'
END IF
```

---

### 7.4 資料驗證邏輯

#### 7.4.1 財報資料完整性驗證

**驗證步驟**:

**步驟 1: 檢查必填欄位**
```
必填欄位清單:
- 營收 (revenue)
- 稅後淨利 (net_income)
- 總資產 (total_assets)
- 股東權益 (equity)
- 流通股數 (shares_outstanding)

IF 任一必填欄位為 NULL THEN
  記錄 data_quality_issues
  跳過該股票
END IF
```

**步驟 2: 檢查數值合理性**
```
IF 總資產 <= 0 THEN
  記錄錯誤: 總資產必須為正
END IF

IF 流通股數 <= 0 THEN
  記錄錯誤: 流通股數必須為正
END IF

IF 營收 < 0 THEN
  記錄警告: 營收為負（特殊情況）
END IF
```

**步驟 3: 檢查會計等式**
```
IF |總資產 - (總負債 + 股東權益)| > 1000 THEN
  記錄錯誤: 資產負債表不平衡
  差異 = |總資產 - (總負債 + 股東權益)|
END IF
```

---

#### 7.4.2 指標計算結果驗證

**驗證步驟**:

**步驟 1: 檢查 NULL 與 NaN**
```
FOR EACH 指標 IN 計算結果
  IF 指標值 IS NULL OR 指標值 IS NaN OR 指標值 IS Inf THEN
    記錄警告: 指標計算結果異常
    將該指標設為 NULL
  END IF
END FOR
```

**步驟 2: 檢查範圍合理性**
```
IF ROE > 100% OR ROE < -100% THEN
  記錄警告: ROE 超出合理範圍
  標記需人工檢查
END IF

IF 負債比 > 200% THEN
  記錄警告: 負債比異常高（淨值可能為負）
END IF

IF 毛利率 > 95% THEN
  記錄警告: 毛利率異常高
END IF

IF 毛利率 < -50% THEN
  記錄警告: 毛利率異常低
END IF
```

**步驟 3: 檢查邏輯一致性**
```
IF 權益比 + 負債比 不約等於 100% THEN
  IF |權益比 + 負債比 - 100| > 5 THEN
    記錄錯誤: 權益比與負債比不一致
  END IF
END IF

IF 毛利率 < 營業利益率 THEN
  記錄警告: 毛利率應大於營業利益率（異常情況）
END IF

IF 營業利益率 < 淨利率 THEN
  記錄警告: 營業利益率應大於淨利率（可能有業外大額收入）
END IF
```

---

## 8. 整合點

### 8.1 對外部系統的依賴

| 外部系統 | 用途 | 協議 | 資料格式 | 限制 |
|---------|------|------|---------|------|
| 無 | - | - | - | - |

M08 模組不依賴外部系統，所有資料來自 M06。

### 8.2 對內部模組的依賴

| 上游模組 | 使用的資料/API | 呼叫頻率 | 說明 |
|---------|--------------|---------|------|
| M06 資料管理模組 | financial_statements 表 | 每週一次（Job） | 讀取財報資料 |
| M06 資料管理模組 | stock_prices 表 | 每週一次（Job） | 讀取股價資料（用於估值指標） |
| M06 資料管理模組 | stocks 表 | 每週一次（Job） | 讀取股本資料 |

### 8.3 對內部模組的提供

| 下游模組 | 使用的 API | 呼叫頻率 | 說明 |
|---------|-----------|---------|------|
| M13 信號判斷引擎 | GET /api/stocks/{id}/fundamentals | 高頻 | 查詢財務指標用於信號判斷 |
| M13 信號判斷引擎 | GET /api/stocks/{id}/scores | 高頻 | 查詢綜合評分 |
| M13 信號判斷引擎 | GET /api/stocks/{id}/alerts | 高頻 | 查詢財務警示 |
| M14 選股引擎 | POST /api/fundamentals/batch | 高頻 | 批次查詢財務指標用於選股篩選 |
| M14 選股引擎 | POST /api/fundamentals/trends | 中頻 | 查詢指標歷史趨勢 |
| M16 回測系統 | POST /api/fundamentals/batch | 中頻 | 批次查詢歷史財務指標用於回測 |
| M17 風險管理模組 | GET /api/stocks/{id}/fundamentals | 中頻 | 查詢財務指標評估風險 |

### 8.4 事件發布

| 事件名稱 | 觸發條件 | 訂閱者 | 事件內容 |
|---------|---------|-------|---------|
| FundamentalIndicatorsCalculated | 財務指標計算完成 | M13, M14 | stock_id, year, quarter, calculation_date |
| FinancialScoreUpdated | 綜合評分更新 | M13, M14 | stock_id, year, quarter, piotroski_score, altman_z_score |
| FinancialAlertDetected | 偵測到財務異常 | M13, M15 | stock_id, year, quarter, alert_type, severity, detail |

**事件發布機制**:
- 使用 Spring ApplicationEventPublisher
- 非同步處理（避免阻塞主流程）
- 失敗重試機制（最多 3 次）

---

## 9. 效能考量

### 9.1 效能目標

參照總綱 NFR：

| 指標 | 目標值 | 說明 |
|-----|-------|------|
| API 回應時間 (P95) | < 300ms | 單一股票查詢 |
| API 回應時間 (P95) | < 1000ms | 批次查詢（10 檔股票） |
| Job 執行時間 | < 20 分鐘 | 2000 檔股票指標計算 |
| 資料庫查詢時間 (P95) | < 100ms | 單一查詢 |
| Redis 快取命中率 | > 80% | 熱門股票 |

### 9.2 資料庫優化策略

#### 9.2.1 索引策略

**fundamental_indicators 表**:
```sql
-- 主要查詢索引
CREATE INDEX idx_fundamental_indicators_stock_id ON fundamental_indicators(stock_id);
CREATE INDEX idx_fundamental_indicators_year_quarter ON fundamental_indicators(year, quarter);
CREATE INDEX idx_fundamental_indicators_calculation_date ON fundamental_indicators(calculation_date);

-- 複合索引（用於常見查詢模式）
CREATE INDEX idx_fundamental_indicators_stock_year_quarter 
  ON fundamental_indicators(stock_id, year DESC, quarter DESC);

-- GIN 索引（加速 JSONB 查詢）
CREATE INDEX idx_fundamental_indicators_valuation 
  ON fundamental_indicators USING GIN(valuation_indicators);
CREATE INDEX idx_fundamental_indicators_profitability 
  ON fundamental_indicators USING GIN(profitability_indicators);
```

**financial_scores 表**:
```sql
CREATE INDEX idx_financial_scores_stock_id ON financial_scores(stock_id);
CREATE INDEX idx_financial_scores_year_quarter ON financial_scores(year, quarter);
CREATE INDEX idx_financial_scores_piotroski ON financial_scores(piotroski_f_score DESC);
CREATE INDEX idx_financial_scores_composite ON financial_scores(composite_score DESC);
```

**financial_alerts 表**:
```sql
CREATE INDEX idx_financial_alerts_stock_id ON financial_alerts(stock_id);
CREATE INDEX idx_financial_alerts_severity ON financial_alerts(severity);
CREATE INDEX idx_financial_alerts_status ON financial_alerts(alert_status);
CREATE INDEX idx_financial_alerts_category ON financial_alerts(alert_category);
```

---

#### 9.2.2 查詢優化

**優化策略 1: 避免 N+1 查詢**
```
錯誤做法:
FOR EACH stock IN stock_list
  SELECT * FROM fundamental_indicators WHERE stock_id = stock.id
END FOR

正確做法:
SELECT * FROM fundamental_indicators 
WHERE stock_id IN ('2330', '2317', '2454', ...)
```

**優化策略 2: 使用 JSONB 索引加速查詢**
```sql
-- 使用 GIN 索引查詢
SELECT stock_id, year, quarter,
       profitability_indicators->>'roe' as roe
FROM fundamental_indicators 
WHERE (profitability_indicators->>'roe')::numeric > 20.0
  AND year = 2024 AND quarter = 3;

-- 效能: 使用 GIN 索引，快速過濾
```

**優化策略 3: 批次查詢歷史資料**
```sql
-- 一次查詢多季資料
SELECT stock_id, year, quarter, roe, eps_growth
FROM fundamental_indicators 
WHERE stock_id = '2330'
  AND (year, quarter) >= (2020, 1)
  AND (year, quarter) <= (2024, 3)
ORDER BY year DESC, quarter DESC;
```

---

#### 9.2.3 批次寫入優化

**MyBatis 批次 UPSERT**:
```xml
<insert id="batchUpsert" parameterType="java.util.List">
  INSERT INTO fundamental_indicators (
    stock_id, year, quarter, report_type,
    valuation_indicators, profitability_indicators,
    pe_ratio, pb_ratio, roe, eps
  ) VALUES
  <foreach collection="list" item="item" separator=",">
    (
      #{item.stockId}, #{item.year}, #{item.quarter}, #{item.reportType},
      #{item.valuationIndicators}::jsonb, #{item.profitabilityIndicators}::jsonb,
      #{item.peRatio}, #{item.pbRatio}, #{item.roe}, #{item.eps}
    )
  </foreach>
  ON CONFLICT (stock_id, year, quarter, report_type)
  DO UPDATE SET
    valuation_indicators = EXCLUDED.valuation_indicators,
    profitability_indicators = EXCLUDED.profitability_indicators,
    pe_ratio = EXCLUDED.pe_ratio,
    pb_ratio = EXCLUDED.pb_ratio,
    roe = EXCLUDED.roe,
    eps = EXCLUDED.eps,
    updated_at = CURRENT_TIMESTAMP;
</insert>
```

**批次大小**:
- 每批 20-50 筆（平衡記憶體與效能）
- 使用 Transaction 保護每批次
- 批次失敗後重試單筆（隔離錯誤）

---

### 9.3 快取優化策略

#### 9.3.1 快取層次設計

**L1 快取（應用層）**:
- 使用 Caffeine 本機快取
- 快取指標定義、參數配置
- TTL: 永久（配置變更時主動失效）

**L2 快取（Redis）**:
- 快取熱門股票財務指標
- 快取綜合評分
- 快取指標歷史趨勢

**快取 Key 設計**:
```
fund:indicators:{stock_id}:{year}:{quarter}        → 單季所有指標
fund:score:{stock_id}:{year}:{quarter}             → 綜合評分
fund:trend:{stock_id}:{indicator}:20q              → 20季趨勢
fund:hot:stocks                                    → 熱門股票清單
```

---

#### 9.3.2 快取更新策略

**策略 1: 主動更新（Write-Through）**
```
當財務指標計算完成時:
1. 寫入資料庫
2. 同步寫入 Redis 快取
3. 設定 TTL = 24 小時
```

**策略 2: 失效更新（Cache-Aside）**
```
當查詢時:
1. 檢查 Redis 快取
2. 若命中，返回快取結果
3. 若未命中，查詢資料庫
4. 將結果寫入 Redis（TTL = 24 小時）
5. 返回結果
```

**策略 3: 定期預熱**
```
每週一 11:30（JOB-M08-005）:
1. 查詢市值前 50 檔股票
2. 批次載入最新 4 季財務指標
3. 批次寫入 Redis
4. 設定 TTL = 24 小時
```

---

#### 9.3.3 快取失效策略

**自動失效**:
- TTL 到期自動失效
- LRU 演算法淘汰冷資料

**主動失效**:
- 財務指標重新計算完成 → 刪除舊快取
- 財報資料修正 → 刪除相關快取

**批次失效**:
```java
// 刪除某股票所有快取
public void invalidateStockCache(String stockId) {
    Set<String> keys = redisTemplate.keys("fund:*:" + stockId + ":*");
    if (keys != null && !keys.isEmpty()) {
        redisTemplate.delete(keys);
    }
}
```

---

### 9.4 Job 效能優化

#### 9.4.1 並行處理

**策略**:
- 使用 Java ExecutorService 並行處理
- 工作執行緒池大小: 5-10 個執行緒
- 每個執行緒處理一批股票（20 檔）

**範例架構**:
```
Job 主執行緒:
  ├─ 查詢待處理股票清單 (2000 檔)
  ├─ 分批 (每批 20 檔，共 100 批)
  ├─ 提交至執行緒池 (5 個工作執行緒)
  │    ├─ Worker 1: 處理批次 1-20
  │    ├─ Worker 2: 處理批次 21-40
  │    ├─ Worker 3: 處理批次 41-60
  │    ├─ Worker 4: 處理批次 61-80
  │    └─ Worker 5: 處理批次 81-100
  └─ 等待所有批次完成
```

---

#### 9.4.2 增量計算

**策略**:
- 只計算新增或更新的財報
- 使用 updated_at 欄位判斷

**SQL 邏輯**:
```sql
-- 查詢最近一週新增或更新的財報
SELECT stock_id, year, quarter
FROM financial_statements
WHERE updated_at > (SELECT MAX(end_time) FROM job_executions WHERE job_name = 'CALCULATE_FUNDAMENTALS')
  OR updated_at > CURRENT_TIMESTAMP - INTERVAL '7 days';
```

**效益**:
- 平時每週只需計算 50-100 檔股票
- 節省 95% 計算時間

---

### 9.5 容量規劃

**資料表容量估算**:

| 資料表 | 每筆大小 | 每季新增 | 每年新增 | 5年總量 |
|-------|---------|---------|---------|---------|
| fundamental_indicators | 5 KB | 2000 筆 | 8000 筆 | 40000 筆 (200 MB) |
| financial_scores | 2 KB | 2000 筆 | 8000 筆 | 40000 筆 (80 MB) |
| financial_alerts | 1 KB | 500 筆 | 2000 筆 | 10000 筆 (10 MB) |

**Redis 容量估算**:
- 熱門股票 50 檔 × 4 季 × 5 KB = 1 MB
- 指標趨勢 50 檔 × 10 指標 × 2 KB = 1 MB
- 總計: 約 5 MB（含其他快取）

**資料庫連接池配置**:
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

---

## 10. 測試準則

### 10.1 單元測試

#### 10.1.1 測試場景

**場景 1: 估值指標計算測試**
```
Given: 
- 財報資料: 營收=2263億, 淨利=934億, 總資產=5兆, 股東權益=3.5兆
- 股價=580, 流通股數=259億股

When: 
- 計算估值指標

Then:
- P/E ≈ 16.08
- P/B ≈ 4.29
- P/S ≈ 6.63
- 所有指標非 NULL, 非 NaN
```

**場景 2: 獲利能力指標計算測試**
```
Given:
- 營收=2263億, 營業成本=1052億, 營業利益=957億, 淨利=934億
- 總資產=5兆, 股東權益=3.5兆

When:
- 計算獲利能力指標

Then:
- 毛利率 ≈ 53.50%
- 營業利益率 ≈ 42.30%
- 淨利率 ≈ 41.27%
- ROE ≈ 26.69%
- ROA ≈ 18.68%
```

**場景 3: 成長性指標計算測試**
```
Given:
- 本季營收=2263億, 去年同季營收=1910億
- 本季EPS=36.05, 去年同季EPS=28.80

When:
- 計算成長性指標

Then:
- 營收成長率 YoY ≈ 18.48%
- EPS 成長率 YoY ≈ 25.17%
```

**場景 4: Piotroski F-Score 計算測試**
```
Given:
- 當季 ROA=18.7%, 去年同季 ROA=17.2%
- 當季 營運現金流=1兆, 淨利=934億
- 當季 流動比=2.1, 去年同季 流動比=2.0
- 當季 毛利率=53.5%, 去年同季 毛利率=52.8%

When:
- 計算 Piotroski F-Score

Then:
- 獲利能力: 4 分 (ROA>0, OCF>0, ROA增加, OCF>淨利)
- 總分 >= 6 分（良好）
```

**場景 5: 財務異常偵測測試**
```
Given:
- 負債比=75%

When:
- 執行異常偵測

Then:
- 產生 HIGH_DEBT_RATIO 警示
- severity = 'HIGH'
- alert_category = 'DEBT_RISK'
```

---

#### 10.1.2 邊界條件測試

**測試 1: 處理虧損公司**
```
Given:
- EPS = -5.00 (虧損)

When:
- 計算 P/E

Then:
- P/E = NULL (虧損時 P/E 無意義)
```

**測試 2: 處理淨值為負公司**
```
Given:
- 股東權益 = -100億 (淨值為負)

When:
- 計算 P/B

Then:
- P/B = NULL (淨值為負時 P/B 無意義)
```

**測試 3: 處理除數為零**
```
Given:
- 去年同季 EPS = 0

When:
- 計算 EPS 成長率

Then:
- EPS 成長率 = NULL (除數為零)
```

**測試 4: 處理盈轉虧**
```
Given:
- 去年同季 EPS = 10.00
- 本季 EPS = -5.00

When:
- 計算 EPS 成長率

Then:
- EPS 成長率 = -999% (標記特殊情況)
```

---

### 10.2 整合測試

#### 10.2.1 API 整合測試

**測試 1: 查詢財務指標 API**
```
Given:
- 資料庫已有台積電 2024Q3 財務指標

When:
- GET /api/stocks/2330/fundamentals?year=2024&quarter=3

Then:
- HTTP Status = 200
- Response.success = true
- Response.data.stock_id = "2330"
- Response.data.pe_ratio > 0
- Response.data.roe > 0
```

**測試 2: 批次查詢 API**
```
Given:
- 資料庫已有台積電、鴻海、聯發科的 2024Q3 財務指標

When:
- POST /api/fundamentals/batch
- Body: {"stock_ids": ["2330", "2317", "2454"], "year": 2024, "quarter": 3}

Then:
- HTTP Status = 200
- Response.data.results.length = 3
- 每個結果包含指定的指標
```

**測試 3: 查詢綜合評分 API**
```
Given:
- 資料庫已有台積電 2024Q3 綜合評分

When:
- GET /api/stocks/2330/scores?year=2024&quarter=3

Then:
- HTTP Status = 200
- Response.data.piotroski_f_score >= 0 AND <= 9
- Response.data.altman_z_score > 0
```

---

#### 10.2.2 Job 整合測試

**測試 1: 財務指標計算 Job**
```
Given:
- M06 已同步台積電 2024Q3 財報
- M06 已同步台積電股價

When:
- 執行 JOB-M08-001 (手動觸發)

Then:
- Job status = 'SUCCESS'
- fundamental_indicators 表新增 1 筆記錄
- stock_id = '2330', year = 2024, quarter = 3
- pe_ratio, roe 等欄位非 NULL
```

**測試 2: 綜合評分計算 Job**
```
Given:
- fundamental_indicators 表已有台積電 2024Q3 與 2023Q3 資料

When:
- 執行 JOB-M08-002

Then:
- Job status = 'SUCCESS'
- financial_scores 表新增 1 筆記錄
- piotroski_f_score >= 0 AND <= 9
- altman_z_score > 0
```

**測試 3: 財務異常偵測 Job**
```
Given:
- fundamental_indicators 表已有高負債股票資料（負債比=75%）

When:
- 執行 JOB-M08-003

Then:
- Job status = 'SUCCESS'
- financial_alerts 表新增警示記錄
- alert_type = 'HIGH_DEBT_RATIO'
- severity = 'HIGH'
```

---

### 10.3 效能測試

#### 10.3.1 API 效能測試

**測試 1: 單一查詢效能**
```
場景: 查詢單一股票財務指標
Target: P95 < 300ms

測試步驟:
1. 準備 100 檔股票的財務指標資料
2. 並發 100 個請求查詢不同股票
3. 測量回應時間

驗證:
- P95 回應時間 < 300ms
- P99 回應時間 < 500ms
```

**測試 2: 批次查詢效能**
```
場景: 批次查詢 10 檔股票
Target: P95 < 1000ms

測試步驟:
1. 準備 1000 檔股票的財務指標資料
2. 並發 100 個請求，每個請求查詢 10 檔股票
3. 測量回應時間

驗證:
- P95 回應時間 < 1000ms
- P99 回應時間 < 1500ms
```

---

#### 10.3.2 Job 效能測試

**測試 1: 指標計算 Job 效能**
```
場景: 計算 2000 檔股票財務指標
Target: < 20 分鐘

測試步驟:
1. 準備 2000 檔股票的財報資料
2. 執行 JOB-M08-001
3. 測量執行時間

驗證:
- 執行時間 < 20 分鐘
- 成功率 > 95%
```

**測試 2: 綜合評分 Job 效能**
```
場景: 計算 2000 檔股票綜合評分
Target: < 5 分鐘

測試步驟:
1. 準備 2000 檔股票的財務指標資料
2. 執行 JOB-M08-002
3. 測量執行時間

驗證:
- 執行時間 < 5 分鐘
- 成功率 > 95%
```

---

### 10.4 測試覆蓋率目標

| 層級 | 覆蓋率目標 | 說明 |
|-----|----------|------|
| Repository | > 90% | JPA Repository 方法測試 |
| Mapper | > 85% | MyBatis Mapper 測試 |
| Service | > 80% | 業務邏輯測試 |
| Controller | > 70% | API 測試 |
| Job | > 75% | 排程任務測試 |

---

### 10.5 測試資料準備

**測試資料集**:
1. **台積電 (2330)**: 標準案例（高ROE、低負債、穩定成長）
2. **中鋼 (2002)**: 景氣循環股（毛利率波動大）
3. **友達 (2409)**: 虧損股（負EPS、淨值低）
4. **長榮 (2603)**: 爆發成長股（EPS大幅成長）
5. **聯電 (2303)**: 財務槓桿高股（負債比>60%）

**財報資料範圍**:
- 時間: 2020Q1 ~ 2024Q3（共 19 季）
- 涵蓋: 營收、淨利、總資產、股東權益、現金流等完整欄位

---

## 附錄

### A. 財務指標速查表

**估值指標 (15個)**:
P/E, Forward P/E, Trailing P/E, PEG, P/B, Tangible P/B, P/S, EV/Sales, P/CF, P/FCF, EV/EBITDA, Tobin's Q, Graham Number, Shiller P/E, EV

**獲利能力指標 (12個)**:
毛利率, 營業利益率, 淨利率, EBITDA Margin, ROE, ROA, ROIC, ROTA, EPS, Diluted EPS, Operating EPS, EBITDA

**財務結構指標 (4個)**:
負債權益比, 負債比率, 權益比率, 長期負債權益比

**償債能力指標 (6個)**:
流動比率, 速動比率, 現金比率, 利息保障倍數, 償債覆蓋率, 營運現金流/流動負債

**經營效率指標 (10個)**:
總資產週轉率, 存貨週轉率, 存貨週轉天數, 應收帳款週轉率, 應收帳款週轉天數, 應付帳款週轉率, 應付帳款週轉天數, 現金週轉週期, 營運週期, 固定資產週轉率

**現金流量指標 (6個)**:
營運現金流, 自由現金流, FCF Yield, 營運現金流比率, 現金流營收比, 應計項目比率

**成長性指標 (5個)**:
營收成長率 YoY, 營收成長率 QoQ, EPS成長率 YoY, EPS成長率 QoQ, 營收/EPS CAGR

**股利政策指標 (4個)**:
現金殖利率, 股利發放率, 股利成長率, 股利保障倍數

**綜合評分 (4個)**:
Piotroski F-Score, Altman Z-Score, Beneish M-Score, Graham Score

**總計**: 75 個指標

---

### B. 常見問題 FAQ

**Q1: 為什麼 P/E 是 NULL？**
A: 公司虧損（EPS < 0）時，P/E 無意義，系統會設為 NULL。

**Q2: 為什麼 ROE 超過 100%？**
A: 可能是：(1) 淨值很小但獲利高，(2) 淨值為負但獲利為正，(3) 資料錯誤。系統會標記異常供人工檢查。

**Q3: Piotroski F-Score 如何解讀？**
A: 
- 8-9 分: 優秀，財務體質非常健全
- 6-7 分: 良好
- 4-5 分: 普通
- 0-3 分: 較差，財務體質不佳

**Q4: Altman Z-Score 如何解讀？**
A:
- Z > 2.99: 安全區，破產風險低
- 1.81 < Z < 2.99: 灰色地帶，需持續關注
- Z < 1.81: 財務困境區，破產風險高

**Q5: 為什麼會產生財務異常警示？**
A: 系統會自動偵測以下異常：
- 盈餘品質問題（應計項目比率高）
- 高負債風險（負債比 > 70%）
- 流動性不足（流動比 < 1.0）
- 獲利惡化（ROE 連續下降）

---

### C. 變更歷史

| 版本 | 日期 | 修改者 | 修改內容 |
|-----|------|-------|---------|
| v1.0 | 2025-12-27 | [待填寫] | 初始版本 |

---

### D. 待辦事項

- [ ] 補充台股資料來源 API 整合細節（公開資訊觀測站、FinMind）
- [ ] 補充美股資料來源 API 整合細節（Yahoo Finance、Alpha Vantage）
- [ ] 完成效能測試基準
- [ ] 建立監控儀表板（Grafana）
- [ ] 撰寫指標計算異常告警腳本
- [ ] 建立財務指標回測驗證機制
- [ ] 補充 Beneish M-Score 各項指數計算細節

---

### E. 參考文獻

1. Piotroski, J. D. (2000). "Value Investing: The Use of Historical Financial Statement Information to Separate Winners from Losers". Journal of Accounting Research.

2. Altman, E. I. (1968). "Financial Ratios, Discriminant Analysis and the Prediction of Corporate Bankruptcy". Journal of Finance.

3. Beneish, M. D. (1999). "The Detection of Earnings Manipulation". Financial Analysts Journal.

4. Graham, B., & Dodd, D. (1934). "Security Analysis". McGraw-Hill.

5. 台灣證券交易所財務報表範本
6. 國際財務報導準則 (IFRS)
7. 台灣會計研究發展基金會 (ARDF) 財務會計準則

---

## 文件結束

**文件編號**: DOC-03-M08  
**版本**: v1.0  
**建立日期**: 2025-12-27  
**最後更新**: 2025-12-27  
**文件狀態**: Draft  

---

**下一步行動**:
1. ✅ 完成 M08 文件撰寫
2. 🔄 進行文件 Review
3. ⏳ 開始 M08 開發實作
4. ⏳ 撰寫 M09 籌碼分析模組文件

**相關文件**:
- DOC-00-MASTER - 總綱
- DOC-01-M06 - 資料管理模組
- DOC-02-M07 - 技術分析模組
- DOC-08-M13 - 信號判斷引擎（待撰寫）
- DOC-09-M14 - 選股引擎（待撰寫）
