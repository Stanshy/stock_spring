# DOC-02-M07 æŠ€è¡“åˆ†ææ¨¡çµ„ (Technical Analysis Module)

## æ–‡ä»¶è³‡è¨Š
- **æ–‡ä»¶ç·¨è™Ÿ**: DOC-02-M07
- **æ¨¡çµ„åç¨±**: æŠ€è¡“åˆ†ææ¨¡çµ„ (Technical Analysis Module)
- **æ¨¡çµ„ä»£ç¢¼**: M07
- **ç‰ˆæœ¬**: v2.0
- **å»ºç«‹æ—¥æœŸ**: 2025-12-27
- **æœ€å¾Œæ›´æ–°**: 2025-12-27
- **æ–‡ä»¶ç‹€æ…‹**: Draft
- **è² è²¬äºº**: [å¾…å¡«å¯«]
- **ä¾è³´æ¨¡çµ„**: M06 è³‡æ–™ç®¡ç†æ¨¡çµ„
- **æŠ€è¡“æ£§**: PostgreSQL 15+ / JPA + MyBatis / Redis 7.0 / pandas-ta

---

## ğŸ“‘ ç›®éŒ„

1. [æ¨¡çµ„æ¦‚è¿°](#1-æ¨¡çµ„æ¦‚è¿°)
2. [åŠŸèƒ½éœ€æ±‚](#2-åŠŸèƒ½éœ€æ±‚)
3. [è³‡æ–™è¨­è¨ˆ](#3-è³‡æ–™è¨­è¨ˆ)
4. [API è¨­è¨ˆ](#4-api-è¨­è¨ˆ)
5. [è³‡æ–™æµè¨­è¨ˆ](#5-è³‡æ–™æµè¨­è¨ˆ)
6. [Job/æ’ç¨‹è¨­è¨ˆ](#6-jobæ’ç¨‹è¨­è¨ˆ)
7. [æ¥­å‹™é‚è¼¯è¨­è¨ˆ](#7-æ¥­å‹™é‚è¼¯è¨­è¨ˆ)
8. [æ•´åˆé»](#8-æ•´åˆé»)
9. [æ•ˆèƒ½è€ƒé‡](#9-æ•ˆèƒ½è€ƒé‡)
10. [æ¸¬è©¦æº–å‰‡](#10-æ¸¬è©¦æº–å‰‡)

---

## 1. æ¨¡çµ„æ¦‚è¿°

### 1.1 æ¨¡çµ„å®šä½

æŠ€è¡“åˆ†ææ¨¡çµ„æ˜¯æ•´å€‹ç³»çµ±çš„**åˆ†æå±¤ï¼ˆLayer 2ï¼‰**ï¼Œè² è²¬ï¼š
- è¨ˆç®— 71 å€‹æŠ€è¡“æŒ‡æ¨™ï¼ˆè¶¨å‹¢ã€å‹•èƒ½ã€æ³¢å‹•ã€æˆäº¤é‡ã€æ”¯æ’å£“åŠ›ã€é€±æœŸã€çµ±è¨ˆã€ç¶œåˆï¼‰
- å„²å­˜æŒ‡æ¨™è¨ˆç®—çµæœè‡³ PostgreSQL è³‡æ–™åº«
- æä¾›æŒ‡æ¨™æŸ¥è©¢ API çµ¦ä¿¡è™Ÿåˆ¤æ–·å¼•æ“ã€é¸è‚¡å¼•æ“ä½¿ç”¨
- åµæ¸¬æŠ€è¡“æŒ‡æ¨™çš„äº¤å‰ã€èƒŒé›¢ç­‰é—œéµè¨Šè™Ÿ
- ç®¡ç†æŒ‡æ¨™è¨ˆç®—çš„æ’ç¨‹èˆ‡å†ªç­‰æ€§

**æ ¸å¿ƒåƒ¹å€¼**: ç‚ºä¿¡è™Ÿåˆ¤æ–·ã€é¸è‚¡ç¯©é¸ã€ç­–ç•¥å›æ¸¬æä¾›å®Œæ•´çš„æŠ€è¡“é¢é‡åŒ–æŒ‡æ¨™ã€‚

### 1.2 æ¨¡çµ„ç›®æ¨™

- âœ… å®Œæ•´æŠ€è¡“æŒ‡æ¨™åº«ï¼šæ”¯æ´ 71 å€‹å¸¸ç”¨æŠ€è¡“æŒ‡æ¨™ï¼ˆåƒç…§ technical_indicators_complete.mdï¼‰
- âœ… é«˜æ•ˆè¨ˆç®—å¼•æ“ï¼šä½¿ç”¨ pandas-ta æ‰¹æ¬¡è¨ˆç®—ï¼Œå„ªåŒ–æ•ˆèƒ½
- âœ… è‡ªå‹•åŒ–æ’ç¨‹ï¼šæ¯æ—¥ç›¤å¾Œè‡ªå‹•è¨ˆç®—æœ€æ–°æŒ‡æ¨™ï¼ˆéµå®ˆç¸½ç¶± 4.5 Job æ¨¡å‹ï¼‰
- âœ… å¢é‡è¨ˆç®—ï¼šåªè¨ˆç®—æ–°å¢æˆ–è®Šå‹•çš„è³‡æ–™ï¼Œé¿å…é‡è¤‡è¨ˆç®—
- âœ… å†ªç­‰æ€§ä¿è­‰ï¼šæ‰€æœ‰ Job éµå®ˆç¸½ç¶± 4.5 å†ªç­‰æ€§è¦æ±‚
- âœ… å¿«å–å„ªåŒ–ï¼šç†±é–€è‚¡ç¥¨æŒ‡æ¨™å¿«å–è‡³ Redisï¼Œæå‡æŸ¥è©¢æ•ˆèƒ½
- âœ… ä¿¡è™Ÿåµæ¸¬ï¼šè‡ªå‹•åµæ¸¬é»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰ã€èƒŒé›¢ç­‰é—œéµè¨Šè™Ÿ

### 1.3 åŠŸèƒ½ç¯„åœ

**åŒ…å«åŠŸèƒ½**:
1. **è¶¨å‹¢æŒ‡æ¨™è¨ˆç®—**ï¼ˆ18 å€‹ï¼‰: MAã€EMAã€MACDã€ADXã€Aroonã€Parabolic SARã€Supertrendã€TRIXã€Ichimoku Cloudã€WMAã€HMAã€DEMAã€TEMAã€VWMAã€ZLEMAã€DMI ç­‰
2. **å‹•èƒ½æŒ‡æ¨™è¨ˆç®—**ï¼ˆ15 å€‹ï¼‰: RSIã€Stochastic (KD)ã€Stochastic RSIã€Williams %Rã€CCIã€MFIã€Ultimate Oscillatorã€ROCã€Momentumã€CMOã€TSIã€KST ç­‰
3. **æ³¢å‹•æ€§æŒ‡æ¨™è¨ˆç®—**ï¼ˆ8 å€‹ï¼‰: Bollinger Bandsã€Keltner Channelã€ATRã€Donchian Channelã€Standard Deviationã€Historical Volatilityã€Mass Indexã€Chaikin Volatility
4. **æˆäº¤é‡æŒ‡æ¨™è¨ˆç®—**ï¼ˆ12 å€‹ï¼‰: Volumeã€Volume MAã€OBVã€AD Lineã€CMFã€EMVã€Force Indexã€NVIã€PVIã€VWAPã€PVT ç­‰
5. **æ”¯æ’å£“åŠ›æŒ‡æ¨™è¨ˆç®—**ï¼ˆ5 å€‹ï¼‰: Pivot Pointsã€Fibonacci Retracementã€Fibonacci Extensionã€Support/Resistance Levelsã€Price Channels
6. **é€±æœŸæŒ‡æ¨™è¨ˆç®—**ï¼ˆ3 å€‹ï¼‰: Hurst Exponentã€Detrended Price Oscillatorã€Schaff Trend Cycle
7. **çµ±è¨ˆæŒ‡æ¨™è¨ˆç®—**ï¼ˆ5 å€‹ï¼‰: Linear Regressionã€Linear Regression Slopeã€R-Squaredã€Correlation Coefficientã€Z-Score
8. **ç¶œåˆæŒ‡æ¨™è¨ˆç®—**ï¼ˆ5 å€‹ï¼‰: Elder Rayã€Coppock Curveã€Qstickã€Vortex Indicatorã€Balance of Power
9. **æŒ‡æ¨™æŸ¥è©¢ API**: æä¾›å–®ä¸€/æ‰¹æ¬¡æŒ‡æ¨™æŸ¥è©¢ä»‹é¢
10. **ä¿¡è™Ÿåµæ¸¬**: é»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰ã€è¶…è²·è¶…è³£ã€èƒŒé›¢

**ä¸åŒ…å«åŠŸèƒ½**:
- åŸºæœ¬é¢æŒ‡æ¨™è¨ˆç®—ï¼ˆç”± M08 è² è²¬ï¼‰
- ç±Œç¢¼æŒ‡æ¨™è¨ˆç®—ï¼ˆç”± M09 è² è²¬ï¼‰
- ä¿¡è™Ÿè©•åˆ†èˆ‡åˆä½µï¼ˆç”± M13 è² è²¬ï¼‰
- æŠ€è¡“å‹æ…‹è¾¨è­˜ï¼ˆç”± M10 è² è²¬ï¼‰

### 1.4 ä¾è³´é—œä¿‚

**ä¸Šæ¸¸ä¾è³´**: 
- M06 è³‡æ–™ç®¡ç†æ¨¡çµ„ï¼ˆè‚¡åƒ¹è³‡æ–™ï¼‰

**ä¸‹æ¸¸ä¾è³´**: 
- M13 ä¿¡è™Ÿåˆ¤æ–·å¼•æ“
- M14 é¸è‚¡å¼•æ“
- M16 å›æ¸¬ç³»çµ±
- M17 é¢¨éšªç®¡ç†æ¨¡çµ„
- M10 æŠ€è¡“å‹æ…‹è¾¨è­˜æ¨¡çµ„

**å¤–éƒ¨ä¾è³´**:
- pandas-taï¼ˆPython æŠ€è¡“æŒ‡æ¨™åº«ï¼‰
- Redisï¼ˆå¿«å–ï¼‰
- PostgreSQLï¼ˆè³‡æ–™å„²å­˜ï¼‰

---

## 2. åŠŸèƒ½éœ€æ±‚

### 2.1 åŠŸèƒ½æ¸…å–®

| åŠŸèƒ½ç·¨è™Ÿ | åŠŸèƒ½åç¨± | å„ªå…ˆç´š | èªªæ˜ | æŒä¹…å±¤ |
|---------|---------|-------|------|-------|
| F-M07-001 | è¶¨å‹¢æŒ‡æ¨™è¨ˆç®— | P0 | MAã€EMAã€MACDã€ADX ç­‰ 18 å€‹æŒ‡æ¨™ | JPA + MyBatis |
| F-M07-002 | å‹•èƒ½æŒ‡æ¨™è¨ˆç®— | P0 | RSIã€KDã€Williams %R ç­‰ 15 å€‹æŒ‡æ¨™ | JPA + MyBatis |
| F-M07-003 | æ³¢å‹•æ€§æŒ‡æ¨™è¨ˆç®— | P0 | Bollinger Bandsã€ATR ç­‰ 8 å€‹æŒ‡æ¨™ | JPA + MyBatis |
| F-M07-004 | æˆäº¤é‡æŒ‡æ¨™è¨ˆç®— | P0 | OBVã€ADã€VWAP ç­‰ 12 å€‹æŒ‡æ¨™ | JPA + MyBatis |
| F-M07-005 | æ”¯æ’å£“åŠ›æŒ‡æ¨™è¨ˆç®— | P1 | Pivot Pointsã€Fibonacci ç­‰ 5 å€‹æŒ‡æ¨™ | JPA |
| F-M07-006 | é€±æœŸæŒ‡æ¨™è¨ˆç®— | P2 | Hurstã€DPOã€STC ç­‰ 3 å€‹æŒ‡æ¨™ | JPA |
| F-M07-007 | çµ±è¨ˆæŒ‡æ¨™è¨ˆç®— | P1 | Linear Regressionã€RÂ² ç­‰ 5 å€‹æŒ‡æ¨™ | JPA |
| F-M07-008 | ç¶œåˆæŒ‡æ¨™è¨ˆç®— | P2 | Elder Rayã€Vortex ç­‰ 5 å€‹æŒ‡æ¨™ | JPA |
| F-M07-009 | æŒ‡æ¨™æŸ¥è©¢ API | P0 | å–®ä¸€/æ‰¹æ¬¡æŒ‡æ¨™æŸ¥è©¢ | JPA + MyBatis |
| F-M07-010 | äº¤å‰ä¿¡è™Ÿåµæ¸¬ | P0 | é»ƒé‡‘/æ­»äº¡äº¤å‰ã€KD äº¤å‰ç­‰ | MyBatis |
| F-M07-011 | è¶…è²·è¶…è³£åµæ¸¬ | P0 | RSIã€KDã€Williams %R è¶…è²·è¶…è³£ | MyBatis |
| F-M07-012 | èƒŒé›¢åµæ¸¬ | P1 | åƒ¹æ ¼èˆ‡æŒ‡æ¨™èƒŒé›¢åˆ¤æ–· | MyBatis |
| F-M07-013 | æŒ‡æ¨™æ’ç¨‹è¨ˆç®— | P0 | æ¯æ—¥ç›¤å¾Œè‡ªå‹•è¨ˆç®— | - |
| F-M07-014 | å¢é‡è¨ˆç®— | P1 | åªè¨ˆç®—æ–°å¢è³‡æ–™ | MyBatis |
| F-M07-015 | æŒ‡æ¨™å¿«å–ç®¡ç† | P1 | ç†±é–€è‚¡ç¥¨æŒ‡æ¨™å¿«å– | - |

### 2.2 ç”¨ä¾‹èªªæ˜

#### UC-M07-001: æ¯æ—¥æŠ€è¡“æŒ‡æ¨™è¨ˆç®—

**åƒèˆ‡è€…**: ç³»çµ±æ’ç¨‹å™¨  
**å‰ç½®æ¢ä»¶**: 
- M06 è‚¡åƒ¹åŒæ­¥å·²å®Œæˆ
- æ”¶åˆ° StockPriceUpdated äº‹ä»¶

**ä¸»è¦æµç¨‹**:
1. ç³»çµ±æ–¼æ¯æ—¥ 15:30 è§¸ç™¼æŠ€è¡“æŒ‡æ¨™è¨ˆç®— Jobï¼ˆéµå®ˆç¸½ç¶± 4.5 Job æ¨¡å‹ï¼‰
2. å»ºç«‹ Job åŸ·è¡Œè¨˜éŒ„ï¼ˆjob_executions è¡¨ï¼Œstatus='RUNNING'ï¼‰
3. æŸ¥è©¢ç•¶æ—¥å·²æ›´æ–°è‚¡åƒ¹çš„è‚¡ç¥¨æ¸…å–®ï¼ˆå¾ M06 StockPriceUpdated äº‹ä»¶ï¼‰
4. å°æ¯æª”è‚¡ç¥¨åŸ·è¡ŒæŒ‡æ¨™è¨ˆç®—ï¼š
   - å¾ stock_prices è¡¨æŸ¥è©¢æ­·å²è‚¡åƒ¹ï¼ˆæœ€è¿‘ 250 æ—¥ï¼Œç”¨æ–¼è¨ˆç®—é•·é€±æœŸæŒ‡æ¨™ï¼‰
   - ä½¿ç”¨ pandas-ta æ‰¹æ¬¡è¨ˆç®—åŸºç¤æŒ‡æ¨™çµ„ï¼ˆMAã€EMAã€RSIã€KDã€MACDã€BBandsã€ATRã€OBVï¼‰
   - é©—è­‰è¨ˆç®—çµæœï¼ˆé NULLã€é NaNã€ç¯„åœåˆç†ï¼‰
   - ä½¿ç”¨ MyBatis æ‰¹æ¬¡ UPSERT å„²å­˜è‡³ technical_indicators è¡¨
5. å›å¯«å¸¸ç”¨æŒ‡æ¨™è‡³ stock_prices è¡¨ï¼ˆma5, ma20, volume_ma5ï¼‰
6. æ›´æ–° Redis å¿«å–ï¼ˆç†±é–€è‚¡ç¥¨å‰ 50 æª”ï¼‰
7. åµæ¸¬æŠ€è¡“ä¿¡è™Ÿï¼ˆé»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰ã€è¶…è²·è¶…è³£ï¼‰
8. ç”¢ç”Ÿä¿¡è™Ÿä¸¦ç™¼å¸ƒï¼ˆéµå®ˆç¸½ç¶± 4.1 Signal Contractï¼‰
9. æ›´æ–° Job åŸ·è¡Œè¨˜éŒ„ï¼ˆstatus='SUCCESS', çµ±è¨ˆè³‡è¨Šï¼‰

**å¾Œç½®æ¢ä»¶**:
- ç•¶æ—¥æŠ€è¡“æŒ‡æ¨™å·²è¨ˆç®—ä¸¦å„²å­˜
- Job åŸ·è¡Œè¨˜éŒ„ç‹€æ…‹ç‚º SUCCESS
- Redis å¿«å–å·²æ›´æ–°
- æŠ€è¡“ä¿¡è™Ÿå·²ç™¼å¸ƒè‡³ M13

**æ›¿ä»£æµç¨‹**:
- 4a. æ­·å²è³‡æ–™ä¸è¶³ï¼ˆä¸Šå¸‚æœªæ»¿ 250 æ—¥ï¼‰â†’ è·³éé•·é€±æœŸæŒ‡æ¨™ï¼Œåªè¨ˆç®—çŸ­é€±æœŸæŒ‡æ¨™
- 4b. è¨ˆç®—çµæœç•°å¸¸ï¼ˆNaNã€Infï¼‰â†’ è¨˜éŒ„ data_quality_issuesï¼Œè·³éè©²è‚¡ç¥¨
- 4c. è³‡æ–™åº«éŒ¯èª¤ â†’ å›æ»¾äº¤æ˜“ï¼ŒJob ç‹€æ…‹è¨­ç‚º FAILEDï¼Œè§¸ç™¼é‡è©¦
- 7a. åµæ¸¬åˆ°äº¤å‰ä¿¡è™Ÿ â†’ ç”¢ç”Ÿ BUY/SELL ä¿¡è™Ÿï¼ˆéµå®ˆç¸½ç¶± 4.1ï¼‰

**å†ªç­‰æ€§è¨­è¨ˆ**:
- ä½¿ç”¨ PostgreSQL `ON CONFLICT ... DO UPDATE`
- é‡è¤‡åŸ·è¡ŒåŒä¸€æ—¥æœŸçš„ Job ä¸æœƒç”¢ç”Ÿé‡è¤‡æŒ‡æ¨™è³‡æ–™
- Job åƒæ•¸åŒ…å« calculation_dateï¼Œç¢ºä¿å¯è¿½æº¯èˆ‡é‡è·‘

---

#### UC-M07-002: æŸ¥è©¢è‚¡ç¥¨æŠ€è¡“æŒ‡æ¨™

**åƒèˆ‡è€…**: å…¶ä»–æ¨¡çµ„ï¼ˆM13, M14, M16 ç­‰ï¼‰  
**å‰ç½®æ¢ä»¶**: è‚¡ç¥¨ä»£ç¢¼å­˜åœ¨ä¸”å·²è¨ˆç®—æŒ‡æ¨™

**ä¸»è¦æµç¨‹**:
1. æ¥æ”¶æŸ¥è©¢è«‹æ±‚ï¼ˆstock_id, indicator_names, start_date, end_dateï¼‰
2. åƒæ•¸é©—è­‰ï¼ˆæ—¥æœŸæ ¼å¼ã€æŒ‡æ¨™åç¨±æœ‰æ•ˆæ€§ï¼‰
3. æª¢æŸ¥ Redis å¿«å–ï¼ˆå¿«å– Key: `tech:indicators:{stock_id}:{date}`ï¼‰
4. è‹¥å¿«å–å‘½ä¸­ â†’ ç›´æ¥è¿”å›
5. è‹¥å¿«å–æœªå‘½ä¸­ â†’ ä½¿ç”¨ MyBatis æŸ¥è©¢ PostgreSQLï¼ˆè¤‡é›œ JSON æŸ¥è©¢ï¼‰
6. å°‡æŸ¥è©¢çµæœåºåˆ—åŒ–ä¸¦å¯«å…¥ Redis å¿«å–
7. è¿”å›çµæœï¼ˆéµå®ˆç¸½ç¶± 4.4 API Response æ ¼å¼ï¼‰

**å¾Œç½®æ¢ä»¶**:
- è¿”å›ç¬¦åˆæ¢ä»¶çš„æŠ€è¡“æŒ‡æ¨™è³‡æ–™
- ç†±è³‡æ–™å·²å¿«å–è‡³ Redis

**æ›¿ä»£æµç¨‹**:
- 1a. è‚¡ç¥¨ä»£ç¢¼ä¸å­˜åœ¨ â†’ è¿”å›éŒ¯èª¤ç¢¼ M07_STOCK_001
- 2a. æŒ‡æ¨™åç¨±ç„¡æ•ˆ â†’ è¿”å›éŒ¯èª¤ç¢¼ M07_INDICATOR_001
- 5a. æŒ‡æ¨™å°šæœªè¨ˆç®— â†’ è¿”å›ç©ºé™£åˆ— + æç¤ºè¨Šæ¯

---

#### UC-M07-003: åµæ¸¬é»ƒé‡‘äº¤å‰ä¿¡è™Ÿ

**åƒèˆ‡è€…**: æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å¼•æ“  
**å‰ç½®æ¢ä»¶**: 
- MA5, MA20 å·²è¨ˆç®—å®Œæˆ
- æœ‰å‰ä¸€äº¤æ˜“æ—¥è³‡æ–™å¯æ¯”å°

**ä¸»è¦æµç¨‹**:
1. å–å¾—ç•¶æ—¥ MA5, MA20 å€¼
2. å–å¾—å‰ä¸€äº¤æ˜“æ—¥ MA5, MA20 å€¼
3. åˆ¤æ–·äº¤å‰æ¢ä»¶ï¼š
   - å‰æ—¥ï¼šMA5 < MA20
   - ç•¶æ—¥ï¼šMA5 > MA20
4. è‹¥æ»¿è¶³æ¢ä»¶ â†’ ç”¢ç”Ÿ BUY ä¿¡è™Ÿï¼ˆéµå®ˆç¸½ç¶± 4.1 Signal Contractï¼‰
5. å¡«å¯«ä¿¡è™Ÿè©³ç´°è³‡è¨Šï¼š
   - signal_type = 'BUY'
   - signal_source = 'M07_TECHNICAL_ANALYSIS'
   - signal_name = 'MA_GOLDEN_CROSS'
   - evidence_data = {indicator: 'MA', ma5: å€¼, ma20: å€¼, cross_date: æ—¥æœŸ}
   - confidence_score = 70 (åŸºç¤ä¿¡è™Ÿ)
6. ç™¼å¸ƒä¿¡è™Ÿè‡³ M13 ä¿¡è™Ÿåˆ¤æ–·å¼•æ“

**å¾Œç½®æ¢ä»¶**:
- é»ƒé‡‘äº¤å‰ä¿¡è™Ÿå·²ç”¢ç”Ÿ
- ä¿¡è™Ÿå·²ç™¼å¸ƒè‡³ M13

**æ›¿ä»£æµç¨‹**:
- 3a. ä¸æ»¿è¶³äº¤å‰æ¢ä»¶ â†’ ä¸ç”¢ç”Ÿä¿¡è™Ÿ
- 3b. ä»Šæ—¥æ˜¯ä¸Šå¸‚é¦–æ—¥ â†’ ç„¡å‰ä¸€æ—¥è³‡æ–™ï¼Œä¸åˆ¤æ–·äº¤å‰

---

### 2.3 æ¥­å‹™è¦å‰‡

#### BR-M07-001: æŒ‡æ¨™è¨ˆç®—è¦å‰‡

**è¨ˆç®—å„ªå…ˆç´š**:
| å„ªå…ˆç´š | æŒ‡æ¨™çµ„ | è¨ˆç®—æ™‚æ©Ÿ | åŸå›  |
|-------|-------|---------|------|
| P0 | åŸºç¤çµ„ï¼ˆ11 å€‹ï¼‰ | æ¯æ—¥å¿…ç®— | æœ€å¸¸ç”¨ï¼Œä¸‹æ¸¸ä¾è³´ |
| P1 | é€²éšçµ„ï¼ˆ20 å€‹ï¼‰ | æ¯æ—¥å¿…ç®— | å¸¸ç”¨æ–¼é¸è‚¡ç­–ç•¥ |
| P2 | å°ˆæ¥­çµ„ï¼ˆ40 å€‹ï¼‰ | æ¯é€±è¨ˆç®—æˆ–æŒ‰éœ€ | è¨ˆç®—æˆæœ¬é«˜ï¼Œä½¿ç”¨é »ç‡ä½ |

**åŸºç¤çµ„ï¼ˆP0 - æ¯æ—¥å¿…ç®—ï¼‰**:
- SMA(5, 20, 60)
- EMA(12, 26, 50)
- MACD(12, 26, 9)
- RSI(14)
- Stochastic(9, 3, 3)
- Bollinger Bands(20, 2)
- ATR(14)
- OBV
- Volume MA(5, 20)
- ADX(14)
- VWAP

**é€²éšçµ„ï¼ˆP1 - æ¯æ—¥å¿…ç®—ï¼‰**:
- WMA(10, 20), HMA(9, 16)
- Stochastic RSI, Williams %R(14), CCI(20), MFI(14)
- Keltner Channel(20, 2), Donchian Channel(20)
- AD Line, CMF(20)
- Aroon(25), Parabolic SAR, Supertrend(10, 3)
- ROC(12), Momentum(10)
- Pivot Points, Fibonacci Retracement
- Linear Regression(14), Slope(14), R-Squared

**å°ˆæ¥­çµ„ï¼ˆP2 - æŒ‰éœ€è¨ˆç®—ï¼‰**:
- DEMA, TEMA, VWMA, ZLEMA
- Ultimate Oscillator, CMO, TSI, KST
- Standard Deviation, Historical Volatility, Mass Index, Chaikin Volatility
- EMV, Force Index, NVI, PVI, PVT
- Fibonacci Extension, Support/Resistance Levels, Price Channels
- Hurst Exponent, DPO, Schaff Trend Cycle
- Correlation Coefficient, Z-Score
- Elder Ray, Coppock Curve, Qstick, Vortex, Balance of Power
- Ichimoku Cloud, TRIX

---

#### BR-M07-002: æŒ‡æ¨™è¨ˆç®—åƒæ•¸æ¨™æº–åŒ–

æ‰€æœ‰æŒ‡æ¨™ä½¿ç”¨çµ±ä¸€çš„åƒæ•¸è¨­å®šï¼Œéµå¾ªæ¥­ç•Œæ…£ä¾‹ï¼š

| æŒ‡æ¨™ | é è¨­åƒæ•¸ | èªªæ˜ |
|-----|---------|------|
| MA | (5, 10, 20, 60, 120, 240) | å¸¸ç”¨å‡ç·šé€±æœŸ |
| EMA | (12, 26, 50, 200) | MACD èˆ‡é•·æœŸè¶¨å‹¢ |
| MACD | (12, 26, 9) | æ¨™æº–åƒæ•¸ |
| RSI | (14) | æ¨™æº–åƒæ•¸ |
| Stochastic | (9, 3, 3) | K ç·šã€D ç·šåƒæ•¸ |
| Bollinger Bands | (20, 2) | 20 æ—¥å‡ç·šã€2 å€æ¨™æº–å·® |
| ATR | (14) | æ¨™æº–åƒæ•¸ |
| ADX | (14) | æ¨™æº–åƒæ•¸ |
| Williams %R | (14) | æ¨™æº–åƒæ•¸ |
| CCI | (20) | æ¨™æº–åƒæ•¸ |
| MFI | (14) | æ¨™æº–åƒæ•¸ |
| Aroon | (25) | æ¨™æº–åƒæ•¸ |
| Parabolic SAR | (0.02, 0.2) | èµ·å§‹å€¼ã€æœ€å¤§å€¼ |
| Supertrend | (10, 3) | æœŸé–“ã€å€æ•¸ |
| Keltner Channel | (20, 2) | EMA é€±æœŸã€ATR å€æ•¸ |
| Donchian Channel | (20) | é€šé“é€±æœŸ |

---

#### BR-M07-003: æŒ‡æ¨™é©—è­‰è¦å‰‡

**å®Œæ•´æ€§**:
- è¨ˆç®—å¾Œçš„æŒ‡æ¨™å€¼ä¸å¯ç‚º NULLï¼ˆå…è¨± NaN ç”¨æ–¼è³‡æ–™ä¸è¶³æœŸé–“ï¼‰

**æº–ç¢ºæ€§**:
- RSI ç¯„åœï¼š0-100
- Stochastic %Kã€%D ç¯„åœï¼š0-100
- Williams %R ç¯„åœï¼š-100 åˆ° 0
- CCI ç¯„åœï¼šé€šå¸¸ -200 åˆ° +200
- ADX ç¯„åœï¼š0-100

**åˆç†æ€§**:
- MA å€¼æ‡‰æ¥è¿‘ç•¶æœŸæ”¶ç›¤åƒ¹ï¼ˆèª¤å·® < 20%ï¼‰
- MACD æŸ±ç‹€åœ–ä¸æ‡‰éå¤§ï¼ˆ< æ”¶ç›¤åƒ¹çš„ 10%ï¼‰
- Bollinger Bands ä¸Šä¸‹è»Œæ‡‰åŒ…å«ä¸­è»Œ

**ä¸€è‡´æ€§**:
- åŒä¸€æ—¥æœŸã€åŒä¸€è‚¡ç¥¨ã€åŒä¸€æŒ‡æ¨™åªèƒ½æœ‰ä¸€ç­†è¨˜éŒ„
- æŒ‡æ¨™æ™‚é–“åºåˆ—æ‡‰é€£çºŒï¼ˆäº¤æ˜“æ—¥ï¼‰

---

#### BR-M07-004: ä¿¡è™Ÿç”¢ç”Ÿè¦å‰‡

**é»ƒé‡‘äº¤å‰ä¿¡è™Ÿ**:
- æ¢ä»¶ï¼šçŸ­æœŸå‡ç·šä¸Šç©¿é•·æœŸå‡ç·š
- ç¯„ä¾‹ï¼šMA5 ä¸Šç©¿ MA20ã€MA20 ä¸Šç©¿ MA60
- signal_type = 'BUY'
- confidence_score = 70

**æ­»äº¡äº¤å‰ä¿¡è™Ÿ**:
- æ¢ä»¶ï¼šçŸ­æœŸå‡ç·šä¸‹ç©¿é•·æœŸå‡ç·š
- ç¯„ä¾‹ï¼šMA5 ä¸‹ç©¿ MA20ã€MA20 ä¸‹ç©¿ MA60
- signal_type = 'SELL'
- confidence_score = 70

**KD äº¤å‰ä¿¡è™Ÿ**:
- K ç·šä¸Šç©¿ D ç·šä¸” K < 20ï¼ˆä½æª”é»ƒé‡‘äº¤å‰ï¼‰â†’ BUYï¼Œconfidence = 75
- K ç·šä¸‹ç©¿ D ç·šä¸” K > 80ï¼ˆé«˜æª”æ­»äº¡äº¤å‰ï¼‰â†’ SELLï¼Œconfidence = 75

**RSI è¶…è²·è¶…è³£ä¿¡è™Ÿ**:
- RSI > 70 â†’ SELL ä¿¡è™Ÿï¼ˆè¶…è²·ï¼‰ï¼Œconfidence = 60
- RSI < 30 â†’ BUY ä¿¡è™Ÿï¼ˆè¶…è³£ï¼‰ï¼Œconfidence = 60

**MACD äº¤å‰ä¿¡è™Ÿ**:
- MACD ç·šä¸Šç©¿ä¿¡è™Ÿç·š â†’ BUYï¼Œconfidence = 70
- MACD ç·šä¸‹ç©¿ä¿¡è™Ÿç·š â†’ SELLï¼Œconfidence = 70

**Bollinger Bands çªç ´ä¿¡è™Ÿ**:
- åƒ¹æ ¼è·Œç ´ä¸‹è»Œå¾Œå›å‡ â†’ BUYï¼Œconfidence = 65
- åƒ¹æ ¼çªç ´ä¸Šè»Œå¾Œå›è½ â†’ SELLï¼Œconfidence = 65

---

#### BR-M07-005: å¿«å–ç­–ç•¥

åƒç…§ç¸½ç¶±å¿«å–ç­–ç•¥ï¼š

| è³‡æ–™é¡å‹ | å¿«å–ä½ç½® | TTL | é ç†±ç­–ç•¥ | å¤±æ•ˆç­–ç•¥ |
|---------|---------|-----|---------|---------|
| ç†±é–€è‚¡ç¥¨æŒ‡æ¨™ï¼ˆå¸‚å€¼å‰ 50ï¼‰ | Redis | 1 å°æ™‚ | Job å®Œæˆå¾Œä¸»å‹•æ›´æ–° | æ–°æŒ‡æ¨™è¨ˆç®—å®Œæˆå¾Œä¸»å‹•æ›´æ–° |
| ä¸€èˆ¬è‚¡ç¥¨æŒ‡æ¨™ | Redis | 6 å°æ™‚ | é¦–æ¬¡æŸ¥è©¢æ™‚è¼‰å…¥ | LRU è‡ªå‹•æ·˜æ±° |
| å–®æ—¥æŒ‡æ¨™å¿«ç…§ | Redis | 12 å°æ™‚ | ä¸é ç†± | TTL è‡ªå‹•éæœŸ |
| æŒ‡æ¨™å®šç¾©èˆ‡åƒæ•¸ | Redis | æ°¸ä¹… | ç³»çµ±å•Ÿå‹•æ™‚è¼‰å…¥ | é…ç½®æ›´æ–°å¾Œä¸»å‹•æ›´æ–° |

**å¿«å– Key è¨­è¨ˆ**:
```
tech:indicators:{stock_id}:{date}                          â†’ å–®æ—¥æ‰€æœ‰æŒ‡æ¨™
tech:indicator:{stock_id}:{indicator_name}:{date}          â†’ å–®ä¸€æŒ‡æ¨™å–®æ—¥å€¼
tech:indicators:range:{stock_id}:{start}:{end}             â†’ æŒ‡æ¨™ç¯„åœæŸ¥è©¢
tech:config:indicators                                     â†’ æŒ‡æ¨™é…ç½®ï¼ˆåç¨±ã€åƒæ•¸ï¼‰
tech:hot:stocks                                            â†’ ç†±é–€è‚¡ç¥¨æ¸…å–®
```

---

## 3. è³‡æ–™è¨­è¨ˆ

### 3.1 è³‡æ–™è¡¨æ¸…å–®

| è¡¨å | èªªæ˜ | æŒä¹…å±¤ | ç‰¹æ®ŠåŠŸèƒ½ |
|-----|------|-------|---------|
| technical_indicators | æŠ€è¡“æŒ‡æ¨™ä¸»è¡¨ | JPA + MyBatis | JSONBã€åˆ†å€ã€GIN ç´¢å¼• |
| indicator_definitions | æŒ‡æ¨™å®šç¾©èˆ‡åƒæ•¸è¡¨ | JPA | JSONB |
| indicator_calculation_jobs | æŒ‡æ¨™è¨ˆç®— Job è¨˜éŒ„è¡¨ | JPA | - |

### 3.2 è³‡æ–™è¡¨è¨­è¨ˆ

#### 3.2.1 technical_indicators (æŠ€è¡“æŒ‡æ¨™ä¸»è¡¨)

```sql
-- PostgreSQL å»ºè¡¨èªæ³•ï¼ˆä½¿ç”¨åˆ†å€ï¼‰
CREATE TABLE technical_indicators (
    indicator_id        BIGSERIAL,
    stock_id            VARCHAR(10) NOT NULL,
    calculation_date    DATE NOT NULL,
    
    -- è¶¨å‹¢æŒ‡æ¨™ï¼ˆä½¿ç”¨ JSONB å„²å­˜ï¼‰
    trend_indicators    JSONB DEFAULT '{}',
    
    -- å‹•èƒ½æŒ‡æ¨™
    momentum_indicators JSONB DEFAULT '{}',
    
    -- æ³¢å‹•æ€§æŒ‡æ¨™
    volatility_indicators JSONB DEFAULT '{}',
    
    -- æˆäº¤é‡æŒ‡æ¨™
    volume_indicators   JSONB DEFAULT '{}',
    
    -- æ”¯æ’å£“åŠ›æŒ‡æ¨™
    support_resistance  JSONB DEFAULT '{}',
    
    -- é€±æœŸæŒ‡æ¨™
    cycle_indicators    JSONB DEFAULT '{}',
    
    -- çµ±è¨ˆæŒ‡æ¨™
    statistical_indicators JSONB DEFAULT '{}',
    
    -- ç¶œåˆæŒ‡æ¨™
    composite_indicators JSONB DEFAULT '{}',
    
    -- å¿«é€ŸæŸ¥è©¢æ¬„ä½ï¼ˆå†—é¤˜ï¼Œç”¨æ–¼å¸¸ç”¨æŒ‡æ¨™ï¼‰
    ma5                 NUMERIC(10,2),
    ma20                NUMERIC(10,2),
    ma60                NUMERIC(10,2),
    ema12               NUMERIC(10,2),
    ema26               NUMERIC(10,2),
    macd_value          NUMERIC(10,4),
    macd_signal         NUMERIC(10,4),
    macd_histogram      NUMERIC(10,4),
    rsi_14              NUMERIC(5,2),
    stoch_k             NUMERIC(5,2),
    stoch_d             NUMERIC(5,2),
    bbands_upper        NUMERIC(10,2),
    bbands_middle       NUMERIC(10,2),
    bbands_lower        NUMERIC(10,2),
    atr_14              NUMERIC(10,4),
    obv                 BIGINT,
    adx_14              NUMERIC(5,2),
    
    -- è¨ˆç®—è³‡è¨Š
    calculation_version VARCHAR(10),
    calculation_engine  VARCHAR(50) DEFAULT 'pandas-ta',
    
    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (indicator_id, calculation_date),
    UNIQUE (stock_id, calculation_date),
    
    FOREIGN KEY (stock_id) REFERENCES stocks(stock_id) ON DELETE CASCADE
) PARTITION BY RANGE (calculation_date);

-- å»ºç«‹åˆ†å€ï¼ˆæŒ‰å¹´ä»½ï¼‰
CREATE TABLE technical_indicators_2023 PARTITION OF technical_indicators
    FOR VALUES FROM ('2023-01-01') TO ('2024-01-01');
    
CREATE TABLE technical_indicators_2024 PARTITION OF technical_indicators
    FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
    
CREATE TABLE technical_indicators_2025 PARTITION OF technical_indicators
    FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');
    
CREATE TABLE technical_indicators_future PARTITION OF technical_indicators
    FOR VALUES FROM ('2026-01-01') TO (MAXVALUE);

-- ç´¢å¼•
CREATE INDEX idx_technical_indicators_stock_id ON technical_indicators(stock_id);
CREATE INDEX idx_technical_indicators_date ON technical_indicators(calculation_date);

-- GIN ç´¢å¼•ï¼ˆåŠ é€Ÿ JSONB æŸ¥è©¢ï¼‰
CREATE INDEX idx_technical_indicators_trend ON technical_indicators USING GIN(trend_indicators);
CREATE INDEX idx_technical_indicators_momentum ON technical_indicators USING GIN(momentum_indicators);
CREATE INDEX idx_technical_indicators_volatility ON technical_indicators USING GIN(volatility_indicators);
CREATE INDEX idx_technical_indicators_volume ON technical_indicators USING GIN(volume_indicators);

-- è‡ªå‹•æ›´æ–° updated_at è§¸ç™¼å™¨
CREATE TRIGGER update_technical_indicators_updated_at
    BEFORE UPDATE ON technical_indicators
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE technical_indicators IS 'æŠ€è¡“æŒ‡æ¨™ä¸»è¡¨ï¼ˆä½¿ç”¨åˆ†å€å’Œ JSONB å„ªåŒ–ï¼‰';
COMMENT ON COLUMN technical_indicators.trend_indicators IS 'è¶¨å‹¢æŒ‡æ¨™ JSONBï¼ˆMAã€EMAã€MACDã€ADXç­‰ï¼‰';
COMMENT ON COLUMN technical_indicators.ma5 IS '5æ—¥å‡ç·šï¼ˆå†—é¤˜æ¬„ä½ï¼Œç”¨æ–¼å¿«é€ŸæŸ¥è©¢ï¼‰';
```

**è¨­è¨ˆèªªæ˜**:
- ä½¿ç”¨ PostgreSQL **åˆ†å€ï¼ˆPartitioningï¼‰** å„ªåŒ–å¤§é‡æ­·å²è³‡æ–™æŸ¥è©¢
- ä½¿ç”¨ **JSONB** å„²å­˜å„é¡åˆ¥æŒ‡æ¨™ï¼Œå½ˆæ€§æ“´å……
- æä¾›å†—é¤˜æ¬„ä½ï¼ˆma5, rsi_14 ç­‰ï¼‰ç”¨æ–¼é«˜é »æŸ¥è©¢ï¼Œé¿å…è§£æ JSON
- GIN ç´¢å¼•åŠ é€Ÿ JSONB æŸ¥è©¢
- åˆ†å€ç­–ç•¥ï¼šæŒ‰å¹´ä»½ RANGE åˆ†å€

**JSONB çµæ§‹ç¯„ä¾‹**:

**trend_indicators**:
```json
{
  "ma": {
    "ma5": 580.50,
    "ma10": 575.20,
    "ma20": 570.80,
    "ma60": 565.00,
    "ma120": 560.00,
    "ma240": 555.00
  },
  "ema": {
    "ema12": 578.30,
    "ema26": 572.40,
    "ema50": 568.00,
    "ema200": 550.00
  },
  "macd": {
    "macd_line": 5.90,
    "signal_line": 4.20,
    "histogram": 1.70
  },
  "adx": {
    "adx": 25.50,
    "plus_di": 28.30,
    "minus_di": 15.20
  },
  "aroon": {
    "aroon_up": 80,
    "aroon_down": 20,
    "aroon_oscillator": 60
  },
  "psar": {
    "psar": 570.00,
    "trend": "up"
  },
  "supertrend": {
    "supertrend": 575.00,
    "direction": 1
  }
}
```

**momentum_indicators**:
```json
{
  "rsi": {
    "rsi_14": 65.50
  },
  "stochastic": {
    "k": 75.20,
    "d": 72.80
  },
  "stochrsi": {
    "stochrsi_k": 80.00,
    "stochrsi_d": 75.00
  },
  "williams_r": {
    "willr_14": -25.50
  },
  "cci": {
    "cci_20": 120.30
  },
  "mfi": {
    "mfi_14": 68.50
  },
  "roc": {
    "roc_12": 5.20
  },
  "momentum": {
    "momentum_10": 15.30
  }
}
```

**volatility_indicators**:
```json
{
  "bbands": {
    "upper": 590.00,
    "middle": 580.00,
    "lower": 570.00,
    "bandwidth": 20.00,
    "percent_b": 0.75
  },
  "keltner": {
    "upper": 588.00,
    "middle": 580.00,
    "lower": 572.00
  },
  "atr": {
    "atr_14": 12.50
  },
  "donchian": {
    "upper": 595.00,
    "middle": 580.00,
    "lower": 565.00
  }
}
```

**volume_indicators**:
```json
{
  "obv": 125000000000,
  "ad_line": 85000000000,
  "cmf": {
    "cmf_20": 0.35
  },
  "mfi": {
    "mfi_14": 68.50
  },
  "vwap": 578.50,
  "volume_ma": {
    "vol_ma5": 35000000,
    "vol_ma20": 32000000
  }
}
```

**JSONB æŸ¥è©¢ç¯„ä¾‹**:
```sql
-- æŸ¥è©¢ RSI > 70 çš„è‚¡ç¥¨ï¼ˆè¶…è²·ï¼‰
SELECT stock_id, calculation_date, 
       (momentum_indicators->'rsi'->>'rsi_14')::numeric as rsi
FROM technical_indicators
WHERE calculation_date = '2024-12-24'
  AND (momentum_indicators->'rsi'->>'rsi_14')::numeric > 70;

-- æŸ¥è©¢ MA5 ä¸Šç©¿ MA20 çš„è‚¡ç¥¨ï¼ˆé»ƒé‡‘äº¤å‰ï¼‰
SELECT t1.stock_id, t1.calculation_date
FROM technical_indicators t1
JOIN technical_indicators t2 ON t1.stock_id = t2.stock_id
WHERE t1.calculation_date = '2024-12-24'
  AND t2.calculation_date = '2024-12-23'
  AND (t1.trend_indicators->'ma'->>'ma5')::numeric > (t1.trend_indicators->'ma'->>'ma20')::numeric
  AND (t2.trend_indicators->'ma'->>'ma5')::numeric < (t2.trend_indicators->'ma'->>'ma20')::numeric;

-- æŸ¥è©¢åŒ…å«ç‰¹å®šæŒ‡æ¨™çš„è¨˜éŒ„
SELECT * FROM technical_indicators 
WHERE trend_indicators ? 'macd'  -- æª¢æŸ¥ JSON éµæ˜¯å¦å­˜åœ¨
  AND calculation_date = '2024-12-24';
```

**UPSERT èªæ³•ï¼ˆMyBatisï¼‰**:
```sql
INSERT INTO technical_indicators (
    stock_id, calculation_date, 
    trend_indicators, momentum_indicators, volatility_indicators, volume_indicators,
    ma5, ma20, ma60, rsi_14, stoch_k, stoch_d, atr_14, obv,
    calculation_version, calculation_engine
) VALUES (
    '2330', '2024-12-24',
    '{"ma": {"ma5": 580.5, "ma20": 570.8}, ...}'::jsonb,
    '{"rsi": {"rsi_14": 65.5}, ...}'::jsonb,
    '{"bbands": {...}}'::jsonb,
    '{"obv": 125000000000, ...}'::jsonb,
    580.5, 570.8, 565.0, 65.5, 75.2, 72.8, 12.5, 125000000000,
    'v2.0', 'pandas-ta'
)
ON CONFLICT (stock_id, calculation_date)
DO UPDATE SET
    trend_indicators = EXCLUDED.trend_indicators,
    momentum_indicators = EXCLUDED.momentum_indicators,
    volatility_indicators = EXCLUDED.volatility_indicators,
    volume_indicators = EXCLUDED.volume_indicators,
    ma5 = EXCLUDED.ma5,
    ma20 = EXCLUDED.ma20,
    rsi_14 = EXCLUDED.rsi_14,
    stoch_k = EXCLUDED.stoch_k,
    stoch_d = EXCLUDED.stoch_d,
    atr_14 = EXCLUDED.atr_14,
    obv = EXCLUDED.obv,
    calculation_version = EXCLUDED.calculation_version,
    updated_at = CURRENT_TIMESTAMP;
```

---

#### 3.2.2 indicator_definitions (æŒ‡æ¨™å®šç¾©èˆ‡åƒæ•¸è¡¨)

```sql
-- PostgreSQL å»ºè¡¨èªæ³•
CREATE TABLE indicator_definitions (
    definition_id       BIGSERIAL PRIMARY KEY,
    indicator_name      VARCHAR(50) NOT NULL UNIQUE,
    indicator_category  VARCHAR(50) NOT NULL CHECK (indicator_category IN (
        'TREND', 'MOMENTUM', 'VOLATILITY', 'VOLUME', 
        'SUPPORT_RESISTANCE', 'CYCLE', 'STATISTICAL', 'COMPOSITE'
    )),
    indicator_name_zh   VARCHAR(100),
    description         TEXT,
    
    -- åƒæ•¸å®šç¾©ï¼ˆJSONBï¼‰
    default_params      JSONB NOT NULL,
    param_ranges        JSONB,
    
    -- è¨ˆç®—è³‡è¨Š
    calculation_formula TEXT,
    pandas_ta_function  VARCHAR(50),
    min_data_points     INTEGER,
    
    -- è¼¸å‡ºè³‡è¨Š
    output_fields       JSONB,
    value_range         JSONB,
    
    -- å„ªå…ˆç´šèˆ‡å•Ÿç”¨ç‹€æ…‹
    priority            VARCHAR(10) CHECK (priority IN ('P0', 'P1', 'P2')),
    is_active           BOOLEAN DEFAULT TRUE,
    is_cached           BOOLEAN DEFAULT FALSE,
    
    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_indicator_definitions_category ON indicator_definitions(indicator_category);
CREATE INDEX idx_indicator_definitions_priority ON indicator_definitions(priority);
CREATE INDEX idx_indicator_definitions_active ON indicator_definitions(is_active);

-- GIN ç´¢å¼•
CREATE INDEX idx_indicator_definitions_params ON indicator_definitions USING GIN(default_params);

-- è‡ªå‹•æ›´æ–° updated_at è§¸ç™¼å™¨
CREATE TRIGGER update_indicator_definitions_updated_at
    BEFORE UPDATE ON indicator_definitions
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- è¡¨è¨»é‡‹
COMMENT ON TABLE indicator_definitions IS 'æŠ€è¡“æŒ‡æ¨™å®šç¾©èˆ‡åƒæ•¸é…ç½®è¡¨';
COMMENT ON COLUMN indicator_definitions.default_params IS 'é è¨­åƒæ•¸ JSONBï¼ˆå¦‚: {"period": 14}ï¼‰';
COMMENT ON COLUMN indicator_definitions.output_fields IS 'è¼¸å‡ºæ¬„ä½å®šç¾© JSONB';

-- æ’å…¥ç¯„ä¾‹è³‡æ–™
INSERT INTO indicator_definitions (
    indicator_name, indicator_category, indicator_name_zh, description,
    default_params, param_ranges, pandas_ta_function, min_data_points,
    output_fields, value_range, priority, is_active, is_cached
) VALUES
-- è¶¨å‹¢æŒ‡æ¨™
('MA', 'TREND', 'ç°¡å–®ç§»å‹•å¹³å‡', 'è¨ˆç®—Nå¤©æ”¶ç›¤åƒ¹çš„å¹³å‡å€¼',
 '{"periods": [5, 10, 20, 60, 120, 240]}'::jsonb,
 '{"min_period": 2, "max_period": 500}'::jsonb,
 'sma', 2,
 '["ma5", "ma10", "ma20", "ma60", "ma120", "ma240"]'::jsonb,
 '{"min": 0, "max": null}'::jsonb,
 'P0', true, true),

('EMA', 'TREND', 'æŒ‡æ•¸ç§»å‹•å¹³å‡', 'çµ¦äºˆè¿‘æœŸåƒ¹æ ¼æ›´é«˜æ¬Šé‡çš„ç§»å‹•å¹³å‡',
 '{"periods": [12, 26, 50, 200]}'::jsonb,
 '{"min_period": 2, "max_period": 500}'::jsonb,
 'ema', 2,
 '["ema12", "ema26", "ema50", "ema200"]'::jsonb,
 '{"min": 0, "max": null}'::jsonb,
 'P0', true, true),

('MACD', 'TREND', 'MACDæŒ‡æ¨™', 'æŒ‡æ•¸å¹³æ»‘ç•°åŒç§»å‹•å¹³å‡ç·š',
 '{"fast": 12, "slow": 26, "signal": 9}'::jsonb,
 '{"fast": [5, 20], "slow": [20, 50], "signal": [5, 15]}'::jsonb,
 'macd', 26,
 '["macd_line", "signal_line", "histogram"]'::jsonb,
 '{"min": null, "max": null}'::jsonb,
 'P0', true, true),

('RSI', 'MOMENTUM', 'ç›¸å°å¼·å¼±æŒ‡æ¨™', 'æ¸¬é‡åƒ¹æ ¼è®Šå‹•é€Ÿåº¦å’Œå¹…åº¦',
 '{"period": 14}'::jsonb,
 '{"min_period": 5, "max_period": 30}'::jsonb,
 'rsi', 14,
 '["rsi_14"]'::jsonb,
 '{"min": 0, "max": 100}'::jsonb,
 'P0', true, true),

('STOCH', 'MOMENTUM', 'KDéš¨æ©ŸæŒ‡æ¨™', 'æ¸¬é‡æ”¶ç›¤åƒ¹åœ¨é«˜ä½å€é–“çš„ä½ç½®',
 '{"k": 9, "d": 3, "smooth_k": 3}'::jsonb,
 '{"k": [5, 20], "d": [2, 5], "smooth_k": [2, 5]}'::jsonb,
 'stoch', 9,
 '["stoch_k", "stoch_d"]'::jsonb,
 '{"min": 0, "max": 100}'::jsonb,
 'P0', true, true),

('BBANDS', 'VOLATILITY', 'å¸ƒæ—é€šé“', 'åƒ¹æ ¼çš„çµ±è¨ˆæ³¢å‹•ç¯„åœ',
 '{"period": 20, "std": 2}'::jsonb,
 '{"period": [10, 50], "std": [1, 3]}'::jsonb,
 'bbands', 20,
 '["upper", "middle", "lower"]'::jsonb,
 '{"min": 0, "max": null}'::jsonb,
 'P0', true, true),

('ATR', 'VOLATILITY', 'å¹³å‡çœŸå¯¦ç¯„åœ', 'æ¸¬é‡åƒ¹æ ¼æ³¢å‹•å¹…åº¦',
 '{"period": 14}'::jsonb,
 '{"period": [7, 30]}'::jsonb,
 'atr', 14,
 '["atr_14"]'::jsonb,
 '{"min": 0, "max": null}'::jsonb,
 'P0', true, true),

('OBV', 'VOLUME', 'èƒ½é‡æ½®', 'ç´¯ç©æˆäº¤é‡æŒ‡æ¨™',
 '{}'::jsonb,
 '{}'::jsonb,
 'obv', 1,
 '["obv"]'::jsonb,
 '{"min": null, "max": null}'::jsonb,
 'P0', true, true),

('ADX', 'TREND', 'å¹³å‡è¶¨å‘æŒ‡æ¨™', 'æ¸¬é‡è¶¨å‹¢å¼·åº¦',
 '{"period": 14}'::jsonb,
 '{"period": [7, 30]}'::jsonb,
 'adx', 14,
 '["adx", "plus_di", "minus_di"]'::jsonb,
 '{"min": 0, "max": 100}'::jsonb,
 'P0', true, true);
```

**è¨­è¨ˆèªªæ˜**:
- é›†ä¸­ç®¡ç†æ‰€æœ‰æŠ€è¡“æŒ‡æ¨™çš„å®šç¾©èˆ‡åƒæ•¸
- ä½¿ç”¨ JSONB å„²å­˜åƒæ•¸é…ç½®ï¼Œå½ˆæ€§æ“´å……
- æ”¯æ´å„ªå…ˆç´šåˆ†é¡ï¼ˆP0/P1/P2ï¼‰ï¼Œæ§åˆ¶è¨ˆç®—é »ç‡
- æä¾› pandas-ta å‡½æ•¸æ˜ å°„ï¼Œç°¡åŒ–è¨ˆç®—å¼•æ“å¯¦ä½œ

---

#### 3.2.3 indicator_calculation_jobs (æŒ‡æ¨™è¨ˆç®— Job è¨˜éŒ„è¡¨)

```sql
-- PostgreSQL å»ºè¡¨èªæ³•
CREATE TABLE indicator_calculation_jobs (
    job_id              BIGSERIAL PRIMARY KEY,
    job_type            VARCHAR(50) DEFAULT 'CALCULATE_INDICATORS',
    calculation_date    DATE NOT NULL,
    
    -- Job åƒæ•¸
    stock_list          TEXT[],
    indicator_priority  VARCHAR(10),
    
    -- åŸ·è¡Œè³‡è¨Š
    status              VARCHAR(20) DEFAULT 'PENDING' CHECK (status IN (
        'PENDING', 'RUNNING', 'SUCCESS', 'FAILED', 'CANCELLED'
    )),
    start_time          TIMESTAMP,
    end_time            TIMESTAMP,
    duration_seconds    INTEGER,
    
    -- çµ±è¨ˆè³‡è¨Šï¼ˆJSONBï¼‰
    statistics          JSONB DEFAULT '{}',
    
    -- éŒ¯èª¤è³‡è¨Š
    error_message       TEXT,
    error_stack_trace   TEXT,
    
    -- å¯©è¨ˆæ¬„ä½
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by          VARCHAR(50) DEFAULT 'SYSTEM'
);

-- ç´¢å¼•
CREATE INDEX idx_indicator_jobs_date ON indicator_calculation_jobs(calculation_date);
CREATE INDEX idx_indicator_jobs_status ON indicator_calculation_jobs(status);
CREATE INDEX idx_indicator_jobs_type ON indicator_calculation_jobs(job_type);

-- è¡¨è¨»é‡‹
COMMENT ON TABLE indicator_calculation_jobs IS 'æŠ€è¡“æŒ‡æ¨™è¨ˆç®— Job åŸ·è¡Œè¨˜éŒ„è¡¨';
COMMENT ON COLUMN indicator_calculation_jobs.statistics IS 'åŸ·è¡Œçµ±è¨ˆè³‡è¨Šï¼ˆç¸½ç­†æ•¸ã€æˆåŠŸç­†æ•¸ã€å¤±æ•—ç­†æ•¸ç­‰ï¼‰';
```

**statistics JSONB çµæ§‹ç¯„ä¾‹**:
```json
{
  "total_stocks": 1800,
  "success_count": 1785,
  "failed_count": 15,
  "skipped_count": 0,
  "indicators_calculated": ["MA", "EMA", "RSI", "MACD"],
  "failed_stocks": ["1234", "5678"],
  "average_time_per_stock_ms": 250
}
```

---

### 3.3 è³‡æ–™åº«è¦–åœ–ï¼ˆViewï¼‰

#### 3.3.1 v_latest_indicators (æœ€æ–°æŒ‡æ¨™è¦–åœ–)

```sql
-- å»ºç«‹è¦–åœ–ï¼šå–å¾—æ¯æª”è‚¡ç¥¨çš„æœ€æ–°æŒ‡æ¨™
CREATE OR REPLACE VIEW v_latest_indicators AS
SELECT 
    ti.stock_id,
    s.stock_name,
    ti.calculation_date,
    ti.ma5, ti.ma20, ti.ma60,
    ti.ema12, ti.ema26,
    ti.macd_value, ti.macd_signal, ti.macd_histogram,
    ti.rsi_14,
    ti.stoch_k, ti.stoch_d,
    ti.bbands_upper, ti.bbands_middle, ti.bbands_lower,
    ti.atr_14,
    ti.obv,
    ti.adx_14,
    ti.trend_indicators,
    ti.momentum_indicators,
    ti.volatility_indicators,
    ti.volume_indicators
FROM technical_indicators ti
JOIN stocks s ON ti.stock_id = s.stock_id
WHERE ti.calculation_date = (
    SELECT MAX(calculation_date) 
    FROM technical_indicators 
    WHERE stock_id = ti.stock_id
)
AND s.is_active = true;

COMMENT ON VIEW v_latest_indicators IS 'æ¯æª”è‚¡ç¥¨çš„æœ€æ–°æŠ€è¡“æŒ‡æ¨™ï¼ˆæ´»èºè‚¡ç¥¨ï¼‰';
```

---

#### 3.3.2 v_golden_cross_candidates (é»ƒé‡‘äº¤å‰å€™é¸è¦–åœ–)

```sql
-- å»ºç«‹è¦–åœ–ï¼šåµæ¸¬ MA5 ä¸Šç©¿ MA20 çš„è‚¡ç¥¨
CREATE OR REPLACE VIEW v_golden_cross_candidates AS
WITH today_data AS (
    SELECT stock_id, ma5, ma20, calculation_date
    FROM technical_indicators
    WHERE calculation_date = CURRENT_DATE - INTERVAL '1 day'
),
yesterday_data AS (
    SELECT stock_id, ma5, ma20
    FROM technical_indicators ti1
    WHERE calculation_date = (
        SELECT MAX(calculation_date)
        FROM technical_indicators ti2
        WHERE ti2.stock_id = ti1.stock_id
          AND ti2.calculation_date < (CURRENT_DATE - INTERVAL '1 day')
    )
)
SELECT 
    t.stock_id,
    s.stock_name,
    t.calculation_date as cross_date,
    t.ma5 as today_ma5,
    t.ma20 as today_ma20,
    y.ma5 as yesterday_ma5,
    y.ma20 as yesterday_ma20,
    'GOLDEN_CROSS' as signal_type
FROM today_data t
JOIN yesterday_data y ON t.stock_id = y.stock_id
JOIN stocks s ON t.stock_id = s.stock_id
WHERE y.ma5 < y.ma20
  AND t.ma5 > t.ma20
  AND s.is_active = true;

COMMENT ON VIEW v_golden_cross_candidates IS 'MA5ä¸Šç©¿MA20é»ƒé‡‘äº¤å‰å€™é¸è‚¡ç¥¨';
```


### 3.4 JPA vs MyBatis ä½¿ç”¨å ´æ™¯

| è³‡æ–™è¡¨ | ç°¡å–® CRUD | è¤‡é›œæŸ¥è©¢ | æ‰¹æ¬¡æ“ä½œ | çµ±è¨ˆæŸ¥è©¢ |
|-------|----------|---------|---------|---------|
| technical_indicators | JPA | **MyBatis** | **MyBatis** | **MyBatis** |
| indicator_definitions | JPA | JPA | JPA | JPA |
| indicator_calculation_jobs | JPA | JPA | JPA | JPA |

**ä½¿ç”¨åŸå‰‡**:
- **JPA**: å–®ç­†æŸ¥è©¢ã€ç°¡å–®æ¢ä»¶ã€Entity ç®¡ç†
- **MyBatis**: æ‰¹æ¬¡ UPSERTã€JSONB æŸ¥è©¢ã€äº¤å‰ä¿¡è™Ÿåµæ¸¬ã€è¶…è²·è¶…è³£æŸ¥è©¢

---

---

## 4. API è¨­è¨ˆ

### 4.1 API åˆ—è¡¨ç¸½è¦½

| APIç·¨è™Ÿ | ç«¯é» | æ–¹æ³• | èªªæ˜ | å„ªå…ˆç´š |
|--------|------|------|------|-------|
| API-M07-001 | /api/stocks/{id}/indicators | GET | æŸ¥è©¢å–®ä¸€è‚¡ç¥¨æŠ€è¡“æŒ‡æ¨™ | P0 |
| API-M07-002 | /api/stocks/{id}/indicators/{name} | GET | æŸ¥è©¢å–®ä¸€è‚¡ç¥¨ç‰¹å®šæŒ‡æ¨™ | P0 |
| API-M07-003 | /api/indicators/latest | GET | æ‰¹æ¬¡æŸ¥è©¢æœ€æ–°æŒ‡æ¨™ | P0 |
| API-M07-004 | /api/indicators/signals/crosses | GET | æŸ¥è©¢äº¤å‰ä¿¡è™Ÿ | P0 |
| API-M07-005 | /api/indicators/signals/overbought | GET | æŸ¥è©¢è¶…è²·è¶…è³£ä¿¡è™Ÿ | P1 |
| API-M07-006 | /api/indicators/definitions | GET | æŸ¥è©¢æŒ‡æ¨™å®šç¾©æ¸…å–® | P1 |
| API-M07-007 | /api/jobs/calculate-indicators | POST | æ‰‹å‹•è§¸ç™¼æŒ‡æ¨™è¨ˆç®— | P1 |

---

### 4.2 API è©³ç´°è¦æ ¼

#### API-M07-001: æŸ¥è©¢å–®ä¸€è‚¡ç¥¨æŠ€è¡“æŒ‡æ¨™

**Endpoint**: `GET /api/stocks/{stock_id}/indicators`

**Path Parameters**:
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ |
|-----|------|------|------|
| stock_id | String | Y | è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¦‚ 2330ï¼‰ |

**Query Parameters**:
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ | é è¨­å€¼ |
|-----|------|------|------|-------|
| start_date | String | N | é–‹å§‹æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ | 30å¤©å‰ |
| end_date | String | N | çµæŸæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ | ä»Šæ—¥ |
| indicators | String | N | æŒ‡æ¨™åç¨±æ¸…å–®ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰ | å…¨éƒ¨ |
| categories | String | N | æŒ‡æ¨™é¡åˆ¥ï¼ˆTREND, MOMENTUMç­‰ï¼‰ | å…¨éƒ¨ |

**Response** (éµå®ˆç¸½ç¶± 4.4 API çµ±ä¸€è¦ç¯„):
```json
{
  "success": true,
  "timestamp": "2024-12-27T10:30:00+08:00",
  "data": {
    "stock_id": "2330",
    "stock_name": "å°ç©é›»",
    "indicators": [
      {
        "calculation_date": "2024-12-24",
        "trend": {
          "ma5": 580.50,
          "ma20": 570.80,
          "ma60": 565.00,
          "ema12": 578.30,
          "ema26": 572.40,
          "macd": {
            "macd_line": 5.90,
            "signal_line": 4.20,
            "histogram": 1.70
          },
          "adx": {
            "adx": 25.50,
            "plus_di": 28.30,
            "minus_di": 15.20
          }
        },
        "momentum": {
          "rsi_14": 65.50,
          "stochastic": {
            "k": 75.20,
            "d": 72.80
          },
          "williams_r": -25.50
        },
        "volatility": {
          "bbands": {
            "upper": 590.00,
            "middle": 580.00,
            "lower": 570.00
          },
          "atr_14": 12.50
        },
        "volume": {
          "obv": 125000000000,
          "cmf_20": 0.35,
          "vwap": 578.50
        }
      }
    ],
    "total_count": 30
  },
  "error": null
}
```

**éŒ¯èª¤ç¢¼**:
| éŒ¯èª¤ç¢¼ | HTTP Status | èªªæ˜ |
|-------|------------|------|
| M07_STOCK_001 | 404 | è‚¡ç¥¨ä¸å­˜åœ¨ |
| M07_PARAM_001 | 400 | åƒæ•¸é©—è­‰å¤±æ•—ï¼ˆæ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼‰ |
| M07_INDICATOR_001 | 400 | æŒ‡æ¨™åç¨±ç„¡æ•ˆ |
| M07_NO_DATA_001 | 404 | æŸ¥ç„¡æŒ‡æ¨™è³‡æ–™ |

---

#### API-M07-002: æŸ¥è©¢å–®ä¸€è‚¡ç¥¨ç‰¹å®šæŒ‡æ¨™

**Endpoint**: `GET /api/stocks/{stock_id}/indicators/{indicator_name}`

**Path Parameters**:
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ |
|-----|------|------|------|
| stock_id | String | Y | è‚¡ç¥¨ä»£ç¢¼ |
| indicator_name | String | Y | æŒ‡æ¨™åç¨±ï¼ˆMAã€RSIã€MACDç­‰ï¼‰ |

**Query Parameters**:
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ | é è¨­å€¼ |
|-----|------|------|------|-------|
| start_date | String | N | é–‹å§‹æ—¥æœŸ | 30å¤©å‰ |
| end_date | String | N | çµæŸæ—¥æœŸ | ä»Šæ—¥ |

**Response** (éµå®ˆç¸½ç¶± 4.4 API çµ±ä¸€è¦ç¯„):
```json
{
  "success": true,
  "timestamp": "2024-12-27T10:30:00+08:00",
  "data": {
    "stock_id": "2330",
    "indicator_name": "RSI",
    "indicator_params": {"period": 14},
    "values": [
      {
        "date": "2024-12-24",
        "value": 65.50
      },
      {
        "date": "2024-12-23",
        "value": 63.20
      }
    ],
    "total_count": 30,
    "statistics": {
      "max": 75.30,
      "min": 45.20,
      "avg": 58.50,
      "current": 65.50,
      "previous": 63.20,
      "change": 2.30
    }
  },
  "error": null
}
```

---

#### API-M07-003: æ‰¹æ¬¡æŸ¥è©¢æœ€æ–°æŒ‡æ¨™

**Endpoint**: `GET /api/indicators/latest`

**Query Parameters**:
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ | é è¨­å€¼ |
|-----|------|------|------|-------|
| stock_ids | String | Y | è‚¡ç¥¨ä»£ç¢¼æ¸…å–®ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰ | - |
| indicators | String | N | æŒ‡æ¨™åç¨±æ¸…å–® | åŸºç¤çµ„ |

**Response** (éµå®ˆç¸½ç¶± 4.4 API çµ±ä¸€è¦ç¯„):
```json
{
  "success": true,
  "timestamp": "2024-12-27T10:30:00+08:00",
  "data": [
    {
      "stock_id": "2330",
      "stock_name": "å°ç©é›»",
      "calculation_date": "2024-12-24",
      "ma5": 580.50,
      "ma20": 570.80,
      "rsi_14": 65.50,
      "macd": {
        "macd_line": 5.90,
        "signal_line": 4.20,
        "histogram": 1.70
      }
    },
    {
      "stock_id": "2317",
      "stock_name": "é´»æµ·",
      "calculation_date": "2024-12-24",
      "ma5": 105.50,
      "ma20": 102.30,
      "rsi_14": 58.20
    }
  ],
  "error": null
}
```

---

#### API-M07-004: æŸ¥è©¢äº¤å‰ä¿¡è™Ÿ

**Endpoint**: `GET /api/indicators/signals/crosses`

**Query Parameters**:
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ | é è¨­å€¼ |
|-----|------|------|------|-------|
| cross_type | String | N | äº¤å‰é¡å‹ï¼ˆGOLDEN, DEATH, KDï¼‰ | å…¨éƒ¨ |
| date | String | N | æŸ¥è©¢æ—¥æœŸ | æœ€æ–°äº¤æ˜“æ—¥ |
| market_type | String | N | å¸‚å ´é¡å‹ï¼ˆTWSE, OTCï¼‰ | å…¨éƒ¨ |

**Response** (éµå®ˆç¸½ç¶± 4.4 API çµ±ä¸€è¦ç¯„):
```json
{
  "success": true,
  "timestamp": "2024-12-27T10:30:00+08:00",
  "data": {
    "cross_date": "2024-12-24",
    "signals": [
      {
        "stock_id": "2330",
        "stock_name": "å°ç©é›»",
        "cross_type": "GOLDEN_CROSS",
        "indicator": "MA",
        "short_period": 5,
        "long_period": 20,
        "short_value": 580.50,
        "long_value": 570.80,
        "previous_short": 568.20,
        "previous_long": 570.50,
        "signal_strength": "STRONG",
        "confidence_score": 75
      }
    ],
    "total_count": 2
  },
  "error": null
}
```

---

#### API-M07-005: æŸ¥è©¢è¶…è²·è¶…è³£ä¿¡è™Ÿ

**Endpoint**: `GET /api/indicators/signals/overbought`

**Query Parameters**:
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ | é è¨­å€¼ |
|-----|------|------|------|-------|
| signal_type | String | N | ä¿¡è™Ÿé¡å‹ï¼ˆOVERBOUGHT, OVERSOLDï¼‰ | å…¨éƒ¨ |
| indicator | String | N | æŒ‡æ¨™ï¼ˆRSI, KD, WILLIAMS_Rï¼‰ | å…¨éƒ¨ |
| date | String | N | æŸ¥è©¢æ—¥æœŸ | æœ€æ–°äº¤æ˜“æ—¥ |

**Response** (éµå®ˆç¸½ç¶± 4.4 API çµ±ä¸€è¦ç¯„):
```json
{
  "success": true,
  "timestamp": "2024-12-27T10:30:00+08:00",
  "data": {
    "signal_date": "2024-12-24",
    "signals": [
      {
        "stock_id": "1234",
        "stock_name": "XXé›»å­",
        "signal_type": "OVERBOUGHT",
        "indicator": "RSI",
        "indicator_value": 78.50,
        "threshold": 70,
        "duration_days": 3,
        "signal_strength": "STRONG",
        "confidence_score": 65
      }
    ],
    "total_count": 2
  },
  "error": null
}
```

---

#### API-M07-006: æŸ¥è©¢æŒ‡æ¨™å®šç¾©æ¸…å–®

**Endpoint**: `GET /api/indicators/definitions`

**Query Parameters**:
| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ | é è¨­å€¼ |
|-----|------|------|------|-------|
| category | String | N | æŒ‡æ¨™é¡åˆ¥ | å…¨éƒ¨ |
| priority | String | N | å„ªå…ˆç´šï¼ˆP0, P1, P2ï¼‰ | å…¨éƒ¨ |
| is_active | Boolean | N | æ˜¯å¦å•Ÿç”¨ | true |

**Response** (éµå®ˆç¸½ç¶± 4.4 API çµ±ä¸€è¦ç¯„):
```json
{
  "success": true,
  "timestamp": "2024-12-27T10:30:00+08:00",
  "data": [
    {
      "indicator_name": "RSI",
      "indicator_name_zh": "ç›¸å°å¼·å¼±æŒ‡æ¨™",
      "category": "MOMENTUM",
      "description": "æ¸¬é‡åƒ¹æ ¼è®Šå‹•é€Ÿåº¦å’Œå¹…åº¦",
      "default_params": {
        "period": 14
      },
      "param_ranges": {
        "min_period": 5,
        "max_period": 30
      },
      "output_fields": ["rsi_14"],
      "value_range": {
        "min": 0,
        "max": 100
      },
      "priority": "P0",
      "is_active": true
    }
  ],
  "total_count": 71
}
```

---

#### API-M07-007: æ‰‹å‹•è§¸ç™¼æŒ‡æ¨™è¨ˆç®—

**Endpoint**: `POST /api/jobs/calculate-indicators`

**Request Body**:
```json
{
  "calculation_date": "2024-12-24",
  "stock_ids": ["2330", "2317"],
  "indicator_priority": "P0",
  "force_recalculate": false
}
```

**Response** (éµå®ˆç¸½ç¶± 4.4 API çµ±ä¸€è¦ç¯„):
```json
{
  "success": true,
  "timestamp": "2024-12-27T10:30:00+08:00",
  "data": {
    "job_id": 12345,
    "job_type": "CALCULATE_INDICATORS",
    "status": "RUNNING",
    "calculation_date": "2024-12-24",
    "estimated_duration_seconds": 300
  },
  "error": null
}
```

### 4.3 éŒ¯èª¤ç¢¼å®šç¾©

éµå®ˆç¸½ç¶± 4.4 éŒ¯èª¤ç¢¼è¦ç¯„ã€‚

| éŒ¯èª¤ç¢¼ | HTTP Status | èªªæ˜ | è™•ç†å»ºè­° |
|-------|------------|------|---------|
| M07_STOCK_001 | 404 | è‚¡ç¥¨ä¸å­˜åœ¨ | æª¢æŸ¥è‚¡ç¥¨ä»£ç¢¼ |
| M07_PARAM_001 | 400 | åƒæ•¸é©—è­‰å¤±æ•— | æª¢æŸ¥æ—¥æœŸæ ¼å¼ã€ç¯„åœ |
| M07_INDICATOR_001 | 400 | æŒ‡æ¨™åç¨±ç„¡æ•ˆ | åƒç…§ indicator_definitions è¡¨ |
| M07_NO_DATA_001 | 404 | æŸ¥ç„¡æŒ‡æ¨™è³‡æ–™ | ç¢ºèªæŒ‡æ¨™å·²è¨ˆç®— |
| M07_CALC_001 | 500 | æŒ‡æ¨™è¨ˆç®—å¤±æ•— | æª¢æŸ¥æ­·å²è³‡æ–™å®Œæ•´æ€§ |

---

## 5. è³‡æ–™æµè¨­è¨ˆ

### 5.1 è³‡æ–™æµç¸½è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             M06 è³‡æ–™ç®¡ç†æ¨¡çµ„                          â”‚
â”‚         StockPriceUpdated äº‹ä»¶ç™¼å¸ƒ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                M07 æŠ€è¡“åˆ†ææ¨¡çµ„                       â”‚
â”‚                                                     â”‚
â”‚  1. æ¥æ”¶äº‹ä»¶ â†’ è§¸ç™¼æŒ‡æ¨™è¨ˆç®— Job                      â”‚
â”‚  2. æŸ¥è©¢æ­·å²è‚¡åƒ¹ï¼ˆstock_pricesï¼‰                     â”‚
â”‚  3. pandas-ta æ‰¹æ¬¡è¨ˆç®—æŒ‡æ¨™                          â”‚
â”‚  4. é©—è­‰è¨ˆç®—çµæœ                                    â”‚
â”‚  5. å„²å­˜è‡³ technical_indicators è¡¨                  â”‚
â”‚  6. å›å¯«å¸¸ç”¨æŒ‡æ¨™è‡³ stock_prices                      â”‚
â”‚  7. æ›´æ–° Redis å¿«å–                                 â”‚
â”‚  8. åµæ¸¬æŠ€è¡“ä¿¡è™Ÿï¼ˆäº¤å‰ã€è¶…è²·è¶…è³£ï¼‰                   â”‚
â”‚  9. ç”¢ç”Ÿä¿¡è™Ÿï¼ˆéµå®ˆ Signal Contractï¼‰                 â”‚
â”‚ 10. ç™¼å¸ƒ TechnicalSignalDetected äº‹ä»¶               â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  M13 ä¿¡è™Ÿ    â”‚                  â”‚  M14 é¸è‚¡    â”‚
â”‚  åˆ¤æ–·å¼•æ“    â”‚                  â”‚  å¼•æ“        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5.2 æ ¸å¿ƒæµç¨‹ï¼šæ¯æ—¥æŠ€è¡“æŒ‡æ¨™è¨ˆç®—

```
START: æ¯æ—¥æŠ€è¡“æŒ‡æ¨™è¨ˆç®— Job
  â†“
1. è§¸ç™¼æ¢ä»¶
   - æ™‚é–“ï¼šæ¯æ—¥ 15:30ï¼ˆç›¤å¾Œï¼‰
   - æˆ–æ¥æ”¶åˆ° StockPriceUpdated äº‹ä»¶
  â†“
2. å»ºç«‹ Job åŸ·è¡Œè¨˜éŒ„
   - æ’å…¥ indicator_calculation_jobs è¡¨
   - status = 'RUNNING'
  â†“
3. è¼‰å…¥é…ç½®
   - å¾ indicator_definitions è¡¨è¼‰å…¥å•Ÿç”¨çš„æŒ‡æ¨™
   - ä¾ priority åˆ†çµ„ï¼ˆP0 å„ªå…ˆï¼‰
  â†“
4. æŸ¥è©¢éœ€è¨ˆç®—çš„è‚¡ç¥¨æ¸…å–®
   - è‹¥ç‚ºäº‹ä»¶è§¸ç™¼ â†’ å¾äº‹ä»¶å–å¾— stock_ids
   - è‹¥ç‚ºæ’ç¨‹è§¸ç™¼ â†’ æŸ¥è©¢æ‰€æœ‰æ´»èºè‚¡ç¥¨
  â†“
5. æ‰¹æ¬¡è™•ç†ï¼ˆæ¯æ‰¹ 50 æª”è‚¡ç¥¨ï¼‰
   â†“
   5.1 å°æ¯æª”è‚¡ç¥¨ï¼š
       - æŸ¥è©¢æ­·å²è‚¡åƒ¹ï¼ˆæœ€è¿‘ 250 äº¤æ˜“æ—¥ï¼‰
       - é©—è­‰è³‡æ–™å……è¶³æ€§ï¼ˆmin_data_pointsï¼‰
       â†“
   5.2 ä½¿ç”¨ pandas-ta æ‰¹æ¬¡è¨ˆç®—
       - è½‰æ›ç‚º pandas DataFrame
       - å‘¼å« pandas-ta å‡½æ•¸ï¼ˆdf.ta.rsi(), df.ta.macd()...ï¼‰
       - è™•ç† NaN å€¼
       â†“
   5.3 é©—è­‰è¨ˆç®—çµæœ
       - æª¢æŸ¥å€¼åŸŸç¯„åœï¼ˆRSI: 0-100ï¼‰
       - æª¢æŸ¥ NaNã€Inf
       - è¨˜éŒ„ç•°å¸¸å€¼
       â†“
   5.4 çµ„è£ JSONB è³‡æ–™
       - ä¾é¡åˆ¥çµ„è£ï¼ˆtrend_indicators, momentum_indicators...ï¼‰
       - å¡«å……å†—é¤˜æ¬„ä½ï¼ˆma5, rsi_14...ï¼‰
       â†“
   5.5 æ‰¹æ¬¡ UPSERTï¼ˆMyBatisï¼‰
       - å„²å­˜è‡³ technical_indicators è¡¨
       - ON CONFLICT DO UPDATE
       â†“
   5.6 å›å¯«å¸¸ç”¨æŒ‡æ¨™
       - UPDATE stock_prices SET ma5=?, ma20=?, volume_ma5=?
       â†“
   5.7 æ›´æ–° Redis å¿«å–
       - è‹¥ç‚ºç†±é–€è‚¡ç¥¨ â†’ ä¸»å‹•æ›´æ–°å¿«å–
       - æ¸…é™¤èˆŠå¿«å–éµ
  â†“
6. åµæ¸¬æŠ€è¡“ä¿¡è™Ÿ
   - é»ƒé‡‘äº¤å‰/æ­»äº¡äº¤å‰åµæ¸¬
   - KD äº¤å‰åµæ¸¬
   - è¶…è²·è¶…è³£åµæ¸¬
   â†“
7. ç”¢ç”Ÿä¿¡è™Ÿï¼ˆéµå®ˆç¸½ç¶± 4.1 Signal Contractï¼‰
   - signal_source = 'M07_TECHNICAL_ANALYSIS'
   - signal_name = 'MA_GOLDEN_CROSS' / 'RSI_OVERBOUGHT'...
   - evidence_data å¡«å……æŒ‡æ¨™å€¼
  â†“
8. ç™¼å¸ƒäº‹ä»¶
   - TechnicalSignalDetected äº‹ä»¶
   - è¨‚é–±è€…ï¼šM13 ä¿¡è™Ÿåˆ¤æ–·å¼•æ“
  â†“
9. æ›´æ–° Job åŸ·è¡Œè¨˜éŒ„
   - status = 'SUCCESS' / 'FAILED'
   - statistics å¡«å……ï¼ˆæˆåŠŸç­†æ•¸ã€å¤±æ•—ç­†æ•¸ï¼‰
   - end_time, duration_seconds
  â†“
END
```

---

### 5.3 æµç¨‹ï¼šæŸ¥è©¢æŠ€è¡“æŒ‡æ¨™ï¼ˆå«å¿«å–ï¼‰

```
START: API è«‹æ±‚æŸ¥è©¢æŒ‡æ¨™
  â†“
1. æ¥æ”¶è«‹æ±‚
   - stock_id, start_date, end_date, indicators
  â†“
2. åƒæ•¸é©—è­‰
   - è‚¡ç¥¨ä»£ç¢¼æ ¼å¼
   - æ—¥æœŸç¯„åœåˆç†æ€§ï¼ˆä¸è¶…é 1 å¹´ï¼‰
   - æŒ‡æ¨™åç¨±æœ‰æ•ˆæ€§
   â†“
3. æª¢æŸ¥ Redis å¿«å–
   - Key: tech:indicators:{stock_id}:{start_date}:{end_date}
   â”œâ”€ å‘½ä¸­ â†’ è¿”å›å¿«å–è³‡æ–™
   â””â”€ æœªå‘½ä¸­ â†’ ç¹¼çºŒ
  â†“
4. æŸ¥è©¢ PostgreSQL
   - ä½¿ç”¨ MyBatis è¤‡é›œæŸ¥è©¢
   - è§£æ JSONB æ¬„ä½
   - éæ¿¾æŒ‡å®šæ—¥æœŸç¯„åœ
  â†“
5. è³‡æ–™è½‰æ›
   - å°‡ JSONB å±•é–‹ç‚º JSON ç‰©ä»¶
   - çµ„è£ Response æ ¼å¼
  â†“
6. å¯«å…¥ Redis å¿«å–
   - åºåˆ—åŒ–ç‚º JSON
   - è¨­å®š TTLï¼ˆ6 å°æ™‚ï¼‰
  â†“
7. è¿”å›çµæœ
   - éµå®ˆç¸½ç¶± 4.4 API Response æ ¼å¼
  â†“
END
```

---

### 5.4 æµç¨‹ï¼šäº¤å‰ä¿¡è™Ÿåµæ¸¬


START: åµæ¸¬é»ƒé‡‘äº¤å‰ä¿¡è™Ÿ
  â†“
1. å–å¾—ä»Šæ—¥æŒ‡æ¨™
   - æŸ¥è©¢ technical_indicators
   - WHERE calculation_date = TODAY
   - å–å¾— ma5, ma20
  â†“
2. å–å¾—æ˜¨æ—¥æŒ‡æ¨™
   - æŸ¥è©¢ technical_indicators
   - WHERE calculation_date = YESTERDAY
   - å–å¾— ma5, ma20
  â†“
3. åˆ¤æ–·äº¤å‰æ¢ä»¶
   â”œâ”€ æ˜¨æ—¥ï¼šma5 < ma20 AND ä»Šæ—¥ï¼šma5 > ma20
   â”‚   â†’ é»ƒé‡‘äº¤å‰ï¼ˆGOLDEN_CROSSï¼‰
   â”‚
   â”œâ”€ æ˜¨æ—¥ï¼šma5 > ma20 AND ä»Šæ—¥ï¼šma5 < ma20
   â”‚   â†’ æ­»äº¡äº¤å‰ï¼ˆDEATH_CROSSï¼‰
   â”‚
   â””â”€ å¦ â†’ ç„¡äº¤å‰ï¼ŒçµæŸ
  â†“
4. ç”¢ç”Ÿä¿¡è™Ÿï¼ˆéµå®ˆç¸½ç¶± 4.1 Signal Contractï¼‰
   - signal_uuid = UUID
   - signal_type = 'BUY' / 'SELL'
   - signal_source = 'M07_TECHNICAL_ANALYSIS'
   - signal_name = 'MA_GOLDEN_CROSS' / 'MA_DEATH_CROSS'
   - signal_category = 'TREND_CROSS'
   - confidence_score = 70
   - evidence_data = {
       indicator: 'MA',
       short_period: 5,
       long_period: 20,
       today_ma5: å€¼,
       today_ma20: å€¼,
       yesterday_ma5: å€¼,
       yesterday_ma20: å€¼,
       cross_date: æ—¥æœŸ
     }
  â†“
5. å„²å­˜ä¿¡è™Ÿï¼ˆç™¼é€è‡³ M13ï¼‰
   - æ’å…¥ signals è¡¨ï¼ˆéµå®ˆ Signal Contractï¼‰
   - æˆ–é€é Event ç™¼å¸ƒçµ¦ M13
  


## 6. Job/æ’ç¨‹è¨­è¨ˆ

### 6.1 Job åˆ—è¡¨

| Jobç·¨è™Ÿ | Jobåç¨± | åŸ·è¡Œé »ç‡ | åŸ·è¡Œæ™‚é–“ | å„ªå…ˆç´š | èªªæ˜ |
|--------|---------|---------|---------|-------|------|
| JOB-M07-001 | åŸºç¤æŒ‡æ¨™è¨ˆç®— | æ¯æ—¥ | 15:30 | P0 | è¨ˆç®— P0 åŸºç¤çµ„ 11 å€‹æŒ‡æ¨™ |
| JOB-M07-002 | é€²éšæŒ‡æ¨™è¨ˆç®— | æ¯æ—¥ | 16:00 | P1 | è¨ˆç®— P1 é€²éšçµ„ 20 å€‹æŒ‡æ¨™ |
| JOB-M07-003 | å°ˆæ¥­æŒ‡æ¨™è¨ˆç®— | æ¯é€±ä¸€ | 18:00 | P2 | è¨ˆç®— P2 å°ˆæ¥­çµ„ 40 å€‹æŒ‡æ¨™ |
| JOB-M07-004 | äº¤å‰ä¿¡è™Ÿåµæ¸¬ | æ¯æ—¥ | 16:30 | P0 | åµæ¸¬é»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰ |
| JOB-M07-005 | è¶…è²·è¶…è³£åµæ¸¬ | æ¯æ—¥ | 16:30 | P0 | åµæ¸¬ RSIã€KD è¶…è²·è¶…è³£ |
| JOB-M07-006 | å¿«å–é ç†± | æ¯æ—¥ | 07:00 | P1 | é è¼‰ç†±é–€è‚¡ç¥¨æŒ‡æ¨™è‡³ Redis |
| JOB-M07-007 | æ­·å²æŒ‡æ¨™å›å¡« | æ‰‹å‹•è§¸ç™¼ | - | P2 | å›å¡«æ­·å²è³‡æ–™çš„æŒ‡æ¨™è¨ˆç®— |

---

### 6.2 Job è¨­è¨ˆè©³ç´°è¦æ ¼

#### JOB-M07-001: åŸºç¤æŒ‡æ¨™è¨ˆç®—

**Job è³‡è¨Š**:
- **Job ID**: JOB-M07-001
- **Job åç¨±**: åŸºç¤æŒ‡æ¨™è¨ˆç®—
- **åŸ·è¡Œé »ç‡**: æ¯æ—¥ï¼ˆé€±ä¸€ï½é€±äº”ï¼‰
- **åŸ·è¡Œæ™‚é–“**: 15:30ï¼ˆç›¤å¾Œ 30 åˆ†é˜ï¼‰
- **é ä¼°åŸ·è¡Œæ™‚é–“**: 15-20 åˆ†é˜
- **å„ªå…ˆç´š**: P0ï¼ˆæœ€é«˜ï¼‰

**è§¸ç™¼æ¢ä»¶**:
- å®šæ™‚è§¸ç™¼ï¼šæ¯æ—¥ 15:30ï¼ˆCron: `0 30 15 * * MON-FRI`ï¼‰
- äº‹ä»¶è§¸ç™¼ï¼šæ¥æ”¶åˆ° M06 `StockPriceUpdated` äº‹ä»¶ï¼ˆå»¶é² 30 åˆ†é˜å¾Œè§¸ç™¼ï¼‰

**Job åƒæ•¸**:
```json
{
  "calculation_date": "2024-12-24",
  "indicator_priority": "P0",
  "stock_list": null,  // null = æ‰€æœ‰æ´»èºè‚¡ç¥¨
  "force_recalculate": false,
  "batch_size": 50
}
```

**åŸ·è¡Œæµç¨‹**:
```
1. å»ºç«‹ Job åŸ·è¡Œè¨˜éŒ„
   INSERT INTO indicator_calculation_jobs (
     job_type, calculation_date, indicator_priority, status
   ) VALUES ('CALCULATE_INDICATORS', '2024-12-24', 'P0', 'RUNNING')
   
2. æŸ¥è©¢éœ€è¨ˆç®—çš„è‚¡ç¥¨æ¸…å–®
   SELECT stock_id FROM stocks WHERE is_active = true
   è‹¥ stock_list åƒæ•¸é NULLï¼Œå‰‡åªè¨ˆç®—æŒ‡å®šè‚¡ç¥¨
   
3. è¼‰å…¥ P0 æŒ‡æ¨™å®šç¾©
   SELECT * FROM indicator_definitions 
   WHERE priority = 'P0' AND is_active = true
   
4. æ‰¹æ¬¡è™•ç†ï¼ˆæ¯æ‰¹ 50 æª”è‚¡ç¥¨ï¼‰
   FOR EACH batch IN stock_batches:
     4.1 æŸ¥è©¢æ­·å²è‚¡åƒ¹ï¼ˆæœ€è¿‘ 250 äº¤æ˜“æ—¥ï¼‰
         SELECT * FROM stock_prices 
         WHERE stock_id IN (batch) 
           AND trade_date >= CURRENT_DATE - INTERVAL '250 days'
         ORDER BY trade_date
     
     4.2 pandas-ta æ‰¹æ¬¡è¨ˆç®—
         df.ta.sma(length=[5, 20, 60])
         df.ta.ema(length=[12, 26, 50])
         df.ta.macd(fast=12, slow=26, signal=9)
         df.ta.rsi(length=14)
         df.ta.stoch(k=9, d=3, smooth_k=3)
         df.ta.bbands(length=20, std=2)
         df.ta.atr(length=14)
         df.ta.obv()
         df.ta.vwap()
         df.ta.adx(length=14)
     
     4.3 é©—è­‰è¨ˆç®—çµæœ
         - æª¢æŸ¥ NaNï¼ˆè³‡æ–™ä¸è¶³æœŸé–“å…è¨±ï¼‰
         - æª¢æŸ¥å€¼åŸŸç¯„åœï¼ˆRSI: 0-100ï¼‰
         - æª¢æŸ¥ç•°å¸¸å€¼
     
     4.4 çµ„è£ JSONB
         trend_indicators = {
           "ma": {"ma5": ..., "ma20": ..., "ma60": ...},
           "ema": {"ema12": ..., "ema26": ..., "ema50": ...},
           "macd": {...},
           "adx": {...}
         }
         
     4.5 æ‰¹æ¬¡ UPSERT
         INSERT INTO technical_indicators (...) VALUES (...)
         ON CONFLICT (stock_id, calculation_date) DO UPDATE ...
     
     4.6 å›å¯« stock_prices
         UPDATE stock_prices 
         SET ma5 = ?, ma20 = ?, volume_ma5 = ?
         WHERE stock_id = ? AND trade_date = ?
   
5. æ›´æ–° Redis å¿«å–ï¼ˆç†±é–€è‚¡ç¥¨ï¼‰
   ç†±é–€è‚¡ç¥¨æ¸…å–®ï¼ˆå¸‚å€¼å‰ 50ï¼‰
   FOR EACH hot_stock:
     Redis.set("tech:indicators:{stock_id}:{date}", data, TTL=1h)
   
6. æ›´æ–° Job åŸ·è¡Œè¨˜éŒ„
   UPDATE indicator_calculation_jobs SET
     status = 'SUCCESS',
     end_time = CURRENT_TIMESTAMP,
     duration_seconds = ...,
     statistics = {
       "total_stocks": 1800,
       "success_count": 1785,
       "failed_count": 15,
       "indicators_calculated": ["MA", "EMA", "RSI", ...]
     }
   WHERE job_id = ?
```

**å†ªç­‰æ€§è¨­è¨ˆ**ï¼ˆéµå®ˆç¸½ç¶± 4.5ï¼‰:
- ä½¿ç”¨ PostgreSQL `ON CONFLICT ... DO UPDATE` ç¢ºä¿é‡è¤‡åŸ·è¡Œä¸ç”¢ç”Ÿé‡è¤‡è³‡æ–™
- Job åƒæ•¸åŒ…å« `calculation_date`ï¼Œç¢ºä¿å¯é‡è·‘ç‰¹å®šæ—¥æœŸ
- è‹¥ Job å¤±æ•—ï¼Œå¯å®‰å…¨é‡è©¦ï¼Œä¸æœƒç”¢ç”Ÿå‰¯ä½œç”¨

**éŒ¯èª¤è™•ç†**:
```
IF è³‡æ–™åº«é€£ç·šå¤±æ•—:
  - å›æ»¾äº¤æ˜“
  - Job status = 'FAILED'
  - è¨˜éŒ„éŒ¯èª¤è¨Šæ¯
  - è§¸ç™¼é‡è©¦ï¼ˆæœ€å¤š 3 æ¬¡ï¼Œé–“éš” 5 åˆ†é˜ï¼‰

IF è¨ˆç®—çµæœç•°å¸¸ï¼ˆNaNã€Infï¼‰:
  - è¨˜éŒ„ data_quality_issues è¡¨
  - è·³éè©²è‚¡ç¥¨
  - ç¹¼çºŒè™•ç†å…¶ä»–è‚¡ç¥¨

IF å–®ä¸€è‚¡ç¥¨è™•ç†è¶…æ™‚ï¼ˆ> 1 åˆ†é˜ï¼‰:
  - è¨˜éŒ„è­¦å‘Š
  - è·³éè©²è‚¡ç¥¨
  - ç¹¼çºŒè™•ç†
```

**ç›£æ§æŒ‡æ¨™**:
- Job åŸ·è¡Œæ™‚é–“ï¼ˆç›®æ¨™ < 20 åˆ†é˜ï¼‰
- æˆåŠŸç‡ï¼ˆç›®æ¨™ > 99%ï¼‰
- å¹³å‡å–®è‚¡è™•ç†æ™‚é–“ï¼ˆç›®æ¨™ < 250msï¼‰
- å¿«å–å‘½ä¸­ç‡ï¼ˆç›®æ¨™ > 85%ï¼‰

---

#### JOB-M07-002: é€²éšæŒ‡æ¨™è¨ˆç®—

**Job è³‡è¨Š**:
- **Job ID**: JOB-M07-002
- **Job åç¨±**: é€²éšæŒ‡æ¨™è¨ˆç®—
- **åŸ·è¡Œé »ç‡**: æ¯æ—¥ï¼ˆé€±ä¸€ï½é€±äº”ï¼‰
- **åŸ·è¡Œæ™‚é–“**: 16:00ï¼ˆåŸºç¤æŒ‡æ¨™å®Œæˆå¾Œï¼‰
- **é ä¼°åŸ·è¡Œæ™‚é–“**: 20-25 åˆ†é˜
- **å„ªå…ˆç´š**: P1

**ä¾è³´é—œä¿‚**:
- å‰ç½®æ¢ä»¶ï¼šJOB-M07-001 å¿…é ˆæˆåŠŸå®Œæˆ
- æª¢æŸ¥æ©Ÿåˆ¶ï¼šæŸ¥è©¢ `indicator_calculation_jobs` è¡¨ç¢ºèª JOB-M07-001 ç‹€æ…‹ç‚º SUCCESS

**åŸ·è¡Œæµç¨‹**:
```
1. æª¢æŸ¥å‰ç½®æ¢ä»¶
   SELECT status FROM indicator_calculation_jobs 
   WHERE job_type = 'CALCULATE_INDICATORS'
     AND calculation_date = CURRENT_DATE
     AND indicator_priority = 'P0'
   
   IF status != 'SUCCESS':
     å»¶é²åŸ·è¡Œï¼ˆç­‰å¾… 5 åˆ†é˜å¾Œé‡è©¦ï¼‰
   
2. è¼‰å…¥ P1 æŒ‡æ¨™å®šç¾©
   SELECT * FROM indicator_definitions 
   WHERE priority = 'P1' AND is_active = true
   
3. æ‰¹æ¬¡è¨ˆç®—ï¼ˆæµç¨‹åŒ JOB-M07-001ï¼‰
   è¨ˆç®—æŒ‡æ¨™ï¼š
   - WMA, HMA
   - Stochastic RSI, Williams %R, CCI, MFI
   - Keltner Channel, Donchian Channel
   - AD Line, CMF
   - Aroon, Parabolic SAR, Supertrend
   - ROC, Momentum
   - Pivot Points, Fibonacci
   - Linear Regression, Slope, R-Squared
   
4. æ›´æ–° technical_indicators è¡¨ï¼ˆUPSERTï¼‰
   
5. æ›´æ–° Job åŸ·è¡Œè¨˜éŒ„
```

---

#### JOB-M07-003: å°ˆæ¥­æŒ‡æ¨™è¨ˆç®—

**Job è³‡è¨Š**:
- **Job ID**: JOB-M07-003
- **Job åç¨±**: å°ˆæ¥­æŒ‡æ¨™è¨ˆç®—
- **åŸ·è¡Œé »ç‡**: æ¯é€±ä¸€æ¬¡
- **åŸ·è¡Œæ™‚é–“**: æ¯é€±ä¸€ 18:00
- **é ä¼°åŸ·è¡Œæ™‚é–“**: 40-50 åˆ†é˜
- **å„ªå…ˆç´š**: P2

**Cron è¡¨é”å¼**: `0 0 18 * * MON`

**åŸ·è¡Œæµç¨‹**:
```
1. è¼‰å…¥ P2 æŒ‡æ¨™å®šç¾©ï¼ˆ40 å€‹æŒ‡æ¨™ï¼‰
   
2. è¨ˆç®—æ›´è€—æ™‚çš„å°ˆæ¥­æŒ‡æ¨™ï¼š
   - DEMA, TEMA, VWMA, ZLEMA
   - Ultimate Oscillator, CMO, TSI, KST
   - Standard Deviation, Historical Volatility, Mass Index
   - Hurst Exponent, DPO, Schaff Trend Cycle
   - Correlation Coefficient, Z-Score
   - Elder Ray, Coppock Curve, Qstick, Vortex, BOP
   - Ichimoku Cloud, TRIX
   
3. æ›´æ–° technical_indicators è¡¨
   
4. åŸ·è¡Œæ™‚é–“è¼ƒé•·ï¼Œéœ€ç›£æ§è¶…æ™‚
```

---

#### JOB-M07-004: äº¤å‰ä¿¡è™Ÿåµæ¸¬

**Job è³‡è¨Š**:
- **Job ID**: JOB-M07-004
- **Job åç¨±**: äº¤å‰ä¿¡è™Ÿåµæ¸¬
- **åŸ·è¡Œé »ç‡**: æ¯æ—¥
- **åŸ·è¡Œæ™‚é–“**: 16:30ï¼ˆåŸºç¤æŒ‡æ¨™è¨ˆç®—å®Œæˆå¾Œï¼‰
- **é ä¼°åŸ·è¡Œæ™‚é–“**: 3-5 åˆ†é˜
- **å„ªå…ˆç´š**: P0

**åŸ·è¡Œæµç¨‹**:
```
1. æª¢æŸ¥å‰ç½®æ¢ä»¶
   ç¢ºèª JOB-M07-001 å·²æˆåŠŸå®Œæˆ
   
2. è¼‰å…¥ä»Šæ—¥èˆ‡æ˜¨æ—¥æŒ‡æ¨™è³‡æ–™
   SELECT stock_id, ma5, ma20, ma60, stoch_k, stoch_d
   FROM technical_indicators
   WHERE calculation_date IN (CURRENT_DATE, CURRENT_DATE - INTERVAL '1 day')
   
3. åµæ¸¬é»ƒé‡‘äº¤å‰ï¼ˆMA5 ä¸Šç©¿ MA20ï¼‰
   SELECT t1.stock_id
   FROM technical_indicators t1
   JOIN technical_indicators t2 ON t1.stock_id = t2.stock_id
   WHERE t1.calculation_date = CURRENT_DATE
     AND t2.calculation_date = CURRENT_DATE - INTERVAL '1 day'
     AND t2.ma5 < t2.ma20
     AND t1.ma5 > t1.ma20
   
4. åµæ¸¬æ­»äº¡äº¤å‰ï¼ˆMA5 ä¸‹ç©¿ MA20ï¼‰
   
5. åµæ¸¬ KD äº¤å‰
   - K ç·šä¸Šç©¿ D ç·šä¸” K < 20ï¼ˆä½æª”é»ƒé‡‘äº¤å‰ï¼‰
   - K ç·šä¸‹ç©¿ D ç·šä¸” K > 80ï¼ˆé«˜æª”æ­»äº¡äº¤å‰ï¼‰
   
6. ç”¢ç”Ÿä¿¡è™Ÿï¼ˆéµå®ˆç¸½ç¶± 4.1 Signal Contractï¼‰
   FOR EACH äº¤å‰ä¿¡è™Ÿ:
     INSERT INTO signals (
       signal_uuid, stock_id, signal_type, signal_source, signal_name,
       signal_category, trigger_price, confidence_score, evidence_data
     ) VALUES (
       UUID(), '2330', 'BUY', 'M07_TECHNICAL_ANALYSIS', 'MA_GOLDEN_CROSS',
       'TREND_CROSS', 580.0, 70, '{"indicator": "MA", ...}'::jsonb
     )
   
7. ç™¼å¸ƒäº‹ä»¶ï¼ˆTechnicalSignalDetectedï¼‰
   FOR EACH ä¿¡è™Ÿ:
     ç™¼å¸ƒè‡³ M13 ä¿¡è™Ÿåˆ¤æ–·å¼•æ“
   
8. æ›´æ–° Job åŸ·è¡Œè¨˜éŒ„
```

**ä¿¡è™Ÿç”¢ç”Ÿé‚è¼¯**:
```java
// é»ƒé‡‘äº¤å‰ä¿¡è™Ÿ
if (yesterday.ma5 < yesterday.ma20 && today.ma5 > today.ma20) {
    Signal signal = Signal.builder()
        .signalUuid(UUID.randomUUID())
        .stockId(stockId)
        .signalType(SignalType.BUY)
        .signalSource("M07_TECHNICAL_ANALYSIS")
        .signalName("MA_GOLDEN_CROSS")
        .signalCategory("TREND_CROSS")
        .triggerPrice(currentPrice)
        .confidenceScore(70)
        .evidenceData(buildEvidence(today, yesterday))
        .build();
    
    signalRepository.save(signal);
    eventPublisher.publish(new TechnicalSignalDetectedEvent(signal));
}
```

---

#### JOB-M07-005: è¶…è²·è¶…è³£åµæ¸¬

**Job è³‡è¨Š**:
- **Job ID**: JOB-M07-005
- **Job åç¨±**: è¶…è²·è¶…è³£åµæ¸¬
- **åŸ·è¡Œé »ç‡**: æ¯æ—¥
- **åŸ·è¡Œæ™‚é–“**: 16:30
- **é ä¼°åŸ·è¡Œæ™‚é–“**: 3-5 åˆ†é˜
- **å„ªå…ˆç´š**: P0

**åŸ·è¡Œæµç¨‹**:
```
1. æª¢æŸ¥å‰ç½®æ¢ä»¶
   
2. åµæ¸¬ RSI è¶…è²·ï¼ˆRSI > 70ï¼‰
   SELECT stock_id, rsi_14
   FROM technical_indicators
   WHERE calculation_date = CURRENT_DATE
     AND rsi_14 > 70
   
3. åµæ¸¬ RSI è¶…è³£ï¼ˆRSI < 30ï¼‰
   
4. è¨ˆç®—æŒçºŒå¤©æ•¸ï¼ˆé€£çºŒè¶…è²·/è¶…è³£ï¼‰
   SELECT stock_id, COUNT(*) as duration
   FROM technical_indicators
   WHERE calculation_date >= CURRENT_DATE - INTERVAL '7 days'
     AND rsi_14 > 70
   GROUP BY stock_id
   HAVING COUNT(*) >= 3
   
5. åµæ¸¬ KD è¶…è²·ï¼ˆK > 80 AND D > 80ï¼‰
   
6. åµæ¸¬ KD è¶…è³£ï¼ˆK < 20 AND D < 20ï¼‰
   
7. åµæ¸¬ Williams %R è¶…è²·ï¼ˆ> -20ï¼‰
   
8. åµæ¸¬ Williams %R è¶…è³£ï¼ˆ< -80ï¼‰
   
9. ç”¢ç”Ÿä¿¡è™Ÿ
   - æŒçºŒå¤©æ•¸è¶Šé•·ï¼Œconfidence_score è¶Šé«˜
   - æŒçºŒ 1 å¤©ï¼šconfidence = 60
   - æŒçºŒ 3 å¤©ï¼šconfidence = 70
   - æŒçºŒ 5 å¤©ä»¥ä¸Šï¼šconfidence = 75
   
10. ç™¼å¸ƒäº‹ä»¶
```

---

#### JOB-M07-006: å¿«å–é ç†±

**Job è³‡è¨Š**:
- **Job ID**: JOB-M07-006
- **Job åç¨±**: å¿«å–é ç†±
- **åŸ·è¡Œé »ç‡**: æ¯æ—¥
- **åŸ·è¡Œæ™‚é–“**: 07:00ï¼ˆé–‹ç›¤å‰ï¼‰
- **é ä¼°åŸ·è¡Œæ™‚é–“**: 1-2 åˆ†é˜
- **å„ªå…ˆç´š**: P1

**åŸ·è¡Œæµç¨‹**:
```
1. æŸ¥è©¢ç†±é–€è‚¡ç¥¨æ¸…å–®ï¼ˆå¸‚å€¼å‰ 50ï¼‰
   SELECT stock_id FROM stocks 
   WHERE is_active = true 
   ORDER BY market_cap DESC 
   LIMIT 50
   
2. å–å¾—æœ€æ–°äº¤æ˜“æ—¥
   SELECT MAX(calculation_date) FROM technical_indicators
   
3. å°æ¯æª”ç†±é–€è‚¡ç¥¨ï¼š
   FOR EACH hot_stock:
     3.1 æŸ¥è©¢æœ€æ–°æŒ‡æ¨™
         SELECT * FROM technical_indicators 
         WHERE stock_id = hot_stock 
           AND calculation_date = latest_date
     
     3.2 åºåˆ—åŒ–ç‚º JSON
     
     3.3 å¯«å…¥ Redis
         Key: tech:indicators:{stock_id}:{date}
         Value: JSON
         TTL: 1 å°æ™‚
   
4. é ç†±æŒ‡æ¨™å®šç¾©
   SELECT * FROM indicator_definitions WHERE is_active = true
   Redis.set("tech:config:indicators", JSON, TTL=æ°¸ä¹…)
   
5. è¨˜éŒ„é ç†±çµ±è¨ˆ
```

---

#### JOB-M07-007: æ­·å²æŒ‡æ¨™å›å¡«

**Job è³‡è¨Š**:
- **Job ID**: JOB-M07-007
- **Job åç¨±**: æ­·å²æŒ‡æ¨™å›å¡«
- **åŸ·è¡Œé »ç‡**: æ‰‹å‹•è§¸ç™¼
- **åŸ·è¡Œæ™‚é–“**: ä¸å®š
- **é ä¼°åŸ·è¡Œæ™‚é–“**: ä¾è³‡æ–™é‡è€Œå®šï¼ˆå¯èƒ½æ•¸å°æ™‚ï¼‰
- **å„ªå…ˆç´š**: P2

**ä½¿ç”¨å ´æ™¯**:
- ç³»çµ±é¦–æ¬¡ä¸Šç·šï¼Œéœ€å›å¡«æ­·å²è³‡æ–™
- æ–°è‚¡ä¸Šå¸‚ï¼Œéœ€è¨ˆç®—éå»çš„æŒ‡æ¨™
- æŒ‡æ¨™è¨ˆç®—é‚è¼¯æ›´æ–°ï¼Œéœ€é‡æ–°è¨ˆç®—

**åŸ·è¡Œæµç¨‹**:
```
1. æ¥æ”¶åƒæ•¸
   {
     "start_date": "2020-01-01",
     "end_date": "2024-12-24",
     "stock_ids": ["2330", "2317"] or null (å…¨éƒ¨è‚¡ç¥¨),
     "indicator_priority": "P0" or null (å…¨éƒ¨æŒ‡æ¨™)
   }
   
2. å»ºç«‹å›å¡« Job æ¸…å–®
   FOR date IN date_range(start_date, end_date):
     IF è©²æ—¥ç‚ºäº¤æ˜“æ—¥:
       å»ºç«‹å­ Jobï¼ˆé¡ä¼¼ JOB-M07-001ï¼‰
   
3. ä¾åºåŸ·è¡Œå­ Job
   - é¿å…ä¸¦è¡ŒåŸ·è¡Œéå¤šå°è‡´è³‡æºè€—ç›¡
   - æ¯åŸ·è¡Œ 10 å€‹å­ Job æš«åœ 30 ç§’
   
4. ç›£æ§é€²åº¦
   - è¨˜éŒ„å·²å®Œæˆå¤©æ•¸
   - é ä¼°å‰©é¤˜æ™‚é–“
   
5. å®Œæˆå¾Œé©—è­‰
   - æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§
   - çµ±è¨ˆç¼ºå¤±è¨˜éŒ„
```

---

### 6.3 Job èª¿åº¦èˆ‡ä¾è³´ç®¡ç†

**Job ä¾è³´é—œä¿‚åœ–**:
```
JOB-M07-001 (åŸºç¤æŒ‡æ¨™)
    â”œâ”€â†’ JOB-M07-002 (é€²éšæŒ‡æ¨™)
    â”œâ”€â†’ JOB-M07-004 (äº¤å‰ä¿¡è™Ÿ)
    â””â”€â†’ JOB-M07-005 (è¶…è²·è¶…è³£)

JOB-M07-003 (å°ˆæ¥­æŒ‡æ¨™) - ç¨ç«‹åŸ·è¡Œ

JOB-M07-006 (å¿«å–é ç†±) - ç¨ç«‹åŸ·è¡Œ

JOB-M07-007 (æ­·å²å›å¡«) - æ‰‹å‹•è§¸ç™¼
```

**èª¿åº¦ç­–ç•¥**:
- ä½¿ç”¨ Spring Boot `@Scheduled` è¨»è§£
- æˆ–ä½¿ç”¨ Quartz Schedulerï¼ˆæ›´è¤‡é›œå ´æ™¯ï¼‰
- Job åŸ·è¡Œç‹€æ…‹è¨˜éŒ„è‡³ `indicator_calculation_jobs` è¡¨

**å†ªç­‰æ€§ä¿è­‰**ï¼ˆç¸½ç¶± 4.5 è¦æ±‚ï¼‰:
- æ‰€æœ‰ Job ä½¿ç”¨ `calculation_date` åƒæ•¸
- è³‡æ–™åº«ä½¿ç”¨ `ON CONFLICT ... DO UPDATE`
- é‡è¤‡åŸ·è¡ŒåŒä¸€ Job ä¸ç”¢ç”Ÿå‰¯ä½œç”¨
- æ”¯æ´å®‰å…¨é‡è©¦

---

## 7. æ¥­å‹™é‚è¼¯è¨­è¨ˆ

> **èªªæ˜**: æœ¬ç¯€ä»¥æ–‡å­—æè¿°æ¥­å‹™é‚è¼¯èˆ‡æ¼”ç®—æ³•ï¼Œä¸åŒ…å«ç¨‹å¼ç¢¼å¯¦ä½œ

### 7.1 Service å±¤æ¶æ§‹

```
IndicatorCalculationService (æŒ‡æ¨™è¨ˆç®—æœå‹™ - é–€é¢)
    â”‚
    â”œâ”€â†’ PandasTaCalculationEngine (pandas-ta è¨ˆç®—å¼•æ“)
    â”‚       â”œâ”€ è·è²¬: å‘¼å« pandas-ta è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
    â”‚       â”œâ”€ ä¾è³´: JPype / REST API
    â”‚       â””â”€ æ ¸å¿ƒæ–¹æ³•: calculate(stockId, prices, priority)
    â”‚
    â”œâ”€â†’ SignalDetectionService (ä¿¡è™Ÿåµæ¸¬æœå‹™)
    â”‚       â”œâ”€ è·è²¬: åµæ¸¬äº¤å‰ã€è¶…è²·è¶…è³£ã€èƒŒé›¢ä¿¡è™Ÿ
    â”‚       â”œâ”€ ä¾è³´: TechnicalIndicatorRepository (JPA), TechnicalIndicatorMapper (MyBatis)
    â”‚       â””â”€ æ ¸å¿ƒæ–¹æ³•: detectCrossSignals(), detectOverboughtOversold()
    â”‚
    â”œâ”€â†’ IndicatorQueryService (æŒ‡æ¨™æŸ¥è©¢æœå‹™)
    â”‚       â”œâ”€ è·è²¬: æä¾›æŒ‡æ¨™æŸ¥è©¢ä»‹é¢ã€å¿«å–ç®¡ç†
    â”‚       â”œâ”€ ä¾è³´: TechnicalIndicatorMapper (MyBatis), RedisTemplate
    â”‚       â””â”€ æ ¸å¿ƒæ–¹æ³•: queryIndicators(), queryLatestIndicatorsBatch()
    â”‚
    â”œâ”€â†’ IndicatorValidationService (æŒ‡æ¨™é©—è­‰æœå‹™)
    â”‚       â”œâ”€ è·è²¬: é©—è­‰æŒ‡æ¨™è¨ˆç®—çµæœçš„æ­£ç¢ºæ€§èˆ‡åˆç†æ€§
    â”‚       â”œâ”€ ä¾è³´: IndicatorDefinitionRepository (JPA)
    â”‚       â””â”€ æ ¸å¿ƒæ–¹æ³•: validateRange(), validateConsistency()
    â”‚
    â””â”€â†’ CacheManagementService (å¿«å–ç®¡ç†æœå‹™)
            â”œâ”€ è·è²¬: å¿«å–é ç†±ã€å¿«å–æ›´æ–°ã€å¿«å–å¤±æ•ˆ
            â”œâ”€ ä¾è³´: RedisTemplate
            â””â”€ æ ¸å¿ƒæ–¹æ³•: warmupCache(), updateCache(), invalidateCache()
```

---

### 7.2 æŒ‡æ¨™è¨ˆç®—é‚è¼¯

#### 7.2.1 è¨ˆç®—æµç¨‹ç¸½è¦½

**è¼¸å…¥**: stock_id, calculation_date, indicator_priority  
**è¼¸å‡º**: è¨ˆç®—å®Œæˆçš„æŠ€è¡“æŒ‡æ¨™è³‡æ–™

**è™•ç†æ­¥é©Ÿ**:

**æ­¥é©Ÿ 1: æŸ¥è©¢æ­·å²è‚¡åƒ¹**
- å¾ stock_prices è¡¨æŸ¥è©¢æœ€è¿‘ 250 å€‹äº¤æ˜“æ—¥çš„è‚¡åƒ¹è³‡æ–™
- æª¢æŸ¥è³‡æ–™å……è¶³æ€§ï¼ˆè‡³å°‘éœ€è¦ 10 å€‹äº¤æ˜“æ—¥ï¼‰
- è‹¥è³‡æ–™ä¸è¶³ï¼Œæ¨™è¨˜ä¸¦è·³éé•·é€±æœŸæŒ‡æ¨™

**æ­¥é©Ÿ 2: è³‡æ–™æ ¼å¼è½‰æ›**
- å°‡è‚¡åƒ¹è³‡æ–™è½‰æ›ç‚º pandas DataFrame æ ¼å¼
- æ¬„ä½å°æ‡‰ï¼štrade_date â†’ date, close_price â†’ close, high_price â†’ high, low_price â†’ low, volume â†’ volume

**æ­¥é©Ÿ 3: ä¾å„ªå…ˆç´šè¼‰å…¥æŒ‡æ¨™å®šç¾©**
- P0 åŸºç¤çµ„ï¼š11 å€‹æŒ‡æ¨™ï¼ˆMAã€EMAã€RSIã€KDã€MACDã€BBandsã€ATRã€OBVã€Volume MAã€ADXã€VWAPï¼‰
- P1 é€²éšçµ„ï¼š20 å€‹æŒ‡æ¨™ï¼ˆWMAã€HMAã€Stochastic RSIã€Williams %Rã€CCIã€MFI ç­‰ï¼‰
- P2 å°ˆæ¥­çµ„ï¼š40 å€‹æŒ‡æ¨™ï¼ˆDEMAã€TEMAã€Ultimate Oscillatorã€Hurst Exponent ç­‰ï¼‰

**æ­¥é©Ÿ 4: å‘¼å« pandas-ta æ‰¹æ¬¡è¨ˆç®—**
- ä½¿ç”¨ pandas-ta çš„ `df.ta.*` æ–¹æ³•è¨ˆç®—æŒ‡æ¨™
- æ‰¹æ¬¡è¨ˆç®—åŒé¡åˆ¥æŒ‡æ¨™ï¼ˆå¦‚æ‰€æœ‰ MA é€±æœŸä¸€æ¬¡è¨ˆç®—å®Œæˆï¼‰
- è™•ç† NaN å€¼ï¼ˆè³‡æ–™ä¸è¶³æœŸé–“å…è¨± NaNï¼‰

**æ­¥é©Ÿ 5: é©—è­‰è¨ˆç®—çµæœ**
- æª¢æŸ¥å€¼åŸŸç¯„åœï¼ˆRSI: 0-100, Stochastic: 0-100 ç­‰ï¼‰
- æª¢æŸ¥ NaNã€Inf ç•°å¸¸å€¼
- æª¢æŸ¥åˆç†æ€§ï¼ˆMA å€¼æ‡‰æ¥è¿‘æ”¶ç›¤åƒ¹ï¼‰

**æ­¥é©Ÿ 6: çµ„è£ JSONB è³‡æ–™**
- ä¾é¡åˆ¥çµ„è£ JSONBï¼ˆtrend_indicators, momentum_indicators, volatility_indicators ç­‰ï¼‰
- å¡«å……å†—é¤˜æ¬„ä½ï¼ˆma5, ma20, rsi_14, stoch_k, stoch_d ç­‰ï¼‰

**æ­¥é©Ÿ 7: å„²å­˜è‡³è³‡æ–™åº«**
- ä½¿ç”¨ MyBatis æ‰¹æ¬¡ UPSERTï¼ˆON CONFLICT DO UPDATEï¼‰
- ç¢ºä¿å†ªç­‰æ€§ï¼ˆé‡è¤‡åŸ·è¡Œä¸ç”¢ç”Ÿé‡è¤‡è³‡æ–™ï¼‰

**æ­¥é©Ÿ 8: å›å¯«å¸¸ç”¨æŒ‡æ¨™è‡³ stock_prices**
- UPDATE stock_prices SET ma5=?, ma20=?, volume_ma5=? WHERE stock_id=? AND trade_date=?

**æ­¥é©Ÿ 9: æ›´æ–°å¿«å–**
- è‹¥ç‚ºç†±é–€è‚¡ç¥¨ï¼ˆå¸‚å€¼å‰ 50ï¼‰ï¼Œä¸»å‹•æ›´æ–° Redis å¿«å–
- æ¸…é™¤èˆŠå¿«å–éµ

---

#### 7.2.2 pandas-ta æ•´åˆç­–ç•¥

**æ–¹æ¡ˆ 1: JPype æ•´åˆï¼ˆæ¨è–¦ï¼‰**

**åˆå§‹åŒ–**:
```
ç³»çµ±å•Ÿå‹•æ™‚:
1. æª¢æŸ¥ Python ç’°å¢ƒæ˜¯å¦å­˜åœ¨
2. å•Ÿå‹• JVMï¼ˆJPype.startJVM()ï¼‰
3. è¼‰å…¥ pandasã€pandas_ta æ¨¡çµ„
4. æ¸¬è©¦é€£ç·šèˆ‡è¨ˆç®—åŠŸèƒ½
```

**è¨ˆç®—æµç¨‹**:
```
1. å¾ Java å‚³éè‚¡åƒ¹è³‡æ–™è‡³ Python
   - è½‰æ›ç‚º Python dict æ ¼å¼
   - å»ºç«‹ pandas DataFrame

2. å‘¼å« pandas-ta å‡½æ•¸
   - df.ta.sma(length=[5, 20, 60])  # ä¸€æ¬¡è¨ˆç®—å¤šå€‹é€±æœŸ
   - df.ta.ema(length=[12, 26, 50])
   - df.ta.macd(fast=12, slow=26, signal=9)
   - df.ta.rsi(length=14)
   - df.ta.stoch(k=9, d=3, smooth_k=3)
   - df.ta.bbands(length=20, std=2)
   - df.ta.atr(length=14)
   - df.ta.obv()
   - df.ta.vwap()
   - df.ta.adx(length=14)

3. å–å¾—è¨ˆç®—çµæœ
   - å¾ Python å›å‚³çµæœè‡³ Java
   - è½‰æ›ç‚º Java ç‰©ä»¶ï¼ˆIndicatorCalculationResultï¼‰
```

**éŒ¯èª¤è™•ç†**:
```
IF Python ç’°å¢ƒä¸å­˜åœ¨:
  - è¨˜éŒ„éŒ¯èª¤: "pandas-ta ç’°å¢ƒæœªå®‰è£"
  - é™ç´šä½¿ç”¨ Java åŸç”Ÿå¯¦ä½œï¼ˆta4jï¼‰æˆ–æ‹‹å‡ºç•°å¸¸

IF è¨ˆç®—è¶…æ™‚ï¼ˆ> 30 ç§’ï¼‰:
  - ä¸­æ–·è¨ˆç®—
  - è¨˜éŒ„è­¦å‘Š: "æŒ‡æ¨™è¨ˆç®—è¶…æ™‚"
  - è·³éè©²è‚¡ç¥¨

IF è¨ˆç®—ç•°å¸¸ï¼ˆExceptionï¼‰:
  - è¨˜éŒ„éŒ¯èª¤èˆ‡ stack trace
  - æ¨™è¨˜è©²è‚¡ç¥¨è¨ˆç®—å¤±æ•—
  - ç¹¼çºŒè™•ç†å…¶ä»–è‚¡ç¥¨
```

---

**æ–¹æ¡ˆ 2: REST API æ•´åˆ**

**æ¶æ§‹**:
```
Java Service â†’ HTTP Request â†’ Python Flask API â†’ pandas-ta â†’ Response â†’ Java
```

**Python Flask API ç«¯é»**:
```
POST /api/calculate
Request Body:
{
  "stock_id": "2330",
  "prices": [
    {"date": "2024-12-24", "close": 580.0, "high": 585.0, "low": 575.0, "volume": 35000000},
    ...
  ],
  "indicators": ["MA", "RSI", "MACD", "KD", "BBANDS", "ATR"]
}

Response:
{
  "stock_id": "2330",
  "indicators": {
    "MA": {"ma5": 580.5, "ma20": 570.8, "ma60": 565.0},
    "RSI": {"rsi_14": 65.5},
    ...
  }
}
```

**Java å‘¼å«é‚è¼¯**:
```
1. çµ„è£ HTTP Request
   - URL: http://localhost:8001/api/calculate
   - Method: POST
   - Body: JSONï¼ˆè‚¡åƒ¹è³‡æ–™ + æŒ‡æ¨™æ¸…å–®ï¼‰

2. ç™¼é€è«‹æ±‚ï¼ˆRestTemplate / WebClientï¼‰
   - è¨­å®šè¶…æ™‚æ™‚é–“: 30 ç§’
   - è¨­å®šé‡è©¦ç­–ç•¥: æœ€å¤š 3 æ¬¡

3. è§£æ Response
   - ååºåˆ—åŒ– JSON ç‚º Java ç‰©ä»¶
   - é©—è­‰çµæœå®Œæ•´æ€§

4. è¿”å›è¨ˆç®—çµæœ
```

**å„ªé»**:
- è§£è€¦åˆï¼ŒJava å’Œ Python ç¨ç«‹éƒ¨ç½²
- æ˜“æ–¼æ“´å±•ï¼ˆå¤šå€‹ Python ç¯€é»è² è¼‰å¹³è¡¡ï¼‰
- æ˜“æ–¼ç›£æ§ï¼ˆAPI å‘¼å«æ—¥èªŒã€æ•ˆèƒ½æŒ‡æ¨™ï¼‰

**ç¼ºé»**:
- ç¶²è·¯å»¶é²ï¼ˆå¢åŠ  10-50msï¼‰
- éœ€è¦é¡å¤–ç¶­è­· Python æœå‹™
- åºåˆ—åŒ–/ååºåˆ—åŒ–é–‹éŠ·

---

#### 7.2.3 æŒ‡æ¨™è¨ˆç®—åƒæ•¸ç®¡ç†

**è¼‰å…¥æŒ‡æ¨™å®šç¾©**:
```
æŸ¥è©¢ indicator_definitions è¡¨:
SELECT * FROM indicator_definitions 
WHERE priority = 'P0' 
  AND is_active = true
ORDER BY indicator_name

çµæœ:
[
  {indicator_name: 'MA', default_params: {periods: [5, 20, 60]}, pandas_ta_function: 'sma'},
  {indicator_name: 'RSI', default_params: {period: 14}, pandas_ta_function: 'rsi'},
  ...
]
```

**å‹•æ…‹çµ„è£è¨ˆç®—åƒæ•¸**:
```
FOR EACH æŒ‡æ¨™å®šç¾©:
  æå– pandas_ta_function åç¨±
  æå– default_params åƒæ•¸
  
  ç¯„ä¾‹:
  æŒ‡æ¨™: MA
  å‡½æ•¸: df.ta.sma
  åƒæ•¸: length=[5, 20, 60]
  
  å‘¼å«: df.ta.sma(length=[5, 20, 60])
  çµæœæ¬„ä½: SMA_5, SMA_20, SMA_60
```

**åƒæ•¸é©—è­‰**:
```
æª¢æŸ¥åƒæ•¸ç¯„åœï¼ˆparam_rangesï¼‰:
IF (å¯¦éš›åƒæ•¸ < min æˆ– å¯¦éš›åƒæ•¸ > max) THEN
  è¨˜éŒ„è­¦å‘Š: "åƒæ•¸è¶…å‡ºå»ºè­°ç¯„åœ"
  ä½¿ç”¨é è¨­åƒæ•¸
END IF

ç¯„ä¾‹:
RSI æœŸé–“ç¯„åœ: [5, 30]
è‹¥ä½¿ç”¨è€…è¨­å®š period=50 â†’ è­¦å‘Šä¸¦ä½¿ç”¨é è¨­ 14
```

---

### 7.3 ä¿¡è™Ÿåµæ¸¬é‚è¼¯

#### 7.3.1 é»ƒé‡‘äº¤å‰åµæ¸¬

**è¼¸å…¥**: stock_id, calculation_date  
**è¼¸å‡º**: é»ƒé‡‘äº¤å‰ä¿¡è™Ÿï¼ˆè‹¥åµæ¸¬åˆ°ï¼‰

**è™•ç†æ­¥é©Ÿ**:

**æ­¥é©Ÿ 1: å–å¾—ä»Šæ—¥èˆ‡æ˜¨æ—¥æŒ‡æ¨™**
```
æŸ¥è©¢ä»Šæ—¥æŒ‡æ¨™:
SELECT ma5, ma20, ma60 
FROM technical_indicators 
WHERE stock_id = '2330' 
  AND calculation_date = '2024-12-24'

æŸ¥è©¢æ˜¨æ—¥æŒ‡æ¨™:
SELECT ma5, ma20, ma60 
FROM technical_indicators 
WHERE stock_id = '2330' 
  AND calculation_date = '2024-12-23'
```

**æ­¥é©Ÿ 2: åˆ¤æ–· MA5 x MA20 äº¤å‰**
```
IF (æ˜¨æ—¥ ma5 < æ˜¨æ—¥ ma20) AND (ä»Šæ—¥ ma5 > ä»Šæ—¥ ma20) THEN
  åµæ¸¬åˆ°é»ƒé‡‘äº¤å‰
  
  è¨ˆç®—äº¤å‰å¼·åº¦:
  cross_strength = (ä»Šæ—¥ ma5 - ä»Šæ—¥ ma20) / ä»Šæ—¥ ma20 Ã— 100
  
  IF (cross_strength > 1%) THEN
    signal_strength = 'STRONG'
    confidence_score = 75
  ELSE
    signal_strength = 'WEAK'
    confidence_score = 70
  END IF
END IF
```

**æ­¥é©Ÿ 3: åˆ¤æ–· MA20 x MA60 äº¤å‰ï¼ˆé•·æœŸè¶¨å‹¢ï¼‰**
```
IF (æ˜¨æ—¥ ma20 < æ˜¨æ—¥ ma60) AND (ä»Šæ—¥ ma20 > ä»Šæ—¥ ma60) THEN
  åµæ¸¬åˆ°é•·æœŸé»ƒé‡‘äº¤å‰
  
  signal_strength = 'VERY_STRONG'  // é•·æœŸäº¤å‰æ›´å…·æ„ç¾©
  confidence_score = 80
END IF
```

**æ­¥é©Ÿ 4: ç”¢ç”Ÿä¿¡è™Ÿï¼ˆéµå®ˆç¸½ç¶± 4.1 Signal Contractï¼‰**
```
ä¿¡è™Ÿå…§å®¹:
- signal_uuid = UUID ç”Ÿæˆ
- stock_id = '2330'
- signal_type = 'BUY'
- signal_source = 'M07_TECHNICAL_ANALYSIS'
- signal_name = 'MA_GOLDEN_CROSS'
- signal_category = 'TREND_CROSS'
- trigger_price = ç•¶æœŸæ”¶ç›¤åƒ¹
- confidence_score = 70-80ï¼ˆä¾äº¤å‰å¼·åº¦ï¼‰
- evidence_data = {
    indicator: 'MA',
    short_period: 5,
    long_period: 20,
    today_ma5: 580.50,
    today_ma20: 570.80,
    yesterday_ma5: 568.20,
    yesterday_ma20: 570.50,
    cross_date: '2024-12-24',
    cross_strength: 1.7
  }
- detected_at = ç•¶å‰æ™‚é–“
```

**æ­¥é©Ÿ 5: å„²å­˜ä¿¡è™Ÿä¸¦ç™¼å¸ƒäº‹ä»¶**
```
å„²å­˜è‡³ signals è¡¨ï¼ˆéµå®ˆç¸½ç¶± Signal Contractï¼‰

ç™¼å¸ƒäº‹ä»¶:
Event Type: TechnicalSignalDetected
Event Data: {signal_uuid, stock_id, signal_type, signal_name, confidence_score}
è¨‚é–±è€…: M13 ä¿¡è™Ÿåˆ¤æ–·å¼•æ“
```

---

#### 7.3.2 æ­»äº¡äº¤å‰åµæ¸¬

**åˆ¤æ–·é‚è¼¯**:
```
IF (æ˜¨æ—¥ ma5 > æ˜¨æ—¥ ma20) AND (ä»Šæ—¥ ma5 < ä»Šæ—¥ ma20) THEN
  åµæ¸¬åˆ°æ­»äº¡äº¤å‰
  
  ä¿¡è™Ÿå…§å®¹:
  - signal_type = 'SELL'
  - signal_name = 'MA_DEATH_CROSS'
  - confidence_score = 70
END IF
```

---

#### 7.3.3 KD äº¤å‰åµæ¸¬

**ä½æª”é»ƒé‡‘äº¤å‰ï¼ˆå¼·å‹¢è²·é€²ä¿¡è™Ÿï¼‰**:
```
IF (æ˜¨æ—¥ K < æ˜¨æ—¥ D) AND (ä»Šæ—¥ K > ä»Šæ—¥ D) AND (ä»Šæ—¥ K < 20) THEN
  åµæ¸¬åˆ° KD ä½æª”é»ƒé‡‘äº¤å‰
  
  ä¿¡è™Ÿå…§å®¹:
  - signal_type = 'BUY'
  - signal_name = 'KD_GOLDEN_CROSS_LOW'
  - signal_category = 'MOMENTUM_CROSS'
  - confidence_score = 80  // ä½æª”äº¤å‰ï¼Œä¿¡å¿ƒåº¦æ›´é«˜
  - evidence_data = {
      indicator: 'KD',
      today_k: 18.5,
      today_d: 15.2,
      yesterday_k: 14.8,
      yesterday_d: 16.3,
      cross_position: 'LOW'  // ä½æª”ï¼ˆ< 20ï¼‰
    }
END IF
```

**é«˜æª”æ­»äº¡äº¤å‰ï¼ˆå¼·å‹¢è³£å‡ºä¿¡è™Ÿï¼‰**:
```
IF (æ˜¨æ—¥ K > æ˜¨æ—¥ D) AND (ä»Šæ—¥ K < ä»Šæ—¥ D) AND (ä»Šæ—¥ K > 80) THEN
  åµæ¸¬åˆ° KD é«˜æª”æ­»äº¡äº¤å‰
  
  ä¿¡è™Ÿå…§å®¹:
  - signal_type = 'SELL'
  - signal_name = 'KD_DEATH_CROSS_HIGH'
  - confidence_score = 80
  - evidence_data.cross_position = 'HIGH'  // é«˜æª”ï¼ˆ> 80ï¼‰
END IF
```

**ä¸€èˆ¬äº¤å‰ï¼ˆå¼±å‹¢ä¿¡è™Ÿï¼‰**:
```
IF (æ˜¨æ—¥ K < æ˜¨æ—¥ D) AND (ä»Šæ—¥ K > ä»Šæ—¥ D) AND (20 <= ä»Šæ—¥ K <= 80) THEN
  åµæ¸¬åˆ° KD ä¸€èˆ¬é»ƒé‡‘äº¤å‰
  
  ä¿¡è™Ÿå…§å®¹:
  - signal_type = 'BUY'
  - signal_name = 'KD_GOLDEN_CROSS'
  - confidence_score = 65  // ä¸­æ€§å€äº¤å‰ï¼Œä¿¡å¿ƒåº¦è¼ƒä½
  - evidence_data.cross_position = 'MIDDLE'
END IF
```

---

#### 7.3.4 è¶…è²·è¶…è³£åµæ¸¬

**RSI è¶…è²·åµæ¸¬**:

**æ­¥é©Ÿ 1: å–å¾—ç•¶æœŸ RSI å€¼**
```
æŸ¥è©¢æœ€æ–° RSI:
SELECT rsi_14 
FROM technical_indicators 
WHERE stock_id = '2330' 
  AND calculation_date = '2024-12-24'

çµæœ: rsi_14 = 78.5
```

**æ­¥é©Ÿ 2: è¨ˆç®—æŒçºŒè¶…è²·å¤©æ•¸**
```
æŸ¥è©¢æœ€è¿‘ 7 å¤© RSI:
SELECT calculation_date, rsi_14 
FROM technical_indicators 
WHERE stock_id = '2330' 
  AND calculation_date >= '2024-12-18'
  AND calculation_date <= '2024-12-24'
ORDER BY calculation_date DESC

è¨ˆç®—æŒçºŒå¤©æ•¸:
duration_days = 0
FOR EACH æ—¥æœŸï¼ˆå¾ä»Šæ—¥å¾€å‰ï¼‰:
  IF (rsi_14 > 70) THEN
    duration_days += 1
  ELSE
    BREAK  // ä¸­æ–·ï¼Œä¸å†è¨ˆç®—
  END IF
END FOR

çµæœ: duration_days = 3ï¼ˆé€£çºŒ 3 å¤©è¶…è²·ï¼‰
```

**æ­¥é©Ÿ 3: ç”¢ç”Ÿè¶…è²·ä¿¡è™Ÿ**
```
IF (rsi_14 > 70) THEN
  åˆ¤æ–·ä¿¡è™Ÿå¼·åº¦:
  IF (duration_days >= 5) THEN
    confidence_score = 75  // æŒçºŒ 5 å¤©ä»¥ä¸Šï¼Œåè½‰æ©Ÿç‡é«˜
    signal_strength = 'VERY_STRONG'
  ELSE IF (duration_days >= 3) THEN
    confidence_score = 70  // æŒçºŒ 3-4 å¤©
    signal_strength = 'STRONG'
  ELSE
    confidence_score = 60  // å‰›é€²å…¥è¶…è²·
    signal_strength = 'WEAK'
  END IF
  
  ä¿¡è™Ÿå…§å®¹:
  - signal_type = 'SELL'
  - signal_name = 'RSI_OVERBOUGHT'
  - signal_category = 'MOMENTUM_EXTREME'
  - confidence_score = 60-75ï¼ˆä¾æŒçºŒå¤©æ•¸ï¼‰
  - evidence_data = {
      indicator: 'RSI',
      rsi_value: 78.5,
      threshold: 70,
      duration_days: 3,
      signal_strength: 'STRONG'
    }
END IF
```

**RSI è¶…è³£åµæ¸¬**:
```
IF (rsi_14 < 30) THEN
  è¨ˆç®—æŒçºŒè¶…è³£å¤©æ•¸ï¼ˆåŒä¸Šé‚è¼¯ï¼‰
  
  ä¿¡è™Ÿå…§å®¹:
  - signal_type = 'BUY'
  - signal_name = 'RSI_OVERSOLD'
  - confidence_score = 60-75
END IF
```

---

**Stochastic KD è¶…è²·è¶…è³£åµæ¸¬**:
```
IF (K > 80 AND D > 80) THEN
  ä¿¡è™Ÿå…§å®¹:
  - signal_type = 'SELL'
  - signal_name = 'STOCH_OVERBOUGHT'
  - confidence_score = 65
  - evidence_data = {k: 85.2, d: 82.3}
END IF

IF (K < 20 AND D < 20) THEN
  ä¿¡è™Ÿå…§å®¹:
  - signal_type = 'BUY'
  - signal_name = 'STOCH_OVERSOLD'
  - confidence_score = 65
END IF
```

---

**Williams %R è¶…è²·è¶…è³£åµæ¸¬**:
```
IF (Williams %R > -20) THEN
  ä¿¡è™Ÿå…§å®¹:
  - signal_type = 'SELL'
  - signal_name = 'WILLR_OVERBOUGHT'
  - confidence_score = 60
END IF

IF (Williams %R < -80) THEN
  ä¿¡è™Ÿå…§å®¹:
  - signal_type = 'BUY'
  - signal_name = 'WILLR_OVERSOLD'
  - confidence_score = 60
END IF
```

---

### 7.4 æŒ‡æ¨™é©—è­‰é‚è¼¯

#### 7.4.1 ç¯„åœé©—è­‰

**RSI ç¯„åœé©—è­‰**:
```
IF (RSI < 0 OR RSI > 100) THEN
  é©—è­‰å¤±æ•—
  éŒ¯èª¤è¨Šæ¯: "RSI è¶…å‡ºç¯„åœ [0, 100]ï¼Œç•¶å‰å€¼: {RSI}"
  è™•ç†æ–¹å¼: æ¨™è¨˜ç‚ºè¨ˆç®—ç•°å¸¸ï¼Œä¸å„²å­˜è©²ç­†æŒ‡æ¨™
END IF
```

**Stochastic KD ç¯„åœé©—è­‰**:
```
IF (K < 0 OR K > 100 OR D < 0 OR D > 100) THEN
  é©—è­‰å¤±æ•—
  éŒ¯èª¤è¨Šæ¯: "KD è¶…å‡ºç¯„åœ [0, 100]"
  è™•ç†æ–¹å¼: æ¨™è¨˜ç‚ºè¨ˆç®—ç•°å¸¸
END IF
```

**Williams %R ç¯„åœé©—è­‰**:
```
IF (Williams %R < -100 OR Williams %R > 0) THEN
  é©—è­‰å¤±æ•—
  éŒ¯èª¤è¨Šæ¯: "Williams %R è¶…å‡ºç¯„åœ [-100, 0]"
END IF
```

**ADX ç¯„åœé©—è­‰**:
```
IF (ADX < 0 OR ADX > 100) THEN
  é©—è­‰å¤±æ•—
  éŒ¯èª¤è¨Šæ¯: "ADX è¶…å‡ºç¯„åœ [0, 100]"
END IF
```

---

#### 7.4.2 åˆç†æ€§é©—è­‰

**MA å€¼åˆç†æ€§æª¢æŸ¥**:
```
è¨ˆç®— MA èˆ‡æ”¶ç›¤åƒ¹çš„åé›¢åº¦:
deviation = ABS(MA - close_price) / close_price

IF (deviation > 0.2) THEN  // åé›¢è¶…é 20%
  è¨˜éŒ„è­¦å‘Š: "MA å€¼èˆ‡æ”¶ç›¤åƒ¹åé›¢éå¤§"
  è­¦å‘Šå…§å®¹: {
    ma_value: 580.5,
    close_price: 450.0,
    deviation: 0.29  // 29%
  }
  è™•ç†æ–¹å¼: è¨˜éŒ„è­¦å‘Šä½†ä»å„²å­˜è³‡æ–™ï¼ˆå¯èƒ½æ˜¯é•·æœŸå‡ç·šï¼‰
END IF
```

**Bollinger Bands åˆç†æ€§æª¢æŸ¥**:
```
IF (upper < middle OR lower > middle) THEN
  é©—è­‰å¤±æ•—
  éŒ¯èª¤è¨Šæ¯: "Bollinger Bands ä¸Šä¸‹è»Œé †åºéŒ¯èª¤"
  è™•ç†æ–¹å¼: ä¸å„²å­˜ï¼Œæ¨™è¨˜ç‚ºè¨ˆç®—éŒ¯èª¤
END IF

IF (upper - lower < 0) THEN
  é©—è­‰å¤±æ•—
  éŒ¯èª¤è¨Šæ¯: "Bollinger Bands å¯¬åº¦ç‚ºè² å€¼"
END IF

IF ((upper - lower) / middle > 0.5) THEN  // å¯¬åº¦è¶…éä¸­è»Œçš„ 50%
  è¨˜éŒ„è­¦å‘Š: "Bollinger Bands å¯¬åº¦ç•°å¸¸å¤§"
  è™•ç†æ–¹å¼: è¨˜éŒ„è­¦å‘Šä½†ä»å„²å­˜ï¼ˆå¯èƒ½æ˜¯é«˜æ³¢å‹•æœŸï¼‰
END IF
```

**MACD åˆç†æ€§æª¢æŸ¥**:
```
è¨ˆç®— MACD æŸ±ç‹€åœ–èˆ‡æ”¶ç›¤åƒ¹çš„æ¯”ä¾‹:
ratio = ABS(macd_histogram) / close_price

IF (ratio > 0.1) THEN  // æŸ±ç‹€åœ–è¶…éæ”¶ç›¤åƒ¹çš„ 10%
  è¨˜éŒ„è­¦å‘Š: "MACD æŸ±ç‹€åœ–ç•°å¸¸å¤§"
  è™•ç†æ–¹å¼: è¨˜éŒ„è­¦å‘Šä½†ä»å„²å­˜
END IF
```

---

#### 7.4.3 å®Œæ•´æ€§é©—è­‰

**JSONB æ¬„ä½å®Œæ•´æ€§**:
```
æª¢æŸ¥ trend_indicators:
IF (trend_indicators IS NULL OR trend_indicators = '{}') THEN
  è¨˜éŒ„è­¦å‘Š: "è¶¨å‹¢æŒ‡æ¨™ç‚ºç©º"
END IF

æª¢æŸ¥å¿…è¦æŒ‡æ¨™å­˜åœ¨:
required_indicators = ['ma', 'ema', 'macd']  // P0 åŸºç¤çµ„å¿…é ˆæœ‰

FOR EACH required IN required_indicators:
  IF (trend_indicators ä¸åŒ…å« required) THEN
    è¨˜éŒ„è­¦å‘Š: "ç¼ºå°‘å¿…è¦æŒ‡æ¨™: {required}"
  END IF
END FOR
```

**NaN å€¼è™•ç†**:
```
FOR EACH æŒ‡æ¨™å€¼ IN è¨ˆç®—çµæœ:
  IF (å€¼ IS NULL OR å€¼ = 'NaN' OR å€¼ = 'Infinity') THEN
    æª¢æŸ¥æ˜¯å¦ç‚ºè³‡æ–™ä¸è¶³æœŸé–“:
    IF (æ—¥æœŸ < ä¸Šå¸‚æ—¥æœŸ + min_data_points å¤©) THEN
      å…è¨± NaNï¼ˆæ¨™è¨˜ç‚º "è³‡æ–™ä¸è¶³æœŸé–“"ï¼‰
    ELSE
      é©—è­‰å¤±æ•—: "è¨ˆç®—ç•°å¸¸ï¼Œç”¢ç”Ÿ NaN"
      è™•ç†æ–¹å¼: è¨˜éŒ„åˆ° data_quality_issues è¡¨
    END IF
  END IF
END FOR
```

**é©—è­‰å¤±æ•—è™•ç†æµç¨‹**:
```
é©—è­‰å¤±æ•— â†’
  â”œâ”€ åš´é‡éŒ¯èª¤ï¼ˆç¯„åœéŒ¯èª¤ã€NaNï¼‰
  â”‚   â”œâ”€ ä¸å„²å­˜è©²ç­†æŒ‡æ¨™
  â”‚   â”œâ”€ è¨˜éŒ„åˆ° data_quality_issues è¡¨
  â”‚   â”œâ”€ åš´é‡åº¦: HIGH
  â”‚   â””â”€ è§¸ç™¼å‘Šè­¦ï¼ˆè‹¥é€£çºŒå¤±æ•—ï¼‰
  â”‚
  â””â”€ è¼•å¾®è­¦å‘Šï¼ˆåˆç†æ€§åé›¢ï¼‰
      â”œâ”€ å„²å­˜æŒ‡æ¨™è³‡æ–™
      â”œâ”€ è¨˜éŒ„è­¦å‘Šæ—¥èªŒ
      â””â”€ åš´é‡åº¦: LOW
```

---

### 7.5 æ‰¹æ¬¡è™•ç†é‚è¼¯

#### 7.5.1 æ‰¹æ¬¡å¤§å°æ±ºç­–

**æ±ºç­–ä¾æ“š**:
- è‚¡åƒ¹è³‡æ–™é‡ï¼ˆ250 å¤© Ã— è‚¡ç¥¨æ•¸ï¼‰
- pandas-ta è¨ˆç®—æ™‚é–“ï¼ˆå¹³å‡ 200ms/è‚¡ï¼‰
- è³‡æ–™åº«å¯«å…¥æ•ˆèƒ½ï¼ˆ100 ç­†/æ‰¹æ¬¡æœ€ä½³ï¼‰
- è¨˜æ†¶é«”ä½¿ç”¨é‡

**å»ºè­°æ‰¹æ¬¡å¤§å°**:
| è³‡æ–™é¡å‹ | æ‰¹æ¬¡å¤§å° | ç†ç”± |
|---------|---------|------|
| è‚¡åƒ¹æŸ¥è©¢ | 50 æª”è‚¡ç¥¨ | é¿å…å–®æ¬¡æŸ¥è©¢è³‡æ–™é‡éå¤§ |
| æŒ‡æ¨™è¨ˆç®— | 50 æª”è‚¡ç¥¨ | å¹³è¡¡è¨˜æ†¶é«”ä½¿ç”¨èˆ‡æ•ˆèƒ½ |
| è³‡æ–™åº« UPSERT | 100 ç­† | PostgreSQL UPSERT æœ€ä½³æ•ˆèƒ½ |
| Redis æ‰¹æ¬¡å¯«å…¥ | 100 ç­† | Pipeline æ‰¹æ¬¡æ“ä½œ |

---

#### 7.5.2 æ‰¹æ¬¡è™•ç†æµç¨‹

```
ç¸½è³‡æ–™é›†ï¼ˆ1800 æª”è‚¡ç¥¨ï¼‰
  â†“
è¼‰å…¥æŒ‡æ¨™å®šç¾©ï¼ˆP0 åŸºç¤çµ„ï¼‰
  â†“
åˆ†æ‰¹è™•ç†ï¼ˆbatch_size = 50ï¼‰
  â†“
æ‰¹æ¬¡ 1: è‚¡ç¥¨ 1-50
â”œâ”€ æŸ¥è©¢æ­·å²è‚¡åƒ¹ï¼ˆ250 å¤© Ã— 50 æª”ï¼‰
â”œâ”€ pandas-ta æ‰¹æ¬¡è¨ˆç®—
â”‚   â”œâ”€ è½‰æ›ç‚º DataFrame
â”‚   â”œâ”€ è¨ˆç®— MAã€EMAã€RSIã€KDã€MACDã€BBandsã€ATRã€OBVã€ADXã€VWAP
â”‚   â””â”€ è™•ç† NaN å€¼
â”œâ”€ é©—è­‰è¨ˆç®—çµæœ
â”‚   â”œâ”€ ç¯„åœé©—è­‰
â”‚   â”œâ”€ åˆç†æ€§é©—è­‰
â”‚   â””â”€ å®Œæ•´æ€§é©—è­‰
â”œâ”€ çµ„è£ JSONB è³‡æ–™
â”œâ”€ æ‰¹æ¬¡ UPSERTï¼ˆMyBatisï¼‰
â”‚   â””â”€ INSERT ... ON CONFLICT DO UPDATE
â”œâ”€ å›å¯« stock_pricesï¼ˆma5, ma20, volume_ma5ï¼‰
â””â”€ è¨˜éŒ„è™•ç†çµæœï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰
  â†“
æ‰¹æ¬¡ 2: è‚¡ç¥¨ 51-100
â”œâ”€ ï¼ˆåŒä¸Šï¼‰
â””â”€ ...
  â†“
...
  â†“
æ‰¹æ¬¡ 36: è‚¡ç¥¨ 1751-1800
â”œâ”€ ï¼ˆåŒä¸Šï¼‰
â””â”€ å®Œæˆ
  â†“
å½™ç¸½çµ±è¨ˆ
â”œâ”€ æˆåŠŸç­†æ•¸: 1785
â”œâ”€ å¤±æ•—ç­†æ•¸: 15
â”œâ”€ å¹³å‡è™•ç†æ™‚é–“: 245ms/è‚¡
â””â”€ è¨˜éŒ„åˆ° indicator_calculation_jobs è¡¨
```

**æ‰¹æ¬¡å¤±æ•—è™•ç†**:
```
IF æ‰¹æ¬¡è¨ˆç®—å¤±æ•—:
  â”œâ”€ è¨˜éŒ„å¤±æ•—çš„è‚¡ç¥¨æ¸…å–®
  â”œâ”€ ç¹¼çºŒè™•ç†ä¸‹ä¸€æ‰¹æ¬¡ï¼ˆä¸ä¸­æ–·æ•´é«”æµç¨‹ï¼‰
  â”œâ”€ Job çµæŸå¾Œçµ±è¨ˆå¤±æ•—ç­†æ•¸
  â””â”€ å¤±æ•—æ‰¹æ¬¡å¯å–®ç¨é‡è·‘
```

---

### 7.6 å¿«å–ç­–ç•¥

#### 7.6.1 å¿«å–éµè¨­è¨ˆ

**å–®æ—¥æŒ‡æ¨™è³‡æ–™**:
```
Key: tech:indicators:{stock_id}:{calculation_date}
ç¯„ä¾‹: tech:indicators:2330:2024-12-24
Value: TechnicalIndicator JSONï¼ˆå«æ‰€æœ‰ 8 é¡æŒ‡æ¨™ï¼‰
TTL: 6 å°æ™‚

çµæ§‹:
{
  "stock_id": "2330",
  "calculation_date": "2024-12-24",
  "trend": {"ma5": 580.5, "ma20": 570.8, ...},
  "momentum": {"rsi_14": 65.5, "stoch_k": 75.2, ...},
  "volatility": {"bbands_upper": 590.0, ...},
  "volume": {"obv": 125000000000, ...}
}
```

**å–®ä¸€æŒ‡æ¨™å–®æ—¥è³‡æ–™**:
```
Key: tech:indicator:{stock_id}:{indicator_name}:{calculation_date}
ç¯„ä¾‹: tech:indicator:2330:RSI:2024-12-24
Value: {"rsi_14": 65.5}
TTL: 6 å°æ™‚
```

**ç¯„åœæŸ¥è©¢**:
```
Key: tech:indicators:range:{stock_id}:{start_date}:{end_date}
ç¯„ä¾‹: tech:indicators:range:2330:2024-12-01:2024-12-24
Value: List<TechnicalIndicator> JSON
TTL: 12 å°æ™‚
```

**æŒ‡æ¨™é…ç½®**:
```
Key: tech:config:indicators
Value: List<IndicatorDefinition> JSONï¼ˆ71 å€‹æŒ‡æ¨™å®šç¾©ï¼‰
TTL: æ°¸ä¹…ï¼ˆæˆ– 7 å¤©ï¼‰
```

**ç†±é–€è‚¡ç¥¨æ¸…å–®**:
```
Key: tech:hot:stocks
Value: ["2330", "2317", "2454", ...]ï¼ˆå¸‚å€¼å‰ 50 æª”ï¼‰
TTL: 24 å°æ™‚
```

---

#### 7.6.2 TTL è¨­å®šç­–ç•¥

| è³‡æ–™é¡å‹ | TTL | ç†ç”± |
|---------|-----|------|
| ç†±é–€è‚¡ç¥¨æŒ‡æ¨™ï¼ˆå¸‚å€¼å‰ 50ï¼‰ | 1 å°æ™‚ | Job å®Œæˆå¾Œä¸»å‹•æ›´æ–° |
| ä¸€èˆ¬è‚¡ç¥¨æŒ‡æ¨™ï¼ˆç•¶æ—¥ï¼‰ | 6 å°æ™‚ | ç›¤å¾Œå¯èƒ½æœ‰ä¿®æ­£ |
| æ­·å²æŒ‡æ¨™ï¼ˆç¯„åœæŸ¥è©¢ï¼‰ | 12 å°æ™‚ | ä¸å¸¸è®Šå‹• |
| æŒ‡æ¨™å®šç¾©é…ç½® | æ°¸ä¹… | é…ç½®è®Šæ›´æ™‚ä¸»å‹•æ›´æ–° |
| ç†±é–€è‚¡ç¥¨æ¸…å–® | 24 å°æ™‚ | æ¯æ—¥æ›´æ–°ä¸€æ¬¡ |

---

#### 7.6.3 å¿«å–æ›´æ–°ç­–ç•¥

**Cache-Aside æ¨¡å¼**:
```
è®€å–æµç¨‹:
1. æŸ¥è©¢ Redis å¿«å–
   â”œâ”€ å‘½ä¸­ â†’ è¿”å›å¿«å–è³‡æ–™
   â””â”€ æœªå‘½ä¸­ â†’ æŸ¥è©¢ PostgreSQL
       â”œâ”€ æŸ¥è©¢æˆåŠŸ â†’ å¯«å…¥å¿«å– â†’ è¿”å›è³‡æ–™
       â””â”€ æŸ¥è©¢å¤±æ•— â†’ è¿”å›éŒ¯èª¤

å¯«å…¥æµç¨‹ï¼ˆæŒ‡æ¨™è¨ˆç®—å®Œæˆå¾Œï¼‰:
1. å¯«å…¥ PostgreSQL è³‡æ–™åº«ï¼ˆMyBatis UPSERTï¼‰
2. è‹¥ç‚ºç†±é–€è‚¡ç¥¨ â†’ ä¸»å‹•æ›´æ–°å¿«å–
3. æ¸…é™¤èˆŠå¿«å–éµï¼ˆè‹¥æ—¥æœŸç¯„åœè®Šæ›´ï¼‰
```

**å¿«å–é ç†±**:
```
ç³»çµ±å•Ÿå‹•æ™‚:
1. è¼‰å…¥æŒ‡æ¨™å®šç¾©é…ç½®
   Redis.set("tech:config:indicators", definitions, TTL=æ°¸ä¹…)

2. è¼‰å…¥ç†±é–€è‚¡ç¥¨æ¸…å–®ï¼ˆå¸‚å€¼å‰ 50ï¼‰
   Redis.set("tech:hot:stocks", hot_stocks, TTL=24h)

3. é è¼‰ç†±é–€è‚¡ç¥¨æœ€æ–°æŒ‡æ¨™
   FOR EACH hot_stock:
     latest_indicators = æŸ¥è©¢æœ€æ–°æŒ‡æ¨™
     Redis.set("tech:indicators:{stock_id}:{date}", indicators, TTL=1h)
   END FOR

Job å®Œæˆå¾Œï¼ˆJOB-M07-001ï¼‰:
1. æ›´æ–°ç†±é–€è‚¡ç¥¨å¿«å–ï¼ˆå¸‚å€¼å‰ 50ï¼‰
2. æ¸…é™¤éæœŸæ—¥æœŸçš„å¿«å–
```

**å¿«å–å¤±æ•ˆè§¸ç™¼æ™‚æ©Ÿ**:
```
æŒ‡æ¨™è¨ˆç®— Job å®Œæˆ â†’
  â”œâ”€ æ¸…é™¤ tech:indicators:{stock_id}:* ç›¸é—œå¿«å–ï¼ˆå—å½±éŸ¿è‚¡ç¥¨ï¼‰
  â”œâ”€ æ›´æ–°ç†±é–€è‚¡ç¥¨å¿«å–ï¼ˆä¸»å‹•æ›´æ–°ï¼‰
  â””â”€ æ¸…é™¤ç¯„åœæŸ¥è©¢å¿«å–ï¼ˆå«å—å½±éŸ¿æ—¥æœŸçš„ç¯„åœï¼‰

æŒ‡æ¨™å®šç¾©æ›´æ–° â†’
  â”œâ”€ æ¸…é™¤ tech:config:indicators
  â””â”€ é‡æ–°è¼‰å…¥æŒ‡æ¨™å®šç¾©
```

**å¿«å–ç©¿é€é˜²è­·**:
```
ä½¿ç”¨å¸ƒéš†éæ¿¾å™¨ï¼ˆBloom Filterï¼‰:
1. ç³»çµ±å•Ÿå‹•æ™‚ï¼Œå°‡æ‰€æœ‰æ´»èºè‚¡ç¥¨ ID åŠ å…¥å¸ƒéš†éæ¿¾å™¨
2. æŸ¥è©¢å‰å…ˆæª¢æŸ¥å¸ƒéš†éæ¿¾å™¨
   â”œâ”€ ä¸å­˜åœ¨ â†’ ç›´æ¥è¿”å› 404ï¼Œä¸æŸ¥è©¢è³‡æ–™åº«
   â””â”€ å¯èƒ½å­˜åœ¨ â†’ ç¹¼çºŒæŸ¥è©¢æµç¨‹

ç©ºå€¼å¿«å–:
IF (æŸ¥è©¢è³‡æ–™åº«å¾Œç™¼ç¾è³‡æ–™ä¸å­˜åœ¨) THEN
  å¿«å–ç©ºå€¼: Redis.set(key, "NULL", TTL=5åˆ†é˜)
  é¿å…é‡è¤‡æŸ¥è©¢è³‡æ–™åº«
END IF
```

**å¿«å–é›ªå´©é˜²è­·**:
```
TTL åŠ å…¥éš¨æ©Ÿå€¼:
base_ttl = 6 å°æ™‚
random_offset = RANDOM(-36åˆ†é˜, +36åˆ†é˜)
actual_ttl = base_ttl + random_offset

ç¯„ä¾‹:
å¿«å– 1: TTL = 5.4 å°æ™‚
å¿«å– 2: TTL = 6.3 å°æ™‚
å¿«å– 3: TTL = 6.6 å°æ™‚

é¿å…å¤§é‡å¿«å–åŒæ™‚å¤±æ•ˆ
```

---

## 8. æ•´åˆé»

### 8.1 å°å¤–éƒ¨ç³»çµ±çš„ä¾è³´

| å¤–éƒ¨ç³»çµ± | ç”¨é€” | å”è­° | èªè­‰æ–¹å¼ | é™åˆ¶ | å‚™æ´æ–¹æ¡ˆ |
|---------|------|------|---------|------|---------|
| M06 è³‡æ–™ç®¡ç†æ¨¡çµ„ | è‚¡åƒ¹æ­·å²è³‡æ–™ | REST API | Internal | ç„¡ | - |
| pandas-ta (Python) | æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å¼•æ“ | Python Library / REST API | ç„¡ | è¨ˆç®—æ•ˆèƒ½ | è‡ªè¡Œå¯¦ä½œ Java ç‰ˆæœ¬ |
| Redis | å¿«å– | Redis Protocol | ç„¡ | è¨˜æ†¶é«”å®¹é‡ | - |
| PostgreSQL | è³‡æ–™å„²å­˜ | JDBC | å¸³å¯† | é€£ç·šæ•¸ | - |

**pandas-ta æ•´åˆæ–¹å¼**:

**æ–¹æ¡ˆ 1: JPypeï¼ˆæ¨è–¦ï¼‰**
- ä½¿ç”¨ JPype å¾ Java å‘¼å« Python pandas-ta
- å„ªé»ï¼šç›´æ¥ä½¿ç”¨åŸç”Ÿ pandas-taï¼Œè¨ˆç®—æº–ç¢º
- ç¼ºé»ï¼šéœ€è¦å®‰è£ Python ç’°å¢ƒ

**æ–¹æ¡ˆ 2: REST API åŒ…è£**
- å»ºç«‹ç¨ç«‹çš„ Python å¾®æœå‹™ï¼Œæä¾› REST API
- å„ªé»ï¼šè§£è€¦åˆï¼Œæ˜“æ–¼æ“´å±•
- ç¼ºé»ï¼šå¢åŠ ç¶²è·¯å»¶é²

**æ–¹æ¡ˆ 3: Java åŸç”Ÿå¯¦ä½œ**
- ä½¿ç”¨ ta4j æˆ–è‡ªè¡Œå¯¦ä½œæŠ€è¡“æŒ‡æ¨™
- å„ªé»ï¼šç„¡å¤–éƒ¨ä¾è³´
- ç¼ºé»ï¼šé–‹ç™¼æˆæœ¬é«˜ï¼Œéœ€é©—è­‰æº–ç¢ºæ€§

---

### 8.2 å°å…§éƒ¨æ¨¡çµ„çš„æä¾›

| ä¸‹æ¸¸æ¨¡çµ„ | ä½¿ç”¨çš„ API | è³‡æ–™é¡å‹ | å‘¼å«é »ç‡ | å¿«å–ç­–ç•¥ |
|---------|-----------|---------|---------|---------|
| M13 ä¿¡è™Ÿåˆ¤æ–·å¼•æ“ | GET /stocks/{id}/indicators | æŠ€è¡“æŒ‡æ¨™ | ä¿¡è™Ÿåˆ¤æ–·æ™‚ | 6 å°æ™‚ TTL |
| M14 é¸è‚¡å¼•æ“ | GET /indicators/latest | æœ€æ–°æŒ‡æ¨™ | é¸è‚¡åŸ·è¡Œæ™‚ | 1 å°æ™‚ TTL |
| M16 å›æ¸¬ç³»çµ± | GET /stocks/{id}/indicators | æ­·å²æŒ‡æ¨™ | å›æ¸¬åŸ·è¡Œæ™‚ | 12 å°æ™‚ TTL |
| M17 é¢¨éšªç®¡ç† | GET /stocks/{id}/indicators/ATR | ATR æ³¢å‹•ç‡ | é¢¨éšªè¨ˆç®—æ™‚ | 6 å°æ™‚ TTL |
| M10 å‹æ…‹è¾¨è­˜ | GET /stocks/{id}/indicators | åƒ¹æ ¼èˆ‡æŒ‡æ¨™ | å‹æ…‹åˆ†ææ™‚ | 6 å°æ™‚ TTL |

---

### 8.3 äº‹ä»¶ç™¼å¸ƒ

**ç™¼å¸ƒçš„äº‹ä»¶**ï¼ˆéµå®ˆç¸½ç¶±äº‹ä»¶è¦ç¯„ï¼‰:

| äº‹ä»¶åç¨± | è§¸ç™¼æ¢ä»¶ | äº‹ä»¶å…§å®¹ | è¨‚é–±è€… | ç”¨é€” |
|---------|---------|---------|-------|------|
| BasicIndicatorsCalculated | åŸºç¤æŒ‡æ¨™è¨ˆç®—å®Œæˆ | calculation_date, stock_count, indicators | M13, M14 | è§¸ç™¼ä¿¡è™Ÿåˆ¤æ–·ã€é¸è‚¡ |
| TechnicalSignalDetected | åµæ¸¬åˆ°æŠ€è¡“ä¿¡è™Ÿ | signal_uuid, stock_id, signal_type, signal_name | M13 | ä¿¡è™Ÿåˆ¤æ–·å¼•æ“è™•ç† |
| IndicatorCalculationFailed | æŒ‡æ¨™è¨ˆç®—å¤±æ•— | stock_id, failed_indicators, error_message | M15 ç›£æ§ç³»çµ± | è§¸ç™¼å‘Šè­¦ |

**äº‹ä»¶æ ¼å¼ç¯„ä¾‹**:

**BasicIndicatorsCalculated**:
```json
{
  "event_id": "evt_abc123",
  "event_type": "BasicIndicatorsCalculated",
  "event_time": "2024-12-24T16:00:00+08:00",
  "source": "M07",
  "version": "1.0",
  "data": {
    "calculation_date": "2024-12-24",
    "total_stocks": 1800,
    "success_count": 1785,
    "failed_count": 15,
    "indicators": ["MA", "EMA", "MACD", "RSI", "KD", "BBANDS", "ATR", "OBV", "VOLUME_MA", "ADX", "VWAP"],
    "job_id": 12345
  }
}
```

**TechnicalSignalDetected**:
```json
{
  "event_id": "evt_def456",
  "event_type": "TechnicalSignalDetected",
  "event_time": "2024-12-24T16:35:00+08:00",
  "source": "M07",
  "version": "1.0",
  "data": {
    "signal_uuid": "550e8400-e29b-41d4-a716-446655440000",
    "stock_id": "2330",
    "stock_name": "å°ç©é›»",
    "signal_type": "BUY",
    "signal_name": "MA_GOLDEN_CROSS",
    "signal_category": "TREND_CROSS",
    "trigger_price": 580.00,
    "confidence_score": 70,
    "evidence": {
      "indicator": "MA",
      "short_period": 5,
      "long_period": 20,
      "today_ma5": 580.50,
      "today_ma20": 570.80,
      "yesterday_ma5": 568.20,
      "yesterday_ma20": 570.50
    }
  }
}
```

---

### 8.4 å°ä¸Šæ¸¸æ¨¡çµ„çš„ä¾è³´

**M06 è³‡æ–™ç®¡ç†æ¨¡çµ„**:

**è¨‚é–±çš„äº‹ä»¶**:
| äº‹ä»¶åç¨± | ç”¨é€” | è™•ç†æ–¹å¼ |
|---------|------|---------|
| StockPriceUpdated | è§¸ç™¼æŒ‡æ¨™è¨ˆç®— | å»¶é² 30 åˆ†é˜å¾Œè§¸ç™¼ JOB-M07-001 |
| StockListUpdated | æ›´æ–°è‚¡ç¥¨æ¸…å–® | é‡æ–°è¼‰å…¥æ´»èºè‚¡ç¥¨æ¸…å–® |

**å‘¼å«çš„ API**:
| API | ç”¨é€” | å¿«å– |
|-----|------|------|
| GET /stocks/{id}/prices | æŸ¥è©¢æ­·å²è‚¡åƒ¹ | 6 å°æ™‚ TTL |
| GET /stocks | æŸ¥è©¢è‚¡ç¥¨æ¸…å–® | 24 å°æ™‚ TTL |
| GET /trading-calendar/{year} | æŸ¥è©¢äº¤æ˜“æ—¥æ›† | 7 å¤© TTL |

---

## 9. æ•ˆèƒ½è€ƒé‡

### 9.1 æ•ˆèƒ½ç›®æ¨™

| æŒ‡æ¨™ | ç›®æ¨™å€¼ | æ¸¬é‡æ–¹å¼ | èªªæ˜ |
|-----|-------|---------|------|
| API å›æ‡‰æ™‚é–“ï¼ˆå–®ä¸€è‚¡ç¥¨ï¼‰ | P95 < 150ms | APM ç›£æ§ | å«å¿«å–å‘½ä¸­ |
| API å›æ‡‰æ™‚é–“ï¼ˆæ‰¹æ¬¡æŸ¥è©¢ï¼‰ | P95 < 500ms | APM ç›£æ§ | 50 æª”è‚¡ç¥¨ |
| åŸºç¤æŒ‡æ¨™è¨ˆç®— Job åŸ·è¡Œæ™‚é–“ | < 20 åˆ†é˜ | Job åŸ·è¡Œè¨˜éŒ„ | 1800 æª”è‚¡ç¥¨ï¼Œ11 å€‹æŒ‡æ¨™ |
| é€²éšæŒ‡æ¨™è¨ˆç®— Job åŸ·è¡Œæ™‚é–“ | < 25 åˆ†é˜ | Job åŸ·è¡Œè¨˜éŒ„ | 1800 æª”è‚¡ç¥¨ï¼Œ20 å€‹æŒ‡æ¨™ |
| å¿«å–å‘½ä¸­ç‡ | > 85% | Redis çµ±è¨ˆ | ç†±é–€è‚¡ç¥¨ |
| è³‡æ–™åº«æŸ¥è©¢æ™‚é–“ | < 80ms | æ…¢æŸ¥è©¢æ—¥èªŒ | å–®è¡¨æŸ¥è©¢ï¼Œæœ‰ç´¢å¼• |
| JSONB æŸ¥è©¢æ™‚é–“ | < 120ms | æ…¢æŸ¥è©¢æ—¥èªŒ | ä½¿ç”¨ GIN ç´¢å¼• |
| å–®æª”è‚¡ç¥¨æŒ‡æ¨™è¨ˆç®—æ™‚é–“ | < 250ms | è¨ˆç®—å¼•æ“çµ±è¨ˆ | pandas-ta è¨ˆç®— |

---

### 9.2 æ•ˆèƒ½å„ªåŒ–ç­–ç•¥

#### 9.2.1 è³‡æ–™åº«å„ªåŒ–

**ç´¢å¼•å„ªåŒ–**:
- æ‰€æœ‰å¸¸ç”¨æŸ¥è©¢æ¬„ä½éƒ½å»ºç«‹ç´¢å¼•
- GIN ç´¢å¼•åŠ é€Ÿ JSONB æŸ¥è©¢
- è¤‡åˆç´¢å¼•é †åºï¼š(stock_id, calculation_date)
- å®šæœŸåŸ·è¡Œ `ANALYZE` æ›´æ–°çµ±è¨ˆè³‡è¨Š

**æŸ¥è©¢å„ªåŒ–**:
```sql
-- ä¸è‰¯ç¯„ä¾‹ï¼šå¾ªç’°æŸ¥è©¢
FOR EACH stock IN stock_list:
    SELECT * FROM technical_indicators WHERE stock_id = stock;
END FOR

-- è‰¯å¥½ç¯„ä¾‹ï¼šæ‰¹æ¬¡æŸ¥è©¢
SELECT * FROM technical_indicators 
WHERE stock_id IN ('2330', '2317', '2454', ...)
  AND calculation_date = '2024-12-24';
```

**JSONB æŸ¥è©¢å„ªåŒ–**:
```sql
-- ä½¿ç”¨ GIN ç´¢å¼•åŠ é€Ÿ
SELECT * FROM technical_indicators 
WHERE trend_indicators ? 'ma'  -- æª¢æŸ¥éµå­˜åœ¨
  AND (trend_indicators->'ma'->>'ma5')::numeric > 100;

-- ä½¿ç”¨å†—é¤˜æ¬„ä½åŠ é€Ÿå¸¸ç”¨æŸ¥è©¢
SELECT * FROM technical_indicators 
WHERE ma5 > 100  -- ç›´æ¥æŸ¥è©¢å†—é¤˜æ¬„ä½ï¼Œæ›´å¿«
  AND calculation_date = '2024-12-24';
```

**åˆ†å€å„ªåŒ–**:
- technical_indicators è¡¨æŒ‰å¹´ä»½åˆ†å€
- æŸ¥è©¢æ™‚è‡ªå‹•è£å‰ªä¸ç›¸é—œåˆ†å€
- ç¯„ä¾‹ï¼šæŸ¥è©¢ 2024 å¹´è³‡æ–™ï¼Œåªæƒæ technical_indicators_2024 åˆ†å€

---

#### 9.2.2 è¨ˆç®—å¼•æ“å„ªåŒ–

**æ‰¹æ¬¡è¨ˆç®—**:
- ä½¿ç”¨æ‰¹æ¬¡è™•ç†ï¼ˆbatch_size = 50ï¼‰
- æ¸›å°‘è³‡æ–™åº«é€£ç·šæ¬¡æ•¸
- ä½¿ç”¨ pandas-ta çš„æ‰¹æ¬¡è¨ˆç®—åŠŸèƒ½

**å¹³è¡Œè¨ˆç®—**:
- ä½¿ç”¨åŸ·è¡Œç·’æ± ï¼ˆThreadPoolExecutorï¼‰
- åŸ·è¡Œç·’æ± å¤§å°ï¼šCPU æ ¸å¿ƒæ•¸ Ã— 2
- æ¯å€‹åŸ·è¡Œç·’è™•ç†ä¸€æ‰¹è‚¡ç¥¨ï¼ˆbatch_size = 50ï¼‰

**çµæœå¿«å–**:
- è¨ˆç®—çµæœç«‹å³å¿«å–è‡³ Redis
- æ‰¹æ¬¡å¯«å…¥è³‡æ–™åº«ï¼ˆæ¸›å°‘ I/Oï¼‰

---

#### 9.2.3 å¿«å–å„ªåŒ–

**å¤šå±¤å¿«å–æ¶æ§‹**:
```
è«‹æ±‚ 
  â†“
æœ¬åœ°å¿«å–ï¼ˆCaffeineï¼ŒTTL 5 åˆ†é˜ï¼‰
  â†“ æœªå‘½ä¸­
Redisï¼ˆL1 å¿«å–ï¼Œç†±è³‡æ–™ï¼ŒTTL 1-6 å°æ™‚ï¼‰
  â†“ æœªå‘½ä¸­
PostgreSQLï¼ˆè³‡æ–™åº«ï¼‰
  â†“
è¿”å›è³‡æ–™ä¸¦å¯«å…¥å¿«å–
```

**å¿«å–é ç†±**:
- ç³»çµ±å•Ÿå‹•æ™‚é è¼‰ç†±é–€è‚¡ç¥¨ï¼ˆå¸‚å€¼å‰ 50ï¼‰æœ€æ–°æŒ‡æ¨™
- Job å®Œæˆå¾Œæ‰¹æ¬¡æ›´æ–°å¿«å–

**å¿«å–å¤±æ•ˆç­–ç•¥**:
- æ–°æŒ‡æ¨™è¨ˆç®—å®Œæˆå¾Œä¸»å‹•æ›´æ–°å¿«å–
- TTL éæœŸè‡ªå‹•æ¸…é™¤

---

### 9.3 å®¹é‡è¦åŠƒ

#### 9.3.1 è³‡æ–™é‡ä¼°ç®—

**technical_indicators è¡¨**:
```
æ¯æª”è‚¡ç¥¨æ¯æ—¥ 1 ç­†è¨˜éŒ„
å°è‚¡ç´„ 1800 æª”è‚¡ç¥¨
æ¯å¹´ç´„ 250 å€‹äº¤æ˜“æ—¥

å¹´åº¦è³‡æ–™é‡ = 1800 Ã— 250 = 450,000 ç­†/å¹´
10 å¹´è³‡æ–™é‡ = 4,500,000 ç­†

å–®ç­†è¨˜éŒ„å¤§å°ä¼°ç®—:
- å›ºå®šæ¬„ä½: ~200 bytes
- JSONB æ¬„ä½ (trend_indicators): ~2 KB
- JSONB æ¬„ä½ (momentum_indicators): ~1.5 KB
- JSONB æ¬„ä½ (volatility_indicators): ~1 KB
- JSONB æ¬„ä½ (volume_indicators): ~1 KB
- å†—é¤˜æ¬„ä½ + å…¶ä»–: ~500 bytes
å–®ç­† â‰ˆ 6 KB

å¹´åº¦å„²å­˜ç©ºé–“ = 450,000 Ã— 6 KB â‰ˆ 2.7 GB
10 å¹´å„²å­˜ç©ºé–“ â‰ˆ 27 GB
```

**Redis å¿«å–å®¹é‡**:
```
ç†±é–€è‚¡ç¥¨ï¼ˆ50 æª”ï¼‰æœ€æ–°æŒ‡æ¨™å¿«å–:
50 æª” Ã— 6 KB â‰ˆ 300 KB

ä¸€èˆ¬å¿«å–ï¼ˆLRUï¼Œæœ€å¤š 500 æª”è‚¡ç¥¨ Ã— 30 å¤©ï¼‰:
500 Ã— 30 Ã— 6 KB â‰ˆ 90 MB

ç¸½ Redis å®¹é‡éœ€æ±‚: ~100 MB
å»ºè­°é…ç½®: 512 MBï¼ˆç•™æœ‰å……è¶³é¤˜è£•ï¼‰
```

---

## 10. æ¸¬è©¦æº–å‰‡

### 10.1 å–®å…ƒæ¸¬è©¦

**æ¸¬è©¦å ´æ™¯**:

**IndicatorCalculationService æ¸¬è©¦**:
```
æ¸¬è©¦: è¨ˆç®— MA æŒ‡æ¨™
Given: å°ç©é›» 250 å€‹äº¤æ˜“æ—¥è‚¡åƒ¹è³‡æ–™
When: å‘¼å« calculateMA(stockId="2330", periods=[5, 20, 60])
Then: 
  - è¿”å› MA5, MA20, MA60 å€¼
  - MA5 å€¼ç­‰æ–¼æœ€è¿‘ 5 æ—¥æ”¶ç›¤åƒ¹å¹³å‡
  - èª¤å·® < 0.01%

æ¸¬è©¦: è³‡æ–™ä¸è¶³è™•ç†
Given: å°ç©é›»åªæœ‰ 10 å€‹äº¤æ˜“æ—¥è‚¡åƒ¹è³‡æ–™
When: å‘¼å« calculateMA(stockId="2330", periods=[5, 20, 60])
Then:
  - MA5 æœ‰å€¼ï¼ˆè³‡æ–™å……è¶³ï¼‰
  - MA20 ç‚º NaNï¼ˆè³‡æ–™ä¸è¶³ï¼‰
  - ä¸æ‹‹å‡ºç•°å¸¸
```

**SignalDetectionService æ¸¬è©¦**:
```
æ¸¬è©¦: é»ƒé‡‘äº¤å‰åµæ¸¬
Given: 
  - æ˜¨æ—¥ MA5=98, MA20=100
  - ä»Šæ—¥ MA5=101, MA20=100
When: å‘¼å« detectCrossSignals(stockId="2330", date="2024-12-24")
Then:
  - ç”¢ç”Ÿ BUY ä¿¡è™Ÿ
  - signal_name = 'MA_GOLDEN_CROSS'
  - confidence_score = 70
```

---

### 10.2 æ•´åˆæ¸¬è©¦

**å®Œæ•´æŒ‡æ¨™è¨ˆç®—æµç¨‹æ¸¬è©¦**:
```
æ¸¬è©¦: ç«¯åˆ°ç«¯æŒ‡æ¨™è¨ˆç®—
Given: 
  - stock_prices è¡¨æœ‰å°ç©é›»æœ€æ–° 250 å¤©è‚¡åƒ¹è³‡æ–™
  - indicator_definitions è¡¨æœ‰åŸºç¤æŒ‡æ¨™å®šç¾©
When: 
  - è§¸ç™¼ JOB-M07-001ï¼ˆåŸºç¤æŒ‡æ¨™è¨ˆç®—ï¼‰
Then:
  - Job ç‹€æ…‹è®Šç‚º RUNNING
  - technical_indicators è¡¨æ–°å¢å°ç©é›»æŒ‡æ¨™è¨˜éŒ„
  - Redis å¿«å–è¢«æ›´æ–°
  - Job ç‹€æ…‹è®Šç‚º SUCCESS
```

---

### 10.3 æ•ˆèƒ½æ¸¬è©¦

**è² è¼‰æ¸¬è©¦**:
```
æ¸¬è©¦: API ä¸¦ç™¼æŸ¥è©¢
å ´æ™¯: 100 å€‹ä¸¦ç™¼è«‹æ±‚æŸ¥è©¢ä¸åŒè‚¡ç¥¨çš„æœ€æ–°æŒ‡æ¨™
é æœŸ:
  - P95 å›æ‡‰æ™‚é–“ < 150ms
  - éŒ¯èª¤ç‡ < 0.1%
  - å¿«å–å‘½ä¸­ç‡ > 85%
```

---

### 10.4 æ¸¬è©¦è¦†è“‹ç‡ç›®æ¨™

| å±¤ç´š | è¦†è“‹ç‡ç›®æ¨™ | æ¸¬è©¦å·¥å…· |
|-----|----------|---------|
| Repository (JPA) | > 90% | JUnit 5, Spring Boot Test |
| Mapper (MyBatis) | > 85% | MyBatis Test |
| Service | > 80% | JUnit 5, Mockito |
| Controller | > 70% | MockMvc, RestAssured |
| æ•´é«”å°ˆæ¡ˆ | > 75% | JaCoCo |

---

## é™„éŒ„

### A. æŒ‡æ¨™è¨ˆç®—å…¬å¼åƒè€ƒ

**MA (Simple Moving Average)**:
```
MA(n) = Î£(Close_i) / n
å…¶ä¸­ i = 0 to n-1ï¼ˆæœ€è¿‘ n å¤©ï¼‰
```

**RSI (Relative Strength Index)**:
```
RS = å¹³å‡æ¼²å¹… / å¹³å‡è·Œå¹…
RSI = 100 - [100 / (1 + RS)]
```

---

### B. pandas-ta å‡½æ•¸å°æ‡‰è¡¨

| æŒ‡æ¨™ | pandas-ta å‡½æ•¸ | åƒæ•¸ |
|-----|---------------|------|
| MA | df.ta.sma(length=20) | length |
| EMA | df.ta.ema(length=12) | length |
| MACD | df.ta.macd(fast=12, slow=26, signal=9) | fast, slow, signal |
| RSI | df.ta.rsi(length=14) | length |
| Stochastic | df.ta.stoch(k=9, d=3, smooth_k=3) | k, d, smooth_k |
| Bollinger Bands | df.ta.bbands(length=20, std=2) | length, std |
| ATR | df.ta.atr(length=14) | length |

---

### C. è®Šæ›´æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹è€… | ä¿®æ”¹å…§å®¹ |
|-----|------|-------|---------|
| v1.0 | 2025-12-22 | [å¾…å¡«å¯«] | åˆå§‹ç‰ˆæœ¬ï¼ˆæ¦‚å¿µè¨­è¨ˆï¼‰ |
| v2.0 | 2025-12-27 | [å¾…å¡«å¯«] | å‡ç´šè‡³ PostgreSQL + JPA + MyBatisï¼Œæ•´åˆ pandas-ta è¨ˆç®—å¼•æ“ï¼Œæ–°å¢ 71 å€‹æŠ€è¡“æŒ‡æ¨™ï¼Œæ–°å¢ä¿¡è™Ÿåµæ¸¬åŠŸèƒ½ |

---

### D. å¾…è¾¦äº‹é …

- [ ] å®Œæˆ pandas-ta æ•´åˆæ–¹æ¡ˆé¸å‹ï¼ˆJPype vs REST APIï¼‰
- [ ] å¯¦ä½œ pandas-ta Python å¾®æœå‹™ï¼ˆè‹¥æ¡ç”¨ REST API æ–¹æ¡ˆï¼‰
- [ ] å»ºç«‹æ•ˆèƒ½æ¸¬è©¦åŸºæº–ï¼ˆå–®è‚¡è¨ˆç®—æ™‚é–“ã€æ‰¹æ¬¡è™•ç†æ™‚é–“ï¼‰
- [ ] è£œå……é€²éšæŒ‡æ¨™è¨ˆç®—å…¬å¼ï¼ˆP2 å°ˆæ¥­çµ„ 40 å€‹æŒ‡æ¨™ï¼‰
- [ ] æ’°å¯«ä¿¡è™Ÿåµæ¸¬æ¼”ç®—æ³•è©³ç´°æ–‡ä»¶ï¼ˆèƒŒé›¢åµæ¸¬é‚è¼¯ï¼‰
- [ ] å»ºç«‹ç›£æ§å„€è¡¨æ¿ï¼ˆGrafanaï¼‰
- [ ] å®Œæˆ 71 å€‹æŒ‡æ¨™çš„å–®å…ƒæ¸¬è©¦
- [ ] æ’°å¯«æŒ‡æ¨™è¨ˆç®—æº–ç¢ºæ€§é©—è­‰è…³æœ¬


## æ–‡ä»¶çµæŸ

**æ–‡ä»¶ç·¨è™Ÿ**: DOC-02-M07  
**ç‰ˆæœ¬**: v2.0  
**å»ºç«‹æ—¥æœŸ**: 2025-12-27  
**æœ€å¾Œæ›´æ–°**: 2025-12-27  
**æ–‡ä»¶ç‹€æ…‹**: Draft  

---

**ä¸‹ä¸€æ­¥è¡Œå‹•**:
1. Review æœ¬æ–‡ä»¶ï¼ˆåœ˜éšŠå¯©æ ¸ï¼‰
2. å»ºç«‹è³‡æ–™åº« Schemaï¼ˆåŸ·è¡Œ DDLï¼‰
3. å¯¦ä½œæ ¸å¿ƒ Serviceï¼ˆIndicatorCalculationServiceï¼‰
4. æ•´åˆ pandas-ta è¨ˆç®—å¼•æ“
5. å¯¦ä½œ API Controller
6. æ’°å¯«å–®å…ƒæ¸¬è©¦
7. æ•´åˆæ¸¬è©¦èˆ‡æ•ˆèƒ½æ¸¬è©¦


