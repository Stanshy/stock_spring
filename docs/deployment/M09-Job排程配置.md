# M09-ç±Œç¢¼åˆ†ææ¨¡çµ„ Job æ’ç¨‹é…ç½®

> **æ–‡ä»¶ç·¨è™Ÿ**: JOB-M09
> **æ¨¡çµ„åç¨±**: ç±Œç¢¼åˆ†ææ¨¡çµ„
> **ç‰ˆæœ¬**: v1.0
> **æœ€å¾Œæ›´æ–°**: 2026-01-11
> **ç‹€æ…‹**: Draft

---

## ğŸ“‹ Job æ’ç¨‹ç¸½è¦½

æœ¬æ–‡ä»¶å®šç¾©ç±Œç¢¼åˆ†ææ¨¡çµ„çš„æ‰€æœ‰æ‰¹æ¬¡ä½œæ¥­èˆ‡æ’ç¨‹é…ç½®ã€‚

---

## 1. Job æ¸…å–®

| Job ç·¨è™Ÿ | Job åç¨± | Job é¡å‹ | åŸ·è¡Œé »ç‡ | åŸ·è¡Œæ™‚é–“ | å„ªå…ˆç´š | é ä¼°æ™‚é•· |
|---------|---------|---------|---------|---------|-------|---------|
| JOB-M09-001 | CALC_CHIP_ANALYSIS | ANALYSIS | æ¯äº¤æ˜“æ—¥ | 16:00 | P0 | 5-8 åˆ†é˜ |
| JOB-M09-002 | UPDATE_CHIP_RANKINGS | CACHE | æ¯äº¤æ˜“æ—¥ | 16:10 | P0 | 2-3 åˆ†é˜ |
| JOB-M09-003 | SCAN_CHIP_SIGNALS | ANALYSIS | æ¯äº¤æ˜“æ—¥ | 16:15 | P0 | 3-5 åˆ†é˜ |
| JOB-M09-004 | CALC_COST_ESTIMATION | ANALYSIS | æ¯é€±ä¸€ | 08:00 | P2 | 10 åˆ†é˜ |
| JOB-M09-005 | CLEANUP_OLD_RESULTS | MAINTENANCE | æ¯æœˆ | æ¯æœˆ1æ—¥ 03:00 | P2 | 5 åˆ†é˜ |
| JOB-M09-006 | REFRESH_RANKINGS_CACHE | CACHE | æ¯30åˆ†é˜ | ç›¤ä¸­ | P1 | 1 åˆ†é˜ |

---

## 2. Job è©³ç´°è¨­è¨ˆ

### JOB-M09-001: æ¯æ—¥ç±Œç¢¼åˆ†ææ‰¹æ¬¡è¨ˆç®—

**Cron è¡¨é”å¼**: `0 0 16 * * MON-FRI`ï¼ˆé€±ä¸€åˆ°é€±äº” 16:00ï¼‰

**åŸ·è¡Œé‚è¼¯**:
1. æª¢æŸ¥ç•¶æ—¥æ˜¯å¦ç‚ºäº¤æ˜“æ—¥
2. ç¢ºèª M06 è³‡æ–™åŒæ­¥å®Œæˆï¼ˆinstitutional_tradingã€margin_tradingï¼‰
3. å–å¾—æ‰€æœ‰æ´»èºè‚¡ç¥¨æ¸…å–®
4. åˆ†æ‰¹åŸ·è¡Œç±Œç¢¼è¨ˆç®—å¼•æ“
5. æ‰¹æ¬¡ UPSERT è¨ˆç®—çµæœè‡³ chip_analysis_results
6. è¨˜éŒ„ Job åŸ·è¡Œçµæœ

**å‰ç½®æ¢ä»¶**:
- JOB-M06-002 (ä¸‰å¤§æ³•äººåŒæ­¥) å®Œæˆ
- JOB-M06-003 (èè³‡èåˆ¸åŒæ­¥) å®Œæˆ

**åƒæ•¸**:
```json
{
  "job_name": "CALC_CHIP_ANALYSIS",
  "trade_date": "2024-12-24",
  "stock_ids": null,
  "force_recalculate": false,
  "batch_size": 50,
  "calculation_plan": {
    "include_institutional": true,
    "include_margin": true,
    "include_concentration": true,
    "include_cost": false,
    "include_signals": true,
    "lookback_period": 60
  }
}
```

**é æœŸåŸ·è¡Œæ™‚é•·**: 5-8 åˆ†é˜ï¼ˆ1800 æª”è‚¡ç¥¨ï¼‰

**å†ªç­‰æ€§è¨­è¨ˆ**:
- ä½¿ç”¨ PostgreSQL `ON CONFLICT (stock_id, trade_date) DO UPDATE`
- é‡è¤‡åŸ·è¡Œæœƒè¦†è“‹ç•¶æ—¥çµæœ

**å¤±æ•—è™•ç†**:
- å–®ä¸€è‚¡ç¥¨è¨ˆç®—å¤±æ•—ä¸å½±éŸ¿å…¶ä»–è‚¡ç¥¨ï¼ˆcontinue on errorï¼‰
- è¨˜éŒ„å¤±æ•—è‚¡ç¥¨æ¸…å–®åˆ° job_execution_details
- å¤±æ•—ç‡ > 10% è§¸ç™¼å‘Šè­¦

---

### JOB-M09-002: æ›´æ–°ç±Œç¢¼æ’è¡Œæ¦œ

**Cron è¡¨é”å¼**: `0 10 16 * * MON-FRI`ï¼ˆé€±ä¸€åˆ°é€±äº” 16:10ï¼‰

**å‰ç½®æ¢ä»¶**: JOB-M09-001 å®Œæˆ

**åŸ·è¡Œé‚è¼¯**:
1. è¨ˆç®—å„é¡ç±Œç¢¼æ’è¡Œæ¦œ
   - å¤–è³‡è²·è¶…/è³£è¶…æ’è¡Œ
   - æŠ•ä¿¡è²·è¶…/è³£è¶…æ’è¡Œ
   - èè³‡å¢æ¸›æ’è¡Œ
   - é€£çºŒè²·è¶…å¤©æ•¸æ’è¡Œ
   - ä¸‰å¤§æ³•äººåˆè¨ˆæ’è¡Œ
2. å„²å­˜è‡³ chip_rankings_cache
3. æ›´æ–° Redis å¿«å–

**åƒæ•¸**:
```json
{
  "job_name": "UPDATE_CHIP_RANKINGS",
  "trade_date": "2024-12-24",
  "rank_types": [
    "foreign_buy", "foreign_sell",
    "trust_buy", "trust_sell",
    "margin_increase", "margin_decrease",
    "foreign_continuous", "total_institutional"
  ],
  "market_types": ["TWSE", "OTC", "ALL"],
  "limit_per_rank": 50,
  "cache_ttl_minutes": 30
}
```

**é æœŸåŸ·è¡Œæ™‚é•·**: 2-3 åˆ†é˜

---

### JOB-M09-003: å…¨å¸‚å ´ç•°å¸¸è¨Šè™Ÿæƒæ

**Cron è¡¨é”å¼**: `0 15 16 * * MON-FRI`ï¼ˆé€±ä¸€åˆ°é€±äº” 16:15ï¼‰

**å‰ç½®æ¢ä»¶**: JOB-M09-001 å®Œæˆ

**åŸ·è¡Œé‚è¼¯**:
1. å¾ chip_analysis_results å–å¾—ç•¶æ—¥è¨ˆç®—çµæœ
2. åŸ·è¡Œç•°å¸¸è¨Šè™Ÿåµæ¸¬è¦å‰‡
3. ç”¢ç”Ÿè¨Šè™Ÿè¨˜éŒ„å„²å­˜è‡³ chip_signals
4. é«˜åš´é‡åº¦è¨Šè™Ÿè§¸ç™¼å‘Šè­¦

**åƒæ•¸**:
```json
{
  "job_name": "SCAN_CHIP_SIGNALS",
  "trade_date": "2024-12-24",
  "signal_rules": [
    "CHIP_SIG_001", "CHIP_SIG_002", "CHIP_SIG_003",
    "CHIP_SIG_007", "CHIP_SIG_008", "CHIP_SIG_009",
    "CHIP_SIG_010", "CHIP_SIG_012", "CHIP_SIG_013"
  ],
  "lookback_days": 20,
  "z_score_threshold": 2.0
}
```

**é æœŸåŸ·è¡Œæ™‚é•·**: 3-5 åˆ†é˜

**å‘Šè­¦è¦å‰‡**:

| è¨Šè™Ÿåš´é‡åº¦ | å‘Šè­¦æ–¹å¼ | èªªæ˜ |
|-----------|---------|------|
| CRITICAL | Email + Slack | ç«‹å³é€šçŸ¥ |
| HIGH | Slack | åŒ¯ç¸½é€šçŸ¥ |
| MEDIUM | è¨˜éŒ„ | åƒ…è¨˜éŒ„ |
| LOW | è¨˜éŒ„ | åƒ…è¨˜éŒ„ |

---

### JOB-M09-004: ä¸»åŠ›æˆæœ¬ä¼°ç®—

**Cron è¡¨é”å¼**: `0 0 8 * * MON`ï¼ˆæ¯é€±ä¸€ 08:00ï¼‰

**åŸ·è¡Œé‚è¼¯**:
1. å–å¾—æ‰€æœ‰æ´»èºè‚¡ç¥¨
2. å°æ¯æª”è‚¡ç¥¨è¨ˆç®—ä¸»åŠ›æˆæœ¬ä¼°ç®—
3. å„²å­˜è‡³ chip_cost_estimation

**åƒæ•¸**:
```json
{
  "job_name": "CALC_COST_ESTIMATION",
  "estimation_date": "2024-12-24",
  "lookback_days": 120,
  "calculation_method": "WEIGHTED_AVERAGE"
}
```

**é æœŸåŸ·è¡Œæ™‚é•·**: 10 åˆ†é˜

---

### JOB-M09-005: æ¸…ç†èˆŠç±Œç¢¼åˆ†æçµæœ

**Cron è¡¨é”å¼**: `0 0 3 1 * *`ï¼ˆæ¯æœˆ 1 æ—¥ 03:00ï¼‰

**åŸ·è¡Œé‚è¼¯**:
1. åˆªé™¤è¶…éä¿ç•™æœŸé™çš„ chip_signalsï¼ˆä¿ç•™ 90 å¤©ï¼‰
2. åˆªé™¤éæœŸçš„ chip_rankings_cache
3. ä¿ç•™ chip_analysis_resultsï¼ˆé•·æœŸä¿å­˜ï¼‰

**åƒæ•¸**:
```json
{
  "job_name": "CLEANUP_OLD_RESULTS",
  "signals_retention_days": 90,
  "rankings_cache_retention_days": 7
}
```

---

### JOB-M09-006: ç›¤ä¸­æ’è¡Œæ¦œå¿«å–åˆ·æ–°

**Cron è¡¨é”å¼**: `0 */30 9-13 * * MON-FRI`ï¼ˆç›¤ä¸­æ¯30åˆ†é˜ï¼‰

**èªªæ˜**: æ­¤ Job ç”¨æ–¼ç›¤ä¸­å³æ™‚æ•¸æ“šå ´æ™¯ï¼ˆè‹¥æœ‰å³æ™‚è³‡æ–™æºï¼‰

**åŸ·è¡Œé‚è¼¯**:
1. æª¢æŸ¥ Redis å¿«å–æ˜¯å¦éæœŸ
2. è‹¥éæœŸï¼Œé‡æ–°è¨ˆç®—æ’è¡Œæ¦œ
3. æ›´æ–° Redis å¿«å–

---

## 3. Job ä¾è³´é—œä¿‚

```
æ¯äº¤æ˜“æ—¥:

M06 Jobs                           M09 Jobs
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
15:00 - SYNC_STOCK_PRICES
        (JOB-M06-001)
          â”‚
          â–¼
15:30 - SYNC_INSTITUTIONAL_TRADING
        SYNC_MARGIN_TRADING
        (JOB-M06-002, JOB-M06-003)
          â”‚
          â”‚ å®Œæˆå¾Œè§¸ç™¼
          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                                 â”‚
        â–¼                                                 â”‚
16:00 - CALC_CHIP_ANALYSIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        (JOB-M09-001)                                     â”‚
          â”‚                                               â”‚
          â–¼                                               â”‚
16:10 - UPDATE_CHIP_RANKINGS                              â”‚
        (JOB-M09-002)                                     â”‚
          â”‚                                               â”‚
          â–¼                                               â”‚
16:15 - SCAN_CHIP_SIGNALS                                â”‚
        (JOB-M09-003)                                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯é€±:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
é€±ä¸€ 08:00 - CALC_COST_ESTIMATION
             (JOB-M09-004)

æ¯æœˆ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1æ—¥ 03:00 - CLEANUP_OLD_RESULTS
            (JOB-M09-005)

ç›¤ä¸­ï¼ˆè‹¥æœ‰å³æ™‚è³‡æ–™ï¼‰:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ¯30åˆ†é˜ - REFRESH_RANKINGS_CACHE
           (JOB-M09-006)
```

---

## 4. Job ç›£æ§èˆ‡å‘Šè­¦

### 4.1 ç›£æ§æŒ‡æ¨™

| æŒ‡æ¨™ | é–¾å€¼ | å‘Šè­¦ç­‰ç´š | è™•ç†æ–¹å¼ |
|-----|------|---------|---------|
| Job åŸ·è¡Œæ™‚é•· | > é ä¼°æ™‚é•· Ã— 2 | WARNING | è¨˜éŒ„æ…¢åŸ·è¡Œ |
| Job å¤±æ•—ç‡ | > 10% | ERROR | ç«‹å³å‘Šè­¦ |
| Job é€£çºŒå¤±æ•— | >= 3 æ¬¡ | CRITICAL | ç«‹å³å‘Šè­¦ä¸¦æš«åœ |
| ç±Œç¢¼è¨ˆç®—è¦†è“‹ç‡ | < 95% | WARNING | æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§ |
| ç•°å¸¸è¨Šè™Ÿæ•¸é‡ï¼ˆCRITICALï¼‰ | > 10 | WARNING | é€šçŸ¥åˆ†æå¸« |

### 4.2 å‘Šè­¦é€šé“

é€é M15 å‘Šè­¦ç³»çµ±ï¼š
- Email
- Slack
- SMSï¼ˆCRITICAL ç­‰ç´šï¼‰

---

## 5. æ‰‹å‹•åŸ·è¡ŒæŒ‡å¼•

### 5.1 è£œç®—ç‰¹å®šæ—¥æœŸ

```bash
# é€é API è§¸ç™¼
curl -X POST http://localhost:8080/api/v1/chip/jobs/calc-analysis \
  -H "Content-Type: application/json" \
  -d '{
    "trade_date": "2024-12-20",
    "force_recalculate": true
  }'
```

### 5.2 è£œç®—ç‰¹å®šè‚¡ç¥¨

```bash
curl -X POST http://localhost:8080/api/v1/chip/jobs/calc-analysis \
  -H "Content-Type: application/json" \
  -d '{
    "trade_date": "2024-12-24",
    "stock_ids": ["2330", "2317", "2454"],
    "force_recalculate": true
  }'
```

### 5.3 é‡å»ºæ’è¡Œæ¦œå¿«å–

```bash
curl -X POST http://localhost:8080/api/v1/chip/jobs/update-rankings \
  -H "Content-Type: application/json" \
  -d '{
    "trade_date": "2024-12-24",
    "clear_cache": true
  }'
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [M09 åŠŸèƒ½éœ€æ±‚](../specs/functional/M09-ç±Œç¢¼åˆ†æåŠŸèƒ½éœ€æ±‚.md)
- [M09 æ¥­å‹™æµç¨‹](../design/M09-æ¥­å‹™æµç¨‹.md)
- [M06 Jobæ’ç¨‹é…ç½®](./M06-Jobæ’ç¨‹é…ç½®.md)
- [å…¨ç³»çµ± Job æ¨¡å‹](../specs/technical/00-å…¨ç³»çµ±å¥‘ç´„.md#45-job-æ¨¡å‹)

---

**æ–‡ä»¶ç¶­è­·è€…**: DevOps å·¥ç¨‹å¸«
**æœ€å¾Œæ›´æ–°**: 2026-01-11
**ä¸‹æ¬¡å¯©æ ¸**: 2026-03-31
