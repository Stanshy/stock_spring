# M11-é‡åŒ–ç­–ç•¥æ¨¡çµ„ Job æ’ç¨‹é…ç½®

> **æ–‡ä»¶ç·¨è™Ÿ**: JOB-M11
> **æ¨¡çµ„åç¨±**: é‡åŒ–ç­–ç•¥æ¨¡çµ„
> **ç‰ˆæœ¬**: v1.0
> **æœ€å¾Œæ›´æ–°**: 2026-01-14
> **ç‹€æ…‹**: Draft

---

## ğŸ“‹ Job æ’ç¨‹ç¸½è¦½

æœ¬æ–‡ä»¶å®šç¾©é‡åŒ–ç­–ç•¥æ¨¡çµ„çš„æ‰€æœ‰æ‰¹æ¬¡ä½œæ¥­èˆ‡æ’ç¨‹é…ç½®ã€‚

---

## 1. Job æ¸…å–®

| Job ç·¨è™Ÿ | Job åç¨± | Job é¡å‹ | åŸ·è¡Œé »ç‡ | åŸ·è¡Œæ™‚é–“ | å„ªå…ˆç´š | é ä¼°æ™‚é•· |
|---------|---------|---------|---------|---------|-------|---------|
| JOB-M11-001 | EXEC_ALL_STRATEGIES | ANALYSIS | æ¯äº¤æ˜“æ—¥ | 16:35 | P0 | 5-10 åˆ†é˜ |
| JOB-M11-002 | NOTIFY_M13_SIGNALS | EVENT | æ¯äº¤æ˜“æ—¥ | 16:45 | P0 | < 1 åˆ†é˜ |
| JOB-M11-003 | UPDATE_STRATEGY_STATS | MAINTENANCE | æ¯äº¤æ˜“æ—¥ | 17:00 | P1 | 2-3 åˆ†é˜ |
| JOB-M11-004 | CLEANUP_OLD_SIGNALS | MAINTENANCE | æ¯é€±æ—¥ | 03:00 | P2 | 5 åˆ†é˜ |
| JOB-M11-005 | REFRESH_FACTOR_METADATA | MAINTENANCE | æ¯é€±ä¸€ | 07:00 | P2 | 1 åˆ†é˜ |

---

## 2. Job è©³ç´°è¨­è¨ˆ

### JOB-M11-001: æ¯æ—¥ç­–ç•¥æ‰¹æ¬¡åŸ·è¡Œ

**Cron è¡¨é”å¼**: `0 35 16 * * MON-FRI`ï¼ˆé€±ä¸€åˆ°é€±äº” 16:35ï¼‰

**åŸ·è¡Œé‚è¼¯**:
1. æª¢æŸ¥ç•¶æ—¥æ˜¯å¦ç‚ºäº¤æ˜“æ—¥
2. ç¢ºèª M07/M08/M09 è¨ˆç®—å®Œæˆ
3. å–å¾—æ‰€æœ‰æ´»èºç­–ç•¥ï¼ˆstatus = 'ACTIVE'ï¼‰
4. ä¾åºåŸ·è¡Œæ¯å€‹ç­–ç•¥
5. æ‰¹æ¬¡å„²å­˜ç­–ç•¥ä¿¡è™Ÿè‡³ strategy_signals
6. è¨˜éŒ„åŸ·è¡Œçµæœè‡³ strategy_executions
7. æ›´æ–°ç­–ç•¥çµ±è¨ˆ

**å‰ç½®æ¢ä»¶**:
- JOB-M07-001 (æŠ€è¡“æŒ‡æ¨™è¨ˆç®—) å®Œæˆ
- JOB-M08-001 (è²¡å‹™æŒ‡æ¨™è¨ˆç®—) å®Œæˆ
- JOB-M09-001 (ç±Œç¢¼åˆ†æè¨ˆç®—) å®Œæˆ

**åƒæ•¸**:
```json
{
  "job_name": "EXEC_ALL_STRATEGIES",
  "trade_date": "2024-12-24",
  "execution_config": {
    "parallel_strategies": false,
    "parallel_stocks": true,
    "batch_size": 100,
    "timeout_minutes": 30
  },
  "stock_universe": {
    "market_type": "ALL",
    "min_volume": 500,
    "exclude_etf": true,
    "exclude_suspended": true
  },
  "output_config": {
    "include_factor_values": true,
    "include_diagnostics": true,
    "save_all_signals": true
  }
}
```

**é æœŸåŸ·è¡Œæ™‚é•·**: 5-10 åˆ†é˜ï¼ˆ10 å€‹ç­–ç•¥ Ã— 1800 æª”è‚¡ç¥¨ï¼‰

**å†ªç­‰æ€§è¨­è¨ˆ**:
- ä½¿ç”¨ execution_id ä½œç‚ºå”¯ä¸€è­˜åˆ¥
- é‡è¤‡åŸ·è¡Œæœƒç”¢ç”Ÿæ–°çš„ execution_id
- åŒä¸€å¤©çš„ä¿¡è™Ÿä¸æœƒé‡è¤‡ï¼ˆé  signal_id å”¯ä¸€ï¼‰

**å¤±æ•—è™•ç†**:
- å–®ä¸€ç­–ç•¥åŸ·è¡Œå¤±æ•—ä¸å½±éŸ¿å…¶ä»–ç­–ç•¥
- è¨˜éŒ„å¤±æ•—ç­–ç•¥åˆ° job_execution_details
- å¤±æ•—ç­–ç•¥æ•¸ > 50% è§¸ç™¼å‘Šè­¦

---

### JOB-M11-002: é€šçŸ¥ M13 æ–°ä¿¡è™Ÿ

**Cron è¡¨é”å¼**: `0 45 16 * * MON-FRI`ï¼ˆé€±ä¸€åˆ°é€±äº” 16:45ï¼‰

**å‰ç½®æ¢ä»¶**: JOB-M11-001 å®Œæˆ

**åŸ·è¡Œé‚è¼¯**:
1. æŸ¥è©¢ç•¶æ—¥æ–°å¢çš„æœªæ¶ˆè²»ä¿¡è™Ÿæ•¸é‡
2. è‹¥æœ‰æ–°ä¿¡è™Ÿï¼Œç™¼é€äº‹ä»¶é€šçŸ¥ M13
3. è¨˜éŒ„é€šçŸ¥çµæœ

**åƒæ•¸**:
```json
{
  "job_name": "NOTIFY_M13_SIGNALS",
  "trade_date": "2024-12-24",
  "notification_config": {
    "channel": "EVENT_BUS",
    "event_type": "STRATEGY_SIGNALS_READY",
    "include_summary": true
  }
}
```

**äº‹ä»¶è¨Šæ¯æ ¼å¼**:
```json
{
  "event_type": "STRATEGY_SIGNALS_READY",
  "trade_date": "2024-12-24",
  "summary": {
    "total_signals": 45,
    "buy_signals": 38,
    "sell_signals": 5,
    "hold_signals": 2,
    "strategies_executed": 10
  },
  "timestamp": "2024-12-24T16:45:00+08:00"
}
```

**é æœŸåŸ·è¡Œæ™‚é•·**: < 1 åˆ†é˜

---

### JOB-M11-003: æ›´æ–°ç­–ç•¥çµ±è¨ˆ

**Cron è¡¨é”å¼**: `0 0 17 * * MON-FRI`ï¼ˆé€±ä¸€åˆ°é€±äº” 17:00ï¼‰

**å‰ç½®æ¢ä»¶**: JOB-M11-001 å®Œæˆ

**åŸ·è¡Œé‚è¼¯**:
1. çµ±è¨ˆæ¯å€‹ç­–ç•¥çš„åŸ·è¡Œçµæœ
2. æ›´æ–° strategies è¡¨çš„çµ±è¨ˆæ¬„ä½
3. è¨ˆç®—ç­–ç•¥ç¸¾æ•ˆæŒ‡æ¨™ï¼ˆ7æ—¥ã€30æ—¥ã€90æ—¥ï¼‰

**åƒæ•¸**:
```json
{
  "job_name": "UPDATE_STRATEGY_STATS",
  "trade_date": "2024-12-24",
  "statistics_config": {
    "periods": [7, 30, 90],
    "metrics": ["signal_count", "avg_confidence", "hit_rate"]
  }
}
```

**æ›´æ–°å…§å®¹**:
```sql
UPDATE strategies
SET
    total_executions = (SELECT COUNT(*) FROM strategy_executions WHERE strategy_id = strategies.strategy_id),
    total_signals = (SELECT COUNT(*) FROM strategy_signals WHERE strategy_id = strategies.strategy_id),
    last_execution_at = (SELECT MAX(started_at) FROM strategy_executions WHERE strategy_id = strategies.strategy_id),
    updated_at = CURRENT_TIMESTAMP
WHERE status IN ('ACTIVE', 'INACTIVE');
```

**é æœŸåŸ·è¡Œæ™‚é•·**: 2-3 åˆ†é˜

---

### JOB-M11-004: æ¸…ç†èˆŠç­–ç•¥ä¿¡è™Ÿ

**Cron è¡¨é”å¼**: `0 0 3 * * SUN`ï¼ˆæ¯é€±æ—¥ 03:00ï¼‰

**åŸ·è¡Œé‚è¼¯**:
1. åˆªé™¤è¶…éä¿ç•™æœŸé™çš„ç­–ç•¥ä¿¡è™Ÿï¼ˆä¿ç•™ 90 å¤©ï¼‰
2. åˆªé™¤éæœŸçš„åŸ·è¡Œè¨˜éŒ„è¨ºæ–·è³‡è¨Šï¼ˆä¿ç•™ 30 å¤©å®Œæ•´ï¼Œ90 å¤©æ‘˜è¦ï¼‰
3. VACUUM ç›¸é—œè³‡æ–™è¡¨

**åƒæ•¸**:
```json
{
  "job_name": "CLEANUP_OLD_SIGNALS",
  "retention_config": {
    "signals_retention_days": 90,
    "executions_full_retention_days": 30,
    "executions_summary_retention_days": 365,
    "vacuum_tables": ["strategy_signals", "strategy_executions"]
  }
}
```

**é æœŸåŸ·è¡Œæ™‚é•·**: 5 åˆ†é˜

---

### JOB-M11-005: åˆ·æ–°å› å­å…ƒæ•¸æ“š

**Cron è¡¨é”å¼**: `0 0 7 * * MON`ï¼ˆæ¯é€±ä¸€ 07:00ï¼‰

**åŸ·è¡Œé‚è¼¯**:
1. å¾ M07/M08/M09 åŒæ­¥æœ€æ–°çš„å› å­å®šç¾©
2. æ›´æ–° factor_metadata è¡¨
3. åˆ·æ–°å› å­å…ƒæ•¸æ“šå¿«å–

**åƒæ•¸**:
```json
{
  "job_name": "REFRESH_FACTOR_METADATA",
  "sync_config": {
    "source_modules": ["M07", "M08", "M09"],
    "refresh_cache": true
  }
}
```

**é æœŸåŸ·è¡Œæ™‚é•·**: 1 åˆ†é˜

---

## 3. Job ä¾è³´é—œä¿‚

```
æ¯äº¤æ˜“æ—¥:

M07/M08/M09 Jobs                         M11 Jobs
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
16:00 - CALC_TECHNICAL_INDICATORS
        (JOB-M07-001)
          â”‚
16:00 - CALC_FUNDAMENTAL_INDICATORS
        (JOB-M08-001)
          â”‚
16:00 - CALC_CHIP_ANALYSIS
        (JOB-M09-001)
          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                             â”‚
                                                             â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚                            â”‚
                                        â–¼                            â”‚
16:35 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ EXEC_ALL_STRATEGIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                              (JOB-M11-001)                          â”‚
                                        â”‚                            â”‚
                                        â–¼                            â”‚
16:45 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ NOTIFY_M13_SIGNALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                              (JOB-M11-002)                          â”‚
                                        â”‚                            â”‚
                                        â–¼                            â”‚
17:00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UPDATE_STRATEGY_STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              (JOB-M11-003)
                                        â”‚
                                        â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   M13 æ¶ˆè²»ä¿¡è™Ÿ   â”‚
                              â”‚   (ä¸‹æ¸¸ä¾è³´)     â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


æ¯é€±:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
é€±æ—¥ 03:00 â”€ CLEANUP_OLD_SIGNALS
             (JOB-M11-004)

é€±ä¸€ 07:00 â”€ REFRESH_FACTOR_METADATA
             (JOB-M11-005)
```

---

## 4. Job ç›£æ§èˆ‡å‘Šè­¦

### 4.1 ç›£æ§æŒ‡æ¨™

| æŒ‡æ¨™ | é–¾å€¼ | å‘Šè­¦ç­‰ç´š | è™•ç†æ–¹å¼ |
|-----|------|---------|---------|
| Job åŸ·è¡Œæ™‚é•· | > é ä¼° Ã— 2 | WARNING | è¨˜éŒ„æ…¢åŸ·è¡Œ |
| ç­–ç•¥åŸ·è¡Œå¤±æ•—ç‡ | > 30% | ERROR | ç«‹å³å‘Šè­¦ |
| ä¿¡è™Ÿç”¢ç”Ÿæ•¸ç‚º 0 | æ‰€æœ‰ç­–ç•¥ | WARNING | æª¢æŸ¥è³‡æ–™ä¾†æº |
| M13 æ¶ˆè²»å»¶é² | > 30 åˆ†é˜ | WARNING | é€šçŸ¥ M13 åœ˜éšŠ |
| Job é€£çºŒå¤±æ•— | >= 3 æ¬¡ | CRITICAL | æš«åœä¸¦å‘Šè­¦ |

### 4.2 å‘Šè­¦é€šé“

é€é M15 å‘Šè­¦ç³»çµ±ï¼š
- Email
- Slack
- SMSï¼ˆCRITICAL ç­‰ç´šï¼‰

### 4.3 ç›£æ§å„€è¡¨æ¿

| é¢æ¿ | æŒ‡æ¨™ |
|-----|------|
| ç­–ç•¥åŸ·è¡Œç¸½è¦½ | ç•¶æ—¥åŸ·è¡Œç­–ç•¥æ•¸ã€æˆåŠŸ/å¤±æ•—æ•¸ |
| ä¿¡è™Ÿç”¢ç”Ÿçµ±è¨ˆ | å„ç­–ç•¥ä¿¡è™Ÿæ•¸ã€BUY/SELL æ¯”ä¾‹ |
| åŸ·è¡Œæ•ˆèƒ½ | å¹³å‡åŸ·è¡Œæ™‚é–“ã€æœ€æ…¢ç­–ç•¥ |
| å› å­è¼‰å…¥ç‹€æ…‹ | å› å­ç¼ºå¤±ç‡ã€è³‡æ–™å®Œæ•´åº¦ |

---

## 5. æ‰‹å‹•åŸ·è¡ŒæŒ‡å¼•

### 5.1 åŸ·è¡Œå–®ä¸€ç­–ç•¥

```bash
curl -X POST http://localhost:8080/api/v1/strategy/STG_MOMENTUM_001/execute \
  -H "Content-Type: application/json" \
  -d '{
    "execution_date": "2024-12-24",
    "stock_universe": {
      "type": "MARKET",
      "market_type": "TWSE"
    },
    "options": {
      "include_factor_values": true,
      "save_results": true
    }
  }'
```

### 5.2 åŸ·è¡Œæ‰€æœ‰æ´»èºç­–ç•¥

```bash
curl -X POST http://localhost:8080/api/v1/strategy/jobs/exec-all \
  -H "Content-Type: application/json" \
  -d '{
    "trade_date": "2024-12-24",
    "force_execute": true
  }'
```

### 5.3 è£œåŸ·è¡Œç‰¹å®šæ—¥æœŸ

```bash
curl -X POST http://localhost:8080/api/v1/strategy/jobs/backfill \
  -H "Content-Type: application/json" \
  -d '{
    "start_date": "2024-12-20",
    "end_date": "2024-12-24",
    "strategy_ids": ["STG_MOMENTUM_001", "STG_VALUE_001"]
  }'
```

### 5.4 æ‰‹å‹•é€šçŸ¥ M13

```bash
curl -X POST http://localhost:8080/api/v1/strategy/jobs/notify-m13 \
  -H "Content-Type: application/json" \
  -d '{
    "trade_date": "2024-12-24"
  }'
```

---

## 6. ç½é›£æ¢å¾©

### 6.1 Job å¤±æ•—æ¢å¾©ç¨‹åº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Job å¤±æ•—æ¢å¾©ç¨‹åº                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. æª¢æŸ¥å¤±æ•—åŸå› 
   - æŸ¥çœ‹ job_executions è¡¨çš„ error_message
   - æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼æ—¥èªŒ

2. åˆ¤æ–·å¤±æ•—é¡å‹
   â”œâ”€â”€ è³‡æ–™ä¾†æºå•é¡Œï¼ˆM07/M08/M09 æœªå®Œæˆï¼‰
   â”‚   â†’ ç­‰å¾…ä¸Šæ¸¸ Job å®Œæˆï¼Œé‡æ–°åŸ·è¡Œ
   â”‚
   â”œâ”€â”€ è³‡æ–™åº«é€£ç·šå•é¡Œ
   â”‚   â†’ æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹ï¼Œé‡æ–°åŸ·è¡Œ
   â”‚
   â”œâ”€â”€ ç­–ç•¥å®šç¾©éŒ¯èª¤
   â”‚   â†’ ä¿®å¾©ç­–ç•¥å®šç¾©ï¼Œé‡æ–°åŸ·è¡Œè©²ç­–ç•¥
   â”‚
   â””â”€â”€ ç³»çµ±è³‡æºä¸è¶³
       â†’ æ“´å±•è³‡æºæˆ–éŒ¯å³°åŸ·è¡Œ

3. æ¢å¾©åŸ·è¡Œ
   curl -X POST /api/v1/strategy/jobs/retry \
     -d '{"job_id": "xxx", "trade_date": "2024-12-24"}'

4. é©—è­‰çµæœ
   - ç¢ºèª strategy_signals æœ‰æ–°è³‡æ–™
   - ç¢ºèª M13 å¯æ­£å¸¸æ¶ˆè²»
```

### 6.2 è³‡æ–™ä¸ä¸€è‡´è™•ç†

```sql
-- æª¢æŸ¥åŸ·è¡Œè¨˜éŒ„èˆ‡ä¿¡è™Ÿæ•¸æ˜¯å¦ä¸€è‡´
SELECT
    se.execution_id,
    se.signals_generated,
    COUNT(ss.signal_id) as actual_signals
FROM strategy_executions se
LEFT JOIN strategy_signals ss ON se.execution_id = ss.execution_id
WHERE se.execution_date = '2024-12-24'
GROUP BY se.execution_id, se.signals_generated
HAVING se.signals_generated != COUNT(ss.signal_id);

-- è‹¥ä¸ä¸€è‡´ï¼Œé‡æ–°åŸ·è¡Œè©²ç­–ç•¥
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [M11 åŠŸèƒ½éœ€æ±‚](../specs/functional/M11-é‡åŒ–ç­–ç•¥åŠŸèƒ½éœ€æ±‚.md)
- [M11 æ¥­å‹™æµç¨‹](../design/M11-æ¥­å‹™æµç¨‹.md)
- [M07 Jobæ’ç¨‹é…ç½®](./M07-Jobæ’ç¨‹é…ç½®.md)
- [M09 Jobæ’ç¨‹é…ç½®](./M09-Jobæ’ç¨‹é…ç½®.md)
- [å…¨ç³»çµ± Job æ¨¡å‹](../specs/technical/00-å…¨ç³»çµ±å¥‘ç´„.md#45-job-æ¨¡å‹)

---

**æ–‡ä»¶ç¶­è­·è€…**: DevOps å·¥ç¨‹å¸«
**æœ€å¾Œæ›´æ–°**: 2026-01-14
**ä¸‹æ¬¡å¯©æ ¸**: 2026-04-14
