# ğŸ“ é–‹ç™¼æº–å‰‡

> **æ–‡ä»¶ç·¨è™Ÿ**: DOC-SPEC-TECH-02  
> **æ–‡ä»¶åç¨±**: é–‹ç™¼æº–å‰‡ (Development Guidelines)  
> **ç‰ˆæœ¬**: v2.0  
> **æœ€å¾Œæ›´æ–°**: 2025-12-31  
> **ç‹€æ…‹**: Draft

---

## ğŸ“‘ ç›®éŒ„

1. [ç¨‹å¼ç¢¼è¦ç¯„](#1-ç¨‹å¼ç¢¼è¦ç¯„)
2. [è³‡æ–™åº«è¨­è¨ˆè¦ç¯„](#2-è³‡æ–™åº«è¨­è¨ˆè¦ç¯„)
3. [æŒä¹…å±¤ä½¿ç”¨æº–å‰‡](#3-æŒä¹…å±¤ä½¿ç”¨æº–å‰‡)
4. [Git è¦ç¯„](#4-git-è¦ç¯„)
5. [æ¸¬è©¦è¦ç¯„](#5-æ¸¬è©¦è¦ç¯„)
6. [API è¨­è¨ˆè¦ç¯„](#6-api-è¨­è¨ˆè¦ç¯„)

---

## 1. ç¨‹å¼ç¢¼è¦ç¯„

### 1.1 å‘½åè¦ç¯„

#### 1.1.1 é¡åˆ¥å‘½å

**æ ¼å¼**: å¤§é§å³°å¼ï¼ˆPascalCaseï¼‰

| é¡åˆ¥é¡å‹ | å‘½åè¦å‰‡ | ç¯„ä¾‹ |
|---------|---------|------|
| **Entity** | åè© | `Stock`, `Signal`, `StockPrice` |
| **DTO** | åè© + DTO | `StockDTO`, `SignalRequestDTO`, `SignalResponseDTO` |
| **Repository** | åè© + Repository | `StockRepository`, `SignalRepository` |
| **Mapper** | åè© + Mapper | `SignalMapper`, `IndicatorMapper` |
| **Service** | åè© + Service | `StockService`, `SignalService` |
| **Controller** | åè© + Controller | `StockController`, `SignalController` |
| **Exception** | æƒ…å¢ƒ + Exception | `StockNotFoundException`, `InvalidSignalException` |
| **Scheduler** | å‹•ä½œ + Scheduler | `DataSyncScheduler`, `SignalDetectionScheduler` |

---

#### 1.1.2 æ–¹æ³•å‘½å

**æ ¼å¼**: å°é§å³°å¼ï¼ˆcamelCaseï¼‰

| æ–¹æ³•é¡å‹ | å‘½åè¦å‰‡ | ç¯„ä¾‹ |
|---------|---------|------|
| **æŸ¥è©¢** | get/find/query + åè© | `getStock()`, `findActiveSignals()` |
| **æ–°å¢** | create/add/insert + åè© | `createSignal()`, `addStock()` |
| **æ›´æ–°** | update/modify + åè© | `updateStock()`, `modifySignalStatus()` |
| **åˆªé™¤** | delete/remove + åè© | `deleteStock()`, `removeExpiredSignals()` |
| **è¨ˆç®—** | calculate + åè© | `calculateMACD()`, `calculateROE()` |
| **é©—è­‰** | validate/check + åè© | `validateStock()`, `checkDataQuality()` |
| **åˆ¤æ–·** | is/has/can + åè©/å½¢å®¹è© | `isActive()`, `hasSignal()`, `canTrade()` |

---

#### 1.1.3 è®Šæ•¸å‘½å

**æ ¼å¼**: å°é§å³°å¼ï¼ˆcamelCaseï¼‰

```java
// âœ… æ­£ç¢ºç¯„ä¾‹
String stockId = "2330";
BigDecimal closePrice = new BigDecimal("500.00");
List<Signal> activeSignals = new ArrayList<>();
boolean isActive = true;

// âŒ éŒ¯èª¤ç¯„ä¾‹
String StockID = "2330";          // æ‡‰ä½¿ç”¨ camelCase
BigDecimal close_price = ...;     // æ‡‰ä½¿ç”¨ camelCase
List<Signal> signal_list = ...;   // æ‡‰ä½¿ç”¨ camelCase
boolean active = true;             // å¸ƒæ—å€¼æ‡‰åŠ  is/has å‰ç¶´
```

**å¸¸æ•¸å‘½å**: å…¨å¤§å¯« + åº•ç·š

```java
// âœ… æ­£ç¢ºç¯„ä¾‹
public static final String DEFAULT_MARKET = "TWSE";
public static final int MAX_RETRY_COUNT = 3;
public static final BigDecimal STOP_LOSS_RATIO = new BigDecimal("0.10");

// âŒ éŒ¯èª¤ç¯„ä¾‹
public static final String defaultMarket = "TWSE";  // æ‡‰å…¨å¤§å¯«
public static final int maxRetryCount = 3;          // æ‡‰å…¨å¤§å¯«
```

---

### 1.2 åŒ…çµæ§‹è¦ç¯„

#### 1.2.1 æ¨™æº–åŒ…çµæ§‹

```
com.stockmonitor
â”œâ”€â”€ entity/                    # JPA Entity
â”‚   â”œâ”€â”€ Stock.java
â”‚   â”œâ”€â”€ StockPrice.java
â”‚   â””â”€â”€ Signal.java
â”‚
â”œâ”€â”€ dto/                       # Data Transfer Object
â”‚   â”œâ”€â”€ request/
â”‚   â”‚   â”œâ”€â”€ SignalCreateRequest.java
â”‚   â”‚   â””â”€â”€ StockQueryRequest.java
â”‚   â””â”€â”€ response/
â”‚       â”œâ”€â”€ SignalResponse.java
â”‚       â””â”€â”€ StockResponse.java
â”‚
â”œâ”€â”€ repository/                # JPA Repository
â”‚   â”œâ”€â”€ StockRepository.java
â”‚   â””â”€â”€ SignalRepository.java
â”‚
â”œâ”€â”€ mapper/                    # MyBatis Mapper
â”‚   â”œâ”€â”€ SignalMapper.java
â”‚   â”œâ”€â”€ IndicatorMapper.java
â”‚   â””â”€â”€ ScreenerMapper.java
â”‚
â”œâ”€â”€ service/                   # Business Logic
â”‚   â”œâ”€â”€ StockService.java
â”‚   â”œâ”€â”€ SignalService.java
â”‚   â””â”€â”€ IndicatorService.java
â”‚
â”œâ”€â”€ controller/                # REST API
â”‚   â”œâ”€â”€ StockController.java
â”‚   â””â”€â”€ SignalController.java
â”‚
â”œâ”€â”€ scheduler/                 # Scheduled Tasks
â”‚   â”œâ”€â”€ DataSyncScheduler.java
â”‚   â””â”€â”€ SignalDetectionScheduler.java
â”‚
â”œâ”€â”€ config/                    # Configuration
â”‚   â”œâ”€â”€ DatabaseConfig.java
â”‚   â”œâ”€â”€ RedisConfig.java
â”‚   â””â”€â”€ SecurityConfig.java
â”‚
â”œâ”€â”€ exception/                 # Custom Exceptions
â”‚   â”œâ”€â”€ StockNotFoundException.java
â”‚   â””â”€â”€ InvalidSignalException.java
â”‚
â””â”€â”€ util/                      # Utility Classes
    â”œâ”€â”€ DateUtils.java
    â””â”€â”€ ValidationUtils.java
```

#### 1.2.2 æ¨¡çµ„åŒ–åŒ…çµæ§‹

å¦‚æœæŒ‰æ¨¡çµ„åŠƒåˆ†ï¼š

```
com.stockmonitor
â”œâ”€â”€ m06.data/                  # M06 è³‡æ–™ç®¡ç†æ¨¡çµ„
â”‚   â”œâ”€â”€ entity/
â”‚   â”œâ”€â”€ repository/
â”‚   â”œâ”€â”€ service/
â”‚   â””â”€â”€ controller/
â”‚
â”œâ”€â”€ m07.technical/             # M07 æŠ€è¡“åˆ†ææ¨¡çµ„
â”‚   â”œâ”€â”€ entity/
â”‚   â”œâ”€â”€ mapper/
â”‚   â”œâ”€â”€ service/
â”‚   â””â”€â”€ controller/
â”‚
â””â”€â”€ m13.signal/                # M13 ä¿¡è™Ÿå¼•æ“æ¨¡çµ„
    â”œâ”€â”€ entity/
    â”œâ”€â”€ repository/
    â”œâ”€â”€ mapper/
    â”œâ”€â”€ service/
    â””â”€â”€ controller/
```

---

### 1.3 è¨»è§£è¦ç¯„

#### 1.3.1 JavaDoc è¨»è§£

**æ‰€æœ‰ public é¡åˆ¥èˆ‡æ–¹æ³•å¿…é ˆæœ‰ JavaDoc**

**é¡åˆ¥è¨»è§£ç¯„ä¾‹**:
```java
/**
 * æŠ€è¡“æŒ‡æ¨™è¨ˆç®—æœå‹™
 * 
 * <p>æä¾›å„é¡æŠ€è¡“æŒ‡æ¨™çš„è¨ˆç®—åŠŸèƒ½ï¼ŒåŒ…å«ï¼š
 * <ul>
 *   <li>è¶¨å‹¢æŒ‡æ¨™ï¼ˆMAã€EMAã€MACDï¼‰</li>
 *   <li>å‹•èƒ½æŒ‡æ¨™ï¼ˆRSIã€KDã€WRï¼‰</li>
 *   <li>æ³¢å‹•æŒ‡æ¨™ï¼ˆBBã€ATRï¼‰</li>
 * </ul>
 * 
 * @author Chris Chang
 * @since 1.0.0
 */
@Service
public class IndicatorService {
    // ...
}
```

**æ–¹æ³•è¨»è§£ç¯„ä¾‹**:
```java
/**
 * è¨ˆç®—è‚¡ç¥¨çš„æŠ€è¡“æŒ‡æ¨™
 *
 * <p>æ ¹æ“šæŒ‡å®šçš„æ™‚é–“å€é–“è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ï¼Œæ”¯æ´å¤šç¨®æŒ‡æ¨™é¡å‹ã€‚
 * è¨ˆç®—çµæœæœƒè‡ªå‹•å¿«å–ä»¥æå‡æ•ˆèƒ½ã€‚
 *
 * @param stockId è‚¡ç¥¨ä»£ç¢¼ï¼Œä¸å¯ç‚º null
 * @param startDate é–‹å§‹æ—¥æœŸï¼Œä¸å¯ç‚º null
 * @param endDate çµæŸæ—¥æœŸï¼Œä¸å¯ç‚º null
 * @return æŠ€è¡“æŒ‡æ¨™åˆ—è¡¨ï¼Œå¦‚æœç„¡è³‡æ–™å‰‡è¿”å›ç©ºåˆ—è¡¨
 * @throws StockNotFoundException ç•¶è‚¡ç¥¨ä¸å­˜åœ¨æ™‚
 * @throws IllegalArgumentException ç•¶æ—¥æœŸç¯„åœç„¡æ•ˆæ™‚
 */
public List<TechnicalIndicator> calculateIndicators(
    @NotNull String stockId, 
    @NotNull LocalDate startDate, 
    @NotNull LocalDate endDate) {
    // ...
}
```

---

#### 1.3.2 ç¨‹å¼ç¢¼è¨»è§£

**è¨»è§£åŸå‰‡**:
- âœ… è§£é‡‹**ç‚ºä»€éº¼**é€™æ¨£åšï¼ˆWhyï¼‰ï¼Œè€Œé**åšä»€éº¼**ï¼ˆWhatï¼‰
- âœ… è§£é‡‹è¤‡é›œçš„æ¥­å‹™é‚è¼¯
- âœ… æ¨™è¨» TODOã€FIXMEã€HACK
- âŒ é¿å…ç„¡æ„ç¾©çš„è¨»è§£
- âŒ é¿å…éæ™‚çš„è¨»è§£

**å¥½çš„è¨»è§£ç¯„ä¾‹**:
```java
// âœ… å¥½çš„è¨»è§£ï¼šè§£é‡‹ç‚ºä»€éº¼
// ä½¿ç”¨ UUID è€Œéè³‡æ–™åº«è‡ªå¢ IDï¼Œæ˜¯ç‚ºäº†æ”¯æ´åˆ†æ•£å¼ç³»çµ±ä¸­çš„è·¨è³‡æ–™åº«å»é‡
String signalUuid = UUID.randomUUID().toString();

// âœ… å¥½çš„è¨»è§£ï¼šè§£é‡‹æ¥­å‹™é‚è¼¯
// èè³‡ç¶­æŒç‡ä½æ–¼ 130% æ™‚ï¼Œè¦–ç‚ºè­¦æˆ’ç‹€æ…‹ï¼Œéœ€è¦ç™¼é€è­¦å ±
if (marginRatio < 130) {
    sendMarginCallAlert(stockId);
}

// âœ… å¥½çš„è¨»è§£ï¼šæ¨™è¨»å¾…è¾¦äº‹é …
// TODO: æœªä¾†éœ€è¦æ”¯æ´ç¾è‚¡è³‡æ–™ï¼Œå±†æ™‚éœ€è¦èª¿æ•´æ™‚å€è™•ç†é‚è¼¯
LocalDateTime now = LocalDateTime.now();
```

**ä¸å¥½çš„è¨»è§£ç¯„ä¾‹**:
```java
// âŒ ä¸å¥½çš„è¨»è§£ï¼šæè¿°ç¨‹å¼ç¢¼åšäº†ä»€éº¼ï¼ˆé¡¯è€Œæ˜“è¦‹ï¼‰
// å‰µå»ºä¸€å€‹æ–°çš„ Signal ç‰©ä»¶
Signal signal = new Signal();

// âŒ ä¸å¥½çš„è¨»è§£ï¼šç„¡æ„ç¾©
// é€™æ˜¯ä¸€å€‹æ–¹æ³•
public void processData() { ... }

// âŒ ä¸å¥½çš„è¨»è§£ï¼šéæ™‚çš„è¨»è§£
// ä½¿ç”¨ MySQL è³‡æ–™åº«  ï¼ˆå¯¦éš›å·²æ”¹ç”¨ PostgreSQLï¼‰
DataSource dataSource = ...;
```

---

## 2. è³‡æ–™åº«è¨­è¨ˆè¦ç¯„

### 2.1 å‘½åè¦ç¯„

#### 2.1.1 è¡¨å‘½å

**æ ¼å¼**: å°å¯« + åº•ç·šï¼Œè¤‡æ•¸å½¢å¼

```sql
-- âœ… æ­£ç¢ºç¯„ä¾‹
stocks
stock_prices
technical_indicators
signals

-- âŒ éŒ¯èª¤ç¯„ä¾‹
Stock                -- æ‡‰ä½¿ç”¨å°å¯«
stock_price          -- æ‡‰ä½¿ç”¨è¤‡æ•¸å½¢å¼
TechnicalIndicator   -- æ‡‰ä½¿ç”¨å°å¯« + åº•ç·š
```

---

#### 2.1.2 æ¬„ä½å‘½å

**æ ¼å¼**: å°å¯« + åº•ç·š

```sql
-- âœ… æ­£ç¢ºç¯„ä¾‹
stock_id
signal_type
created_at
is_active

-- âŒ éŒ¯èª¤ç¯„ä¾‹
StockId              -- æ‡‰ä½¿ç”¨å°å¯« + åº•ç·š
signalType           -- æ‡‰ä½¿ç”¨åº•ç·šåˆ†éš”
CreatedAt            -- æ‡‰ä½¿ç”¨å°å¯«
```

---

#### 2.1.3 ç´¢å¼•å‘½å

| ç´¢å¼•é¡å‹ | å‘½åè¦å‰‡ | ç¯„ä¾‹ |
|---------|---------|------|
| **ä¸»éµ** | `pk_{table}` | `pk_stocks` |
| **å”¯ä¸€ç´¢å¼•** | `uk_{table}_{column(s)}` | `uk_signals_uuid` |
| **ä¸€èˆ¬ç´¢å¼•** | `idx_{table}_{column(s)}` | `idx_signals_stock_date` |
| **GIN ç´¢å¼•** | `gin_{table}_{column}` | `gin_signals_evidence_data` |

**ç¯„ä¾‹**:
```sql
-- ä¸»éµ
ALTER TABLE stocks ADD CONSTRAINT pk_stocks PRIMARY KEY (stock_id);

-- å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX uk_signals_uuid ON signals(signal_uuid);

-- ä¸€èˆ¬ç´¢å¼•
CREATE INDEX idx_signals_stock_date ON signals(stock_id, signal_date);

-- GIN ç´¢å¼•ï¼ˆPostgreSQL JSONBï¼‰
CREATE INDEX gin_signals_evidence_data ON signals USING GIN (evidence_data);
```

---

### 2.2 PostgreSQL è³‡æ–™é¡å‹è¦ç¯„

| è³‡æ–™é¡å‹ | PostgreSQL é¡å‹ | èªªæ˜ | ç¯„ä¾‹ |
|---------|----------------|------|------|
| **ä¸»éµï¼ˆè‡ªå¢ï¼‰** | `BIGSERIAL` / `SERIAL` | è‡ªå‹•éå¢ä¸»éµ | `stock_id BIGSERIAL` |
| **è‚¡ç¥¨ä»£ç¢¼** | `VARCHAR(10)` | å°è‚¡æœ€å¤š 6 ç¢¼ | `stock_id VARCHAR(10)` |
| **é‡‘é¡/åƒ¹æ ¼** | `NUMERIC(15,2)` | ç²¾ç¢ºåˆ°å°æ•¸é»å¾Œ 2 ä½ | `close_price NUMERIC(15,2)` |
| **æ¯”ç‡/ç™¾åˆ†æ¯”** | `NUMERIC(5,2)` | -999.99 ~ 999.99 | `roe NUMERIC(5,2)` |
| **æ•¸é‡** | `BIGINT` | æˆäº¤é‡ã€å¼µæ•¸ | `volume BIGINT` |
| **æ—¥æœŸ** | `DATE` | åƒ…æ—¥æœŸ | `trade_date DATE` |
| **æ—¥æœŸæ™‚é–“** | `TIMESTAMP` | å«æ™‚åˆ†ç§’ | `created_at TIMESTAMP` |
| **æ—¥æœŸæ™‚é–“ï¼ˆæ™‚å€ï¼‰** | `TIMESTAMPTZ` | å«æ™‚åˆ†ç§’èˆ‡æ™‚å€ | `created_at TIMESTAMPTZ` |
| **çŸ­æ–‡å­—** | `VARCHAR(N)` | N < 255 | `stock_name VARCHAR(50)` |
| **é•·æ–‡å­—** | `TEXT` | é•·æ–‡å­—å…§å®¹ | `description TEXT` |
| **JSON** | `JSONB` | çµæ§‹åŒ–è³‡æ–™ | `evidence_data JSONB` |
| **å¸ƒæ—å€¼** | `BOOLEAN` | true/false | `is_active BOOLEAN` |
| **é™£åˆ—** | `ARRAY` | PostgreSQL åŸç”Ÿé™£åˆ— | `tags TEXT[]` |

---

### 2.3 PostgreSQL ç‰¹å®šè¨­è¨ˆè¦ç¯„

#### 2.3.1 ä½¿ç”¨ BIGSERIAL ä½œç‚ºè‡ªå¢ä¸»éµ

```sql
CREATE TABLE stocks (
    stock_id BIGSERIAL PRIMARY KEY,
    stock_code VARCHAR(10) NOT NULL,
    stock_name VARCHAR(50) NOT NULL
);
```

---

#### 2.3.2 ä½¿ç”¨ JSONB å„²å­˜è¤‡é›œçµæ§‹åŒ–è³‡æ–™

```sql
CREATE TABLE signals (
    signal_id BIGSERIAL PRIMARY KEY,
    evidence_data JSONB,
    technical_factors JSONB
);

-- ç‚º JSONB æ¬„ä½å»ºç«‹ GIN ç´¢å¼•
CREATE INDEX gin_signals_evidence_data ON signals USING GIN (evidence_data);
CREATE INDEX gin_signals_technical_factors ON signals USING GIN (technical_factors);
```

**æŸ¥è©¢ JSONB ç¯„ä¾‹**:
```sql
-- æŸ¥è©¢ JSONB æ¬„ä½
SELECT * FROM signals 
WHERE evidence_data->>'indicator' = 'MACD' 
  AND (evidence_data->>'macd_value')::numeric > 1.0;

-- æª¢æŸ¥ JSON éµæ˜¯å¦å­˜åœ¨
SELECT * FROM signals 
WHERE technical_factors ? 'RSI';

-- åŒ…å«å­é›†æŸ¥è©¢
SELECT * FROM signals 
WHERE evidence_data @> '{"indicator": "MACD"}'::jsonb;
```

---

#### 2.3.3 ä½¿ç”¨ CHECK ç´„æŸå–ä»£ ENUM

```sql
CREATE TABLE signals (
    signal_type VARCHAR(10) NOT NULL 
        CHECK (signal_type IN ('BUY', 'SELL', 'HOLD')),
    
    signal_status VARCHAR(20) DEFAULT 'ACTIVE'
        CHECK (signal_status IN ('ACTIVE', 'EXPIRED', 'TRIGGERED', 'CANCELLED'))
);
```

**ç†ç”±**: CHECK ç´„æŸæ¯” ENUM æ›´éˆæ´»ï¼Œæ˜“æ–¼æ“´å±•

---

#### 2.3.4 ä½¿ç”¨è§¸ç™¼å™¨è‡ªå‹•æ›´æ–° updated_at

```sql
-- å»ºç«‹é€šç”¨çš„æ›´æ–°å‡½æ•¸
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ç‚ºè¡¨å»ºç«‹è§¸ç™¼å™¨
CREATE TRIGGER update_signals_updated_at
    BEFORE UPDATE ON signals
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

#### 2.3.5 ä½¿ç”¨ COMMENT ON æ–°å¢è¨»é‡‹

```sql
COMMENT ON TABLE signals IS 'çµ±ä¸€ä¿¡è™Ÿè¡¨';
COMMENT ON COLUMN signals.signal_id IS 'ä¿¡è™ŸIDï¼ˆä¸»éµï¼‰';
COMMENT ON COLUMN signals.signal_uuid IS 'UUIDï¼Œç”¨æ–¼å»é‡';
COMMENT ON COLUMN signals.evidence_data IS 'ä¿¡è™Ÿè­‰æ“šè³‡æ–™ï¼ˆJSONBæ ¼å¼ï¼Œæ”¯æ´é«˜æ•ˆæŸ¥è©¢ï¼‰';
```

---

### 2.4 å¿…è¦æ¬„ä½

**æ‰€æœ‰è¡¨å¿…é ˆåŒ…å«**:

```sql
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
```

**ä½¿ç”¨è€…ç›¸é—œè¡¨å»ºè­°åŒ…å«**:

```sql
created_by VARCHAR(50),
updated_by VARCHAR(50)
```

---

### 2.5 ç´¢å¼•è¨­è¨ˆåŸå‰‡

#### 2.5.1 ä½•æ™‚å»ºç«‹ç´¢å¼•

- âœ… ä¸»éµï¼ˆè‡ªå‹•å»ºç«‹ï¼‰
- âœ… å¤–éµ
- âœ… ç¶“å¸¸ç”¨æ–¼ WHERE æ¢ä»¶çš„æ¬„ä½
- âœ… ç¶“å¸¸ç”¨æ–¼ ORDER BY çš„æ¬„ä½
- âœ… ç¶“å¸¸ç”¨æ–¼ JOIN çš„æ¬„ä½
- âœ… JSONB æ¬„ä½ï¼ˆä½¿ç”¨ GIN ç´¢å¼•ï¼‰

#### 2.5.2 è¤‡åˆç´¢å¼•è¦å‰‡

- æœ€å¸¸ç”¨æ–¼æŸ¥è©¢çš„æ¬„ä½æ”¾åœ¨å‰é¢
- é¸æ“‡æ€§é«˜çš„æ¬„ä½æ”¾åœ¨å‰é¢

```sql
-- âœ… æ­£ç¢ºï¼šstock_id é¸æ“‡æ€§é«˜ï¼Œæ”¾å‰é¢
CREATE INDEX idx_signals_stock_date ON signals(stock_id, signal_date);

-- âŒ éŒ¯èª¤ï¼šsignal_date é¸æ“‡æ€§ä½ï¼Œä¸æ‡‰æ”¾å‰é¢
CREATE INDEX idx_signals_date_stock ON signals(signal_date, stock_id);
```

#### 2.5.3 éƒ¨åˆ†ç´¢å¼•ï¼ˆPartial Indexï¼‰

```sql
-- åªç´¢å¼• ACTIVE ç‹€æ…‹çš„ä¿¡è™Ÿ
CREATE INDEX idx_signals_active_only ON signals(stock_id, signal_date)
WHERE signal_status = 'ACTIVE';
```

#### 2.5.4 é¿å…éåº¦ç´¢å¼•

- æ¯å€‹è¡¨çš„ç´¢å¼•æ•¸é‡ < 5-7 å€‹ï¼ˆç‰¹æ®Šæƒ…æ³ä¾‹å¤–ï¼‰
- å¯«å…¥é »ç¹çš„è¡¨è¬¹æ…å»ºç«‹ç´¢å¼•

---

## 3. æŒä¹…å±¤ä½¿ç”¨æº–å‰‡

### 3.1 JPA ä½¿ç”¨æº–å‰‡

#### 3.1.1 æ¨è–¦ä½¿ç”¨å ´æ™¯

```java
// âœ… æ¨è–¦ï¼šç°¡å–®æŸ¥è©¢
stockRepository.findById(stockId);
stockRepository.findByMarket("TWSE");

// âœ… æ¨è–¦ï¼šç°¡å–®æ¢ä»¶çµ„åˆ
List<Stock> findByIsActiveTrueAndMarket(String market);

// âœ… æ¨è–¦ï¼šåŸºç¤åˆ†é 
Page<Stock> findAll(Pageable pageable);

// âŒ ä¸æ¨è–¦ï¼šè¤‡é›œå‹•æ…‹æŸ¥è©¢ç”¨ JPAï¼ˆæ‡‰æ”¹ç”¨ MyBatisï¼‰
```

---

#### 3.1.2 Entity è¨­è¨ˆ

```java
@Entity
@Table(name = "signals")
@TypeDef(name = "jsonb", typeClass = JsonBinaryType.class)
@Data
public class Signal {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "signal_id")
    private Long signalId;
    
    @Column(name = "stock_id", nullable = false, length = 10)
    private String stockId;
    
    // JSONB æ¬„ä½æ˜ å°„
    @Type(JsonBinaryType.class)
    @Column(name = "evidence_data", columnDefinition = "jsonb")
    private Map<String, Object> evidenceData;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
}
```

---

#### 3.1.3 é¿å… N+1 æŸ¥è©¢

```java
// âœ… ä½¿ç”¨ @EntityGraph
@EntityGraph(attributePaths = {"stock", "indicators"})
List<Signal> findByStockId(String stockId);

// âœ… ä½¿ç”¨ JOIN FETCH
@Query("SELECT s FROM Signal s JOIN FETCH s.stock WHERE s.stockId = :stockId")
List<Signal> findWithStock(@Param("stockId") String stockId);
```

---

### 3.2 MyBatis ä½¿ç”¨æº–å‰‡

#### 3.2.1 æ¨è–¦ä½¿ç”¨å ´æ™¯

```java
// âœ… æ¨è–¦ï¼šè¤‡é›œå¤šè¡¨ JOIN
signalMapper.searchSignals(criteria);

// âœ… æ¨è–¦ï¼šå‹•æ…‹ SQL
indicatorMapper.calculateWithDynamicConditions(params);

// âœ… æ¨è–¦ï¼šæ‰¹æ¬¡æ“ä½œ
signalMapper.batchInsertSignals(signals);

// âœ… æ¨è–¦ï¼šPostgreSQL ç‰¹å®šåŠŸèƒ½ï¼ˆJSONB æŸ¥è©¢ï¼‰
signalMapper.findByJsonbField(indicator, minValue);

// âŒ ä¸æ¨è–¦ï¼šç°¡å–® CRUD ç”¨ MyBatisï¼ˆæ‡‰æ”¹ç”¨ JPAï¼‰
```

---

#### 3.2.2 XML Mapper ç¯„ä¾‹

**è¤‡é›œå‹•æ…‹æŸ¥è©¢**:
```xml
<select id="searchSignals" resultType="SignalDTO">
    SELECT * FROM signals
    <where>
        <if test="criteria.stockIds != null">
            AND stock_id IN
            <foreach collection="criteria.stockIds" item="stockId" 
                     open="(" separator="," close=")">
                #{stockId}
            </foreach>
        </if>
        <if test="criteria.indicator != null">
            AND evidence_data ->> 'indicator' = #{criteria.indicator}
        </if>
        <if test="criteria.minValue != null">
            AND (evidence_data ->> 'value')::numeric >= #{criteria.minValue}
        </if>
    </where>
    ORDER BY signal_time DESC
</select>
```

**PostgreSQL æ‰¹æ¬¡æ’å…¥**:
```xml
<insert id="batchInsertSignals">
    INSERT INTO signals (signal_uuid, stock_id, signal_type, evidence_data)
    VALUES
    <foreach collection="signals" item="signal" separator=",">
        (#{signal.signalUuid}, #{signal.stockId}, #{signal.signalType},
         #{signal.evidenceData, typeHandler=org.apache.ibatis.type.JsonTypeHandler}::jsonb)
    </foreach>
    ON CONFLICT (signal_uuid) DO UPDATE SET
        updated_at = CURRENT_TIMESTAMP
</insert>
```

---

### 3.3 JPA vs MyBatis é¸æ“‡æ±ºç­–è¡¨

| å ´æ™¯ | ä½¿ç”¨ JPA | ä½¿ç”¨ MyBatis | ç†ç”± |
|-----|---------|-------------|------|
| å–®è¡¨ CRUD | âœ… | âŒ | JPA æ›´ç°¡æ½” |
| ç°¡å–®æ¢ä»¶æŸ¥è©¢ | âœ… | âŒ | æ–¹æ³•å‘½åå³å¯ |
| è¤‡é›œ JOIN | âŒ | âœ… | MyBatis SQL æ›´ç›´è§€ |
| å‹•æ…‹æ¢ä»¶æŸ¥è©¢ | âŒ | âœ… | MyBatis å‹•æ…‹ SQL æ›´éˆæ´» |
| æ‰¹æ¬¡æ’å…¥/æ›´æ–° | âŒ | âœ… | MyBatis æ•ˆèƒ½æ›´å¥½ |
| JSONB è¤‡é›œæŸ¥è©¢ | âŒ | âœ… | MyBatis æ”¯æ´åŸç”Ÿ SQL |
| åˆ†é æŸ¥è©¢ | âœ… | âœ… | å…©è€…çš†å¯ |
| çµ±è¨ˆèšåˆ | âŒ | âœ… | MyBatis æ›´é©åˆ |

---

### 3.4 äº‹å‹™ç®¡ç†

**JPA å’Œ MyBatis å…±ç”¨åŒä¸€å€‹äº‹å‹™ç®¡ç†å™¨**:

```java
@Service
@Transactional
public class MixedService {
    
    @Autowired
    private StockRepository stockRepository;  // JPA
    
    @Autowired
    private SignalMapper signalMapper;  // MyBatis
    
    public void mixedOperation() {
        // JPA æ“ä½œ
        Stock stock = stockRepository.findById(stockId).orElseThrow();
        stock.setUpdatedAt(LocalDateTime.now());
        stockRepository.save(stock);
        
        // MyBatis æ“ä½œï¼ˆåŒä¸€äº‹å‹™ï¼‰
        signalMapper.updateRelatedData(stockId);
        
        // è‹¥ä»»ä¸€æ“ä½œå¤±æ•—ï¼Œæ•´é«”å›æ»¾
    }
}
```

---

## 4. Git è¦ç¯„

### 4.1 åˆ†æ”¯ç­–ç•¥

#### 4.1.1 ä¸»è¦åˆ†æ”¯

| åˆ†æ”¯ | ç”¨é€” | èªªæ˜ |
|-----|------|------|
| **main** | ç”Ÿç”¢ç’°å¢ƒåˆ†æ”¯ | æ°¸é ä¿æŒç©©å®šï¼Œåªæ¥å— merge |
| **develop** | é–‹ç™¼ä¸»åˆ†æ”¯ | æ•´åˆæ‰€æœ‰åŠŸèƒ½ |

#### 4.1.2 è‡¨æ™‚åˆ†æ”¯

| åˆ†æ”¯é¡å‹ | å‘½åæ ¼å¼ | ç¯„ä¾‹ |
|---------|---------|------|
| **åŠŸèƒ½é–‹ç™¼** | `feature/<feature-name>` | `feature/m07-macd-indicator` |
| **Bug ä¿®å¾©** | `bugfix/<bug-description>` | `bugfix/fix-price-validation` |
| **ç·Šæ€¥ä¿®å¾©** | `hotfix/<issue-description>` | `hotfix/critical-db-connection-issue` |
| **ç™¼å¸ƒæº–å‚™** | `release/<version>` | `release/v1.0.0` |

---

### 4.2 Commit Message è¦ç¯„

#### 4.2.1 æ ¼å¼

```
<type>(<scope>): <subject>

<body>

<footer>
```

#### 4.2.2 Type é¡å‹

| Type | èªªæ˜ | ç¯„ä¾‹ |
|------|------|------|
| **feat** | æ–°åŠŸèƒ½ | `feat(M07): æ–°å¢ MACD æŒ‡æ¨™è¨ˆç®—åŠŸèƒ½` |
| **fix** | Bug ä¿®å¾© | `fix(M13): ä¿®æ­£ä¿¡è™Ÿå»é‡é‚è¼¯éŒ¯èª¤` |
| **docs** | æ–‡ä»¶ä¿®æ”¹ | `docs: æ›´æ–° API æ–‡æª”` |
| **style** | ç¨‹å¼ç¢¼æ ¼å¼ | `style: æ ¼å¼åŒ–ç¨‹å¼ç¢¼` |
| **refactor** | é‡æ§‹ | `refactor(M07): é‡æ§‹æŒ‡æ¨™è¨ˆç®—é‚è¼¯` |
| **test** | æ¸¬è©¦ç›¸é—œ | `test(M07): æ–°å¢ MACD å–®å…ƒæ¸¬è©¦` |
| **chore** | å»ºç½®å·¥å…·ã€ä¾è³´æ›´æ–° | `chore: å‡ç´š Spring Boot è‡³ 3.2.1` |

#### 4.2.3 ç¯„ä¾‹

```
feat(M07): æ–°å¢ MACD æŒ‡æ¨™è¨ˆç®—åŠŸèƒ½

å¯¦ä½œ MACD æŒ‡æ¨™è¨ˆç®—é‚è¼¯ï¼ŒåŒ…å«ï¼š
- MACD ç·šè¨ˆç®—
- Signal ç·šè¨ˆç®—
- æŸ±ç‹€åœ–è¨ˆç®—

Issue #123
```

```
fix(M13): ä¿®æ­£ä¿¡è™Ÿå»é‡é‚è¼¯éŒ¯èª¤

ä¿®æ­£ signal_uuid ç”Ÿæˆæ™‚æœªåŒ…å« signal_name çš„å•é¡Œï¼Œ
å°è‡´ä¸åŒä¿¡è™Ÿè¢«èª¤åˆ¤ç‚ºé‡è¤‡

Issue #456
```

---

### 4.3 Pull Request è¦ç¯„

**PR æ¨™é¡Œ**: èˆ‡ Commit Message æ ¼å¼ç›¸åŒ

**PR æè¿°**:
```markdown
## è®Šæ›´èªªæ˜
ç°¡çŸ­æè¿°é€™å€‹ PR åšäº†ä»€éº¼

## è®Šæ›´å…§å®¹
- æ–°å¢ XXX åŠŸèƒ½
- ä¿®æ”¹ YYY é‚è¼¯
- åˆªé™¤ ZZZ å†—é¤˜ç¨‹å¼ç¢¼

## æ¸¬è©¦
- [ ] å–®å…ƒæ¸¬è©¦é€šé
- [ ] æ•´åˆæ¸¬è©¦é€šé
- [ ] æ‰‹å‹•æ¸¬è©¦é€šé

## ç›¸é—œ Issue
Closes #123
```

---

## 5. æ¸¬è©¦è¦ç¯„

### 5.1 æ¸¬è©¦å‘½åè¦ç¯„

**æ¸¬è©¦é¡åˆ¥å‘½å**:
```
{ClassName}Test

ç¯„ä¾‹:
StockServiceTest
SignalServiceTest
IndicatorServiceTest
```

**æ¸¬è©¦æ–¹æ³•å‘½å**:
```
test{MethodName}_{Scenario}_should{ExpectedResult}

ç¯„ä¾‹:
testGetStockById_WithValidId_shouldReturnStock()
testGetStockById_WithInvalidId_shouldThrowNotFoundException()
testCalculateMACD_WithInsufficientData_shouldThrowException()
```

---

### 5.2 æ¸¬è©¦çµæ§‹ï¼ˆGiven-When-Thenï¼‰

```java
@Test
void testCalculateMACD_WithValidData_shouldReturnCorrectValue() {
    // Given: æº–å‚™æ¸¬è©¦è³‡æ–™
    String stockId = "2330";
    List<StockPrice> prices = prepareTestData();
    
    // When: åŸ·è¡Œæ¸¬è©¦æ–¹æ³•
    MACD result = indicatorService.calculateMACD(stockId, prices);
    
    // Then: é©—è­‰çµæœ
    assertNotNull(result);
    assertEquals(1.25, result.getMacdValue(), 0.01);
}
```

---

### 5.3 Mock ä½¿ç”¨

```java
@Mock
private StockRepository stockRepository;

@Mock
private SignalMapper signalMapper;

@InjectMocks
private StockService stockService;

@Test
void testGetStock() {
    // Given
    Stock mockStock = new Stock("2330", "å°ç©é›»");
    when(stockRepository.findById("2330")).thenReturn(Optional.of(mockStock));
    
    // When
    Stock result = stockService.getStock("2330");
    
    // Then
    assertEquals("2330", result.getStockId());
    verify(stockRepository, times(1)).findById("2330");
}
```

---

## 6. API è¨­è¨ˆè¦ç¯„

API è¨­è¨ˆè¦ç¯„è©³è¦‹ [API çµ±ä¸€è¦ç¯„](00-å…¨ç³»çµ±å¥‘ç´„.md#44-api-çµ±ä¸€è¦ç¯„)

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [å…¨ç³»çµ±å¥‘ç´„](00-å…¨ç³»çµ±å¥‘ç´„.md) - Signal Contractã€API è¦ç¯„
- [æŠ€è¡“æ¶æ§‹](00-æŠ€è¡“æ¶æ§‹.md) - æŠ€è¡“é¸å‹ã€éƒ¨ç½²æ¶æ§‹
- [NFR éåŠŸèƒ½æ€§éœ€æ±‚](00-NFRéåŠŸèƒ½æ€§éœ€æ±‚.md)

---

**æ–‡ä»¶ç¶­è­·è€…**: æŠ€è¡“ä¸»ç®¡  
**æœ€å¾Œæ›´æ–°**: 2025-12-31  
**ä¸‹æ¬¡å¯©æ ¸**: 2026-01-31
