# 📚 文件製作指南

> **文件編號**: DOC-GUIDE-00  
> **文件名稱**: 總綱使用說明與模組文件製作原則  
> **版本**: v2.0  
> **最後更新**: 2025-12-31  
> **狀態**: Draft

---

## 📑 目錄

1. [總綱使用說明](#1-總綱使用說明)
2. [模組文件製作原則](#2-模組文件製作原則)
3. [文件撰寫風格](#3-文件撰寫風格)
4. [常見錯誤與檢查清單](#4-常見錯誤與檢查清單)

---

## 1. 總綱使用說明

### 1.1 總綱是什麼？

**總綱（DOC-00-MASTER）是系統的「憲法」**，定義了：
- ✅ 全系統共用的契約與規範
- ✅ 跨模組的介面標準
- ✅ 技術架構與選型決策
- ✅ 非功能性需求（效能、安全、可用性）

---

### 1.2 總綱與模組文件的關係

```
┌─────────────────────────────────────┐
│         總綱（DOC-00-MASTER）        │
│                                     │
│  定義全系統規則：                    │
│  - Signal Contract                  │
│  - API 統一規範                      │
│  - Job 模型                          │
│  - 資料品質規範                      │
│  - 錯誤碼規範                        │
│  - RBAC 權限模型                     │
└─────────────────────────────────────┘
                  ↓
            【必須遵守】
                  ↓
        ┌─────────┴──────────┐
        ↓                    ↓
┌───────────────┐    ┌───────────────┐
│ 模組文件 M06   │    │ 模組文件 M07   │
│ - 實作細節     │    │ - 實作細節     │
│ - 資料表設計   │    │ - 指標計算邏輯 │
│ - API 端點     │    │ - API 端點     │
└───────────────┘    └───────────────┘
```

**核心原則**:
- **總綱定義規則，模組遵守規則**
- **模組文件不重複定義總綱的契約**
- **模組文件專注於「如何實作」，不解釋「為什麼選擇」**

---

### 1.3 總綱的核心章節

#### ⭐⭐⭐ 全系統契約（最重要）

**所有模組必須遵守的契約**：

| 契約名稱 | 說明 | 參照文檔 | 適用模組 |
|---------|------|---------|---------|
| **Signal Contract** | 統一信號格式 | [00-全系統契約.md](../specs/technical/00-全系統契約.md#2-signal-contract統一信號資料模型) | M07, M08, M09, M10, M11, M12 |
| **API 統一規範** | Request/Response 格式、錯誤碼 | [00-全系統契約.md](../specs/technical/00-全系統契約.md#4-api-統一規範) | 所有模組 |
| **Job 模型** | Job 結構、冪等性、重試 | [00-全系統契約.md](../specs/technical/00-全系統契約.md#5-job-模型規範) | M06, M07, M08, M09, M12 |
| **資料品質規範** | 驗證規則、檢核流程 | [00-全系統契約.md](../specs/technical/00-全系統契約.md#7-資料品質規範) | M06 |
| **RBAC 權限模型** | 角色、權限、資源 | [00-全系統契約.md](../specs/technical/00-全系統契約.md#6-rbac-權限模型) | 所有模組 |

**使用方式**:
1. 設計 API → 參照 API 統一規範
2. 產生信號 → 參照 Signal Contract
3. 設計 Job → 參照 Job 模型
4. 驗證資料 → 參照資料品質規範

---

### 1.4 如何正確使用總綱

#### ✅ 正確方式

**場景 1: 設計 API**
```
1. 閱讀 00-全系統契約.md 的 API 統一規範
2. 在模組文件中設計具體 API 端點
3. Response 格式寫：「遵守全系統契約的 API 統一規範」
```

**場景 2: 產生信號**
```
1. 閱讀 00-全系統契約.md 的 Signal Contract
2. 在模組文件中設計信號產生邏輯
3. 信號格式寫：「遵守全系統契約的 Signal Contract」
```

**場景 3: 設計 Job**
```
1. 閱讀 00-全系統契約.md 的 Job 模型
2. 在模組文件中設計 Job 執行流程
3. 冪等性設計遵守全系統契約要求
```

---

#### ❌ 錯誤方式

**錯誤 1: 在模組文件中重新定義 API 格式**
```
❌ 錯誤:
「本模組的 API Response 格式為：
{
  "success": true,
  "data": {...}
}」

✅ 正確:
「API Response 遵守全系統契約的 API 統一規範」
```

**錯誤 2: 不遵守 Signal Contract**
```
❌ 錯誤:
自行定義信號格式 {type: "buy", ...}

✅ 正確:
遵守全系統契約的 Signal Contract 格式
```

**錯誤 3: 解釋技術選型**
```
❌ 錯誤:
「為什麼選擇 PostgreSQL 而不是 MySQL...（長篇大論）」

✅ 正確:
直接使用 PostgreSQL，不需解釋選型理由
```

---

## 2. 模組文件製作原則

### 2.1 模組文件的定位

**模組文件是 SA/SD 文件，專注於設計**：

| 應該包含 ✅ | 不應該包含 ❌ |
|-----------|-------------|
| 模組功能說明 | 技術選型解釋 |
| 資料表設計（完整 DDL） | 完整 Java 程式碼 |
| 業務邏輯步驟（文字） | Service 實作程式碼 |
| API 規格（JSON 範例） | Controller 實作程式碼 |
| Job 執行流程（文字） | 重複總綱的契約定義 |
| 流程圖（ASCII 圖） | 個人意見或推測 |

---

### 2.2 標準文件結構（10 章節）

| 章節 | 內容 | 核心重點 |
|-----|------|---------|
| **1. 模組概述** | 定位、目標、範圍、依賴 | 說明模組的角色與邊界 |
| **2. 功能需求** | 功能清單、用例、業務規則 | 詳細的功能說明 |
| **3. 資料設計** | 資料表 DDL、索引、關聯 | ⭐ 完整的資料庫設計 |
| **4. API 設計** | API 端點、Request/Response | ⭐ 遵守 API 統一規範 |
| **5. 資料流設計** | 流程圖、時序圖 | ASCII 圖或文字描述 |
| **6. Job/排程設計** | Job 清單、Cron、冪等性 | ⭐ 遵守 Job 模型 |
| **7. 業務邏輯設計** | Service 架構、演算法 | 文字描述，無程式碼 |
| **8. 整合點** | 上下游依賴、事件發布 | 模組間介面 |
| **9. 效能考量** | 效能目標、優化策略 | 參照 NFR |
| **10. 測試準則** | 測試場景、覆蓋率 | 單元測試、整合測試 |

---

### 2.3 各章節撰寫要點

#### 第 1 章：模組概述

**包含內容**:
- 模組在系統中的定位（Layer 1/2/3）
- 模組目標（3-5 條）
- 功能範圍（包含 vs 不包含）
- 依賴關係（上游、下游、外部）

**範例**:
```markdown
### 1.1 模組定位
[模組名稱]是整個系統的 Layer [X]，負責：
- 功能 A
- 功能 B
- 功能 C

### 1.4 依賴關係
**上游依賴**: [模組清單]
**下游依賴**: [模組清單]
**外部依賴**: [外部系統清單]
```

---

#### 第 2 章：功能需求

**包含內容**:
- 功能清單表（編號、名稱、優先級、持久層）
- 3-5 個核心用例說明
- 業務規則（參照總綱規範）

**用例格式**:
```markdown
#### UC-M[XX]-001: [用例名稱]

**參與者**: [角色]
**前置條件**: [條件]
**主要流程**:
1. 步驟 1
2. 步驟 2
3. ...

**後置條件**: [結果]
**替代流程**: 
- 1a. 異常情況 → 處理方式
```

---

#### 第 3 章：資料設計 ⭐

**包含內容**:
- 資料表清單
- **完整的 DDL**（CREATE TABLE）
- 索引設計
- PostgreSQL 特殊功能說明

**重要**: 這是模組文件最重要的產出之一！

**DDL 範例**:
```sql
-- PostgreSQL 建表語法
CREATE TABLE [表名] (
    id              BIGSERIAL PRIMARY KEY,
    [欄位名]         [型態] [約束],
    
    -- PostgreSQL 特殊型態
    tags            TEXT[] DEFAULT '{}',      -- 陣列
    extra_info      JSONB DEFAULT '{}',       -- JSONB
    
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_[表名]_[欄位] ON [表名]([欄位]);

-- GIN 索引（JSONB、陣列）
CREATE INDEX gin_[表名]_jsonb ON [表名] USING GIN(jsonb_column);

-- 註釋
COMMENT ON TABLE [表名] IS '表說明';
COMMENT ON COLUMN [表名].[欄位名] IS '欄位說明';
```

**資料關聯圖範例**:
```
┌──────────────┐
│   [主表]      │ ← 主表說明（1）
└──────────────┘
       │
       ├──────────────→ [關聯表1] (1:N)
       │                - 特性說明
       │                - 索引說明
       │
       ├──────────────→ [關聯表2] (1:N)
       │                - 特性說明
       │
       └──────────────→ [關聯表3] (1:N)
                        - 特性說明

[獨立表] (無外鍵關聯)
```

---

**JPA vs MyBatis 使用場景範例**:

| 資料表 | 簡單 CRUD | 複雜查詢 | 批次操作 | 統計查詢 |
|-------|----------|---------|---------|---------|
| [表1] | JPA | JPA | JPA | JPA |
| [表2] | JPA | MyBatis | **MyBatis** | **MyBatis** |
| [表3] | JPA | **MyBatis** | **MyBatis** | **MyBatis** |

**使用原則**:
- **JPA**: 單筆查詢、簡單條件、關聯查詢
- **MyBatis**: 批次 UPSERT、複雜動態 SQL、JSONB 查詢、統計分析

**判斷標準**:
- JSONB 欄位查詢 → MyBatis
- 批次操作（>10 筆）→ MyBatis
- 複雜 JOIN、子查詢 → MyBatis
- 簡單 CRUD → JPA
- 分頁查詢 → JPA（使用 Spring Data JPA Pageable）

---

#### 第 4 章：API 設計 ⭐

**包含內容**:
- API 列表總覽
- 3-5 個核心 API 的詳細規格
- Request/Response 範例（JSON）
- 錯誤碼定義

**重要**: Response 格式必須遵守 API 統一規範！

**API 範例**:
```markdown
#### API-M[XX]-001: [API 名稱]

**Endpoint**: `GET /api/[resource]`

**Query Parameters**:
| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| param1 | String | Y | 說明 |

**Response** (遵守 API 統一規範):
```json
{
  "success": true,
  "timestamp": "2025-12-31T10:30:00+08:00",
  "data": { ... },
  "error": null
}
```

**錯誤碼**:
| 錯誤碼 | HTTP Status | 說明 |
|-------|------------|------|
| M[XX]_ERROR_001 | 404 | 說明 |
```

**❌ 不要寫 Controller 程式碼！**

---

#### 第 5 章：資料流設計

**包含內容**:
- 資料流總覽（ASCII 圖）
- 2-3 個核心流程圖

**流程圖範例**:
```
START: [流程名稱]
  ↓
1. 步驟 1
   ├─ 條件 A → 處理 A
   └─ 條件 B → 處理 B
  ↓
2. 步驟 2
  ↓
3. 步驟 3
  ↓
END
```

---

#### 第 6 章：Job/排程設計 ⭐

**包含內容**:
- Job 清單（編號、名稱、頻率、優先級）
- 2-3 個核心 Job 的詳細設計
- Cron 表達式
- **冪等性設計**（遵守 Job 模型）

**重要**: 所有 Job 必須具備冪等性！

**Job 範例**:
```markdown
#### JOB-M[XX]-001: [Job 名稱]

**Cron 表達式**: `0 0 15 * * MON-FRI`

**執行邏輯**:
1. 步驟 1
2. 步驟 2
3. ...

**冪等性設計**（遵守 Job 模型）:
- 使用唯一鍵確保不重複
- 重複執行結果一致

**失敗處理**:
- 重試機制
- 失敗告警
```

---

#### 第 7 章：業務邏輯設計

**包含內容**:
- Service 層架構（文字描述）
- 資料處理邏輯（步驟說明）
- 驗證邏輯（規則說明）

**重要**: 本章**只用文字描述，不寫程式碼**！

**範例**:
```markdown
### 7.1 Service 層架構

[主 Service 名稱]
    │
    ├─→ [子 Service 1]
    │       ├─ 職責: [說明]
    │       ├─ 依賴: [Repository/Mapper]
    │       └─ 核心方法: [方法名](參數)
    │
    ├─→ [子 Service 2]
    │       └─ ...

### 7.2 [邏輯名稱]

**步驟**:
1. 步驟 1 說明
2. 步驟 2 說明
3. ...

**驗證規則**:
- 規則 1: [說明]
- 規則 2: [說明]
```

**❌ 不要寫 Service 實作程式碼！**

---

#### 第 8 章：整合點

**包含內容**:
- 外部系統依賴
- 對內部模組的提供
- 事件發布

**範例**:
```markdown
### 8.1 對外部系統的依賴

| 外部系統 | 用途 | 協議 | 限制 |
|---------|------|------|------|
| [系統名] | [用途] | REST | [限制] |

### 8.2 對內部模組的提供

| 下游模組 | 使用的 API | 呼叫頻率 |
|---------|-----------|---------|
| M[XX] | GET /api/... | [頻率] |

### 8.3 事件發布

| 事件名稱 | 觸發條件 | 訂閱者 |
|---------|---------|-------|
| [Event名] | [條件] | M[XX], M[YY] |
```

---

#### 第 9 章：效能考量

**包含內容**:
- 效能目標（參照 NFR）
- 資料庫優化策略
- 快取優化策略
- 容量規劃

**範例**:
```markdown
### 9.1 效能目標

| 指標 | 目標值 |
|-----|-------|
| API 回應時間 | P95 < [X]ms |
| Job 執行時間 | < [X] 分鐘 |

### 9.2 優化策略

**資料庫優化**:
- 索引策略
- 查詢優化
- 分區策略（如適用）

**快取優化**:
- Key 設計: [pattern]
- TTL 設定: [時間]
```

---

#### 第 10 章：測試準則

**包含內容**:
- 單元測試場景
- 整合測試場景
- 測試覆蓋率目標

**範例**:
```markdown
### 10.1 單元測試

**測試場景**:
- 場景 1: [說明]
- 場景 2: [說明]

**測試範例**:
```
測試: [測試名稱]
Given: [前置條件]
When: [執行動作]
Then: [預期結果]
```

### 10.2 測試覆蓋率目標

| 層級 | 覆蓋率目標 |
|-----|----------|
| Repository | > 90% |
| Service | > 80% |
| Controller | > 70% |
```

---

## 3. 文件撰寫風格

### 3.1 語言風格

**原則**:
- ✅ 使用**繁體中文**為主
- ✅ 專有名詞使用英文（API、CRUD、Job）
- ✅ 保持專業、簡潔、清晰

**範例**:
```markdown
✅ 正確: 使用 PostgreSQL 的 JSONB 型態儲存資料
❌ 錯誤: 用 PostgreSQL 的 JSONB type 來 store data
```

---

### 3.2 描述風格

**原則**:
- ✅ 使用主動語態
- ✅ 使用條列式（適度）
- ✅ 避免冗長段落
- ✅ 重點使用粗體

**範例**:
```markdown
✅ 正確:
系統每日執行以下步驟：
1. 檢查條件
2. 執行處理
3. 記錄結果

❌ 錯誤:
當系統的時間到達的時候，就會開始執行一系列的處理...（冗長）
```

---

### 3.3 流程圖風格

**使用 ASCII 圖**:
```
START
  ↓
步驟 1
  ↓
判斷
├─ 是 → 步驟 2
└─ 否 → END
  ↓
END
```

---

### 3.4 避免的內容

**❌ 不要寫**:
1. 完整的 Java 程式碼（20+ 行）
2. 技術選型的解釋（已在總綱）
3. 重複總綱的契約定義
4. 個人意見或推測

**✅ 應該寫**:
1. 設計概念與架構
2. 業務邏輯步驟
3. 資料結構定義（DDL）
4. API 規格（JSON）
5. 流程圖（ASCII）

---

## 4. 常見錯誤與檢查清單

### 4.1 常見錯誤

#### 錯誤 1: 在模組文件中解釋技術選型 ❌

```markdown
❌ 錯誤:
「我們選擇 PostgreSQL 的原因是...
相較於 MySQL，PostgreSQL 有以下優勢...（長篇大論）」

✅ 正確:
「使用 PostgreSQL 的 JSONB 型態儲存資料」
（不需解釋為什麼選 PostgreSQL）
```

---

#### 錯誤 2: 寫完整的程式碼實作 ❌

```markdown
❌ 錯誤:
@Service
public class XXXService {
    @Autowired
    private XXXRepository repository;
    
    public void method() {
        // 50 行程式碼
    }
}

✅ 正確:
XXXService
├─ 職責: [說明]
├─ 依賴: XXXRepository (JPA)
└─ 核心方法: method()
    執行步驟:
    1. 步驟 1
    2. 步驟 2
```

---

#### 錯誤 3: 重複定義總綱契約 ❌

```markdown
❌ 錯誤:
「本模組的 API Response 格式定義如下：
{
  "success": true,
  "data": {...}
}」

✅ 正確:
「API Response 遵守 API 統一規範」
```

---

#### 錯誤 4: 不遵守 10 章節結構 ❌

```markdown
❌ 錯誤:
自己定義章節結構，如：
1. 簡介
2. 設計
3. 實作
4. 測試

✅ 正確:
遵守標準 10 章節結構
```

---

### 4.2 撰寫檢查清單

#### 開始撰寫前 ✓
- [ ] 閱讀完整總綱
- [ ] 理解全系統契約
- [ ] 了解模組的上下游依賴
- [ ] 確認 JPA vs MyBatis 使用場景

#### 撰寫時 ✓
- [ ] 遵守標準 10 章節結構
- [ ] 第 3 章有完整 DDL
- [ ] 第 4 章 API 遵守 API 統一規範
- [ ] 第 6 章 Job 遵守 Job 模型（冪等性）
- [ ] 第 7 章只有文字，無程式碼
- [ ] 流程圖使用 ASCII 圖或文字

#### 撰寫後 ✓
- [ ] 檢查是否重複總綱內容
- [ ] 檢查是否有過多程式碼
- [ ] 檢查是否解釋技術選型
- [ ] 檢查表格格式正確
- [ ] 檢查章節編號連續

---

### 4.3 審核標準

| 項目 | 說明 | 權重 |
|-----|------|------|
| **完整性** | 10 章節完整 | 20% |
| **正確性** | 技術描述正確 | 20% |
| **一致性** | 遵守總綱契約 | 30% |
| **清晰度** | 易讀易懂 | 20% |
| **格式** | Markdown 格式正確 | 10% |

**審核結果**:
- ✅ **通過**: 可以開始開發
- 🔄 **修改**: 需要調整後再審核
- ❌ **退回**: 重大問題，需重寫

---

### 4.4 文件規模參考

**標準模組文件規模**:
- **總字數**: 15,000 - 20,000 字
- **上半部（第 1-5 章）**: 8,000 - 10,000 字
- **下半部（第 6-10 章）**: 7,000 - 10,000 字

**核心產出**:
- DDL: 3-10 個資料表
- API: 5-10 個端點
- Job: 3-8 個排程
- 流程圖: 3-5 個
- 用例: 3-5 個

---

## 附錄

### A. 快速參考

**核心契約文檔**:
- Signal Contract → 信號必須遵守
- API 統一規範 → API 必須遵守
- Job 模型 → Job 必須遵守（冪等性）
- 資料品質規範 → 驗證規則

**模組文件必備產出**:
- ⭐ 第 3 章: 完整 DDL
- ⭐ 第 4 章: API 規格（遵守 API 統一規範）
- ⭐ 第 6 章: Job 設計（遵守 Job 模型）
- ⭐ 第 7 章: 業務邏輯（文字，無程式碼）

**JPA vs MyBatis 原則**:
- 簡單 CRUD → JPA
- 複雜查詢、批次操作、JSONB 查詢 → MyBatis

---

### B. 文件命名規範

| 文件類型 | 命名格式 |
|---------|---------|
| 總綱 | `00-總綱_v{版本}.md` |
| 模組文件 | `DOC-{序號}-M{模組編號}-{模組名稱}_v{版本}.md` |
| 指引文件 | `DOC-00-{名稱}.md` |

**範例**:
- `00-總綱_v02.md`
- `DOC-01-M06-資料管理模組_v2.0.md`
- `DOC-00-GUIDE.md`

---

### C. 重要提醒

#### ⚠️ 模組文件的核心目的

**SA/SD 文件是設計文件，不是程式碼文件！**

目的是：
1. 說明**設計思路**
2. 定義**資料結構**（DDL）
3. 定義**介面規格**（API）
4. 說明**業務流程**（流程圖）

不是為了：
1. ❌ 教人怎麼寫程式
2. ❌ 展示程式碼技巧
3. ❌ 解釋技術選型理由

---

## 📚 相關文檔

- [00-全系統契約](../specs/technical/00-全系統契約.md)
- [00-技術架構](../specs/technical/00-技術架構.md)
- [00-開發準則](../specs/technical/00-開發準則.md)
- [00-NFR非功能性需求](../specs/technical/00-NFR非功能性需求.md)

---

**祝文件撰寫順利！📝**

**文件維護者**: 文件管理員  
**最後更新**: 2025-12-31  
**下次審核**: 2026-01-31
