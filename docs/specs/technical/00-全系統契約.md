# 📜 全系統契約

> **文件編號**: DOC-SPEC-TECH-00  
> **文件名稱**: 全系統契約 (System-Wide Contracts)  
> **版本**: v2.0  
> **最後更新**: 2025-12-31  
> **重要性**: ⭐⭐⭐⭐⭐ 核心契約，所有模組必須遵守

---

## ⚠️ 重要說明

**本文檔定義所有模組必須遵守的共用規則與標準，確保系統整體一致性。**

違反這些契約將導致：
- ❌ 模組無法正確整合
- ❌ 資料無法統一處理
- ❌ 系統架構混亂
- ❌ 後續維護困難

---

## 📑 目錄

1. [資料流總覽](#1-資料流總覽)
2. [Signal Contract（統一信號資料模型）](#2-signal-contract統一信號資料模型) ⭐
3. [持久層架構設計](#3-持久層架構設計)
4. [API 統一規範](#4-api-統一規範)
5. [Job 模型規範](#5-job-模型規範)
6. [RBAC 權限模型](#6-rbac-權限模型)
7. [資料品質規範](#7-資料品質規範)

---

## 1. 資料流總覽

### 1.1 整體架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                     外部資料來源                              │
│  Yahoo Finance / 證交所 / 公開資訊觀測站 / FinMind           │
└─────────────────────────────────────────────────────────────┘
                              ↓
                    [資料管理模組 M06]
                    - 資料獲取 (Fetch)
                    - 資料清洗 (Clean)
                    - 資料驗證 (Validate)
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      資料儲存層                               │
│  PostgreSQL: stocks, stock_prices, financial_data, chip_data│
│  - 使用 JSONB 儲存複雜結構化資料                             │
│  - 支援 GIN 索引提升 JSON 查詢效能                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┴─────────────────────┐
        ↓                     ↓                     ↓
   [技術分析 M07]        [基本面 M08]         [籌碼分析 M09]
   [型態辨識 M10]        [量化策略 M11]       [總經產業 M12]
   - JPA: 簡單 CRUD      - JPA: 基礎操作      - JPA: 基礎操作
   - MyBatis: 複雜計算   - MyBatis: 財報查詢  - MyBatis: 籌碼分析
        │                     │                     │
        └─────────────────────┬─────────────────────┘
                              ↓
                    [信號判斷引擎 M13]
                    - 信號生成
                    - 信號去重
                    - 信號合併
                    - 信號評分
                    - MyBatis: 複雜信號查詢
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     信號儲存與索引                            │
│         PostgreSQL: signals (統一 Signal Contract)          │
│         - JSONB 欄位儲存證據資料（evidence_data）            │
│              Redis: 信號快取、去重快取                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┴─────────────────────┐
        ↓                                           ↓
   [選股引擎 M14]                          [警報通知系統 M15]
   - 條件篩選                               - 條件匹配
   - 策略執行                               - 通知發送
   - 排序排名                               - 頻率控制
   - MyBatis: 複雜多條件篩選                - JPA: 基礎 CRUD
        ↓                                           ↓
   [回測系統 M16]                          [通知渠道]
   [風險管理 M17]                          LINE / Email / Telegram
   [投資組合 M18]                          WebSocket / Discord
   - MyBatis: 複雜統計查詢                  
        ↓                                           ↓
┌─────────────────────────────────────────────────────────────┐
│                        前端介面                               │
│              Web Dashboard / Mobile App                      │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 關鍵資料流路徑

| 路徑 | 說明 | 流程 |
|------|------|------|
| **資料入庫** | 外部資料進入系統 | 外部 API → M06 → PostgreSQL/Redis |
| **指標計算** | 技術/基本面指標運算 | 資料庫 → 各分析模組 → 指標表 → Redis 快取 |
| **信號生成** | 產生買賣信號 | 指標/型態 → M13 → signals 表 → 通知/選股 |
| **查詢路徑** | 前端查詢資料 | 前端 → API → 快取/資料庫 → 回應 |

---

## 2. Signal Contract（統一信號資料模型）⭐

> **設計原則**: 所有模組產生的信號必須遵守統一的資料結構，以便於去重、合併、評分、追溯。

### 2.1 為什麼需要 Signal Contract？

#### ❌ 沒有統一格式的問題

```
├── 技術分析模組: 自己的信號表 technical_signals
├── 基本面模組: 自己的信號表 fundamental_signals  
├── 籌碼模組: 自己的信號表 chip_signals
└── 結果: 
    - 無法整合
    - 無法去重
    - 無法統一評分
    - 無法追蹤來源
```

#### ✅ 使用 Signal Contract

```
所有信號存入統一的 signals 表
├── 用 signal_source 區分來源（TECHNICAL/FUNDAMENTAL/CHIP）
├── 用 JSONB 儲存模組特定資料
└── 結果: 
    - 可以去重
    - 可以合併
    - 可以統一評分
    - 可以追溯來源
```

---

### 2.2 資料庫 Schema

#### 2.2.1 完整建表語法

```sql
-- PostgreSQL 建表語法
CREATE TABLE signals (
    -- ========== 主鍵與識別 ==========
    signal_id           BIGSERIAL PRIMARY KEY,
    signal_uuid         VARCHAR(36) NOT NULL UNIQUE,
    
    -- ========== 股票資訊 ==========
    stock_id            VARCHAR(10) NOT NULL,
    stock_name          VARCHAR(50),
    
    -- ========== 信號基本資訊 ==========
    signal_type         VARCHAR(10) NOT NULL 
        CHECK (signal_type IN ('BUY', 'SELL', 'HOLD')),
    signal_source       VARCHAR(50) NOT NULL,
    signal_name         VARCHAR(100) NOT NULL,
    signal_category     VARCHAR(50),
    
    -- ========== 信號強度與評分 ==========
    signal_strength     NUMERIC(5,2),    -- 0.00 ~ 100.00
    confidence_score    NUMERIC(5,2),    -- 0.00 ~ 100.00
    
    -- ========== 價格資訊 ==========
    trigger_price       NUMERIC(10,2),   -- 觸發價格
    current_price       NUMERIC(10,2),   -- 當前價格
    target_price        NUMERIC(10,2),   -- 目標價格
    stop_loss_price     NUMERIC(10,2),   -- 停損價格
    
    -- ========== 時間資訊 ==========
    signal_date         DATE NOT NULL,
    signal_time         TIMESTAMP NOT NULL,
    valid_until         TIMESTAMP,       -- 信號有效期限
    
    -- ========== 版本與追溯 ==========
    signal_version      INTEGER DEFAULT 1,
    parent_signal_id    BIGINT,
    is_merged           BOOLEAN DEFAULT FALSE,
    merge_count         INTEGER DEFAULT 1,
    
    -- ========== 證據與依據（JSONB） ==========
    evidence_data       JSONB,           -- 證據資料
    technical_factors   JSONB,           -- 技術因子
    fundamental_factors JSONB,           -- 基本面因子
    chip_factors        JSONB,           -- 籌碼因子
    
    -- ========== 狀態管理 ==========
    signal_status       VARCHAR(20) DEFAULT 'ACTIVE' 
        CHECK (signal_status IN ('ACTIVE', 'EXPIRED', 'TRIGGERED', 'CANCELLED')),
    is_notified         BOOLEAN DEFAULT FALSE,
    notification_count  INTEGER DEFAULT 0,
    
    -- ========== 審計欄位 ==========
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by          VARCHAR(50),
    
    -- ========== 外鍵約束 ==========
    CONSTRAINT fk_parent_signal 
        FOREIGN KEY (parent_signal_id) 
        REFERENCES signals(signal_id)
);

-- ========== 索引設計 ==========

-- 基礎索引
CREATE INDEX idx_signals_stock_date 
    ON signals(stock_id, signal_date);
CREATE INDEX idx_signals_signal_time 
    ON signals(signal_time);
CREATE INDEX idx_signals_source 
    ON signals(signal_source);
CREATE INDEX idx_signals_type_status 
    ON signals(signal_type, signal_status);
CREATE INDEX idx_signals_uuid 
    ON signals(signal_uuid);

-- JSONB 欄位的 GIN 索引（加速 JSON 查詢）
CREATE INDEX idx_signals_evidence_data 
    ON signals USING GIN (evidence_data);
CREATE INDEX idx_signals_technical_factors 
    ON signals USING GIN (technical_factors);
CREATE INDEX idx_signals_fundamental_factors 
    ON signals USING GIN (fundamental_factors);
CREATE INDEX idx_signals_chip_factors 
    ON signals USING GIN (chip_factors);

-- ========== 觸發器 ==========

-- 自動更新 updated_at 欄位
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_signals_updated_at
    BEFORE UPDATE ON signals
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- ========== 表註釋 ==========
COMMENT ON TABLE signals IS '統一信號表 - 所有模組產生的信號都存入此表';
COMMENT ON COLUMN signals.signal_id IS '信號ID（自增主鍵）';
COMMENT ON COLUMN signals.signal_uuid IS 'UUID，用於去重識別';
COMMENT ON COLUMN signals.stock_id IS '股票代碼（如 2330）';
COMMENT ON COLUMN signals.signal_source IS '信號來源模組（TECHNICAL/FUNDAMENTAL/CHIP等）';
COMMENT ON COLUMN signals.evidence_data IS '信號證據資料（JSONB格式，支援高效查詢）';
```

---

### 2.3 核心欄位說明

#### 2.3.1 必填欄位 ⭐

| 欄位名稱 | 類型 | 說明 | 範例 |
|---------|------|------|------|
| **signal_uuid** | VARCHAR(36) | UUID，用於去重 | `a1b2c3d4-e5f6-7890-...` |
| **stock_id** | VARCHAR(10) | 股票代碼 | `2330`, `0050` |
| **signal_type** | VARCHAR(10) | 信號類型 | `BUY`, `SELL`, `HOLD` |
| **signal_source** | VARCHAR(50) | 信號來源模組 | `TECHNICAL`, `FUNDAMENTAL` |
| **signal_name** | VARCHAR(100) | 信號名稱 | `MA_GOLDEN_CROSS`, `RSI_OVERSOLD` |
| **signal_date** | DATE | 信號日期 | `2025-12-31` |
| **signal_time** | TIMESTAMP | 信號時間 | `2025-12-31 14:30:00` |

#### 2.3.2 選填欄位

| 欄位名稱 | 類型 | 說明 | 使用時機 |
|---------|------|------|---------|
| **signal_category** | VARCHAR(50) | 信號類別 | 用於分類（如 TREND_FOLLOWING） |
| **signal_strength** | NUMERIC(5,2) | 信號強度 (0-100) | 有強度計算時填寫 |
| **confidence_score** | NUMERIC(5,2) | 信心分數 (0-100) | 有信心度計算時填寫 |
| **target_price** | NUMERIC(10,2) | 目標價 | 有價格預測時填寫 |
| **stop_loss_price** | NUMERIC(10,2) | 停損價 | 有停損建議時填寫 |
| **valid_until** | TIMESTAMP | 有效期限 | 信號有時效性時填寫 |

---

### 2.4 Signal Source 規範

#### 2.4.1 標準 Signal Source

| 模組 | Signal Source | 說明 | 範例 Signal Name |
|-----|--------------|------|------------------|
| **M07** 技術分析 | `TECHNICAL` | 技術指標產生的信號 | `MA_GOLDEN_CROSS`, `RSI_OVERSOLD`, `MACD_BULLISH_CROSS` |
| **M08** 基本面分析 | `FUNDAMENTAL` | 財務指標產生的信號 | `LOW_PE_RATIO`, `HIGH_ROE`, `PROFIT_GROWTH` |
| **M09** 籌碼分析 | `CHIP` | 籌碼變化產生的信號 | `INSTITUTIONAL_BUY`, `HIGH_CONCENTRATION` |
| **M10** 型態辨識 | `PATTERN` | 圖表型態產生的信號 | `HAMMER`, `HEAD_SHOULDER`, `DOUBLE_BOTTOM` |
| **M11** 量化策略 | `STRATEGY` | 策略執行產生的信號 | `MOMENTUM_BUY`, `MEAN_REVERSION` |
| **M12** 總經產業 | `MACRO` | 總經指標產生的信號 | `SECTOR_ROTATION`, `RATE_CUT_BENEFIT` |
| **M14** 選股引擎 | `SCREENER` | 篩選結果產生的信號 | `TOP_MOMENTUM_STOCKS`, `VALUE_PICKS` |

#### 2.4.2 Signal Name 命名規範

**格式**: `{指標名稱}_{觸發條件}`

**範例**:
```
✅ 正確命名:
- MA_GOLDEN_CROSS      (MA 黃金交叉)
- RSI_OVERSOLD         (RSI 超賣)
- MACD_BULLISH_CROSS   (MACD 多頭交叉)
- KD_OVERBOUGHT        (KD 超買)
- PE_RATIO_LOW         (本益比偏低)

❌ 錯誤命名:
- ma golden cross      (不用小寫)
- 均線黃金交叉          (不用中文)
- MAC                  (命名不清楚)
- rsi                  (太簡短)
```

---

### 2.5 Signal Category 分類

#### 2.5.1 技術面類別

```
TREND_FOLLOWING    趨勢跟隨
MOMENTUM           動能
REVERSAL           反轉
VOLUME             成交量
VOLATILITY         波動
```

#### 2.5.2 基本面類別

```
VALUATION          估值
PROFITABILITY      獲利能力
GROWTH             成長性
FINANCIAL_HEALTH   財務健康
DIVIDEND           股利
```

#### 2.5.3 籌碼面類別

```
INSTITUTIONAL      法人動向
MARGIN             融資融券
INSIDER            內部人持股
CONCENTRATION      籌碼集中
```

#### 2.5.4 型態類別

```
CANDLESTICK        K線型態
CHART_PATTERN      圖表型態
TREND_PATTERN      趨勢型態
```

---

### 2.6 JSONB 欄位結構

#### 2.6.1 evidence_data 範例

**技術指標信號**:
```json
{
  "indicator": "MACD",
  "macd_value": 1.25,
  "signal_line": 0.95,
  "histogram": 0.30,
  "condition": "MACD > Signal Line",
  "threshold": 0,
  "calculation_date": "2025-12-31"
}
```

**型態識別信號**:
```json
{
  "pattern_type": "HAMMER",
  "pattern_score": 85,
  "candle_count": 1,
  "body_ratio": 0.25,
  "shadow_ratio": 2.5,
  "location": "SUPPORT_LEVEL",
  "confirmation": true
}
```

**基本面信號**:
```json
{
  "metric": "PE_RATIO",
  "current_value": 12.5,
  "industry_average": 18.3,
  "percentile": 25,
  "trend": "IMPROVING",
  "period": "2024Q3"
}
```

#### 2.6.2 technical_factors 範例

```json
{
  "MA5": 125.50,
  "MA20": 120.30,
  "RSI": 45.20,
  "MACD": 1.25,
  "volume_ratio": 1.8,
  "trend": "BULLISH"
}
```

#### 2.6.3 fundamental_factors 範例

```json
{
  "PE_ratio": 15.5,
  "PB_ratio": 2.3,
  "ROE": 18.5,
  "EPS": 8.50,
  "revenue_growth": 0.12,
  "profit_margin": 0.15
}
```

#### 2.6.4 chip_factors 範例

```json
{
  "foreign_buy": 5000,
  "trust_buy": 2000,
  "dealer_buy": -1000,
  "margin_ratio": 0.25,
  "short_ratio": 0.05,
  "concentration": "HIGH"
}
```

---

### 2.7 信號去重規則

#### 2.7.1 去重鍵組合

```
去重鍵 = stock_id + signal_source + signal_name + signal_date
```

**含義**: 同一天、同一股票、同一來源、同一名稱的信號視為重複

#### 2.7.2 去重邏輯

1. 若出現重複，保留 `signal_strength` 較高的信號
2. 若強度相同，保留最新產生的信號（`signal_time` 較晚）
3. 被合併的信號會記錄 `parent_signal_id` 並設定 `is_merged = true`

#### 2.7.3 去重實作方式（PostgreSQL）

```sql
-- 方法 1: 使用 MD5 + ENCODE
SELECT ENCODE(
    DIGEST(
        CONCAT(stock_id, ':', signal_source, ':', signal_name, ':', signal_date),
        'md5'
    ),
    'hex'
) AS signal_uuid;

-- 方法 2: 使用 PostgreSQL 內建的 uuid_generate_v5（推薦）
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

SELECT uuid_generate_v5(
    uuid_ns_url(),
    CONCAT(stock_id, ':', signal_source, ':', signal_name, ':', signal_date)
) AS signal_uuid;
```

---

### 2.8 信號合併規則

#### 2.8.1 合併條件

當多個模組對同一股票在同一天產生相同方向的信號時，可以合併：

- 同一 `stock_id`
- 同一 `signal_date`
- 同一 `signal_type` (BUY/SELL)
- 不同 `signal_source` 或 `signal_name`

#### 2.8.2 合併後信號特徵

```
signal_name: "多重信號 (MULTIPLE_SIGNALS)"
signal_strength: 加權平均或取最大值
confidence_score: 綜合評分
is_merged: true
merge_count: 合併的信號數量
evidence_data: 包含所有來源信號的證據
```

#### 2.8.3 合併權重範例

```
技術面信號: 30%
基本面信號: 30%
籌碼面信號: 20%
型態信號: 20%
```

---

### 2.9 信號生命週期

#### 2.9.1 狀態流轉圖

```
[ACTIVE] 新生成的信號，有效且未觸發
   ↓
[TRIGGERED] 使用者已執行操作（買入/賣出）
   ↓ 或
[EXPIRED] 超過 valid_until 時間，信號過期
   ↓ 或
[CANCELLED] 條件不再滿足，信號取消
```

#### 2.9.2 狀態轉換規則

| 原狀態 | 新狀態 | 觸發條件 |
|--------|--------|---------|
| ACTIVE | TRIGGERED | 使用者執行交易 |
| ACTIVE | EXPIRED | 超過有效期限 |
| ACTIVE | CANCELLED | 條件消失（如技術指標反轉） |
| 任何狀態 | CANCELLED | 手動取消 |

---

### 2.10 PostgreSQL 特有功能應用

#### 2.10.1 JSONB 查詢範例

```sql
-- 查詢 MACD 值大於 1.0 的信號
SELECT * FROM signals 
WHERE evidence_data->>'indicator' = 'MACD' 
  AND (evidence_data->>'macd_value')::numeric > 1.0;

-- 查詢包含特定技術因子的信號
SELECT * FROM signals 
WHERE technical_factors ? 'RSI'  -- 檢查 JSON 鍵是否存在
  AND (technical_factors->>'RSI')::numeric < 30;

-- 複合條件查詢
SELECT * FROM signals 
WHERE evidence_data @> '{"indicator": "MACD"}'::jsonb  -- 包含子集
  AND signal_type = 'BUY'
  AND signal_status = 'ACTIVE';
```

#### 2.10.2 PostgreSQL 陣列型態應用

```sql
-- 在需要的表中使用陣列
ALTER TABLE stocks ADD COLUMN tags TEXT[];

-- 查詢包含特定標籤的股票
SELECT * FROM stocks WHERE 'semiconductor' = ANY(tags);
```

---

## 📚 相關文檔

- [技術架構總覽](00-技術架構.md)
- [API 統一規範](../api/M06-API規格.md)
- [資料庫設計](../../design/database-schema.md)
- [開發準則](00-開發準則.md)

---

**文件維護者**: 系統架構師  
**最後更新**: 2025-12-31  
**下次審核**: 2026-01-31
