# M08-基本面分析模組功能需求

> **文件編號**: SPEC-FUNC-M08  
> **模組名稱**: 基本面分析模組  
> **版本**: v2.0  
> **最後更新**: 2026-01-15  
> **狀態**: Draft

---

## 1. 模組概述

### 1.1 模組定位

基本面分析模組是整個系統的**分析層（Layer 2）**，負責：
- 計算 75 個基本面財務指標（估值、獲利、財務結構、償債、效率、現金流、成長、股利、綜合評分）
- 儲存指標計算結果至 PostgreSQL 資料庫
- 提供財務指標查詢 API 給信號判斷引擎、選股引擎使用
- 偵測財務異常、盈餘品質問題
- 管理指標計算的排程與冪等性

**核心價值**: 為信號判斷、選股篩選、策略回測提供完整的基本面量化指標。

### 1.2 模組目標

- ✅ 完整財務指標庫：支援 75 個基本面指標（參照 fundamental_indicators_complete.md）
- ✅ 自動化計算：每季財報公告後自動計算財務指標（遵守總綱 4.5 Job 模型）
- ✅ 歷史趨勢分析：計算指標成長率、趨勢方向
- ✅ 冪等性保證：所有 Job 遵守總綱 4.5 冪等性要求
- ✅ 快取優化：熱門股票財務指標快取至 Redis，提升查詢效能
- ✅ 綜合評分：提供 Piotroski F-Score、Altman Z-Score 等綜合評分

### 1.3 功能範圍

**包含功能**:
1. **估值指標計算**（15 個）: P/E、P/B、P/S、P/CF、P/FCF、PEG、EV/EBITDA、Graham Number、Tobin's Q 等
2. **獲利能力指標計算**（12 個）: 毛利率、營業利益率、淨利率、ROE、ROA、ROIC、EPS、EBITDA Margin 等
3. **財務結構指標計算**（4 個）: 負債權益比、負債比率、權益比率、長期負債權益比
4. **償債能力指標計算**（6 個）: 流動比率、速動比率、現金比率、利息保障倍數、償債覆蓋率等
5. **經營效率指標計算**（10 個）: 總資產週轉率、存貨週轉率、應收帳款週轉率、現金週轉週期等
6. **現金流量指標計算**（6 個）: 自由現金流、FCF Yield、營運現金流比率、應計項目比率等
7. **成長性指標計算**（5 個）: 營收成長率、EPS 成長率、淨利成長率、ROE 成長率等
8. **股利政策指標計算**（4 個）: 現金殖利率、股利發放率、股利成長率、股利保障倍數
9. **綜合評分計算**（4 個）: Piotroski F-Score、Altman Z-Score、Beneish M-Score、Graham 評分
10. **財務指標查詢 API**: 提供單一/批次財務指標查詢介面

**不包含功能**:
- 技術指標計算（由 M07 負責）
- 籌碼指標計算（由 M09 負責）
- 信號評分與合併（由 M13 負責）

### 1.4 依賴關係

**上游依賴**: 
- M06 資料管理模組（財務報表資料）

**下游依賴**: 
- M13 信號判斷引擎
- M14 選股引擎
- M16 回測系統
- M17 風險管理模組

**外部依賴**:
- PostgreSQL（資料儲存）
- Redis（快取）

### 1.5 實作進度

> **最後更新**: 2026-01-15

| 優先級 | 指標組 | 計畫數量 | 已完成 | 進度 | 狀態 |
|-------|-------|---------|-------|------|------|
| P0 | 基礎組 | 20 | 20 | 100% | ✅ 已完成 |
| P1 | 進階組 | ~30 | 0 | 0% | ⏳ 待開發 |
| P2 | 專業組 | ~25 | 0 | 0% | ⏳ 待開發 |

**P0 已完成 (20 個)**:
- 估值類（5 個）：PE、PB、PS、PEG、**EV/EBITDA**
- 獲利能力類（6 個）：ROE、ROA、GrossMargin、NetMargin、**OperatingMargin**、**EPS**
- 財務結構類（3 個）：DebtRatio、EquityRatio、**DebtToEquity**
- 償債能力類（3 個）：CurrentRatio、QuickRatio、**InterestCoverage**
- 現金流量類（3 個）：FCF、FCFYield、**OCFRatio**

**基礎架構已完成**:
- ✅ 引擎核心（FundamentalEngine、DefaultFundamentalEngine、M08IndicatorRegistry）
- ✅ 模型（FinancialData、CalculationResult、CalculationPlan、Diagnostics）
- ✅ Domain 實體（FundamentalIndicator、FinancialScore、FinancialAlert）
- ✅ Repository（JPA）+ Mapper（MyBatis）
- ✅ Service 層
- ✅ Controller（API）
- ✅ Job 排程

**測試覆蓋**:
- ⚠️ 單元測試尚未建立（待補齊）

> 詳細開發記錄請參閱 [M08-開發記錄](../../design/M08-開發記錄.md)

---


---

## 2. 功能需求

### 2.1 功能清單

| 功能編號 | 功能名稱 | 優先級 | 說明 | 持久層 |
|---------|---------|-------|------|-------|
| F-M08-001 | 估值指標計算 | P0 | P/E、P/B、P/S、PEG 等 15 個指標 | JPA + MyBatis |
| F-M08-002 | 獲利能力指標計算 | P0 | 毛利率、淨利率、ROE、EPS 等 12 個指標 | JPA + MyBatis |
| F-M08-003 | 財務結構指標計算 | P0 | 負債比、權益比等 4 個指標 | JPA |
| F-M08-004 | 償債能力指標計算 | P0 | 流動比率、速動比率等 6 個指標 | JPA |
| F-M08-005 | 經營效率指標計算 | P1 | 週轉率、現金週轉週期等 10 個指標 | JPA + MyBatis |
| F-M08-006 | 現金流量指標計算 | P0 | FCF、FCF Yield 等 6 個指標 | JPA + MyBatis |
| F-M08-007 | 成長性指標計算 | P1 | 營收成長率、EPS 成長率等 5 個指標 | MyBatis |
| F-M08-008 | 股利政策指標計算 | P1 | 殖利率、股利發放率等 4 個指標 | JPA |
| F-M08-009 | 綜合評分計算 | P1 | Piotroski F-Score、Altman Z-Score 等 | MyBatis |
| F-M08-010 | 財務指標查詢 API | P0 | 單一/批次財務指標查詢 | JPA + MyBatis |
| F-M08-011 | 歷史趨勢分析 | P1 | 計算指標成長率、趨勢方向 | MyBatis |
| F-M08-012 | 財務異常偵測 | P1 | 盈餘品質、會計操縱風險 | MyBatis |
| F-M08-013 | 指標排程計算 | P0 | 每季財報公告後自動計算 | - |
| F-M08-014 | 指標快取管理 | P1 | 熱門股票財務指標快取 | - |

### 2.2 用例說明

#### UC-M08-001: 每季財務指標計算

**參與者**: 系統排程器  
**前置條件**: 
- M06 財報資料同步已完成
- 收到 FinancialStatementUpdated 事件

**主要流程**:
1. 系統於每週一 09:00 觸發財務指標計算 Job（遵守總綱 4.5 Job 模型）
2. 建立 Job 執行記錄（job_executions 表，status='RUNNING'）
3. 查詢最近一季新增或更新的財報資料（從 M06 FinancialStatementUpdated 事件）
4. 對每檔股票每季財報執行指標計算：
   - 從 financial_statements 表查詢該季財報資料
   - 從 stock_prices 表查詢計算日當天的收盤價（用於估值指標）
   - 計算基礎指標組（估值、獲利、財務結構、償債能力）
   - 查詢歷史財報計算成長性指標（營收成長率、EPS 成長率）
   - 計算綜合評分（Piotroski F-Score、Altman Z-Score）
   - 驗證計算結果（非 NULL、非 NaN、範圍合理）
   - 使用 MyBatis 批次 UPSERT 儲存至 fundamental_indicators 表
5. 更新 Redis 快取（熱門股票前 50 檔）
6. 偵測財務異常（盈餘品質惡化、負債比過高、現金流轉負）
7. 產生信號並發布（遵守總綱 4.2 Signal Contract）
8. 更新 Job 執行記錄（status='SUCCESS', 統計資訊）

**後置條件**:
- 該季財務指標已計算並儲存
- Job 執行記錄狀態為 SUCCESS
- Redis 快取已更新
- 財務異常信號已發布至 M13

**替代流程**:
- 4a. 財報資料不完整（缺少必要欄位）→ 記錄 data_quality_issues，跳過該股票
- 4b. 計算結果異常（NaN、Inf、負數ROE但公司獲利）→ 記錄異常，跳過該股票
- 4c. 資料庫錯誤 → 回滾交易，Job 狀態設為 FAILED，觸發重試
- 6a. 偵測到財務異常 → 產生 SELL/HOLD 信號（遵守總綱 4.2）

---

#### UC-M08-002: 財務指標批次查詢

**參與者**: M14 選股引擎、M13 信號判斷引擎  
**前置條件**: 
- 財務指標已計算並儲存

**主要流程**:
1. 下游模組發送批次查詢請求（股票清單、指標清單、時間範圍）
2. 檢查 Redis 快取是否命中
3. 若快取未命中，使用 MyBatis 批次查詢資料庫
4. 組裝查詢結果（遵守總綱 4.4 API 統一規範）
5. 更新 Redis 快取（設定 TTL）
6. 返回結果

**後置條件**:
- 查詢結果已返回
- 快取已更新（若未命中）

**替代流程**:
- 2a. 快取命中 → 直接返回快取結果，跳至步驟 6
- 3a. 資料庫無資料 → 返回空結果，error_code='M08_DATA_001'

---

#### UC-M08-003: 財務異常偵測

**參與者**: 系統排程器  
**前置條件**: 
- 財務指標已計算完成

**主要流程**:
1. 讀取當季財務指標
2. 執行異常偵測規則：
   - 盈餘品質：應計項目比率 > 10%（可能會計操縱）
   - 負債風險：負債比 > 70%（財務風險高）
   - 流動性風險：流動比 < 1.0（短期償債能力不足）
   - 現金流問題：自由現金流連續 2 季為負（燒錢）
   - ROE 惡化：ROE 連續 2 季下降且 < 10%
3. 若偵測到異常，產生警示信號
4. 記錄異常至 financial_alerts 表
5. 發布事件至 M13 信號判斷引擎

**後置條件**:
- 財務異常已記錄
- 警示信號已發布

---

### 2.3 業務規則

#### BR-M08-001: 財務指標計算優先級

**核心組（P0 - 每季必算）**:
- 估值指標：P/E, P/B, P/S, PEG, EV/EBITDA
- 獲利能力：毛利率, 營業利益率, 淨利率, ROE, ROA, EPS
- 財務結構：負債權益比, 負債比率, 權益比率
- 償債能力：流動比率, 速動比率, 利息保障倍數
- 現金流量：自由現金流, FCF Yield, 營運現金流比率

**進階組（P1 - 每季計算）**:
- 經營效率：總資產週轉率, 存貨週轉率, 應收帳款週轉率, 現金週轉週期
- 成長性：營收成長率, EPS 成長率, 淨利成長率
- 股利政策：現金殖利率, 股利發放率
- 綜合評分：Piotroski F-Score, Altman Z-Score

**專業組（P2 - 按需計算）**:
- 進階估值：Tobin's Q, Graham Number, Shiller P/E
- 進階獲利：ROIC, ROTA
- 進階償債：償債覆蓋率, 現金比率
- 進階現金流：應計項目比率, 現金流營收比
- 進階成長：CAGR (3年、5年)
- 進階評分：Beneish M-Score, Graham 評分

---

#### BR-M08-002: 指標計算參數標準化

所有指標使用統一的計算方法，遵循財務會計準則：

| 指標 | 計算公式 | 資料來源 |
|-----|---------|---------|
| P/E | 股價 / 每股盈餘(EPS) | stock_prices, financial_statements |
| P/B | 股價 / 每股淨值 | stock_prices, financial_statements |
| P/S | 股價 / 每股營收 | stock_prices, financial_statements |
| ROE | 稅後淨利 / 股東權益 × 100% | financial_statements |
| ROA | 稅後淨利 / 總資產 × 100% | financial_statements |
| 毛利率 | (營收 - 營業成本) / 營收 × 100% | financial_statements |
| 淨利率 | 稅後淨利 / 營收 × 100% | financial_statements |
| 負債比 | 總負債 / 總資產 × 100% | financial_statements |
| 流動比 | 流動資產 / 流動負債 | financial_statements |
| FCF | 營運現金流 - 資本支出 | financial_statements |
| EPS 成長率 | (本季EPS - 去年同季EPS) / 去年同季EPS × 100% | financial_statements (歷史) |

---

#### BR-M08-003: 指標驗證規則

**完整性**:
- 計算後的指標值不可為 NULL（允許 NaN 用於資料不足期間）
- 財報資料必須包含核心欄位（營收、淨利、總資產、股東權益）

**準確性**:
- ROE、ROA、各利潤率範圍：-100% 到 100%（虧損公司可為負）
- 負債比範圍：0% 到 200%（超過 100% 表示淨值為負）
- 流動比、速動比範圍：> 0
- P/E、P/B、P/S 範圍：> 0（負值表示虧損，需特殊處理）

**合理性**:
- ROE > 100%：異常高，需人工檢查
- 負債比 > 90%：高風險，觸發警示
- 流動比 < 0.5：流動性風險，觸發警示
- 毛利率 < 0% 或 > 80%：異常值，需檢查

**一致性**:
- 同一股票、同一季度、同一指標只能有一筆記錄
- 權益比 + 負債比 ≈ 100%（容許 ±1% 誤差）

---

#### BR-M08-004: 財務異常偵測規則

**盈餘品質警示**:
- 應計項目比率 > 10%：可能會計操縱
- 營運現金流 < 淨利 × 0.7：盈餘品質不佳
- 自由現金流連續 2 季為負：燒錢警示

**財務結構警示**:
- 負債比 > 70%：高負債風險
- 負債權益比 > 2.0：財務槓桿過高
- 權益比 < 30%：自有資金不足

**償債能力警示**:
- 流動比 < 1.0：短期償債能力不足
- 速動比 < 0.8：流動性風險
- 利息保障倍數 < 1.5：利息支付能力不足

**獲利能力警示**:
- ROE 連續 2 季下降且 < 10%：獲利惡化
- 毛利率連續 2 季下降且 < 15%：競爭力下降
- 淨利率 < 3%：獲利能力弱

---

#### BR-M08-005: 快取策略

參照總綱快取策略：

| 資料類型 | 快取位置 | TTL | 預熱策略 | 失效策略 |
|---------|---------|-----|---------|---------|
| 熱門股票財務指標（市值前 50） | Redis | 24 小時 | Job 完成後主動更新 | 新財報計算完成後主動更新 |
| 一般股票財務指標 | Redis | 48 小時 | 首次查詢時載入 | LRU 自動淘汰 |
| 單季指標快照 | Redis | 7 天 | 不預熱 | TTL 自動過期 |
| 綜合評分 | Redis | 24 小時 | 計算完成後主動更新 | 新評分計算後主動更新 |

**快取 Key 設計**:
```
fund:indicators:{stock_id}:{year}:{quarter}                → 單季所有指標
fund:indicator:{stock_id}:{indicator_name}:{year}:{quarter} → 單一指標單季值
fund:trend:{stock_id}:{indicator_name}:{periods}           → 指標歷史趨勢
fund:score:{stock_id}:{score_type}:{year}:{quarter}        → 綜合評分
fund:hot:stocks                                            → 熱門股票清單
```

---


---

## 📚 相關文檔

- [系統功能總覽](./00-系統功能總覽.md)
- [M08 API規格](../technical/api/M08-API規格.md)
- [M08 資料庫設計](../../design/M08-資料庫設計.md)
- [M08 業務流程](../../design/M08-業務流程.md)

---

**文件維護者**: 系統分析師  
**最後更新**: 2025-12-31
