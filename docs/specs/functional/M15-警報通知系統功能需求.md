# M15-警報通知系統 功能需求

> **文件編號**: FUNC-M15
> **模組名稱**: 警報通知系統 (Alert Notification System)
> **版本**: v1.0
> **最後更新**: 2026-01-15
> **狀態**: Draft

---

## 1. 模組概述

### 1.1 模組定位

M15 警報通知系統是系統的**即時通知中樞**，位於 Layer 5 (應用層)。負責監控 M13 信號引擎產生的交易信號，依據用戶設定的警報規則判斷是否觸發，並透過多種管道（Email、Line、APP 推播）發送通知給用戶。

```
┌─────────────────────────────────────────────────────────────────────┐
│                      M15 警報通知系統定位                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│                    ┌─────────────────────┐                          │
│                    │    M13 信號引擎     │                          │
│                    │   (信號來源)        │                          │
│                    └──────────┬──────────┘                          │
│                               │ 信號產生                             │
│                               ▼                                      │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │                    M15 警報通知系統                         │     │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌─────────┐ │     │
│  │  │ 規則引擎  │─►│ 警報判斷  │─►│ 通知派發  │─►│ 通知管道│ │     │
│  │  └───────────┘  └───────────┘  └───────────┘  └─────────┘ │     │
│  └────────────────────────────────────────────────────────────┘     │
│                               │                                      │
│         ┌─────────────────────┼─────────────────────┐               │
│         ▼                     ▼                     ▼               │
│    ┌─────────┐          ┌─────────┐          ┌─────────┐           │
│    │  Email  │          │  Line   │          │   APP   │           │
│    └─────────┘          └─────────┘          └─────────┘           │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 核心價值

| 價值項目 | 說明 |
|---------|------|
| 即時通知 | 信號產生後即時推送通知，不錯過交易機會 |
| 個人化警報 | 用戶可自訂監控股票、信號等級、通知頻率 |
| 多管道推送 | 支援 Email、Line、APP 推播等多種通知方式 |
| 靜音控制 | 支援勿擾時段、每日限額，避免訊息騷擾 |
| 歷史追蹤 | 完整記錄警報歷史，便於回顧與分析 |

### 1.3 模組依賴

```
上游依賴:
┌─────────────────────────────────────────────────────────────────────┐
│  M13 信號判斷引擎                                                    │
│  ├── unified_signals: 統一信號資料                                  │
│  ├── signal_details: 信號明細                                       │
│  └── signal_summaries: 信號摘要                                     │
│                                                                      │
│  M06 資料管理模組                                                    │
│  ├── stocks: 股票基本資料                                           │
│  └── stock_daily: 價格資料（通知內容）                              │
└─────────────────────────────────────────────────────────────────────┘

下游服務:
┌─────────────────────────────────────────────────────────────────────┐
│  外部通知服務                                                        │
│  ├── SMTP Server: Email 發送                                        │
│  ├── Line Notify API: Line 推播                                     │
│  └── Firebase Cloud Messaging: APP 推播                             │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 功能清單

### 2.1 功能總覽

| 功能編號 | 功能名稱 | 優先級 | 說明 |
|---------|---------|:------:|------|
| F-M15-001 | 警報規則管理 | P0 | 用戶建立/修改/刪除警報規則 |
| F-M15-002 | 信號監控 | P0 | 監控 M13 信號變化 |
| F-M15-003 | 警報觸發判斷 | P0 | 依規則判斷是否觸發警報 |
| F-M15-004 | 通知派發 | P0 | 將警報發送至各通知管道 |
| F-M15-005 | Email 通知 | P0 | Email 格式化與發送 |
| F-M15-006 | Line 通知 | P1 | Line Notify 整合 |
| F-M15-007 | APP 推播 | P1 | Firebase FCM 整合 |
| F-M15-008 | 靜音設定 | P1 | 勿擾時段、每日限額 |
| F-M15-009 | 警報歷史 | P1 | 警報記錄查詢與管理 |
| F-M15-010 | 通知偏好 | P1 | 用戶通知偏好設定 |
| F-M15-011 | 批次通知 | P2 | 合併多則警報為摘要通知 |
| F-M15-012 | 通知範本 | P2 | 自訂通知訊息格式 |

### 2.2 警報規則類型

| 規則類型 | 代碼 | 說明 | 觸發條件 |
|---------|------|------|---------|
| 信號警報 | SIGNAL | M13 信號觸發 | 指定股票/評級/方向 |
| 價格警報 | PRICE | 價格突破 | 突破指定價位 |
| 漲跌幅警報 | CHANGE | 漲跌幅達標 | 漲跌幅超過閾值 |
| 成交量警報 | VOLUME | 量能異常 | 成交量倍數異常 |
| 自選股信號 | WATCHLIST | 自選股有信號 | 自選股產生信號 |

---

## 3. 功能詳細需求

### 3.1 F-M15-001 警報規則管理

#### 功能說明

用戶可建立、修改、刪除個人化的警報規則，定義何時觸發警報通知。

#### 規則結構

```json
{
  "ruleId": "RULE_001",
  "ruleName": "高評級買入信號",
  "ruleType": "SIGNAL",
  "enabled": true,
  "conditions": {
    "stockIds": ["2330", "2317"],     // 指定股票（空=全部）
    "directions": ["BUY"],             // 信號方向
    "minGrade": "B+",                  // 最低評級
    "minScore": 70                     // 最低分數
  },
  "notifications": {
    "channels": ["EMAIL", "LINE"],
    "priority": "HIGH"
  },
  "throttle": {
    "maxPerDay": 10,                   // 每日最多通知
    "cooldownMinutes": 30              // 同股票冷卻時間
  }
}
```

#### 規則限制

| 限制項目 | 限制值 | 說明 |
|---------|-------|------|
| 每用戶規則數 | 最多 20 條 | 避免系統負載過重 |
| 指定股票數 | 每規則最多 50 檔 | 空表示全市場 |
| 規則名稱長度 | 最多 50 字 | - |

---

### 3.2 F-M15-002 信號監控

#### 功能說明

定期或即時監控 M13 信號引擎產生的新信號，作為警報觸發的來源。

#### 監控模式

| 模式 | 說明 | 延遲 |
|-----|------|------|
| 輪詢模式 | 每分鐘查詢新信號 | 最多 60 秒 |
| 事件驅動 | M13 完成後觸發 | 即時 |
| 混合模式 | 事件驅動 + 定時補查 | 即時 + 保底 |

#### 監控資料

```sql
-- 查詢新產生的信號
SELECT us.*
FROM unified_signals us
WHERE us.trade_date = :today
  AND us.created_at > :lastCheckTime
  AND us.grade IN ('A+', 'A', 'B+', 'B')
ORDER BY us.created_at;
```

---

### 3.3 F-M15-003 警報觸發判斷

#### 功能說明

將新信號與用戶設定的警報規則進行比對，判斷是否符合觸發條件。

#### 判斷流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        警報觸發判斷流程                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────┐                                                   │
│  │   新信號     │                                                   │
│  │  (from M13)  │                                                   │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐    ┌──────────────┐                               │
│  │  取得所有    │───►│  逐條比對    │                               │
│  │  啟用規則    │    │   規則條件   │                               │
│  └──────────────┘    └──────┬───────┘                               │
│                             │                                        │
│         ┌───────────────────┼───────────────────┐                   │
│         ▼                   ▼                   ▼                   │
│    ┌─────────┐        ┌─────────┐        ┌─────────┐               │
│    │ 股票    │        │ 評級    │        │ 方向    │               │
│    │ 匹配?   │        │ 匹配?   │        │ 匹配?   │               │
│    └────┬────┘        └────┬────┘        └────┬────┘               │
│         │                  │                  │                     │
│         └──────────────────┼──────────────────┘                     │
│                            │                                         │
│                            ▼                                         │
│                     ┌─────────────┐                                  │
│                     │ 所有條件    │                                  │
│                     │  皆符合?    │                                  │
│                     └──────┬──────┘                                  │
│                            │                                         │
│              ┌─────────────┼─────────────┐                          │
│              ▼ 是                        ▼ 否                       │
│       ┌─────────────┐             ┌─────────────┐                   │
│       │  檢查節流   │             │   跳過      │                   │
│       │  條件      │             └─────────────┘                   │
│       └──────┬──────┘                                                │
│              │                                                       │
│              ▼                                                       │
│       ┌─────────────┐                                                │
│       │  建立警報   │                                                │
│       │  記錄      │                                                │
│       └─────────────┘                                                │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

#### 評級比較邏輯

```java
public boolean isGradeMatch(String signalGrade, String minGrade) {
    List<String> gradeOrder = List.of("A+", "A", "B+", "B", "C", "D");
    int signalIndex = gradeOrder.indexOf(signalGrade);
    int minIndex = gradeOrder.indexOf(minGrade);
    return signalIndex >= 0 && signalIndex <= minIndex;  // 越小越好
}
```

---

### 3.4 F-M15-004 通知派發

#### 功能說明

將觸發的警報根據用戶設定的通知管道進行派發。

#### 派發架構

```
┌─────────────────────────────────────────────────────────────────────┐
│                        通知派發架構                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────┐                                                   │
│  │   Alert      │                                                   │
│  │   Queue      │ ◄── 警報佇列                                      │
│  └──────┬───────┘                                                   │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────┐                                                   │
│  │  Dispatcher  │ ◄── 派發器                                        │
│  └──────┬───────┘                                                   │
│         │                                                            │
│    ┌────┴────────────────────────────────┐                          │
│    │                                     │                          │
│    ▼                                     ▼                          │
│  ┌──────────────┐                 ┌──────────────┐                  │
│  │  Channel     │                 │  Channel     │                  │
│  │  Router      │                 │  Router      │                  │
│  └──────┬───────┘                 └──────┬───────┘                  │
│         │                                │                          │
│    ┌────┼────────────────┐              │                          │
│    ▼    ▼                ▼              ▼                          │
│  ┌────┐ ┌────┐      ┌────┐      ┌────────────┐                     │
│  │Email│ │Line│      │FCM │      │ Webhook    │                     │
│  │Sender│ │Sender│   │Sender│    │ (擴充)    │                     │
│  └────┘ └────┘      └────┘      └────────────┘                     │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

#### 通知優先級

| 優先級 | 處理方式 | 適用場景 |
|-------|---------|---------|
| HIGH | 立即發送 | A+ 評級、重大信號 |
| NORMAL | 佇列處理 | 一般信號通知 |
| LOW | 批次彙總 | 低評級、次要資訊 |

---

### 3.5 F-M15-005 Email 通知

#### 功能說明

透過 SMTP 發送格式化的 Email 通知。

#### Email 格式

```html
<!-- 信號警報 Email 範本 -->
<h2>📈 交易信號警報</h2>

<table>
  <tr>
    <td>股票</td>
    <td>{{stockId}} {{stockName}}</td>
  </tr>
  <tr>
    <td>信號方向</td>
    <td>{{direction}}</td>
  </tr>
  <tr>
    <td>評級</td>
    <td>{{grade}} ({{score}}分)</td>
  </tr>
  <tr>
    <td>現價</td>
    <td>{{price}} ({{changePercent}}%)</td>
  </tr>
  <tr>
    <td>信號時間</td>
    <td>{{signalTime}}</td>
  </tr>
</table>

<h3>信號摘要</h3>
<p>{{signalSummary}}</p>

<p style="color: #999; font-size: 12px;">
  此為系統自動發送的警報通知，請勿直接回覆。
  如需調整通知設定，請前往 <a href="{{settingsUrl}}">通知設定</a>。
</p>
```

---

### 3.6 F-M15-006 Line 通知

#### 功能說明

透過 Line Notify API 發送 Line 通知。

#### Line 訊息格式

```
📈 交易信號警報

股票: 2330 台積電
方向: 買入 🟢
評級: A (85分)
現價: 580.00 (+2.5%)

【信號摘要】
技術面: RSI 55 動能轉強
籌碼面: 外資連買 5 日

⏰ 2026-01-15 14:30:00
```

#### Line Notify 整合

```java
@Service
public class LineNotificationSender implements NotificationSender {

    @Value("${notification.line.api-url}")
    private String apiUrl;

    public void send(Alert alert, UserNotificationConfig config) {
        String message = formatLineMessage(alert);

        HttpHeaders headers = new HttpHeaders();
        headers.setBearerAuth(config.getLineToken());
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);

        MultiValueMap<String, String> body = new LinkedMultiValueMap<>();
        body.add("message", message);

        restTemplate.postForEntity(apiUrl, new HttpEntity<>(body, headers), String.class);
    }
}
```

---

### 3.7 F-M15-008 靜音設定

#### 功能說明

用戶可設定勿擾時段與每日通知上限，避免訊息騷擾。

#### 靜音配置

```json
{
  "userId": "user001",
  "muteSettings": {
    "enabled": true,
    "quietHours": {
      "start": "22:00",
      "end": "08:00",
      "timezone": "Asia/Taipei"
    },
    "weekendMute": true,
    "dailyLimit": {
      "email": 20,
      "line": 10,
      "push": 30
    }
  }
}
```

#### 靜音判斷邏輯

```java
public boolean shouldMute(String userId, LocalDateTime now) {
    MuteSettings settings = getMuteSettings(userId);

    if (!settings.isEnabled()) {
        return false;
    }

    // 檢查勿擾時段
    LocalTime currentTime = now.toLocalTime();
    if (isInQuietHours(currentTime, settings.getQuietHours())) {
        return true;
    }

    // 檢查週末靜音
    if (settings.isWeekendMute() && isWeekend(now)) {
        return true;
    }

    // 檢查每日上限
    return hasExceededDailyLimit(userId, now.toLocalDate());
}
```

---

### 3.8 F-M15-009 警報歷史

#### 功能說明

記錄所有觸發的警報，供用戶查詢與分析。

#### 歷史記錄內容

| 欄位 | 說明 |
|-----|------|
| alertId | 警報 ID |
| ruleId | 觸發規則 ID |
| userId | 用戶 ID |
| stockId | 股票代碼 |
| alertType | 警報類型 |
| signalId | 關聯信號 ID |
| triggeredAt | 觸發時間 |
| notifiedChannels | 已通知管道 |
| notificationStatus | 通知狀態 |
| readAt | 已讀時間 |

---

### 3.9 F-M15-011 批次通知

#### 功能說明

當短時間內產生多則警報時，合併為摘要通知發送。

#### 批次邏輯

```
┌─────────────────────────────────────────────────────────────────────┐
│                        批次通知邏輯                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  設定: batchWindow = 5 分鐘, batchThreshold = 3 則                   │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │ 14:00:00  警報 1 ──► 等待 5 分鐘                              │   │
│  │ 14:01:30  警報 2 ──► 累積                                     │   │
│  │ 14:03:00  警報 3 ──► 達到 3 則閾值                            │   │
│  │ 14:05:00  ──────────► 發送批次摘要通知                        │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  批次摘要格式:                                                       │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │ 📊 您有 3 則新警報                                            │   │
│  │                                                               │   │
│  │ 1. 2330 台積電 - 買入信號 (A)                                 │   │
│  │ 2. 2317 鴻海 - 買入信號 (B+)                                  │   │
│  │ 3. 2454 聯發科 - 賣出信號 (B)                                 │   │
│  │                                                               │   │
│  │ 點擊查看詳情 >>                                               │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. 非功能性需求

### 4.1 效能需求

| 指標 | 目標值 | 說明 |
|-----|-------|------|
| 信號監控延遲 | < 60 秒 | 信號產生到開始判斷 |
| 警報觸發延遲 | < 5 秒 | 判斷到產生警報 |
| 通知發送延遲 | < 30 秒 | 警報到用戶收到 |
| 通知發送成功率 | > 99% | Email/Line/Push |
| 併發處理能力 | 1000 則/分鐘 | 警報處理吞吐量 |

### 4.2 可靠性需求

| 需求項目 | 說明 |
|---------|------|
| 訊息不遺失 | 使用訊息佇列確保不遺失 |
| 重試機制 | 發送失敗自動重試 3 次 |
| 冪等性 | 同一警報不重複發送 |
| 狀態追蹤 | 記錄每則通知的發送狀態 |

### 4.3 擴展性需求

| 需求項目 | 說明 |
|---------|------|
| 新通知管道 | 預留 Webhook 擴充介面 |
| 新規則類型 | 規則引擎支援擴展 |
| 多語言支援 | 通知範本國際化 |

---

## 5. 錯誤碼定義

| 錯誤碼 | HTTP 狀態碼 | 說明 |
|-------|------------|------|
| M15-001 | 400 | 規則格式無效 |
| M15-002 | 400 | 超過規則數量限制 |
| M15-003 | 404 | 規則不存在 |
| M15-004 | 400 | 通知管道未設定 |
| M15-005 | 400 | Line Token 無效 |
| M15-006 | 500 | Email 發送失敗 |
| M15-007 | 500 | Line 發送失敗 |
| M15-008 | 500 | Push 發送失敗 |
| M15-009 | 429 | 超過每日通知限額 |
| M15-010 | 400 | 靜音設定無效 |

---

## 6. 相關文檔

- [M15 API 規格](../api/M15-API規格.md)
- [M15 資料庫設計](../../design/M15-資料庫設計.md)
- [M15 業務流程](../../design/M15-業務流程.md)
- [M13 信號引擎功能需求](./M13-信號引擎功能需求.md)

---

**文件維護者**: 後端工程師
**最後更新**: 2026-01-15
**下次審核**: 2026-04-15
