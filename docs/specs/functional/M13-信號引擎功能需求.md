# M13-信號判斷引擎功能需求

> **文件編號**: FUNC-M13
> **模組名稱**: 信號判斷引擎 (Signal Judgment Engine)
> **版本**: v1.0
> **最後更新**: 2026-01-14
> **狀態**: Draft

---

## 1. 模組定位

### 1.1 模組概述

M13 信號判斷引擎是系統的核心整合模組，負責收集來自所有上游分析模組的原始信號，進行去重、合併、評分與排序，最終產生統一的買賣信號供下游模組消費。

### 1.2 核心價值

- **信號整合**: 統一整合來自 6 個分析模組的異質信號
- **去重合併**: 消除重複信號，合併相似信號
- **智能評分**: 基於多維度因素對信號進行綜合評分
- **優先排序**: 依評分排序，突出最具投資價值的信號
- **統一輸出**: 提供標準化信號格式供下游模組消費

### 1.3 系統定位

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Layer 4: 信號層                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │    M07      M08      M09      M10      M11      M12                │   │
│  │   技術     基本面    籌碼     型態     量化     總經產業            │   │
│  │   信號     信號      信號     信號     策略     信號                │   │
│  │    │        │        │        │      信號       │                  │   │
│  │    └────────┴────────┴────────┴────────┴────────┘                  │   │
│  │                              │                                     │   │
│  │                              ▼                                     │   │
│  │    ┌─────────────────────────────────────────────────────────┐    │   │
│  │    │                        M13                               │    │   │
│  │    │                   信號判斷引擎                            │ ← 本模組
│  │    │                                                          │    │   │
│  │    │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │    │   │
│  │    │  │ 信號    │  │ 信號    │  │ 信號    │  │ 統一    │    │    │   │
│  │    │  │ 收集    │→ │ 去重    │→ │ 評分    │→ │ 輸出    │    │    │   │
│  │    │  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │    │   │
│  │    └─────────────────────────────────────────────────────────┘    │   │
│  │                              │                                     │   │
│  │                              ▼                                     │   │
│  │    ┌─────────────────────────────────────────────────────────┐    │   │
│  │    │    M14      M15      M16      M17      M18              │    │   │
│  │    │   選股     警報     回測     風險     投組               │    │   │
│  │    │   引擎     通知     系統     管理     管理               │    │   │
│  │    └─────────────────────────────────────────────────────────┘    │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.4 模組依賴

| 依賴方向 | 模組 | 依賴內容 |
|---------|------|---------|
| 上游 | M07 技術分析 | 技術指標信號（RSI 超買超賣、MACD 黃金交叉等） |
| 上游 | M08 基本面分析 | 財務指標信號（本益比偏低、ROE 提升等） |
| 上游 | M09 籌碼分析 | 籌碼異常信號（法人連續買超、融資斷頭等） |
| 上游 | M10 技術型態 | 型態識別信號（頭肩底、突破等） |
| 上游 | M11 量化策略 | 策略執行信號（策略觸發、買賣建議） |
| 上游 | M12 總經產業 | 產業輪動信號（產業轉強、經濟週期變化） |
| 下游 | M14 選股引擎 | 消費統一信號進行選股篩選 |
| 下游 | M15 警報通知 | 消費統一信號觸發警報 |
| 下游 | M16 回測系統 | 消費歷史信號進行回測 |
| 下游 | M17 風險管理 | 消費信號進行風險評估 |
| 下游 | M18 投組管理 | 消費信號調整持股 |

---

## 2. 功能清單

| 功能編號 | 功能名稱 | 優先級 | 說明 |
|---------|---------|-------|------|
| F-M13-001 | 信號收集 | P0 | 從各上游模組收集原始信號 |
| F-M13-002 | 信號去重 | P0 | 識別並合併重複或相似信號 |
| F-M13-003 | 信號合併 | P0 | 將同股票多信號合併為綜合信號 |
| F-M13-004 | 信號評分 | P0 | 基於多維度計算信號綜合評分 |
| F-M13-005 | 信號排序 | P0 | 依評分排序產生每日推薦清單 |
| F-M13-006 | 信號分類 | P1 | 依信號類型、強度分類標籤 |
| F-M13-007 | 信號查詢 | P0 | 提供多維度信號查詢接口 |
| F-M13-008 | 信號發布 | P0 | 發布統一信號供下游消費 |

---

## 3. 功能詳細設計

### F-M13-001: 信號收集

**功能描述**: 從各上游分析模組收集原始信號

**信號來源與類型**:

| 來源模組 | 信號類型 | 信號範例 | 收集方式 |
|---------|---------|---------|---------|
| M07 技術分析 | TECHNICAL | RSI 超買、MACD 黃金交叉、均線突破 | 查詢 technical_signals 表 |
| M08 基本面 | FUNDAMENTAL | PE 偏低、ROE 提升、營收創高 | 查詢 fundamental_signals 表 |
| M09 籌碼 | CHIP | 外資連買、融資減少、主力進場 | 查詢 chip_signals 表 |
| M10 型態 | PATTERN | 頭肩底完成、突破頸線、雙底 | 查詢 pattern_signals 表 |
| M11 策略 | STRATEGY | 動能策略買入、價值策略觸發 | 查詢 strategy_signals 表 |
| M12 產業 | INDUSTRY | 產業轉強、經濟週期轉換 | 查詢 industry_signals 表 |

**原始信號統一格式**:
```json
{
  "source_signal_id": "TECH_SIG_2024122401",
  "source_module": "M07",
  "signal_type": "TECHNICAL",
  "signal_code": "RSI_OVERSOLD",
  "signal_name": "RSI 超賣反彈",
  "stock_id": "2330",
  "signal_date": "2024-12-24",
  "signal_direction": "BUY",
  "source_confidence": 0.75,
  "signal_metadata": {
    "rsi_value": 25.5,
    "threshold": 30,
    "indicator": "RSI_14"
  },
  "created_at": "2024-12-24T16:30:00+08:00"
}
```

**收集策略**:
- **即時收集**: 監聽各模組發布的信號事件
- **批次收集**: 每日定時批次查詢未消費的信號
- **冪等性**: 使用 source_signal_id 確保不重複收集

**驗收條件**:
- [ ] 支援從 6 個上游模組收集信號
- [ ] 信號格式統一轉換
- [ ] 收集過程記錄完整日誌
- [ ] 支援事件驅動與批次兩種模式

---

### F-M13-002: 信號去重

**功能描述**: 識別並處理重複或高度相似的信號

**去重規則**:

| 去重類型 | 判斷條件 | 處理方式 |
|---------|---------|---------|
| 完全重複 | 同股票 + 同信號類型 + 同日期 | 保留信心度最高者 |
| 語義重複 | 同股票 + 相關信號類型（如 RSI 超賣 + KD 超賣） | 合併為一個信號 |
| 時間重複 | 同股票 + 同信號類型 + 3 日內 | 僅保留最新者 |
| 來源重複 | 同一底層指標觸發多信號 | 合併並標註來源 |

**語義相關信號群組**:
```json
{
  "oversold_group": [
    "RSI_OVERSOLD", "KD_OVERSOLD", "WILLIAMS_OVERSOLD"
  ],
  "overbought_group": [
    "RSI_OVERBOUGHT", "KD_OVERBOUGHT", "WILLIAMS_OVERBOUGHT"
  ],
  "golden_cross_group": [
    "MACD_GOLDEN_CROSS", "MA_GOLDEN_CROSS", "KD_GOLDEN_CROSS"
  ],
  "institutional_buy_group": [
    "FOREIGN_BUY", "TRUST_BUY", "DEALER_BUY", "TOTAL_INSTITUTIONAL_BUY"
  ]
}
```

**去重演算法**:
```python
def deduplicate_signals(raw_signals):
    # 1. 按股票分組
    signals_by_stock = group_by(raw_signals, 'stock_id')

    deduplicated = []
    for stock_id, signals in signals_by_stock.items():
        # 2. 完全重複去除
        unique_signals = remove_exact_duplicates(signals)

        # 3. 語義重複合併
        merged_signals = merge_semantic_duplicates(unique_signals)

        # 4. 時間重複去除
        latest_signals = keep_latest_within_window(merged_signals, days=3)

        deduplicated.extend(latest_signals)

    return deduplicated
```

**驗收條件**:
- [ ] 完全重複信號被正確去除
- [ ] 語義相關信號被正確合併
- [ ] 去重後信號數量明顯減少
- [ ] 去重過程可追溯

---

### F-M13-003: 信號合併

**功能描述**: 將同一股票的多個信號合併為綜合信號

**合併邏輯**:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          信號合併流程                                        │
└─────────────────────────────────────────────────────────────────────────────┘

股票 2330 的原始信號:
┌─────────────────────────────────────────────────────────────────────────────┐
│ 技術信號: RSI 超賣反彈 (BUY, confidence: 0.75)                              │
│ 籌碼信號: 外資連續買超 5 日 (BUY, confidence: 0.82)                         │
│ 基本面信號: PE 低於歷史 20% (BUY, confidence: 0.68)                         │
│ 型態信號: 雙底完成 (BUY, confidence: 0.70)                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                          ┌─────────────────┐
                          │   信號合併器    │
                          │                 │
                          │ 1. 方向一致性   │
                          │ 2. 信心度加權   │
                          │ 3. 維度覆蓋度   │
                          └─────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 統一信號:                                                                   │
│ {                                                                           │
│   "stock_id": "2330",                                                       │
│   "unified_direction": "BUY",                                               │
│   "direction_strength": "STRONG",  // 4 個 BUY 信號，方向一致              │
│   "unified_confidence": 0.82,      // 加權平均                             │
│   "dimension_coverage": 4,         // 覆蓋 4 個分析維度                    │
│   "contributing_signals": [...]                                             │
│ }                                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

**方向一致性判斷**:

| 買入信號數 | 賣出信號數 | 方向強度 | 統一方向 |
|-----------|-----------|---------|---------|
| >= 3 | 0 | STRONG | BUY |
| 2 | 0-1 | MODERATE | BUY |
| 1 | 0 | WEAK | BUY |
| 0 | >= 3 | STRONG | SELL |
| 0-1 | 2 | MODERATE | SELL |
| 0 | 1 | WEAK | SELL |
| >= 2 | >= 2 | CONFLICT | HOLD |

**維度覆蓋權重**:

| 分析維度 | 權重 | 說明 |
|---------|------|------|
| 技術分析 (M07) | 0.20 | 價格趨勢 |
| 基本面 (M08) | 0.20 | 內在價值 |
| 籌碼 (M09) | 0.20 | 資金流向 |
| 型態 (M10) | 0.15 | 圖形技術 |
| 策略 (M11) | 0.15 | 量化模型 |
| 產業 (M12) | 0.10 | 宏觀背景 |

**驗收條件**:
- [ ] 同股票多信號正確合併
- [ ] 方向一致性正確判斷
- [ ] 維度覆蓋度正確計算
- [ ] 合併後保留原始信號追溯

---

### F-M13-004: 信號評分

**功能描述**: 基於多維度因素對統一信號進行綜合評分

**評分維度**:

| 維度 | 權重 | 評分因素 | 分數範圍 |
|-----|------|---------|---------|
| 信號強度 | 30% | 方向一致性、信心度 | 0-100 |
| 維度覆蓋 | 25% | 觸發信號的分析維度數量 | 0-100 |
| 歷史績效 | 20% | 類似信號的歷史準確率 | 0-100 |
| 市場環境 | 15% | 大盤趨勢、產業強弱 | 0-100 |
| 時效性 | 10% | 信號新鮮度 | 0-100 |

**評分公式**:
```
UnifiedScore =
    0.30 × SignalStrengthScore +
    0.25 × DimensionCoverageScore +
    0.20 × HistoricalPerformanceScore +
    0.15 × MarketEnvironmentScore +
    0.10 × FreshnessScore
```

**各維度評分細則**:

**1. 信號強度評分**:
```python
def calculate_signal_strength_score(signal):
    # 方向一致性分數
    direction_score = {
        'STRONG': 100,
        'MODERATE': 70,
        'WEAK': 40,
        'CONFLICT': 20
    }[signal.direction_strength]

    # 信心度分數
    confidence_score = signal.unified_confidence * 100

    return direction_score * 0.6 + confidence_score * 0.4
```

**2. 維度覆蓋評分**:
```python
def calculate_dimension_coverage_score(signal):
    coverage = signal.dimension_coverage
    max_dimensions = 6

    # 基礎分數
    base_score = (coverage / max_dimensions) * 80

    # 加分：覆蓋重要維度
    bonus = 0
    if has_technical_signal(signal): bonus += 5
    if has_chip_signal(signal): bonus += 5
    if has_fundamental_signal(signal): bonus += 5
    if has_strategy_signal(signal): bonus += 5

    return min(base_score + bonus, 100)
```

**3. 歷史績效評分**:
```python
def calculate_historical_performance_score(signal):
    # 查詢類似信號組合的歷史表現
    historical_accuracy = get_historical_accuracy(
        signal.contributing_signals,
        lookback_days=90
    )

    # 基於勝率評分
    if historical_accuracy >= 0.7:
        return 100
    elif historical_accuracy >= 0.6:
        return 80
    elif historical_accuracy >= 0.5:
        return 60
    else:
        return 40
```

**評分結果分級**:

| 分數區間 | 評級 | 說明 |
|---------|------|------|
| 90-100 | A+ | 極強信號，多維度一致看多/空 |
| 80-89 | A | 強信號，建議優先關注 |
| 70-79 | B+ | 中強信號，可納入觀察 |
| 60-69 | B | 一般信號，需搭配其他判斷 |
| 50-59 | C | 弱信號，參考價值較低 |
| < 50 | D | 極弱或衝突信號 |

**驗收條件**:
- [ ] 5 個評分維度正確計算
- [ ] 加權評分正確
- [ ] 評級分類正確
- [ ] 評分可追溯可解釋

---

### F-M13-005: 信號排序

**功能描述**: 依評分排序產生每日推薦清單

**排序規則**:

1. **主排序**: 統一評分（降序）
2. **次排序**: 維度覆蓋數（降序）
3. **三級排序**: 信號時間（降序，較新優先）

**每日推薦清單**:
```json
{
  "trade_date": "2024-12-24",
  "generated_at": "2024-12-24T17:30:00+08:00",
  "buy_signals": [
    {
      "rank": 1,
      "stock_id": "2330",
      "stock_name": "台積電",
      "unified_score": 92.5,
      "grade": "A+",
      "direction": "BUY",
      "direction_strength": "STRONG",
      "dimension_coverage": 5,
      "key_factors": ["外資連買", "RSI 超賣反彈", "PE 歷史低位"]
    },
    {
      "rank": 2,
      "stock_id": "2454",
      "stock_name": "聯發科",
      "unified_score": 88.3,
      "grade": "A",
      "direction": "BUY",
      "direction_strength": "STRONG",
      "dimension_coverage": 4,
      "key_factors": ["動能策略觸發", "產業轉強"]
    }
  ],
  "sell_signals": [...],
  "total_buy_signals": 45,
  "total_sell_signals": 12
}
```

**驗收條件**:
- [ ] 排序邏輯正確
- [ ] 每日產生買入/賣出推薦清單
- [ ] 支援指定 Top N 查詢
- [ ] 包含關鍵因素摘要

---

### F-M13-006: 信號分類

**功能描述**: 依信號類型、強度進行分類標籤

**分類維度**:

**1. 信號方向分類**:
- BUY: 買入信號
- SELL: 賣出信號
- HOLD: 觀望信號

**2. 信號強度分類**:
- STRONG: 強烈信號（多維度一致）
- MODERATE: 中等信號
- WEAK: 弱信號
- CONFLICT: 衝突信號

**3. 信號類型標籤**:
| 標籤 | 說明 | 範例 |
|-----|------|------|
| MOMENTUM | 動能型信號 | RSI 突破、MACD 黃金交叉 |
| VALUE | 價值型信號 | PE 偏低、股利率高 |
| INSTITUTIONAL | 法人動向信號 | 外資買超、主力進場 |
| PATTERN | 型態突破信號 | 雙底、頭肩底 |
| SECTOR | 產業輪動信號 | 產業轉強 |
| STRATEGY | 策略觸發信號 | 量化策略買入 |

**4. 時效性分類**:
- INTRADAY: 當日有效
- SHORT_TERM: 短期（1-5 日）
- MEDIUM_TERM: 中期（5-20 日）
- LONG_TERM: 長期（20 日以上）

**驗收條件**:
- [ ] 支援多維度分類標籤
- [ ] 標籤可組合查詢
- [ ] 分類結果可用於篩選

---

### F-M13-007: 信號查詢

**功能描述**: 提供多維度信號查詢接口

**查詢維度**:

| 查詢條件 | 說明 |
|---------|------|
| stock_id | 指定股票 |
| trade_date | 信號日期 |
| direction | 信號方向（BUY/SELL/HOLD） |
| grade | 評級（A+/A/B+/B/C/D） |
| min_score | 最低評分 |
| signal_types | 信號類型標籤 |
| source_modules | 來源模組 |
| sector_code | 產業代碼 |

**驗收條件**:
- [ ] 支援 8 種查詢維度
- [ ] 支援組合查詢
- [ ] 查詢效能符合 SLA
- [ ] 支援分頁

---

### F-M13-008: 信號發布

**功能描述**: 發布統一信號供下游模組消費

**發布方式**:

| 方式 | 適用場景 | 說明 |
|-----|---------|------|
| API 查詢 | 即時查詢 | 下游模組主動拉取 |
| 事件推送 | 即時通知 | 發布事件通知下游 |
| 訂閱機制 | 特定條件 | 符合條件時推送 |

**事件格式**:
```json
{
  "event_type": "UNIFIED_SIGNALS_READY",
  "trade_date": "2024-12-24",
  "summary": {
    "total_signals": 120,
    "buy_signals": 85,
    "sell_signals": 25,
    "hold_signals": 10,
    "grade_distribution": {
      "A+": 8,
      "A": 22,
      "B+": 35,
      "B": 30,
      "C": 20,
      "D": 5
    }
  },
  "timestamp": "2024-12-24T17:30:00+08:00"
}
```

**消費者標記**:
- 下游模組消費信號後標記 `is_consumed`
- 記錄消費時間與消費者

**驗收條件**:
- [ ] API 接口正常提供
- [ ] 事件通知正確發送
- [ ] 消費狀態正確追蹤
- [ ] 支援多消費者同時消費

---

## 4. 系統架構

### 4.1 SignalEngine 架構

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            M13 SignalEngine                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        SignalCollector                               │   │
│  │                        (信號收集器)                                  │   │
│  │  - 從 M07/M08/M09/M10/M11/M12 收集原始信號                          │   │
│  │  - 格式轉換為統一格式                                                │   │
│  │  - 記錄收集日誌                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        SignalDeduplicator                            │   │
│  │                        (信號去重器)                                  │   │
│  │  - 完全重複去除                                                      │   │
│  │  - 語義重複合併                                                      │   │
│  │  - 時間窗口去重                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        SignalMerger                                  │   │
│  │                        (信號合併器)                                  │   │
│  │  - 同股票信號合併                                                    │   │
│  │  - 方向一致性判斷                                                    │   │
│  │  - 維度覆蓋計算                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        SignalScorer                                  │   │
│  │                        (信號評分器)                                  │   │
│  │  - 5 維度評分                                                        │   │
│  │  - 加權計算                                                          │   │
│  │  - 評級分類                                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        SignalPublisher                               │   │
│  │                        (信號發布器)                                  │   │
│  │  - 儲存統一信號                                                      │   │
│  │  - 發布事件通知                                                      │   │
│  │  - 提供查詢接口                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 技術選型

| 層級 | 技術選擇 | 說明 |
|-----|---------|------|
| 持久層 | JPA + MyBatis | JPA 處理 CRUD，MyBatis 處理複雜聚合查詢 |
| 快取 | Redis | 信號快取、排行榜快取 |
| 排程 | Quartz | 定時批次處理 |
| 事件 | Spring Events | 內部事件驅動 |
| API | REST | 提供查詢接口 |

---

## 5. 非功能性需求

| 需求類型 | 需求內容 | 目標值 |
|---------|---------|-------|
| 效能 | 信號查詢回應時間 | P95 < 100ms |
| 效能 | 每日信號處理完成時間 | < 10 分鐘 |
| 可用性 | 服務可用率 | 99.5% |
| 擴展性 | 支援日信號數量 | > 10,000 筆 |
| 準確性 | 去重準確率 | > 98% |
| 可追溯 | 信號來源可追溯 | 100% |

---

## 6. 驗收標準

### 6.1 功能驗收

- [ ] 所有 8 項功能通過單元測試
- [ ] 6 個上游模組信號正確收集
- [ ] 去重邏輯正確執行
- [ ] 評分結果合理可解釋
- [ ] 5 個下游模組可正常消費

### 6.2 整合驗收

- [ ] 與 M07-M12 整合正常
- [ ] 與 M14-M18 整合正常
- [ ] API 回應時間符合 SLA
- [ ] 信號追溯鏈完整

---

## 📚 相關文檔

- [M13 API 規格](../api/M13-API規格.md)
- [M13 資料庫設計](../../design/M13-資料庫設計.md)
- [M13 業務流程](../../design/M13-業務流程.md)
- [M11 量化策略模組](./M11-量化策略功能需求.md)
- [M12 總經產業模組](./M12-總經產業分析功能需求.md)

---

**文件維護者**: 產品經理
**最後更新**: 2026-01-14
**下次審核**: 2026-04-14
