# M17-風險管理功能需求

> **文件編號**: FUNC-M17
> **模組名稱**: 風險管理模組 (Risk Management Module)
> **版本**: v1.0
> **最後更新**: 2026-01-15
> **狀態**: Draft

---

## 1. 模組概述

### 1.1 模組定位

M17 風險管理模組是 Layer 6 管理層模組，負責監控投資組合的風險暴露、計算風險指標、設定風險限額並發出風險預警。本模組整合 M06 的價格數據、M07 的技術指標與 M13 的統一信號，為 M18 投資組合管理提供風險評估與控制功能。

```
┌─────────────────────────────────────────────────────────────────┐
│                    M17 風險管理模組定位                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Layer 6 管理層                         │   │
│  │                                                           │   │
│  │         ┌──────────┐         ┌──────────┐                │   │
│  │         │   M17    │ ◄─────► │   M18    │                │   │
│  │         │ 風險管理 │         │ 投組管理 │                │   │
│  │         └────┬─────┘         └──────────┘                │   │
│  │              │                                            │   │
│  └──────────────┼───────────────────────────────────────────┘   │
│                 │                                               │
│                 ▼                                               │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  上游依賴模組                             │   │
│  │    ┌──────────┐ ┌──────────┐ ┌──────────┐               │   │
│  │    │   M06    │ │   M07    │ │   M13    │               │   │
│  │    │ 股票數據 │ │ 技術指標 │ │ 統一信號 │               │   │
│  │    └──────────┘ └──────────┘ └──────────┘               │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 核心價值

| 價值面向 | 說明 |
|---------|------|
| **風險量化** | 提供專業風險指標：VaR、波動度、最大回撤等 |
| **風險監控** | 即時監控投組風險暴露，及早發現異常 |
| **風險控制** | 設定風險限額，防止過度風險暴露 |
| **風險預警** | 風險超標時發出告警，協助決策 |
| **合規支援** | 提供風險報告，滿足法規要求 |

### 1.3 模組依賴

```
┌─────────────────────────────────────────────────────────────────┐
│                      M17 模組依賴圖                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                      ┌──────────┐                               │
│                      │   M17    │                               │
│                      │ 風險管理 │                               │
│                      └────┬─────┘                               │
│                           │                                     │
│       ┌───────────────────┼───────────────────┐                │
│       │                   │                   │                │
│       ▼                   ▼                   ▼                │
│  ┌──────────┐       ┌──────────┐       ┌──────────┐           │
│  │   M06    │       │   M07    │       │   M13    │           │
│  │ 股票數據 │       │ 技術指標 │       │ 統一信號 │           │
│  │ • 日K線  │       │ • 波動度 │       │ • 風險   │           │
│  │ • 報酬率 │       │ • ATR    │       │   評估   │           │
│  └──────────┘       └──────────┘       └──────────┘           │
│                                                                │
└─────────────────────────────────────────────────────────────────┘
```

| 依賴模組 | 依賴內容 | 用途 |
|---------|---------|------|
| M06 | stock_daily, stocks | 歷史價格、報酬率計算 |
| M07 | technical_indicators (ATR, 波動度) | 風險指標輸入 |
| M13 | unified_signals | 信號風險評估 |

### 1.4 被依賴關係

| 下游模組 | 依賴內容 | 用途 |
|---------|---------|------|
| M18 | risk_assessments, risk_limits | 投組風險控制 |

---

## 2. 功能清單

### 2.1 功能總覽

| 功能編號 | 功能名稱 | 優先級 | 說明 |
|---------|---------|:------:|------|
| F-M17-001 | 持倉風險計算 | P0 | 計算個股與組合風險指標 |
| F-M17-002 | VaR 計算 | P0 | Value at Risk 風險值 |
| F-M17-003 | 波動度分析 | P0 | 歷史與隱含波動度 |
| F-M17-004 | 風險限額管理 | P0 | 設定與監控風險限額 |
| F-M17-005 | 風險預警 | P0 | 風險超標告警 |
| F-M17-006 | 相關性分析 | P1 | 持倉相關性矩陣 |
| F-M17-007 | 集中度分析 | P1 | 產業/個股集中度 |
| F-M17-008 | 風險報告 | P1 | 風險評估報告 |
| F-M17-009 | 情境分析 | P2 | 壓力測試 |
| F-M17-010 | Beta 分析 | P2 | 市場風險暴露 |
| F-M17-011 | 風險歸因 | P2 | 風險來源分析 |
| F-M17-012 | 歷史風險查詢 | P2 | 風險指標歷史 |

### 2.2 P0 核心功能詳細需求

#### F-M17-001 持倉風險計算

**功能說明**：計算投資組合中每個持倉及整體組合的風險指標。

**風險指標定義**：

| 指標 | 公式 | 說明 |
|-----|------|------|
| **日報酬率** | (P_t - P_{t-1}) / P_{t-1} | 每日價格變化率 |
| **年化波動度** | std(日報酬率) × √252 | 風險程度衡量 |
| **Beta** | Cov(股票報酬, 市場報酬) / Var(市場報酬) | 系統風險 |
| **最大回撤** | max((峰值 - 谷底) / 峰值) | 最大虧損幅度 |
| **下行波動度** | std(負報酬率) × √252 | 下行風險 |
| **夏普比率** | (年化報酬 - 無風險利率) / 年化波動度 | 風險調整報酬 |

**輸入參數**：

```json
{
  "portfolioId": "PF_001",
  "positions": [
    {"stockId": "2330", "shares": 5000, "avgCost": 520.00},
    {"stockId": "2317", "shares": 10000, "avgCost": 105.00}
  ],
  "calculationDate": "2026-01-15",
  "lookbackDays": 252
}
```

**輸出結果**：

```json
{
  "portfolioId": "PF_001",
  "calculationDate": "2026-01-15",
  "portfolioValue": 3650000,

  "portfolioRisk": {
    "volatility": 0.2235,
    "annualizedReturn": 0.1523,
    "sharpeRatio": 0.68,
    "maxDrawdown": 0.1845,
    "beta": 1.12,
    "var95_1day": 115000,
    "var99_1day": 165000
  },

  "positionRisks": [
    {
      "stockId": "2330",
      "stockName": "台積電",
      "marketValue": 2750000,
      "weight": 0.7534,
      "volatility": 0.2856,
      "beta": 1.25,
      "contribution": 0.1892,
      "marginalVar": 85000
    },
    {
      "stockId": "2317",
      "stockName": "鴻海",
      "marketValue": 1100000,
      "weight": 0.3014,
      "volatility": 0.3124,
      "beta": 1.08,
      "contribution": 0.0826,
      "marginalVar": 42000
    }
  ],

  "riskBreakdown": {
    "systematicRisk": 0.65,
    "idiosyncraticRisk": 0.35,
    "diversificationBenefit": 0.12
  }
}
```

#### F-M17-002 VaR 計算

**功能說明**：計算投資組合的風險值 (Value at Risk)，評估在正常市場條件下的潛在最大損失。

**VaR 計算方法**：

```
┌─────────────────────────────────────────────────────────────────┐
│                      VaR 計算方法                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 歷史模擬法 (Historical Simulation)                          │
│  ────────────────────────────────────────────────────────────   │
│  • 使用過去 N 天的實際報酬率分布                                 │
│  • VaR_α = Percentile(historical_returns, α)                   │
│  • 優點：不假設分布、考慮厚尾                                   │
│  • 缺點：依賴歷史數據品質                                       │
│                                                                  │
│  2. 參數法 (Parametric / Variance-Covariance)                   │
│  ────────────────────────────────────────────────────────────   │
│  • 假設報酬率服從常態分布                                       │
│  • VaR_α = μ - Z_α × σ                                         │
│  • 其中 Z_95% = 1.645, Z_99% = 2.326                           │
│  • 優點：計算快速                                               │
│  • 缺點：常態假設可能不適用                                     │
│                                                                  │
│  3. 蒙地卡羅模擬 (Monte Carlo)                                  │
│  ────────────────────────────────────────────────────────────   │
│  • 模擬大量可能的價格路徑                                       │
│  • VaR = Percentile(simulated_returns, α)                      │
│  • 優點：可模擬各種分布、非線性                                 │
│  • 缺點：計算量大                                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**VaR 類型**：

| VaR 類型 | 信心水準 | 持有期間 | 用途 |
|---------|---------|---------|------|
| VaR 95% 1-Day | 95% | 1 天 | 日常監控 |
| VaR 99% 1-Day | 99% | 1 天 | 極端風險 |
| VaR 95% 10-Day | 95% | 10 天 | 法規要求 |
| CVaR (ES) | 95% | 1 天 | 尾部風險 |

**輸出結構**：

```json
{
  "portfolioId": "PF_001",
  "calculationDate": "2026-01-15",
  "portfolioValue": 3650000,

  "var": {
    "historical": {
      "var95_1day": 115000,
      "var99_1day": 165000,
      "var95_10day": 365000,
      "cvar95_1day": 145000
    },
    "parametric": {
      "var95_1day": 108000,
      "var99_1day": 152000
    },
    "monteCarlo": {
      "var95_1day": 118000,
      "var99_1day": 170000,
      "simulations": 10000
    }
  },

  "interpretation": {
    "var95_1day_pct": 0.0315,
    "meaning": "95% 信心水準下，1 天內損失不超過 115,000 元"
  }
}
```

#### F-M17-003 波動度分析

**功能說明**：計算並分析投資組合的波動度特性。

**波動度類型**：

| 類型 | 計算方式 | 說明 |
|-----|---------|------|
| **歷史波動度** | std(日報酬率) × √252 | 過去實際波動 |
| **EWMA 波動度** | 指數加權移動平均 | 近期權重較高 |
| **Parkinson 波動度** | 基於高低價 | 考慮日內波動 |
| **Garman-Klass 波動度** | 基於 OHLC | 更精確估計 |

**EWMA 波動度公式**：

```
σ²_t = λ × σ²_{t-1} + (1-λ) × r²_{t-1}

其中：
λ = 衰減因子 (通常 0.94)
r = 日報酬率
```

**輸出結構**：

```json
{
  "stockId": "2330",
  "calculationDate": "2026-01-15",

  "volatility": {
    "historical_20d": 0.2156,
    "historical_60d": 0.2385,
    "historical_252d": 0.2856,
    "ewma": 0.2245,
    "parkinson": 0.2512,
    "garmanKlass": 0.2478
  },

  "volatilityTrend": {
    "current": 0.2245,
    "avg30d": 0.2180,
    "avg90d": 0.2350,
    "percentile": 65,
    "trend": "INCREASING"
  },

  "volatilityRegime": {
    "regime": "NORMAL",
    "description": "波動度處於正常範圍"
  }
}
```

#### F-M17-004 風險限額管理

**功能說明**：設定並監控各類風險限額，確保風險在可控範圍內。

**風險限額類型**：

| 限額類型 | 說明 | 範例 |
|---------|------|------|
| **VaR 限額** | 每日 VaR 上限 | VaR_95 ≤ 5% 資產 |
| **波動度限額** | 組合波動度上限 | σ ≤ 25% |
| **單一持股限額** | 單一股票權重上限 | ≤ 20% |
| **產業集中度限額** | 單一產業權重上限 | ≤ 30% |
| **最大回撤限額** | 從高點回撤上限 | ≤ 15% |
| **Beta 限額** | 市場曝險上限 | 0.8 ≤ β ≤ 1.2 |

**限額設定**：

```json
{
  "portfolioId": "PF_001",
  "limits": [
    {
      "limitId": "LMT_001",
      "limitType": "VAR_95_1DAY",
      "limitValue": 0.05,
      "action": "ALERT",
      "description": "日 VaR95 不超過資產 5%"
    },
    {
      "limitId": "LMT_002",
      "limitType": "SINGLE_STOCK_WEIGHT",
      "limitValue": 0.20,
      "action": "BLOCK",
      "description": "單一持股不超過 20%"
    },
    {
      "limitId": "LMT_003",
      "limitType": "SECTOR_CONCENTRATION",
      "limitValue": 0.30,
      "sector": "TECH",
      "action": "ALERT",
      "description": "科技業不超過 30%"
    },
    {
      "limitId": "LMT_004",
      "limitType": "MAX_DRAWDOWN",
      "limitValue": 0.15,
      "action": "ALERT",
      "description": "最大回撤不超過 15%"
    }
  ]
}
```

**限額監控結果**：

```json
{
  "portfolioId": "PF_001",
  "checkDate": "2026-01-15",
  "overallStatus": "WARNING",

  "limitChecks": [
    {
      "limitId": "LMT_001",
      "limitType": "VAR_95_1DAY",
      "limitValue": 0.05,
      "currentValue": 0.0315,
      "utilization": 0.63,
      "status": "OK",
      "headroom": 0.0185
    },
    {
      "limitId": "LMT_002",
      "limitType": "SINGLE_STOCK_WEIGHT",
      "limitValue": 0.20,
      "currentValue": 0.2534,
      "utilization": 1.267,
      "status": "BREACH",
      "breach": {
        "stockId": "2330",
        "currentWeight": 0.2534,
        "excessWeight": 0.0534
      }
    }
  ],

  "breachCount": 1,
  "warningCount": 0
}
```

#### F-M17-005 風險預警

**功能說明**：當風險指標超過閾值時，自動發出預警通知。

**預警類型**：

| 預警等級 | 觸發條件 | 行動 |
|---------|---------|------|
| INFO | 利用率 > 70% | 記錄日誌 |
| WARNING | 利用率 > 85% | 發送通知 |
| ALERT | 利用率 > 95% | 發送緊急通知 |
| BREACH | 利用率 > 100% | 發送警報 + 建議行動 |

**預警通知結構**：

```json
{
  "alertId": "ALT_20260115_001",
  "portfolioId": "PF_001",
  "alertTime": "2026-01-15T14:30:00+08:00",
  "alertLevel": "BREACH",
  "alertType": "LIMIT_BREACH",

  "details": {
    "limitType": "SINGLE_STOCK_WEIGHT",
    "limitValue": 0.20,
    "currentValue": 0.2534,
    "breachAmount": 0.0534,
    "affectedStock": "2330"
  },

  "recommendation": {
    "action": "REDUCE_POSITION",
    "description": "建議減持台積電 534,000 元以符合限額",
    "targetWeight": 0.20
  },

  "notification": {
    "channels": ["EMAIL", "PUSH"],
    "status": "SENT"
  }
}
```

### 2.3 P1 進階功能詳細需求

#### F-M17-006 相關性分析

**功能說明**：計算持倉之間的相關性矩陣，評估分散化效果。

**輸出結構**：

```json
{
  "portfolioId": "PF_001",
  "calculationDate": "2026-01-15",
  "lookbackDays": 60,

  "correlationMatrix": {
    "stocks": ["2330", "2317", "2454", "2881"],
    "matrix": [
      [1.00, 0.72, 0.85, 0.35],
      [0.72, 1.00, 0.68, 0.42],
      [0.85, 0.68, 1.00, 0.28],
      [0.35, 0.42, 0.28, 1.00]
    ]
  },

  "analysis": {
    "avgCorrelation": 0.52,
    "maxCorrelation": {"pair": ["2330", "2454"], "value": 0.85},
    "minCorrelation": {"pair": ["2454", "2881"], "value": 0.28},
    "diversificationScore": 0.65,
    "highlyCorrelatedPairs": [
      {"pair": ["2330", "2454"], "correlation": 0.85}
    ]
  }
}
```

#### F-M17-007 集中度分析

**功能說明**：分析投資組合的集中度風險。

**集中度指標**：

| 指標 | 公式 | 說明 |
|-----|------|------|
| **HHI** | Σ(w_i)² | 赫芬達爾指數 |
| **Top5 權重** | Σ(前5大持股權重) | 大戶集中度 |
| **產業 HHI** | Σ(產業權重)² | 產業集中度 |
| **有效持股數** | 1 / HHI | 等效分散數 |

**輸出結構**：

```json
{
  "portfolioId": "PF_001",
  "calculationDate": "2026-01-15",

  "stockConcentration": {
    "hhi": 0.2845,
    "effectiveStocks": 3.52,
    "top5Weight": 0.92,
    "top10Weight": 1.00,
    "concentrationLevel": "HIGH"
  },

  "sectorConcentration": {
    "hhi": 0.4523,
    "effectiveSectors": 2.21,
    "distribution": [
      {"sector": "半導體", "weight": 0.58},
      {"sector": "電子零組件", "weight": 0.25},
      {"sector": "金融", "weight": 0.17}
    ],
    "concentrationLevel": "HIGH"
  },

  "recommendation": {
    "message": "組合集中度偏高，建議增加分散化",
    "suggestedSectors": ["傳產", "生技"]
  }
}
```

#### F-M17-008 風險報告

**功能說明**：產生完整的風險評估報告。

**報告內容**：

```json
{
  "reportId": "RPT_RISK_20260115_001",
  "portfolioId": "PF_001",
  "reportDate": "2026-01-15",
  "reportType": "DAILY",

  "executiveSummary": {
    "portfolioValue": 3650000,
    "dailyPnL": 45000,
    "dailyReturn": 0.0125,
    "riskLevel": "MODERATE",
    "limitBreaches": 1,
    "keyRisks": ["單一持股集中度過高", "科技業曝險偏高"]
  },

  "riskMetrics": {
    "var95_1day": 115000,
    "var99_1day": 165000,
    "volatility": 0.2235,
    "beta": 1.12,
    "sharpeRatio": 0.68,
    "maxDrawdown": 0.1845
  },

  "limitStatus": {
    "summary": {"ok": 3, "warning": 1, "breach": 1},
    "details": []
  },

  "concentrationAnalysis": {},
  "correlationHighlights": {},

  "historicalComparison": {
    "var_percentile_30d": 72,
    "volatility_percentile_30d": 65
  }
}
```

### 2.4 P2 次要功能

#### F-M17-009 情境分析 (壓力測試)

**功能說明**：模擬極端市場情境對組合的影響。

**預設情境**：

| 情境 | 描述 | 參數 |
|-----|------|------|
| 市場大跌 | 加權指數下跌 10% | 各股依 Beta 調整 |
| 2008 金融海嘯 | 重演 2008 走勢 | 歷史數據 |
| 利率上升 | 升息 1% | 利率敏感度 |
| 科技股崩盤 | 科技股下跌 20% | 產業調整 |
| 自訂情境 | 用戶定義 | 自訂參數 |

**輸出結構**：

```json
{
  "portfolioId": "PF_001",
  "scenarios": [
    {
      "scenarioName": "市場大跌 10%",
      "portfolioImpact": -412000,
      "impactPct": -0.1129,
      "positionImpacts": [
        {"stockId": "2330", "impact": -343750, "pct": -0.125},
        {"stockId": "2317", "impact": -118800, "pct": -0.108}
      ]
    },
    {
      "scenarioName": "科技股崩盤",
      "portfolioImpact": -715000,
      "impactPct": -0.1959
    }
  ]
}
```

---

## 3. 非功能性需求

### 3.1 效能需求

| 指標 | 目標值 | 說明 |
|-----|-------|------|
| 單組合風險計算 | < 2 秒 | 含 VaR、波動度 |
| 限額檢查 | < 500ms | 即時檢查 |
| 相關性矩陣 (20股) | < 3 秒 | 60 日回溯 |
| 情境分析 (5情境) | < 5 秒 | 含所有持股 |

### 3.2 計算頻率

| 計算類型 | 頻率 | 說明 |
|---------|------|------|
| VaR 計算 | 每日收盤後 | 批次計算 |
| 限額監控 | 即時 | 交易時觸發 |
| 波動度更新 | 每日 | 與 VaR 同步 |
| 風險報告 | 每日/每週 | 定時產生 |

---

## 4. 錯誤碼定義

| 錯誤碼 | 說明 | HTTP Status |
|-------|------|-------------|
| M17-001 | 投組不存在 | 404 |
| M17-002 | 歷史數據不足 | 400 |
| M17-003 | 無效的風險限額設定 | 400 |
| M17-004 | 計算失敗 | 500 |
| M17-005 | 限額 ID 不存在 | 404 |
| M17-006 | 情境定義無效 | 400 |
| M17-007 | 報告產生失敗 | 500 |

---

## 5. 相關文檔

- [M17 API 規格](../api/M17-API規格.md)
- [M17 資料庫設計](../../design/M17-資料庫設計.md)
- [M17 ERD](../../design/erd/M17-ERD.md)
- [M17 業務流程](../../design/M17-業務流程.md)
- [M18 投資組合管理功能需求](./M18-投資組合管理功能需求.md)

---

**文件維護者**: 後端工程師
**最後更新**: 2026-01-15
**下次審核**: 2026-04-15
