# M06-資料管理模組功能需求

> **文件編號**: SPEC-FUNC-M06  
> **模組名稱**: 資料管理模組  
> **版本**: v2.0  
> **最後更新**: 2025-12-31  
> **狀態**: Draft

---

## 1. 模組概述

### 1.1 模組定位

資料管理模組是整個系統的**基礎層（Layer 1）**，負責：
- 從外部資料源獲取股票相關資料
- 清洗、驗證資料品質
- 儲存至 PostgreSQL 資料庫
- 提供資料查詢 API 給其他模組使用
- 管理資料生命週期（歸檔、清理）

**核心價值**: 為所有上層模組（分析、信號、選股等）提供乾淨、正確、即時的資料基礎。

### 1.2 模組目標

- ✅ 自動化資料獲取：每日自動同步台股股價、財報、籌碼資料
- ✅ 資料品質保證：確保資料完整、準確、一致（參照總綱 4.7 資料品質規範）
- ✅ 高效資料存取：透過快取與索引優化查詢效能
- ✅ 多資料源支援：整合 Yahoo Finance、證交所、FinMind 等資料源
- ✅ 容錯與備援：資料源失敗時自動切換備援
- ✅ 冪等性保證：所有 Job 遵守總綱 4.5 Job 模型的冪等性要求

### 1.3 功能範圍

**包含功能**:
1. 股票基本資料管理（股票代碼、名稱、產業分類）
2. 股價歷史資料同步（開高低收量）
3. 財務報表資料同步（季報、年報）
4. 籌碼資料同步（三大法人、融資融券、董監持股）
5. 交易日曆管理
6. 資料品質檢核（參照總綱 4.7）
7. 資料更新排程（參照總綱 4.5 Job 模型）

**不包含功能**:
- 資料分析與計算（由 M07, M08, M09 負責）
- 信號產生（由 M13 負責）
- 即時報價串流（使用延遲報價）

### 1.4 依賴關係

**上游依賴**: 無（Layer 1 基礎模組）

**下游依賴**: 
- M07 技術分析模組
- M08 基本面分析模組
- M09 籌碼分析模組
- M10 技術型態辨識模組
- M12 總經與產業分析模組
- M13 信號判斷引擎
- M14 選股引擎
- M16 回測系統
- M17 風險管理模組
- M18 投資組合管理

**外部依賴**:
- Yahoo Finance API
- 台灣證券交易所公開資訊
- 公開資訊觀測站
- FinMind API（可選）

---


---

## 2. 功能需求

### 2.1 功能清單

| 功能編號 | 功能名稱 | 優先級 | 說明 | 持久層 |
|---------|---------|-------|------|-------|
| F-M06-001 | 股票清單管理 | P0 | 維護台股上市櫃公司清單 | JPA |
| F-M06-002 | 股價資料同步 | P0 | 每日同步股價資料（OHLCV） | MyBatis |
| F-M06-003 | 財報資料同步 | P1 | 每季同步財務報表資料 | MyBatis |
| F-M06-004 | 籌碼資料同步 | P1 | 每日同步三大法人、融資融券資料 | MyBatis |
| F-M06-005 | 交易日曆管理 | P0 | 維護交易日與假日資訊 | JPA |
| F-M06-006 | 資料品質檢核 | P0 | 驗證資料完整性與一致性 | MyBatis |
| F-M06-007 | 資料查詢 API | P0 | 提供股票資料查詢介面 | JPA + MyBatis |
| F-M06-008 | 資料更新排程 | P0 | 定時自動執行資料同步 | - |
| F-M06-009 | 資料補齊機制 | P1 | 補齊缺失的歷史資料 | MyBatis |
| F-M06-010 | 資料源備援 | P2 | 主資料源失敗時切換備援 | - |

### 2.2 用例說明

#### UC-M06-001: 每日股價資料同步

**參與者**: 系統排程器  
**前置條件**: 
- 當日為交易日
- 收盤後（15:00 之後）

**主要流程**:
1. 系統於每日 15:00 觸發股價同步 Job（參照總綱 4.5 Job 模型）
2. 建立 Job 執行記錄（job_executions 表，status='RUNNING'）
3. 從 Yahoo Finance 獲取所有上市櫃股票當日股價
4. 驗證資料品質（參照總綱 4.7 資料品質規範）
   - 四價關係：`low <= open,close <= high`
   - 價格變動：不超過 ±10%（漲跌停幅度）
   - 成交量非負
5. 使用 MyBatis 批次 UPSERT 儲存至 stock_prices 表
6. 更新 Redis 快取（熱門股票）
7. 更新 Job 執行記錄（status='SUCCESS', end_time, statistics）
8. 發布 StockPriceUpdated 事件

**後置條件**:
- 當日股價資料已儲存
- Job 執行記錄狀態為 SUCCESS
- Redis 快取已更新
- 事件已發布給訂閱者

**替代流程**:
- 4a. 資料驗證失敗 → 記錄到 data_quality_issues 表，跳過該股票，繼續處理其他股票
- 3a. Yahoo Finance 失敗 → 切換至備援資料源（證交所 API）
- 5a. 資料庫錯誤 → 回滾交易，更新 Job 狀態為 FAILED，觸發重試機制

**冪等性設計**:
- 使用 PostgreSQL `ON CONFLICT ... DO UPDATE`
- 重複執行同一日期的 Job 不會產生重複資料
- Job 參數包含 trade_date，確保可追溯與重跑

---

#### UC-M06-002: 查詢股票歷史股價

**參與者**: 其他模組（M07, M08, M13 等）  
**前置條件**: 股票代碼存在

**主要流程**:
1. 接收查詢請求（stock_id, start_date, end_date）
2. 參數驗證（日期格式、範圍合理性）
3. 檢查 Redis 快取（快取 Key: `stock:prices:{stock_id}:{start_date}:{end_date}`）
4. 若快取命中 → 直接返回
5. 若快取未命中 → 使用 JPA Repository 查詢 PostgreSQL
6. 將查詢結果序列化並寫入 Redis 快取
7. 返回結果（遵守總綱 4.4 API Response 格式）

**後置條件**:
- 返回符合條件的股價列表
- 熱資料已快取至 Redis

**替代流程**:
- 1a. 股票代碼不存在 → 返回錯誤碼 M06_STOCK_001（參照總綱 4.4）
- 2a. 參數驗證失敗 → 返回錯誤碼 M06_PARAM_001
- 5a. 資料庫查詢失敗 → 返回錯誤碼 M06_DB_001

---

#### UC-M06-003: 財報資料同步

**參與者**: 系統排程器  
**前置條件**: 
- 財報公告日期已到
- 公開資訊觀測站資料可用

**主要流程**:
1. 系統偵測新財報公告（每季財報公告後 3 個工作日內）
2. 建立 Job 執行記錄（SYNC_FINANCIAL_DATA）
3. 從公開資訊觀測站下載財報資料（XBRL 格式優先）
4. 解析 XBRL/HTML 資料
5. 驗證資料完整性（參照總綱 4.7）
   - 必填欄位檢查（revenue, net_income, total_assets 等）
   - 資產負債平衡：`total_assets = total_liabilities + equity`（容許 ±1% 誤差）
6. 使用 MyBatis 批次儲存至 financial_statements 表
7. 更新 Job 執行記錄（SUCCESS）
8. 發布 FinancialStatementUpdated 事件

**後置條件**:
- 最新財報資料已儲存
- Job 執行記錄已更新
- 事件已發布

**替代流程**:
- 3a. 下載失敗 → 重試 3 次，仍失敗則記錄錯誤
- 4a. 解析失敗 → 記錄 data_quality_issues，標記為 MANUAL_REVIEW
- 6a. 資料庫錯誤 → 回滾交易，Job 狀態設為 FAILED

---

### 2.3 業務規則

#### BR-M06-001: 股價資料驗證規則
遵守總綱 4.7 資料品質規範：

**完整性**:
- stock_id, trade_date, open_price, high_price, low_price, close_price, volume 不可為 NULL

**準確性**:
- 價格 >= 0
- 成交量 >= 0
- 成交金額 = close_price × volume（容許 ±1% 誤差）

**一致性**:
- 四價關係：`low_price <= open_price` AND `low_price <= close_price` AND `high_price >= open_price` AND `high_price >= close_price`

**有效性**:
- 台股漲跌幅限制 ±10%（相較於前一交易日收盤價）
- 交易日期必須為有效交易日（查詢 trading_calendar 表）

**唯一性**:
- (stock_id, trade_date) 為唯一鍵

---

#### BR-M06-002: 資料更新頻率
遵守總綱 4.5 Job 排程規範：

| 資料類型 | 更新頻率 | 執行時間 | Job 名稱 |
|---------|---------|---------|---------|
| 股價資料 | 每交易日 | 15:00 | SYNC_STOCK_PRICES |
| 籌碼資料 | 每交易日 | 15:30 | SYNC_CHIP_DATA |
| 財報資料 | 每季財報公告後 | 手動/自動觸發 | SYNC_FINANCIAL_DATA |
| 股票清單 | 每月 1 日 | 08:00 | SYNC_STOCK_LIST |
| 交易日曆 | 每年 1 月 1 日 | 02:00 | SYNC_TRADING_CALENDAR |

---

#### BR-M06-003: 資料保留政策

| 資料類型 | 保留期限 | 歸檔策略 | 清理策略 |
|---------|---------|---------|---------|
| 股價資料 | 20 年 | 使用 PostgreSQL 分區（每年一個分區） | 每年清理 20 年前資料 |
| 財報資料 | 永久 | 不歸檔 | 不清理 |
| 籌碼資料 | 5 年 | 使用分區（每年一個分區） | 每年清理 5 年前資料 |
| Job 執行記錄 | 3 個月 | 每月歸檔到 job_executions_archive | 每月清理 3 個月前資料 |
| 資料品質問題記錄 | 1 年 | 季度歸檔 | 每季清理 1 年前已解決問題 |

---

#### BR-M06-004: 快取策略
參照總綱快取策略：

| 資料類型 | 快取位置 | TTL | 預熱策略 | 失效策略 |
|---------|---------|-----|---------|---------|
| 熱門股票股價（市值前 50） | Redis | 1 小時 | 系統啟動時載入 | Job 完成後主動更新 |
| 一般股票股價 | Redis | 6 小時 | 首次查詢時載入 | LRU 自動淘汰 |
| 財報資料 | Redis | 24 小時 | 不預熱 | 新財報同步後主動更新 |
| 股票清單 | Redis | 24 小時 | 系統啟動時載入 | 股票清單更新後主動更新 |
| 交易日曆 | Redis | 7 天 | 系統啟動時載入 | 年度更新後主動更新 |

**快取 Key 設計**:
```
stock:info:{stock_id}                              → 股票基本資訊
stock:prices:{stock_id}:{start_date}:{end_date}    → 股價範圍查詢
stock:price:{stock_id}:{trade_date}                → 單日股價
stock:financial:{stock_id}:{year}:{quarter}        → 單季財報
stocks:list:active                                 → 活躍股票清單
trading:calendar:{year}                            → 年度交易日曆
```

---


---

## 📚 相關文檔

- [系統功能總覽](./00-系統功能總覽.md)
- [M06 API規格](../technical/api/M06-API規格.md)
- [M06 資料庫設計](../../design/M06-資料庫設計.md)
- [M06 業務流程](../../design/M06-業務流程.md)

---

**文件維護者**: 系統分析師  
**最後更新**: 2025-12-31
