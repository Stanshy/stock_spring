# M07-技術分析模組功能需求

> **文件編號**: SPEC-FUNC-M07  
> **模組名稱**: 技術分析模組  
> **版本**: v2.0  
> **最後更新**: 2025-12-31  
> **狀態**: Draft

---

## 1. 模組概述

### 1.1 模組定位

技術分析模組是整個系統的**分析層（Layer 2）**，負責：
- 計算 71 個技術指標（趨勢、動能、波動、成交量、支撐壓力、週期、統計、綜合）
- 儲存指標計算結果至 PostgreSQL 資料庫
- 提供指標查詢 API 給信號判斷引擎、選股引擎使用
- 偵測技術指標的交叉、背離等關鍵訊號
- 管理指標計算的排程與冪等性

**核心價值**: 為信號判斷、選股篩選、策略回測提供完整的技術面量化指標。

### 1.2 模組目標

- ✅ 完整技術指標庫：支援 71 個常用技術指標（參照 technical_indicators_complete.md）
- ✅ 高效計算引擎：使用 pandas-ta 批次計算，優化效能
- ✅ 自動化排程：每日盤後自動計算最新指標（遵守總綱 4.5 Job 模型）
- ✅ 增量計算：只計算新增或變動的資料，避免重複計算
- ✅ 冪等性保證：所有 Job 遵守總綱 4.5 冪等性要求
- ✅ 快取優化：熱門股票指標快取至 Redis，提升查詢效能
- ✅ 信號偵測：自動偵測黃金交叉、死亡交叉、背離等關鍵訊號

### 1.3 功能範圍

**包含功能**:
1. **趨勢指標計算**（18 個）: MA、EMA、MACD、ADX、Aroon、Parabolic SAR、Supertrend、TRIX、Ichimoku Cloud、WMA、HMA、DEMA、TEMA、VWMA、ZLEMA、DMI 等
2. **動能指標計算**（15 個）: RSI、Stochastic (KD)、Stochastic RSI、Williams %R、CCI、MFI、Ultimate Oscillator、ROC、Momentum、CMO、TSI、KST 等
3. **波動性指標計算**（8 個）: Bollinger Bands、Keltner Channel、ATR、Donchian Channel、Standard Deviation、Historical Volatility、Mass Index、Chaikin Volatility
4. **成交量指標計算**（12 個）: Volume、Volume MA、OBV、AD Line、CMF、EMV、Force Index、NVI、PVI、VWAP、PVT 等
5. **支撐壓力指標計算**（5 個）: Pivot Points、Fibonacci Retracement、Fibonacci Extension、Support/Resistance Levels、Price Channels
6. **週期指標計算**（3 個）: Hurst Exponent、Detrended Price Oscillator、Schaff Trend Cycle
7. **統計指標計算**（5 個）: Linear Regression、Linear Regression Slope、R-Squared、Correlation Coefficient、Z-Score
8. **綜合指標計算**（5 個）: Elder Ray、Coppock Curve、Qstick、Vortex Indicator、Balance of Power
9. **指標查詢 API**: 提供單一/批次指標查詢介面
10. **信號偵測**: 黃金交叉、死亡交叉、超買超賣、背離

**不包含功能**:
- 基本面指標計算（由 M08 負責）
- 籌碼指標計算（由 M09 負責）
- 信號評分與合併（由 M13 負責）
- 技術型態辨識（由 M10 負責）

### 1.4 依賴關係

**上游依賴**: 
- M06 資料管理模組（股價資料）

**下游依賴**: 
- M13 信號判斷引擎
- M14 選股引擎
- M16 回測系統
- M17 風險管理模組
- M10 技術型態辨識模組

**外部依賴**:
- pandas-ta（Python 技術指標庫）
- Redis（快取）
- PostgreSQL（資料儲存）

---


---

## 2. 功能需求

### 2.1 功能清單

| 功能編號 | 功能名稱 | 優先級 | 說明 | 持久層 |
|---------|---------|-------|------|-------|
| F-M07-001 | 趨勢指標計算 | P0 | MA、EMA、MACD、ADX 等 18 個指標 | JPA + MyBatis |
| F-M07-002 | 動能指標計算 | P0 | RSI、KD、Williams %R 等 15 個指標 | JPA + MyBatis |
| F-M07-003 | 波動性指標計算 | P0 | Bollinger Bands、ATR 等 8 個指標 | JPA + MyBatis |
| F-M07-004 | 成交量指標計算 | P0 | OBV、AD、VWAP 等 12 個指標 | JPA + MyBatis |
| F-M07-005 | 支撐壓力指標計算 | P1 | Pivot Points、Fibonacci 等 5 個指標 | JPA |
| F-M07-006 | 週期指標計算 | P2 | Hurst、DPO、STC 等 3 個指標 | JPA |
| F-M07-007 | 統計指標計算 | P1 | Linear Regression、R² 等 5 個指標 | JPA |
| F-M07-008 | 綜合指標計算 | P2 | Elder Ray、Vortex 等 5 個指標 | JPA |
| F-M07-009 | 指標查詢 API | P0 | 單一/批次指標查詢 | JPA + MyBatis |
| F-M07-010 | 交叉信號偵測 | P0 | 黃金/死亡交叉、KD 交叉等 | MyBatis |
| F-M07-011 | 超買超賣偵測 | P0 | RSI、KD、Williams %R 超買超賣 | MyBatis |
| F-M07-012 | 背離偵測 | P1 | 價格與指標背離判斷 | MyBatis |
| F-M07-013 | 指標排程計算 | P0 | 每日盤後自動計算 | - |
| F-M07-014 | 增量計算 | P1 | 只計算新增資料 | MyBatis |
| F-M07-015 | 指標快取管理 | P1 | 熱門股票指標快取 | - |

### 2.2 用例說明

#### UC-M07-001: 每日技術指標計算

**參與者**: 系統排程器  
**前置條件**: 
- M06 股價同步已完成
- 收到 StockPriceUpdated 事件

**主要流程**:
1. 系統於每日 15:30 觸發技術指標計算 Job（遵守總綱 4.5 Job 模型）
2. 建立 Job 執行記錄（job_executions 表，status='RUNNING'）
3. 查詢當日已更新股價的股票清單（從 M06 StockPriceUpdated 事件）
4. 對每檔股票執行指標計算：
   - 從 stock_prices 表查詢歷史股價（最近 250 日，用於計算長週期指標）
   - 使用 pandas-ta 批次計算基礎指標組（MA、EMA、RSI、KD、MACD、BBands、ATR、OBV）
   - 驗證計算結果（非 NULL、非 NaN、範圍合理）
   - 使用 MyBatis 批次 UPSERT 儲存至 technical_indicators 表
5. 回寫常用指標至 stock_prices 表（ma5, ma20, volume_ma5）
6. 更新 Redis 快取（熱門股票前 50 檔）
7. 偵測技術信號（黃金交叉、死亡交叉、超買超賣）
8. 產生信號並發布（遵守總綱 4.1 Signal Contract）
9. 更新 Job 執行記錄（status='SUCCESS', 統計資訊）

**後置條件**:
- 當日技術指標已計算並儲存
- Job 執行記錄狀態為 SUCCESS
- Redis 快取已更新
- 技術信號已發布至 M13

**替代流程**:
- 4a. 歷史資料不足（上市未滿 250 日）→ 跳過長週期指標，只計算短週期指標
- 4b. 計算結果異常（NaN、Inf）→ 記錄 data_quality_issues，跳過該股票
- 4c. 資料庫錯誤 → 回滾交易，Job 狀態設為 FAILED，觸發重試
- 7a. 偵測到交叉信號 → 產生 BUY/SELL 信號（遵守總綱 4.1）

**冪等性設計**:
- 使用 PostgreSQL `ON CONFLICT ... DO UPDATE`
- 重複執行同一日期的 Job 不會產生重複指標資料
- Job 參數包含 calculation_date，確保可追溯與重跑

---

#### UC-M07-002: 查詢股票技術指標

**參與者**: 其他模組（M13, M14, M16 等）  
**前置條件**: 股票代碼存在且已計算指標

**主要流程**:
1. 接收查詢請求（stock_id, indicator_names, start_date, end_date）
2. 參數驗證（日期格式、指標名稱有效性）
3. 檢查 Redis 快取（快取 Key: `tech:indicators:{stock_id}:{date}`）
4. 若快取命中 → 直接返回
5. 若快取未命中 → 使用 MyBatis 查詢 PostgreSQL（複雜 JSON 查詢）
6. 將查詢結果序列化並寫入 Redis 快取
7. 返回結果（遵守總綱 4.4 API Response 格式）

**後置條件**:
- 返回符合條件的技術指標資料
- 熱資料已快取至 Redis

**替代流程**:
- 1a. 股票代碼不存在 → 返回錯誤碼 M07_STOCK_001
- 2a. 指標名稱無效 → 返回錯誤碼 M07_INDICATOR_001
- 5a. 指標尚未計算 → 返回空陣列 + 提示訊息

---

#### UC-M07-003: 偵測黃金交叉信號

**參與者**: 技術指標計算引擎  
**前置條件**: 
- MA5, MA20 已計算完成
- 有前一交易日資料可比對

**主要流程**:
1. 取得當日 MA5, MA20 值
2. 取得前一交易日 MA5, MA20 值
3. 判斷交叉條件：
   - 前日：MA5 < MA20
   - 當日：MA5 > MA20
4. 若滿足條件 → 產生 BUY 信號（遵守總綱 4.1 Signal Contract）
5. 填寫信號詳細資訊：
   - signal_type = 'BUY'
   - signal_source = 'M07_TECHNICAL_ANALYSIS'
   - signal_name = 'MA_GOLDEN_CROSS'
   - evidence_data = {indicator: 'MA', ma5: 值, ma20: 值, cross_date: 日期}
   - confidence_score = 70 (基礎信號)
6. 發布信號至 M13 信號判斷引擎

**後置條件**:
- 黃金交叉信號已產生
- 信號已發布至 M13

**替代流程**:
- 3a. 不滿足交叉條件 → 不產生信號
- 3b. 今日是上市首日 → 無前一日資料，不判斷交叉

---

### 2.3 業務規則

#### BR-M07-001: 指標計算規則

**計算優先級**:
| 優先級 | 指標組 | 計算時機 | 原因 |
|-------|-------|---------|------|
| P0 | 基礎組（11 個） | 每日必算 | 最常用，下游依賴 |
| P1 | 進階組（20 個） | 每日必算 | 常用於選股策略 |
| P2 | 專業組（40 個） | 每週計算或按需 | 計算成本高，使用頻率低 |

**基礎組（P0 - 每日必算）**:
- SMA(5, 20, 60)
- EMA(12, 26, 50)
- MACD(12, 26, 9)
- RSI(14)
- Stochastic(9, 3, 3)
- Bollinger Bands(20, 2)
- ATR(14)
- OBV
- Volume MA(5, 20)
- ADX(14)
- VWAP

**進階組（P1 - 每日必算）**:
- WMA(10, 20), HMA(9, 16)
- Stochastic RSI, Williams %R(14), CCI(20), MFI(14)
- Keltner Channel(20, 2), Donchian Channel(20)
- AD Line, CMF(20)
- Aroon(25), Parabolic SAR, Supertrend(10, 3)
- ROC(12), Momentum(10)
- Pivot Points, Fibonacci Retracement
- Linear Regression(14), Slope(14), R-Squared

**專業組（P2 - 按需計算）**:
- DEMA, TEMA, VWMA, ZLEMA
- Ultimate Oscillator, CMO, TSI, KST
- Standard Deviation, Historical Volatility, Mass Index, Chaikin Volatility
- EMV, Force Index, NVI, PVI, PVT
- Fibonacci Extension, Support/Resistance Levels, Price Channels
- Hurst Exponent, DPO, Schaff Trend Cycle
- Correlation Coefficient, Z-Score
- Elder Ray, Coppock Curve, Qstick, Vortex, Balance of Power
- Ichimoku Cloud, TRIX

---

#### BR-M07-002: 指標計算參數標準化

所有指標使用統一的參數設定，遵循業界慣例：

| 指標 | 預設參數 | 說明 |
|-----|---------|------|
| MA | (5, 10, 20, 60, 120, 240) | 常用均線週期 |
| EMA | (12, 26, 50, 200) | MACD 與長期趨勢 |
| MACD | (12, 26, 9) | 標準參數 |
| RSI | (14) | 標準參數 |
| Stochastic | (9, 3, 3) | K 線、D 線參數 |
| Bollinger Bands | (20, 2) | 20 日均線、2 倍標準差 |
| ATR | (14) | 標準參數 |
| ADX | (14) | 標準參數 |
| Williams %R | (14) | 標準參數 |
| CCI | (20) | 標準參數 |
| MFI | (14) | 標準參數 |
| Aroon | (25) | 標準參數 |
| Parabolic SAR | (0.02, 0.2) | 起始值、最大值 |
| Supertrend | (10, 3) | 期間、倍數 |
| Keltner Channel | (20, 2) | EMA 週期、ATR 倍數 |
| Donchian Channel | (20) | 通道週期 |

---

#### BR-M07-003: 指標驗證規則

**完整性**:
- 計算後的指標值不可為 NULL（允許 NaN 用於資料不足期間）

**準確性**:
- RSI 範圍：0-100
- Stochastic %K、%D 範圍：0-100
- Williams %R 範圍：-100 到 0
- CCI 範圍：通常 -200 到 +200
- ADX 範圍：0-100

**合理性**:
- MA 值應接近當期收盤價（誤差 < 20%）
- MACD 柱狀圖不應過大（< 收盤價的 10%）
- Bollinger Bands 上下軌應包含中軌

**一致性**:
- 同一日期、同一股票、同一指標只能有一筆記錄
- 指標時間序列應連續（交易日）

---

#### BR-M07-004: 信號產生規則

**黃金交叉信號**:
- 條件：短期均線上穿長期均線
- 範例：MA5 上穿 MA20、MA20 上穿 MA60
- signal_type = 'BUY'
- confidence_score = 70

**死亡交叉信號**:
- 條件：短期均線下穿長期均線
- 範例：MA5 下穿 MA20、MA20 下穿 MA60
- signal_type = 'SELL'
- confidence_score = 70

**KD 交叉信號**:
- K 線上穿 D 線且 K < 20（低檔黃金交叉）→ BUY，confidence = 75
- K 線下穿 D 線且 K > 80（高檔死亡交叉）→ SELL，confidence = 75

**RSI 超買超賣信號**:
- RSI > 70 → SELL 信號（超買），confidence = 60
- RSI < 30 → BUY 信號（超賣），confidence = 60

**MACD 交叉信號**:
- MACD 線上穿信號線 → BUY，confidence = 70
- MACD 線下穿信號線 → SELL，confidence = 70

**Bollinger Bands 突破信號**:
- 價格跌破下軌後回升 → BUY，confidence = 65
- 價格突破上軌後回落 → SELL，confidence = 65

---

#### BR-M07-005: 快取策略

參照總綱快取策略：

| 資料類型 | 快取位置 | TTL | 預熱策略 | 失效策略 |
|---------|---------|-----|---------|---------|
| 熱門股票指標（市值前 50） | Redis | 1 小時 | Job 完成後主動更新 | 新指標計算完成後主動更新 |
| 一般股票指標 | Redis | 6 小時 | 首次查詢時載入 | LRU 自動淘汰 |
| 單日指標快照 | Redis | 12 小時 | 不預熱 | TTL 自動過期 |
| 指標定義與參數 | Redis | 永久 | 系統啟動時載入 | 配置更新後主動更新 |

**快取 Key 設計**:
```
tech:indicators:{stock_id}:{date}                          → 單日所有指標
tech:indicator:{stock_id}:{indicator_name}:{date}          → 單一指標單日值
tech:indicators:range:{stock_id}:{start}:{end}             → 指標範圍查詢
tech:config:indicators                                     → 指標配置（名稱、參數）
tech:hot:stocks                                            → 熱門股票清單
```

---


---

## 📚 相關文檔

- [系統功能總覽](./00-系統功能總覽.md)
- [M07 API規格](../technical/api/M07-API規格.md)
- [M07 資料庫設計](../../design/M07-資料庫設計.md)
- [M07 業務流程](../../design/M07-業務流程.md)

---

**文件維護者**: 系統分析師  
**最後更新**: 2025-12-31
