# M18-投資組合管理功能需求

> **文件編號**: FUNC-M18
> **模組名稱**: 投資組合管理 (Portfolio Management)
> **版本**: v1.0
> **最後更新**: 2026-01-15
> **狀態**: Draft

---

## 1. 模組概述

### 1.1 模組定位

M18 投資組合管理模組是系統的最終管理層（L6），負責整合所有分析結果與信號，提供完整的投資組合生命週期管理功能。包含投組建立、持倉管理、交易執行、績效追蹤、再平衡建議等核心功能，並與 M17 風險管理模組深度整合，確保投資決策符合風險控管要求。

### 1.2 核心價值

| 價值項目 | 說明 |
|---------|------|
| 統一管理 | 集中管理多個投資組合與持倉 |
| 信號整合 | 自動接收 M13 信號並轉換為交易建議 |
| 績效追蹤 | 完整的績效計算與歸因分析 |
| 風險整合 | 與 M17 整合，確保風險可控 |
| 再平衡優化 | 智能再平衡建議與執行 |

### 1.3 模組依賴

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      M18 投資組合管理 依賴關係                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  上游依賴：                                                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                     │
│  │    M06      │  │    M13      │  │    M17      │                     │
│  │  資料管理    │  │  信號引擎    │  │  風險管理    │                     │
│  ├─────────────┤  ├─────────────┤  ├─────────────┤                     │
│  │ • 股價資料   │  │ • 統一信號   │  │ • VaR 指標   │                     │
│  │ • 基本資料   │  │ • 信號評分   │  │ • 限額檢查   │                     │
│  │ • 指數資料   │  │ • 買賣建議   │  │ • 風險預警   │                     │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                     │
│         │                │                │                             │
│         └────────────────┼────────────────┘                             │
│                          ▼                                               │
│                   ┌─────────────┐                                       │
│                   │    M18      │                                       │
│                   │  投資組合    │                                       │
│                   │    管理      │                                       │
│                   └─────────────┘                                       │
│                                                                          │
│  下游輸出：                                                               │
│  • 投組績效報告                                                          │
│  • 交易執行指令                                                          │
│  • 再平衡建議                                                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.4 技術規格

| 項目 | 規格 |
|-----|------|
| 持久層 | JPA + MyBatis |
| 快取 | Redis (投組快照) |
| 效能目標 | API < 300ms (P95) |
| 最大投組數 | 100 / 用戶 |
| 最大持倉數 | 200 / 投組 |

---

## 2. 功能清單

### 2.1 功能總覽

| 功能編號 | 功能名稱 | 優先級 | 說明 |
|---------|---------|:------:|------|
| F-M18-001 | 投資組合管理 | P0 | 投組 CRUD、設定、狀態管理 |
| F-M18-002 | 持倉管理 | P0 | 持倉記錄、成本計算、市值更新 |
| F-M18-003 | 交易記錄 | P0 | 交易歷史、成本追蹤 |
| F-M18-004 | 績效計算 | P0 | 報酬率、風險調整報酬 |
| F-M18-005 | 投組快照 | P0 | 每日投組狀態快照 |
| F-M18-006 | 信號整合 | P1 | 接收 M13 信號轉交易建議 |
| F-M18-007 | 再平衡建議 | P1 | 目標配置與再平衡計算 |
| F-M18-008 | 績效歸因 | P1 | Brinson 歸因分析 |
| F-M18-009 | 基準比較 | P1 | 與指數基準比較 |
| F-M18-010 | 現金管理 | P1 | 現金部位追蹤 |
| F-M18-011 | 股利追蹤 | P2 | 股利記錄與再投資 |
| F-M18-012 | 投組報告 | P2 | 綜合績效報告生成 |

---

## 3. P0 核心功能詳細需求

### 3.1 F-M18-001 投資組合管理

#### 功能說明
管理用戶的投資組合，包含建立、查詢、更新、刪除等基本操作。

#### 投組屬性

| 屬性 | 類型 | 說明 |
|-----|------|------|
| portfolioId | String | 投組唯一識別碼 |
| portfolioName | String | 投組名稱 |
| portfolioType | Enum | 類型：REAL/VIRTUAL/WATCHLIST |
| initialCapital | Decimal | 初始資金 |
| baseCurrency | String | 基準幣別 (TWD) |
| benchmarkCode | String | 比較基準代碼 |
| status | Enum | 狀態：ACTIVE/SUSPENDED/CLOSED |
| riskProfile | Enum | 風險屬性：CONSERVATIVE/MODERATE/AGGRESSIVE |
| targetAllocation | JSON | 目標配置 |
| rebalancePolicy | JSON | 再平衡政策 |

#### 投組類型

| 類型 | 說明 |
|-----|------|
| REAL | 實際投資組合，追蹤真實持倉 |
| VIRTUAL | 虛擬組合，模擬投資 |
| WATCHLIST | 觀察清單，僅追蹤不計算績效 |

#### 業務規則

```
BR-M18-001-01: 每個用戶最多 100 個投組
BR-M18-001-02: 投組名稱同一用戶下不得重複
BR-M18-001-03: 初始資金必須大於 0
BR-M18-001-04: CLOSED 狀態投組不可進行交易
BR-M18-001-05: 刪除投組需先清空所有持倉
```

---

### 3.2 F-M18-002 持倉管理

#### 功能說明
管理投資組合的股票持倉，包含持倉記錄、成本計算、市值更新。

#### 持倉屬性

| 屬性 | 類型 | 說明 |
|-----|------|------|
| positionId | String | 持倉唯一識別碼 |
| portfolioId | String | 所屬投組 |
| stockId | String | 股票代碼 |
| shares | Integer | 持有股數 |
| avgCost | Decimal | 平均成本 |
| totalCost | Decimal | 總成本 |
| currentPrice | Decimal | 現價 |
| marketValue | Decimal | 市值 |
| unrealizedPnL | Decimal | 未實現損益 |
| unrealizedReturn | Decimal | 未實現報酬率 |
| weight | Decimal | 投組權重 |
| firstBuyDate | Date | 首次買進日期 |
| lastTradeDate | Date | 最近交易日期 |

#### 成本計算方法

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        成本計算方法                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  採用移動加權平均法 (Moving Weighted Average):                            │
│                                                                          │
│  買進時：                                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ new_avg_cost = (old_shares × old_avg_cost + new_shares × price) │   │
│  │                 ─────────────────────────────────────────────    │   │
│  │                         old_shares + new_shares                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  賣出時：                                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • 平均成本不變                                                    │   │
│  │ • 計算已實現損益 = sell_shares × (sell_price - avg_cost)         │   │
│  │ • 扣除交易成本 (手續費 + 證交稅)                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  範例：                                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. 買進 1000 股 @ 100 → avg_cost = 100                          │   │
│  │ 2. 買進 1000 股 @ 120 → avg_cost = (1000×100+1000×120)/2000     │   │
│  │                                   = 110                          │   │
│  │ 3. 賣出 500 股 @ 130 → 已實現損益 = 500 × (130-110) = 10,000    │   │
│  │                        avg_cost 維持 110                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 業務規則

```
BR-M18-002-01: 持倉股數必須 >= 0
BR-M18-002-02: 賣出股數不得超過持有股數
BR-M18-002-03: 市值每日盤後自動更新
BR-M18-002-04: 單一投組最多 200 個持倉
BR-M18-002-05: 持倉為 0 時自動標記為已結清
```

---

### 3.3 F-M18-003 交易記錄

#### 功能說明
記錄所有交易歷史，支援成本追蹤與交易分析。

#### 交易屬性

| 屬性 | 類型 | 說明 |
|-----|------|------|
| tradeId | String | 交易唯一識別碼 |
| portfolioId | String | 所屬投組 |
| stockId | String | 股票代碼 |
| tradeType | Enum | 類型：BUY/SELL |
| tradeDate | Date | 交易日期 |
| settleDate | Date | 交割日期 |
| shares | Integer | 交易股數 |
| price | Decimal | 成交價格 |
| amount | Decimal | 成交金額 |
| commission | Decimal | 手續費 |
| tax | Decimal | 證交稅 |
| netAmount | Decimal | 淨金額 |
| signalId | String | 來源信號 ID |
| tradeSource | Enum | 來源：MANUAL/SIGNAL/REBALANCE |
| note | String | 備註 |

#### 交易成本計算

```
買進：
  commission = amount × 0.001425 (券商手續費)
  tax = 0
  netAmount = amount + commission

賣出：
  commission = amount × 0.001425
  tax = amount × 0.003 (證交稅)
  netAmount = amount - commission - tax
```

---

### 3.4 F-M18-004 績效計算

#### 功能說明
計算投資組合的績效指標，包含報酬率、風險調整報酬等。

#### 績效指標

| 指標 | 公式 | 說明 |
|-----|------|------|
| 總報酬率 | (Current - Initial) / Initial | 累積報酬 |
| 年化報酬率 | (1 + Total Return)^(365/Days) - 1 | 年化調整 |
| TWR | Π(1 + HPR) - 1 | 時間加權報酬 |
| MWR (IRR) | NPV = 0 的折現率 | 金額加權報酬 |
| Sharpe Ratio | (Rp - Rf) / σp | 風險調整報酬 |
| Sortino Ratio | (Rp - Rf) / σd | 下行風險調整 |
| Treynor Ratio | (Rp - Rf) / β | 系統風險調整 |
| Information Ratio | (Rp - Rb) / TE | 超額報酬穩定性 |
| Alpha | Rp - [Rf + β(Rm - Rf)] | 超額報酬 |
| Max Drawdown | Max[(Peak - Trough) / Peak] | 最大回撤 |

#### 時間加權報酬率 (TWR) 計算

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     時間加權報酬率 (TWR)                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  目的：消除現金流入流出的影響，反映投資決策的真實績效                        │
│                                                                          │
│  計算步驟：                                                               │
│  1. 在每次現金流發生時切割期間                                            │
│  2. 計算每個子期間的持有期報酬 (HPR)                                       │
│  3. 連乘所有子期間報酬                                                    │
│                                                                          │
│  公式：                                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ TWR = [(1 + HPR₁) × (1 + HPR₂) × ... × (1 + HPRₙ)] - 1          │   │
│  │                                                                   │   │
│  │ 其中：HPRᵢ = (MVₑ - MVₛ - CF) / MVₛ                              │   │
│  │       MVₑ = 期末市值                                              │   │
│  │       MVₛ = 期初市值                                              │   │
│  │       CF  = 期間現金流                                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  範例：                                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ Day 0:  投入 100 萬                                               │   │
│  │ Day 30: 市值 110 萬，再投入 50 萬                                  │   │
│  │ Day 60: 市值 170 萬                                               │   │
│  │                                                                   │   │
│  │ HPR₁ = (110 - 100) / 100 = 10%                                   │   │
│  │ HPR₂ = (170 - 160) / 160 = 6.25%  (期初 = 110 + 50)              │   │
│  │ TWR = (1.10 × 1.0625) - 1 = 16.875%                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 3.5 F-M18-005 投組快照

#### 功能說明
每日記錄投資組合狀態快照，用於績效追蹤與歷史分析。

#### 快照內容

| 欄位 | 說明 |
|-----|------|
| snapshotDate | 快照日期 |
| totalValue | 總市值 |
| cashBalance | 現金餘額 |
| positionValue | 持倉市值 |
| dailyPnL | 當日損益 |
| dailyReturn | 當日報酬率 |
| cumulativeReturn | 累積報酬率 |
| benchmarkReturn | 基準報酬率 |
| positions | 持倉明細快照 |

---

## 4. P1 進階功能詳細需求

### 4.1 F-M18-006 信號整合

#### 功能說明
接收 M13 信號引擎的統一信號，轉換為投組的交易建議。

#### 信號處理流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        信號整合流程                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  1. 信號接收                                                              │
│     ┌───────────────────────────────────────────────────────────────┐  │
│     │ M13 unified_signals → 篩選投組訂閱的股票/信號類型               │  │
│     └───────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  2. 信號評估                                                              │
│     ┌───────────────────────────────────────────────────────────────┐  │
│     │ • 信號強度評估 (Grade A/B/C)                                    │  │
│     │ • 與現有持倉比對                                                 │  │
│     │ • 檢查風險限額 (M17)                                            │  │
│     └───────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  3. 交易建議生成                                                          │
│     ┌───────────────────────────────────────────────────────────────┐  │
│     │ 買入信號：                                                       │  │
│     │   • 計算建議買入股數 (根據資金/權重上限)                          │  │
│     │   • 檢查單一個股權重限制                                         │  │
│     │                                                                 │  │
│     │ 賣出信號：                                                       │  │
│     │   • 檢查是否持有該股票                                           │  │
│     │   • 計算建議賣出比例                                             │  │
│     └───────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  4. 待辦交易清單                                                          │
│     ┌───────────────────────────────────────────────────────────────┐  │
│     │ 生成 pending_trades 供用戶確認或自動執行                         │  │
│     └───────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 信號訂閱設定

| 設定項 | 說明 |
|-------|------|
| signalTypes | 訂閱的信號類型 (技術/基本面/籌碼) |
| minGrade | 最低信號等級 (A/B/C) |
| autoExecute | 是否自動執行 |
| stockFilter | 股票過濾條件 |

---

### 4.2 F-M18-007 再平衡建議

#### 功能說明
根據目標配置與現有持倉，計算再平衡交易建議。

#### 再平衡類型

| 類型 | 說明 |
|-----|------|
| THRESHOLD | 偏離閾值觸發 (如偏離 >5%) |
| PERIODIC | 定期再平衡 (月/季/年) |
| TACTICAL | 戰術性調整 (基於信號) |

#### 再平衡計算

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        再平衡計算邏輯                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  輸入：                                                                   │
│  • 目標配置 (target_allocation)                                          │
│  • 現有持倉 (current_positions)                                          │
│  • 總資產價值 (total_value)                                              │
│  • 交易成本參數                                                          │
│                                                                          │
│  計算步驟：                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ FOR EACH stock IN target_allocation:                             │   │
│  │                                                                   │   │
│  │   target_value = total_value × target_weight                     │   │
│  │   current_value = current_position × current_price               │   │
│  │   diff_value = target_value - current_value                      │   │
│  │                                                                   │   │
│  │   IF abs(diff_value / target_value) > threshold:                 │   │
│  │     trade_shares = round(diff_value / current_price)             │   │
│  │     trade_type = diff_value > 0 ? BUY : SELL                     │   │
│  │     trades.add(trade_shares, trade_type)                         │   │
│  │                                                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  最佳化考量：                                                             │
│  • 最小交易金額限制 (避免過小交易)                                         │
│  • 交易成本最小化                                                         │
│  • 稅務最佳化 (優先賣出虧損部位)                                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 4.3 F-M18-008 績效歸因

#### 功能說明
使用 Brinson 模型進行績效歸因分析。

#### Brinson 歸因模型

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Brinson 績效歸因模型                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  總超額報酬 = 投組報酬 - 基準報酬                                          │
│             = 配置效果 + 選股效果 + 交互效果                               │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 配置效果 (Allocation Effect):                                     │   │
│  │   AA = Σ[(Wp,i - Wb,i) × (Rb,i - Rb)]                            │   │
│  │   表示產業/類別配置與基準不同所產生的報酬差異                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 選股效果 (Selection Effect):                                      │   │
│  │   SS = Σ[Wb,i × (Rp,i - Rb,i)]                                   │   │
│  │   表示在相同配置下選擇不同個股所產生的報酬差異                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 交互效果 (Interaction Effect):                                    │   │
│  │   INT = Σ[(Wp,i - Wb,i) × (Rp,i - Rb,i)]                         │   │
│  │   表示配置與選股的交互影響                                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  符號說明：                                                               │
│  • Wp,i = 投組在第 i 類別的權重                                           │
│  • Wb,i = 基準在第 i 類別的權重                                           │
│  • Rp,i = 投組在第 i 類別的報酬                                           │
│  • Rb,i = 基準在第 i 類別的報酬                                           │
│  • Rb   = 基準總報酬                                                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 4.4 F-M18-009 基準比較

#### 功能說明
與指定基準進行績效比較分析。

#### 支援基準

| 基準代碼 | 名稱 | 說明 |
|---------|------|------|
| TAIEX | 加權指數 | 台灣加權股價指數 |
| TPEx | 櫃買指數 | 櫃檯買賣指數 |
| TWSE50 | 台灣50 | 元大台灣50 ETF |
| CUSTOM | 自訂 | 用戶自訂基準 |

#### 比較指標

| 指標 | 說明 |
|-----|------|
| 相對報酬 | 投組報酬 - 基準報酬 |
| 勝率 | 超越基準的天數比例 |
| 追蹤誤差 | 報酬差異的標準差 |
| 相關係數 | 與基準的報酬相關性 |

---

### 4.5 F-M18-010 現金管理

#### 功能說明
管理投資組合的現金部位。

#### 現金交易類型

| 類型 | 說明 |
|-----|------|
| DEPOSIT | 存入資金 |
| WITHDRAW | 提取資金 |
| DIVIDEND | 股利收入 |
| INTEREST | 利息收入 |
| FEE | 費用支出 |

---

## 5. P2 次要功能詳細需求

### 5.1 F-M18-011 股利追蹤

#### 功能說明
記錄持股的股利發放與處理。

#### 股利類型

| 類型 | 說明 |
|-----|------|
| CASH | 現金股利 |
| STOCK | 股票股利 |
| DRIP | 股利再投資 |

### 5.2 F-M18-012 投組報告

#### 功能說明
生成綜合績效報告。

#### 報告類型

| 類型 | 內容 |
|-----|------|
| DAILY | 每日摘要 |
| WEEKLY | 週報 |
| MONTHLY | 月報 (含歸因分析) |
| ANNUAL | 年報 (完整分析) |

---

## 6. 非功能性需求

### 6.1 效能需求

| 操作 | 目標時間 | 最大時間 |
|-----|---------|---------|
| 取得投組概覽 | < 200ms | 500ms |
| 取得持倉清單 | < 150ms | 300ms |
| 績效計算 | < 500ms | 2s |
| 再平衡計算 | < 1s | 5s |
| 歸因分析 | < 2s | 10s |

### 6.2 資料需求

| 項目 | 需求 |
|-----|------|
| 快照保留 | 3 年每日快照 |
| 交易保留 | 永久保留 |
| 歷史績效 | 5 年 |

### 6.3 與 M17 整合

| 整合點 | 說明 |
|-------|------|
| 限額檢查 | 交易前檢查風險限額 |
| 風險指標 | 顯示 VaR、Beta 等指標 |
| 風險預警 | 接收並顯示預警 |

---

## 7. 錯誤碼定義

| 錯誤碼 | HTTP | 說明 |
|-------|------|------|
| M18-001 | 404 | 投資組合不存在 |
| M18-002 | 400 | 投組名稱已存在 |
| M18-003 | 400 | 投組數量超過上限 |
| M18-004 | 400 | 投組狀態不允許此操作 |
| M18-005 | 404 | 持倉不存在 |
| M18-006 | 400 | 持倉數量超過上限 |
| M18-007 | 400 | 股數不足 |
| M18-008 | 400 | 交易金額不足 |
| M18-009 | 400 | 現金餘額不足 |
| M18-010 | 409 | 風險限額超限 |
| M18-011 | 400 | 無效的目標配置 |
| M18-012 | 400 | 無效的基準代碼 |

---

## 8. 相關文檔

- [M18 API 規格](../api/M18-API規格.md)
- [M18 資料庫設計](../../design/M18-資料庫設計.md)
- [M18 ERD](../../design/erd/M18-ERD.md)
- [M17 風險管理功能需求](./M17-風險管理功能需求.md)
- [M13 信號判斷引擎功能需求](./M13-信號判斷引擎功能需求.md)

---

**文件維護者**: 後端工程師
**最後更新**: 2026-01-15
**下次審核**: 2026-04-15
